<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>13.k8s安装calico时如何选择网卡 | ren_mccの博客</title><meta name="author" content="ren_mcc"><meta name="copyright" content="ren_mcc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 了解calico的通信 默认情况下calico使用的是IPIP模式进行通信，所有节点之间建立tunl0隧道，每创建一个pod在宿主机上都会产生一个以cali开头的虚拟接口，如下图pod1生成了一个calixxxx网卡，pod2生成了一个caliyyyy虚拟网卡。每个pod发出去的数据包会直接转发到cali开头的网卡，这个接口跟pod里的网卡是veth pair的关系。 veth pari最直">
<meta property="og:type" content="article">
<meta property="og:title" content="13.k8s安装calico时如何选择网卡">
<meta property="og:url" content="https://renm.cc/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/index.html">
<meta property="og:site_name" content="ren_mccの博客">
<meta property="og:description" content="1. 了解calico的通信 默认情况下calico使用的是IPIP模式进行通信，所有节点之间建立tunl0隧道，每创建一个pod在宿主机上都会产生一个以cali开头的虚拟接口，如下图pod1生成了一个calixxxx网卡，pod2生成了一个caliyyyy虚拟网卡。每个pod发出去的数据包会直接转发到cali开头的网卡，这个接口跟pod里的网卡是veth pair的关系。 veth pari最直">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://renm.cc/img/yuanshen/avatar/3b87e950352ac65ca2697d55e516d01892138a91.jpeg">
<meta property="article:published_time" content="2022-09-13T05:30:04.000Z">
<meta property="article:modified_time" content="2023-06-28T13:47:21.806Z">
<meta property="article:author" content="ren_mcc">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://renm.cc/img/yuanshen/avatar/3b87e950352ac65ca2697d55e516d01892138a91.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://renm.cc/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '13.k8s安装calico时如何选择网卡',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><script src="/js/jquery.min.js"></script><link rel="stylesheet" href="/js/function.min.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="/js/custom.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-image: url(/img/backgroud7.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar2.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">148</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/yuanshen/avatar/3b87e950352ac65ca2697d55e516d01892138a91.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ren_mccの博客</span></a><a class="nav-page-title" href="/"><span class="site-name">13.k8s安装calico时如何选择网卡</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">13.k8s安装calico时如何选择网卡</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-13T05:30:04.000Z" title="发表于 2022-09-13 13:30:04">2022-09-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-28T13:47:21.806Z" title="更新于 2023-06-28 21:47:21">2023-06-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kubernetes/">kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-06-28 21:47:21&quot;}" hidden></div><h2 id="1-了解calico的通信">1. 了解calico的通信</h2>
<p>默认情况下calico使用的是IPIP模式进行通信，所有节点之间建立tunl0隧道，每创建一个pod在宿主机上都会产生一个以cali开头的虚拟接口，如下图pod1生成了一个calixxxx网卡，pod2生成了一个caliyyyy虚拟网卡。每个pod发出去的数据包会直接转发到cali开头的网卡，这个接口跟pod里的网卡是veth pair的关系。</p>
<p>veth pari最直接的理解就是&quot;网线直连&quot;，pod1发出去的所有数据包，”闭着眼“转发给calixxx，calixxx从其他地方收到数据包”闭着眼“转发给pod1.</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928383845.png" class="">
<p>cali开头的网卡会连接到tunl0上，pod1和pod2通信时，pod1发出的数据包先到达calixxx，然后进入vms71的tunl0接口，再然后到达隧道的另一端vms72的tunl0接口，然后转发到caliyyy，最终到达了pod2,所以tunl0隧道的作用就是封装所有pod之间的流量。</p>
<p>现在的问题是tunl0隧道所走的物理线路是哪条呢？默认情况下calico会自动选择，但是如果有多张网卡的话我们想手动选择网卡，下面分成5种情况来看tunl0如何选择物理线路。</p>
<h2 id="2-实现准备">2. 实现准备</h2>
<p>本实验共两台节点，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms71.rhce.cc   Ready    control-plane,master   54m   v1.23.2</span><br><span class="line">vms72.rhce.cc   Ready    &lt;none&gt;                 54m   v1.23.2</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>为了测试，特地把vms72上的网卡名做了修改，原来的ens32修改成了eth0,原来的ens33修改名eth1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vms71上ens32 ----- vms72上eth1   同一网段。</span><br><span class="line">vms71上ens33 ----- vms72上eth0   同一网段。</span><br></pre></td></tr></table></figure>
<p>同一网段的网卡，结合上图，我这里并没写错。</p>
<p>练习时会在vms71上创建pod1，在vms72上创建pod2，所编写的pod.yaml内容如下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@vms71</span> <span class="string">~</span>]<span class="comment"># cat pod.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms71.rhce.cc</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/centos:test</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms72.rhce.cc</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/centos:test</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line">[<span class="string">root@vms71</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="3-第一种情况-指定网卡1">3. 第一种情况 指定网卡1</h2>
<p>修改calico.yaml的内容，找到IP_AUTODETECTION_METHOD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=ens33,eth0&quot;</span><br></pre></td></tr></table></figure>
<p>这里指定tunl0隧道所对应的物理接口为ens33或者eth0。在vms71上他会选择ens33，在vms72上会选择eth0。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928567562.png" class="">
<p><strong>安装calico</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure>
<p><strong>创建测试用的pod</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f pod.yaml </span><br><span class="line">pod/pod1 created</span><br><span class="line">pod/pod2 created</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">[root@vms71 ~]# kubectl get pods -owide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE        IP             NODE        </span><br><span class="line">pod1   1/1     Running   0          14s   10.244.118.193   vms71.rhce.cc </span><br><span class="line">pod2   1/1     Running   0          14s   10.244.5.194     vms72.rhce.cc </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>整个拓扑图应该如下。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928605990.png" class="">
<p>进入到pod1里去，然后通过traceroute访问 pod2的IP即 10.244.5.194。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl exec -it pod1 -- bash</span><br><span class="line">[root@pod1 /]#</span><br><span class="line">[root@pod1 /]# traceroute 10.244.5.194</span><br><span class="line">traceroute to 10.244.5.194 (10.244.5.194), 30 hops max, 60 byte packets</span><br><span class="line"> 1  192-168-26-71.kubernetes.default.svc.cluster.local (192.168.26.71)  0.049 ms  0.009 ms  0.007 ms</span><br><span class="line"> 2  10.244.5.192 (10.244.5.192)  0.477 ms  0.414 ms  0.378 ms</span><br><span class="line"> 3  10.244.5.194 (10.244.5.194)  0.615 ms  0.577 ms  0.540 ms</span><br><span class="line">[root@pod1 /]# exit</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>从这里可以看到在pod1发出去的包，直接到达隧道另一端即vms72上的tunl0，然后再转发到pod2的。<br>
那么vms71和vms72之间的隧道之间是怎么走的呢？</p>
<p>先查看vms71的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p>
<p>查看vms72的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br><span class="line">凡是去往网段10.244.</span><br><span class="line">```118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）。</span><br><span class="line"></span><br><span class="line">删除pod1和pod2。</span><br><span class="line">```shell</span><br><span class="line">[root@vms71 ~]# kubectl delete -f pod.yaml </span><br><span class="line">pod &quot;pod1&quot; deleted</span><br><span class="line">pod &quot;pod2&quot; deleted</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">删除calico。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<h2 id="4-第二种情况-指定网卡2">4. 第二种情况 指定网卡2</h2>
<p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=ens32,eth1&quot;</span><br></pre></td></tr></table></figure>
<p>这里指定tunl0所使用的物理线路是ens32或者eth1，vms71上有ens32所以选择ens32，vms72上有eth1则选择eth1。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928692725.png" class="">
<p><strong>安装calico</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure>
<p><strong>创建pod</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f pod.yaml </span><br><span class="line">pod/pod1 created</span><br><span class="line">pod/pod2 created</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">[root@vms71 ~]# kubectl get pods -owide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE </span><br><span class="line">pod1   1/1     Running   0          3s    10.244.118.193   vms71.rhce.cc </span><br><span class="line">pod2   1/1     Running   0          3s    10.244.5.194     vms72.rhce.cc  </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>两个pod的IP保持了之前一样</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928716721.png" class="">
<p>进入到pod1里去，然后通过traceroute访问 pod2的IP即 10.244.5.194。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl exec -it pod1 -- bash</span><br><span class="line">[root@pod1 /]# traceroute 10.244.5.194</span><br><span class="line">traceroute to 10.244.5.194 (10.244.5.194), 30 hops max, 60 byte packets</span><br><span class="line"> 1  192-168-26-71.kubernetes.default.svc.cluster.local (192.168.26.71)  0.050 ms  0.009 ms  0.007 ms</span><br><span class="line"> 2  10.244.5.192 (10.244.5.192)  0.493 ms  0.407 ms  0.365 ms</span><br><span class="line"> 3  10.244.5.194 (10.244.5.194)  0.482 ms  0.468 ms  0.461 ms</span><br><span class="line">[root@pod1 /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>查看vms71的路由。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.26.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.26.72（这是vms72的eth1接口，也是隧道tunl0的另一端）</p>
<p>查看vms72的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.26.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.26.71（这是vms71的ens32接口，也是隧道tunl0的另一端）<br>
删除pod1和pod2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f pod.yaml </span><br><span class="line">pod &quot;pod1&quot; deleted</span><br><span class="line">pod &quot;pod2&quot; deleted</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<h2 id="5-第三种情况-跳过指定网卡">5. 第三种情况 跳过指定网卡</h2>
<p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;skip-interface=eth1,ens32&quot;</span><br></pre></td></tr></table></figure>
<p>tunl0选择物理网卡时跳过eth1或者ens32。在vms71上跳过ens32的话只能选择ens33，在vms72上跳过eth1的话只能选择eth0。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928793951.png" class="">
<p>安装calico</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure>
<p>先查看vms71的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p>
<p>先查看vms72的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）</p>
<p><strong>删除calico</strong><br>
[root@vms71 ~]# kubectl delete -f calico.yaml<br>
configmap “calico-config” deleted<br>
…输出…<br>
[root@vms71 ~]#</p>
<h2 id="6-第四种情况-通过网络连通性判断">6. 第四种情况 通过网络连通性判断</h2>
<p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;can-reach=192.168.30.1&quot;</span><br></pre></td></tr></table></figure>
<p>tunl0要选择能和192.168.30.1通信的那张网卡，在vms71上ens33网卡和192.168.30.1是同一个网段，能够和192.168.30.1通信，被选中。在vms72上eth0网卡和192.168.30.1是同一网段可以通信，被选中。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928865022.png" class="">
<p><strong>创建calico</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure>
<p>先查看vms71的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p>
<p>先查看vms72的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）。</p>
<p>删除calico。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<h2 id="7-第五种情况-通过cidr判断">7. 第五种情况 通过cidr判断</h2>
<p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;cidr=192.168.26.0/24&quot;</span><br></pre></td></tr></table></figure>
<p>tunl0选择选择192.168.26.0/24网段的网卡，vms71选中的是ens32，vms72上选中的应该是eth1了，因为他们都是属于192.168.26.0/24网段的。</p>
<img src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928925269.png" class="">
<p><strong>创建calico</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure>
<p><strong>查看vms71的路由</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.26.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.26.72（这是vms72的eth1接口，也是隧道tunl0的另一端）。</p>
<p>查看vms72的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.26.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure>
<p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.26.71（这是vms71的ens32接口，也是隧道tunl0的另一端）。</p>
<p><strong>删除calico</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://renm.cc">ren_mcc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://renm.cc/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/">https://renm.cc/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://renm.cc" target="_blank">ren_mccの博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post-share"><div class="social-share" data-image="/img/yuanshen/avatar/3b87e950352ac65ca2697d55e516d01892138a91.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/20220913/kubernetes-20220913-14-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/" title="14.网络策略"><img class="cover" src="/img/yuanshen/avatar/9183h1124p0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">14.网络策略</div></div><div class="info-2"><div class="info-item-1">1. pod间通信  2. 网络解决方案 CNI(container network interface) CNCF下的一个项目，由coreOS提出 通过插件的方式统一配置 flannel—基于overlay 不支持网络策略 calico—基于BGP 支持网络策略 canal 支持网络策略 3. 各种解决方案的对比  不管哪种解决方案，每个pod都有独立IP，可以直接通信，只是性能及配置的难易及是否支持网络策略 4. 网络策略 只允许特定的客户端能访问，其他客户端不能访问 1.此网络策略要保护谁 2.指定入口流量还是出口流量 3.具体的规则 4.1 查看集群是否有网络策略 1kubectl get networkpolicies 4.2 创建策略 只允指定网络能访问 1234567891011121314151617181920212223242526apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata:  name: mypolicy1  namespace: chap10-netspec: ...</div></div></div></a><a class="pagination-related" href="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/" title="12.calico通信"><img class="cover" src="/img/yuanshen/avatar/10007.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">12.calico通信</div></div><div class="info-2"><div class="info-item-1">1. 安装etcd集群 通过文章部署etcd集群部署etcd集群 2. 安装docker-ce 通过文章docker安装和加速安装docker-ce 2.1 修改配置 修改docker启动脚本配置存储到etcd 1ExecStart=/usr/bin/dockerd --cluster-store=etcd://192.168.10.41:2379 -H fd:// --containerd=/run/containerd/containerd.sock 2.2 重启docker 12systemctl daemon-reloadsystemctl restart docker 3. 安装calico 3.1 创建目录 1mkdir /etc/calico 3.2 创建配置文件 [root@node003 ~]# cat /etc/calico/calicoctl.cfg 123456apiVersion: v1kind: calicoApiConfigmetadata:spec:  datastoreType: &quot;etcdv2&quot;  ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/" title="1.服务网格"><img class="cover" src="/img/yuanshen/avatar/97400f365b0b47cf8533d9d0b4ebe150!400x400.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="info-item-2">1.服务网格</div></div><div class="info-2"><div class="info-item-1">1. 前言 如果你比较关注新兴技术的话，那么很可能在不同的地方听说过 istio，并且知道它和 service mesh 有着牵扯。这篇文章可以作为了解 istio 的入门介绍，了解什么是 istio，istio 为什么最近这么火，以及 istio 能够我们带来什么好处。 2. 什么是 istio？ 官方对 istio 的介绍浓缩成了一句话：  An open platform to connect, secure, control and observe services.  翻译过来，就是”连接、安全加固、控制和观察服务的开放平台“。开放平台就是指它本身是开源的，服务对应的是微服务，也可以粗略地理解为单个应用。 中间的四个动词就是 istio 的主要功能，官方也各有一句话的说明。这里再阐释一下：  连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和红黑部署等功能 安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密 控制（Control）：应用用户定义的...</div></div></div></a><a class="pagination-related" href="/20220210/kubernetes-20220210-kubectl%E5%91%BD%E4%BB%A4%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8/" title="kubectl命令自动补全"><img class="cover" src="/img/yuanshen/avatar/42f268bdcc7059cc27fd69a639c7c6f0253fe1c4.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-10</div><div class="info-item-2">kubectl命令自动补全</div></div><div class="info-2"><div class="info-item-1">1234567yum install -y bash-completionsource /usr/share/bash-completion/bash_completionsource &lt;(kubectl completion bash)echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrcecho &quot;source &lt;(helm completion bash)&quot; &gt;&gt; ~/.bashrc </div></div></div></a><a class="pagination-related" href="/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/" title="1.k8s简介"><img class="cover" src="/img/yuanshen/avatar/bf096b63f6246b60841dc6d1f61c7845500fa275.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-06</div><div class="info-item-2">1.k8s简介</div></div><div class="info-2"><div class="info-item-1">1. 简介   我们可以使用docker run或nerdctl run这样的命令来创建一个一个的容器，...</div></div></div></a><a class="pagination-related" href="/20220906/kubernetes-20220906-3-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/" title="3.k8s的基本管理"><img class="cover" src="/img/yuanshen/avatar/20210501094035_643fc.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-06</div><div class="info-item-2">3.k8s的基本管理</div></div><div class="info-2"><div class="info-item-1">1. 了解namespace 集群逻辑上的资源分类，用于实现多租户的资源隔离。k8s上所有命名空间对应于containerd的k8s.io命名空间。  1.1 查看集群上命名空间 123456[root@node001 ~]# kubectl get namespaces NAME              STATUS   AGEdefault           Active   18hkube-node-lease   Active   18hkube-public       Active   18hkube-system       Active   18h 1.2 查看指定ns空间资源 12345678910111213141516[root@node001 ~]# kubectl get pod -n kube-system NAME                                       READY   STATUS    RESTARTS   AGEcalico-kube-controllers-6799f5f4b4-jfclq   1/1...</div></div></div></a><a class="pagination-related" href="/20220906/kubernetes-20220906-4-%E4%BA%86%E8%A7%A3etcd/" title="4.了解etcd"><img class="cover" src="/img/yuanshen/avatar/128170_111705817.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-06</div><div class="info-item-2">4.了解etcd</div></div><div class="info-2"><div class="info-item-1">1. 简介 etcd集群是一个分布式系统，使用Raft协议来维护集群内容各个节点状态的一致性。 主机状态Leader,Follower,Candidate 当集群初始化时候，每个节点都是Follower角色 通过心跳与其他节点同步数据 当Follower在一定时间内没有收到来自其他节点的心跳，会将自己角色改变为Candidate，并发起一次选主投票。 配置etcd集群，建议尽可能是奇数个节点。 目前在用的两个大版本v2，v3 v3已键值对的方式来存储数据，k8s从1.5开始使用v3版本etcd。  2. 单节点etcd 2.1 安装etcd 1[root@node001 ~]# yum install etcd -y 2.2 修改配置文件 12345678910111213141516171819202122[root@node001 ~]# vim...</div></div></div></a><a class="pagination-related" href="/20220216/kubernetes-20220216-k8s%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="k8s基础环境配置"><img class="cover" src="/img/yuanshen/avatar/1000111.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-16</div><div class="info-item-2">k8s基础环境配置</div></div><div class="info-2"><div class="info-item-1">1 主机基础配置 1.1 主机名配置 因为 K8S 或者 FQDN 的规定，主机名仅支持包含 - 或/和 .(中横线和点)两种特殊符号，并且一个集群中主机名不能重复。 1.2 Hosts  Linux 系统安装完成后，在 hosts(/etc/hosts) 中应该有 localhost 指向 127.0.0.1，如果没有则手动添加上。 配置每台主机的 hosts(/etc/hosts)，添加 host_ip $hostname 到 /etc/hosts 文件中。  1.3 CentOS 关闭 selinux 1sudo sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 1.4 关闭防火墙(可选)或者放行相应端口   CentOS  1systemctl stop firewalld.service &amp;&amp; systemctl disable firewalld.service   Ubuntu   1ufw disable   1.5...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BA%86%E8%A7%A3calico%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="toc-number">1.</span> <span class="toc-text">1. 了解calico的通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">2. 实现准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%83%85%E5%86%B5-%E6%8C%87%E5%AE%9A%E7%BD%91%E5%8D%A11"><span class="toc-number">3.</span> <span class="toc-text">3. 第一种情况 指定网卡1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%83%85%E5%86%B5-%E6%8C%87%E5%AE%9A%E7%BD%91%E5%8D%A12"><span class="toc-number">4.</span> <span class="toc-text">4. 第二种情况 指定网卡2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5-%E8%B7%B3%E8%BF%87%E6%8C%87%E5%AE%9A%E7%BD%91%E5%8D%A1"><span class="toc-number">5.</span> <span class="toc-text">5. 第三种情况 跳过指定网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%AC%AC%E5%9B%9B%E7%A7%8D%E6%83%85%E5%86%B5-%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A%E6%80%A7%E5%88%A4%E6%96%AD"><span class="toc-number">6.</span> <span class="toc-text">6. 第四种情况 通过网络连通性判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%AC%AC%E4%BA%94%E7%A7%8D%E6%83%85%E5%86%B5-%E9%80%9A%E8%BF%87cidr%E5%88%A4%E6%96%AD"><span class="toc-number">7.</span> <span class="toc-text">7. 第五种情况 通过cidr判断</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By ren_mcc</div><div class="footer_custom_text"><a rel="noopener external nofollow noreferrer noopener" target="_blank" href="https://beian.miit.gov.cn/"> <img class="icp-icon entered loading" alt="ICP" src="/img/icp.png" data-ll-status><span>京ICP备2022001205号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: [''],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '66d4f322d55224acd2c774ad4be93348'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><div class="aplayer no-destroy" data-id="7211977673" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="list" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/docker/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱 docker (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/docker-compose/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 docker-compose (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/containerd/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 containerd (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/kubernetes/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 kubernetes (27)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/python/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 python (37)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/golang/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 golang (38)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 redis (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/kafka/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 kafka (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://renm.cc/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>