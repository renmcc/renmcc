<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>目录文件处理</title>
      <link href="/20230628/python-20230628-%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/"/>
      <url>/20230628/python-20230628-%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-文件IO操作">1. 文件IO操作</h2><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>open</td><td>打开</td></tr><tr><td>read</td><td>读取</td></tr><tr><td>write</td><td>写入</td></tr><tr><td>close</td><td>关闭</td></tr><tr><td>readline</td><td>行读取</td></tr><tr><td>readlines</td><td>多行读取</td></tr></tbody></table><h3 id="1-1-open方法">1.1 open方法</h3><p>open(file, mode=‘r’, buffering=-1, encoding=None, errors=None, newline=None,closefd=True, opener=None)</p><p>打开一个文件，返回一个文件对象(流对象)和文件描述符。打开文件失败，则返回异常</p><p>基本使用：创建一个文件test，然后打开它，用完关闭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;test&quot;</span>) <span class="comment"># file对象</span></span><br><span class="line"><span class="comment"># windows &lt;_io.TextIOWrapper name=&#x27;test&#x27; mode=&#x27;r&#x27; encoding=&#x27;cp936&#x27;&gt;</span></span><br><span class="line"><span class="comment"># linux &lt;_io.TextIOWrapper name=&#x27;test&#x27; mode=&#x27;r&#x27; encoding=&#x27;UTF-8&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(f.read()) <span class="comment"># 读取文件</span></span><br><span class="line">f.close() <span class="comment"># 关闭文件</span></span><br></pre></td></tr></table></figure><p>文件操作中，最常用的操作就是读和写。<br>文件访问的模式有两种：文本模式和二进制模式。不同模式下，操作函数不尽相同，表现的结果也不一样。</p><p>注：<br>windows中使用codepage代码页，可以认为每一个代码页就是一张编码表。cp936等同于GBK</p><h3 id="1-2-open参数">1.2 open参数</h3><h4 id="1-2-1-file">1.2.1 file</h4><p>打开或者要创建的文件名。如果不指定路径，默认是当前路径</p><h4 id="1-2-2-mode模式">1.2.2 mode模式</h4><table><thead><tr><th>模式描述字符</th><th>意义</th></tr></thead><tbody><tr><td>r</td><td>缺省模式，只读打开</td></tr><tr><td>w</td><td>只写打开</td></tr><tr><td>x</td><td>创建并写入一个新文件</td></tr><tr><td>a</td><td>只写打开，追加内容</td></tr><tr><td>b</td><td>二进制模式</td></tr><tr><td>t</td><td>缺省模式，文本模式</td></tr><tr><td>+</td><td>读或写打开后，使用+来增加缺失的写或读的能力</td></tr></tbody></table><p>模式对于IO操作来说，其实只有读和写两种：</p><ul><li>只读 r</li><li>只写 w、x、a</li><li>增加缺失能力 +</li></ul><p>r 模式</p><ul><li>只读打开文件，如果使用write方法，会抛异常</li><li>如果文件不存在，抛出FileNotFoundError异常</li></ul><p>w 模式</p><ul><li>表示只写方式打开，如果读取则抛出异常</li><li>如果文件不存在，则直接创建文件</li><li>如果文件存在，则清空文件内容</li></ul><p>x 模式</p><ul><li>文件不存在，创建文件，并只写方式打开</li><li>文件存在，抛出FileExistsError异常</li></ul><p>a 模式</p><ul><li>文件存在，只写打开，追加内容</li><li>文件不存在，则创建后，只写打开，追加内容</li></ul><p>wxa模式都可以产生新文件</p><ul><li>w不管文件存在与否，都会生成全新内容的文件</li><li>a不管文件是否存在，都能在打开的文件尾部追加</li><li>x必须要求文件事先不存在，自己要造一个新文件</li></ul><p>文本模式t</p><ul><li>字符流，将文件的字节按照某种字符编码理解，按照字符操作。open的默认mode就是rt。</li></ul><p>二进制模式b</p><ul><li>字节流，将文件就按照字节理解，与字符编码无关。二进制模式操作时，字节操作使用bytes类型</li></ul><ul><li>模式</li></ul><ul><li>为r、w、a、x提供缺失的读或写功能，但是，获取文件对象依旧按照r、w、a、x自己的特征</li><li>+模式不能单独使用，可以认为它是为前面的模式字符做增强功能的</li></ul><h4 id="1-2-3-encoding：编码，仅文本模式使用">1.2.3 encoding：编码，仅文本模式使用</h4><p>None 表示使用缺省编码，依赖操作系统。windows、linux下测试如下代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;test1&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">f.write(<span class="string">&#x27;啊&#x27;</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>windows下缺省GBK（0xB0A1），Linux下缺省UTF-8（0xE5 95 8A）</p><h4 id="1-2-4-文件指针">1.2.4 文件指针</h4><ul><li>mode=r，指针起始在0</li><li>mode=a，指针起始在EOF</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;o:/test.txt&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(f)</span><br><span class="line">f.write(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(f.tell())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;o:/test.txt&#x27;</span>, <span class="string">&#x27;rt+&#x27;</span>) <span class="comment"># windows下打开</span></span><br><span class="line">f.write(<span class="string">&#x27;啊&#x27;</span>) <span class="comment"># 从什么地方开始写几个字节？</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">ord</span>(<span class="string">&#x27;啊&#x27;</span>)), <span class="string">&#x27;啊&#x27;</span>.encode(), <span class="string">&#x27;啊&#x27;</span>.encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(f.tell())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>tell、seek函数都是使用字节索引的</p><ul><li>tell() 指定当前字节索引位置</li><li>seek(offset, whence=0)相对于某处偏移<ul><li>文本模式<ul><li>seek(0)、seek(200)，相对开始向右偏移，不能左超界</li><li>seek(0, 1)，只能是偏移0，就是原地踏步，没有用的操作</li><li>seek(0, 2)，只能是偏移0，就是跳到EOF</li></ul></li><li>字节模式<ul><li>seek(0)、seek(200)，相对开始向右偏移，不能左超界</li><li>seek(0, 1)、seek(-5, 1)、seek(5, 1)，相对当前索引位置偏移，不能左超界</li><li>seek(0, 2)、seek(-5, 2)、seek(5, 2)，相对EOF偏移，不能左超界</li></ul></li><li>最常用的操作就是seek(0)、seek(0, 2)</li></ul></li></ul><h3 id="1-3-read">1.3 read</h3><p>read(size=-1)</p><ul><li>size表示读取的多少个字符或字节；负数或者None表示读取到EOF</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;o:/test.txt&#x27;</span></span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line">f.write(<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">f.close()</span><br><span class="line">f = <span class="built_in">open</span>(filename)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span>, f.read(<span class="number">1</span>)) <span class="comment"># 按字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span>, f.read(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span>, f.read())</span><br><span class="line">f.close()</span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">4</span>, f.read(<span class="number">1</span>)) <span class="comment"># 按字节</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">5</span>, f.read(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">6</span>, <span class="string">&#x27;aaa&#x27;</span>.encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">7</span>, f.read())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>建议，使用文件对象时，一定要指定编码，而不是使用默认编码</p><h3 id="1-4-write">1.4 write</h3><ul><li>write(s)，文本模式时，从当前指针处把字符串s写入到文件中并返回写入字符的个数；二进制时将bytes写入文件并返回写入字节数</li><li>writelines(lines)，将字符串列表写入文件</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;o:/test.txt&#x27;</span></span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line">lines = [<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;123\n&#x27;</span>, <span class="string">&#x27;aaa&#x27;</span>] <span class="comment"># 需提供换行符</span></span><br><span class="line"><span class="comment"># for line in lines:</span></span><br><span class="line"><span class="comment"># f.write(line)</span></span><br><span class="line">f.writelines(lines)</span><br><span class="line">f.seek(<span class="number">0</span>) <span class="comment"># 回到开始</span></span><br><span class="line"><span class="built_in">print</span>(f.read())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><h4 id="1-5-close">1.5 close</h4><p>flush并关闭文件对象。文件已经关闭，再次关闭没有任何效果。可以查看文件对象的closed属性，判断是否关闭</p><h2 id="2-上下文管理">2. 上下文管理</h2><p>文件对象这种打开资源并一定要关闭的对象，为了保证其打开后一定关闭，为其提供了上下文支持。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;o:/test.txt&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>, f.closed)</span><br><span class="line">    <span class="built_in">print</span>(f.write(<span class="string">&#x27;abcd&#x27;</span>))  <span class="comment"># r模式写入失败，抛异常</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span>, f.closed)  <span class="comment"># with中不管是否抛异常，with结束时都会保证关闭文件对象</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> 文件对象 <span class="keyword">as</span> 标识符: <span class="comment"># 等同于 标识符 = 文件对象</span></span><br><span class="line">    <span class="keyword">pass</span> <span class="comment"># 标识符可以在内部使用</span></span><br></pre></td></tr></table></figure><p>上下文管理</p><ol><li>使用with关键字，上下文管理针对的是with后的对象</li><li>使用with … as 关键字</li><li>上下文管理的语句块并不会开启新的作用域</li></ol><p>文件对象上下文管理</p><ol><li>进入with时，with后的文件对象是被管理对象</li><li>as子句后的标识符，指向with后的文件对象</li><li>with语句块执行完的时候，会自动关闭文件对象</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;o:/test.txt&#x27;</span></span><br><span class="line">f = <span class="built_in">open</span>(filename)</span><br><span class="line"><span class="keyword">with</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>, f.closed)</span><br><span class="line">    <span class="built_in">print</span>(f.write(<span class="string">&#x27;abcd&#x27;</span>))  <span class="comment"># r模式写入失败</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span>, f.closed)  <span class="comment"># with中不管是否抛异常，with结束时都会关闭文件对象</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-1-文件的遍历">2.1 文件的遍历</h3><p>类似于日志文件，文件需要遍历，最常用的方式就是逐行遍历</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;o:/test.txt&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&#x27;\n&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, <span class="built_in">range</span>(<span class="number">101</span>, <span class="number">120</span>))))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:  <span class="comment"># 文件对象时可迭代对象，逐行遍历</span></span><br><span class="line">        <span class="built_in">print</span>(line.encode())  <span class="comment"># 带换行符</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-路径操作">3. 路径操作</h2><h3 id="3-1-os-path模块">3.1 os.path模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># os模块常用函数</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">p = path.join(<span class="string">&#x27;/etc&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;network&#x27;</span>)  <span class="comment"># 拼接</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(p), p)</span><br><span class="line"><span class="built_in">print</span>(path.exists(p))  <span class="comment"># 存在</span></span><br><span class="line"><span class="built_in">print</span>(path.split(p))  <span class="comment"># 分割</span></span><br><span class="line"><span class="built_in">print</span>(path.splitdrive(<span class="string">&#x27;o:/temp/test&#x27;</span>))  <span class="comment"># windows方法</span></span><br><span class="line"><span class="built_in">print</span>(path.dirname(p), path.basename(p))  <span class="comment"># 路径和基名</span></span><br><span class="line"><span class="built_in">print</span>(path.abspath(<span class="string">&#x27;&#x27;</span>), path.abspath(<span class="string">&#x27;.&#x27;</span>))  <span class="comment"># 绝对路径</span></span><br><span class="line"><span class="comment"># 打印父目录</span></span><br><span class="line">p1 = path.abspath(__file__)</span><br><span class="line"><span class="built_in">print</span>(p1)</span><br><span class="line"><span class="keyword">while</span> p1 != path.dirname(p1):</span><br><span class="line">    p1 = path.dirname(p1)</span><br><span class="line">    <span class="built_in">print</span>(p1)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>os.path模块操作的都是字符串</p><h3 id="3-2-Path类">3.2 Path类</h3><p>从3.4开始Python提供了pathlib模块，使用Path类操作目录更加方便</p><h4 id="3-2-1-初始化">3.2.1 初始化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = Path() <span class="comment"># 当前目录， Path()、Path(&#x27;.&#x27;)、Path(&#x27;&#x27;)</span></span><br><span class="line">p = Path(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c/d&#x27;</span>) <span class="comment"># 当前目录下的a/b/c/d</span></span><br><span class="line">p = Path(<span class="string">&#x27;/etc&#x27;</span>, Path(<span class="string">&#x27;sysconfig&#x27;</span>), <span class="string">&#x27;network/ifcfg&#x27;</span>) <span class="comment"># 根下的etc目录</span></span><br></pre></td></tr></table></figure><h4 id="3-2-2-拼接">3.2.2 拼接</h4><p>操作符/</p><ul><li>Path对象 / Path对象</li><li>Path对象 / 字符串</li><li>字符串 / Path对象</li></ul><p>joinpath</p><ul><li>joinpath(*other) 在当前Path路径上连接多个字符串返回新路径对象</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path()</span><br><span class="line">p = p / <span class="string">&#x27;a&#x27;</span></span><br><span class="line">p1 = <span class="string">&#x27;b&#x27;</span> / p</span><br><span class="line">p2 = Path(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">p3 = p2 / p1</span><br><span class="line"><span class="built_in">print</span>(p1, p2, p3)</span><br><span class="line"><span class="built_in">print</span>(p3.parts)</span><br><span class="line"><span class="built_in">print</span>(p3.joinpath(<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e/f&#x27;</span>, Path(<span class="string">&#x27;g/h&#x27;</span>)))</span><br></pre></td></tr></table></figure><h4 id="3-2-3-分解">3.2.3 分解</h4><p>parts属性，会返回目录各部分的元组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">&#x27;/a/b/c/d&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p.parts) <span class="comment"># 最左边的/是根目录</span></span><br></pre></td></tr></table></figure><h4 id="3-2-4-父目录">3.2.4 父目录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">&#x27;/zzz/mysql/install/mysql.tar.gz&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p.parent)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents: <span class="comment"># 可迭代对象</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure><h4 id="3-2-5-目录组成部分">3.2.5 目录组成部分</h4><p>name、stem、suffix、suffixes、with_suffix(suffix)、with_name(name)</p><ul><li>name 目录的最后一个部分</li><li>suffix 目录中最后一个部分的扩展名</li><li>stem 目录最后一个部分，没有后缀</li><li>name = stem + suffix</li></ul><p>suffixes 返回多个扩展名列表</p><ul><li>with_suffix(suffix) 有扩展名则替换，无则补充扩展名</li><li>with_name(name) 替换目录最后一个部分并返回一个新的路径</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">&#x27;/zz/mysql/install/mysql.tar.gz&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p.parent)</span><br><span class="line"><span class="built_in">print</span>(p.name)</span><br><span class="line"><span class="built_in">print</span>(p.stem)</span><br><span class="line"><span class="built_in">print</span>(p.suffix)</span><br><span class="line"><span class="built_in">print</span>(p.suffixes)</span><br><span class="line"><span class="built_in">print</span>(p.with_name(<span class="string">&#x27;redis&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(p.with_name(<span class="string">&#x27;redis&#x27;</span>).with_suffix(<span class="string">&#x27;.zip&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\zz\mysql\install</span><br><span class="line">mysql.tar.gz</span><br><span class="line">mysql.tar</span><br><span class="line">.gz</span><br><span class="line">[<span class="string">&#x27;.tar&#x27;</span>, <span class="string">&#x27;.gz&#x27;</span>]</span><br><span class="line">\zz\mysql\install\redis</span><br><span class="line">\zz\mysql\install\redis.zip</span><br></pre></td></tr></table></figure><h4 id="3-2-6-全局方法">3.2.6 全局方法</h4><ul><li>cwd() 返回当前工作目录</li><li>home() 返回当前家目录</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = Path(<span class="string">&#x27;/zz/mysql/install/mysql.tar.gz&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p.cwd(), Path.cwd())</span><br><span class="line"><span class="built_in">print</span>(p.home(), Path.home())</span><br></pre></td></tr></table></figure><h4 id="3-2-7-判断方法">3.2.7 判断方法</h4><ul><li>exists() 目录或文件是否存在</li><li>is_dir() 是否是目录，目录存在返回True</li><li>is_file() 是否是普通文件，文件存在返回True</li><li>is_symlink() 是否是软链接</li><li>is_socket() 是否是socket文件</li><li>is_block_device() 是否是块设备</li><li>is_char_device() 是否是字符设备</li><li>is_absolute() 是否是绝对路径</li></ul><p>注意：文件只有存在，才能知道它是什么类型文件</p><h4 id="3-2-8-绝对路径">3.2.8 绝对路径**</h4><ul><li>resolve() 非Windows，返回一个新的路径，这个新路径就是当前Path对象的绝对路径，如果是软链接则直接被解析。Windows下没什么效果。</li><li>absolute() 获取绝对路径。</li></ul><h4 id="3-2-9-其它操作">3.2.9 其它操作</h4><ul><li>rmdir() 删除空目录。没有提供判断目录为空的方法</li><li>touch(mode=0o666, exist_ok=True) 创建一个文件</li><li>as_uri() 将路径返回成URI，例如’file:///etc/passwd’</li><li>mkdir(mode=0o777, parents=False, exist_ok=False)<br>parents，是否创建父目录，True等同于mkdir -p。False时，父目录不存在，则抛出FileNotFoundError<br>exist_ok参数，在3.5版本加入。False时，路径存在，抛出FileExistsError；True时，FileExistsError被忽略</li><li>iterdir() 迭代当前目录，不递归</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">&#x27;o:/a/b/c/d&#x27;</span>)</span><br><span class="line">p.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">(p / <span class="string">&#x27;test&#x27;</span>).touch()</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> p.parents[<span class="built_in">len</span>(p.parents) - <span class="number">1</span>].iterdir():  <span class="comment"># 不支持负索引</span></span><br><span class="line">    <span class="keyword">if</span> x.is_dir():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;dir =&#x27;</span>, x)</span><br><span class="line">    <span class="keyword">elif</span> x.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;file =&#x27;</span>, x)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;other =&#x27;</span>, x)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>stat 相当于stat命令</li><li>lstat 使用方法同stat()，但如果是符号链接，则显示符号链接本身的文件信息</li></ul><h4 id="3-2-10-通配符">3.2.10 通配符</h4><ul><li>glob(pattern) 通配给定的模式，返回生成器对象</li><li>rglob(pattern) 通配给定的模式，递归目录，返回生成器对象</li><li>? 代表一个字符</li><li>* 表示任意个字符</li><li>[abc]或[a-z] 表示一个字符</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(p.glob(<span class="string">&#x27;test*&#x27;</span>)) <span class="comment"># 返回当前目录对象下的test开头的文件</span></span><br><span class="line"><span class="built_in">list</span>(p.glob(<span class="string">&#x27;**/*.py&#x27;</span>)) <span class="comment"># 递归所有目录，等同rglob</span></span><br><span class="line"><span class="built_in">list</span>(p.glob(<span class="string">&#x27;**/*&#x27;</span>))</span><br><span class="line">g = p.rglob(<span class="string">&#x27;*.py&#x27;</span>) <span class="comment"># 生成器，递归</span></span><br><span class="line"><span class="built_in">next</span>(g)</span><br><span class="line"><span class="built_in">list</span>(p.rglob(<span class="string">&#x27;*.???&#x27;</span>)) <span class="comment"># 匹配扩展名为3个字符的文件</span></span><br><span class="line"><span class="built_in">list</span>(p1.rglob(<span class="string">&#x27;[a-z]*.???&#x27;</span>)) <span class="comment"># 匹配字母开头的且扩展名是3个字符的文件</span></span><br></pre></td></tr></table></figure><h2 id="4-shutil模块">4. shutil模块</h2><p>文件拷贝：使用打开2个文件对象，源文件读取内容，写入目标文件中来完成拷贝过程。但是这样丢失stat数据信息（权限等），因为根本没有复制这些信息过去。</p><p>目录复制又怎么办呢？</p><p>Python提供了一个方便的库shutil（高级文件操作）。</p><h3 id="4-1-copy-复制">4.1 copy 复制</h3><p>copyfileobj(fsrc, fdst[, length])<br>文件对象的复制，fsrc和fdst是open打开的文件对象，复制内容。fdst要求可写。<br>length 指定了表示buffer的大小；</p><p>copyfile(src, dst, *, follow_symlinks=True)<br>复制文件内容，不含元数据。src、dst为文件的路径字符串<br>本质上调用的就是copyfileobj，所以不带元数据二进制内容复制。</p><p>copymode(src, dst, *, follow_symlinks=True)<br>仅仅复制权限。</p><p>copystat(src, dst, *, follow_symlinks=True)<br>复制元数据，stat包含权限</p><p>copy(src, dst, *, follow_symlinks=True)<br>复制文件内容、权限和部分元数据，不包括创建时间和修改时间。<br>本质上调用的是</p><p>copyfile(src, dst, follow_symlinks=follow_symlinks)<br>copymode(src, dst, follow_symlinks=follow_symlinks)</p><p>copy2 比copy多了复制全部元数据，但需要平台支持。<br>本质上调用的是</p><p>copyfile(src, dst, follow_symlinks=follow_symlinks)<br>copystat(src, dst, follow_symlinks=follow_symlinks)</p><p>copytree(src, dst, symlinks=False, ignore=None, copy_function=copy2,ignore_dangling_symlinks=False)<br>递归复制目录。默认使用copy2，也就是带更多的元数据复制。</p><p>src、dst必须是目录，src必须存在，dst必须不存在<br>ignore = func ，提供一个callable(src, names) -&gt; ignored_names。提供一个函数，它会被调用。src是源目录，names是os.listdir(src)的结果，就是列出src中的文件名，返回值是要被过滤的文件名的set类型数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># o:/temp下有a、b目录</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ignore</span>(<span class="params">src, names</span>):</span><br><span class="line">    ig = <span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x.startswith(<span class="string">&#x27;a&#x27;</span>), names) <span class="comment"># 忽略a开头的</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">set</span>(ig)</span><br><span class="line">shutil.copytree(<span class="string">&#x27;o:/temp&#x27;</span>,<span class="string">&#x27;o:/tt/o&#x27;</span>,ignore=ignore)</span><br></pre></td></tr></table></figure><h3 id="4-2-rm-删除">4.2 rm 删除</h3><p>shutil.rmtree(path, ignore_errors=False, onerror=None)<br>递归删除。如同rm -rf一样危险，慎用。<br>它不是原子操作，有可能删除错误，就会中断，已经删除的就删除了。<br>ignore_errors为true，忽略错误。当为False或者omitted时onerror生效。<br>onerror为callable，接受函数function、path和execinfo。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutil.rmtree(<span class="string">&#x27;O:/tmp&#x27;</span>) <span class="comment"># 类似 rm -rf</span></span><br></pre></td></tr></table></figure><h3 id="4-3-move-移动">4.3 move 移动</h3><p>move(src, dst, copy_function=copy2)<br>递归移动文件、目录到目标，返回目标。<br>本身使用的是 os.rename方法。<br>如果不支持rename，如果是目录则copytree再删除源目录。<br>默认使用copy2方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shutil.move(<span class="string">&#x27;o:/a&#x27;</span>, <span class="string">&#x27;o:/aaa&#x27;</span>)</span><br><span class="line">os.rename(<span class="string">&#x27;o:/t.txt&#x27;</span>,<span class="string">&#x27;o:/temp/t&#x27;</span>)</span><br><span class="line">os.rename(<span class="string">&#x27;test3&#x27;</span>,<span class="string">&#x27;/tmp/py/test300&#x27;</span>)</span><br></pre></td></tr></table></figure><p>shutil还有打包功能。生成tar并压缩。支持zip、gz、bz、xz。</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>functools模块</title>
      <link href="/20230628/python-20230628-functools%E6%A8%A1%E5%9D%97/"/>
      <url>/20230628/python-20230628-functools%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="1-reduce">1. reduce</h2><ul><li>functools.reduce(function, iterable[, initial])</li><li>就是减少的意思</li><li>初始值没有提供就在可迭代对象中取一个</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">sum</span>(<span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">s = reduce(<span class="keyword">lambda</span> x: x, <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(s)  <span class="comment"># TypeError: &lt;lambda&gt;() takes 1 positional argument but 2 were given</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">s = reduce(<span class="keyword">lambda</span> x,y: <span class="built_in">print</span>(x,y), <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">返回结果如下</span><br><span class="line"><span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="literal">None</span> <span class="number">2</span></span><br><span class="line"><span class="literal">None</span> <span class="number">3</span></span><br><span class="line"><span class="literal">None</span> <span class="number">4</span></span><br><span class="line"><span class="literal">None</span> <span class="number">5</span></span><br><span class="line"><span class="literal">None</span> <span class="number">6</span></span><br><span class="line"><span class="literal">None</span> <span class="number">7</span></span><br><span class="line"><span class="literal">None</span> <span class="number">8</span></span><br><span class="line"><span class="literal">None</span> <span class="number">9</span></span><br><span class="line"><span class="literal">None</span></span><br></pre></td></tr></table></figure><p>上一次lambda函数返回值会成为下一次的x</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">sum</span>(<span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">s = reduce(<span class="keyword">lambda</span> x, y: x + y, <span class="built_in">range</span>(<span class="number">10</span>), <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>sum只能求和，reduce能做更加复杂的迭代计算。<br>思考：5的阶乘怎么做？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(reduce(<span class="keyword">lambda</span> x, y: x * y, <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>)))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2-partial">2. partial</h2><p>偏函数</p><ul><li>把函数部分参数固定下来，相当于为部分的参数添加了固定的默认值，形成一个新的函数，并返回这个新函数</li><li>这个新函数是对原函数的封装</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">newadd = partial(add, y=<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(newadd(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(newadd(<span class="number">4</span>, y=<span class="number">15</span>))</span><br><span class="line"><span class="built_in">print</span>(newadd(x=<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(newadd(<span class="number">4</span>, <span class="number">6</span>))  <span class="comment"># 可以吗</span></span><br><span class="line"><span class="built_in">print</span>(newadd(y=<span class="number">6</span>, x=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inspect.signature(newadd))</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y, *args</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y + <span class="built_in">sum</span>(args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">newadd = partial(add, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(newadd())</span><br><span class="line"><span class="built_in">print</span>(newadd(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(newadd(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(newadd(x=<span class="number">1</span>))  <span class="comment">#</span></span><br><span class="line"><span class="built_in">print</span>(newadd(x=<span class="number">1</span>, y=<span class="number">2</span>))  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inspect.signature(newadd))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-1-partial本质">2.1 partial本质</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">partial</span>(<span class="params">func, *args, **keywords</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">newfunc</span>(<span class="params">*fargs, **fkeywords</span>):  <span class="comment"># 包装函数</span></span><br><span class="line">        newkeywords = keywords.copy()</span><br><span class="line">        newkeywords.update(fkeywords)</span><br><span class="line">        <span class="keyword">return</span> func(*(args + fargs), **newkeywords)</span><br><span class="line"></span><br><span class="line">    newfunc.func = func  <span class="comment"># 保留原函数</span></span><br><span class="line">    newfunc.args = args  <span class="comment"># 保留原函数的位置参数</span></span><br><span class="line">    newfunc.keywords = keywords  <span class="comment"># 保留原函数的关键字参数参数</span></span><br><span class="line">    <span class="keyword">return</span> newfunc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = partial(add, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">foo(<span class="number">5</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>尝试分析functools.wraps的实现。类别下面的实现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b, c, d</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b + c + d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">newadd = partial(add, b=<span class="number">2</span>, c=<span class="number">3</span>, d=<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(inspect.signature(newadd))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-lru-cache">3. lru_cache</h2><p>@functools.lru_cache(maxsize=128, typed=False)</p><ul><li>lru即Least-recently-used，最近最少使用。cache缓存</li><li>如果maxsize设置为None，则禁用LRU功能，并且缓存可以无限制增长。当maxsize是二的幂时，LRU功能执行得最好</li><li>如果typed设置为True，则不同类型的函数参数将单独缓存。例如，f(3)和f(3.0)将被视为具有不同结果的不同调用</li><li>Python 3.8 简化了调用，可以使用</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@functools.lru_cache</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="meta">@functools.lru_cache(<span class="params"><span class="number">128</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y=<span class="number">5</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span>, add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span>, add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span>, add(x=<span class="number">4</span>, y=<span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">4</span>, add(y=<span class="number">5</span>, x=<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">5</span>, add(<span class="number">4.0</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="number">6</span>, add(<span class="number">4</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>到底什么调用才能用缓存呢？</p><h3 id="3-1-lru-cache本质">3.1 lru_cache本质</h3><ul><li>内部使用了一个字典</li><li>key是由_make_key函数构造出来</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> _make_key</span><br><span class="line"><span class="built_in">print</span>(_make_key((<span class="number">4</span>, <span class="number">5</span>), &#123;&#125;, <span class="literal">False</span>))</span><br><span class="line"><span class="built_in">print</span>(_make_key((<span class="number">4</span>, <span class="number">5</span>), &#123;&#125;, <span class="literal">True</span>))</span><br><span class="line"><span class="built_in">print</span>(_make_key((<span class="number">4</span>,), &#123;<span class="string">&#x27;y&#x27;</span>:<span class="number">5</span>&#125;, <span class="literal">False</span>))</span><br><span class="line"><span class="built_in">print</span>(_make_key((), &#123;<span class="string">&#x27;x&#x27;</span>:<span class="number">4</span>, <span class="string">&#x27;y&#x27;</span>:<span class="number">5</span>&#125;, <span class="literal">False</span>))</span><br><span class="line"><span class="built_in">print</span>(_make_key((), &#123;<span class="string">&#x27;y&#x27;</span>:<span class="number">5</span>, <span class="string">&#x27;x&#x27;</span>:<span class="number">4</span>&#125;, <span class="literal">False</span>))</span><br></pre></td></tr></table></figure><h3 id="3-2-应用">3.2 应用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 斐波那契数列lru_cache版</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">3</span> <span class="keyword">else</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(fib(<span class="number">101</span>))</span><br></pre></td></tr></table></figure><h3 id="3-3-总结">3.3 总结</h3><p>lru_cache装饰器应用</p><ul><li>使用前提<ol><li>同样的函数参数一定得到同样的结果，至少是一段时间内，同样输入得到同样结果</li><li>计算代价高，函数执行时间很长</li><li>需要多次执行，每一次计算代价高</li></ol></li><li>本质是建立函数调用的参数到返回值的映射</li><li>缺点<ul><li>不支持缓存过期，key无法过期、失效</li><li>不支持清除操作</li><li>不支持分布式，是一个单机的缓存</li></ul></li><li>lru_cache适用场景，单机上需要空间换时间的地方，可以用缓存来将计算变成快速的查询</li></ul><p>学习lru_cache可以让我们了解缓存背后的原理</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>插入排序</title>
      <link href="/20230628/python-20230628-%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/"/>
      <url>/20230628/python-20230628-%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p>插入排序</p><ul><li>每一趟都要把待排序数放到有序区中合适的插入位置</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230628142055.png" alt=""></p><h2 id="1-核心算法">1. 核心算法</h2><ul><li>结果可为升序或降序排列，默认升序排列。以升序为例</li><li>扩大有序区，减小无序区。图中绿色部分就是增大的有序区，黑色部分就是减小的无序区</li><li>增加一个哨兵位，图中最左端红色数字，其中放置每一趟待比较数值</li><li>将哨兵位数值与有序区数值从右到左依次比较，找到哨兵位数值合适的插入点</li></ul><h2 id="2-算法实现">2. 算法实现</h2><ul><li>增加哨兵位<ul><li>为了方便，采用列表头部索引0位置插入哨兵位</li><li>每一次从有序区最右端后的下一个数，即无序区最左端的数放到哨兵位</li></ul></li><li>比较与挪动<ul><li>从有序区最右端开始，从右至左依次与哨兵比较</li><li>比较数比哨兵大，则右移一下，换下一个左边的比较数</li><li>直到找到不大于哨兵的比较数，这是把哨兵插入到这个数右侧的空位即可</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line">nums = [<span class="number">0</span>] + m_list[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(nums[<span class="number">1</span>:])</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">count_move = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, length):  <span class="comment"># 测试的值从nums的索引2开始向后直到最后一个元素</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[i]  <span class="comment"># 索引0位哨兵，索引1位假设的有序区，都跳过</span></span><br><span class="line">    j = i - <span class="number">1</span>  <span class="comment"># i左边的那个数就是有序区末尾</span></span><br><span class="line">    <span class="keyword">if</span> nums[j] &gt; nums[<span class="number">0</span>]:  <span class="comment"># 如果最右侧数大于哨兵才需要挪动和插入</span></span><br><span class="line">        <span class="keyword">while</span> nums[j] &gt; nums[<span class="number">0</span>]:</span><br><span class="line">            nums[j + <span class="number">1</span>] = nums[j]  <span class="comment"># 右移，不是交换</span></span><br><span class="line">            j -= <span class="number">1</span>  <span class="comment"># 继续向左</span></span><br><span class="line">            count_move += <span class="number">1</span></span><br><span class="line">            nums[j + <span class="number">1</span>] = nums[<span class="number">0</span>]  <span class="comment"># 循环中多减了一次j</span></span><br><span class="line"><span class="built_in">print</span>(nums[<span class="number">1</span>:])</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-总结-2">3. 总结</h2><ul><li>最好情况，正好是升序排列，比较迭代n-1次</li><li>最差情况，正好是降序排列，比较迭代1,2,…,n-1即 n(n-1)/2，数据移动非常多</li><li>使用两层嵌套循环，时间复杂度O(n^2)</li><li>稳定排序算法<ul><li>如果待排序序列R中两元素相等，即Ri等于Rj，且i &lt; j ，那么排序后这个先后顺序不变，这种排序算法就称为稳定排序</li><li>已经学习过的排序算法哪些是稳定排序，考虑1、1、2排序</li></ul></li><li>使用在小规模数据比较</li><li>优化<ul><li>如果比较操作耗时大的话，可以采用二分查找来提高效率，即二分查找插入排序</li></ul></li></ul><h2 id="4-排序稳定性">4. 排序稳定性</h2><ul><li>冒泡排序，相同数据不交换，稳定</li><li>直接选择排序，相同数据前面的先选择到，排到有序区，不稳定</li><li>直接插入排序，相同数据不移动，相对位置不变，稳定</li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>类型注释</title>
      <link href="/20230627/python-20230627-%E7%B1%BB%E5%9E%8B%E6%B3%A8%E9%87%8A/"/>
      <url>/20230627/python-20230627-%E7%B1%BB%E5%9E%8B%E6%B3%A8%E9%87%8A/</url>
      
        <content type="html"><![CDATA[<p>Python是动态语言，变量可以随时被赋值并改变类型，也就是说Python的变量是运行时决定的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(add(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;fff&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(add([<span class="number">10</span>], [<span class="number">11</span>]))</span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">4</span>, <span class="string">&#x27;abc&#x27;</span>))  <span class="comment"># 不到运行时，无法判断类型是否正确</span></span><br></pre></td></tr></table></figure><p>动态语言缺点：</p><ol><li>难发现：由于不能做任何类型检查，往往到了运行时问题才显现出来，或到了线上运行时才暴露出来</li><li>难使用：函数使用者看到函数时，并不知道函数设计者的意图，如果没有详尽的文档，使用者只能猜测数据的类型。对于一个新的API，使用者往往不知道该怎么使用，对于返回的类型更是不知道该怎么使用</li></ol><p>动态类型对类型的约束不强，在小规模开发的危害不大，但是随着Python的广泛使用，这种缺点确实对大项目的开发危害非常大。</p><p>如何解决这种问题呢？</p><ol><li>文档字符串。对函数、类、模块使用详尽的使用描述、举例，让使用者使用帮助就能知道使用方式。但是，大多数项目管理不严格，可能文档不全，或者项目发生变动后，文档没有更新等等。</li><li>类型注解：函数注解、变量注解</li></ol><h2 id="2-函数注解">2. 函数注解</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x: <span class="built_in">int</span>, y: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param x: int</span></span><br><span class="line"><span class="string">    :param y: int</span></span><br><span class="line"><span class="string">    :return: int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>(add)</span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(add(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>函数注解</p><ul><li>3.5版本引入</li><li>对函数的形参和返回值的类型说明</li><li>只是对函数形参类型、返回值类型做的辅助的说明，非强制类型约束</li><li>第三方工具，例如Pycharm就可以根据类型注解进行代码分析，发现隐藏的Bug</li><li>函数注解存放在函数的属性 <strong>annotations</strong> 中，字典类型</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;x&#x27;</span>: &lt;<span class="keyword">class</span> <span class="string">&#x27;int&#x27;</span>&gt;, <span class="string">&#x27;y&#x27;</span>: &lt;<span class="keyword">class</span> <span class="string">&#x27;int&#x27;</span>&gt;, <span class="string">&#x27;return&#x27;</span>: &lt;<span class="keyword">class</span> <span class="string">&#x27;int&#x27;</span>&gt;&#125;</span><br></pre></td></tr></table></figure><h2 id="3-类型注解">3. 类型注解</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i:<span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line">j:<span class="built_in">str</span> = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line">k:<span class="built_in">str</span> = <span class="number">300</span></span><br><span class="line"><span class="built_in">print</span>(i, j, k)</span><br></pre></td></tr></table></figure><h2 id="4-类型注解">4.类型注解</h2><ul><li>3.6版本引入</li><li>对变量类型的说明，非强制约束</li><li>第三方工具可以进行类型分析和推断</li></ul><h2 id="5-类型检查">5. 类型检查</h2><p>函数传参经常传错，如何检查？</p><p>可以在函数内部写isinstance来判断参数类型是否正确，但是检查可以看做不是业务代码，写在里面就是侵入式代码。那如何更加灵活的检查呢？</p><ul><li>非侵入式代码</li><li>动态获取待检查的函数的参数类型注解</li><li>当函数调用传入实参时，和类型注解比对</li></ul><p>能否使用函数的 <strong>annotations</strong> 属性吗？虽然Python 3.6之后，字典记录了录入序，但是我们还是要认为字段是无顺序的。那如何和按位置传实参对应呢？</p><h2 id="6-使用inspect模块">6. 使用inspect模块</h2><p>inspect模块可以获取Python中各种对象信息。</p><ul><li>inspect.isfunction(add)，是否是函数</li><li>inspect.ismethod(pathlib.Path().absolute)，是否是类的方法，要绑定</li><li>inspect.isgenerator(add))，是否是生成器对象</li><li>inspect.isgeneratorfunction(add))，是否是生成器函数</li><li>inspect.isclass(add))，是否是类</li><li>inspect.ismodule(inspect))，是否是模块</li><li>inspect.isbuiltin(print))，是否是内建对象</li></ul><p>还有很多is函数，需要的时候查阅inspect模块帮助</p><p>inspect.signature(callable, *, follow_wrapped=True)</p><ul><li>获取可调用对象的签名</li><li>3.5增加follow_wrapped，如果使用functools的wraps或update_wrapper，follow_wrapped为True跟进被包装函数的 <strong>wrapped</strong> ，也就是去获取真正的被包装函数的签名</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x: <span class="built_in">int</span>, /, y: <span class="built_in">int</span> = <span class="number">5</span>, *args, m=<span class="number">6</span>, n, **kwargs</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> x + y + m + n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sig = inspect.signature(add)  <span class="comment"># 获取签名</span></span><br><span class="line"><span class="built_in">print</span>(sig)</span><br><span class="line"><span class="built_in">print</span>(sig.return_annotation)  <span class="comment"># 返回值注解</span></span><br><span class="line">params = sig.parameters  <span class="comment"># 所有参数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(params))</span><br><span class="line"><span class="built_in">print</span>(params)  <span class="comment"># 有序字典OrderedDict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> params.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(k), k, <span class="built_in">type</span>(v), v, sep=<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>inspect.Parameter</p><ul><li>4个属性<ul><li>name，参数名，字符串</li><li>default，缺省值</li><li>annotation，类型注解</li><li>kind，类型<ul><li>POSITIONAL_ONLY，只接受仅位置传参</li><li>POSITIONAL_OR_KEYWORD，可以接受关键字或者位置传参</li><li>VAR_POSITIONAL，可变位置参数，对应*args</li><li>KEYWORD_ONLY，对应<em>或者</em>args之后的出现的非可变关键字形参，只接受关键字传参</li><li>VAR_KEYWORD，可变关键字参数，对应**kwargs</li></ul></li></ul></li></ul><p>empty，特殊类，用来标记default属性或者annotation属性为空</p><h2 id="7-参数类型检查">7. 参数类型检查</h2><p>有如下函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y: <span class="built_in">int</span> = <span class="number">7</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>请检查用户的输入是否符合参数类型注解的要求</p><p>分析：</p><ul><li>调用时，用户才会传入实参，才能判断实参是否符合类型要求</li><li>调用时，让用户感觉上还是调用原函数</li><li>如果类型不符，提示用户</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">fn</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">fn</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        sig = inspect.signature(fn)</span><br><span class="line">        params = sig.parameters</span><br><span class="line"></span><br><span class="line">        values = <span class="built_in">tuple</span>(params.values())</span><br><span class="line">        <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(args):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (values[i].annotation <span class="keyword">is</span> <span class="keyword">not</span> values[i].empty <span class="keyword">and</span> <span class="built_in">isinstance</span>(v, values[i].annotation)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;warn! &#123;&#125;=&#123;&#125; not &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(values[i].name, v, values[i].annotation))  <span class="comment"># 有类型注解的检查</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (params[k].annotation <span class="keyword">is</span> <span class="keyword">not</span> inspect._empty <span class="keyword">and</span> <span class="built_in">isinstance</span>(v, params[k].annotation)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;warn! &#123;&#125;=&#123;&#125; not &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(k, v, params[k].annotation))  <span class="comment"># 有类型注解的检查</span></span><br><span class="line"></span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@check</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x: <span class="built_in">int</span>, y: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">3</span>, y=<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;#&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(add(<span class="string">&#x27;a&#x27;</span>, y=<span class="string">&#x27;b&#x27;</span>))</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line">warn! x=a not &lt;class <span class="string">&#x27;int&#x27;</span>&gt;</span><br><span class="line">warn! y=b not &lt;class <span class="string">&#x27;int&#x27;</span>&gt;</span><br><span class="line">ab</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>装饰器</title>
      <link href="/20230627/python-20230627-%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
      <url>/20230627/python-20230627-%E8%A3%85%E9%A5%B0%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-高阶函数">1. 高阶函数</h2><h3 id="1-1-一等公民">1.1 一等公民</h3><ul><li>函数在Python是一等公民（First-Class Object）</li><li>函数也是对象，是可调用对象</li><li>函数可以作为普通变量，也可以作为函数的参数、返回值</li></ul><h3 id="1-2-高阶函数">1.2 高阶函数</h3><p>高阶函数（High-order Function）</p><ul><li>数学概念 y = f(g(x))</li><li>在数学和计算机科学中，高阶函数应当是至少满足下面一个条件的函数<ul><li>接受一个或多个函数作为参数</li><li>输出一个函数</li></ul></li></ul><p>观察下面的函数定义，回答问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>(<span class="params">base</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>(<span class="params">step=<span class="number">1</span></span>):</span><br><span class="line">        base += step</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>请问counter是不是高阶函数？</li><li>上面代码有没有问题？如果有，如何改？</li><li>如何调用以完成计数功能？</li><li>f1 = counter(5)和f2=counter(5)，请问f1和f2相等吗？</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>(<span class="params">base</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>(<span class="params">step=<span class="number">1</span></span>):  <span class="comment"># 有没有闭包？</span></span><br><span class="line">        <span class="keyword">nonlocal</span> base  <span class="comment"># 形参base也是外部函数counter的local变量</span></span><br><span class="line">        base += step</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1 = counter(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(c1())</span><br><span class="line"><span class="built_in">print</span>(c1())</span><br><span class="line"><span class="built_in">print</span>(c1())</span><br><span class="line">f1 = counter(<span class="number">5</span>)</span><br><span class="line">f2 = counter(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(f1 == f2)  <span class="comment"># 相等吗？</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2-柯里化">2. 柯里化</h2><ul><li>指的是将原来接受两个参数的函数变成新的接受一个参数的函数的过程。新的函数返回一个以原有第二个参数为参数的函数</li><li>z = f(x, y) 转换成 z = f(x)(y)的形式</li></ul><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure><p>原来函数调用为 add(4, 5) ，柯里化目标是 add(4)(5) 。如何实现？</p><p>每一次括号说明是函数调用，说明 add(4)(5) 是2次函数调用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">4</span>)(<span class="number">5</span>)</span><br><span class="line">等价于</span><br><span class="line">t = add(<span class="number">4</span>)</span><br><span class="line">t(<span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>也就是说add(4)应该返回函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_add</span>(<span class="params">y</span>):</span><br><span class="line">        <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _add</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">100</span>)(<span class="number">200</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过嵌套函数就可以把函数转成柯里化函数。</p><h2 id="3-装饰器">3. 装饰器</h2><h3 id="3-1-由来">3.1 由来</h3><p>需求：为一个加法函数增加记录实参的功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;add called. x=&#123;&#125;, y=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x, y))  <span class="comment"># 增加的记录功能</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的代码满足了需求，但有缺点：<br>记录信息的功能，可以是一个单独的功能。显然和add函数耦合太紧密。加法函数属于业务功能，输出信息属于非功能代码，不该放在add函数中</p><p>1、提供一个函数logger完成记录功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">    ret = fn(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(logger(add))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、改进传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn, *args, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">    ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(logger(add, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、柯里化</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>调用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(logger(add)(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inner = logger(add)</span><br><span class="line">x = inner(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure><p>再进一步</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add = logger(add)</span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">100</span>, <span class="number">200</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4、装饰器语法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger  </span><span class="comment"># 等价于 add = wrapper &lt;=&gt; add = logger(add)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">100</span>, <span class="number">200</span>))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@logger就是装饰器语法</p><p>等价式非常重要，如果你不能理解装饰器，开始的时候一定要把等价式写在后面</p><h3 id="3-2-无参装饰器">3.2 无参装饰器</h3><ul><li>上例的装饰器语法，称为无参装饰器</li><li>@符号后是一个函数</li><li>虽然是无参装饰器，但是@后的函数本质上是单参函数</li><li>上例的logger函数是一个高阶函数</li></ul><h3 id="3-3-日志记录装饰器实现">3.3 日志记录装饰器实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Function &#123;&#125; took &#123;&#125;s.&#x27;</span>.<span class="built_in">format</span>(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger  </span><span class="comment"># 等价于 add = wrapper &lt;=&gt; add = logger(add)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">100</span>, <span class="number">200</span>))</span><br></pre></td></tr></table></figure><h3 id="3-4-装饰器本质">3.4 装饰器本质</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230627191209.png" alt=""></p><p>如何类比上图和装饰器呢</p><h3 id="3-5-文档字符串">3.5 文档字符串</h3><ul><li>Python文档字符串Documentation Strings</li><li>在函数（类、模块）语句块的第一行，且习惯是多行的文本，所以多使用三引号</li><li>文档字符串也算是合法的一条语句</li><li>惯例是首字母大写，第一行写概述，空一行，第三行写详细描述</li><li>可以使用特殊属性__doc__访问这个文档</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;这是加法函数的文档&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&#x27;s doc = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(add.__name__, add.__doc__))</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;wrapper&#x27;s doc&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Function &#123;&#125; took &#123;&#125;s.&#x27;</span>.<span class="built_in">format</span>(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger  </span><span class="comment"># 等价于 add = wrapper &lt;=&gt; add = logger(add)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;add&#x27;s doc&quot;&quot;&quot;</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name=&#123;&#125;, doc=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(add.__name__, add.__doc__))</span><br></pre></td></tr></table></figure><p>被装饰后，函数名和文档都不对了。如何解决？</p><p>functools模块提供了一个wraps装饰器函数，本质上调用的是update_wrapper，它就是一个属性复制函数。</p><p>wraps(wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)</p><ul><li>wrapped就是被包装函数</li><li>wrapper就是包装函数</li><li>用被包装函数的属性覆盖包装函数的同名属性</li><li>元组WRAPPER_ASSIGNMENTS中是要被覆盖的属性<ul><li><strong>module</strong> , <strong>name</strong> , <strong>qualname</strong> , <strong>doc</strong> , <strong>annotations</strong></li><li>模块名、名称、限定名、文档、参数注解</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger</span>(<span class="params">fn</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">fn</span>)  </span><span class="comment"># 用被包装函数fn的属性覆盖包装函数wrapper的同名属性</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;wrapper&#x27;s doc&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用前增强&#x27;</span>)</span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args, **kwargs)  <span class="comment"># 参数解构</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;调用后增强&#x27;</span>)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Function &#123;&#125; took &#123;&#125;s.&#x27;</span>.<span class="built_in">format</span>(fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger  </span><span class="comment"># 等价于 add = wrapper &lt;=&gt; add = logger(add)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;add&#x27;s doc&quot;&quot;&quot;</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name=&#123;&#125;, doc=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(add.__name__, add.__doc__))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-6-带参装饰器">3.6 带参装饰器</h3><ul><li>@之后不是一个单独的标识符，是一个函数调用</li><li>函数调用的返回值又是一个函数，此函数是一个无参装饰器</li><li>带参装饰器，可以有任意个参数<ul><li>@func()</li><li>@func(1)</li><li>@func(1, 2)</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>选择排序</title>
      <link href="/20230627/python-20230627-%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/"/>
      <url>/20230627/python-20230627-%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简单选择排序">1. 简单选择排序</h2><ul><li>选择排序<ul><li>每一趟两两比较大小，找出极值（极大值或极小值）并放置到有序区的位置</li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230627145748.png" alt=""></p><h3 id="1-1-核心算法-2">1.1 核心算法</h3><ul><li>结果可为升序或降序排列，默认升序排列。以降序为例</li><li>扩大有序区，减小无序区。图中红色部分就是增大的有序区，反之就是减小的无序区</li><li>相邻元素依次两两比较，获得每一次比较后的最大值，并记住此值的索引</li><li>每一趟都从无序区中选择出最大值，然后交换到当前无序区最左端</li></ul><h3 id="1-2-算法实现">1.2 算法实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line">nums = m_list[<span class="number">0</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="comment"># 选择排序</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>):</span><br><span class="line">    maxindex = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, length):</span><br><span class="line">        count_iter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line">    <span class="keyword">if</span> maxindex != i:</span><br><span class="line">        nums[maxindex], nums[i] = nums[i], nums[maxindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(count_iter, count_swap)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2-二元选择排序">2. 二元选择排序</h2><ul><li>同时选择出每一趟的最大值和最小值，并分别固定到两端的有序区</li><li>减少迭代的趟数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line">nums = m_list[<span class="number">1</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length // <span class="number">2</span>):  <span class="comment"># 一次固定2个数，减半</span></span><br><span class="line">    maxindex = i  <span class="comment"># 正索引，假设无序区第一个就是最大数，其索引记作最大</span></span><br><span class="line">    minindex = -i - <span class="number">1</span>  <span class="comment"># 负索引，假设无序区最后一个就是最小数，其索引记作最小</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, length - i):  <span class="comment"># 每次左边加一个，右边也要减一个，表示无序区两端都减少</span></span><br><span class="line">        count_iter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line">        <span class="keyword">if</span> nums[minindex] &gt; nums[-j - <span class="number">1</span>]:</span><br><span class="line">            minindex = -j - <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(maxindex, i, &quot;|||&quot;, minindex, -i-1)</span></span><br><span class="line">    <span class="keyword">if</span> maxindex != i:</span><br><span class="line">        nums[maxindex], nums[i] = nums[i], nums[maxindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line">        <span class="comment"># [1, 3, 2]为例，如果i位置上就是最小值，走到这里，说明最大值和最小值交换过了，要调整最小值索引为maxindex</span></span><br><span class="line">        <span class="keyword">if</span> i == length + minindex:</span><br><span class="line">            minindex = maxindex - length</span><br><span class="line">    <span class="keyword">if</span> minindex != -i - <span class="number">1</span>:  <span class="comment"># 负索引比较</span></span><br><span class="line">        nums[minindex], nums[-i - <span class="number">1</span>] = nums[-i - <span class="number">1</span>], nums[minindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(count_iter, count_swap)</span><br></pre></td></tr></table></figure><p>以上代码还有没有优化的可能？</p><p>如果一趟比较后，极大值、极小值的值相等，说明什么？</p><p>说明，剩余比较的数将全部相等，那么排序可以立即停止</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line">nums = m_list[<span class="number">1</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length // <span class="number">2</span>):  <span class="comment"># 一次固定2个数，减半</span></span><br><span class="line">    maxindex = i  <span class="comment"># 正索引，假设无序区第一个就是最大数，其索引记作最大</span></span><br><span class="line">    minindex = -i - <span class="number">1</span>  <span class="comment"># 负索引，假设无序区最后一个就是最小数，其索引记作最小</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, length - i):  <span class="comment"># 每次左边加一个，右边也要减一个，表示无序区两端都减少</span></span><br><span class="line">        count_iter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line">        <span class="keyword">if</span> nums[minindex] &gt; nums[-j - <span class="number">1</span>]:</span><br><span class="line">            minindex = -j - <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(maxindex, i, &quot;|||&quot;, minindex, -i-1)</span></span><br><span class="line">    <span class="keyword">if</span> nums[maxindex] == nums[minindex]:  <span class="comment"># 元素全相同</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> maxindex != i:</span><br><span class="line">        nums[maxindex], nums[i] = nums[i], nums[maxindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line">        <span class="comment"># [1, 3, 2]为例，如果i位置上就是最小值，走到这里，说明最大值和最小值交换过了，要调整最小值索引为maxindex</span></span><br><span class="line">        <span class="keyword">if</span> i == length + minindex:</span><br><span class="line">            minindex = maxindex - length</span><br><span class="line">    <span class="keyword">if</span> minindex != -i - <span class="number">1</span>:  <span class="comment"># 负索引比较</span></span><br><span class="line">        nums[minindex], nums[-i - <span class="number">1</span>] = nums[-i - <span class="number">1</span>], nums[minindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(count_iter, count_swap)</span><br></pre></td></tr></table></figure><p>考虑一种特殊情况<br>[1, 1, 1, 1, 1, 1, 1, 1, 2] 这种情况，找到的最小值索引是-2，最大值索引8，上面的代码会交换2次，最小值两个1交换是无用功，所以，增加一个判断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">nums = m_list[<span class="number">4</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length // <span class="number">2</span>):  <span class="comment"># 一次固定2个数，减半</span></span><br><span class="line">    maxindex = i  <span class="comment"># 正索引，假设无序区第一个就是最大数，其索引记作最大</span></span><br><span class="line">    minindex = -i - <span class="number">1</span>  <span class="comment"># 负索引，假设无序区最后一个就是最小数，其索引记作最小</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, length - i):  <span class="comment"># 每次左边加一个，右边也要减一个，表示无序区两端都减少</span></span><br><span class="line">        count_iter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line">        <span class="keyword">if</span> nums[minindex] &gt; nums[-j - <span class="number">1</span>]:</span><br><span class="line">            minindex = -j - <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(maxindex, i, &quot;|||&quot;, minindex, -i-1)</span></span><br><span class="line">    <span class="keyword">if</span> nums[maxindex] == nums[minindex]:  <span class="comment"># 元素全相同</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> maxindex != i:</span><br><span class="line">        nums[maxindex], nums[i] = nums[i], nums[maxindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line">        <span class="comment"># [1, 3, 2]为例，如果i位置上就是最小值，走到这里，说明最大值和最小值交换过了，要调整最小值索引为maxindex</span></span><br><span class="line">        <span class="keyword">if</span> i == length + minindex:</span><br><span class="line">            minindex = maxindex - length</span><br><span class="line">    <span class="keyword">if</span> minindex != -i - <span class="number">1</span> <span class="keyword">and</span> nums[minindex] != nums[-i - <span class="number">1</span>]:  <span class="comment"># 负索引比较，值不一样再交换</span></span><br><span class="line">        nums[minindex], nums[-i - <span class="number">1</span>] = nums[-i - <span class="number">1</span>], nums[minindex]</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(count_iter, count_swap)</span><br></pre></td></tr></table></figure><h2 id="3-总结">3. 总结</h2><ul><li>简单选择排序需要数据一趟趟比较，并在每一趟中发现极值</li><li>没有办法知道当前这一趟是否已经达到排序要求，但是可以知道极值是否在目标索引位置上</li><li>遍历次数1,…,n-1之和n(n-1)/2</li><li>时间复杂度O(n2)</li><li>减少了交换次数，提高了效率，性能略好于冒泡法</li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>冒泡排序</title>
      <link href="/20230627/python-20230627-%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/"/>
      <url>/20230627/python-20230627-%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="1-冒泡排序Bubble-Sort">1. 冒泡排序Bubble Sort</h2><ul><li>交换排序<ul><li>相邻元素两两比较大小，有必要则交换</li><li>元素越小或越大，就会在数列中慢慢的交换并“浮”向顶端，如同水泡咕嘟咕嘟往上冒</li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230627132708.png" alt=""></p><h3 id="1-1-核心算法">1.1 核心算法</h3><ul><li>排序算法，一般都实现为就地排序，输出为升序</li><li>扩大有序区，减小无序区。图中红色部分就是增大的有序区，反之就是减小的无序区</li><li>每一趟比较中，将无序区中所有元素依次两两比较，升序排序将大数调整到两数中的右侧</li><li>每一趟比较完成，都会把这一趟的最大数推倒当前无序区的最右侧</li></ul><h3 id="1-2-基本实现">1.2 基本实现</h3><p>思考时，将问题规模减小，一般2次不一定能找到规律，3次基本上可以看出规律。所以，我们思考时认为列表里面就只有4个元素。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nums = [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>]  <span class="comment"># 数字少好思考</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)  <span class="comment"># 4</span></span><br><span class="line"><span class="comment"># 第一趟</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="comment"># 本趟内两两比较，大数换到右边</span></span><br><span class="line"><span class="comment"># 2个数比1下，3个数比2下，那么比较次数就是当前比较数个数-1</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>):  <span class="comment"># j 为0, 1, 2</span></span><br><span class="line">    <span class="built_in">print</span>(j, nums[j], nums[j + <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> nums[j] &gt; nums[j + <span class="number">1</span>]:  <span class="comment"># 只有大于才交换，小于等于就不用了</span></span><br><span class="line">        temp = nums[j]</span><br><span class="line">        nums[j] = nums[j + <span class="number">1</span>]</span><br><span class="line">        nums[j + <span class="number">1</span>] = temp</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line"><span class="comment"># i取0、1、2试一试</span></span><br></pre></td></tr></table></figure><p>上面代码已经基本上完成了核心比较交换算法。下面解决每一趟的问题。</p><p>每一趟无序区是减小1个的，所以考虑使用两个循环，外面 i 循环表示趟，里面 j 循环表示每一趟的两两比较。内层 j 循环正好可以使用外层的 i，用在range(length-1-i)，因为i第一次为0相当于没有减，第二次就是1了，这里range当计数器用表示走几趟。</p><p>i 循环控制趟数，4个数比较3趟就可以了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nums = [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>]  <span class="comment"># 数字少好思考</span></span><br><span class="line"><span class="comment"># nums = [1, 9, 8, 5, 6, 7, 4, 3, 2]</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)  <span class="comment"># 4</span></span><br><span class="line"><span class="comment"># i 控制趟数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>):</span><br><span class="line">    <span class="comment"># 本趟内两两比较，大数换到右边</span></span><br><span class="line">    <span class="comment"># 2个数比1下，3个数比2下，那么比较次数就是当前比较数个数-1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span> - i):  <span class="comment"># j 为0, 1, 2</span></span><br><span class="line">        <span class="built_in">print</span>(j, nums[j], nums[j + <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j + <span class="number">1</span>]:  <span class="comment"># 只有大于才交换，小于等于就不用了</span></span><br><span class="line">            temp = nums[j]</span><br><span class="line">            nums[j] = nums[j + <span class="number">1</span>]</span><br><span class="line">            nums[j + <span class="number">1</span>] = temp</span><br><span class="line">        <span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;result = &#x27;</span>, nums)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以增加两个变量：count表示比较的次数，count_swap表示交换的次数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nums = [<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>]  <span class="comment"># 数字少好思考</span></span><br><span class="line"><span class="comment"># nums = [1, 9, 8, 5, 6, 7, 4, 3, 2]</span></span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)  <span class="comment"># 4</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="comment"># i 控制趟数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>):</span><br><span class="line">    <span class="comment"># 本趟内两两比较，大数换到右边</span></span><br><span class="line">    <span class="comment"># 2个数比1下，3个数比2下，那么比较次数就是当前比较数个数-1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span> - i):  <span class="comment"># j 为0, 1, 2</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j + <span class="number">1</span>]:  <span class="comment"># 只有大于才交换，小于等于就不用了</span></span><br><span class="line">            temp = nums[j]</span><br><span class="line">            nums[j] = nums[j + <span class="number">1</span>]</span><br><span class="line">            nums[j + <span class="number">1</span>] = temp</span><br><span class="line">            count_swap += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;result = &#x27;</span>, nums)</span><br><span class="line"><span class="built_in">print</span>(count, count_swap)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-3-优化">1.3 优化</h3><p>思考：如果某一趟两两比较后没有发生任何交换，说明什么？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nums = [1, 9, 8, 5] # 数字少好思考</span></span><br><span class="line"><span class="comment"># nums = [1, 9, 8, 5, 6, 7, 4, 3, 2]</span></span><br><span class="line">nums = [<span class="number">9</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line"><span class="built_in">print</span>(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)  <span class="comment"># 4</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line"><span class="comment"># i 控制趟数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span>):</span><br><span class="line">    <span class="comment"># 假设这一趟不需要交换了</span></span><br><span class="line">    finished = <span class="literal">True</span>  <span class="comment"># 定义标记</span></span><br><span class="line">    <span class="comment"># 本趟内两两比较，大数换到右边</span></span><br><span class="line">    <span class="comment"># 2个数比1下，3个数比2下，那么比较次数就是当前比较数个数-1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">1</span> - i):  <span class="comment"># j 为0, 1, 2</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j + <span class="number">1</span>]:  <span class="comment"># 只有大于才交换，小于等于就不用了</span></span><br><span class="line">            temp = nums[j]</span><br><span class="line">            nums[j] = nums[j + <span class="number">1</span>]</span><br><span class="line">            nums[j + <span class="number">1</span>] = temp</span><br><span class="line">            count_swap += <span class="number">1</span></span><br><span class="line">            finished = <span class="literal">False</span>  <span class="comment"># 有一次交换就要标记为False</span></span><br><span class="line">    <span class="keyword">if</span> finished:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(nums)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;result = &#x27;</span>, nums)</span><br><span class="line"><span class="built_in">print</span>(count, count_swap)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-4-总结">1.4 总结</h3><ul><li>冒泡法需要数据一趟趟比较</li><li>可以设定一个标记判断此轮是否有数据交换发生，如果没有发生交换，可以结束排序，如果发生交换，继续下一轮排序</li><li>最差的排序情况是，初始顺序与目标顺序完全相反，遍历次数1,…,n-1之和n(n-1)/2</li><li>最好的排序情况是，初始顺序与目标顺序完全相同，遍历次数n-1</li><li>时间复杂度O(n2)</li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>可迭代对象和内建函数</title>
      <link href="/20230625/python-20230625-%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/"/>
      <url>/20230625/python-20230625-%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-可迭代对象">1. 可迭代对象</h2><table><thead><tr><th>建函数</th><th>函数签名</th><th>说明</th></tr></thead><tbody><tr><td>iter</td><td>iter(iterable)</td><td>把一个可迭代对象包装成迭代器</td></tr><tr><td>next</td><td>next(iterable[, default])</td><td>取迭代器下一个元素</br>如果已经取完，继续取抛StopIteration异常</td></tr><tr><td>reversed</td><td>reversed(seq)</td><td>返回一个翻转元素的迭代器</td></tr><tr><td>enumerate</td><td>enumerate(seq, start=0)</td><td>迭代一个可迭代对象，返回一个迭代器</br>每一个元素都是数字和元素构成的二元组</td></tr></tbody></table><p><strong>迭代器</strong></p><ul><li>特殊的对象，一定是可迭代对象，具备可迭代对象的特征</li><li>通过iter方法把一个可迭代对象封装成迭代器</li><li>通过next方法，获取 迭代器对象的一个元素</li><li>生成器对象，就是迭代器对象。但是迭代器对象未必是生成器对象</li></ul><p><strong>可迭代对象</strong></p><ul><li>能够通过迭代一次次返回不同的元素的对象<ul><li>所谓相同，不是指值是否相同，而是元素在容器中是否是同一个，例如列表中值可以重复的，</li><li>[‘a’, ‘a’]，虽然这个列表有2个元素，值一样，但是两个’a’是不同的元素</li></ul></li><li>可以迭代，但是未必有序，未必可索引</li><li>可迭代对象有：list、tuple、string、bytes、bytearray、range、set、dict、生成器、迭代器等</li><li>可以使用成员操作符in、not in<ul><li>对于线性数据结构，in本质上是在遍历对象，时间复杂度为O(n)</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lst = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br><span class="line">it = <span class="built_in">iter</span>(lst) <span class="comment"># 返回一个迭代器对象&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(it))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(it))</span><br><span class="line"><span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(it, <span class="number">2</span>):</span><br><span class="line"><span class="built_in">print</span>(i, x)</span><br><span class="line"><span class="comment">#print(next(it)) # StopIteration</span></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>(lst):</span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"><span class="comment"># 比较下面的区别，说明原因？</span></span><br><span class="line">it = <span class="built_in">iter</span>(lst)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">in</span> it)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">in</span> it)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">in</span> lst)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> <span class="keyword">in</span> lst)</span><br></pre></td></tr></table></figure><h2 id="2-内建函数">2. 内建函数</h2><h3 id="2-1-排序sorted">2.1 排序sorted</h3><p>定义 sorted(iterable, *, key=None, reverse=False) -&gt;list</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sorted</span>(lst, key=<span class="keyword">lambda</span> x:<span class="number">6</span>-x) <span class="comment"># 返回新列表</span></span><br><span class="line"><span class="built_in">list</span>.sort(key=<span class="keyword">lambda</span> x: <span class="number">6</span>-x) <span class="comment"># 就地修改</span></span><br><span class="line"><span class="built_in">sorted</span>([<span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">3</span>], key=<span class="keyword">lambda</span> x: <span class="built_in">str</span>(x))</span><br><span class="line"><span class="built_in">sorted</span>([<span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">3</span>], key=<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-过滤filter">2.2 过滤filter</h3><ul><li>定义 filter(function, iterable)</li><li>对可迭代对象进行遍历，返回一个迭代器</li><li>function参数是一个参数的函数，且返回值应当是bool类型，或其返回值等效布尔值。</li><li>function参数如果是None，可迭代对象的每一个元素自身等效布尔值</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x%<span class="number">3</span>==<span class="number">0</span>, [<span class="number">1</span>,<span class="number">9</span>,<span class="number">55</span>,<span class="number">150</span>,-<span class="number">3</span>,<span class="number">78</span>,<span class="number">28</span>,<span class="number">123</span>]))</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="literal">None</span>, <span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="literal">None</span>, <span class="built_in">range</span>(-<span class="number">5</span>, <span class="number">5</span>)))</span><br></pre></td></tr></table></figure><h3 id="2-3-映射map">2.3 映射map</h3><ul><li>定义 map(function, *iterables) -&gt; map object</li><li>对多个可迭代对象的元素，按照指定的函数进行映射</li><li>返回一个迭代器</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="number">2</span>*x+<span class="number">1</span>, <span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="built_in">dict</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: (x%<span class="number">5</span>, x), <span class="built_in">range</span>(<span class="number">500</span>)))</span><br><span class="line"><span class="built_in">dict</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x,y: (x,y), <span class="string">&#x27;abcde&#x27;</span>, <span class="built_in">range</span>(<span class="number">10</span>)))</span><br></pre></td></tr></table></figure><h3 id="2-4-拉链函数zip">2.4 拉链函数zip</h3><ul><li>zip(*iterables)</li><li>像拉链一样，把多个可迭代对象合并在一起，返回一个迭代器</li><li>将每次从不同对象中取到的元素合并成一个元组</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">5</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="built_in">dict</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line">&#123;<span class="built_in">str</span>(x):y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>))&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>递归函数</title>
      <link href="/20230625/python-20230625-%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0/"/>
      <url>/20230625/python-20230625-%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-函数执行流程">1. 函数执行流程</h2><p>C语言中，函数的活动和栈有关。</p><p>栈是后进先出的数据结构。栈是由底端向顶端生长，栈顶加入数据称为压栈、入栈，栈顶弹出数据称为出栈。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    r = x + y</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    b = add(a, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>main调用，在栈顶创建栈帧</li><li>a = 1，在main栈帧中增加a，堆里增加1，a指向这个1</li><li>b = add(a, 2)，等式右边先执行，add函数调用</li><li>add调用，在栈顶创建栈帧，压在main栈帧上面</li><li>add栈帧中增加2个变量，x变量指向1，y指向堆中新的对象2</li><li>在堆中保存计算结果3，并在add栈帧中增加r指向3</li><li>print函数创建栈帧，实参r被压入print的栈帧中</li><li>print函数执行完毕，函数返回，移除栈帧</li><li>add函数返回，移除栈帧</li><li>main栈帧中增加b指向add函数的返回值对象</li><li>main函数返回，移除栈帧</li></ul><p>问题：如果再次调用main函数，和刚才的main函数调用，有什么关系？</p><p>每一次函数调用都会创建一个独立的栈帧入栈。</p><p>因此，可以得到这样一句不准确的话：哪怕是同一个函数两次调用，每一次调用都是独立的，这两次调用没什么关系。</p><h2 id="2-递归">2. 递归</h2><ul><li>函数直接或者间接调用自身就是 递归</li><li>递归需要有边界条件、递归前进段、递归返回段</li><li>递归一定要有边界条件</li><li>当边界条件不满足的时候，递归前进</li><li>当边界条件满足的时候，递归返回</li></ul><h3 id="2-1-斐波那契数列递归">2.1 斐波那契数列递归</h3><p>斐波那契数列Fibonacci number：1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, …</p><p>如果设F(n）为该数列的第n项（n∈N*），那么这句话可以写成如下形式：:F(n)=F(n-1)+F(n-2)<br>有F(0)=0，F(1)=1, F(n)=F(n-1)+F(n-2)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 递归</span></span><br><span class="line"><span class="comment"># 递归</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib_v2</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> fib_v2(n - <span class="number">1</span>) + fib_v2(n - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib_v2</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">3</span> <span class="keyword">else</span> fib_v2(n - <span class="number">1</span>) + fib_v2(n - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fib_v2(<span class="number">35</span>)  <span class="comment"># 9227465</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>递归实现很美，但是执行fib(35)就已经非常慢了，为什么？</p><p>以fib(5)为例。看了下图后，fib(6)是怎样计算的呢？</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230625181246.png" alt=""></p><p>这个函数进行了大量的重复计算，所以慢。</p><h3 id="2-2-递归要求">2.2 递归要求</h3><ul><li>递归一定要有退出条件，递归调用一定要执行到这个退出条件。没有退出条件的递归调用，就是无限调用</li><li>递归调用的深度不宜过深</li><li>Python对递归调用的深度做了限制，以保护解释器<ul><li>超过递归深度限制，抛出RecursionError： maxinum recursion depth exceeded 超出最大深度</li><li>sys.getrecursionlimit()</li></ul></li></ul><h3 id="2-3-递归效率">2.3 递归效率</h3><p>使用时间差或者%%timeit来测试一下这两个版本斐波那契数列的效率。很明显循环版效率高。</p><p>难道递归函数实现，就意味着效率低吗？</p><p>能否改进一下fib_v2函数？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 递归</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib_v3</span>(<span class="params">n, a=<span class="number">1</span>, b=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> b</span><br><span class="line">    a, b = b, a + b</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(n, a, b)</span></span><br><span class="line">    <span class="keyword">return</span> fib_v3(n - <span class="number">1</span>, a, b)  <span class="comment"># 函数调用次数就成了循环次数，将上次的计算结果代入下次函数调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fib_v3(<span class="number">101</span>)  <span class="comment"># fib_v3(35)</span></span><br><span class="line"><span class="comment"># 提示：用fib_v3(3)代入思考递归后计算了几次</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-4-间接递归">2.4 间接递归</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">foo1</span>():</span><br><span class="line">    foo2()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo2</span>():</span><br><span class="line">    foo1()</span><br><span class="line"></span><br><span class="line">foo1()</span><br></pre></td></tr></table></figure><p>间接递归调用，是函数通过别的函数调用了自己，这一样是递归。</p><p>只要是递归调用，不管是直接还是间接，都要注意边界返回问题。但是间接递归调用有时候是非常不明显，代码调用复杂时，很难发现出现了递归调用，这是非常危险的。</p><p>所有，使用良好的代码规范来避免这种递归的发生。</p><p><strong>总结</strong></p><ul><li>递归是一种很自然的表达，符合逻辑思维</li><li>递归相对运行效率低，每一次调用函数都要开辟栈帧</li><li>递归有深度限制，如果递归层次太深，函数连续压栈，栈内存很快就溢出了</li><li>如果是有限次数的递归，可以使用递归调用，或者使用循环代替，循环代码稍微复杂一些，但是只</li><li>要不是死循环，可以多次迭代直至算出结果</li><li>绝大多数递归，都可以使用循环实现</li><li>即使递归代码很简洁，但是能不用则不用递归s</li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>匿名函数、生成器函数</title>
      <link href="/20230625/python-20230625-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8%E5%87%BD%E6%95%B0/"/>
      <url>/20230625/python-20230625-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-匿名函数">1. 匿名函数</h2><p>匿名：隐藏名字，即没有名称</p><p>匿名函数：没有名字的函数。</p><p>函数没有名字该如何定义？函数没有名字如何调用？</p><h3 id="1-1-Lambda表达式">1.1 Lambda表达式</h3><p>Python中，使用Lambda表达式构建匿名函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> x: x ** <span class="number">2</span> <span class="comment"># 定义</span></span><br><span class="line">(<span class="keyword">lambda</span> x: x ** <span class="number">2</span>)(<span class="number">4</span>) <span class="comment"># 调用</span></span><br><span class="line">foo = <span class="keyword">lambda</span> x,y: (x+y) ** <span class="number">2</span> <span class="comment"># 定义函数</span></span><br><span class="line">foo(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> (x+y) ** <span class="number">2</span></span><br></pre></td></tr></table></figure><ul><li>使用lambda关键字定义匿名函数，格式为 lambda [参数列表]: 表达式</li><li>参数列表不需要小括号。无参就不写参数</li><li>冒号用来分割参数列表和表达式部分</li><li>不需要使用return。表达式的值，就是匿名函数的返回值。表达式中不能出现等号</li><li>lambda表达式（匿名函数）只能写在一行上，也称为单行函数</li></ul><p>匿名函数往往用在为高阶函数传参时，使用lambda表达式，往往能简化代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 返回常量的函数</span></span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> :<span class="number">0</span>)())</span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> x:<span class="number">100</span>)(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># 加法匿名函数，带缺省值</span></span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> x, y=<span class="number">3</span>: x + y)(<span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> x, y=<span class="number">3</span>: x + y)(<span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line"><span class="comment"># keyword-only参数</span></span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> x, *, y=<span class="number">30</span>: x + y)(<span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> x, *, y=<span class="number">30</span>: x + y)(<span class="number">5</span>, y=<span class="number">10</span>))</span><br><span class="line"><span class="comment"># 可变参数</span></span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> *args: (x <span class="keyword">for</span> x <span class="keyword">in</span> args))(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> *args: [x+<span class="number">1</span> <span class="keyword">for</span> x <span class="keyword">in</span> args])(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line"><span class="built_in">print</span>((<span class="keyword">lambda</span> *args: &#123;x%<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> args&#125;)(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br></pre></td></tr></table></figure><h3 id="1-2-应用">1.2 应用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需求，构建一个字典，所有key对应的值是一个列表，创建新的kv对的值也是空列表</span></span><br><span class="line">d = &#123;c:[] <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;abcde&#x27;</span>&#125;</span><br><span class="line">d[<span class="string">&#x27;a&#x27;</span>].append(<span class="number">10</span>) <span class="comment"># &#123;&#x27;a&#x27;: [10], &#x27;b&#x27;: [], &#x27;c&#x27;: [], &#x27;d&#x27;: [], &#x27;e&#x27;: []&#125;</span></span><br><span class="line">d[<span class="string">&#x27;f&#x27;</span>] = [] <span class="comment"># 新增key，value是空列表</span></span><br><span class="line">d[<span class="string">&#x27;f&#x27;</span>].append(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># defaultdict</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line">d = defaultdict(<span class="built_in">list</span>) <span class="comment"># lambda : list()</span></span><br><span class="line">d[<span class="string">&#x27;a&#x27;</span>].append(<span class="string">&#x27;10&#x27;</span>) <span class="comment"># d[&#x27;a&#x27;] = list()</span></span><br><span class="line">d[<span class="string">&#x27;f&#x27;</span>].append(<span class="string">&#x27;20&#x27;</span>)</span><br><span class="line"><span class="comment"># sorted</span></span><br><span class="line">x = [<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;c&#x27;</span>, <span class="number">32</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(x, key=<span class="built_in">str</span>))</span><br><span class="line"><span class="comment"># 如果按照数字排序怎么做？</span></span><br><span class="line">x = [<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;c&#x27;</span>, <span class="number">32</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(x, key=<span class="keyword">lambda</span> x: x <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">else</span> <span class="built_in">int</span>(x, <span class="number">16</span>)))</span><br></pre></td></tr></table></figure><h2 id="2-生成器函数">2. 生成器函数</h2><p>Python中有2种方式构造生成器对象：</p><ul><li><ol><li>生成器表达式</li></ol></li><li><ol start="2"><li>生成器函数</li></ol><ul><li>函数体代码中包含yield语句的函数</li><li>与普通函数调用不同，生成器函数调用返回的是生成器对象</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">m = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(m))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(m))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(m))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(inc))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(inc())) <span class="comment"># 生成器函数一定要调用，返回生成器对象</span></span><br><span class="line"></span><br><span class="line">g = inc() <span class="comment"># 返回新的生成器对象</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> g:</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-------------------&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> g: <span class="comment"># 还能迭代出元素吗？</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure><p>普通函数调用，函数会立即执行直到执行完毕。</p><p>生成器函数调用，并不会立即执行函数体，而是返回一个生成器对象，需要使用next函数来驱动这个生成器对象，或者使用循环来驱动。</p><p>生成器表达式和生成器函数都可以得到生成器对象，只不过生成器函数可以写更加复杂的逻辑。</p><h3 id="2-1-执行过程">2.1 执行过程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">4</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">6</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(gen()))  <span class="comment"># 看到什么</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(gen()))  <span class="comment"># 看到什么</span></span><br><span class="line">g = gen()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># return的值可以拿到吗？</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g, <span class="string">&#x27;End&#x27;</span>))  <span class="comment"># 没有元素不想抛异常，给个缺省值</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在生成器函数中，可以多次yield，每执行一次yield后会暂停执行，把yield表达式的值返回</li><li>再次执行会执行到下一个yield语句又会暂停执行</li><li>函数返回<ul><li>return语句依然可以终止函数运行，但return语句的返回值不能被获取到</li><li>return会导致当前函数返回，无法继续执行，也无法继续获取下一个值，抛出StopIteration异常</li><li>如果函数没有显式的return语句，如果生成器函数执行到结尾（相当于执行了returnNone），一样会抛出StopIteration异常</li></ul></li></ul><p><strong>生成器函数</strong></p><ul><li>包含yield语句的生成器函数调用后，生成生成器对象的时候，生成器函数的函数体不会立即执行</li><li>next(generator) 会从函数的当前位置向后执行到之后碰到的第一个yield语句，会弹出值，并暂停函数执行</li><li>再次调用next函数，和上一条一样的处理过程</li><li>继续调用next函数，生成器函数如果结束执行了（显式或隐式调用了return语句），会抛出StopIteration异常</li></ul><h3 id="2-2-应用">2.2 应用</h3><h4 id="2-2-1-无限循环">2.2.1 无限循环</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c = counter()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(c))  <span class="comment"># 打印什么</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(c))  <span class="comment"># 打印什么</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(c))  <span class="comment"># 打印什么</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-2-2-计数器">2.2.2 计数器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    c = counter()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">next</span>(c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inc())  <span class="comment"># 打印什么?</span></span><br><span class="line"><span class="built_in">print</span>(inc())  <span class="comment"># 打印什么?</span></span><br><span class="line"><span class="built_in">print</span>(inc())  <span class="comment"># 打印什么?为什么?如何修改</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改上例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    c = counter()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">next</span>(c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner  <span class="comment"># return lambda: next(c)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = inc()</span><br><span class="line"><span class="built_in">print</span>(foo())  <span class="comment"># 打印什么?</span></span><br><span class="line"><span class="built_in">print</span>(foo())  <span class="comment"># 打印什么?</span></span><br><span class="line"><span class="built_in">print</span>(foo())  <span class="comment"># 打印什么?为什么?</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码中的inner函数可以由lambda表达式替代。</p><h4 id="2-2-3-斐波那契数列">2.2.3 斐波那契数列</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>():</span><br><span class="line">    a = <span class="number">0</span></span><br><span class="line">    b = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a, b = b, a + b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = fib()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">102</span>):</span><br><span class="line">    <span class="built_in">print</span>(i, <span class="built_in">next</span>(f))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-2-4-协程Coroutine">2.2.4 协程Coroutine</h4><ul><li>生成器的高级用法</li><li>它比进程、线程轻量级，是在用户空间调度函数的一种实现</li><li>Python3 asyncio就是协程实现，已经加入到标准库</li><li>Python3.5 使用async、await关键字直接原生支持协程</li><li>协程调度器实现思路<br>有2个生成器A、B<br>next(A)后，A执行到了yield语句暂停，然后去执行next(B)，B执行到yield语句也暂停，然后再次调<br>用next(A)，再调用next(B)在，周而复始，就实现了调度的效果<br>可以引入调度的策略来实现切换的方式</li><li>协程是一种非抢占式调度</li></ul><h3 id="2-3-yield-from语法">2.3 yield from语法</h3><p>从Python 3.3开始增加了yield from语法，使得 yield from iterable 等价于 for item in iterable: yield item 。</p><p>yield from就是一种简化语法的语法糖。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用yield from 简化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">range</span>(<span class="number">1000</span>)  <span class="comment"># 注意这个函数出现了yield，也是生成器函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = inc()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(foo))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>本质上yield from的意思就是，从from后面的可迭代对象中拿元素一个个yield出去</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数作用域</title>
      <link href="/20230624/python-20230624-%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F/"/>
      <url>/20230624/python-20230624-%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F/</url>
      
        <content type="html"><![CDATA[<h2 id="1-作用域">1. 作用域</h2><p>一个标识符的可见范围，这就是标识符的作用域。一般常说的是变量的作用域</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    x = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># 可以访问到吗</span></span><br></pre></td></tr></table></figure><p>上例中x不可以访问到，会抛出异常（NameError: name ‘x’ is not defined），原因在于函数是一个封装，它会开辟一个作用域，x变量被限制在这个作用域中，所以在函数外部x变量不可见。</p><p>注意：每一个函数都会开辟一个作用域</p><h2 id="2-作用域分类">2. 作用域分类</h2><ul><li>全局作用域<ul><li>在整个程序运行环境中都可见</li><li>全局作用域中的变量称为全局变量global</li></ul></li><li>局部作用域<ul><li>在函数、类等内部可见</li><li>局部作用域中的变量称为局部变量，其使用范围不能超过其所在局部作用域</li><li>也称为本地作用域local</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 局部变量</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn1</span>():</span><br><span class="line">    x = <span class="number">1</span> <span class="comment"># 局部作用域，x为局部变量，使用范围在fn1内</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn2</span>():</span><br><span class="line">    <span class="built_in">print</span>(x) <span class="comment"># x能打印吗？可见吗？为什么？</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># x能打印吗？可见吗？为什么？</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局变量</span></span><br><span class="line">x = <span class="number">5</span> <span class="comment"># 全局变量，也在函数外定义</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="built_in">print</span>(x) <span class="comment"># 可见吗？为什么？</span></span><br><span class="line"></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure><ul><li>一般来讲外部作用域变量可以在函数内部可见，可以使用</li><li>反过来，函数内部的局部变量，不能在函数外部看到</li></ul><h2 id="3-函数嵌套">3. 函数嵌套</h2><p>在一个函数中定义了另外一个函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">outer</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;inner&quot;</span>)</span><br><span class="line">    inner()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;outer&quot;</span>)</span><br><span class="line">outer() <span class="comment"># 可以吗？</span></span><br><span class="line">inner() <span class="comment"># 可以吗？</span></span><br></pre></td></tr></table></figure><p>内部函数inner不能在外部直接使用，会抛NameError异常，因为它在函数外部不可见。</p><p>其实，inner不过就是一个标识符，就是一个函数outer内部定义的变量而已。</p><p><strong>嵌套结构的作用域</strong></p><p>对比下面嵌套结构，代码执行的效果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">outer1</span>():</span><br><span class="line">    o = <span class="number">65</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;inner&#x27;</span>, o, <span class="built_in">chr</span>(o))</span><br><span class="line">    inner()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;outer&#x27;</span>, o, <span class="built_in">chr</span>(o))</span><br><span class="line">outer1() <span class="comment"># 执行后，打印什么</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">outer2</span>():</span><br><span class="line">    o = <span class="number">65</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        o = <span class="number">97</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;inner&#x27;</span>, o, <span class="built_in">chr</span>(o))</span><br><span class="line">    inner()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;outer&#x27;</span>, o, <span class="built_in">chr</span>(o))</span><br><span class="line">outer2() <span class="comment"># 执行后，打印什么</span></span><br></pre></td></tr></table></figure><p>从执行的结果来看：</p><ul><li>外层变量在内部作用域可见</li><li>内层作用域inner中，如果定义了 o = 97 ，相当于在当前函数inner作用域中重新定义了一个新的变量o，但是，这个o并不能覆盖掉外部作用域outer2中的变量o。只不过对于inner函数来说，其只能可见自己作用域中定义的变量o了</li></ul><table><thead><tr><th>内建函数</th><th>函数签名</th><th>说明</th></tr></thead><tbody><tr><td>chr</td><td>chr(i)</td><td>通过unicode编码返回对应字符</td></tr><tr><td>ord</td><td>ord©</td><td>获得字符对应的unicode</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">ord</span>(<span class="string">&#x27;中&#x27;</span>), <span class="built_in">hex</span>(<span class="built_in">ord</span>(<span class="string">&#x27;中&#x27;</span>)), <span class="string">&#x27;中&#x27;</span>.encode(), <span class="string">&#x27;中&#x27;</span>.encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"><span class="built_in">chr</span>(<span class="number">20013</span>) <span class="comment"># &#x27;中&#x27;</span></span><br><span class="line"><span class="built_in">chr</span>(<span class="number">97</span>)</span><br></pre></td></tr></table></figure><h2 id="4-一个赋值语句的问题">4. 一个赋值语句的问题</h2><p>再看下面左右2个函数</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230625163917.png" alt=""></p><table><thead><tr><th>左边函数</th><th>右边函数</th></tr></thead><tbody><tr><td>正常执行，函数外部的变</br>量在函数内部可见</td><td>执行错误吗，为什么？难道函数内部又不可见了？y = x + 1可以正确</br>执行，可是为什么x += 1却不能正确执行？</td></tr></tbody></table><p>仔细观察函数2返回的错误指向x += 1，原因是什么呢?</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">5</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    x += <span class="number">1</span></span><br><span class="line">foo() <span class="comment"># 报错如下</span></span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230625164238.png" alt=""></p><p>原因分析：</p><ul><li>x += 1 其实是 x = x + 1</li><li>只要有&quot;x=&quot;出现，这就是赋值语句。相当于在foo内部定义一个局部变量x，那么foo内部所有x都是这个局部变量x了</li><li>x = x + 1 相当于使用了局部变量x，但是这个x还没有完成赋值，就被右边拿来做加1操作了</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">5</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(): <span class="comment"># 函数被解释器解释，foo指向函数对象，同时解释器会理解x是什么作用域</span></span><br><span class="line">    <span class="built_in">print</span>(x) <span class="comment"># x 在函数解析时就被解释器判定为局部变量</span></span><br><span class="line">    x += <span class="number">1</span> <span class="comment"># x = x + 1</span></span><br><span class="line">foo() <span class="comment"># 调用时</span></span><br></pre></td></tr></table></figure><p>如何解决这个常见问题</p><h2 id="5-global语句">5. global语句</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">5</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">global</span> x <span class="comment"># 全局变量</span></span><br><span class="line">    x += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure><ul><li>使用global关键字的变量，将foo内的x声明为使用外部的全局作用域中定义的x</li><li>全局作用域中必须有x的定义</li></ul><p>如果全局作用域中没有x定义会怎样？</p><div class="note warning no-icon flat"><p>注意，下面试验如果在ipython、jupyter中做，上下文运行环境中有可能有x的定义，稍微不注意，就测试不出效果</p></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有错吗？</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有错吗？</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x = <span class="number">10</span></span><br><span class="line">    x += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">foo()</span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># 可以吗</span></span><br></pre></td></tr></table></figure><p>使用global关键字定义的变量，虽然在foo函数中声明，但是这将告诉当前foo函数作用域，这个x变量将使用外部全局作用域中的x。</p><p>即使是在foo中又写了 x = 10 ，也不会在foo这个局部作用域中定义局部变量x了。</p><p>使用了global，foo中的x不再是局部变量了，它是全局变量。</p><p><strong>总结</strong></p><ul><li>x+=1 这种是特殊形式产生的错误的原因？先引用后赋值，而python动态语言是赋值才算定义，才能被引用。解决办法，在这条语句前增加x=0之类的赋值语句，或者使用global 告诉内部作用域，去全局作用域查找变量定义</li><li>内部作用域使用 x = 10 之类的赋值语句会重新定义局部作用域使用的变量x，但是，一旦这个作用域中使用 global 声明x为全局的，那么x=5相当于在为全局作用域的变量x赋值</li></ul><p><strong>global使用原则</strong></p><ul><li>外部作用域变量会在内部作用域可见，但也不要在这个内部的局部作用域中直接使用，因为函数的目的就是为了封装，尽量与外界隔离</li><li>如果函数需要使用外部全局变量，请尽量使用函数的形参定义，并在调用传实参解决</li><li>一句话：不用global。学习它就是为了深入理解变量作用域</li></ul><h2 id="6-闭包">6. 闭包***</h2><p>自由变量：未在本地作用域中定义的变量。例如定义在内层函数外的外层函数的作用域中的变量</p><p>闭包：就是一个概念，出现在嵌套函数中，指的是内层函数引用到了外层函数的自由变量，就形成了闭包。很多语言都有这个概念，最熟悉就是JavaScript</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    c = [<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">        c[<span class="number">0</span>] += <span class="number">1</span> <span class="comment"># 报错吗？ 为什么 # line 4</span></span><br><span class="line">        <span class="keyword">return</span> c[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line"></span><br><span class="line">foo = counter() <span class="comment"># line 8</span></span><br><span class="line"><span class="built_in">print</span>(foo(), foo()) <span class="comment"># line 9</span></span><br><span class="line">c = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(foo()) <span class="comment"># line 11</span></span><br></pre></td></tr></table></figure><p>代码分析</p><ul><li>第8行会执行counter函数并返回inc对应的函数对象，注意这个函数对象并不释放，因为有foo记着</li><li>第4行会报错吗？为什么<ul><li>不会报错，c已经在counter函数中定义过了。而且inc中的使用方式是为c的元素修改值，而不是重新定义c变量</li></ul></li><li>第9行打印什么结果？<ul><li>打印 1 2</li></ul></li><li>第11行打印什么结果？<ul><li>打印 3</li><li>第9行的c和counter中的c不一样，而inc引用的是自由变量正是counter中的变量c</li></ul></li></ul><p>这是Python2中实现闭包的方式，Python3还可以使用nonlocal关键字</p><p>再看下面这段代码，会报错吗？使用global能解决吗？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line">foo = counter()</span><br><span class="line"><span class="built_in">print</span>(foo(), foo())</span><br></pre></td></tr></table></figure><p>上例一定出错，使用gobal可以解决</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    <span class="keyword">global</span> count</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">        <span class="keyword">global</span> count</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line"></span><br><span class="line">foo = counter()</span><br><span class="line"><span class="built_in">print</span>(foo(), foo())</span><br><span class="line">count = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(foo()) <span class="comment"># 打印几？</span></span><br></pre></td></tr></table></figure><p>上例使用global解决，这是全局变量的实现，而不是闭包了。</p><p>如果要对这个普通变量使用闭包，Python3中可以使用nonlocal关键字。</p><h2 id="7-nonlocal语句">7. nonlocal语句</h2><p>nonlocal：将变量标记为不在本地作用域定义，而是在上级的某一级局部作用域中定义，但不能是全局作用域中定义。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inc</span>():</span><br><span class="line">        <span class="keyword">nonlocal</span> count  <span class="comment"># 声明变量count不是本地变量</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = counter()</span><br><span class="line"><span class="built_in">print</span>(foo(), foo())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>count 是外层函数的局部变量，被内部函数引用。</p><p>内部函数使用nonlocal关键字声明count变量在上级作用域而非本地作用域中定义。</p><p>代码中内层函数引用外部局部作用域中的自由变量，形成闭包。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230625171032.png" alt=""></p><p>上例是错误的，nonlocal 声明变量 a 不在当前作用域，但是往外就是全局作用域了，所以错误。</p><h2 id="8-函数的销毁">8. 函数的销毁</h2><p>定义一个函数就是生成一个函数对象，函数名指向的就是函数对象。</p><p>可以使用del语句删除函数，使其引用计数减1。</p><p>可以使用同名标识符覆盖原有定义，本质上也是使其引用计数减1。</p><p>Python程序结束时，所有对象销毁。</p><p>函数也是对象，也不例外，是否销毁，还是看引用计数是否减为0。</p><h2 id="9-变量名解析原则LEGB">9. 变量名解析原则LEGB***</h2><ul><li>Local，本地作用域、局部作用域的local命名空间。函数调用时创建，调用结束消亡</li><li>Enclosing，Python2.2时引入了嵌套函数，实现了闭包，这个就是嵌套函数的外部函数的命名空间</li><li>Global，全局作用域，即一个模块的命名空间。模块被import时创建，解释器退出时消亡</li><li>Build-in，内置模块的命名空间，生命周期从python解释器启动时创建到解释器退出时消亡。例如</li><li>print(open)，print和open都是内置的变量</li></ul><p>所以一个名词的查找顺序就是LEGB</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230625171417.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数</title>
      <link href="/20230623/python-20230623-%E5%87%BD%E6%95%B0/"/>
      <url>/20230623/python-20230623-%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-函数">1. 函数</h2><p>数学定义</p><ul><li>y=f(x) ，y是x的函数，x是自变量。y=f(x0, x1, …, xn)</li></ul><p>Python函数</p><ul><li>由若干语句组成的语句块、函数名称、参数列表构成，它是组织代码的最小单元</li><li>完成一定的功能</li></ul><p>函数的作用</p><ul><li>结构化编程对代码的最基本的封装，一般按照功能组织一段代码</li><li>封装的目的为了复用，减少冗余代码</li><li>代码更加简洁美观、可读易懂</li></ul><p>函数的分类</p><ul><li>内建函数，如max()、reversed()等</li><li>库函数，如math.ceil()等</li><li>自定义函数，使用def关键字定义‘</li></ul><h2 id="2-函数定义">2. 函数定义</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">函数名</span>(<span class="params">参数列表</span>):</span><br><span class="line">    函数体（代码块）</span><br><span class="line">    [<span class="keyword">return</span> 返回值]</span><br></pre></td></tr></table></figure><ul><li>函数名就是标识符，命名要求一样</li><li>语句块必须缩进，约定4个空格</li><li>Python的函数若没有return语句，会隐式返回一个None值</li><li>定义中的参数列表称为形式参数，只是一种符号表达（标识符），简称形参</li></ul><h2 id="3-函数调用">3. 函数调用</h2><ul><li>函数定义，只是声明了一个函数，它不能被执行，需要调用执行</li><li>调用的方式，就是函数名后加上小括号，如有必要在括号内填写上参数</li><li>调用时写的参数是实际参数，是实实在在传入的值，简称实参</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>): <span class="comment"># 函数定义</span></span><br><span class="line">    result = x + y <span class="comment"># 函数体</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="comment"># 返回值</span></span><br><span class="line"></span><br><span class="line">out = add(<span class="number">4</span>,<span class="number">5</span>) <span class="comment"># 函数调用，可能有返回值，使用变量接收这个返回值</span></span><br><span class="line"><span class="built_in">print</span>(out) <span class="comment"># print函数加上括号也是调用</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span></span><br></pre></td></tr></table></figure><p>上面代码解释：</p><ul><li>定义一个函数add，及函数名是add，能接受2个形式参数</li><li>该函数计算的结果，通过返回值返回，需要return语句</li><li>调用时，通过函数名add后加2个实际参数，返回值可使用变量接收</li><li>函数名也是标识符</li><li>返回值也是值</li><li>定义需要在调用前，也就是说调用时，已经被定义过了，否则抛NameError异常</li><li>函数是可调用的对象，callable(add)返回True</li></ul><p>看看这个函数是不是通用的？体会一下Python函数的好处</p><h2 id="4-函数参数">4. 函数参数</h2><p>函数在定义是要定义好形式参数，调用时也提供足够的实际参数，一般来说，形参和实参个数要一致（可变参数除外）。</p><h3 id="4-1-实参传参方式">4.1 实参传参方式</h3><p>1、位置传参<br>定义时def f(x, y, z)， 调用使用 f(1, 3, 5)，按照参数定义顺序传入实参</p><p>2、关键字传参<br>定义时def f(x, y, z)，调用使用 f(x=1, y=3, z=5)，使用形参的名字来传入实参的方式，如果使用了形参名字，那么传参顺序就可和定义顺序不同</p><p>要求位置参数必须在关键字参数之前传入，位置参数是按位置对应的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="built_in">print</span>(y)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">4</span>) <span class="comment"># 按顺序对应，反过来x和y值就不同</span></span><br><span class="line">add(x=[<span class="number">4</span>], y=(<span class="number">5</span>,))</span><br><span class="line">add(y=<span class="number">5.1</span>, x=<span class="number">4.2</span>) <span class="comment"># 关键字传参，按名字对应，无所谓顺序</span></span><br><span class="line">add(<span class="number">4</span>, y=<span class="number">5</span>) <span class="comment"># 正确</span></span><br><span class="line">add(y=<span class="number">5</span>, <span class="number">4</span>) <span class="comment"># 错误传参</span></span><br></pre></td></tr></table></figure><p>切记：传参指的是调用时传入实参，就2种方式。<br>下面讲的都是形参定义</p><h3 id="4-2-形参缺省值">4.2 形参缺省值</h3><p>缺省值也称为默认值，可以在函数定义时，为形参增加一个缺省值。其作用：</p><ul><li>参数的默认值可以在未传入足够的实参的时候，对没有给定的参数赋值为默认值</li><li>参数非常多的时候，并不需要用户每次都输入所有的参数，简化函数调用</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x=<span class="number">4</span>, y=<span class="number">5</span></span>):</span><br><span class="line">    <span class="keyword">return</span> x+y</span><br><span class="line"></span><br><span class="line">测试调用 add()、add(x=<span class="number">5</span>)、add(y=<span class="number">7</span>)、add(<span class="number">6</span>, <span class="number">10</span>)、add(<span class="number">6</span>, y=<span class="number">7</span>)、add(x=<span class="number">5</span>, y=<span class="number">6</span>)、</span><br><span class="line">add(y=<span class="number">5</span>, x=<span class="number">6</span>)、add(x=<span class="number">5</span>, <span class="number">6</span>)、add(y=<span class="number">8</span>, <span class="number">4</span>)、add(<span class="number">11</span>, x=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">能否这样定义 <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y=<span class="number">5</span></span>) 或 <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x=<span class="number">4</span>,y</span>) ？</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个函数login，参数名称为host、port、username、password</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">3306</span>, username=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;root&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;mysql://&#123;2&#125;:&#123;3&#125;@&#123;0&#125;:&#123;1&#125;/&#x27;</span>.<span class="built_in">format</span>(host, port, username, password))</span><br><span class="line"></span><br><span class="line">login()</span><br><span class="line">login(<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line">login(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3361</span>, <span class="string">&#x27;wayne&#x27;</span>, <span class="string">&#x27;wayne&#x27;</span>)</span><br><span class="line">login(<span class="string">&#x27;127.0.0.1&#x27;</span>, username=<span class="string">&#x27;wayne&#x27;</span>)</span><br><span class="line">login(username=<span class="string">&#x27;wayne&#x27;</span>, password=<span class="string">&#x27;wayne&#x27;</span>, host=<span class="string">&#x27;www.hehe.com&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="4-3-可变参数">4.3 可变参数</h3><p>需求：写一个函数，可以对多个数累加求和</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum</span>(<span class="params">iterable</span>):</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        s += x</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>([<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(<span class="built_in">range</span>(<span class="number">4</span>)))</span><br></pre></td></tr></table></figure><p>上例，传入可迭代对象，并累加每一个元素。</p><p>也可以使用可变参数完成上面的函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum</span>(<span class="params">*nums</span>):</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">        <span class="built_in">sum</span> += x</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure><p>1、可变位置参数</p><ul><li>在形参前使用 * 表示该形参是可变位置参数，可以接受多个实参</li><li>它将收集来的实参组织到一个tuple中</li></ul><p>2、可变关键字参数</p><ul><li>在形参前使用 ** 表示该形参是可变关键字参数，可以接受多个关键字参数</li><li>它将收集来的实参的名称和值，组织到一个dict中</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">showconfig</span>(<span class="params">**kwargs</span>):</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(k,v), end=<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line"></span><br><span class="line">showconfig(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8080</span>, username=<span class="string">&#x27;wayne&#x27;</span>, password=<span class="string">&#x27;hehe&#x27;</span>)</span><br></pre></td></tr></table></figure><p>混合使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可以定义为下列方式吗？</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showconfig</span>(<span class="params">username, password, **kwargs</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showconfig</span>(<span class="params">username, *args, **kwargs</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showconfig</span>(<span class="params">username, password, **kwargs, *args</span>) <span class="comment"># ?</span></span><br></pre></td></tr></table></figure><p>总结：</p><ul><li>有可变位置参数和可变关键字参数</li><li>可变位置参数在形参前使用一个星号*</li><li>可变关键字参数在形参前使用两个星号**</li><li>可变位置参数和可变关键字参数都可以收集若干个实参，可变位置参数收集形成一个tuple，可变</li><li>关键字参数收集形成一个dict</li><li>混合使用参数的时候，普通参数需要放到参数列表前面，可变参数要放到参数列表的后面，可变位</li><li>置参数需要在可变关键字参数之前</li></ul><p>使用举例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">x, y, *args, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y, args, kwargs, sep=<span class="string">&#x27;\n&#x27;</span>, end=<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>)</span><br><span class="line">fn(x=<span class="number">1</span>, y=<span class="number">2</span>, z=<span class="number">3</span>)</span><br><span class="line">fn(x=<span class="number">3</span>, y=<span class="number">8</span>, <span class="number">7</span>, <span class="number">9</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>) <span class="comment"># ?</span></span><br><span class="line">fn(<span class="number">7</span>, <span class="number">9</span>, y=<span class="number">5</span>, x=<span class="number">3</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>) <span class="comment"># ?</span></span><br></pre></td></tr></table></figure><p>fn(x=3, y=8, 7, 9, a=1, b=‘abc’)，错在位置传参必须在关键字传参之前<br>fn(7, 9, y=5, x=3, a=1, b=‘abc’)，错在7和9已经按照位置传参了，x=3、y=5有重复传参了</p><h3 id="4-4-keyword-only参数">4.4 keyword-only参数</h3><p>先看一段代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">*args, x, y, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y, args, kwargs, sep=<span class="string">&#x27;\n&#x27;</span>, end=<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, y=<span class="number">6</span>, x=<span class="number">7</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;abc&#x27;</span>)</span><br></pre></td></tr></table></figure><p>在Python3之后，新增了keyword-only参数。</p><p>keyword-only参数：在形参定义时，在一个*星号之后，或一个可变位置参数之后，出现的普通参数，<br>就已经不是普通的参数了，称为keyword-only参数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">*args, x</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, args, sep=<span class="string">&#x27;\n&#x27;</span>, end=<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, x=<span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>keyword-only参数，言下之意就是这个参数必须采用关键字传参。</p><p>可以认为，上例中，args可变位置参数已经截获了所有位置参数，其后的变量x不可能通过位置传参传入了。</p><p>思考：def fn(**kwargs, x) 可以吗？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">**kwargs, x</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, kwargs, sep=<span class="string">&#x27;\n&#x27;</span>, end=<span class="string">&#x27;\n\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>直接语法错误了。</p><p>可以认为，kwargs会截获所有关键字传参，就算写了x=5，x也没有机会得到这个值，所以这种语法不存在。</p><p>keyword-only参数另一种形式</p><ul><li>星号后所有的普通参数都成了keyword-only参数。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">*, x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y)</span><br><span class="line"></span><br><span class="line">fn(x=<span class="number">6</span>, y=<span class="number">7</span>)</span><br><span class="line">fn(y=<span class="number">8</span>, x=<span class="number">9</span>)</span><br></pre></td></tr></table></figure><h3 id="4-5-Positional-only参数">4.5 Positional-only参数</h3><p>Python 3.8 开始，增加了最后一种形参类型的定义：Positional-only参数。（2019年10月发布3.8.0）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">a, /</span>):</span><br><span class="line">    <span class="built_in">print</span>(a, sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fn(<span class="number">3</span>)</span><br><span class="line">fn(a=<span class="number">4</span>) <span class="comment"># 错误，仅位置参数，不可以使用关键字传参</span></span><br></pre></td></tr></table></figure><h3 id="4-6-参数的混合使用">4.6 参数的混合使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可变位置参数、keyword-only参数、缺省值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">*args, x=<span class="number">5</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line"></span><br><span class="line">fn() <span class="comment"># 等价于fn(x=5)</span></span><br><span class="line">fn(<span class="number">5</span>)</span><br><span class="line">fn(x=<span class="number">6</span>)</span><br><span class="line">fn(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,x=<span class="number">10</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通参数、可变位置参数、keyword-only参数、缺省值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">y, *args, x=<span class="number">5</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;x=&#123;&#125;, y=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x, y))</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">fn() <span class="comment">#</span></span><br><span class="line">fn(<span class="number">5</span>)</span><br><span class="line">fn(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">fn(x=<span class="number">6</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, x=<span class="number">10</span>)</span><br><span class="line">fn(y=<span class="number">17</span>, <span class="number">2</span>, <span class="number">3</span>, x=<span class="number">10</span>) <span class="comment">#</span></span><br><span class="line">fn(<span class="number">1</span>, <span class="number">2</span>, y=<span class="number">3</span>, x=<span class="number">10</span>) <span class="comment">#</span></span><br><span class="line">fn(y=<span class="number">20</span>, x=<span class="number">30</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 普通参数、缺省值、可变关键字参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">x=<span class="number">5</span>, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;x=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">fn()</span><br><span class="line">fn(<span class="number">5</span>)</span><br><span class="line">fn(x=<span class="number">6</span>)</span><br><span class="line">fn(y=<span class="number">3</span>, x=<span class="number">10</span>)</span><br><span class="line">fn(<span class="number">3</span>, y=<span class="number">10</span>)</span><br><span class="line">fn(y=<span class="number">3</span>, z=<span class="number">20</span>)</span><br></pre></td></tr></table></figure><h3 id="4-7-参数规则">4.7 参数规则</h3><p>参数列表参数一般顺序是：positional-only参数、普通参数、缺省参数、可变位置参数、keyword-only参数（可带缺省值）、可变关键字参数。</p><p>注意：<br>代码应该易读易懂，而不是为难别人<br>请按照书写习惯定义函数参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">a, b, /, x, y, z=<span class="number">3</span>, *args, m=<span class="number">4</span>, n, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(a, b)</span><br><span class="line">    <span class="built_in">print</span>(x, y, z)</span><br><span class="line">    <span class="built_in">print</span>(m, n)</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;admin&#x27;</span>, password=<span class="string">&#x27;admin&#x27;</span>, port=<span class="string">&#x27;3306&#x27;</span>,**kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;mysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">    user, password, host, port, kwargs.get(<span class="string">&#x27;db&#x27;</span>, <span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">connect(db=<span class="string">&#x27;cmdb&#x27;</span>) <span class="comment"># 参数的缺省值把最常用的缺省值都写好了</span></span><br><span class="line">connect(host=<span class="string">&#x27;192.168.1.123&#x27;</span>, db=<span class="string">&#x27;cmdb&#x27;</span>)</span><br><span class="line">connect(host=<span class="string">&#x27;192.168.1.123&#x27;</span>, db=<span class="string">&#x27;cmdb&#x27;</span>, password=<span class="string">&#x27;mysql&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>定义最常用参数为普通参数，可不提供缺省值，必须由用户提供。注意这些参数的顺序，最常用的先定义</li><li>将必须使用名称的才能使用的参数，定义为keyword-only参数，要求必须使用关键字传参</li><li>如果函数有很多参数，无法逐一定义，可使用可变参数。如果需要知道这些参数的意义，则使用可变关键字参数收集</li></ul><h2 id="5-参数解构">5. 参数解构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">add((<span class="number">4</span>, <span class="number">5</span>)) <span class="comment"># 可以吗？</span></span><br><span class="line">t = <span class="number">4</span>, <span class="number">5</span></span><br><span class="line">add(t[<span class="number">0</span>], t[<span class="number">1</span>])</span><br><span class="line">add(*t)</span><br><span class="line">add(*(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">add(*[<span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">add(*&#123;<span class="number">4</span>, <span class="number">5</span>&#125;) <span class="comment"># 注意有顺序吗？</span></span><br><span class="line">add(*<span class="built_in">range</span>(<span class="number">4</span>, <span class="number">6</span>))</span><br><span class="line">add(*&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">10</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">11</span>&#125;) <span class="comment"># 可以吗？</span></span><br><span class="line">add(**&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">10</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">11</span>&#125;) <span class="comment"># 可以吗？</span></span><br><span class="line">add(**&#123;<span class="string">&#x27;x&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;y&#x27;</span>:<span class="number">110</span>&#125;) <span class="comment"># 可以吗？</span></span><br></pre></td></tr></table></figure><p>参数解构：</p><ul><li>在给函数提供实参的时候，可以在可迭代对象前使用 * 或者 ** 来进行结构的解构，提取出其中所有元素作为函数的实参</li><li>使用 * 解构成位置传参</li><li>使用 ** 解构成关键字传参</li><li>提取出来的元素数目要和参数的要求匹配</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">*nums</span>):</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">        result += x</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">add(*[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>])</span><br><span class="line">add(*<span class="built_in">range</span>(<span class="number">5</span>))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.8以后，下面就不可以使用字典解构后的关键字传参了</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y, /</span>): <span class="comment"># 仅位置形参</span></span><br><span class="line">    <span class="built_in">print</span>(x, y)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">add(**&#123;<span class="string">&#x27;x&#x27;</span>:<span class="number">10</span>, <span class="string">&#x27;y&#x27;</span>:<span class="number">11</span>&#125;)</span><br></pre></td></tr></table></figure><h2 id="6-函数返回值">6. 函数返回值</h2><p>先看几个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># return语句之后可以执行吗？</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showplus</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;~~end~~&#x27;</span>) <span class="comment"># return之后会执行吗？</span></span><br><span class="line"></span><br><span class="line">showplus(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 多条return语句都会执行吗</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showplus</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">showplus(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 下例多个return可以执行吗？</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guess</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> x &gt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&gt; 3&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;= 3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(guess(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面函数执行的结果是什么</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x):</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is not greater than 3&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(fn(<span class="number">5</span>)) <span class="comment"># 打印什么？</span></span><br><span class="line"><span class="built_in">print</span>(fn(<span class="number">3</span>)) <span class="comment"># 打印什么？</span></span><br></pre></td></tr></table></figure><p>总结</p><ul><li>Python函数使用return语句返回“返回值”</li><li>所有函数都有返回值，如果没有return语句，隐式调用return None</li><li>return 语句并不一定是函数的语句块的最后一条语句</li><li>一个函数可以存在多个return语句，但是只有一条可以被执行。如果没有一条return语句被执行到，隐式调用return None</li><li>如果有必要，可以显示调用return None，可以简写为return</li><li>如果函数执行了return语句，函数就会返回，当前被执行的return语句之后的其它语句就不会被执行了</li><li>返回值的作用：结束函数调用、返回“返回值”</li></ul><p>能够一次返回多个值吗？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">showvalues</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span></span><br><span class="line"></span><br><span class="line">showvalues() <span class="comment"># 返回了多个值吗？</span></span><br></pre></td></tr></table></figure><ul><li>函数不能同时返回多个值</li><li>return 1, 3, 5 看似返回多个值，隐式的被python封装成了一个元组</li><li>x, y, z = showlist() 使用解构提取返回值更为方便</li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解析式和生成器表达式</title>
      <link href="/20230622/python-20230622-%E8%A7%A3%E6%9E%90%E5%BC%8F%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/20230622/python-20230622-%E8%A7%A3%E6%9E%90%E5%BC%8F%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="1-列表解析式">1.列表解析式</h2><p>列表解析式List Comprehension，也叫列表推导式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个列表，元素0~9，将每一个元素加1后的平方值组成新的列表</span></span><br><span class="line">x = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    x.append((i+<span class="number">1</span>)**<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列表解析式</span></span><br><span class="line"><span class="built_in">print</span>([(i+<span class="number">1</span>)**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])</span><br></pre></td></tr></table></figure><p>语法</p><ul><li>[返回值 for 元素 in 可迭代对象 if 条件]</li><li>使用中括号[]，内部是for循环，if条件语句可选</li><li>返回一个新的列表</li></ul><p>列表解析式是一种语法糖</p><ul><li>编译器会优化，不会因为简写而影响效率，反而因优化提高了效率</li><li>减少程序员工作量，减少出错</li><li>简化了代码，增强了可读性</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[expr <span class="keyword">for</span> item <span class="keyword">in</span> iterable <span class="keyword">if</span> cond1 <span class="keyword">if</span> cond2]</span><br><span class="line">等价于</span><br><span class="line">ret = []</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> iterable:</span><br><span class="line">    <span class="keyword">if</span> cond1:</span><br><span class="line">        <span class="keyword">if</span> cond2:</span><br><span class="line">            ret.append(expr)</span><br><span class="line"><span class="comment"># [</span></span><br><span class="line">expr <span class="keyword">for</span> i <span class="keyword">in</span> iterable1 <span class="keyword">for</span> j <span class="keyword">in</span> iterable2 ]</span><br><span class="line">等价于</span><br><span class="line">ret = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> iterable1:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> iterable2:</span><br><span class="line">        ret.append(expr)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请问下面3种输出各是什么？为什么</span></span><br><span class="line">[(i,j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> j&gt;<span class="number">23</span>]</span><br><span class="line">[(i,j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">if</span> j&gt;<span class="number">23</span>]</span><br><span class="line">[(i,j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">and</span> j&gt;<span class="number">23</span>]</span><br></pre></td></tr></table></figure><h2 id="2-集合解析式">2. 集合解析式</h2><p>语法</p><ul><li>{返回值 for 元素 in 可迭代对象 if 条件}</li><li>列表解析式的中括号换成大括号{}就变成了集合解析式</li><li>立即返回一个集合</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;(x, x+<span class="number">1</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;[x] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125; <span class="comment"># 可以吗？</span></span><br></pre></td></tr></table></figure><h2 id="3-字典解析式">3. 字典解析式</h2><p>语法</p><ul><li>{key:value for 元素 in 可迭代对象 if 条件}</li><li>列表解析式的中括号换成大括号{}，元素的构造使用key:value形式</li><li>立即返回一个字典</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;x:(x,x+<span class="number">1</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;x:[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;(x,):[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;[x]:[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125; <span class="comment">#</span></span><br><span class="line">&#123;<span class="built_in">str</span>(x):y <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)&#125; <span class="comment"># 输出多少个元素？</span></span><br></pre></td></tr></table></figure><h2 id="4-生成器表达式">4. 生成器表达式</h2><p>语法</p><ul><li>(返回值 for 元素 in 可迭代对象 if 条件)</li><li>列表解析式的中括号换成小括号就行了</li><li>返回一个生成器对象</li></ul><p>和列表解析式的区别</p><ul><li>生成器表达式是按需计算（或称惰性求值、延迟计算），需要的时候才计算值</li><li>列表解析式是立即返回值</li></ul><p>生成器对象</p><ul><li>可迭代对象</li><li>迭代器</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622022856.png" alt=""></p><table><thead><tr><th>生成器表达式</th><th>列表解析式</th></tr></thead><tbody><tr><td>延迟计算</br> 返回可迭代对象迭代器，可以迭代</br> 只能迭代一次</td><td>立即计算</br> 返回可迭代对象列表，不是迭代器</br> 可反复迭代</td></tr></tbody></table><h2 id="5-生成器表达式和列表解析式对比">5. 生成器表达式和列表解析式对比</h2><ul><li>计算方式<ul><li>生成器表达式延迟计算，列表解析式立即计算</li></ul></li><li>内存占用<ul><li>单从返回值本身来说，生成器表达式省内存，列表解析式返回新的列表</li><li>生成器没有数据，内存占用极少，使用的时候，一次返回一个数据，只会占用一个数据的空间</li><li>列表解析式构造新的列表需要为所有元素立即占用掉内存</li></ul></li><li>计算速度<ul><li>单看计算时间看，生成器表达式耗时非常短，列表解析式耗时长</li><li>但生成器本身并没有返回任何值，只返回了一个生成器对象</li><li>列表解析式构造并返回了一个新的列表</li></ul></li></ul><h2 id="6-总结">6. 总结</h2><ul><li>Python2 引入列表解析式</li><li>Python2.4 引入生成器表达式</li><li>Python3 引入集合、字典解析式，并迁移到了2.7</li></ul><p>一般来说，应该多应用解析式，简短、高效。如果一个解析式非常复杂，难以读懂，要考虑拆解成for循环。</p><p>生成器和迭代器是不同的对象，但都是可迭代对象。</p><p>如果不需要立即获得所有可迭代对象的元素，在Python 3中，推荐使用惰性求值的迭代器</p><table><thead><tr><th>内建函数</th><th>函数签名</th><th>说明</th></tr></thead><tbody><tr><td>sorted</td><td>sorted(iterable[, key][, reverse])</td><td>默认升序，对可迭代对象排序 </br>立即返回列表</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 排序一定是容器内全体参与</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(<span class="built_in">range</span>(<span class="number">10</span>, <span class="number">20</span>), reverse=<span class="literal">True</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;abc&#x27;</span>&#125;))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;abc&#x27;</span>&#125;.items()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;ABC&#x27;</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;abc&#x27;</span>&#125;.values(), key=<span class="built_in">str</span>, reverse=<span class="literal">True</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">2000</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;201&#x27;</span>&#125;.values(), key=<span class="built_in">str</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">2000</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;201&#x27;</span>&#125;.values(), key=<span class="built_in">int</span>))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>哈希表</title>
      <link href="/20230622/python-20230622-%E5%93%88%E5%B8%8C%E8%A1%A8/"/>
      <url>/20230622/python-20230622-%E5%93%88%E5%B8%8C%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-集合Set">1. 集合Set</h2><p>集合，简称集。由任意个元素构成的集体。高级语言都实现了这个非常重要的数据结构类型。</p><p>Python中，它是可变的、无序的、不重复的元素的集合。</p><h3 id="1-1-初始化">1.1 初始化</h3><ul><li>set() -&gt; new empty set object</li><li>set(iterable) -&gt; new set object</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s1 = <span class="built_in">set</span>()</span><br><span class="line">s2 = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">s3 = <span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">s4 = <span class="built_in">set</span>(<span class="string">&#x27;abcdabcd&#x27;</span>)</span><br><span class="line">s5 = &#123;&#125; <span class="comment"># 这是什么？</span></span><br><span class="line">s6 = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">s7 = &#123;<span class="number">1</span>, (<span class="number">1</span>,)&#125;</span><br><span class="line">s8 = &#123;<span class="number">1</span>, (<span class="number">1</span>,), [<span class="number">1</span>]&#125; <span class="comment"># ？</span></span><br></pre></td></tr></table></figure><h3 id="1-2-元素性质">1.2 元素性质</h3><ul><li>去重：在集合中，所有元素必须相异</li><li>无序：因为无序，所以不可索引</li><li>可哈希：Python集合中的元素必须可以hash，即元素都可以使用内建函数hash<ul><li>目前学过不可hash的类型有：list、set、bytearray</li></ul></li><li>可迭代：set中虽然元素不一样，但元素都可以迭代出来</li></ul><h3 id="1-3-增加">1.3 增加</h3><ul><li>add(elem)<ul><li>增加一个元素到set中</li><li>如果元素存在，什么都不做</li></ul></li><li>update(*others)<ul><li>合并其他元素到set集合中来</li><li>参数others必须是可迭代对象</li><li>就地修改</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">set</span>()</span><br><span class="line">s.add(<span class="number">1</span>)</span><br><span class="line">s.update((<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), [<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br></pre></td></tr></table></figure><h3 id="1-4-删除">1.4 删除</h3><ul><li>remove(elem)<ul><li>从set中移除一个元素</li><li>元素不存在，抛出KeyError异常。为什么是KeyError？</li></ul></li><li>discard(elem)<ul><li>从set中移除一个元素</li><li>元素不存在，什么都不做</li></ul></li><li>pop() -&gt; item<ul><li>移除并返回任意的元素。为什么是任意元素？</li><li>空集返回KeyError异常</li></ul></li><li>clear()<ul><li>移除所有元素</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">s.remove(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#s.remove(11) # KeyError为什么</span></span><br><span class="line">s.discard(<span class="number">11</span>)</span><br><span class="line">s.pop()</span><br><span class="line">s.clear()</span><br></pre></td></tr></table></figure><h3 id="1-5-修改">1.5 修改</h3><p>集合类型没有修改。因为元素唯一。如果元素能够加入到集合中，说明它和别的元素不一样。<br>所谓修改，其实就是把当前元素改成一个完全不同的元素，就是删除加入新元素</p><h3 id="1-6-索引">1.6 索引</h3><p>非线性结构，不可索引。</p><h3 id="1-7-成员运算符in">1.7 成员运算符in</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">10</span> <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="number">10</span> <span class="keyword">in</span> &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure><p>上面2句代码，分别在列表和集合中搜索元素。如果列表和集合的元素都有100万个，谁的效率高？</p><h3 id="1-8-set和线性结构比较">1.8 set和线性结构比较</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622005801.png" alt=""></p><p>结果说明，集合性能很好。为什么？</p><ul><li>线性数据结构，搜索元素的时间复杂度是O(n)，即随着数据规模增加耗时增大</li><li>set、dict使用hash表实现，内部使用hash值作为key，时间复杂度为O(1)，查询时间和数据规模无关，不会随着数据规模增大而搜索性能下降。</li></ul><h3 id="1-9-遍历">1.9 遍历</h3><p>只要是容器，都可以遍历元素。但是效率都是O(n)</p><h3 id="1-10-可哈希">1.10 可哈希</h3><ul><li>数值型int、float、complex</li><li>布尔型True、False</li><li>字符串string、bytes</li><li>tuple</li><li>None</li><li>以上都是不可变类型，称为可哈希类型，hashable</li></ul><p>set元素必须是可hash的。</p><h3 id="1-11-集合概念">1.11 集合概念</h3><ul><li>全集<ul><li>所有元素的集合。例如实数集，所有实数组成的集合就是全集</li></ul></li><li>子集subset和超集superset<ul><li>一个集合A所有元素都在另一个集合B内，A是B的子集，B是A的超集</li></ul></li><li>真子集和真超集<ul><li>A是B的子集，且A不等于B，A就是B的真子集，B是A的真超集</li></ul></li><li>并集：多个集合合并的结果</li><li>交集：多个集合的公共部分</li><li>差集：集合中除去和其他集合公共部分</li></ul><h4 id="1-11-1-并集">1.11.1 并集</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622010308.png" alt=""></p><p>将两个集合A和B的所有的元素合并到一起，组成的集合称作集合A与集合B的并集</p><ul><li>union(*others) 返回和多个集合合并后的新的集合</li><li>| 运算符重载，等同union</li><li>update(*others) 和多个集合合并，就地修改</li><li>|= 等同update</li></ul><h4 id="1-11-2-交集">1.11.2 交集</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622010430.png" alt=""></p><p>集合A和B，由所有属于A且属于B的元素组成的集合</p><ul><li>intersection(*others) 返回和多个集合的交集</li><li>&amp; 等同intersection</li><li>intersection_update(*others) 获取和多个集合的交集，并就地修改</li><li>&amp;= 等同intersection_update</li></ul><h4 id="1-11-3-差集">1.11.3 差集</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622010604.png" alt=""></p><p>集合A和B，由所有属于A且不属于B的元素组成的集合</p><ul><li>difference(*others) 返回和多个集合的差集</li><li><ul><li>等同difference</li></ul></li><li>difference_update(*others) 获取和多个集合的差集并就地修改</li><li>-= 等同difference_update</li></ul><h4 id="1-11-4-对称差集">1.11.4 对称差集</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230622010726.png" alt=""></p><p>集合A和B，由所有不属于A和B的交集元素组成的集合，记作（A-B）∪（B-A）</p><ul><li>symmetric_differece(other) 返回和另一个集合的对称差集</li><li>^ 等同symmetric_differece</li><li>symmetric_differece_update(other) 获取和另一个集合的对称差集并就地修改</li><li>^= 等同symmetric_differece_update</li></ul><h4 id="1-11-5-其它集合运算">1.11.5 其它集合运算</h4><ul><li>issubset(other)、&lt;= 判断当前集合是否是另一个集合的子集</li><li>set1 &lt; set2 判断set1是否是set2的真子集</li><li>issuperset(other)、&gt;= 判断当前集合是否是other的超集</li><li>set1 &gt; set2 判断set1是否是set2的真超集</li><li>isdisjoint(other) 当前集合和另一个集合没有交集，没有交集，返回True</li></ul><h4 id="1-11-6-练习：">1.11.6 练习：</h4><p>一个总任务列表，存储所有任务。一个已完成的任务列表。找出为未完成的任务</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">业务中，任务ID一般不可以重复</span><br><span class="line">所有任务ID放到一个<span class="built_in">set</span>中，假设为ALL</span><br><span class="line">所有已完成的任务ID放到一个<span class="built_in">set</span>中，假设为COMPLETED，它是ALL的子集</span><br><span class="line">ALL - COMPLETED =&gt; UNCOMPLETED</span><br></pre></td></tr></table></figure><p>集合运算，用好了妙用无穷。</p><h2 id="2-字典Dict">2. 字典Dict</h2><p>Dict即Dictionary，也称为mapping。<br>Python中，字典由任意个元素构成的集合，每一个元素称为Item，也称为Entry。这个Item是由(key,value)组成的二元组。<br>字典是可变的、无序的、key不重复的key-value pairs键值对集合。</p><h3 id="2-1-初始化">2.1 初始化</h3><ul><li>dict(**kwargs) 使用name=value对初始化一个字典</li><li>dict(iterable, <strong>kwarg) 使用可迭代对象和name=value对构造字典，不过可迭代对象的元素必须是一个二元结构</strong></li><li>dict(mapping, **kwarg) 使用一个字典构建另一个字典</li></ul><p>字典的初始化方法都非常常用，都需要会用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d1 = &#123;&#125;</span><br><span class="line">d2 = <span class="built_in">dict</span>()</span><br><span class="line">d3 = <span class="built_in">dict</span>(a=<span class="number">100</span>, b=<span class="number">200</span>)</span><br><span class="line">d4 = <span class="built_in">dict</span>(d3) <span class="comment"># 构造另外一个字典</span></span><br><span class="line">d5 = <span class="built_in">dict</span>(d4, a=<span class="number">300</span>, c=<span class="number">400</span>)</span><br><span class="line">d6 = <span class="built_in">dict</span>([(<span class="string">&#x27;a&#x27;</span>, <span class="number">100</span>), [<span class="string">&#x27;b&#x27;</span>, <span class="number">200</span>], (<span class="number">1</span>, <span class="string">&#x27;abc&#x27;</span>)], b=<span class="number">300</span>, c=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类方法dict.fromkeys(iterable, value)</span></span><br><span class="line">d = <span class="built_in">dict</span>.fromkeys(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">d = <span class="built_in">dict</span>.fromkeys(<span class="built_in">range</span>(<span class="number">5</span>), <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-元素访问">2.2 元素访问</h3><ul><li>d[key]<ul><li>返回key对应的值value</li><li>key不存在抛出KeyError异常</li></ul></li><li>get(key[, default])<ul><li>返回key对应的值value</li><li>key不存在返回缺省值，如果没有设置缺省值就返回None</li></ul></li><li>setdefault(key[, default])<ul><li>返回key对应的值value</li><li>key不存在，添加kv对，value设置为default，并返回default，如果default没有设置，缺省为None</li></ul></li></ul><h3 id="2-3-新增和修改">2.3 新增和修改</h3><ul><li>d[key] = value<ul><li>将key对应的值修改为value</li><li>key不存在添加新的kv对</li></ul></li><li>update([other]) -&gt; None<ul><li>使用另一个字典的kv对更新本字典</li><li>key不存在，就添加</li><li>key存在，覆盖已经存在的key对应的值就地修改</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;&#125;</span><br><span class="line">d[<span class="string">&#x27;a&#x27;</span>] = <span class="number">1</span></span><br><span class="line">d.update(red=<span class="number">1</span>)</span><br><span class="line">d.update([<span class="string">&#x27;red&#x27;</span>, <span class="number">2</span>])</span><br><span class="line">d.update(&#123;<span class="string">&#x27;red&#x27;</span>:<span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="2-4-删除">2.4 删除</h3><ul><li>pop(key[, default])<ul><li>key存在，移除它，并返回它的value</li><li>key不存在，返回给定的default</li><li>default未设置，key不存在则抛出KeyError异常</li></ul></li><li>popitem()<ul><li>移除并返回一个任意的键值对</li><li>字典为empty，抛出KeyError异常</li></ul></li><li>clear()<ul><li>清空字典</li></ul></li></ul><h3 id="2-5-遍历">2.5 遍历</h3><p>1、遍历Key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> d:</span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> d.keys():</span><br><span class="line">    <span class="built_in">print</span>(k)</span><br></pre></td></tr></table></figure><p>2、遍历Value</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> d.values():</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> d.keys():</span><br><span class="line">    <span class="built_in">print</span>(d[k])</span><br><span class="line">    <span class="built_in">print</span>(d.get(k))</span><br></pre></td></tr></table></figure><p>3、遍历Item</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item[<span class="number">0</span>], item[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">for</span> k,_ <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line"><span class="keyword">for</span> _,v <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br></pre></td></tr></table></figure><p>Python3中，keys、values、items方法返回一个类似一个生成器的可迭代对象</p><ul><li>Dictionary view对象，可以使用len()、iter()、in操作</li><li>字典的entry的动态的视图，字典变化，视图将反映出这些变化</li><li>keys()返回一个类set对象，也就是可以看做一个set集合。如果values()都可以hash，那么items()也可以看做是类set对象</li></ul><p>Python2中，上面的方法会返回一个新的列表，立即占据新的内存空间。所以Python2建议使用iterkeys、itervalues、iteritems版本，返回一个迭代器，而不是返回一个copy</p><h3 id="2-6-遍历与删除">2.6 遍历与删除</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误的做法</span></span><br><span class="line">d = <span class="built_in">dict</span>(a=<span class="number">1</span>, b=<span class="number">2</span>, c=<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="built_in">print</span>(d.pop(k))</span><br><span class="line"></span><br><span class="line">抛出RuntimeError: dictionary changed size during iteration</span><br></pre></td></tr></table></figure><p>在使用keys、values、items方法遍历的时候，不可以改变字典的size</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(d):</span><br><span class="line">    <span class="built_in">print</span>(d.popitem())</span><br><span class="line"><span class="keyword">while</span> d:</span><br><span class="line">    <span class="built_in">print</span>(d.popitem())</span><br></pre></td></tr></table></figure><p>上面的while循环虽然可以移除字典元素，但是很少使用，不如直接clear。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for 循环正确删除</span></span><br><span class="line">d = <span class="built_in">dict</span>(a=<span class="number">1</span>, b=<span class="number">2</span>, c=<span class="number">3</span>)</span><br><span class="line">keys = []</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> d.items():</span><br><span class="line">    keys.append(k)</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> keys:</span><br><span class="line">    d.pop(k)</span><br></pre></td></tr></table></figure><p>集合set在遍历中，也不能改变其长度。</p><h3 id="2-7-key">2.7 key</h3><p>字典的key和set的元素要求一致</p><ul><li>set的元素可以就是看做key，set可以看做dict的简化版</li><li>hashable 可哈希才可以作为key，可以使用hash()测试</li><li>使用key访问，就如同列表使用index访问一样，时间复杂度都是O(1)，这也是最好的访问元素的方式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">2.0</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;abc&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    (<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;python&#x27;</span>): <span class="string">&quot;string&quot;</span>,</span><br><span class="line">    <span class="string">b&#x27;abc&#x27;</span>: <span class="string">&#x27;135&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-8-有序性">2.8 有序性</h3><p>字典元素是按照key的hash值无序存储的。</p><p>但是，有时候我们却需要一个有序的元素顺序，Python 3.6之前，使用OrderedDict类可以做到，3.6开始dict自身支持。到底Python对一个无序数据结构记录了什么顺序？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.5如下</span></span><br><span class="line">C:\Python\Python353&gt;python</span><br><span class="line">Python <span class="number">3.5</span><span class="number">.3</span> (v3<span class="number">.5</span><span class="number">.3</span>:1880cb95a742, Jan <span class="number">16</span> <span class="number">2017</span>, <span class="number">16</span>:02:<span class="number">32</span>) [MSC v<span class="number">.1900</span> <span class="number">64</span> bit</span><br><span class="line">(AMD64)] on win32</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">200</span>, <span class="string">&#x27;c&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;d&#x27;</span>:<span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(d.keys())</span><br><span class="line">[<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>exit()</span><br><span class="line">C:\Python\Python353&gt;python</span><br><span class="line">Python <span class="number">3.5</span><span class="number">.3</span> (v3<span class="number">.5</span><span class="number">.3</span>:1880cb95a742, Jan <span class="number">16</span> <span class="number">2017</span>, <span class="number">16</span>:02:<span class="number">32</span>) [MSC v<span class="number">.1900</span> <span class="number">64</span> bit</span><br><span class="line">(AMD64)] on win32</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">200</span>, <span class="string">&#x27;c&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;d&#x27;</span>:<span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>&#125;</span><br></pre></td></tr></table></figure><p>Python 3.6之前，在不同的机器上，甚至同一个程序分别运行2次，都不能确定不同的key的先后顺序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.6+表现如下</span></span><br><span class="line">C:\Python\python366&gt;python</span><br><span class="line">Python <span class="number">3.6</span><span class="number">.6</span> (v3<span class="number">.6</span><span class="number">.6</span>:4cf1f54eb7, Jun <span class="number">27</span> <span class="number">2018</span>, 03:<span class="number">37</span>:03) [MSC v<span class="number">.1900</span> <span class="number">64</span> bit</span><br><span class="line">(AMD64)] on win32</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>exit()</span><br><span class="line">C:\Python\python366&gt;python</span><br><span class="line">Python <span class="number">3.6</span><span class="number">.6</span> (v3<span class="number">.6</span><span class="number">.6</span>:4cf1f54eb7, Jun <span class="number">27</span> <span class="number">2018</span>, 03:<span class="number">37</span>:03) [MSC v<span class="number">.1900</span> <span class="number">64</span> bit</span><br><span class="line">(AMD64)] on win32</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">300</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">200</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">50</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.keys()</span><br><span class="line">dict_keys([<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;d&#x27;</span>])</span><br></pre></td></tr></table></figure><p>Python 3.6+，记录了字典key的录入顺序，遍历的时候，就是按照这个顺序。</p><p>如果使用 d = {‘a’:300, ‘b’:200, ‘c’:100, ‘d’:50} ，就会造成以为字典按照key排序的错觉。</p><p>目前，建议不要3.6+提供的这种字典特性，还是认为字典返回的是无序的，可以在Python不同版本中考虑使用OrderedDict类来保证这种录入序</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>封装和解构</title>
      <link href="/20230621/python-20230621-%E5%B0%81%E8%A3%85%E5%92%8C%E7%BB%93%E6%9E%84/"/>
      <url>/20230621/python-20230621-%E5%B0%81%E8%A3%85%E5%92%8C%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="1-基本概念">1. 基本概念</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t1 = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(t1)) <span class="comment"># 什么类型</span></span><br><span class="line">t2 = (<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(t2))</span><br></pre></td></tr></table></figure><p>Python等式右侧出现逗号分隔的多值的时候，就会将这几个值封装到元组中。这种操作称为封装packing</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x, y = (<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(y) <span class="comment"># 2</span></span><br></pre></td></tr></table></figure><p>Python中等式右侧是一个容器类型，左侧是逗号分隔的多个标识符，将右侧容器中数据的一个个和左侧标识符一一对应。这种操作称为解构unpacking。</p><p>从Python3开始，对解构做了很大的改进，现在用起来已经非常的方便快捷。</p><p>封装和解构是非常方便的提取数据的方法，在Python、JavaScript等语言中应用极广</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 交换数据</span></span><br><span class="line">x = <span class="number">4</span></span><br><span class="line">y = <span class="number">5</span></span><br><span class="line">t = x</span><br><span class="line">x = y</span><br><span class="line">y = t</span><br><span class="line"><span class="comment"># 封装和解构，交换</span></span><br><span class="line">x = <span class="number">10</span></span><br><span class="line">y = <span class="number">11</span></span><br><span class="line">x, y = y, x</span><br></pre></td></tr></table></figure><h2 id="2-简单解构">2. 简单解构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 左右个数相同</span></span><br><span class="line">a,b = <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">a,b = (<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">a,b = [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">a,b = [<span class="number">10</span>,<span class="number">20</span>]</span><br><span class="line">a,b = &#123;<span class="number">10</span>,<span class="number">20</span>&#125; <span class="comment"># 非线性结构</span></span><br><span class="line">a,b = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">10</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">20</span>&#125; <span class="comment"># 非线性结构也可以解构</span></span><br><span class="line">[a,b] = (<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">[a,b] = <span class="number">10</span>,<span class="number">20</span></span><br><span class="line">(a,b) = &#123;<span class="number">30</span>,<span class="number">40</span>&#125;</span><br></pre></td></tr></table></figure><p>那么，左右个数不一致可以吗？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = (<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>)</span><br></pre></td></tr></table></figure><h2 id="3-剩余变量解构">3. 剩余变量解构</h2><p>在Python3.0中增加了剩余变量解构（rest）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a, *rest, b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(a, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(rest), rest) <span class="comment"># &lt;class &#x27;list&#x27;&gt; [2, 3, 4]</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><p>标识符rest将尽可能收集剩余的数据组成一个列表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a, *rest = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(a, rest)</span><br><span class="line">*rest, b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(rest, b)</span><br><span class="line">*rest = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(rest) <span class="comment"># 内容是什么？</span></span><br><span class="line">a, *r1, *r2, b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="comment"># ？</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a, *_, b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(_) <span class="comment"># 在IPython中实验，_是最后一个输出值，这里将把它覆盖</span></span><br><span class="line">_, *b, _ = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(_) <span class="comment"># 第一个_是什么</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment"># 是什么</span></span><br><span class="line"><span class="built_in">print</span>(_) <span class="comment"># 第二个_是什么</span></span><br></pre></td></tr></table></figure><p>_是合法的标识符，这里它没有什么可读性，它在这里的作用就是表示不关心这个变量的值，我不想要。有人把它称作 丢弃(Throwaway)变量</p><h2 id="4-其它结构">4. 其它结构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">y = [*<span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">z = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(x, y, z)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>线性数据结构</title>
      <link href="/20230619/python-20230619-%E7%BA%BF%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/20230619/python-20230619-%E7%BA%BF%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="1-内建常用数据类型">1. 内建常用数据类型</h2><p><strong>分类</strong></p><ul><li>数值型<ul><li>int、float、complex、bool</li></ul></li><li>序列sequence<ul><li>字符串str、字节序列bytes、bytearray</li></ul></li><li>列表list、元组tuple<ul><li>键值对</li><li>集合set、字典dict</li></ul></li></ul><h2 id="2-数值型">2. 数值型</h2><ul><li>int、float、complex、bool都是class，1、5.0、2+3j都是对象即实例</li><li>int：python3的int就是长整型，且没有大小限制，受限于内存区域的大小</li><li>float：由整数部分和小数部分组成。支持十进制和科学计数法表示。C的双精度型实现</li><li>complex：有实数和虚数部分组成，实数和虚数部分都是浮点数，3+4.2J</li><li>bool：int的子类，仅有2个实例True、False对应1和0，可以和整数直接运算</li></ul><h3 id="2-1-类型转换">2.1 类型转换</h3><ul><li>int、float、complex、bool也可以当做内建函数对数据进行类型转换</li><li>int(x) 返回一个整数</li><li>float(x) 返回一个浮点数</li><li>complex(x)、complex(x,y) 返回一个复数</li><li>bool(x) 返回布尔值，前面讲过False等价的对象</li></ul><h3 id="2-2-取整">2.2 取整</h3><p>math模块的floor()、ceil()函数；内建函数int()、round()；运算符//</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 整除</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span>//<span class="number">2</span>, <span class="number">5</span>//<span class="number">2</span>, <span class="number">7</span>//<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(-<span class="number">3</span>//<span class="number">2</span>, -<span class="number">5</span>//<span class="number">2</span>, -<span class="number">7</span>//<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">7</span>//<span class="number">2</span>, <span class="number">7</span>//-<span class="number">2</span>, -<span class="number">7</span>//<span class="number">2</span>, -(<span class="number">7</span>//<span class="number">2</span>))</span><br><span class="line"><span class="comment"># int</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;int ------------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">int</span>(<span class="number">1.4</span>), <span class="built_in">int</span>(<span class="number">1.5</span>), <span class="built_in">int</span>(<span class="number">1.6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">int</span>(-<span class="number">1.4</span>), <span class="built_in">int</span>(-<span class="number">1.5</span>), <span class="built_in">int</span>(-<span class="number">1.6</span>))</span><br><span class="line"><span class="comment"># ceil floor</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ceil floor ------------&#x27;</span>)</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="built_in">print</span>(math.floor(<span class="number">2.5</span>), math.floor(-<span class="number">2.5</span>))</span><br><span class="line"><span class="built_in">print</span>(math.ceil(<span class="number">2.5</span>), math.ceil(-<span class="number">2.5</span>))</span><br><span class="line"><span class="comment"># round</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;round ------------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">round</span>(<span class="number">1.4</span>), <span class="built_in">round</span>(-<span class="number">1.4</span>), <span class="built_in">round</span>(-<span class="number">1.6</span>), <span class="built_in">round</span>(<span class="number">1.6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">round</span>(<span class="number">2.4</span>), <span class="built_in">round</span>(-<span class="number">2.4</span>), <span class="built_in">round</span>(<span class="number">2.6</span>), <span class="built_in">round</span>(<span class="number">2.6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;round .5 ---------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">round</span>(<span class="number">0.5</span>), <span class="built_in">round</span>(<span class="number">1.5</span>), <span class="built_in">round</span>(<span class="number">2.5</span>), <span class="built_in">round</span>(<span class="number">3.5</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">round</span>(-<span class="number">0.5</span>), <span class="built_in">round</span>(-<span class="number">1.5</span>), <span class="built_in">round</span>(-<span class="number">2.5</span>), <span class="built_in">round</span>(-<span class="number">3.5</span>))</span><br></pre></td></tr></table></figure><ul><li>round()，四舍六入五取偶</li><li>math.floor()向下取整</li><li>math.ceil()向上取整</li><li>int() 取整数部分</li><li>// 整除且向下取整</li></ul><h3 id="2-3-常用数值处理函数">2.3 常用数值处理函数</h3><ul><li>min()、max()</li><li>abs()</li><li>pow(x, y) 等于 x ** y</li><li>math.sqrt() 等于 x ** 0.5</li><li>进制函数，返回值是字符串<ul><li>bin()、oct()、hex()</li></ul></li><li>math模块<ul><li>math.pi π</li><li>math.e 自如常数</li><li>math模块中还有对数函数、三角函数等</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(<span class="number">123</span>) <span class="comment"># 返回的是类型int</span></span><br><span class="line"><span class="built_in">isinstance</span>(<span class="number">456</span>, <span class="built_in">int</span>)</span><br><span class="line"><span class="built_in">isinstance</span>(<span class="literal">True</span>, (<span class="built_in">str</span>, <span class="built_in">int</span>, <span class="built_in">bool</span>))</span><br><span class="line"><span class="built_in">type</span>(<span class="number">1</span> + <span class="literal">True</span>)</span><br><span class="line"><span class="built_in">type</span>(<span class="number">1</span> + <span class="literal">True</span> + <span class="number">2.0</span>) <span class="comment"># 什么类型？</span></span><br></pre></td></tr></table></figure><p>即使是强类型语言，也会有隐式类型转换。</p><h2 id="3-线性数据结构">3. 线性数据结构</h2><p>线性表</p><ul><li>线性表（简称表），是一种抽象的数学概念，是一组元素的序列的抽象，它由有穷个元素组成（0个或任意个）</li><li>顺序表：使用一大块连续的内存顺序存储表中的元素，这样实现的表称为顺序表，或称连续表<ul><li>在顺序表中，元素的关系使用顺序表的存储顺序自然地表示</li></ul></li><li>链接表：在存储空间中将分散存储的元素链接起来，这种实现称为链接表，简称链表</li></ul><p>列表如同地铁站排好的队伍，有序，可以插队、离队，可以索引。</p><p>链表如同操场上手拉手的小朋友，有序但空间排列随意。或者可以想象成一串带线的珠子，随意盘放在桌上。也可以离队、插队，也可以索引。</p><h2 id="4-列表list">4. 列表list</h2><ul><li>一个排列整齐的队伍，Python采用顺序表实现</li><li>列表内的个体称作元素，由若干元素组成列表</li><li>元素可以是任意对象（数字、字符串、对象、列表等）</li><li>列表内元素有顺序，可以使用索引</li><li>线性的数据结构</li><li>使用 [ ] 表示</li><li>列表是可变的</li></ul><p>列表是非常重要的数据结构，对其内存结构和操作方法必须烂熟于心</p><h3 id="4-1-初始化">4.1 初始化</h3><ul><li>list() -&gt; new empty list</li><li>list(iterable) -&gt; new list initialized from iterable’s items</li><li>[]</li><li>列表不能一开始就定义大小</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls1 = []</span><br><span class="line">ls2 = <span class="built_in">list</span>()</span><br><span class="line">ls3 = [<span class="number">2</span>, <span class="string">&#x27;ab&#x27;</span>, [<span class="number">3</span>, <span class="string">&#x27;abc&#x27;</span>], (<span class="number">5</span>, <span class="number">30</span>, <span class="number">50</span>)] <span class="comment"># 列表是一个容器，元素可以是其它类型</span></span><br><span class="line">ls4 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">5</span>)) <span class="comment"># 非常常用的构造方式，将一个可迭代对象转换为一个列表</span></span><br></pre></td></tr></table></figure><h3 id="4-2-索引">4.2 索引</h3><ul><li>索引，也叫下标</li><li>正索引：从左至右，从0开始，为列表中每一个元素编号<ul><li>如果列表有元素，索引范围[0, 长度-1]</li></ul></li><li>负索引：从右至左，从-1开始<ul><li>如果列表有元素，索引范围[-长度, -1]</li></ul></li><li>正、负索引不可以超界，否则引发异常IndexError</li><li>为了理解方便，可以认为列表是从左至右排列的，左边是头部，右边是尾部，左边是下界，右边是上界</li><li>列表通过索引访问，list[index] ，index就是索引，使用中括号访问</li></ul><p>使用索引定位访问元素的时间复杂度为O(1)，这是最快的方式，是列表最好的使用方式。</p><h3 id="4-3-查询">4.3 查询</h3><ul><li>index(value,[start,[stop]])<ul><li>通过值value，从指定区间查找列表内的元素是否匹配</li><li>匹配第一个就立即返回索引</li><li>匹配不到，抛出异常ValueError</li></ul></li><li>count(value)<ul><li>返回列表中匹配value的次数</li></ul></li><li>时间复杂度<ul><li>index和count方法都是O(n)</li><li>随着列表数据规模的增大，而效率下降</li></ul></li><li>如何返回列表元素的个数？如何遍历？如何设计高效？<ul><li>len()</li></ul></li></ul><h3 id="4-4-修改">4.4 修改</h3><ul><li>索引定位元素，然后修改。注意索引不能超界</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls1 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">ls1[<span class="number">2</span>] = <span class="number">200</span></span><br></pre></td></tr></table></figure><h3 id="4-5-增加单个元素">4.5 增加单个元素</h3><ul><li>append(object) -&gt; None<ul><li>列表尾部追加元素，返回None</li><li>返回None就意味着没有新的列表产生，就地修改</li><li>定位时间复杂度是O(1)</li></ul></li><li>insert(index, object) -&gt; None<ul><li>在指定的索引index处插入元素object</li><li>返回None就意味着没有新的列表产生，就地修改</li><li>定位时间复杂度是O(1)</li></ul></li><li>索引能超上下界吗？<ul><li>超越上界，尾部追加</li><li>超越下界，头部追加</li></ul></li></ul><h3 id="4-6-增加多个元素">4.6 增加多个元素</h3><ul><li>extend(iteratable) -&gt; None<ul><li>将可迭代对象的元素追加进来，返回None</li><li>就地修改，本列表自身扩展</li></ul></li><li><ul><li>-&gt; list<ul><li>连接操作，将两个列表连接起来，产生新的列表，原列表不变</li><li>本质上调用的是魔术方法__add__()方法</li></ul></li></ul></li><li><ul><li>-&gt; list<ul><li>重复操作，将本列表元素重复n次，返回新的列表</li></ul></li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls1 = [<span class="number">1</span>] * <span class="number">5</span></span><br><span class="line">ls2 = [<span class="literal">None</span>] * <span class="number">6</span></span><br><span class="line">ls3 = [<span class="number">1</span>,<span class="number">2</span>] * <span class="number">3</span></span><br><span class="line">ls4 = [[<span class="number">1</span>]] * <span class="number">3</span></span><br></pre></td></tr></table></figure><p>这个重复操作看似好用，如果原理掌握不好，但非常危险</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>] * <span class="number">3</span></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># 结果是什么</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">y = [[<span class="number">1</span>]] * <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(y) <span class="comment"># 结果是什么</span></span><br><span class="line">y[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(y) <span class="comment"># 结果是什么</span></span><br><span class="line">y[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">200</span></span><br><span class="line"><span class="built_in">print</span>(y) <span class="comment"># 结果是什么</span></span><br></pre></td></tr></table></figure><p>在Python中一切皆对象，而对象都是引用类型，可以理解为一个地址指针指向这个对象。<br>但是，字面常量字符串、数值等表现却不像引用类型，暂时可以称为简单类型。<br>而列表、元组、字典，包括以后学习的类和实例都可以认为是引用类型。<br>你可以认为简单类型直接存在列表中，而引入类型只是把引用地址存在了列表中。</p><h3 id="4-7-删除">4.7 删除</h3><ul><li>remove(value) -&gt; None<ul><li>从左至右查找第一个匹配value的值，找到就移除该元素，并返回None，否则ValueError</li><li>就地修改</li><li>效率？</li></ul></li><li>pop([index]) -&gt; item<ul><li>不指定索引index，就从列表尾部弹出一个元素</li><li>指定索引index，就从索引处弹出一个元素，索引超界抛出IndexError错误</li><li>效率？指定索引的的时间复杂度？不指定索引呢？</li></ul></li><li>clear() -&gt; None<ul><li>清除列表所有元素，剩下一个空列表</li></ul></li></ul><h3 id="4-8-反转">4.8 反转</h3><ul><li>reverse() -&gt; None<ul><li>将列表元素反转，返回None</li><li>就地修改</li></ul></li></ul><p>这个方法最好不用，可以倒着读取，都不要反转。</p><h3 id="4-9-排序">4.9 排序</h3><ul><li>sort(key=None, reverse=False) -&gt; None<ul><li>对列表元素进行排序，就地修改，默认升序</li><li>reverse为True，反转，降序</li><li>key一个函数，指定key如何排序，lst.sort(key=function)</li></ul></li></ul><p>如果排序是必须的，那么排序。排序效率高吗？</p><h3 id="4-9-in成员操作">4.9 in成员操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;a&#x27;</span> <span class="keyword">in</span> [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="number">3</span>,<span class="number">4</span>] <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">3</span>,<span class="number">4</span>]]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3 id="4-10-列表复制">4.10 列表复制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>))</span><br><span class="line">b = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">c = a</span><br><span class="line">c[<span class="number">2</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(a == b) <span class="comment"># 还相等吗？</span></span><br><span class="line"><span class="built_in">print</span>(a == c) <span class="comment"># 相等吗？</span></span><br></pre></td></tr></table></figure><p>问题：</p><ol><li>最终a 和 b相等吗？a和b分别存着什么元素</li><li>a 和 c 相等吗？为什么？ c = a 这一句有复制吗？</li></ol><p>下面的程序a和b相等吗？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>))</span><br><span class="line">b = a.copy()</span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">a[<span class="number">2</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="number">5</span>]</span><br><span class="line">b = a.copy()</span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">a[<span class="number">2</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">a[<span class="number">2</span>] = b[<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">a[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(a == b) <span class="comment"># 还相等吗？</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><h3 id="4-11-列表的内存模型和深浅拷贝">4.11 列表的内存模型和深浅拷贝</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619200447.png" alt=""></p><ul><li>shadow copy<ul><li>影子拷贝，也叫浅拷贝。遇到引用类型数据，仅仅复制一个引用而已</li></ul></li><li>deep copy<ul><li>深拷贝，往往会递归复制一定深度</li></ul></li></ul><p>一般情况下，大多数语言提供的默认复制行为都是浅拷贝。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>], <span class="number">4</span>]</span><br><span class="line">b = copy.deepcopy(a)</span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line">a[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(a == b) <span class="comment"># 还相等吗？</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><p>| Python内建数据类型，内部都实现了 == ，它的意思是内容比较</p><h2 id="5-随机数">5. 随机数</h2><p>random模块</p><ul><li>randint(a, b) 返回[a, b]之间的整数</li><li>randrange ([start,] stop [,step]) 从指定范围内，按指定基数递增的集合中获取一个随机数，基数缺省值为1。 random.randrange(1,7,2)</li><li>choice(seq) 从非空序列的元素中随机挑选一个元素，比如random.choice(range(10))，从0到9中随机挑选一个整数。random.choice([1,3,5,7])</li><li>3.6开始提供choices，一次从样本中随机选择几个，可重复选择，可以指定权重</li><li>random.shuffle(list) -&gt;None 就地打乱列表元素</li><li>sample(population, k) 从样本空间或总体（序列或者集合类型）中随机取出k个不同的元素，返回一个新的列表<ul><li>random.sample([‘a’, ‘b’, ‘c’, ‘d’], 2)</li><li>random.sample([‘a’, ‘a’], 2) 会返回什么结果</li><li>每次从样本空间采样，在这一次中不可以重复抽取同一个元素</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.randint(<span class="number">1</span>, <span class="number">5</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.randrange(<span class="number">1</span>, <span class="number">5</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.choice(x))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察下面的0和1的比例</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.choices([<span class="number">0</span>, <span class="number">1</span>], k=<span class="number">6</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.choices([<span class="number">0</span>, <span class="number">1</span>], [<span class="number">10</span>, <span class="number">1</span>], k=<span class="number">6</span>)) <span class="comment"># 10比1权重</span></span><br><span class="line"></span><br><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="comment"># 采样</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="built_in">print</span>(random.sample(x, <span class="number">5</span>)) <span class="comment"># k能不能是6？</span></span><br></pre></td></tr></table></figure><h2 id="6-元组tuple">6. 元组tuple</h2><ul><li>一个有序的元素组成的集合</li><li>使用小括号 ( ) 表示</li><li>元组是不可变对象</li></ul><h3 id="6-1-初始化">6.1 初始化</h3><ul><li>tuple() -&gt; empty tuple</li><li>tuple(iterable) -&gt; tuple initialized from iterable’s items</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">t1 = () <span class="comment"># 空元组</span></span><br><span class="line">t2 = (<span class="number">1</span>,) <span class="comment"># 必须有这个逗号</span></span><br><span class="line">t3 = (<span class="number">1</span>,) * <span class="number">5</span></span><br><span class="line">t4 = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">t5 = <span class="number">1</span>, <span class="string">&#x27;a&#x27;</span></span><br><span class="line">t6 = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">t7 = <span class="built_in">tuple</span>() <span class="comment"># 空元组</span></span><br><span class="line">t8 = <span class="built_in">tuple</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">t9 = <span class="built_in">tuple</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br></pre></td></tr></table></figure><h3 id="6-2-索引">6.2 索引</h3><p>索引和列表规则一样，不可以超界</p><h3 id="6-3-查询">6.3 查询</h3><p>方法和列表一样，时间复杂度也一样。index、count、len等</p><h3 id="6-4-增删改">6.4 增删改</h3><p>元组元素的个数在初始化的时候已经定义好了，所以不能为元组增加元素、也不能从中删除元素、也不能修改元素的内容。</p><p>但是要注意下面这个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">t1 = ([<span class="number">1</span>]) * <span class="number">3</span></span><br><span class="line">t1[<span class="number">1</span>] = <span class="number">100</span> <span class="comment"># ?</span></span><br><span class="line"><span class="comment"># 注意下面的例子</span></span><br><span class="line">t2 = ([<span class="number">1</span>],) * <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(t2)</span><br><span class="line">t2[<span class="number">1</span>] = <span class="number">100</span></span><br><span class="line">t2[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(t2)</span><br></pre></td></tr></table></figure><p>上例说明t2是可变的吗？不是说元组不可变吗？到底什么不可变</p><h2 id="7-字符串str">7. 字符串str</h2><ul><li>一个个字符组成的有序的序列，是字符的集合</li><li>使用单引号、双引号、三引号引住的字符序列</li><li>字符串是不可变对象，是字面常量</li></ul><p>Python3起，字符串都是Unicode类型</p><h3 id="7-1-初始化">7.1 初始化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s1 = <span class="string">&#x27;string&#x27;</span></span><br><span class="line">s2 = <span class="string">&quot;string2&quot;</span></span><br><span class="line">s3 = <span class="string">&#x27;&#x27;&#x27;this&#x27;s a &quot;String&quot; &#x27;&#x27;&#x27;</span></span><br><span class="line">s4 = <span class="string">&#x27;hello \n magedu.com&#x27;</span></span><br><span class="line">s5 = <span class="string">r&quot;hello \n magedu.com&quot;</span></span><br><span class="line">s6 = <span class="string">&#x27;c:\windows\nt&#x27;</span></span><br><span class="line">s7 = <span class="string">R&quot;c:\windows\nt&quot;</span></span><br><span class="line">s8 = <span class="string">&#x27;c:\windows\\nt&#x27;</span></span><br><span class="line">name = <span class="string">&#x27;tom&#x27;</span>; age = <span class="number">20</span> <span class="comment"># python代码写在一行，使用分号隔开，不推荐</span></span><br><span class="line">s9 = <span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>, <span class="subst">&#123;age&#125;</span>&#x27;</span> <span class="comment"># 3.6支持f前缀</span></span><br><span class="line">sql = <span class="string">&quot;&quot;&quot;select * from user where name=&#x27;tom&#x27; &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>r前缀：所有字符都是本来的意思，没有转义<br>f前缀：3.6开始，使用变量插值</p></div><h3 id="7-2-索引">7.2 索引</h3><p>字符串是序列，支持下标访问。但不可变，不可以修改元素。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;select * from user where name=&#x27;tom&#x27;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(sql[<span class="number">4</span>]) <span class="comment"># 字符串&#x27;c&#x27;</span></span><br><span class="line">sql[<span class="number">4</span>] = <span class="string">&#x27;o&#x27;</span> <span class="comment"># 不可以</span></span><br></pre></td></tr></table></figure><h3 id="7-3-连接">7.3 连接</h3><ul><li>+加号<ul><li>将2个字符串连接起来</li><li>返回一个新的字符串</li></ul></li><li>join方法<ul><li>sep.join(iterable)</li><li>使用指定字符串作为分隔符，将可迭代对象中字符串使用这个分隔符拼接起来</li><li>可迭代对象必须是字符串</li><li>返回一个新的字符串</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="string">&#x27;ab&#x27;</span></span><br><span class="line">x = x + <span class="string">&#x27;cd&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;,&#x27;</span>.join(x))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\t&#x27;</span>.join(x))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>.join(x))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span>.join(<span class="built_in">range</span>(<span class="number">5</span>))) <span class="comment"># 可以吗</span></span><br></pre></td></tr></table></figure><h3 id="7-4-字符查找">7.4 字符查找</h3><ul><li>find(sub[, start[, end]]) -&gt; int<ul><li>在指定的区间[start, end)，从左至右，查找子串sub</li><li>找到返回正索引，没找到返回-1</li></ul></li><li>rfind(sub[, start[, end]]) -&gt; int<ul><li>在指定的区间[start, end)，从右至左，查找子串sub</li><li>找到返回正索引，没找到返回-1</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;hehe.edu&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>, <span class="number">6</span>, <span class="number">9</span>))</span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>, <span class="number">7</span>, <span class="number">20</span>))</span><br><span class="line"><span class="built_in">print</span>(s.find(<span class="string">&#x27;edu&#x27;</span>, <span class="number">200</span>))</span><br><span class="line">s = <span class="string">&#x27;hehe.edu&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>, <span class="number">6</span>, <span class="number">9</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>, <span class="number">7</span>, <span class="number">20</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rfind(<span class="string">&#x27;edu&#x27;</span>, <span class="number">200</span>))</span><br></pre></td></tr></table></figure><p>这两个方法只是找字符串的方向不同，返回值一样。找到第一个满足要求的子串立即返回。特别注意返回值，找不到返回的是负数-1。</p><p>这两个方法效率高吗？要不要用？</p><p>这两个方法效率真不高，都是在字符串中遍历搜索，但是如果找子串工作必不可少，那么必须这么做，但是能少做就少做</p><ul><li>index(sub[, start[, end]]) -&gt; int<ul><li>在指定的区间[start, end)，从左至右，查找子串sub</li><li>找到返回正索引，没找到抛出异常ValueError</li></ul></li><li>rindex(sub[, start[, end]]) -&gt; int<ul><li>在指定的区间[start, end)，从左至右，查找子串sub</li><li>找到返回正索引，没找到抛出异常ValueError</li></ul></li></ul><p>index方法和find方法很像，不好的地方在于找不到抛异常。推荐使用find方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;hehe.edu&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s.index(<span class="string">&#x27;edu&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.index(<span class="string">&#x27;edu&#x27;</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(s.index(<span class="string">&#x27;edu&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="comment">#print(s.index(&#x27;edu&#x27;, 6, 9)) # 抛异常</span></span><br><span class="line"><span class="built_in">print</span>(s.index(<span class="string">&#x27;edu&#x27;</span>, <span class="number">7</span>, <span class="number">20</span>))</span><br><span class="line"><span class="comment">#print(s.index(&#x27;edu&#x27;, 200)) # 抛异常</span></span><br></pre></td></tr></table></figure><ul><li>count(sub[, start[, end]]) -&gt; int<ul><li>在指定的区间[start, end)，从左至右，统计子串sub出现的次数</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;hehe.edu&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s.count(<span class="string">&#x27;edu&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.count(<span class="string">&#x27;edu&#x27;</span>, <span class="number">4</span>))</span><br></pre></td></tr></table></figure><ul><li>时间复杂度<ul><li>find、index和count方法都是O(n)</li><li>随着字符串数据规模的增大，而效率下降</li></ul></li><li>len(string)<ul><li>返回字符串的长度，即字符的个数</li></ul></li></ul><h3 id="7-5-分割">7.5 分割</h3><ul><li>split(sep=None, maxsplit=-1) -&gt; list of strings<ul><li>从左至右</li><li>sep 指定分割字符串，缺省的情况下空白字符串作为分隔符</li><li>maxsplit 指定分割的次数，-1 表示遍历整个字符串</li><li>立即返回列表</li></ul></li><li>rsplit(sep=None, maxsplit=-1) -&gt; list of strings<ul><li>从右向左开始切，但是输出的字符串字符不会反</li><li>sep 指定分割字符串，缺省的情况下空白字符串作为分隔符</li><li>maxsplit 指定分割的次数，-1 表示遍历整个字符串</li><li>立即返回列表</li></ul></li><li>splitlines([keepends]) -&gt; list of strings<ul><li>按照行来切分字符串</li><li>keepends 指的是是否保留行分隔符</li><li>行分隔符包括\n、\r\n、\r等</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;,&#x27;</span>.join(<span class="string">&#x27;abcd&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.split())</span><br><span class="line"><span class="built_in">print</span>(s.split(<span class="string">&#x27;,&#x27;</span>, <span class="number">2</span>))</span><br><span class="line">s1 = <span class="string">&#x27;\na b \tc\nd\n&#x27;</span> <span class="comment"># 注意下面3个切割的区别</span></span><br><span class="line"><span class="built_in">print</span>(s1.split())</span><br><span class="line"><span class="built_in">print</span>(s1.split(<span class="string">&#x27; &#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s1.split(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s1.split(<span class="string">&#x27;b&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s1.splitlines())</span><br></pre></td></tr></table></figure><ul><li>partition(sep) -&gt; (head, sep, tail)<ul><li>从左至右，遇到分隔符就把字符串分割成两部分，返回头、分隔符、尾三部分的三元组</li><li>如果没有找到分隔符，就返回头、2个空元素的三元组</li><li>sep 分割字符串，必须指定</li></ul></li><li>rpartition(sep) -&gt; (head, sep, tail)<ul><li>从右至左，遇到分隔符就把字符串分割成两部分，返回头、分隔符、尾三部分的三元组</li><li>如果没有找到分隔符，就返回2个空元素和尾的三元组</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;,&#x27;</span>.join(<span class="string">&#x27;abcd&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.partition(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.partition(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rpartition(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.rpartition(<span class="string">&#x27;.&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="7-6-替换">7.6 替换</h3><ul><li>replace(old, new[, count]) -&gt; str<ul><li>字符串中找到匹配替换为新子串，返回新字符串</li><li>count表示替换几次，不指定就是全部替换</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;,&#x27;</span>.join(<span class="string">&#x27;abcd&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">2</span>))</span><br><span class="line">s1 = <span class="string">&#x27;www.hehe.edu&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s1.replace(<span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s1.replace(<span class="string">&#x27;ww&#x27;</span>, <span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s1.replace(<span class="string">&#x27;ww&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)) <span class="comment"># 返回什么？</span></span><br><span class="line"><span class="built_in">print</span>(s1.replace(<span class="string">&#x27;www&#x27;</span>, <span class="string">&#x27;a&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="7-7-移除">7.7 移除</h3><ul><li>strip([chars]) -&gt; str<ul><li>在字符串两端去除指定的字符集chars中的所有字符</li><li>如果chars没有指定，去除两端的空白字符</li></ul></li><li>lstrip([chars]) -&gt; str ，从左开始</li><li>rstrip([chars]) -&gt; str，从右开始</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;\t\r\na b c,d\ne\n\t&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(s.strip())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(s.strip(<span class="string">&#x27;\t\n&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(s.strip(<span class="string">&#x27;\t\ne\r&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="7-8-首尾判断">7.8 首尾判断</h3><ul><li>endswith(suffix[, start[, end]]) -&gt; bool<ul><li>在指定的区间[start, end)，字符串是否是suffix结尾</li></ul></li><li>startswith(prefix[, start[, end]]) -&gt; bool<ul><li>在指定的区间[start, end)，字符串是否是prefix开头</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;www.hehe.edu&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s.startswith(<span class="string">&#x27;ww&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(s.startswith(<span class="string">&#x27;e&#x27;</span>, <span class="number">7</span>))</span><br><span class="line"><span class="built_in">print</span>(s.startswith(<span class="string">&#x27;e&#x27;</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(s.startswith(<span class="string">&#x27;edu&#x27;</span>, <span class="number">11</span>))</span><br><span class="line"><span class="built_in">print</span>(s.endswith(<span class="string">&#x27;edu&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="7-9-其它函数">7.9 其它函数</h3><ul><li>upper()大写</li><li>lower()小写</li><li>swapcase() 交换大小写</li><li>isalnum() -&gt; bool 是否是字母和数字组成</li><li>isalpha() 是否是字母</li><li>isdecimal() 是否只包含十进制数字</li><li>isdigit() 是否全部数字(0~9)</li><li>isidentifier() 是不是字母和下划线开头，其他都是字母、数字、下划线</li><li>islower() 是否都是小写</li><li>isupper() 是否全部大写</li><li>isspace() 是否只包含空白字符</li></ul><p>其他格式打印函数中文几乎不用，大家自行查看帮助</p><h3 id="7-10-格式化">7.10 格式化</h3><p>简单的使用+或者join也可以拼接字符串，但是需要先转换数据到字符串后才能拼接。</p><h4 id="7-10-1-C风格printf-style">7.10.1 C风格printf-style</h4><ul><li>占位符：使用%和格式字符，例如%s、%d</li><li>修饰符：在占位符中还可以插入修饰符，例如%03d</li><li>format % values<ul><li>format是格式字符串，values是被格式的值</li><li>格式字符串和被格式的值之间使用%</li><li>values只能是一个对象，可以是一个值，可以是一个元素个数和占位符数目相等的元组，也可</li></ul></li></ul><p>以是一个字典</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;I am %03d&quot;</span> % (<span class="number">20</span>,)</span><br><span class="line"><span class="string">&#x27;I like %s.&#x27;</span> % <span class="string">&#x27;Python&#x27;</span></span><br><span class="line"><span class="string">&quot;%3.2f%% 0x%x %#X&quot;</span> % (<span class="number">89.7654</span>, <span class="number">10</span>, <span class="number">256</span>) <span class="comment"># 宽度为3，小数点后2位</span></span><br><span class="line"><span class="string">&quot;I am %-5d&quot;</span> % (<span class="number">20</span>,)</span><br><span class="line"><span class="string">&quot;%(host)s.%(domain)s&quot;</span> % &#123;<span class="string">&#x27;domain&#x27;</span>:<span class="string">&#x27;magedu.com&#x27;</span>, <span class="string">&#x27;host&#x27;</span>:<span class="string">&#x27;www&#x27;</span>&#125; <span class="comment"># 靠名字对应</span></span><br></pre></td></tr></table></figure><h4 id="7-10-2-format函数">7.10.2 format函数</h4><p>Python2.5之后，字符串类型提供了format函数，功能更加强大，鼓励使用。</p><p>“{} {xxx}”.format(*args, **kwargs) -&gt; str</p><ul><li>args是可变的位置参数</li><li>kwargs是可变关键字参数，写作a=100</li><li>使用花括号作为占位符</li><li>{}表示按照顺序匹配位置参数，{n}表示取位置参数索引为n的值</li><li>{xxx}表示在关键字参数中搜索名称一致的</li><li><code>&#123;&#123;&#125;&#125;</code> 表示打印花括号</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 位置对应</span></span><br><span class="line"><span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">8080</span>)</span><br><span class="line"><span class="comment"># 位置或关键字对应</span></span><br><span class="line"><span class="string">&quot;&#123;server&#125; &#123;1&#125;:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">8080</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>, server=<span class="string">&#x27;Web Server Info: &#x27;</span>)</span><br><span class="line"><span class="comment"># 访问元素</span></span><br><span class="line"><span class="string">&quot;&#123;0[0]&#125;.&#123;0[1]&#125;&quot;</span>.<span class="built_in">format</span>((<span class="string">&#x27;hehe&#x27;</span>, <span class="string">&#x27;com&#x27;</span>))</span><br><span class="line"><span class="comment"># 进制</span></span><br><span class="line"><span class="string">&quot;&#123;0:d&#125; &#123;0:b&#125; &#123;0:o&#125; &#123;0:x&#125; &#123;0:#X&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">31</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浮点数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 1.7320508075688772</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:f&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 1.732051，精度默认6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:10f&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 右对齐，宽度10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:2&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">102.231</span>)) <span class="comment"># 宽度为2数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:2&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">1</span>)) <span class="comment"># 宽度为2数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:.2&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 1.7 2个数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 1.73 小数点后2位</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:3.2f&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>**<span class="number">0.5</span>)) <span class="comment"># 1.73 宽度为3，小数点后2位</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:20.3f&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">0.2745</span>)) <span class="comment"># 0.275</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:3.3%&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">1</span>/<span class="number">3</span>)) <span class="comment"># 33.333%</span></span><br><span class="line"><span class="comment"># 注意宽度可以被撑破</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对齐</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;*&#123;&#125;=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>*<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;*&#123;&#125;=&#123;:2&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>*<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;1&#125;*&#123;0&#125;=&#123;2:3&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>*<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;1&#125;*&#123;0&#125;=&#123;2:0&gt;3&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>*<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;*&#123;&#125;=&#123;:#&lt;3&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">4</span>, <span class="number">5</span>, <span class="number">20</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:#^7&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">3</span>))</span><br></pre></td></tr></table></figure><h2 id="8-字节序列">8. 字节序列</h2><p>Python3 引入两个新的类型bytes、bytearray。<br>bytes不可变字节序列；bytearray是可变字节数组</p><h3 id="8-1-编码与解码">8.1 编码与解码</h3><ul><li>编码：str =&gt; bytes，将字符串这个字符序列使用指定字符集encode编码为一个个字节组成的序列bytes</li><li>解码：bytes或bytearray =&gt; str，将一个个字节按照某种指定的字符集解码为一个个字符串组成的字符串</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;abc&quot;</span>.encdoe()) <span class="comment"># 缺省为utf-8编码</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;啊&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;啊&quot;</span>.encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;abc&#x27;</span>.decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;\xb0\xa1&#x27;</span>.decode(<span class="string">&#x27;gbk&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="8-2-ASCII">8.2 ASCII</h3><p>ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）是基于拉丁字母的一套单字节编码系统</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619210333.png" alt=""></p><div class="note danger no-icon flat"><p>熟记：</p><ol><li>\x00是ASCII表中第一项，C语言中的字符串结束符</li><li>\t、\x09，表示tab字符</li><li>\r\n是\x0d\x0a</li><li>\x30~\x39 字符0~9，\x31是字符1</li><li>\x41对应十进制65，表示A</li><li>\x61对应十进制97，表示a</li></ol><p>注意：这里的1指定是字符1，不是数字1</p><p>UTF-8、GBK都兼容了ASCII</p></div><h3 id="8-3-Bytes初始化">8.3 Bytes初始化</h3><ul><li>bytes() 空bytes</li><li>bytes(int) 指定字节的bytes，被0填充</li><li>bytes(iterable_of_ints) -&gt; bytes [0,255]的int组成的可迭代对象</li><li>bytes(string, encoding[, errors]) -&gt; bytes 等价于string.encode()</li><li>bytes(bytes_or_buffer) -&gt; immutable copy of bytes_or_buffer 从一个字节序列或者buffer复制出</li><li>一个新的不可变的bytes对象</li><li>使用b前缀定义<ul><li>只允许基本ASCII使用字符形式b’abc9’</li><li>使用16进制转义表示b&quot;\x41\x61&quot;</li></ul></li></ul><p>bytes类型和str类型类似，都是不可变类型，操作方法类似。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;abcd&#x27;</span>[<span class="number">2</span>]) <span class="comment"># 返回int，指定是本字节对应的十进制数</span></span><br><span class="line">x = <span class="string">b&#x27;\t\x09&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(x, <span class="built_in">len</span>(x))</span><br><span class="line">y = <span class="string">br&#x27;\t\x09&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(y, <span class="built_in">len</span>(y))</span><br></pre></td></tr></table></figure><h3 id="8-4-bytearray初始化">8.4 bytearray初始化</h3><ul><li>bytearray() 空bytearray</li><li>bytearray(int) 指定字节的bytearray，被0填充</li><li>bytearray(iterable_of_ints) -&gt; bytearray [0,255]的int组成的可迭代对象</li><li>bytearray(string, encoding[, errors]) -&gt; bytearray 近似string.encode()，不过返回可变对象</li><li>bytearray(bytes_or_buffer) 从一个字节序列或者buffer复制出一个新的可变的bytearray对象</li></ul><p>b前缀表示的是bytes，不是bytearray类型</p><p>由于bytearray类型是可变数组，所以，类似列表。</p><ul><li>append(int) 尾部追加一个元素</li><li>insert(index, int) 在指定索引位置插入元素</li><li>extend(iterable_of_ints) 将一个可迭代的整数集合追加到当前bytearray</li><li>pop(index=-1) 从指定索引上移除元素，默认从尾部移除</li><li>remove(value) 找到第一个value移除，找不到抛ValueError异常</li><li>注意：上述方法若需要使用int类型，值在[0, 255]</li><li>clear() 清空bytearray</li><li>reverse() 翻转bytearray，就地修改</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">b = <span class="built_in">bytearray</span>()</span><br><span class="line">b.append(<span class="number">97</span>)</span><br><span class="line">b.append(<span class="number">99</span>)</span><br><span class="line">b.insert(<span class="number">1</span>,<span class="number">98</span>)</span><br><span class="line">b.extend([<span class="number">65</span>,<span class="number">66</span>,<span class="number">67</span>])</span><br><span class="line">b.remove(<span class="number">66</span>)</span><br><span class="line">b.pop()</span><br><span class="line">b.reverse()</span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment"># 输出什么</span></span><br><span class="line">b.clear()</span><br></pre></td></tr></table></figure><h2 id="9-线性结构">9. 线性结构</h2><p>线性结构特征：</p><ul><li>可迭代 for … in</li><li>有长度，通过len(x)获取，容器</li><li>通过整数下标可以访问元素。正索引、负索引<ul><li>可以切片</li></ul></li></ul><p>已经学习过的线性结构：list、tuple、str、bytes、bytearray</p><h3 id="9-1-切片">9.1 切片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sequence[start:stop]</span><br><span class="line">sequence[start:stop:step]</span><br></pre></td></tr></table></figure><ul><li>通过给定的索引区间获得线性结构的一部分数据</li><li>start、stop、step为整数，可以是正整数、负整数、零</li><li>start为0时，可以省略</li><li>stop为末尾时，可以省略</li><li>step为1时，可以省略</li><li>切片时，索引超过上界（右边界），就取到末尾；超过下界（左边界），取到开头</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(x[:])</span><br><span class="line"><span class="built_in">print</span>(x[:-<span class="number">1</span>]) <span class="comment">#</span></span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">0</span>:])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">3</span>:])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">3</span>:-<span class="number">1</span>]) <span class="comment">#</span></span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">9</span>:])</span><br><span class="line"><span class="built_in">print</span>(x[:<span class="number">9</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">9</span>:-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(x[:<span class="number">100</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">100</span>:])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">4</span>:-<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">4</span>:-<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;0123456789&#x27;</span>[-<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;0123456789&#x27;</span>[-<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytearray</span>(<span class="string">b&#x27;0123456789&#x27;</span>)[-<span class="number">10</span>:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># 步长</span></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(x[::])</span><br><span class="line"><span class="built_in">print</span>(x[::<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">2</span>:<span class="number">8</span>:<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(x[:<span class="number">9</span>:<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">1</span>::<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">10</span>:<span class="number">8</span>:<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 起止和方向</span></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">10</span>:])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">5</span>:<span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">5</span>:-<span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">6</span>:<span class="number">5</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">5</span>:<span class="number">5</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">1</span>:<span class="number">9</span>:-<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[::-<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">8</span>::-<span class="number">2</span>]) <span class="comment"># 表示索引8到左尽头，包含0</span></span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">8</span>:<span class="number">0</span>:-<span class="number">2</span>]) <span class="comment"># 表示索引8到索引1，不含0</span></span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">8</span>:-<span class="number">10</span>:<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[<span class="number">8</span>:-<span class="number">10</span>:-<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">5</span>:<span class="number">4</span>:-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(x[-<span class="number">5</span>:<span class="number">5</span>:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>在序列上使用切片[start:stop]，子区间索引范围[start, stop)，相当于从start开始指向stop的方向上获取数据<br>默认step为1，表示向右；步长为负数，表示向左<br>如果子区间方向和步长方向不一致，直接返回当前类型的&quot;空对象&quot;<br>如果子区间方向和步长方向一致，则从起点间隔步长取值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用id看地址，要注意地址回收复用问题</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>([<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>]))</span><br><span class="line"><span class="comment"># 上下两句可能内存地址一样，但是上面那个[1,2,3]没有意义，因为它用完之后，引用计数为0了，没</span></span><br><span class="line">人能再次访问到，释放了内存</span><br><span class="line"><span class="comment"># 如果2个存在在内存中的对象，地址一样一定是同一个对象</span></span><br></pre></td></tr></table></figure><h3 id="9-2-本质">9.2 本质</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">y = x[:]</span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(x), <span class="built_in">id</span>(y))</span><br><span class="line">x[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line">x = [[<span class="number">1</span>]]</span><br><span class="line">y = x[:]</span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line"><span class="built_in">print</span>(x == y)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(x), <span class="built_in">id</span>(y), x <span class="keyword">is</span> y)</span><br><span class="line">x[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line"><span class="built_in">print</span>(x == y)</span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">is</span> y)</span><br><span class="line">x[<span class="number">0</span>] = <span class="number">200</span></span><br><span class="line"><span class="built_in">print</span>(x == y) <span class="comment"># ?</span></span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br></pre></td></tr></table></figure><p>上例可知，实际上切片后得到一个全新的对象。 [:] 或 [::] 相当于copy方法。</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基础语法</title>
      <link href="/20230619/python-20230619-01%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"/>
      <url>/20230619/python-20230619-01%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Python发展">1. Python发展</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619115222.png" alt=""></p><p>1989年圣诞节期间，为了打发无聊的时间，荷兰人Guido van Rossum（数学、计算机双硕士，2005年加入Google，2013年加入DropBox），决心开发一种新的解释性脚本语言。</p><p>1991年初发布了第一个公开发行版。由于他是英国BBC喜剧《Monty Python’s Flying Circus》的忠实粉丝，因此为这门语言取名Python。</p><p>Python目前已经成为很多大学的编程课语言。甚至在国内一些考试已经引入了Python。科学计算方面、运维领域Python几乎已经成为最主要的编程语言，拥有非常方便快捷开发的库。</p><p>Python的哲学，可以使用 <code>import this</code> 查看Python之禅。</p><h2 id="2-Python的版本">2. Python的版本</h2><p>目前企业中使用的主要版本还是2.x和3.x。</p><p>2.x最后一个版本是2.7，很多企业为了兼容老项目依然在维护。从2020年开始，不在支持Python2，官方还提供了一个倒计时网站https://pythonclock.org/。</p><p>3.x还在不断的扩充发展，当前主流版本是3.6+。</p><ul><li>2015年9月发布3.5</li><li>2016年12月发布3.6</li><li>2018年6月发布3.7</li><li>2019年10月发布3.8</li><li>2020年10月发布3.9</li></ul><p>Python2和3的区别</p><ul><li>语句函数化，例如print(1,2)打印出1 2，但是2.x中意思是print语句打印元组，3.x中意思是函数的2个参数整除，例如1/2和1//2，3.x版本中/为自然除</li><li>3.x中raw_input重命名为input，不再使用raw_input</li><li>round函数，在3.x中i.5的取整变为距离最近的偶数</li><li>3.x字符串统一使用Unicode</li><li>异常的捕获、抛出的语法改变</li></ul><p>2015年后，各主要国内外大公司都已经迁移到了Python3。很多重要的Python第三方库也陆续停止了对Python2的支持，所以，Python 3已经是必须学习的版本。2018年Python3的使用比例已经超过了85%。</p><p>在公司内，往往老项目维护维持2.x版本暂不升级，新项目使用3.x开发。</p><p>开发时，假如使用3.5.8，部署时应尽量保持一致，不要随意升级版本，更不要降低版本。</p><p>不要迷信版本，学会一个版本，好好学会一门语言，其他都不是问题。当然，也不要迷信语言。</p><p>在最合适的领域使用最合适的语言。</p><p>截止2021年3月，3.8、3.9版本依然为不稳定版本。</p><h2 id="3-环境安装">3. 环境安装</h2><p>官方网站下载不同平台。<a href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></p><h3 id="3-1-Linux环境安装">3.1 Linux环境安装</h3><p>如果是Ubuntu等桌面系统，都已经更新到了Python较新的版本。但多数生产环境使用的还是红帽系统。</p><p>CentOS7默认还是Python2.7，而开发环境如果是高版本Python就带来了问题。为了不破坏当前系统使用，甚至以后为了多个Python项目部署（这些项目使用不同Python解释器版本），建议使用多版本工具。</p><p>也可以考虑容器部署Python应用程序。</p><p><strong>多版本安装</strong></p><p>以CentOS8为例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install python36 python38</span></span><br><span class="line">可以通过配置选择当前Python版本</span><br><span class="line"><span class="comment"># alternatives --config python3</span></span><br><span class="line">查看当前版本</span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line"><span class="comment"># python3 -V</span></span><br></pre></td></tr></table></figure><p><strong>虚拟环境</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装虚拟环境</span><br><span class="line"><span class="comment"># pip3 install virtualenv</span></span><br></pre></td></tr></table></figure><p>新建一个普通用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># useradd python</span></span><br><span class="line"><span class="comment"># echo python | passwd --stdin python</span></span><br><span class="line"><span class="comment"># su - python</span></span><br></pre></td></tr></table></figure><p>创建工程目录，并设置虚拟环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p projects/cmdb</span><br><span class="line">$ <span class="built_in">mkdir</span> venvs</span><br><span class="line">$ <span class="built_in">cd</span> venvs</span><br><span class="line">$ virtualenv vcmdb</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">vcmdb</span><br><span class="line">$ <span class="built_in">cd</span> ~/projects/cmdb/</span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/python/projects/cmdb</span><br><span class="line">(vcmdb) 表示虚拟环境</span><br><span class="line">$ <span class="built_in">source</span> ~/venvs/vcmdb/bin/activate</span><br><span class="line">(vcmdb) [python@localhost cmdb]$ python -V</span><br><span class="line">Python 3.8.0</span><br><span class="line">(vcmdb) [python@localhost cmdb]$ deactivate</span><br><span class="line">$ python -V</span><br><span class="line">-bash: python: <span class="built_in">command</span> not found</span><br><span class="line">$ python3 -V</span><br><span class="line">Python 3.8.0</span><br></pre></td></tr></table></figure><p>基于3.6的虚拟环境，使用-p 指定3.6版本python解释器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ virtualenv -p /usr/bin/python3.6 vcmdb36</span><br><span class="line">$ <span class="built_in">cd</span> ~/projects/cmdb/</span><br><span class="line">$ <span class="built_in">source</span> ~/venvs/vcmdb36/bin/activate</span><br><span class="line">(vcmdb36) [python@localhost cmdb]$ python -V</span><br><span class="line">Python 3.6.8</span><br><span class="line">(vcmdb36) [python@localhost cmdb]$ <span class="built_in">which</span> python3</span><br><span class="line">~/venvs/vcmdb36/bin/python3</span><br><span class="line">(vcmdb36) [python@localhost cmdb]$ <span class="built_in">which</span> python</span><br><span class="line">~/venvs/vcmdb36/bin/python</span><br><span class="line">(vcmdb36) [python@localhost cmdb]$ deactivate</span><br><span class="line">[python@localhost cmdb]$ python3 -V</span><br><span class="line">Python 3.8.0</span><br></pre></td></tr></table></figure><h3 id="3-2-Windows环境安装">3.2 Windows环境安装</h3><p>下载 <code>Windows x86-64 executable installer</code> ，按照提示安装即可</p><p><strong>勾选增加PATH路径</strong>，简单安装直接点击&quot;Install Now&quot;。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619120611.png" alt=""></p><p>打开Windows命令行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python -V</span><br><span class="line">Python 3.7.4</span><br><span class="line">$ pip -V</span><br><span class="line">pip 19.0.3 (python 3.7)</span><br></pre></td></tr></table></figure><p>pip是Python包管理器，以后安装Python第三方包都需要它，它从3.x开始就集成在Python安装包里面了。</p><h2 id="4-pip通用配置">4. pip通用配置</h2><p>windows配置文件： <code>~/pip/pip.ini</code> windows家目录，在“运行”中键入 .<br>Linux配置文件： <code>~/.pip/pip.conf</code><br>内容，可参照 <a href="http://mirrors.aliyun.xn--compypi-0m1l996f447c">http://mirrors.aliyun.com的pypi帮助</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">[install]</span><br><span class="line">trusted-host=mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p><code>pip install pkgname</code> 命令，是安装python包的命令</p><h2 id="5-安装ipython">5. 安装ipython</h2><h3 id="5-1-ipython">5.1 ipython</h3><p>是增强的交互式Python命令行工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pip list</span><br><span class="line">$ pip install ipython</span><br><span class="line">$ ipython</span><br></pre></td></tr></table></figure><h3 id="5-2-Jupyter">5.2 Jupyter</h3><p>是基于WEB的交互式笔记本，其中可以非常方便的使用Python。<br>安装Jupyter，也会依赖安装ipython的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pip install jupyter</span><br><span class="line">$ jupyter notebook <span class="built_in">help</span></span><br><span class="line">$ jupyter notebook --ip=0.0.0.0 --no-browser</span><br><span class="line">$ ss -tanl</span><br></pre></td></tr></table></figure><p><strong>常用快捷键</strong></p><ul><li>a之前插入代码块、b之后插入代码块</li><li>L 增加行号</li><li>运行代码块 shift + enter，选择下面的代码块</li><li>运行当前代码块 ctrl + enter</li></ul><h2 id="6-Pycharm安装">6. Pycharm安装</h2><p>Windows用户，官网下载Pycharm社区版，足够开发项目使用了。按照软件安装向导提示安装即可。</p><p>Ubuntu可在应用市场安装社区版。</p><h2 id="7-查阅帮助">7. 查阅帮助</h2><ul><li>在线帮助，html</li><li>下载并打开官方文档，chm</li><li>第一手好的资料应该是帮助文档<br><a href="https://www.python.org/downloads/windows/">https://www.python.org/downloads/windows/</a></li><li>IPython中<ul><li>使用help(keyword)，keyword可以是变量、对象、类、函数等</li><li>keyword?</li><li>keyword??</li></ul></li></ul><h2 id="8-Python解释器">8. Python解释器</h2><table><thead><tr><th>解释器</th><th>说明</th></tr></thead><tbody><tr><td>CPython</td><td>官方，C语言开发，最广泛的Python解释器</td></tr><tr><td>IPython</td><td>一个交互式、功能增强的CPython</td></tr><tr><td>PyPy</td><td>Python语言写的Python解释器，JIT技术，动态编译Python代码</td></tr><tr><td>Jython</td><td>Python的源代码编译成Java的字节码，跑在JVM上</td></tr><tr><td>IronPython</td><td>与Jython类似，运行在.Net平台上的解释器，Python代码被编译成.Net的字节码</td></tr><tr><td>stackless</td><td>Python的增强版本解释器，不使用CPython的C的栈，采用微线程概念编程，并发编程</td></tr></tbody></table><h2 id="9-基础语法">9. 基础语法</h2><h3 id="9-1-注释">9.1 注释</h3><p># 井号标注的文本</p><h3 id="9-2-数字">9.2 数字</h3><ul><li>整数int<ul><li>Python3开始不再区分long、int，long被重命名为int，所以只有int类型了</li><li>进制表示：<ul><li>十进制10</li><li>十六进制0x10</li><li>八进制0o10</li><li>二进制0b10</li></ul></li><li>bool类型，有2个值True、False</li></ul></li><li>浮点数float<ul><li>1.2、3.1415、-0.12，1.46e9等价于科学计数法1.46*109</li><li>本质上使用了C语言的double类型</li></ul></li><li>复数complex<ul><li>1+2j或1+2J</li></ul></li></ul><h3 id="9-3-字符串">9.3 字符串</h3><ul><li>使用 ’ &quot; 单双引号引用的字符的序列</li><li>‘’'和&quot;“” 单双三引号，可以跨行、可以在其中自由的使用单双引号</li><li>r前缀：在字符串前面加上r或者R前缀，表示该字符串不做特殊的处理</li><li>f前缀：3.6版本开始，新增f前缀，格式化字符串</li></ul><p><strong>字符串拼接</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span>(<span class="number">1</span>) + <span class="string">&#x27;,&#x27;</span> + <span class="string">&#x27;b&#x27;</span> <span class="comment"># 都转换成字符串拼接到一起</span></span><br><span class="line"><span class="string">&quot;&#123;&#125;-&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># &#123;&#125;就是填的空，有2个，就使用2个值填充</span></span><br><span class="line"><span class="comment"># 在3.6后，可以使用插值</span></span><br><span class="line">a = <span class="number">100</span>;</span><br><span class="line">b = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line"><span class="string">f&#x27;<span class="subst">&#123;a&#125;</span>-<span class="subst">&#123;b&#125;</span>&#x27;</span> <span class="comment"># 一定要使用f前缀，在大括号中使用变量名</span></span><br></pre></td></tr></table></figure><h3 id="9-4-转义序列">9.4 转义序列</h3><p><code>\\</code> <code>\t</code> <code>\r</code> <code>\n</code> <code>\'</code> <code>\&quot;</code></p><ul><li>上面每一个转义字符只代表<strong>一个字符</strong>，例如 \t 显示时占了4个字符位置，但是它是一个字符</li><li>前缀r，把里面的所有字符当普通字符对待，则转义字符就不转义了。</li><li>转义：让字符不再是它当前的意义，例如\t，t就不是当前意义字符t了，而是被\转成了tab键</li></ul><h3 id="9-5-缩进">9.5 缩进</h3><ul><li>未使用C等语言的花括号，而是采用缩进的方式表示层次关系</li><li>约定使用4个空格缩进</li></ul><h3 id="9-6-续行">9.6 续行</h3><ul><li>在行尾使用 \，注意\之后除了紧跟着换行之外不能有其他字符</li><li>如果使用各种括号，认为括号内是一个整体，其内部跨行不用 \</li></ul><h3 id="9-7-标识符">9.7 标识符</h3><ol><li>一个名字，用来指代一个值</li><li>只能是字母、下划线和数字</li><li>只能以字母或下划线开头</li><li>不能是python的关键字，例如def、class就不能作为标识符</li><li>Python是大小写敏感的</li></ol><p><strong>标识符约定：</strong></p><ul><li>不允许使用中文，也不建议使用拼音</li><li>不要使用歧义单词，例如class_</li><li>在python中不要随便使用下划线开头的标识符</li></ul><h3 id="9-8-语言类型">9.8 语言类型</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619122814.png" alt=""></p><p>Python是动态语言、强类型语言。</p><p><strong>静态语言</strong></p><ul><li>事先声明变量类型，之后变量的值可以改变，但值的类型不能再改变</li><li>编译时检查</li></ul><p><strong>动态语言</strong></p><ul><li>不用事先声明类型，随时可以赋值为其他类型</li><li>编程时不知道是什么类型，很难推断</li></ul><p><strong>强类型语言</strong></p><ul><li>不同类型之间操作，必须先强制类型转换为同一类型。 print(‘a’+1)</li></ul><p><strong>弱类型语言</strong></p><ul><li>不同类型间可以操作，自动隐式转换，JavaScript中 console.log(1+‘a’)</li></ul><p>但是要注意的是，强与弱只是一个相对概念，即使是强类型语言也支持隐式类型转换。</p><h3 id="9-10-False等价">9.10 False等价</h3><p>False等价布尔值，相当于bool(value)</p><ul><li>空容器<ul><li>空集合set</li><li>空字典dict</li><li>空列表list</li><li>空元组tuple</li></ul></li><li>空字符串</li><li>None</li><li>0</li></ul><h3 id="9-11-运算符Operator">9.11 运算符Operator</h3><h4 id="9-11-1-算数运算符">9.11.1 算数运算符</h4><p>+、-、*、/、//向下取整整除、%取模、**幂</p><p>注：在Python2中/和//都是整除。</p><h4 id="9-11-2-位运算符">9.11.2 位运算符</h4><p>&amp;位与、|位或、^异或、&lt;&lt;左移、&gt;&gt;右移</p><p>~按位取反，包括符号位</p><h4 id="9-11-3-比较运算符">9.11.3 比较运算符</h4><p>==、!=、&gt;、&gt;=、&lt;、&lt;=</p><p>链式比较： 4 &gt; 3 &gt; 2</p><p>比较运算符，返回一个bool值</p><p>思考：1 == ‘1’ 吗？ 1 &gt; ‘1’ 吗？</p><h4 id="9-11-4-逻辑运算符">9.11.4 逻辑运算符</h4><p>与and、或or、非not</p><p>逻辑运算符也是短路运算符</p><ul><li>and 如果前面的表达式等价为False，后面就没有必要计算了，这个逻辑表达式最终一定等价为False</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="string">&#x27;2&#x27;</span> <span class="keyword">and</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="keyword">and</span> <span class="string">&#x27;abc&#x27;</span> <span class="keyword">and</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><ul><li>or 如果前面的表达式等价为True，后面没有必要计算了，这个逻辑表达式最终一定等价为True</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">or</span> <span class="literal">False</span> <span class="keyword">or</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><ul><li>特别注意，返回值。<strong>返回值不一定是bool型</strong></li><li>把最频繁使用的，做最少计算就可以知道结果的条件放到前面，如果它能短路，将大大减少计算量</li></ul><h4 id="9-11-5-赋值运算符">9.11.5 赋值运算符</h4><p>a = min(3, 5)<br>+=、 -= 、*=、/=、%=、//= 等<br>x = y = z = 10<br>赋值语句先计算等式右边，然后再赋值给变量</p><h4 id="9-11-6-成员运算符">9.11.6 成员运算符</h4><p>in、not in，用来判断是否是容器的元素，返回布尔值</p><h4 id="9-11-7-身份运算符">9.11.7 身份运算符</h4><p>is 、is not，用来判断是否是同一个对象</p><h3 id="9-12-运算符优先级">9.12 运算符优先级</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20230619123908.png" alt=""></p><ul><li>单目运算符 &gt; 双目运算符</li><li>算数运算符 &gt; 位运算符 &gt; 比较运算符 &gt; 逻辑运算符<ul><li>-3 + 2 &gt; 5 and ‘a’ &gt; ‘b’</li></ul></li></ul><p>搞不清楚就使用括号。长表达式，多用括号，易懂、易读</p><h3 id="9-13-表达式">9. 13 表达式</h3><p>由数字、符号、括号、变量等的组合。有算数表达式、逻辑表达式、赋值表达式、lambda表达式等等。</p><p>Python中，赋值即定义。Python是动态语言，只有赋值才会创建一个变量，并决定了变量的类型和值。</p><p>如果一个变量已经定义，赋值相当于重新定义。</p><h2 id="10-内建函数">10. 内建函数</h2><table><thead><tr><th>内建函数</th><th>函数签名</th><th>说明</th></tr></thead><tbody><tr><td>print</td><td>print(value, …, sep=’ ‘,end=’\n’)</td><td>将多个数据输出到控制台，默认使用空格分隔、\n换行</td></tr><tr><td>input</td><td>input([prompt])</td><td>在控制台和用户交互，接收用户输入，并返回字符串</td></tr><tr><td>int</td><td>int(value)</td><td>将给定的值，转换成整数。int本质是类</td></tr><tr><td>str</td><td>str(value)</td><td>将给定的值，转换成字符串。str本质是类</td></tr><tr><td>type</td><td>type(value)</td><td>返回对象的类型。本质是元类</td></tr><tr><td>isinstance</td><td>isinstance(obj,class_or_tuple)</td><td>比较对象的类型，类型可以是obj的基类</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,sep=<span class="string">&#x27;\n&#x27;</span>, end=<span class="string">&#x27;***&#x27;</span>)</span><br><span class="line"><span class="built_in">type</span>(<span class="number">1</span>) <span class="comment"># 返回的是类型，不是字符串</span></span><br><span class="line"><span class="built_in">type</span>(<span class="string">&#x27;abc&#x27;</span>) <span class="comment"># 返回的是类型，不是字符串</span></span><br><span class="line"><span class="built_in">type</span>(<span class="built_in">int</span>) <span class="comment"># 返回type，意思是这个int类型由type构造出来</span></span><br><span class="line"><span class="built_in">type</span>(<span class="built_in">str</span>) <span class="comment"># 返回type，也是类型</span></span><br><span class="line"><span class="built_in">type</span>(<span class="built_in">type</span>) <span class="comment"># 也是type</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">1</span>, <span class="built_in">int</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="literal">False</span>, <span class="built_in">int</span>)) <span class="comment"># True</span></span><br></pre></td></tr></table></figure><h2 id="11-程序控制">11. 程序控制</h2><ul><li>顺序<ul><li>按照先后顺序一条条执行</li><li>例如，先洗手，再吃饭，再洗碗</li></ul></li><li>分支<ul><li>根据不同的情况判断，条件满足执行某条件下的语句</li><li>例如，先洗手，如果饭没有做好，玩游戏；如果饭做好了，就吃饭；如果饭都没有做，叫外卖</li></ul></li><li>循环<ul><li>条件满足就反复执行，不满足就不执行或不再执行</li><li>例如，先洗手，看饭好了没有，没有好，一会来看一次是否好了，一会儿来看一次，直到饭好了，才可是吃饭。这里循环的条件是饭没有好，饭没有好，就循环的来看饭好了没有</li></ul></li></ul><h3 id="11-1-单分支">11.1 单分支</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> condition:</span><br><span class="line">代码块</span><br><span class="line"><span class="keyword">if</span> <span class="number">1</span>&lt;<span class="number">2</span>: <span class="comment"># if True:</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;1 less than 2&#x27;</span>) <span class="comment"># 代码块</span></span><br></pre></td></tr></table></figure><ul><li>condition必须是一个bool类型，这个地方有一个隐式转换bool(condition)，相当于False等价</li><li>if 语句这行最后，会有一个冒号，冒号之后如果有多条语句的代码块，需要另起一行，并缩进<ul><li>if、for、def、class等关键字后面都可以跟代码块</li><li>这些关键后面，如果有一条语句，也可以跟在这一行后面。例如 if 1&gt;2: pass</li></ul></li></ul><h3 id="11-2-多分支">11.2 多分支</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> condition1:</span><br><span class="line">代码块<span class="number">1</span></span><br><span class="line"><span class="keyword">elif</span> condition2:</span><br><span class="line">代码块<span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> condition3:</span><br><span class="line">代码块<span class="number">3</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">代码块</span><br><span class="line"></span><br><span class="line">a = <span class="number">5</span></span><br><span class="line"><span class="keyword">if</span> a&lt;<span class="number">0</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;negative&#x27;</span>)</span><br><span class="line"><span class="keyword">elif</span> a==<span class="number">0</span>: <span class="comment"># 相当于 a &gt;= 0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;zero&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># 相当于 a &gt; 0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;positive&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>多分支结构，只要有一个分支被执行，其他分支都不会被执行</li><li>前一个条件被测试过，下一个条件相当于隐含着这个条件</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 嵌套</span></span><br><span class="line">a = <span class="number">5</span></span><br><span class="line"><span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;zero&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">if</span> a &gt; <span class="number">0</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;positive&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;negative&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="11-3-while循环">11.3 while循环</h3><p>while循环多用于死循环，或者不明确知道循环次数的场景</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> cond:</span><br><span class="line">    block</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>: <span class="comment"># 死循环</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    a = <span class="number">10</span></span><br><span class="line"><span class="keyword">while</span> a: <span class="comment"># 条件满足则进入循环</span></span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    a -= <span class="number">1</span></span><br></pre></td></tr></table></figure><ul><li>上例执行结果是什么？</li><li>为什么？</li><li>会不会打印出0？要注意边界的分析</li><li>如果a=-10可以吗？如何改？回忆一下，False等价是什么？</li></ul><h3 id="11-4-for语句">11.4 for语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> iteratable: <span class="comment"># 可迭代对象中有元素可以迭代，进入循环体</span></span><br><span class="line">    block</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><table><thead><tr><th>内建函数</th><th>函数签名</th><th>说明</th></tr></thead><tbody><tr><td>range</td><td>range(stop)</br>range(start, stop[,step])</td><td>返回惰性的对象</br>可以生成一个序列，遍历它就可以得到这个序列的一个个元素</br>前包后不包</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计数器</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---------&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---------&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><p>range(i)，i大于0，相当于计数器。</p><p>练习：</p><ul><li>打印1到10</li><li>打印10以内的奇数</li><li>打印10以内的偶数</li><li>倒着打印10以内的奇数或偶数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打印偶数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> :</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="comment"># 打印奇数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> != <span class="number">0</span> :</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 倒着打印</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>, -<span class="number">1</span> , -<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><h3 id="11-5-continue">11.5 continue</h3><p>跳过当前循环的当次循环，继续下一次循环</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> != <span class="number">0</span> : <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> != <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i &amp; <span class="number">1</span>: <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><h3 id="11-6-break">11.6 break</h3><p>结束当前循环<br>练习：计算1000以内的，从7开始，被7整除的前15个正整数（for循环）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算1000以内的被7整除的前15个正整数</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, <span class="number">1000</span>, <span class="number">7</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> count &gt;= <span class="number">15</span>:</span><br><span class="line">        <span class="built_in">print</span>(count)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>总结</p><ul><li>continue和break是循环的控制语句，只影响当前循环，包括while、for循环</li><li>如果循环嵌套， continue和break也只影响语句所在的那一层循环</li><li>continue和break 只影响循环，所以 if cond: break 不是跳出if，而是终止if外的break所在的循环</li><li>分支和循环结构可以嵌套使用，可以嵌套多层。</li></ul><h3 id="11-7-else子句">11.7 else子句</h3><p>如果循环正常结束，else子句会被执行，即使是可迭代对象没有什么元素可迭代</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>): <span class="comment"># 可迭代对象没有迭代</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure><p>有上例可知，一般情况下，循环正常执行，只要当前循环不是被break打断的，就可以执行else子句。哪怕是range(0)也可以执行else子句。</p><h3 id="11-8-三元表达式">11.8 三元表达式</h3><p>在Python中，也有类似C语言的三目运算符构成的表达式，但python中的三元表达式不支持复杂的语句</p><p>|  真值表达式 if 条件表达式 else 假值表达式</p><p>三元表达式比较适合简化非常简单的if-else语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断用户的输入的值，如果为空，输出&quot;empty&quot;，否则输出该值</span></span><br><span class="line">value = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> value:</span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;empty&#x27;</span>)</span><br><span class="line"></span><br><span class="line">value = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(value <span class="keyword">if</span> value <span class="keyword">else</span> <span class="string">&#x27;empty&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript基础语法</title>
      <link href="/20230402/JavaScript-20230325-JavaScript%E5%9F%BA%E7%A1%80/"/>
      <url>/20230402/JavaScript-20230325-JavaScript%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介">1. 简介</h2><h3 id="1-1-JavaScript是什么">1.1 JavaScript是什么</h3><p>JavaScript是一种运行在客户端（浏览器）的编程语言，实现人机交互效果。</p><h3 id="1-2-作用">1.2 作用</h3><ul><li>网页特效(监听用户的一些行为让网页作出对应的反馈)</li><li>表单验证(针对表单数据的合法性进行判断)</li><li>数据交互(获取后台的数据，渲染到前端)</li><li>服务端编程(node.js)</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-191759.png" alt=""></p><h3 id="1-3-JavaScript的组成">1.3 JavaScript的组成</h3><ol><li>ECMAScript</li></ol><ul><li>规定了js基础语法核心知识<br>比如：变量、分支语句、循环语句、对象等等</li></ul><ol start="2"><li>Web Apis</li></ol><ul><li>DOM 操作文档，比如对页面元素进行移动、大小、添加删除等操作</li><li>BOM 操作浏览器，比如页面弹窗，检测窗口宽度、存储数据到浏览器等等</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-192727.png" alt=""></p><div class="note primary no-icon flat"><p>JavaScript权威网站<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript</a></p></div><h2 id="2-JavaScript书写位置">2. JavaScript书写位置</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02193213.png" alt=""></p><h3 id="2-1-内部JavaScript">2.1 内部JavaScript</h3><p>直接写在html文件里，用script标签包住</p><p><font color=red size=2>规范</font>：script标签写在<code>&lt;/body&gt;</code>上面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&quot;嗨，欢迎来到前端世界&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note info no-icon flat"><p><strong>提示</strong></p><p>我们将 <code>&lt;script&gt;</code> 放在<font color=red size=2>HTML文件的底部</font>附近的原因是浏览器会按照代码在文件中的顺序加载 HTML。<br>如果先加载的 JavaScript 期望修改其下方的 HTML，那么它可能由于 HTML 尚未被加载而失效。<br>因此，将 JavaScript 代码放在 HTML页面的底部附近通常是最好的策略。</p></div><h3 id="2-2-外部JavaScript">2.2 外部JavaScript</h3><p>代码写在以.js结尾的文件里</p><p><font color=red size=2>语法</font>: 通过script标签，引入到html页面里</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过src引入外部js文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/my.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p><strong>警告</strong></p><p>script标签中间无需写代码，否则会被忽略！<br>外部JavaScript会使代码更加有序，更易于复用，且没有了脚本的混合，HTML 也会更加易读，因此这是个好的习惯。</p></div><h3 id="2-3-内联JavaScript">2.3 内联JavaScript</h3><p>代码写在标签内部</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;逗你玩~~~&#x27;)&quot;</span>&gt;</span>点击月薪过万<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-JavaScript注释">3. JavaScript注释</h2><ul><li>单行注释<br>符号：//<br>作用：// 右边这一行的代码会被忽略<br>快捷键：ctrl + /</li><li>块注释<br>符号：/* <em>/<br>作用：在 /</em> */ 之间的所有内容都会被忽略<br>快捷键：shift + alt + a</li></ul><h2 id="4-JavaScript结束符">4. JavaScript结束符</h2><p>作用： 使用英文的 ; 代表语句结束<br>实际情况： 实际开发中，可写可不写, 浏览器(JavaScript 引擎) 可以自动推断语句的结束位置<br>现状： 在实际开发中，越来越多的人主张，书写 JavaScript 代码时省略结束符<br><font color=red size=2>约定：为了风格统一，结束符要么每句都写，要么每句都不写（按照团队要求.）</font></p><h2 id="5-JavaScript输入输出语法">5. JavaScript输入输出语法</h2><p>输出和输入也可理解为人和计算机的交互，用户通过键盘、鼠标等向计算机输入信息，计算机处理后再展示结果给用户，这便是一次输入和输出的过程。</p><ul><li>输出语法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-195536.png" alt=""></li><li>输入语法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-195814.png" alt=""></li></ul><h2 id="6-变量">6. 变量</h2><p>白话：变量就是一个装东西的盒子。<br>通俗：变量是计算机中用来存储数据的“容器”，它可以让计算机变得有记忆。</p><h3 id="6-1-声明变量">6.1 声明变量</h3><p>声明变量有两部分构成：声明关键字、变量名（标识）<br>let 即关键字 (let: 允许、许可、让、要)，所谓关键字是系统提供的专门用来声明（定义）变量的词语</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> 变量名</span><br></pre></td></tr></table></figure><h3 id="6-2-变量赋值">6.2 变量赋值</h3><p>定义了一个变量后，你就能够初始化它（赋值）。在变量名之后跟上一个“=”，然后是数值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 声明一个age变量</span></span><br><span class="line"><span class="keyword">let</span> age</span><br><span class="line"><span class="comment">// 2. age变量赋值为 18</span></span><br><span class="line">age = <span class="number">18</span></span><br></pre></td></tr></table></figure><h3 id="6-3-变量命名规则与规范">6.3 变量命名规则与规范</h3><p>规则：必须遵守，不遵守报错 (法律层面)<br>规范：建议，不遵守不会报错，但不符合业内通识 （道德层面）</p><ol><li>规则：</li></ol><ul><li>不能用关键字<ul><li>关键字：有特殊含义的字符，JavaScript 内置的一些英语词汇。例如：let、var、if、for等</li></ul></li><li>只能用下划线、字母、数字、$组成，且数字不能开头</li><li>字母严格区分大小写，如 Age 和 age 是不同的变量</li></ul><ol start="2"><li>规范：</li></ol><ul><li>起名要有意义</li><li>遵守小驼峰命名法</li><li>第一个单词首字母小写，后面每个单词首字母大写。例：userName</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-201224.png" alt=""></p><h3 id="6-4-let和var的区别">6.4 let和var的区别</h3><p>在较旧的JavaScript，使用关键字 var 来声明变量 ，而不是 let。<br>var 现在开发中一般不再使用它，只是我们可能再老版程序中看到它。</p><p>let 为了解决 var 的一些问题。</p><p>var 声明:</p><ul><li>可以先使用 在声明 (不合理)</li><li>var 声明过的变量可以重复声明(不合理)</li><li>比如变量提升、全局变量、没有块级作用域等等</li></ul><p>var 就是个bug，别迷恋它了，以后声明变量我们统一使用 let</p><h2 id="7-数组">7. 数组</h2><p>数组 (Array) —— 一种将 一组数据存储在单个变量名下 的优雅方</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = []</span><br></pre></td></tr></table></figure><h3 id="7-1-声明语法">7.1 声明语法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> 数组名 = [数据<span class="number">1</span>, 数据<span class="number">2</span>, ...]</span><br></pre></td></tr></table></figure><ul><li>数组是按顺序保存，所以每个数据都有自己的编号</li><li>计算机中的编号从0开始，所以小明的编号为0，小刚编号为1，以此类推</li><li>在数组中，数据的编号也叫<font color=red size=2>索引或下标</font></li><li>数组可以存储任意类型的数据</li></ul><h3 id="7-2-数组的基本使用">7.2 数组的基本使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数组名[下标]</span><br></pre></td></tr></table></figure><ul><li>通过下标取数据</li><li>取出来是什么类型的，就根据这种类型特点来访问</li></ul><h3 id="7-3-一些术语">7.3 一些术语</h3><p>元素：数组中保存的每个数据都叫数组元素<br>下标：数组中数据的编号<br>长度：数组中数据的个数，通过数组的length属性获得</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> names = [<span class="string">&#x27;小米&#x27;</span>,<span class="string">&#x27;华为&#x27;</span>,<span class="string">&#x27;苹果&#x27;</span>]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(names[<span class="number">0</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(names.<span class="property">length</span>)</span><br></pre></td></tr></table></figure><h2 id="8-常量">8. 常量</h2><ul><li>概念：使用 const 声明的变量称为“常量”。</li><li>使用场景：当某个变量永远不会改变的时候，就可以使用 const 来声明，而不是let。</li><li>命名规范：和变量一致</li><li>常量使用：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明一个常量</span></span><br><span class="line"><span class="keyword">const</span> G = <span class="number">9.8</span></span><br><span class="line"><span class="comment">// 修改常量值</span></span><br><span class="line">G = <span class="number">8.8</span></span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p><strong>警告</strong></p><p>常量不允许重新赋值,声明的时候必须赋值（初始化）</p></div><h2 id="9-数据类型">9. 数据类型</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-02-203317.png" alt=""></p><h3 id="9-1-数字类型-Number">9.1 数字类型(Number)</h3><p>JavaScript 中的正数、负数、小数等 统一称为 数字类型。</p><p>数字可以有很多操作，比如，乘法 * 、除法 / 、加法 + 、减法 - 等等，所以经常和算术运算符一起。<br>数学运算符也叫<strong>算术运算符</strong>，主要包括加、减、乘、除、取余（求模）。</p><ul><li>+：求和</li><li>-：求差</li><li>*：求积</li><li>/：求商</li><li>%：取模（取余数）<ul><li>开发中经常作为某个数字是否被整除</li></ul></li></ul><p>JavaScript中 优先级越高越先被执行，<font color=red size=2>优先级相同时以书从左向右执行</font>。</p><ul><li>乘、除、取余优先级相同</li><li>加、减优先级相同</li><li>乘、除、取余优先级大于加、减</li><li>使用 () 可以提升优先级</li><li>总结： 先乘除后加减，有括号先算括号里面的~~~</li></ul><h3 id="9-2-字符串类型-string">9.2 字符串类型(string)</h3><p>通过单引号（ ‘’） 、双引号（ “”）或反引号( ` ) 包裹的数据都叫字符串，单引号和双引号没有本质上的区别，推荐使用单引号</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uname = <span class="string">&#x27;小明&#x27;</span></span><br><span class="line"><span class="keyword">let</span> gender = <span class="string">&quot;男&quot;</span></span><br></pre></td></tr></table></figure><p><strong>注意事项</strong>：</p><ol><li>无论单引号或是双引号必须成对使用</li><li>单引号/双引号可以互相嵌套，但是不以自已嵌套自已（口诀：外双内单，或者外单内双）</li><li>必要时可以使用转义符 \，输出单引号或双引号</li></ol><h4 id="9-2-1-字符串拼接">9.2.1 字符串拼接</h4><p><code>+</code>运算符可以实现字符串拼接</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;我叫&#x27;</span> + <span class="string">&#x27;六碟话&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="9-2-2-模板字符串">9.2.2 模板字符串</h4><ul><li>`` (反引号)</li><li>在英文输入模式下按键盘的tab键上方那个键（1左边那个键）</li><li>内容拼接变量时，用 ${ } 包住变量</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="string">&#x27;张三&#x27;</span></span><br><span class="line"><span class="keyword">let</span> age = <span class="string">&#x27;30&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">`大家好，我叫<span class="subst">$&#123;name&#125;</span>, 今年<span class="subst">$&#123;age&#125;</span>岁`</span>)</span><br></pre></td></tr></table></figure><h3 id="9-3-布尔类型-boolean">9.3 布尔类型(boolean)</h3><p>表示肯定或否定时在计算机中对应的是布尔类型数据。<br>它有两个固定的值 true 和 false，表示肯定的数据用 true（真），表示否定的数据用 false（假）。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> isCool =<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(isCool)</span><br></pre></td></tr></table></figure><h3 id="9-4-未定义类型-undefined">9.4 未定义类型(undefined)</h3><p>未定义是比较特殊的类型，只有一个值 undefined</p><p><strong>什么情况出现未定义类型？</strong><br>只声明变量，不赋值的情况下，变量的默认值为 undefined，一般很少【直接】为某个变量赋值为 undefined</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> age <span class="comment">// 声明变量但是未赋值</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(age) <span class="comment">// 输出 undefined</span></span><br></pre></td></tr></table></figure><p><strong>工作中的使用场景</strong>：<br>我们开发中经常声明一个变量，等待传送过来的数据。<br>如果我们不知道这个数据是否传递过来，此时我们可以通过检测这个变量是不是undefined，就判断用户是否有数据传递过来</p><h3 id="9-5-数据类型-–-null（空类型）">9.5 数据类型 – null（空类型）</h3><p>JavaScript 中的 null 仅仅是一个代表“无”、“空”或“值未知”的特殊值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj) <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p><strong>null 和 undefined 区别</strong>：</p><ul><li>undefined 表示没有赋值</li><li>null 表示赋值了，但是内容为空</li></ul><p><strong>null 开发中的使用场景</strong>：<br>官方解释：把 null 作为尚未创建的对象<br>大白话： 将来有个变量里面存放的是一个对象，但是对象还没创建好，可以先给个null</p><h2 id="10-数据类型检测">10. 数据类型检测</h2><p>typeof 运算符可以返回被检测的数据类型。它支持两种语法形式：</p><ol><li>作为运算符： typeof x （常用的写法）</li><li>函数形式： typeof(x)</li></ol><p>换言之，有括号和没有括号，得到的结果是一样的，所以我们直接使用运算符的写法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> age = <span class="number">19</span></span><br><span class="line"><span class="keyword">let</span> uname = <span class="string">&#x27;刘德华&#x27;</span></span><br><span class="line"><span class="keyword">let</span> buy</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> age)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> uname)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> buy)</span><br></pre></td></tr></table></figure><h2 id="11-类型转换">11. 类型转换</h2><p>JavaScript是弱数据类型： JavaScript也不知道变量到底属于那种数据类型，只有赋值了才清楚。</p><p>坑： 使用表单、prompt 获取过来的数据默认是字符串类型的，此时就不能直接简单的进行加法运算</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;200&#x27;</span> + <span class="string">&#x27;200&#x27;</span>)  <span class="comment">// 输出结果200200</span></span><br></pre></td></tr></table></figure><p>此时需要转换变量的数据类型。<br>通俗来说，就是<font color=red size=2>把一种数据类型的变量转换成我们需要的数据类型</font></p><h3 id="11-1-隐士转换">11.1 隐士转换</h3><p>某些运算符被执行时，系统内部自动将数据类型进行转换，这种转换称为隐式转换。</p><p><strong>规则</strong>：</p><ul><li><code>+</code> 号两边只要有一个是字符串，都会把另外一个转成字符串</li><li>除了+以外的算术运算符 比如 <code>-</code> <code>*</code> <code>/</code> 等都会把数据转成数字类型</li></ul><p>缺点：</p><ul><li>转换类型不明确，靠经验才能总结</li></ul><p><strong>小技巧</strong>：</p><ul><li><code>+</code>号作为正号解析可以转换成数字型</li><li>任何数据和字符串相加结果都是字符串</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-04-03-001054.png" alt=""></p><h3 id="11-2-显示转换">11.2 显示转换</h3><p>编写程序时过度依靠系统内部的隐式转换是不严禁的，因为隐式转换规律并不清晰，大多是靠经验总结的规律。<br>为了避免因隐式转换带来的问题，通常根逻辑需要对数据进行显示转换。</p><h4 id="11-2-1-转换为数字型">11.2.1 转换为数字型</h4><ul><li>Number(数据)<ul><li>转成数字类型</li><li>如果字符串内容里有非数字，转换失败时结果为 NaN（Not a Number）即不是一个数字</li><li>NaN也是number类型的数据，代表非数字</li></ul></li><li>parseInt(数据)<ul><li>只保留整数</li></ul></li><li>parseFloat(数据)<ul><li>可以保留小数</li></ul></li></ul><h4 id="11-2-2-转换成字符型">11.2.2 转换成字符型</h4><p>String(数据)</p><ul><li>变量.toString(进制)</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vuex</title>
      <link href="/20230329/vue-20230329-vuex/"/>
      <url>/20230329/vue-20230329-vuex/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Vuex概述">1. Vuex概述</h2><h3 id="1-1-官方解释">1.1 官方解释</h3><p><code>Vuex</code> 是一个专为 <code>Vue.js</code> 应用程序开发的状态管理模式</p><ul><li>它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化<ul><li><code>Vuex</code> 也集成到 <code>Vue</code> 的官方调试工具 <code>devtools extension</code>，提供了诸如零配置的<code>time-travel</code>调试，状态快照导入导出等高级调试功能。</li></ul></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20200714140121359.png" alt=""></p><h3 id="1-2-大白话">1.2 大白话</h3><p>状态管理模式、集中式<font color=red size=2>存储管理</font>这些名词听起来就非常高大上，让人捉摸不透。<br>其实，可以简单的将其看成把需要多个组件共享的变量全部存储在一个对象里面。<br>然后，将这个对象放在顶层的<code>Vue</code>实例中，让其他组件可以使用。<br>那么，多个组件是不是就可以共享这个对象中的所有变量属性了呢？<br>如果是这样的话，为什么官方还要专门出一个插件<code>Vuex</code>呢？难道我们不能自己封装一个对象来管理吗？<br>当然可以，只是我们要先想想<code>VueJS</code>带给我们最大的便利是什么呢？没错，就是<font color=red size=2>响应式</font>。<br>如果你自己封装实现一个对象能不能保证它里面所有的属性做到响应式呢？当然也可以，只是自己封装可能稍微麻烦一些。<br>不用怀疑，<code>Vuex</code>就是为了提供这样一个在多个组件间共享状态的插件，用它就可以了。</p><h3 id="1-3-组件间共享数据的方式">1.3 组件间共享数据的方式</h3><ul><li>父向子传值：<code>v-bind</code>属性绑定</li><li>子向父传值：<code>v-on</code>事件绑定</li><li>兄弟组件之间共享数据：EventBus<ul><li><code>$on</code> 接收数据的组件</li><li><code>$emit</code> 发送数据的组件</li></ul></li></ul><p>上述只适合小范围内数据共享，如果是复杂应用的话，就不再合适了。</p><h3 id="1-4-再看Vuex是什么">1.4 再看Vuex是什么</h3><p><code>Vuex</code>是实现组件全局状态(数据)管理的一种机制，可以方便的实现组件之间数据的共享</p><p>如图：<br>在不使用<code>Vuex</code>进行状态管理时，如果要从最下面的紫色组件传递数据的话，还是比较繁琐，也不便于维护。<br>在使用<code>Vuex</code>进行状态管理时，只需要一个共享<code>Store</code>组件，紫色组件将数据写入<code>Store</code>中，其他使用的组件直接从<code>Store</code>中读取即可。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./20200710133446491.png" alt=""></p><h3 id="1-5-使用Vuex统一管理好处">1.5 使用Vuex统一管理好处</h3><ul><li>能够在Vuex中集中管理共享的数据，易于开发和后期维护</li><li>能够高效地实现组件之间的数据共享，提高开发效率</li><li>存储在Vuex中的数据都是响应式的，能够实时保持数据与页面的同步</li></ul><h2 id="2-状态管理">2. 状态管理</h2><h3 id="2-1-单页面状态管理">2.1 单页面状态管理</h3><p>我们知道，要在单个组件中进行状态管理是一件非常简单的事情，如图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./202007141405425.png" alt=""></p><ul><li>State：指的就是我们的状态，可以暂时理解为组件中<code>data</code>中的属性</li><li>View：视图层，可以针对<code>State</code>的变化， 显示不同的信息</li><li>Actions：这里的<code>Actions</code>主要是用户的各种操作，如点击、输入等，会导致状态发生变化</li></ul><p>简单加减法案例，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>当前计数为：&#123;&#123;counter&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;counter+=1&quot;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;counter-=1&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&quot;HelloWorld&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">counter</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在这个案例中，有没有状态需要管理呢？肯定是有的，就是个数<code>counter</code></li><li><code>counter</code>需要某种方式被记录下来，也就是上述中的的<code>State</code>部分</li><li><code>counter</code>的值需要被显示在界面上，这个就是上述中的<code>View</code>部分</li><li>界面发生某些操作(比如此时的+1、-1)，需要去更新状态，这就是上述中的<code>Actions</code>部分</li></ul><p>这就是一个最基本的单页面状态管理。</p><h3 id="2-2-多页面状态管理">2.2 多页面状态管理</h3><p><code>Vue</code>已经帮我们做好了单个界面的状态管理，但是如果是多个界面呢，比如</p><ul><li>多个视图<code>View</code>都依赖同一个状态（一个状态改了，多个界面需要进行更新）</li><li>不同界面的<code>Actions</code>都想修改同一个状态</li></ul><p>也就是说对于某些状态(状态1/状态2/状态3)来说只属于我们某一个视图，但是也有一些状态(状态a/状态b/状态c)属于多个试图共同想要维护的，那怎么办呢？</p><ul><li>状态1/状态2/状态3你放在自己的组件中，自己管理自己用，没问题</li><li>但是状态a/状态b/状态c我们希望交给一个大管家来统一帮助我们管理</li></ul><p>没错，<code>Vuex</code>就是为我们提供这个大管家的工具。</p><h3 id="2-3-全局单例模式">2.3 全局单例模式</h3><p>我们现在要做的就是将共享的状态抽出来，交给我们的大管家，统一进行管理，每个视图按照规定，进行访问和修改操作。</p><p>这就是<code>Vuex</code>的基本思想</p><h3 id="2-4-管理哪些状态">2.4 管理哪些状态</h3><p>如果你做过大型开发，你一定遇到过多个状态，在多个界面间的共享问题。</p><ul><li>比如用户的登录状态、用户名称、头像、地理位置信息等</li><li>比如商品的收藏、购物车中的物品等</li></ul><p>这些状态信息，我们都可以放在统一放在<code>Vuex</code>中，对它进行保存和管理，而且它们还是响应式的。</p><blockquote><p>一般情况下，只有组件之间共享的数据，才有必要存储到Vuex中。<br>对于组件中的私有数据，依旧存储在组件自身的data中即可。</p></blockquote><h2 id="3-Vuex的基本使用">3. Vuex的基本使用</h2><h3 id="3-1-安装-2">3.1 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vuex@<span class="string">&#x27;3.2.0&#x27;</span> --save</span><br></pre></td></tr></table></figure><h3 id="3-2-导入">3.2 导入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import Vuex from <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line">Vue.use(Vuex)</span><br></pre></td></tr></table></figure><h3 id="3-3-创建store对象">3.3 创建store对象</h3><p>在src目录创建store目录然后创建index.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure><h3 id="3-4-挂载store对象">3.4 挂载store对象</h3><p>将创建的共享数据对象<code>store</code>挂载到<code>Vue</code>实例中，所有的组件，就可以直接从<code>store</code>中获取全局的数据了<br>main.js中挂载<code>store</code>对象</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"><span class="comment">// 1. 导入存储</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">productionTip</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>),</span><br><span class="line">  <span class="attr">router</span>: router,</span><br><span class="line">  <span class="comment">// 2. 挂载路由模块</span></span><br><span class="line">  <span class="attr">store</span>: store</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="4-Vuex的核心概念">4. Vuex的核心概念</h2><h3 id="4-1-State">4.1 State</h3><h4 id="4-1-1-概念">4.1.1 概念</h4><p><code>State</code>是提供唯一的公共数据源，所有共享的数据都要统一放到<code>Store</code>的<code>State</code>中进行存储</p><p>如果状态信息是保存到多个<code>Store</code>对象中的，那么之后的管理和维护等都会变得特别困难，所以<code>Vuex</code>也使用了单一状态树(单一数据源<code>Single Source of Truth</code>)来管理应用层级的全部状态。</p><p>单一状态树能够让我们最直接的方式找到某个状态的片段，而且在之后的维护和调试过程中，也可以非常方便的管理和维护。</p><h4 id="4-1-2-State数据访问方式一">4.1.2 State数据访问方式一</h4><p>通过<code>this.$store.state.全局数据名称</code>访问</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123; this.$store.state.count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-1-3-State数据访问方式二">4.1.3 State数据访问方式二</h4><p>从<code>vuex</code>中按需导入<code>mapState</code>函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapState &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br></pre></td></tr></table></figure><p>通过刚才导入的<code>mapState</code>函数，将当前组件需要的全局数据，映射为当前组件的<code>computed</code>计算属性</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; mapState &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">computed</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    ...<span class="title function_">mapState</span>([<span class="string">&quot;count&quot;</span>])</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h3 id="4-2-Mutation">4.2 Mutation</h3><h4 id="4-2-1-引入">4.2.1 引入</h4><p>如果想修改<code>count</code>的值，要怎么做呢？</p><p>也许聪明的你，已经想到，直接在组件中对<code>this.$store.state.count</code>进行操作即可，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123;this.$store.state.count&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;add&quot;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">state</span>.<span class="property">count</span>++;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试发现，这可以实现需求，完成<font color=red size=2>+1</font>操作。</p><p>但是，这种方法在<code>vuex</code>中是严格禁止的，那要怎么做呢？这时，就需要使用<code>Mutation</code>了。</p><h4 id="4-2-2-概念">4.2.2 概念</h4><p><code>Mutation</code>用于变更存储在<code>Store</code>中的数据。</p><ul><li>只能通过<code>mutation</code>变更<code>Store</code>数据，不可以直接操作<code>Store</code>中的数据</li><li>通过这种方式，虽然操作稍微繁琐一些，但可以集中监控所有数据的变化，二直接操作<code>Store</code>数据是无法进行监控的</li></ul><h4 id="4-2-3-定义Mutation函数">4.2.3 定义Mutation函数</h4><p>在<code>mutations</code>中定义函数，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        <span class="title function_">add</span>(<span class="params">state</span>) &#123;</span><br><span class="line">            state.<span class="property">count</span>++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>定义的函数会有一个默认参数<code>state</code>，这个就是存储在<code>Store</code>中的<code>state</code>对象。</p></div><h4 id="4-2-4-调用Mutation函数">4.2.4 调用Mutation函数</h4><p>Mutation中不可以执行异步操作，如需异步，请在Action中处理</p><h5 id="4-2-4-1-方式一">4.2.4.1 方式一</h5><p>在组件中，通过<code>this.$store.commit(方法名)</code>完成触发，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-2-4-2-方式二">4.2.4.2 方式二</h5><p>在组件中导入mapMutations函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapMutations &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br></pre></td></tr></table></figure><p>通过刚才导入的<code>mapMutations</code>函数，将需要的<code>mutations</code>函数映射为当前组件的<code>methods</code>方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; mapMutations &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;AboutPage&#x27;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    ...<span class="title function_">mapMutations</span>([<span class="string">&#x27;add&#x27;</span>]),</span><br><span class="line">    <span class="title function_">addCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">add</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="4-3-Mutation传递参数">4.3 Mutation传递参数</h3><p>在通过<code>mutation</code>更新数据的时候，有时候需携带一些额外的参数，此处，参数被成为<code>mutation</code>的载荷<code>Payload</code></p><p>如果仅有一个参数时，那payload对应的就是这个参数值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        <span class="title function_">add</span>(<span class="params">state, n</span>) &#123;</span><br><span class="line">            state.<span class="property">count</span> += n</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// +++++++++++++++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">&quot;add&quot;</span>,<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果是多参数的话，那就会以对象的形式传递，此时的payload是一个对象，可以从对象中取出相关的数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        <span class="title function_">add</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在组件中，调用如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>: &#123;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">&quot;add&quot;</span>,&#123;<span class="attr">number</span>:<span class="number">10</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-Mutation响应规则">4.4 Mutation响应规则</h3><p><code>Vuex</code>的<code>store</code>中的<code>State</code>是响应式的，当<code>State</code>中的数据发生改变时，<code>Vue</code>组件也会自动更新。</p><p>这就要求我们必须遵守一些<code>Vuex</code>对应的规则：</p><ul><li>提前在<code>store</code>中初始化好所需的属性</li><li>当给<code>State</code>中的对象添加新属性时，使用如下方式：<ul><li>使用<code>Vue.set(obj,'newProp','propValue')</code></li><li>用新对象给旧对象重新赋值</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        <span class="title function_">add</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateUser</span>(<span class="params">state</span>) &#123;</span><br><span class="line">            state.<span class="property">user</span> = &#123;</span><br><span class="line">                ...state.<span class="property">user</span>,</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;上海市&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="4-5-Mutation常量类型">4.5 Mutation常量类型</h3><p>思考一个问题：</p><p>在<code>mutation</code>中, 我们定义了很多事件类型(也就是其中的方法名称)，当项目越来越大时，<code>Vuex</code>管理的状态越来越多，需要更新状态的情况也越来越多，也就意味着<code>Mutation</code>中的方法越来越多。</p><p>当方法过多，使用者需要花费大量时间精力去记住这些方法，甚至多个文件间来回切换，查看方法名称，也存在拷贝或拼写错误的情况。</p><p>那么该如何避免呢？</p><ul><li>在各种Flux实现中，一种很常见的方案就是使用常量替代<code>Mutation</code>事件的类型</li><li>可以将这些常量放在一个单独的文件中，方便管理，整个<code>App</code>所有的事件类型一目了然</li></ul><h4 id="4-5-1-解决方案">4.5.1 解决方案</h4><ul><li>创建<code>mutation-types.js</code>文件，在其中定义常量</li><li>定义常量时, 可以使用<code>ES2015</code>中的风格, 使用一个常量来作为函数的名称</li><li>使用处引入文件即可</li></ul><p>新建mutation-types.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="string">&#x27;add&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> updateUser = <span class="string">&#x27;updateUser&#x27;</span></span><br></pre></td></tr></table></figure><p>在store/index.js中引入并使用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&#x27;./mutation-types&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        [types.<span class="property">add</span>](state, payload) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;,</span><br><span class="line">        [types.<span class="property">updateUser</span>](state) &#123;</span><br><span class="line">            state.<span class="property">user</span> = &#123;</span><br><span class="line">                ...state.<span class="property">user</span>,</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;上海市&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure><p>在组件中，引入并调用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;add&quot;</span>&gt;</span>store加一<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;addUser&quot;</span>&gt;</span>user添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>user: &#123;&#123; this.$store.state.user &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &lt;/template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123;add, updateUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/mutation-types&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">props</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(add,&#123;<span class="attr">number</span>:<span class="number">10</span>&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">addUser</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(updateUser)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="4-6-Action">4.6 Action</h3><p><code>Action</code>类似于<code>Mutation</code>，但是是用于处理异步任务的，比如网络请求等</p><p>如果通过异步操作变更数据，必须通过<code>Action</code>，而不能使用<code>Mutation</code>，但在<code>Action</code>中还是要通过触发<code>Mutation</code>的方式间接变更数据。</p><h4 id="4-6-1-参数context">4.6.1  参数context</h4><p>在<code>actions</code>中定义的方法，都会有默认值<code>context</code>。</p><ul><li><code>context</code>是和<code>store</code>对象具有相同方法和属性的对象</li><li>可以通过<code>context</code>进行<code>commit</code>相关操作，可以获取<code>context.state</code>数据</li></ul><p>但他们并不是同一个对象，在<code>Modules</code>中会介绍到区别。</p><h4 id="4-6-2-使用方法一">4.6.2 使用方法一</h4><p>在<code>index.js</code>中，添加<code>actions</code>及对应的方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="comment">// 自增</span></span><br><span class="line">        [types.<span class="property">addNum</span>](state) &#123;</span><br><span class="line">            state.<span class="property">count</span> += <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        [types.<span class="property">add</span>](state, payload) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;,</span><br><span class="line">        [types.<span class="property">updateUser</span>](state) &#123;</span><br><span class="line">            state.<span class="property">user</span> = &#123;</span><br><span class="line">                ...state.<span class="property">user</span>,</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;上海市&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">addAsync</span>(<span class="params">context</span>) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                context.<span class="title function_">commit</span>(types.<span class="property">addNum</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>组件中调用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;addNumAsync&quot;</span>&gt;</span>store异步加一<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  </span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123;add, updateUser, addAsync &#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/mutation-types&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">props</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">addNumAsync</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="comment">// dispatch用于触发Actions中的方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(addAsync)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="4-6-3-使用方法二">4.6.3 使用方法二</h4><p>在组件中，导入<code>mapActions</code>函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapActions &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br></pre></td></tr></table></figure><p>通过刚才导入的mapActions函数，将需要的actions函数映射为当前组件的methods方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; mapActions &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    ...<span class="title function_">mapActions</span>([<span class="string">&quot;addAsync&quot;</span>]),</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;Î</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addAsync</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-6-4-Actions携带参数">4.6.4 Actions携带参数</h4><p>在index.js的actions中，增加携带参数方法，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        [types.<span class="property">add</span>](state, payload) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">addAsync</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">                context.<span class="title function_">commit</span>(types.<span class="property">add</span>, payload)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在组件中，调用如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;addAsync&quot;</span>&gt;</span>store异步加参数<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前最新Count值为：&#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  </span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">props</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">addAsync</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;addAsync&#x27;</span>, &#123;<span class="attr">number</span>:<span class="number">555</span>&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="4-6-5-Actions与Promise结合">4.6.5 Actions与Promise结合</h4><p><code>Promise</code>经常用于异步操作，在Action中，可以将异步操作放在<code>Promise</code>中，并且在成功或失败后，调用对应的<code>resolve</code>或<code>reject</code>。</p><p>在store/index.js中，为actions添加异步方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        [types.<span class="property">add</span>](state, payload) &#123;</span><br><span class="line">            state.<span class="property">count</span> += payload.<span class="property">number</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">loadUserInfo</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                    context.<span class="title function_">commit</span>(types.<span class="property">add</span>, payload)</span><br><span class="line">                    <span class="title function_">resolve</span>()</span><br><span class="line">                &#125;,<span class="number">2000</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在组件中调用，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addPromise</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;loadUserInfo&#x27;</span>, &#123;<span class="attr">number</span>: <span class="number">10</span>&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-7-Getter">4.7 Getter</h3><ul><li><code>Getters</code>用于对<code>Store</code>中的数据进行加工处理形成新的数据，类似于<code>Vue</code>中的计算属性</li><li><code>Store</code>中数据发生变化，<code>Getters</code>的数据也会跟随变化</li></ul><h4 id="4-7-1-使用方式一">4.7.1 使用方式一</h4><p>在index.js中定义getters</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="comment">// state中存放的就是全局共享数据</span></span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">111</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">        <span class="title function_">showNum</span>(<span class="params">state</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;当前Count值为: &quot;</span> + state.<span class="property">count</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在组件中使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;&#123;&#123; <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">getters</span>.<span class="property">showNum</span> &#125;&#125;&lt;/h2&gt;</span><br></pre></td></tr></table></figure><h4 id="4-7-2-使用方式二">4.7.2 使用方式二</h4><p>在组件中，导入<code>mapGetters</code>函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br></pre></td></tr></table></figure><p>通过刚才导入的<code>mapGetters</code>函数，将需要的<code>getters</code>函数映射为当前组件的<code>computed</code>方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">computed</span>: &#123;</span><br><span class="line">  ...<span class="title function_">mapGetters</span>([<span class="string">&quot;showNum&quot;</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用时，直接调用即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; showNum &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-8-Modules">4.8 Modules</h3><h4 id="4-8-1-概念">4.8.1 概念</h4><p><code>Module</code>是模块的意思，为什么会在<code>Vuex</code>中使用模块呢？</p><ul><li><code>Vues</code>使用单一状态树，意味着很多状态都会交给<code>Vuex</code>来管理</li><li>当应用变的非常复杂时，<code>Store</code>对象就可能变的相当臃肿</li><li>为解决这个问题，<code>Vuex</code>允许我们将<code>store</code>分割成模块(Module)，并且每个模块拥有自己的<code>State</code>、<code>Mutation</code>、<code>Actions</code>、<code>Getters</code>等</li></ul><h4 id="4-8-2-使用">4.8.2 使用</h4><p>在<code>store</code>目录下，新建文件夹<code>modules</code>，用于存放各个模块的<code>modules</code>文件，此处以moduleA为例。</p><p>在<code>modules</code>文件夹中，新建<code>moduleA.js</code>，内部各属性<code>state</code>、<code>mutations</code>等都和之前一致，注释详见代码，示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;凤凰于飞&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">aUpdateName</span>(<span class="params">context</span>) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                context.<span class="title function_">commit</span>(<span class="string">&#x27;updateName&#x27;</span>, <span class="string">&#x27;旺财&#x27;</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">updateName</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">            state.<span class="property">name</span> = payload</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">        <span class="title function_">fullName</span>(<span class="params">state</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state.<span class="property">name</span> + <span class="string">&#x27;王昭君&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">fullName2</span>(<span class="params">state, getters</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过getters调用本组方法</span></span><br><span class="line">            <span class="keyword">return</span> getters.<span class="property">fullName</span> + <span class="string">&#x27; 礼拜&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">fullName3</span>(<span class="params">state, getters, rootState</span>) &#123;</span><br><span class="line">            <span class="comment">// state代表当前module数据状态，rootState代表根节点数据状态</span></span><br><span class="line">            <span class="keyword">return</span> getters.<span class="property">fullName2</span> + rootState.<span class="property">counter</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在store/index.js中引用moduleA，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> moduleA <span class="keyword">from</span> <span class="string">&#x27;./modules/moduleA&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: moduleA</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样就通过分模块完成了对状态管理的模块化拆分。</p><h3 id="4-9-优化">4.9 优化</h3><p>如果项目非常复杂，除了分模块划分外，还可以将主模块的<code>actions</code>、<code>mutations</code>、<code>getters</code>等分别独立出去，拆分成单独的js文件，分别通过<code>export</code>导出，然后再index.js中导入使用。</p><p>示例：<br>分别将主模块的<code>actions</code>、<code>mutations</code>、<code>getters</code>独立成js文件并导出，以actions.js为例，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">    <span class="title function_">aUpdateInfo</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                context.<span class="title function_">commit</span>(<span class="string">&#x27;updateInfo&#x27;</span>)</span><br><span class="line">                <span class="title function_">resolve</span>()</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在store/index.js中，引入并使用，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span></span><br><span class="line"><span class="keyword">import</span> mutations <span class="keyword">from</span> <span class="string">&#x27;./mutations&#x27;</span></span><br><span class="line"><span class="keyword">import</span> actions <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&#x27;./getters&#x27;</span></span><br><span class="line"><span class="keyword">import</span> moduleA <span class="keyword">from</span> <span class="string">&#x27;./modules/moduleA&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">    <span class="attr">counter</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">students</span>: [</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&#x27;旺财&#x27;</span>, <span class="attr">age</span>: <span class="number">12</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&#x27;小强&#x27;</span>, <span class="attr">age</span>: <span class="number">31</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">&#x27;大明&#x27;</span>, <span class="attr">age</span>: <span class="number">45</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">&#x27;狗蛋&#x27;</span>, <span class="attr">age</span>: <span class="number">78</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">info</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;keko&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    getters,</span><br><span class="line">    actions,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: moduleA</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue-router</title>
      <link href="/20230328/vue-20230328-vue-router/"/>
      <url>/20230328/vue-20230328-vue-router/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前端路由的概念">1. 前端路由的概念</h2><h3 id="1-1-什么是路由">1.1 什么是路由</h3><p>路由（英文：router）就是<font color=red size=2>对应关系</font>。</p><h3 id="1-2-SPA与前端路由">1.2 SPA与前端路由</h3><p>SPA 指的是一个 web 网站只有唯一的一个 HTML 页面，<font color=red size=2>所有组件的展示与切换</font>都在这唯一的一个页面内完成。<br>此时，<font color=red size=2>不同组件之间的切换</font>需要通过<font color=red size=2>前端路由</font>来实现。</p><p>结论：在 SPA 项目中，<font color=red size=2>不同功能之间的切换</font>，要<font color=red size=2>依赖于前端路由</font>来完成！</p><h3 id="1-3-什么是前端路由">1.3 什么是前端路由</h3><p>通俗易懂的概念：<font color=red size=2>Hash 地址</font>与<font color=red size=2>组件</font>之间的对应关系</p><h3 id="1-4-前端路由的工作方式">1.4 前端路由的工作方式</h3><p>① 用户<font color=red size=2>点击了</font>页面上的<font color=red size=2>路由链接</font><br>② 导致了 <font color=red size=2>URL 地址栏</font>中的 <font color=red size=2>Hash 值</font>发生了变化<br>③ <font color=red size=2>前端路由监听了到 Hash 地址的变化</font><br>④ 前端路由把当前 <font color=red size=2>Hash 地址对应的组件</font>渲染到浏览器中</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-28-173047.png" alt=""></p><blockquote><p>结论：前端路由，指的是 <font color=red size=2>Hash 地址</font>与<font color=red size=2>组件之间</font>的<font color=red size=2>对应关系</font>！</p></blockquote><h2 id="2-vue-router">2. vue-router</h2><p><code>vue-router</code> 是 vue.js 官方给出的<font color=red size=2>路由解决方案</font>。它只能结合 vue 项目进行使用，能够轻松的管理 SPA 项目中组件的切换。</p><p>vue-router 的官方文档地址：<a href="https://router.vuejs.org/zh/">https://router.vuejs.org/zh/</a></p><h3 id="2-1-vue-router安装和配置">2.1 vue-router安装和配置</h3><p>① 安装 vue-router 包<br>② 创建路由模块<br>③ 导入并挂载路由模块<br>④ 声明路由链接和占位符</p><h4 id="2-1-1-在项目中安装vue-router">2.1.1 在项目中安装vue-router</h4><p>在 vue2 的项目中，安装 vue-router 的命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue-router@3.5.2 -S</span><br></pre></td></tr></table></figure><h4 id="2-1-2-创建路由模块">2.1.2 创建路由模块</h4><p>在 <code>src</code> 源代码目录下，新建 <code>router/index.js</code> 路由模块，并初始化如下的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 导入 Vue 和 VueRouter 的包</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 调用 Vue.use() 函数,把VueRouter 安装为 Vue 的插件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建路由的实例对象</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 向外共享路由的实例对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure><h4 id="2-1-3-导入并挂载路由模块">2.1.3 导入并挂载路由模块</h4><p>在 src/main.js 入口文件中，导入并挂载路由模块。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="comment">// 1. 导入路由模块</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">productionTip</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>),</span><br><span class="line">  <span class="comment">// 2. 挂载路由模块</span></span><br><span class="line">  <span class="attr">router</span>: router</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-1-4-声明路由链接和占位符">2.1.4 声明路由链接和占位符</h4><p>在 src/App.vue 组件中，使用 vue-router 提供的 <code>&lt;router-link&gt;</code> 和 <code>&lt;router-view&gt;</code> 声明路由链接和占位符：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>App 组件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义路由链接 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/home&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/movie&quot;</span>&gt;</span>电影<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2. 定义路由的占位符 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-1-5-声明路由的匹配规则">2.1.5 声明路由的匹配规则</h4><p>在 src/router/index.js 路由模块中，通过 <font color=red size=2>routes 数组</font>声明路由的匹配规则。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 导入 Vue 和 VueRouter 的包</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="comment">// 5. 导入需要使用路由切换展示的组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/Home.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Movie</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/Movie.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">About</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/About.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 调用 Vue.use() 函数,把VueRouter 安装为 Vue 的插件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建路由的实例对象</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">    <span class="attr">routes</span>: [ <span class="comment">// 在routers数组中，声明路由的匹配规则</span></span><br><span class="line">        <span class="comment">// path 表示要匹配的 hash 地址：component 表示要展示的路由组件</span></span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Home</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/movie&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Movie</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>, <span class="attr">component</span>: <span class="title class_">About</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 向外共享路由的实例对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-vue-router的常见用法">3. vue-router的常见用法</h2><h3 id="3-1-路由重定向">3.1 路由重定向</h3><p><font color=red size=2>路由重定向</font>指的是：用户在访问<font color=red size=2>地址 A</font> 的时候，<font color=red size=2>强制用户跳转</font>到地址 C ，从而展示特定的组件页面。<br>通过路由规则的 <code>redirect</code> 属性，指定一个新的路由地址，可以很方便地设置路由的重定向：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">    <span class="attr">routes</span>: [ <span class="comment">// 在routers数组中，声明路由的匹配规则</span></span><br><span class="line">        <span class="comment">// path 表示要匹配的 hash 地址：component 表示要展示的路由组件</span></span><br><span class="line">        &#123;<span class="attr">path</span>:<span class="string">&#x27;/&#x27;</span>, <span class="attr">redirect</span>: <span class="string">&#x27;/home&#x27;</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Home</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/movie&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Movie</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>, <span class="attr">component</span>: <span class="title class_">About</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-2-嵌套路由">3.2 嵌套路由</h3><p>通过路由实现组件的嵌套展示，叫做嵌套路由。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-28-183346.png" alt=""></p><h3 id="3-3-声明子路由链接和子路由占位符">3.3 声明子路由链接和子路由占位符</h3><p>在 About.vue 组件中，声明 tab1 和 tab2 的子路由链接以及子路由占位符。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>About 组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 1. 在关于页面中，声明两个子路由链接 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about/tab1&quot;</span>&gt;</span>tb1<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about/tab2&quot;</span>&gt;</span>tb2<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 2. 在关于页面中，声明子路由的占位符 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;AboutPage&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h3 id="3-3-通过children属性声明子路由规则">3.3 通过children属性声明子路由规则</h3><p>在 src/router/index.js 路由模块中，导入需要的组件，并使用 <font color=red size=2>children 属性</font>声明子路由规则：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 导入 Vue 和 VueRouter 的包</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="comment">// 5. 导入需要使用路由切换展示的组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/Home.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Movie</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/Movie.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">About</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/About.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Tab1</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/tabs/Tab1.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Tab2</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/tabs/Tab2.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 调用 Vue.use() 函数,把VueRouter 安装为 Vue 的插件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建路由的实例对象</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">    <span class="attr">routes</span>: [ <span class="comment">// 在routers数组中，声明路由的匹配规则</span></span><br><span class="line">        <span class="comment">// path 表示要匹配的 hash 地址：component 表示要展示的路由组件</span></span><br><span class="line">        &#123;<span class="attr">path</span>:<span class="string">&#x27;/&#x27;</span>, <span class="attr">redirect</span>: <span class="string">&#x27;/home&#x27;</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Home</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">&#x27;/movie&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Movie</span>&#125;,</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>, </span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">About</span>,</span><br><span class="line">            <span class="comment">// 1. 通过 children 属性，嵌套声明子级路由规则</span></span><br><span class="line">            <span class="attr">children</span>: [</span><br><span class="line">                &#123;<span class="attr">path</span>: <span class="string">&quot;tab1&quot;</span>, <span class="attr">component</span>: <span class="title class_">Tab1</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">path</span>: <span class="string">&quot;tab2&quot;</span>, <span class="attr">component</span>: <span class="title class_">Tab2</span>&#125;,</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 向外共享路由的实例对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-4-动态路由匹配">3.4 动态路由匹配</h3><p>动态路由指的是：把 Hash 地址中<font color=red size=2>可变的部分</font>定义为<font color=red size=2>参数项</font>，从而提高路由规则的<font color=red size=2>复用性</font>。<br>在 vue-router 中使用<font color=red size=2>英文的冒号（:）</font>来定义路由的参数项。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/movie&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Movie</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&quot;:id&quot;</span>, <span class="attr">component</span>: <span class="title class_">Tab1</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="3-5-route-params参数对象">3.5 $route.params参数对象</h3><p>在<font color=red size=2>动态路由</font>渲染出来的组件中，可以使用 <code>this.$route.params</code> 对象访问到<font color=red size=2>动态匹配的参数值</font>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 1. 在关于页面中，声明两个子路由链接 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/movie/1&quot;</span>&gt;</span>第一集<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/movie/2&quot;</span>&gt;</span>第二集<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/movie/3&quot;</span>&gt;</span>第三集<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 2. 在关于页面中，声明子路由的占位符 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Movie 组件-- &#123;&#123; this.$route.params &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;MoviePage&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h3 id="3-6-使用props接收路由参数">3.6 使用props接收路由参数</h3><p>为了简化路由参数的获取形式，<code>vue-router</code> 允许在路由规则中开启 <code>props</code> 传参。示例代码如下：</p><p><strong>路由</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/movie&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Movie</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">        <span class="comment">// 1. 在定义路由规则时，声明 props: true</span></span><br><span class="line">        <span class="comment">// 即可在组件中，以 props 的形式接收到路由规则匹配到的参数项</span></span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&quot;:id&quot;</span>, <span class="attr">component</span>: <span class="title class_">Tab1</span>, <span class="attr">props</span>:<span class="literal">true</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 打印出来 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; id &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;Tab1Page&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 直接使用 props 接收路由规则中匹配到的参数项</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">id</span>: &#123;&#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h3 id="3-7-声明式导航-编程式导航">3.7 声明式导航 &amp; 编程式导航</h3><p>在浏览器中，<font color=red size=2>点击链接</font>实现导航的方式，叫做<font color=red size=2>声明式导航</font>。例如：</p><ul><li>普通网页中点击 <code>&lt;a&gt;</code> 链接、vue 项目中点击 <code>&lt;router-link&gt;</code> 都属于声明式导航</li></ul><p>在浏览器中，<font color=red size=2>调用 API 方法</font>实现导航的方式，叫做<font color=red size=2>编程式导航</font>。例如：</p><ul><li>普通网页中调用 <code>location.href</code> 跳转到新页面的方式，属于编程式导航</li></ul><h4 id="3-7-1-vue-router中的编程式导航API">3.7.1 vue-router中的编程式导航API</h4><p><code>vue-router</code> 提供了许多编程式导航的 API，其中最常用的导航 API 分别是：</p><ol><li><code>this.$router.push</code>(‘hash 地址’)<ul><li>跳转到指定 hash 地址，并增加一条历史记录</li></ul></li><li><code>this.$router.replace</code>(‘hash 地址’)<ul><li>跳转到指定的 hash 地址，并替换掉当前的历史记录</li></ul></li><li><code>this.$router.go</code>(数值 n)<ul><li>实现导航历史前进、后退</li></ul></li></ol><h4 id="3-7-2-router-push">3.7.2 $router.push</h4><p>调用 <code>this.$router.push()</code> 方法，可以跳转到指定的 hash 地址，从而展示对应的组件页面。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        Home</span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;gotoMovie&quot;</span>&gt;</span>跳转到 Movie 页面<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">gotoMovie</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/movie&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-7-3-router-replace">3.7.3 $router.replace</h4><p>调用 <code>this.$router.replace()</code> 方法，可以跳转到指定的 hash 地址，从而展示对应的组件页面。</p><p>push 和 replace 的区别：</p><ul><li>push 会增加一条历史记录</li><li>replace 不会增加历史记录，而是替换掉当前的历史记录</li></ul><h4 id="3-7-4-router-go">3.7.4 $router.go</h4><p>调用 <code>this.$router.go()</code> 方法，可以在浏览历史中前进和后退。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        Home</span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;gotoMovie&quot;</span>&gt;</span>后退<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">goBack</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 后退到之前的组件页面</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">go</span>(-<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h4 id="3-7-5-router-go的简化用法">3.7.5 $router.go的简化用法</h4><p>在实际开发中，一般只会前进和后退一层页面。因此 <code>vue-router</code> 提供了如下两个便捷方法：</p><ol><li><code>$router.back()</code></li></ol><ul><li>在历史记录中，后退到上一个页面</li></ul><ol start="2"><li><code>$router.forward()</code></li></ol><ul><li>在历史记录中，前进到下一个页面</li></ul><h3 id="3-8-导航守卫">3.8 导航守卫</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-29-105628.png" alt=""></p><h4 id="3-8-1-全局前置守卫">3.8.1 全局前置守卫</h4><p>每次发生路由的<font color=red size=2>导航跳转</font>时，都会触发<font color=red size=2>全局前置守卫</font>。因此，在全局前置守卫中，程序员可以对每个路由进行<font color=red size=2>访问权限</font>的控制：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建路由的实例对象</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">    <span class="attr">routes</span>: [ <span class="comment">// 在routers数组中，声明路由的匹配规则</span></span><br><span class="line">      ...</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用路由实例对象的 beforEach 方法，即可声明 &quot;全局前置守卫&quot;</span></span><br><span class="line"><span class="comment">// 每次发生路由导航跳转的时候，都会自动触发 fn 这个 &quot;回调函数&quot;</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(fn)</span><br></pre></td></tr></table></figure><h4 id="3-8-2-守卫方法的3个形参">3.8.2 守卫方法的3个形参</h4><p>全局前置守卫的回调函数中接收 3 个形参，格式为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局前置守卫</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// to 是将要访问的路由的信息对象</span></span><br><span class="line">    <span class="comment">// from 是将要离开的路由信息对象</span></span><br><span class="line">    <span class="comment">// next 是一个函数，调用 next() 表示放行，允许这次路由导航</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="3-8-3-next函数的3种调用方式">3.8.3 next函数的3种调用方式</h4><p>参考示意图，分析 next 函数的 3 种调用方式最终导致的结果：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-29-111146.png" alt=""></p><p>当前用户<font color=red size=2>拥有</font>后台主页的访问权限，直接放行：next()<br>当前用户<font color=red size=2>没有</font>后台主页的访问权限，<font color=red size=2>强制</font>其跳转到登录页面：next(‘/login’)<br>当前用户<font color=red size=2>没有</font>后台主页的访问权限，<font color=red size=2>不允许</font>跳转到后台主页：next(false)</p><h4 id="3-8-4-控制后台主页的访问权限">3.8.4 控制后台主页的访问权限</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// to 是将要访问的路由的信息对象</span></span><br><span class="line">    <span class="comment">// from 是将要离开的路由信息对象</span></span><br><span class="line">    <span class="comment">// next 是一个函数，调用 next() 表示放行，允许这次路由导航</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&#x27;/home&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> token = locakStorage.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (token) &#123;</span><br><span class="line">            <span class="comment">// 访问的是后台主页，且有 token 的值</span></span><br><span class="line">            <span class="title function_">next</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 访问的是后台主页，但是没有 token 的值</span></span><br><span class="line">            <span class="title function_">next</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 访问的不是后台主页，直接放行</span></span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue动态组件插槽以及自定义指令</title>
      <link href="/20230328/vue-20230328-vue%E5%8A%A8%E6%80%81%E7%BB%84%E4%BB%B6%E6%8F%92%E6%A7%BD%E4%BB%A5%E5%8F%8A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4/"/>
      <url>/20230328/vue-20230328-vue%E5%8A%A8%E6%80%81%E7%BB%84%E4%BB%B6%E6%8F%92%E6%A7%BD%E4%BB%A5%E5%8F%8A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="1-动态组件">1. 动态组件</h2><p>动态组件指的是<font color=red size=2>动态切换组件的显示与隐藏</font>。</p><h3 id="1-1-如何实现动态组件渲染">1.1 如何实现动态组件渲染</h3><p>vue 提供了一个内置的 <code>&lt;component&gt;</code> 组件，<font color=red size=2>专门用来实现动态组件的渲染</font>。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过is属性，动态指定要渲染的组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;comName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 点击按钮，动态切换组件的名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;comName = &#x27;LeftCom&#x27;&quot;</span>&gt;</span>展示 Left 组件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;comName = &#x27;RightCom&#x27;&quot;</span>&gt;</span>展示 Right 组件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">LeftCom</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Left.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">RightCom</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Right.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">LeftCom</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">RightCom</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 1. 默认渲染的组件名称   </span></span></span><br><span class="line"><span class="language-javascript">      <span class="attr">comName</span>: <span class="string">&#x27;LeftCom&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-使用keep-alive保持状态">1.2 使用keep-alive保持状态</h3><p>默认情况下，切换动态组件时<font color=red size=2>无法保持组件的状态</font>。此时可以使用 vue 内置的 <code>&lt;keep-alive&gt;</code> 组件保持动态组件的状态。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;comName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-keep-alive对应的生命周期函数">1.3 keep-alive对应的生命周期函数</h3><p>当组件<font color=red size=2>被缓存</font>时，会自动触发组件的 <code>deactivated</code> 生命周期函数。<br>当组件<font color=red size=2>被激活</font>时，会自动触发组件的 <code>activated</code> 生命周期函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;LeftCom&#x27;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件被创建了&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">destroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件被销毁了&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">activated</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;LeftCom 组件被激活了&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">deactivated</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;LeftCom 组件被缓存了&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-keep-alive的include属性">1.4 keep-alive的include属性</h3><p>include 属性用来指定：只有<font color=red size=2>名称匹配的组件</font>会被缓存。多个组件名之间使用<font color=red size=2>英文的逗号</font>分隔：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">include</span>=<span class="string">&quot;LeftCom,RightCom&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;comName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-插槽">2. 插槽</h2><p><font color=red size=2>插槽（Slot）</font>是 vue 为<font color=red size=2>组件的封装者</font>提供的能力。允许开发者在封装组件时，把<font color=red size=2>不确定的、希望由用户指定的部分</font>定义为插槽。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-28-152113.png" alt=""></p><div class="note primary no-icon flat"><p>可以把插槽认为是组件封装期间，为用户预留的内容的占位符。</p></div><h3 id="2-1-体验插槽的基础用法">2.1 体验插槽的基础用法</h3><p>在封装组件时，可以通过 <code>&lt;slot&gt;</code> 元素<font color=red size=2>定义插槽</font>，从而<font color=red size=2>为用户预留内容占位符</font>。示例代码如下：</p><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是 MyCom1 组件的第1个p标签<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过 slot 标签，为用户预留内容占位符（插槽） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是 MyCom2 组件最后一个p标签<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>父组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TestSlot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>~~~~用户自定义的内容~~~~<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">TestSlot</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note danger no-icon flat"><p>如果在封装组件时没有预留任何 <code>&lt;slot&gt;</code> 插槽，则用户提供的任何自定义内容都会<font color=red size=2>被丢弃</font>。</p></div><h3 id="2-2-后备内容">2.2 后备内容</h3><p>封装组件时，可以为预留的 <code>&lt;slot&gt;</code> 插槽提供后备内容（默认内容）。如果组件的使用者没有为插槽提供任何<br>内容，则后备内容会生效。示例代码如下:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是 MyCom1 组件的第1个p标签<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过 slot 标签，为用户预留内容占位符（插槽） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span>这是后备内容<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是 MyCom2 组件最后一个p标签<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-具名插槽">2.3 具名插槽</h3><p>如果在封装组件时<font color=red size=2>需要预留多个插槽节点</font>，则需要为每个 <slot> 插槽指定<font color=red size=2>具体的 name 名称</font>。这种<font color=red size=2>带有具体名称的插槽</font>叫做“具名插槽”。示例代码如下：</p><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 我们希望把页头放这里 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;header&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 我们希望把主要内容放这里 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span>这是后备内容<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 我们希望把页脚放这里 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;footer&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>父组件引用</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestSlot</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h1</span>&gt;</span>滕王阁序<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>主体内容<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:footer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>落款：王勃<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TestSlot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">TestSlot</span> <span class="keyword">from</span> <span class="string">&#x27;./components/TestSlot.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TestSlot</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：没有指定 name 名称的插槽，会有隐含的名称叫做 <code>default</code></p></div><h3 id="2-4-具名插槽的简写形式">2.4 具名插槽的简写形式</h3><p>跟 <code>v-on</code> 和 <code>v-bind</code> 一样，<code>v-slot</code> 也有缩写，即把参数之前的所有内容 (<code>v-slot</code>:) 替换为字符 <code>#</code>。例如 <code>v-slot:header</code>可以被重写为 <code>#header</code></p><h3 id="2-5-作用域插槽">2.5 作用域插槽</h3><p>在封装组件的过程中，可以为预留的 <code>&lt;slot&gt;</code> 插槽绑定 <code>props</code> 数据，这种带有 <code>props</code> 数据的 <code>&lt;slot&gt;</code> 叫做“作用域插槽”。示例代码如下：</p><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;z&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;fruit in fruitList&quot;</span> <span class="attr">:fruit</span>=<span class="string">&quot;fruit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fruitList</span>: [<span class="string">&quot;苹果&quot;</span>,<span class="string">&quot;柠檬&quot;</span>,<span class="string">&quot;青柠&quot;</span>]</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>父组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestSlot</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 1. 接受作用域插槽对外提供的数据 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> #<span class="attr">z</span>=<span class="string">&quot;scope&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 2. 使用作用域插槽的数据 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; scope.fruit &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TestSlot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">TestSlot</span> <span class="keyword">from</span> <span class="string">&#x27;./components/TestSlot.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TestSlot</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-自定义指令">3. 自定义指令</h2><p>vue 官方提供了 <code>v-text</code>、<code>v-for</code>、<code>v-model</code>、<code>v-if</code> 等常用的指令。除此之外 vue 还允许开发者自定义指令。</p><h3 id="3-1-自定义指令的分类">3.1 自定义指令的分类</h3><p>vue 中的自定义指令分为两类，分别是：</p><ol><li>私有自定义指令</li><li>全局自定义指令</li></ol><h3 id="3-2-私有自定义指令">3.2 私有自定义指令</h3><p>在每个 vue 组件中，可以在 <code>directives</code> 节点下声明<font color=red size=2>私有自定义指令</font>。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 声明自定义指令时，指令的名字是color --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用自定义指令时，需要加上 v-指令前缀 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-color</span>&gt;</span>作用域插槽<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;z&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;fruit in fruitList&quot;</span> <span class="attr">:data</span>=<span class="string">&quot;fruit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fruitList</span>: [<span class="string">&quot;苹果&quot;</span>,<span class="string">&quot;柠檬&quot;</span>,<span class="string">&quot;青柠&quot;</span>]</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">directives</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">color</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 为绑定到 html 元素设置红色文字</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">bind</span>(<span class="params">el</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 形参中的 el 是绑定了此指令的、原生的 DOM 对象</span></span></span><br><span class="line"><span class="language-javascript">                el.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-3-为自定义指令动态绑定参数值">3.3 为自定义指令动态绑定参数值</h3><p>在 template 结构中<font color=red size=2>使用自定义指令</font>时，可以通过等号（<code>=</code>）的方式，为当前指令<font color=red size=2>动态绑定参数值</font><br>通过 <code>binding</code> 获取指令的参数值，在声明自定义指令时，可以通过形参中的第二个参数，来接收指令的参数值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 声明自定义指令时，指令的名字是color --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用自定义指令时，需要加上 v-指令前缀 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-color</span>=<span class="string">&quot;color&quot;</span>&gt;</span>作用域插槽<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;z&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;fruit in fruitList&quot;</span> <span class="attr">:data</span>=<span class="string">&quot;fruit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fruitList</span>: [<span class="string">&quot;苹果&quot;</span>,<span class="string">&quot;柠檬&quot;</span>,<span class="string">&quot;青柠&quot;</span>],</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">color</span>: <span class="string">&#x27;yellow&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">directives</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">color</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 为绑定到 html 元素设置红色文字</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">bind</span>(<span class="params">el, binding</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 形参中的 el 是绑定了此指令的、原生的 DOM 对象</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 通过 binding 对象的 。value 属性，获取动态的参数值</span></span></span><br><span class="line"><span class="language-javascript">                el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-4-update函数">3.4 update函数</h3><p>bind 函数<font color=red size=2>只调用 1 次</font>：当指令第一次绑定到元素时调用，<font color=red size=2>当 DOM 更新时 bind 函数不会被触发</font>。 update 函数会在<font color=red size=2>每次 DOM 更新</font>时被调用。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 声明自定义指令时，指令的名字是color --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用自定义指令时，需要加上 v-指令前缀 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-color</span>=<span class="string">&quot;color&quot;</span>&gt;</span>作用域插槽<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;z&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;fruit in fruitList&quot;</span> <span class="attr">:data</span>=<span class="string">&quot;fruit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestSlot&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fruitList</span>: [<span class="string">&quot;苹果&quot;</span>,<span class="string">&quot;柠檬&quot;</span>,<span class="string">&quot;青柠&quot;</span>],</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">color</span>: <span class="string">&#x27;yellow&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">directives</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">color</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 为绑定到 html 元素设置红色文字</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">bind</span>(<span class="params">el, binding</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 形参中的 el 是绑定了此指令的、原生的 DOM 对象</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 通过 binding 对象的 。value 属性，获取动态的参数值</span></span></span><br><span class="line"><span class="language-javascript">                el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 每次 DOM 更新时被调用</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">update</span>(<span class="params">el, binding</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-5-函数简写">3.5 函数简写</h3><p>如果 <code>insert</code> 和<code>update</code> 函数中的<font color=red size=2>逻辑完全相同</font>，则对象格式的自定义指令可以简写成函数格式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">directives</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: &#123;</span><br><span class="line">        <span class="comment">// 为绑定到 html 元素设置红色文字</span></span><br><span class="line">        <span class="title function_">bind</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">            <span class="comment">// 形参中的 el 是绑定了此指令的、原生的 DOM 对象</span></span><br><span class="line">            <span class="comment">// 通过 binding 对象的 。value 属性，获取动态的参数值</span></span><br><span class="line">            el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 每次 DOM 更新时被调用</span></span><br><span class="line">        <span class="title function_">update</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">            el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在 insert 和 update 时，会触发相同的业务逻辑</span></span><br><span class="line">    <span class="title function_">color2</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">        el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-6-全局自定义指令">3.6 全局自定义指令</h3><p>全局共享的自定义指令需要通过<code>Vue.directive()</code>进行声明，示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：字符串，表示全局自定义指令的名字</span></span><br><span class="line"><span class="comment">// 参数2：对象，用来接收指令的参数值</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;color&#x27;</span>,<span class="keyword">function</span>(<span class="params">el, binding</span>)&#123;</span><br><span class="line">    el.<span class="property">style</span>.<span class="property">color</span> = binding.<span class="property">value</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue生命周期和数据共享</title>
      <link href="/20230327/vue-20230327-vue%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB/"/>
      <url>/20230327/vue-20230327-vue%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB/</url>
      
        <content type="html"><![CDATA[<h2 id="1-组件的生命周期">1. 组件的生命周期</h2><p><font color=red size=2>生命周期</font>（Life Cycle）是指一个组件从<font color=red size=2>创建</font> -&gt; <font color=red size=2>运行</font> -&gt; <font color=red size=2>销毁</font>的整个阶段，<font color=red size=2>强调的是一个时间段</font>。<br><font color=red size=2>生命周期函数</font>：是由 vue 框架提供的<font color=red size=2>内置函数</font>，会伴随着组件的生命周期，<font color=red size=2>自动按次序执行</font>。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-173116.png" alt=""></p><div class="note primary no-icon flat"><p>注意：生命周期强调的是时间段，生命周期函数强调的是时间点。</p></div><h2 id="2-组件之间的数据共享">2. 组件之间的数据共享</h2><h3 id="2-1-组件之间的关系">2.1 组件之间的关系</h3><p>在项目开发中，组件之间的<font color=red size=2>最常见的关系</font>分为如下两种：<br>① 父子关系<br>② 兄弟关系</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-173747.png" alt=""></p><h3 id="2-2-父子组件之间的数据共享">2.2 父子组件之间的数据共享</h3><p>父子组件之间的数据共享又分为：<br>① 父 -&gt; 子共享数据<br>② 子 -&gt; 父共享数据</p><h3 id="2-3-父组件向子组件共享数据">2.3 父组件向子组件共享数据</h3><p>父组件向子组件共享数据需要使用<font color=red size=2>自定义属性</font>。示例代码如下：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-174047.png" alt=""></p><p><strong>父组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestVue</span> <span class="attr">:msg</span>=<span class="string">&quot;message&quot;</span> <span class="attr">:user</span>=<span class="string">&quot;userinfo&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">TestVue</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">TestVue</span> <span class="keyword">from</span> <span class="string">&#x27;./components/TestVue.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TestVue</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">message</span>: <span class="string">&#x27;hello vue.js&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">userinfo</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&#x27;zs&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">age</span>: <span class="number">20</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>s</span><br></pre></td></tr></table></figure><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h5</span>&gt;</span>Son 组件<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>父组件传递过来的 msg 值是：&#123;&#123; msg &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>父组件传递过来的 user 值是：&#123;&#123; user &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestVue&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">msg</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>: <span class="title class_">String</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">required</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">user</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>: <span class="title class_">Object</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">default</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;&#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">required</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-4-子组件向父组件共享数据">2.4 子组件向父组件共享数据</h3><p>子组件向父组件共享数据使用<font color=red size=2>自定义事件</font>。示例代码如下：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-174247.png" alt=""></p><p><strong>子组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;add&quot;</span>&gt;</span>加一<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestEmit&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">count</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">add</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">count</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 修改数据时，通过$emit()触发自定义事件</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.$emit(<span class="string">&quot;numchange&quot;</span>, <span class="variable language_">this</span>.<span class="property">count</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>父组件</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestEmit</span> @<span class="attr">numchange</span>=<span class="string">&quot;getNewCount&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">TestEmit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>countFromSon值为：&#123;&#123; countFromSon &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">TestEmit</span> <span class="keyword">from</span> <span class="string">&#x27;./components/TestEmit.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TestEmit</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">countFromSon</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">getNewCount</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">countFromSon</span> = val</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-5-兄弟组件之间的数据共享">2.5 兄弟组件之间的数据共享</h3><p>在 vue2.x 中，兄弟组件之间数据共享的方案是 EventBus</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-174640.png" alt=""></p><p>EventBus 的使用步骤</p><p>① 创建 eventBus.js 模块，并向外共享一个 Vue 的实例对象<br>② 在数据发送方，调用 <code>bus.$emit('事件名称', 要发送的数据)</code> 方法触发自定义事件<br>③ 在数据接收方，调用 <code>bus.$on('事件名称', 事件处理函数)</code> 方法注册一个自定义事件</p><h2 id="3-ref引用">3. ref引用</h2><p>ref 用来辅助开发者在<font color=red size=2>不依赖于 jQuery 的情况下</font>，获取 DOM 元素或组件的引用。<br>每个 vue 的组件实例上，都包含一个 <font color=red size=2>$refs 对象</font>，里面存储着对应的 DOM 元素或组件的引用。默认情况下，<font color=red size=2>组件的 $refs 指向一个空对象</font>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>MyRef 组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getRef&quot;</span>&gt;</span>测试 Refs 引用<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestRef&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">getRef</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// this 是 当前组件的实例对象，this.$refs默认指向空对象</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-1-使用ref引用DOM元素">3.1 使用ref引用DOM元素</h3><p>如果想要使用 ref <font color=red size=2>引用页面上的 DOM 元素</font>，则可以按照如下的方式进行操作：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">ref</span>=<span class="string">&quot;myh3&quot;</span>&gt;</span>MyRef 组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getRef&quot;</span>&gt;</span>测试 Refs 引用<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestRef&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">getRef</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// this 是 当前组件的实例对象，this.$refs默认指向空对象</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 操作 DOM 元素，把文本颜色改为红色</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">myh3</span>.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-2-使用ref引用组件实例">3.2 使用ref引用组件实例</h3><p>如果想要使用 ref <font color=red size=2>引用页面上的组件实例</font>，则可以按照如下的方式进行操作：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用 ref 属性，为对应的&quot;组件&quot;添加引用名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestEmit</span> <span class="attr">ref</span>=<span class="string">&quot;testEmitRef&quot;</span> @<span class="attr">numchange</span>=<span class="string">&quot;getNewCount&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">TestEmit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getRef&quot;</span>&gt;</span>加一from父组件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>countFromSon值为: &#123;&#123; countFromSon &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">TestEmit</span> <span class="keyword">from</span> <span class="string">&#x27;./components/TestEmit.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TestEmit</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">countFromSon</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">getNewCount</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">countFromSon</span> = val</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">getRef</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 通过 this.$refs.引用名称 可以引用组件的实例</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">testEmitRef</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 引用到组件的实例之后，就可以调用组件上的 methods 方法</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">testEmitRef</span>.<span class="title function_">add</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-控制文本框和按钮的按需切换">3.3 控制文本框和按钮的按需切换</h3><p>通过布尔值 <code>inputVisible</code> 来控制组件中的文本框与按钮的按需切换。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;inputVisible&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showInput&quot;</span>&gt;</span>展示input输入框<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;disableInput&quot;</span>&gt;</span>关闭input输入框<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestInputVisible&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 控制文本框和按钮的按需切换</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">inputVisible</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showInput</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 切换布尔值，显示文本框</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">inputVisible</span> = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">disableInput</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">inputVisible</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-4-让文本框自动获得焦点">3.4 让文本框自动获得焦点</h3><p>当文本框展示出来之后，如果希望它立即获得焦点，则可以为其添加 ref 引用，并调用原生 DOM 对象的<font color=red size=2>.focus()</font> 方法即可。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;inputVisible&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;ipt&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showInput&quot;</span>&gt;</span>展示input输入框<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;disableInput&quot;</span>&gt;</span>关闭input输入框<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;TestInputVisible&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 控制文本框和按钮的按需切换</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">inputVisible</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showInput</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 切换布尔值，显示文本框</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">inputVisible</span> = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 把对 input 文本框的操作，推迟到下次 DOM 更新之后，否则页面上根本不存在文本框元素</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 获取文本框的 DOM 引用，并调用 .focus() 使其自动获得焦点</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">ipt</span>.<span class="title function_">focus</span>()</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">disableInput</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">inputVisible</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-5-this-nextTick-cb-方法">3.5 this.$nextTick(cb)方法</h3><p>组件的 <font color=red size=2>$nextTick(cb)</font> 方法，会把 cb 回调<font color=red size=2>推迟到下一个 DOM 更新周期之后执行</font>。通俗的理解是：等组件的DOM 更新完成之后，再执行 cb 回调函数。从而能保证 cb 回调函数可以操作到最新的 DOM 元素。</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue基础入门</title>
      <link href="/20230326/vue-20230326-vue%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"/>
      <url>/20230326/vue-20230326-vue%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-vue介绍">1. vue介绍</h2><h3 id="1-1-什么是vue">1.1 什么是vue</h3><p>官方给出的概念：Vue (读音 /vjuː/，类似于 view) 是一套<font color=red size=2>用于构建用户界面</font>的前端<font color=red size=2>框架</font>。</p><ol><li>构建用户界面<ul><li>用vue往html页面中填充数据，非常的方便</li></ul></li><li>框架<ul><li>框架是一套现成的解决方案，程序员只能遵守框架的规范，去编写自己的业务功能</li><li>要学习vue，就是在学习vue框架中规定的用法</li><li>vue的指令、组件（是对UI结构的复用）、路由、Vuex、vue组件库</li><li>只有把上面罗列的内容掌握以后，才有才发vue项目的能力</li></ul></li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-002647.png" alt=""></p><h3 id="1-2-vue的特性">1.2 vue的特性</h3><p>vue 框架的特性，主要体现在如下两方面：<br>① <font color=red size=2>数据驱动视图</font><br>② <font color=red size=2>双向数据绑定</font></p><h4 id="1-2-1-数据驱动视图">1.2.1 数据驱动视图</h4><p>在使用了 vue 的页面中，vue 会<font color=red size=2>监听数据的变化</font>，从而<font color=red size=2>自动</font>重新渲染页面的结构。示意图如下：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-003354.png" alt=""></p><h4 id="1-2-2-双向数据绑定">1.2.2 双向数据绑定</h4><p>在<font color=red size=2>填写表单</font>时，双向数据绑定可以辅助开发者在<font color=red size=2>不操作 DOM 的前提下，自动</font>把用户填写的内容<font color=red size=2>同步到</font>数据源<br>中。示意图如下：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-003704.png" alt=""></p><h3 id="1-3-MVVM">1.3 MVVM</h3><p><font color=red size=2>MVVM</font> 是 vue 实现<font color=red size=2>数据驱动视图</font>和<font color=red size=2>双向数据绑定</font>的核心原理。MVVM 指的是 Model、View 和 ViewModel，<br>它把每个 HTML 页面都拆分成了这三个部分，如图所示：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-004131.png" alt=""></p><h4 id="1-3-1-MVVM-的工作原理">1.3.1 MVVM 的工作原理</h4><p><font color=red size=2>ViewModel 作为 MVVM 的核心</font>，是它把当前页面的<font color=red size=2>数据源</font>（Model）和<font color=red size=2>页面的结构</font>（View）连接在了一起。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-004434.png" alt=""></p><p>当<font color=red size=2>数据源发生变化</font>时，会被 ViewModel 监听到，VM 会根据最新的数据源<font color=red size=2>自动</font>更新页面的结构<br>当<font color=red size=2>表单元素的值发生变化</font>时，也会被 VM 监听到，VM 会把变化过后最新的值<font color=red size=2>自动同步</font>到 Model 数据源中</p><h3 id="1-4-vue的版本">1.4 vue的版本</h3><p>当前，vue 共有 3 个大版本，其中：<br><font color=red size=2>2.x 版本的 vue 是目前企业级项目开发中的主流版本</font><br>3.x 版本的 vue 于 2020-09-19 发布，生态还不完善，尚未在企业级项目开发中普及和推广<br>1.x 版本的 vue 几乎被淘汰，不再建议学习与使用<br>总结：<br><font color=red size=2>3.x 版本的 vue 是未来企业级项目开发的趋势；</font><br>2.x 版本的 vue 在未来（1 ~ 2年内）会被逐渐淘汰；</p><h2 id="2-vue的基本使用">2. vue的基本使用</h2><h3 id="2-1-基本使用步骤">2.1 基本使用步骤</h3><ol><li>导入vue.js的script脚本文件</li><li>在页面中声明一个将要被vue所控制的DOM区域</li><li>创建vm实例对象（vue实例对象）</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123;username&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.2 指定 Model 数据源</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">username</span>: <span class="string">&quot;zs&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-基本代码与MVVM的对应关系">2.2 基本代码与MVVM的对应关系</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-005123.png" alt=""></p><h2 id="3-vue的调试工具">3. vue的调试工具</h2><h3 id="3-1-安装-vue-devtools-调试工具">3.1 安装 vue-devtools 调试工具</h3><p>vue 官方提供的 vue-devtools 调试工具，能够方便开发者对 vue 项目进行调试与开发。<br><strong>Chrome 浏览器</strong>在线安装 vue-devtools ：<br><a href="https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd">https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd</a><br><strong>FireFox 浏览器</strong>在线安装 vue-devtools ：<br><a href="https://addons.mozilla.org/zh-CN/firefox/addon/vue-js-devtools/">https://addons.mozilla.org/zh-CN/firefox/addon/vue-js-devtools/</a></p><h3 id="3-2-配置-Chrome-浏览器中的-vue-devtools">3.2 配置 Chrome 浏览器中的 vue-devtools</h3><p>点击 Chrome 浏览器右上角的 按钮，选择更多工具 -&gt; 扩展程序 -&gt; Vue.js devtools 详细信息，并勾选如下<br>的两个选项：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-005713.png" alt=""></p><h3 id="3-3-使用-vue-devtools-调试-vue-页面">3.3 使用 vue-devtools 调试 vue 页面</h3><p>在浏览器中访问一个使用了 vue 的页面，打开浏览器的开发者工具，切换到 Vue 面板，即可使用 vue-devtools<br>调试当前的页面。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-005922.png" alt=""></p><h2 id="4-vue的指令">4. vue的指令</h2><h3 id="4-1-指令的概念">4.1 指令的概念</h3><p><font color=red size=2>指令</font>（Directives）是 vue 为开发者提供的<font color=red size=2>模板语法</font>，用于<font color=red size=2>辅助开发者渲染页面的基本结构</font>。</p><p>vue 中的指令按照不同的用途可以分为如下 6 大类：<br>① <font color=red size=2>内容渲染</font>指令<br>② <font color=red size=2>属性绑定</font>指令<br>③ <font color=red size=2>事件绑定</font>指令<br>④ <font color=red size=2>双向绑定</font>指令<br>⑤ <font color=red size=2>条件渲染</font>指令<br>⑥ <font color=red size=2>列表渲染</font>指令</p><div class="note primary no-icon flat"><p>注意：指令是 vue 开发中最基础、最常用、最简单的知识点。</p></div><h4 id="4-1-1-内容渲染指令">4.1.1 内容渲染指令</h4><p><font color=red size=2>内容渲染指令</font>用来辅助开发者<font color=red size=2>渲染 DOM 元素的文本内容</font>。常用的内容渲染指令有如下 3 个：</p><ol><li><code>v-text</code></li><li><code>&#123;&#123;&#125;&#125;</code></li><li><code>v-html</code></li></ol><h5 id="4-1-1-1-v-text">4.1.1.1 v-text</h5><p>用法示例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 把 username 对应的值，渲染到第一个 P 标签中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-text</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 把 gender 对应的值，渲染到第二个 P标签中 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注意：第二个 P 标签中，默认的文本 &quot;性别&quot; 会被 gener 的值覆盖掉 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-text</span>=<span class="string">&quot;gen&quot;</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：v-text 指令会<font color=red size=2>覆盖元素内默认的值</font>。</p></div><h5 id="4-1-1-2-swig￼49-语法">4.1.1.2 <code>&#123;&#123; &#125;&#125;</code>语法</h5><p>vue 提供的 <code>&#123;&#123; &#125;&#125;</code> 语法，专门用来解决 v-text 会覆盖默认文本内容的问题。这种 <code>&#123;&#123; &#125;&#125;</code> 语法的专业名称是<font color=red size=2>插值表达<br>式</font>（英文名为：Mustache）。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用 &#123;&#123; &#125;&#125; 插值表达式,将对应的值渲染到元素的内容节点中 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 同时保留元素自身的默认值 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>姓名：&#123;&#123; username &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>性别：&#123;&#123; gender &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：相对于 <code>v-text</code> 指令来说，插值表达式在开发中更常用一些！因为它<font color=red size=2>不会覆盖元素中默认的文本内容</font>。</p></div><h5 id="4-1-1-3-v-html">4.1.1.3 v-html</h5><p>v-text 指令和插值表达式只能渲染纯文本内容。如果要把包含 HTML 标签的字符串渲染为页面的 HTML 元素，则需要用到 v-html 这个指令</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 假设 data 中定义了名为 discription 的数据，数据的值为包含 HTML 标签的字符串 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- discription: &quot;&lt;h5 style=&#x27;color: red;&#x27;&gt;欢迎来学习vue！！&lt;/h5&gt;&lt;/h5&gt;&quot;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-html</span>=<span class="string">&quot;discription&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-2-属性绑定指令">4.2 属性绑定指令</h3><p>如果需要为<font color=red size=2>元素的属性</font>动态绑定<font color=red size=2>属性值</font>，则需要用到 <font color=red size=2>v-bind</font> 属性绑定指令。用法示例如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用 v-bind 指令，为 input 的 placeholder 动态绑定属性值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-bind:placeholder</span>=<span class="string">&quot;inputValue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用 v-bind 指令，为 img 的 src 动态绑定属性值  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-bind:src</span>=<span class="string">&quot;imgSrc&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 130px&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">inputValue</span>: <span class="string">&quot;请输入内容&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">imgSrc</span>: <span class="string">&quot;https://cn.vuejs.org/images/logo.png&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1-属性绑定指令的简写形式">4.2.1 属性绑定指令的简写形式</h4><p>由于 v-bind 指令在开发中使用频率非常高，因此，vue 官方为其提供了简写形式（简写为英文的 : ）。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-012417.png" alt=""></p><h4 id="4-2-2-使用-Javascript-表达式">4.2.2 使用 Javascript 表达式</h4><p>在 vue 提供的模板渲染语法中，除了支持绑定简单的数据值之外，还支持 Javascript 表达式的运算，例如：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-012625.png" alt=""></p><h3 id="4-3-事件绑定指令">4.3 事件绑定指令</h3><p>vue 提供了 <font color=red size=2>v-on</font> 事件绑定指令，用来辅助程序员为 DOM 元素绑定事件监听。语法格式如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>count 的值为: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 语法格式为 v-on:事件名称=&quot;事件处理函数的名称&quot; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">&quot;addCount&quot;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：原生 DOM 对象有 onclick、oninput、onkeyup 等原生事件，替换为 vue 的事件绑定形式后，<br>分别为：v-on:click、v-on:input、v-on:keyup</p></div><p>通过 v-on 绑定的事件处理函数，需要在 methods 节点中进行声明：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>: &#123;  <span class="comment">// v-on 绑定的事件处理函数，需要声明在 methods 节点中</span></span><br><span class="line">    <span class="attr">addCount</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// 事件处理函数的名称</span></span><br><span class="line">        <span class="comment">// this 表示当前 new 出来的 vm 实例对象</span></span><br><span class="line">        <span class="comment">// 通过 this 可以访问到 data 中的数据</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">count</span> +=<span class="number">1</span>  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-1-事件绑定的简写形式">4.3.1 事件绑定的简写形式</h4><p>由于 v-on 指令在开发中使用频率非常高，因此，vue 官方为其提供了简写形式（简写为英文的 @ ）。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-270013427.png" alt=""></p><h4 id="4-3-2-事件参数对象">4.3.2 事件参数对象</h4><p>在原生的 DOM 事件绑定中，可以在事件处理函数的形参处，接收事件参数对象 event。同理，在 v-on 指令<br>（简写为 @ ）所绑定的事件处理函数中，同样可以接收到事件参数对象 event，示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>: &#123; </span><br><span class="line">    <span class="attr">addCount</span>: <span class="keyword">function</span>(<span class="params">e</span>) &#123; <span class="comment">// 接收事件参数对象 event,简写为 e</span></span><br><span class="line">        <span class="keyword">const</span> nowBgColor = e.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span></span><br><span class="line">        e.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = nowBgColor === <span class="string">&#x27;red&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;green&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">count</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-3-绑定事件并传参">4.3.3 绑定事件并传参</h4><p>在使用 v-on 指令绑定事件时，可以使用 <code>()</code>  进行传参，示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>count 的值为: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 语法格式为 v-on:事件名称=&quot;事件处理函数的名称&quot; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;addCount(2)&quot;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">count</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">                <span class="attr">addCount</span>: <span class="keyword">function</span>(<span class="params">step</span>) &#123; <span class="comment">// 接收事件参数对象 event,简写为 e</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.<span class="property">count</span> += step</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-3-4-event">4.3.4 $event</h4><p><font color=red size=2><code>$event</code></font> 是 vue 提供的<font color=red size=2>特殊变量</font>，用来表示<font color=red size=2>原生的事件参数对象 event</font>。$event 可以解决事件参数对象 event 被覆盖的问题。示例用法如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>count 的值为: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 语法格式为 v-on:事件名称=&quot;事件处理函数的名称&quot; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;addCount(2, $event)&quot;</span>&gt;</span>+2<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">count</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">                <span class="attr">addCount</span>: <span class="keyword">function</span>(<span class="params">step, e</span>) &#123; <span class="comment">// 接收事件参数对象 event,简写为 e</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> nowBgColor = e.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span></span></span><br><span class="line"><span class="language-javascript">                    e.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = nowBgColor === <span class="string">&#x27;cyan&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;yellow&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.<span class="property">count</span> += step</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-3-5-事件修饰符">4.3.5 事件修饰符</h4><p>在事件处理函数中调用 <font color=red size=2>event.preventDefault()</font> 或 <font color=red size=2>event.stopPropagation()</font> 是非常常见的需求。因此，vue 提供了<font color=red size=2>事件修饰符</font>的概念，来辅助程序员更方便的<font color=red size=2>对事件的触发进行控制</font>。常用的 5 个事件修饰符如下：</p><table><thead><tr><th>事件修饰符</th><th>说明</th></tr></thead><tbody><tr><td><font color=red size=2>.prevent</font></td><td><font color=red size=2>阻止默认行为</font>（例如：阻止 a 连接的跳转、阻止表单的提交等）</td></tr><tr><td><font color=red size=2>.stop</font></td><td><font color=red size=2>阻止事件冒泡</font></td></tr><tr><td>.capture</td><td>以捕获模式触发当前的事件处理函数</td></tr><tr><td>.once</td><td>绑定的事件只触发1次</td></tr><tr><td>self</td><td>只有在 event.target 是当前元素自身时触发事件处理函数</td></tr></tbody></table><p>语法格式如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 触发 click 点击事件时，阻止 a 链接的默认跳转行为 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.baidu.com&quot;</span> @<span class="attr">click.prevent</span>=<span class="string">&quot;onLinkClick&quot;</span>&gt;</span>百度首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-3-6-按键修饰符">4.3.6 按键修饰符</h4><p>在<font color=red size=2>监听键盘事件</font>时，我们经常需要<font color=red size=2>判断详细的按键</font>。此时，可以为键盘相关的事件添加按键修饰符，例如：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 只有在 `key` 是 `Enter` 时调用 `vm.submit()` --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">keyup.enter</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 只有在 `key` 是 `Esc` 时调用 `vm.clerInput()` --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">keyup.esc</span>=<span class="string">&quot;clearInput&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="5-双向绑定指令">5. 双向绑定指令</h3><p>vue 提供了<font color=red size=2>v-model 双向数据绑定</font>指令，用来辅助开发者在<font color=red size=2>不操作 DOM</font> 的前提下，<font color=red size=2>快速获取表单的数据</font></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>用户名：&#123;&#123; username &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>选中的省份是：&#123;&#123; province &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">v-model</span>=<span class="string">&quot;province&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>北京<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>河北<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>黑龙江<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">username</span>: <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">province</span>: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="5-1-v-model-指令的修饰符">5.1 v-model 指令的修饰符</h4><p><font color=red size=2>为了方便对用户输入的内容进行处理</font>，vue 为 v-model 指令提供了 3 个修饰符，分别是：</p><table><thead><tr><th>修饰符</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>.number</td><td>自动将用户的输入值转为数值类型</td><td>&lt;input v-model<font color=red size=2>.number</font>=“age” /&gt;</td></tr><tr><td>.trim</td><td>自动过滤用户输入的首尾空白字符</td><td>&lt;input v-model<font color=red size=2>.trim</font>=“msg” /&gt;</td></tr><tr><td>.lazy</td><td>在“change”时而非“input”时更新</td><td>&lt;input v-model<font color=red size=2>.lazy</font>=“msg” /&gt;</td></tr></tbody></table><h3 id="6-条件渲染指令">6. 条件渲染指令</h3><p><font color=red size=2>条件渲染指令</font>用来辅助开发者<font color=red size=2>按需控制 DOM 的显示与隐藏</font>。条件渲染指令有如下两个，分别是：</p><ul><li>v-if</li><li>v-show</li></ul><p>示例用法如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">&quot;networkState === 200&quot;</span>&gt;</span>请求成功 --- 被 v-if 控制<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-show</span>=<span class="string">&quot;networkState === 200&quot;</span>&gt;</span>请求成功 --- 被 v-show 控制<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="6-1-v-if和v-show的区别">6.1 v-if和v-show的区别</h4><p>实现原理不同：</p><ul><li>v-if 指令会<font color=red size=2>动态地创建或移除 DOM 元素</font>，从而控制元素在页面上的显示与隐藏；</li><li>v-show 指令会动态为元素<font color=red size=2>添加或移除 style=“display: none;” 样式</font>，从而控制元素的显示与隐藏；</li></ul><p>性能消耗不同：<br>v-if 有更高的切换开销，而 v-show 有更高的初始渲染开销。因此：</p><ul><li>如果需要非常频繁地切换，则使用 v-show 较好</li><li>如果在运行时条件很少改变，则使用 v-if 较好</li></ul><h4 id="6-2-v-else">6.2 v-else</h4><p>v-if 可以单独使用，或配合 v-else 指令一起使用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;Math.random() &gt; 0.5&quot;</span>&gt;</span></span><br><span class="line">        随机数大于 0.5</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">        随机数小于或等于 0.5</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：v-else 指令<font color=red size=2>必须配合</font> v-if 指令一起使用，否则它将不会被识别！</p></div><h4 id="6-3-v-else-if">6.3 v-else-if</h4><p>v-else-if 指令，顾名思义，充当 v-if 的“else-if 块”，可以连续使用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;type === &#x27;A&#x27;&quot;</span>&gt;</span>优秀<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else-if</span>=<span class="string">&quot;type === &#x27;B&#x27;&quot;</span>&gt;</span>良好<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else-if</span>=<span class="string">&quot;type === &#x27;C&#x27;&quot;</span>&gt;</span>一般<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span>差<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：v-else-if 指令<font color=red size=2>必须配合</font> v-if 指令一起使用，否则它将不会被识别！</p></div><h3 id="7-列表渲染指令">7. 列表渲染指令</h3><p>vue 提供了 <code>v-for</code> 列表渲染指令，用来辅助开发者<font color=red size=2>基于一个数组来循环渲染一个列表结构</font>。<code>v-for</code> 指令需要使用 <font color=red size=2>item in items </font>形式的特殊语法，其中：</p><ul><li>items 是待循环的数组</li><li>item 是被循环的每一项</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;item in list&quot;</span>&gt;</span>姓名是：&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">list</span>: [</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">&#x27;ls&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">                ]</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="7-1-v-for中的索引">7.1 v-for中的索引</h4><p>v-for 指令还支持一个<font color=red size=2>可选的</font>第二个参数，即<font color=red size=2>当前项的索引</font>。语法格式为 <font color=red size=2>(item, index) in items</font>，示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in list&quot;</span>&gt;</span>索引是：&#123;&#123;index&#125;&#125;，姓名是：&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">list</span>: [</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">&#x27;ls&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">                ]</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：v-for 指令中的 <font color=red size=2>item 项</font>和 <font color=red size=2>index 索引</font>都是形参，可以根据需要进行<font color=red size=2>重命名</font>。例如 (<font color=red size=2>user, i</font>) in userlist</p></div><h4 id="7-2-使用key维护列表的状态">7.2 使用key维护列表的状态</h4><p>当<font color=red size=2>列表的数据变化</font>时，默认情况下，vue 会<font color=red size=2>尽可能的复用</font>已存在的 DOM 元素，从而<font color=red size=2>提升渲染的性能</font>。但这种默认的性能优化策略，会导致<font color=red size=2>有状态的列表无法被正确更新</font>。为了给 vue 一个提示，以便它能跟踪每个节点的身份，从而在保证<font color=red size=2>有状态的列表被正确更新</font>的前提下，提升渲染的性能。此时，需要为每项提供一个<font color=red size=2>唯一的 key 属性</font>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 加 key 属性的好处 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 1. 正确维护列表的状态 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 2. 复用现有的 DOM 元素，提升渲染的性能 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span>&gt;</span></span><br><span class="line">                索引是：&#123;&#123;index&#125;&#125;，姓名是：&#123;&#123; item.name &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">list</span>: [</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">                    &#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">&#x27;ls&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">                ]</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123; </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>key 的注意事项</strong></p><ol><li>key 的值只能是<font color=red size=2>字符串</font>或<font color=red size=2>数字</font>类型</li><li>key 的值<font color=red size=2>必须具有唯一性</font>（即：key 的值不能重复）</li><li>建议把数据项 id 属性的值作为 key 的值（因为 id 属性的值具有唯一性）</li><li>使用 index 的值当作 key 的值没有任何意义（因为 index 的值不具有唯一性）</li><li>建议使用 v-for 指令时<font color=red size=2>一定要指定 key 的值</font>（既提升性能、又防止列表状态紊乱）</li></ol><h2 id="5-过滤器">5. 过滤器</h2><p><font color=red size=2>过滤器（Filters）</font>是 vue 为开发者提供的功能，常用于<font color=red size=2>文本的格式化</font>。过滤器可以用在两个地方：<font color=red size=2>插值表达式</font>和 <font color=red size=2>v-bind</font> 属性绑定。<br>过滤器应该被添加在 JavaScript 表达式的<font color=red size=2>尾部</font>，由“<font color=red size=2>管道符</font>”进行调用，示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 在双花括号中通过&quot;管道符&quot;调用 capitalize 过滤器，对message的值进行格式化 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; message | capitalize &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 在v-bind中通过&quot;管道符&quot;嗲用formatId过滤器，对rawId的值进行格式化 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">:id</span>=<span class="string">&quot;rawId | formatId&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="5-1-定义过滤器">5.1 定义过滤器</h3><p>在创建 vue 实例期间，可以在 <font color=red size=2>filters</font> 节点中定义过滤器，示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">        <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span><br><span class="line">        <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;this is a test message&quot;</span>,</span><br><span class="line">            <span class="attr">rawId</span>: <span class="string">&quot;测试信息&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">filters</span>: &#123;  <span class="comment">// 在 filters 节点下定义过滤器</span></span><br><span class="line">            <span class="title function_">capitalize</span>(<span class="params">str</span>) &#123; <span class="comment">// 把首字母转为大写的过滤器</span></span><br><span class="line">                <span class="keyword">return</span> str.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">methods</span>: &#123; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="5-2-私有过滤器和全局过滤器">5.2 私有过滤器和全局过滤器</h3><p>在 filters 节点下定义的过滤器，称为“私有过滤器”，因为它只能在当前 vm 实例所控制的 el 区域内使用。如果希望在多个 vue 实例之间共享过滤器，则可以按照如下的格式定义全局过滤器：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局过滤器 - 独立于每个 vm 实例之外</span></span><br><span class="line"><span class="comment">// Vue.filter() 方法接收两个参数</span></span><br><span class="line"><span class="comment">//      第1个参数，是全局过滤器的名字</span></span><br><span class="line"><span class="comment">//      第2个参数，是全局过滤器的处理函数</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">filters</span>(<span class="string">&#x27;capitalize&#x27;</span>, <span class="function">(<span class="params">str</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + str.<span class="title function_">slice</span>(<span class="number">1</span>) + <span class="string">&#x27;~~&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="5-3-连续调用多个过滤器">5.3 连续调用多个过滤器</h3><p>过滤器可以串联地进行调用，例如:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 把 message 的值，交给filterA进行处理 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 把filterA处理的结果，再交给filterB进行处理 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 最终把filterB处理的结果，作为最终的值渲染到页面上 --&gt;</span></span><br><span class="line">&#123;&#123; message | filterA | filterB &#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4-过滤器传参">5.4 过滤器传参</h3><p>过滤器的本质是 JavaScript 函数，因此可以接收参数，格式如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- arg1 和 arg2 是传递给 filterA 的参数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; message | capitalize | maxLength1(5) &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">message</span>: <span class="string">&quot;this is a test message&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">filters</span>: &#123;  </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 第一个参数：永远都是&quot;管道符&quot;前面待处理的值</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 从第二个参数开始，才是调用过滤器时传递过来的arg1和arg2参数</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">capitalize</span>(<span class="params">str</span>) &#123; </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> str.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + str.<span class="title function_">slice</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 全局过滤器</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 控制文本的最大长度</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">Vue</span>.<span class="title function_">filter</span>(<span class="string">&#x27;maxLength&#x27;</span>,<span class="function">(<span class="params">str, len=<span class="number">10</span></span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (str.<span class="property">length</span> &lt;= len) <span class="keyword">return</span> str</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> str.<span class="title function_">slice</span>(<span class="number">0</span>, len) + <span class="string">&#x27;...&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="5-5-过滤器的兼容性">5.5 过滤器的兼容性</h3><p>过滤器仅在 vue 2.x 和 1.x 中受支持，在 <font color=red size=2>vue 3.x</font> 的版本中<font color=red size=2>剔除</font>了过滤器相关的功能。</p><p>在企业级项目开发中：</p><ul><li>如果使用的是 2.x 版本的 vue，则依然可以使用过滤器相关的功能</li><li>如果项目已经升级到了 3.x 版本的 vue，官方建议使用<font color=red size=2>计算属性</font>或<font color=red size=2>方法</font>代替被剔除的过滤器功能</li></ul><p>具体的迁移指南，请参考 vue 3.x 的官方文档给出的说明：<br><a href="https://v3.vuejs.org/guide/migration/filters.html#migration-strategy">https://v3.vuejs.org/guide/migration/filters.html#migration-strategy</a></p><h2 id="6-watch侦听器">6. watch侦听器</h2><p>watch 侦听器允许开发者监视数据的变化，从而针对数据的变化做特定的操作。</p><p>语法格式如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">        <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span><br><span class="line">        <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;this is a test message&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">filters</span>: &#123;  </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">watch</span>: &#123;</span><br><span class="line">            <span class="comment">// 监听 message 值的变化</span></span><br><span class="line">            <span class="comment">// newVal 是&quot;变化后的新值&quot;, oldVal是&quot;变化之前的旧值&quot;</span></span><br><span class="line">            <span class="title function_">message</span>(<span class="params">newVal, oldVal</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(newVal, oldVal)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">methods</span>: &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="6-1-检测用户名是否可用">6.1 检测用户名是否可用</h3><p>监听 username 值的变化，并使用 axios 发起 Ajax 请求，检测当前输入的用户名是否可用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios@1.3.4/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">username</span>: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">filters</span>: &#123;  </span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">watch</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 监听 username 值的变化</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">async</span> <span class="title function_">username</span>(<span class="params">newVal</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (newVal == <span class="string">&#x27;&#x27;</span>) <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 使用axios 发起请求， 判断用户名是否可用</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> &#123; <span class="attr">data</span>: res &#125; = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&quot;https://www.escook.cn/api/finduser/&quot;</span> + newVal)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="6-2-immediate选项">6.2 immediate选项</h3><p>默认情况下，组件在初次加载完毕后不会调用 watch 侦听器。如果想让 watch 侦听器<font color=red size=2>立即被调用</font>，则需要使用 <font color=red size=2>immediate</font> 选项。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">watch</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: &#123;</span><br><span class="line">        <span class="comment">// handler 是固定写法，表示当 username 的值变化时，自动调用 handler 处理函数</span></span><br><span class="line">        <span class="attr">handler</span>: <span class="keyword">async</span>  <span class="keyword">function</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newVal == <span class="string">&#x27;&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">            <span class="comment">// 使用axios 发起请求， 判断用户名是否可用</span></span><br><span class="line">            <span class="keyword">const</span> &#123; <span class="attr">data</span>: res &#125; = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&quot;https://www.escook.cn/api/finduser/&quot;</span> + newVal)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 表示页面初次渲染好之后，就立即触发当前的watch侦听器</span></span><br><span class="line">        <span class="attr">immediate</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="6-3-deep选项">6.3 deep选项</h3><p>如果 watch 侦听的是一个对象，如果对象中的属性值发生了变化，则无法被监听到。此时需要使用 deep 选项，代码示例如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 在页面中声明一个将要被 vue 所控制的 DOM 区域 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;info.username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. 导入vue.js 的 script 脚本文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios@1.3.4/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 创建vm 实例对象 （vue 实例对象）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.1 指定当前vm实例要控制页面的哪个区域</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">info</span>: &#123;<span class="attr">username</span>: <span class="string">&#x27;admin&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">filters</span>: &#123;  </span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">watch</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">info</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// handler 是固定写法，表示当 username 的值变化时，自动调用 handler 处理函数</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">handler</span>: <span class="keyword">async</span>  <span class="keyword">function</span>(<span class="params">newVal</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(newVal.<span class="property">username</span>)</span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">deep</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="6-4-监听对象单个属性的变化">6.4 监听对象单个属性的变化</h3><p>如果<font color=red size=2>只想监听对象中单个属性</font>的变化，则可以按照如下的方式定义 watch 侦听器：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">watch</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;info.username&#x27;</span>: &#123;</span><br><span class="line">        <span class="comment">// handler 是固定写法，表示当 username 的值变化时，自动调用 handler 处理函数</span></span><br><span class="line">        <span class="attr">handler</span>: <span class="keyword">async</span>  <span class="keyword">function</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(newVal)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">deep</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="7-计算属性">7. 计算属性</h2><p>计算属性指的是<font color=red size=2>通过一系列运算</font>之后，最终得到一个<font color=red size=2>属性值</font>。<br><font color=red size=2>这个动态计算出来的属性值</font>可以被模板结构或 methods 方法使用。示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;show&quot;</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/vue/2.6.10/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">r</span>: <span class="number">0</span>, <span class="attr">g</span>: <span class="number">0</span>, <span class="attr">b</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">computed</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">rgb</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="string">`rgb(<span class="subst">$&#123;<span class="variable language_">this</span>.r&#125;</span>, <span class="subst">$&#123;<span class="variable language_">this</span>.g&#125;</span>, <span class="subst">$&#123;<span class="variable language_">this</span>.b&#125;</span>)`</span> &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">filters</span>: &#123;  </span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">watch</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">show</span>(<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">rgb</span>)&#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="7-1-计算属性的特点">7.1 计算属性的特点</h3><p>① 虽然计算属性在<font color=red size=2>声明的时候</font>被定义为<font color=red size=2>方法</font>，但是计算属性的<font color=red size=2>本质是一个属性</font><br>② 计算属性会<font color=red size=2>缓存计算的结果</font>，只有计算属性<font color=red size=2>依赖的数据变化时</font>，才会重新进行运算</p><h2 id="8-vue-cli">8. vue-cli</h2><h3 id="8-1-什么是单页面应用程序">8.1 什么是单页面应用程序</h3><p>单页面应用程序（英文名：Single Page Application）简称 SPA，顾名思义，指的是一个 Web 网站中只有唯一的一个 HTML 页面，所有的功能与交互都在这唯一的一个页面内完成。</p><h3 id="8-2-什么是-vue-cli">8.2 什么是 vue-cli</h3><p><font color=red size=2>vue-cli 是 Vue.js 开发的标准工具</font>。它简化了程序员基于 webpack 创建工程化的 Vue 项目的过程。</p><p>引用自 vue-cli 官网上的一句话：<br>程序员可以<font color=red size=2>专注在撰写应用上</font>，而不必花好几天去纠结 webpack 配置的问题。</p><p>中文官网：<a href="https://cli.vuejs.org/zh/">https://cli.vuejs.org/zh/</a></p><h3 id="8-2-安装和使用">8.2 安装和使用</h3><p>vue-cli 是 npm 上的一个全局包，使用 npm install 命令，即可方便的把它安装到自己的电脑上：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br></pre></td></tr></table></figure><p>基于 vue-cli 快速生成工程化的 Vue 项目：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create 项目的名称</span><br></pre></td></tr></table></figure><h3 id="8-3-vue项目的运行流程">8.3 vue项目的运行流程</h3><p>在工程化的项目中，vue 要做的事情很单纯：通过 <code>main.js</code> 把 <code>App.vue</code> 渲染到 <code>index.html</code> 的指定区域中。</p><p>其中：</p><ol><li>App.vue 用来编写待渲染的模板结构</li><li>index.html 中需要预留一个 el 区域</li><li>main.js 把 App.vue 渲染到了 index.html 所预留的区域中</li></ol><h2 id="9-vue组件">9. vue组件</h2><p><font color=red size=2>组件化开发</font>指的是：根据<font color=red size=2>封装</font>的思想，把页面上<font color=red size=2>可重用的 UI 结构封装为组件</font>，从而方便项目的开发和维护</p><h3 id="9-1-vue中的组件化开发">9.1 vue中的组件化开发</h3><p>vue 是一个支持组件化开发的前端框架。<br>vue 中规定：组件的后缀名是 .vue。之前接触到的 App.vue 文件本质上就是一个 vue 的组件</p><h3 id="9-2-vue组件的三个组成部分">9.2 vue组件的三个组成部分</h3><p>每个 .vue 组件都由 3 部分构成，分别是：</p><ol><li>template -&gt; 组件的模板结构</li><li>script -&gt; 组件的 JavaScript 行为</li><li>style -&gt; 组件的样式</li></ol><p>其中，每个组件中必须包含 template 模板结构，而 script 行为和 style 样式是可选的组成部分</p><h4 id="9-2-1-template">9.2.1 template</h4><p>vue 规定：每个组件对应的模板结构，需要定义到 <code>&lt;template&gt;</code> 节点中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 当前组件的 DOM 结构，需要定义到 template 标签的内部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>注意：<br> template 是 vue 提供的<font color=red size=2>容器标签</font>，只起到<font color=red size=2>包裹性质的作用</font>，它不会被渲染为真正的 DOM 元素<br> template 中只能包含唯一的根节点</p></div><h4 id="9-2-2-script">9.2.2 script</h4><p>vue 规定：开发者可以在 <code>&lt;script&gt;</code> 节点中封装组件的 JavaScript 业务逻辑。<br><code>&lt;script &gt;</code> 节点的基本结构如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 今后，组件相关的 data 数据、methods 方法等</span></span><br><span class="line">    <span class="comment">// 都需要定义到 export default 所导出的对象中</span></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h5 id="9-2-2-1-组件中的data必须是函数">9.2.2.1 组件中的data必须是函数</h5><p>vue 规定：.vue 组件中的 data 必须是一个函数，不能直接指向一个数据对象。<br>因此在组件中定义 data 数据节点时，下面的方式是错误的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>: &#123; <span class="comment">// 组件中，不能直接让 data 指向一个数据对象（会报错）</span></span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>会导致<font color=red size=2>多个组件实例</font>共用<font color=red size=2>同一份数据</font>的问题，请参考官方给出的示例：<br><a href="https://cn.vuejs.org/v2/guide/components.html#data-%E5%BF%85%E9%A1%BB%E6%98%AF%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">https://cn.vuejs.org/v2/guide/components.html#data-必须是一个函数</a></p><h4 id="9-2-3-style">9.2.3 style</h4><p>vue 规定：组件内的 <code>&lt;style&gt;</code> 节点是可选的，开发者可以在 <code>&lt;style&gt;</code> 节点中编写样式美化当前组件的 UI 结构。<br><code>&lt;script &gt;</code> 节点的基本结构如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">font-weight</span>: normal;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><h5 id="9-2-3-1-让style中支持less语法">9.2.3.1 让style中支持less语法</h5><p>在 <code>&lt;style&gt;</code> 标签上添加 lang=“less” 属性，即可使用 less 语法编写组件的样式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;style lang=&quot;less&quot;&gt;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">font-weight</span>: normal;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><h3 id="9-3-组件之间的父子关系">9.3 组件之间的父子关系</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-163307.png" alt=""></p><h4 id="9-3-1-使用组件的三个步骤">9.3.1 使用组件的三个步骤</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-163505.png" alt=""></p><h4 id="9-3-2-通过components注册的是私有子组件">9.3.2 通过components注册的是私有子组件</h4><p>例如：<br>在组件 A 的 components 节点下，注册了组件 F。<br>则组件 F 只能用在组件 A 中；不能被用在组件 C 中。<br>请大家思考两个问题：<br>① 为什么 F 不能用在组件 C 中？<br>② 怎样才能在组件 C 中使用 F？</p><h4 id="9-3-3-注册全局组件">9.3.3 注册全局组件</h4><p>在 vue 项目的 <code>main.js</code> 入口文件中，通过 <code>Vue.component()</code> 方法，可以注册全局组件。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入需要全局注册的组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Count</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/Count.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数1: 字符串格式, 表示组件的&quot;注册名称&quot;</span></span><br><span class="line"><span class="comment">// 参数2: 需要被全局注册的那个组件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&quot;MyCount&quot;</span>, <span class="title class_">Count</span>)</span><br></pre></td></tr></table></figure><h3 id="9-4-组件的props">9.4 组件的props</h3><p>props 是组件的<font color=red size=2>自定义属性</font>，在<font color=red size=2>封装通用组件</font>的时候，合理地使用 props 可以极大的<font color=red size=2>提高组件的复用性！</font><br>它的语法格式如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// 组件的自定义属性</span></span><br><span class="line">    <span class="attr">props</span>: [<span class="string">&#x27;自定义属性A&#x27;</span>,<span class="string">&#x27;自定义属性B&#x27;</span>,<span class="string">&#x27;....&#x27;</span>],</span><br><span class="line">    <span class="comment">// 组件私有数据</span></span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9-4-1-props是只读的">9.4.1  props是只读的</h4><p>vue 规定：组件中封装的自定义属性是<font color=red size=2>只读的</font>，程序员<font color=red size=2>不能直接修改</font> props 的值。否则会直接报错：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./2023-03-27-164650.png" alt=""></p><p>要想修改 props 的值，可以<font color=red size=2>把 props 的值转存到 data 中</font>，因为 data 中的数据都是可读可写的！</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// 组件的自定义属性</span></span><br><span class="line">    <span class="attr">props</span>: [<span class="string">&#x27;init&#x27;</span>],</span><br><span class="line">    <span class="comment">// 组件私有数据</span></span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">init</span> <span class="comment">// 把 this.init 的值转存到 count</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9-4-2-props的default默认值">9.4.2 props的default默认值</h4><p>在声明自定义属性时，可以通过 default 来定义属性的默认值。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">init</span>: &#123;</span><br><span class="line">        <span class="comment">// 用 default 属性定义属性的默认值</span></span><br><span class="line">        <span class="attr">default</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="9-4-3-props的type值类型">9.4.3  props的type值类型</h4><p>在声明自定义属性时，可以通过 type 来定义属性的值类型。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">init</span>: &#123;</span><br><span class="line">        <span class="comment">// 用 default 属性定义属性的默认值</span></span><br><span class="line">        <span class="attr">default</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="comment">// 用 type 属性定义属性的值类型</span></span><br><span class="line">        <span class="comment">// 如果传递过来的值不符合此类型，则会在终端报错</span></span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Number</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="9-4-4-props的required必填项">9.4.4 props的required必填项</h4><p>在声明自定义属性时，可以通过 <code>required</code> 选项，将属性设置为<font color=red size=2>必填项</font>，强制用户必须传递属性的值。示例代<br>码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">init</span>: &#123;</span><br><span class="line">        <span class="comment">// 用 default 属性定义属性的默认值</span></span><br><span class="line">        <span class="attr">default</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="comment">// 用 type 属性定义属性的值类型</span></span><br><span class="line">        <span class="comment">// 如果传递过来的值不符合此类型，则会在终端报错</span></span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Number</span>,</span><br><span class="line">        <span class="comment">// 必填项校验</span></span><br><span class="line">        <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="9-5-组件之间的样式冲突问题">9.5 组件之间的样式冲突问题</h3><p>默认情况下，写在 <font color=red size=2>.vue 组件中的样式会全局生效</font>，因此很容易造成<font color=red size=2>多个组件之间的样式冲突问题</font>。</p><p>导致组件之间样式冲突的根本原因是：<br>① 单页面应用程序中，所有组件的 DOM 结构，都是基于<font color=red size=2>唯一的 index.html 页面</font>进行呈现的<br>② 每个组件中的样式，都会<font color=red size=2>影响整个 index.html 页面</font>中的 DOM 元素</p><h4 id="9-5-1-解决组件样式冲突的问题">9.5.1 解决组件样式冲突的问题</h4><p>为每个组件分配唯一的自定义属性，在编写组件样式时，通过属性选择器来控制样式的作用域，示例代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span> <span class="attr">data-v-001</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span> <span class="attr">data-v-001</span>&gt;</span>轮播图<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 通过中括号&quot;属性选择器&quot;,来防止组件之间的样式冲突问题，</span></span></span><br><span class="line"><span class="comment"><span class="language-css">       因此每个组件分配的自定义属性是&quot;唯一的&quot;</span></span></span><br><span class="line"><span class="comment"><span class="language-css">    */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.container</span><span class="selector-attr">[data-v-0001]</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid red;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="9-5-2-style节点的scoped属性">9.5.2 style节点的scoped属性</h4><p>为了提高开发效率和开发体验，vue 为 style 节点提供了 scoped 属性，从而防止组件之间的样式冲突问题：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>轮播图<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* style 节点的 scoped 属性，用来自动为每个组件分配唯一的&quot;自定义属性&quot;</span></span></span><br><span class="line"><span class="comment"><span class="language-css">       并自动为当前组件的DOM标签和style样式应用这个自定义属性，防止组件的样式冲突问题</span></span></span><br><span class="line"><span class="comment"><span class="language-css">    */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid red;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="9-5-3-deep-样式穿透">9.5.3 /deep/ 样式穿透</h4><p>如果给当前组件的 style 节点添加了 scoped 属性，则<font color=red size=2>当前组件的样式对其子组件是不生效的</font>。如果想让某些样<br>式对子组件生效，可以使用 <font color=red size=2>/deep/ 深度选择器</font></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;style scoped&gt;</span><br><span class="line"><span class="selector-class">.title</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue; <span class="comment">/* 不加 /deep/ 时，生成的选择器格式为 .title[data-v-052242de] */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/deep/ <span class="selector-class">.title</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue; <span class="comment">/* 加上 /deep/ 时，生成的选择器格式为[data-v-052242de] .title */</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GRPC</title>
      <link href="/20230301/golang-20230301-GRPC/"/>
      <url>/20230301/golang-20230301-GRPC/</url>
      
        <content type="html"><![CDATA[<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./grpc.png" alt="avatar"></p><p>gRPC是Google公司基于Protobuf开发的跨语言的开源RPC框架。gRPC基于HTTP/2协议设计，可以基于一个HTTP/2链接提供多个服务，对于移动设备更加友好。</p><h2 id="GRPC技术栈">GRPC技术栈</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./grpc-go-stack.png" alt="avatar"></p><ul><li>数据交互格式: protobuf</li><li>通信方式: 最底层为TCP或Unix Socket协议，在此之上是HTTP/2协议的实现</li><li>核心库: 在HTTP/2协议之上又构建了针对Go语言的gRPC核心库</li><li>Stub: 应用程序通过gRPC插件生产的Stub代码和gRPC核心库通信，也可以直接和gRPC核心库通信</li></ul><p>gRPC采用protobuf描述 接口和数据, 我们可以把他理解为: protobuf ON HTTP2 的一种RPC</p><h2 id="Hello-gRPC">Hello gRPC</h2><p>下面我们讲演示一个基础的gRPC服务.</p><h3 id="protobuf-grpc插件">protobuf grpc插件</h3><p>protobuf 不仅可以定义交互的数据结构(message), 还可以定义交互的接口:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service HelloService &#123;</span><br><span class="line">    rpc Hello (String) returns (String);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从Protobuf的角度看，gRPC只不过是一个针对service接口生成代码的生成器。因此我们需要提前安装grpc的代码生成插件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># protoc-gen-<span class="keyword">go</span> 插件之前已经安装</span><br><span class="line"># <span class="keyword">go</span> install google.golang.org/protobuf/cmd/protoc-gen-<span class="keyword">go</span>@latest</span><br><span class="line"></span><br><span class="line"># 安装protoc-gen-<span class="keyword">go</span>-grpc插件</span><br><span class="line"><span class="keyword">go</span> install google.golang.org/grpc/cmd/protoc-gen-<span class="keyword">go</span>-grpc@latest</span><br></pre></td></tr></table></figure><h3 id="生成代码">生成代码</h3><p>然后基于protoc-gen-go-grpc来生产我们的grpc代码, 我们把之前的rpc 修改为GRPC</p><p>我们看看protobuf 定义接口的语法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service &lt;service_name&gt; &#123;</span><br><span class="line">    rpc &lt;function_name&gt; (&lt;request&gt;) returns (&lt;response&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>service: 用于申明这是个服务的接口</li><li>service_name: 服务的名称,接口名称</li><li>function_name: 函数的名称</li><li>request: 函数参数， 必须的</li><li>response: 函数返回， 必须的, 不能没有</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package hello;</span><br><span class="line">option go_package=&quot;test_rpc/pbrpc/service&quot;;</span><br><span class="line"></span><br><span class="line">// The HelloService service definition.</span><br><span class="line">service HelloService &#123;</span><br><span class="line">    rpc Hello (Request) returns (Response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    string value = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    string value = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们生产代码, 同时制定gprc插件对应参数:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=./grpc/pb --go_out=./grpc/pb  --go_opt=module=<span class="string">&quot;test-grpc/grpc/pb&quot;</span> ./grpc/pb/hello.proto</span><br></pre></td></tr></table></figure><h2 id="gRPC服务端">gRPC服务端</h2><p>基于服务端的HelloServiceServer接口可以重新实现HelloService服务</p><p>首先我们构建一个服务实体，实现GRPC定义的接口</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/grpc/pb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ pb.HelloServiceServer = <span class="built_in">new</span>(HelloServiceServer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnimplementedHelloServiceServer must be embedded to have forward compatible implementations.</span></span><br><span class="line"><span class="keyword">type</span> HelloServiceServer <span class="keyword">struct</span> &#123;</span><br><span class="line">*pb.UnimplementedHelloServiceServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloServiceServer)</span></span> Hello(ctx context.Context, req *pb.Request) (*pb.Response, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;pb.Response&#123;Value: fmt.Sprintf(<span class="string">&quot;Hello %s&quot;</span>, req.Value)&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 首先是通过grpc.NewServer()构造一个gRPC服务对象</span></span><br><span class="line">grpcServer := grpc.NewServer()</span><br><span class="line"><span class="comment">// 然后通过gRPC插件生成的RegisterHelloServiceServer函数注册我们实现的HelloServiceImpl服务</span></span><br><span class="line">pb.RegisterHelloServiceServer(grpcServer, <span class="built_in">new</span>(HelloServiceServer))</span><br><span class="line"></span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后通过grpcServer.Serve(lis)在一个监听端口上提供gRPC服务</span></span><br><span class="line">grpcServer.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gRPC客户端">gRPC客户端</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/grpc/pb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// grpc.Dial负责和gRPC服务建立链接</span></span><br><span class="line">conn, err := grpc.Dial(<span class="string">&quot;localhost:1234&quot;</span>, grpc.WithInsecure())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHelloServiceClient函数基于已经建立的链接构造HelloServiceClient对象,</span></span><br><span class="line"><span class="comment">// 返回的client其实是一个HelloServiceClient接口对象</span></span><br><span class="line">client := pb.NewHelloServiceClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过接口定义的方法就可以调用服务端对应的gRPC服务提供的方法</span></span><br><span class="line">req := &amp;pb.Request&#123;Value: <span class="string">&quot;张三&quot;</span>&#125;</span><br><span class="line">reply, err := client.Hello(context.Background(), req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply.GetValue())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="gRPC流">gRPC流</h2><p>RPC是远程函数调用，因此每次调用的函数参数和返回值不能太大，否则将严重影响每次调用的响应时间。因此传统的RPC方法调用对于上传和下载较大数据量场景并不适合。为此，gRPC框架针对服务器端和客户端分别提供了流特性</p><p>服务端或客户端的单向流是双向流的特例，我们在HelloService增加一个支持双向流的Channel方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// The HelloService service definition.</span><br><span class="line">service HelloService &#123;</span><br><span class="line">    rpc Hello (Request) returns (Response) &#123;&#125;</span><br><span class="line">    rpc Channel (stream Request) returns (stream Response) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键字stream指定启用流特性，参数部分是接收客户端参数的流，返回值是返回给客户端的流。</p><h3 id="生成Streaming-RPC">生成Streaming RPC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=./grpc/pb --go-grpc_out=./grpc/pb --go-grpc_opt=module=<span class="string">&quot;test-grpc/grpc/pb&quot;</span> ./grpc/pb/hello.proto</span><br></pre></td></tr></table></figure><p>我们看看接口的变化:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端的Channel方法返回一个HelloService_ChannelClient类型的返回值，可以用于和服务端进行双向通信</span></span><br><span class="line"><span class="comment">// HelloServiceClient is the client API for HelloService service.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream.</span></span><br><span class="line"><span class="keyword">type</span> HelloServiceClient <span class="keyword">interface</span> &#123;</span><br><span class="line">Hello(ctx context.Context, in *Request, opts ...grpc.CallOption) (*Response, <span class="type">error</span>)</span><br><span class="line">Channel(ctx context.Context, opts ...grpc.CallOption) (HelloService_ChannelClient, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在服务端的Channel方法参数是一个新的HelloService_ChannelServer类型的参数，可以用于和客户端双向通信</span></span><br><span class="line"><span class="comment">// HelloServiceServer is the server API for HelloService service.</span></span><br><span class="line"><span class="comment">// All implementations must embed UnimplementedHelloServiceServer</span></span><br><span class="line"><span class="comment">// for forward compatibility</span></span><br><span class="line"><span class="keyword">type</span> HelloServiceServer <span class="keyword">interface</span> &#123;</span><br><span class="line">Hello(context.Context, *Request) (*Response, <span class="type">error</span>)</span><br><span class="line">Channel(HelloService_ChannelServer) <span class="type">error</span></span><br><span class="line">mustEmbedUnimplementedHelloServiceServer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HelloService_ChannelClient 和 HelloService_ChannelServer 接口定义:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request  -----&gt; </span></span><br><span class="line"><span class="comment">// Response &lt;----</span></span><br><span class="line"><span class="keyword">type</span> HelloService_ChannelClient <span class="keyword">interface</span> &#123;</span><br><span class="line">Send(*Request) <span class="type">error</span></span><br><span class="line">Recv() (*Response, <span class="type">error</span>)</span><br><span class="line">grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request &lt;----</span></span><br><span class="line"><span class="comment">// Reponse ----&gt;</span></span><br><span class="line"><span class="keyword">type</span> HelloService_ChannelServer <span class="keyword">interface</span> &#123;</span><br><span class="line">Send(*Response) <span class="type">error</span></span><br><span class="line">Recv() (*Request, <span class="type">error</span>)</span><br><span class="line">grpc.ServerStream</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现服务端和客户端的流辅助接口均定义了Send和Recv方法用于流数据的双向通信</p><h3 id="服务端-2">服务端</h3><p>server端逻辑:</p><ul><li>接收一个Request</li><li>响应一个Response</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *HelloService)</span></span> Channel(stream service.HelloService_ChannelServer) <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// 服务端在循环中接收客户端发来的数据</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// 接收一个请求</span></span><br><span class="line">args, err := stream.Recv()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// 如果遇到io.EOF表示客户端流被关闭</span></span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应一个请求</span></span><br><span class="line"><span class="comment">// 生成返回的数据通过流发送给客户端</span></span><br><span class="line">resp := &amp;service.Response&#123;Value: <span class="string">&quot;hello:&quot;</span> + args.GetValue()&#125;</span><br><span class="line">err = stream.Send(resp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// 服务端发送异常, 函数退出, 服务端流关闭</span></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>双向流数据的发送和接收都是完全独立的行为。</p><p>需要注意的是，发送和接收的操作并不需要一一对应，用户可以根据真实场景进行组织代码</p><h3 id="客户端-2">客户端</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;test-rpc/grpc/service&quot;</span></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">conn, err := grpc.Dial(<span class="string">&quot;localhost:1234&quot;</span>, grpc.WithInsecure())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">client := service.NewHelloServiceClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端需要先调用Channel方法获取返回的流对象</span></span><br><span class="line">stream, err := client.Channel(context.Background())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在客户端我们将发送和接收操作放到两个独立的Goroutine。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 首先是向服务端发送数据</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := stream.Send(&amp;service.Request&#123;Value: <span class="string">&quot;hi&quot;</span>&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后在循环中接收服务端返回的数据</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">reply, err := stream.Recv()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply.GetValue())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gRPC认证">gRPC认证</h2><p>前面我们的grpc服务 在无任何保护机制下 都可以被任何人调用, 这是很危险的, 因此我们需要为grpc 添加认证的功能</p><p>我们在上面的流程中可以得知Grpc有2种模式:</p><ul><li>Request Response模式</li><li>Stream 模式</li></ul><p>在grpc的认证体系中, 着2种认证是独立开的</p><h3 id="Request-Response认证">Request Response认证</h3><p>我们先来看看 grpc框架给我们预留的 拦截器钩子:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./grpc-unary.png" alt="avatar"></p><h4 id="原理">原理</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./grpc-server-inter.png" alt="avatar"></p><ul><li>ctx 请求上下文</li><li>req rpc请求数据</li><li>info 服务端相关数据, 不用理解这个</li><li>handler 处理请求的handler, 相对于next()</li><li>resp rpc响应</li><li>err rpc 错误</li></ul><p>gprc 基于HTTP2通讯, grpc的拦截器的作用原理和 http的中间件是一样的:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./http-middle.png" alt="avatar"></p><h4 id="编写中间件">编写中间件</h4><p>基于此原理，我们来编写一个 Request Response模式下的中间件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">ClientHeaderKey = <span class="string">&quot;client-id&quot;</span></span><br><span class="line">ClientSecretKey = <span class="string">&quot;client-secret&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GrpcAuthUnaryServerInterceptor returns a new unary server interceptor for auth.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GrpcAuthUnaryServerInterceptor</span><span class="params">()</span></span> grpc.UnaryServerInterceptor &#123;</span><br><span class="line"><span class="keyword">return</span> newGrpcAuther().Auth</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newGrpcAuther</span><span class="params">()</span></span> *grpcAuther &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;grpcAuther&#123;</span><br><span class="line">log: zap.L().Named(<span class="string">&quot;Grpc Auther&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// internal todo</span></span><br><span class="line"><span class="keyword">type</span> grpcAuther <span class="keyword">struct</span> &#123;</span><br><span class="line">log logger.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *grpcAuther)</span></span> Auth(</span><br><span class="line">ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;,</span><br><span class="line">info *grpc.UnaryServerInfo,</span><br><span class="line">handler grpc.UnaryHandler,</span><br><span class="line">) (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// 重上下文中获取认证信息</span></span><br><span class="line">md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;ctx is not an grpc incoming context&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;gprc header info: &quot;</span>, md)</span><br><span class="line"></span><br><span class="line">clientId, clientSecret := a.GetClientCredentialsFromMeta(md)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验调用的客户端凭证是否有效</span></span><br><span class="line"><span class="keyword">if</span> err := a.validateServiceCredential(clientId, clientSecret); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp, err = handler(ctx, req)</span><br><span class="line"><span class="keyword">return</span> resp, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *grpcAuther)</span></span> GetClientCredentialsFromMeta(md metadata.MD) (</span><br><span class="line">clientId, clientSecret <span class="type">string</span>) &#123;</span><br><span class="line">cids := md.Get(ClientHeaderKey)</span><br><span class="line">sids := md.Get(ClientSecretKey)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(cids) &gt; <span class="number">0</span> &#123;</span><br><span class="line">clientId = cids[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sids) &gt; <span class="number">0</span> &#123;</span><br><span class="line">clientSecret = sids[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *grpcAuther)</span></span> validateServiceCredential(clientId, clientSecret <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> clientId == <span class="string">&quot;&quot;</span> &amp;&amp; clientSecret == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> status.Errorf(codes.Unauthenticated, <span class="string">&quot;client_id or client_secret is \&quot;\&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !(clientId == <span class="string">&quot;admin&quot;</span> &amp;&amp; clientSecret == <span class="string">&quot;123456&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> status.Errorf(codes.Unauthenticated, <span class="string">&quot;client_id or client_secret invalidate&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Server添加认证">Server添加认证</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先是通过grpc.NewServer()构造一个gRPC服务对象</span></span><br><span class="line">grpcServer := grpc.NewServer(</span><br><span class="line"><span class="comment">// 添加认证中间件, 如果有多个中间件需要添加 使用ChainUnaryInterceptor</span></span><br><span class="line">grpc.UnaryInterceptor(auther.GrpcAuthUnaryServerInterceptor()),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="Client携带认证-基础">Client携带认证(基础)</h4><p>客户端每次发送RPC时都需要携带上 调用凭证, 也就是服务端认证是需要的:</p><ul><li>client_id</li><li>client_secret</li></ul><p>那客户端怎么把凭证传递给服务端端喃? 对照 http1.1 的认证逻辑(通过Header来传递), grpc也提供了类似的机制: metadata,</p><p>我们可以把凭证放到metadata中, 传递给服务端, 然后服务端从中取出, 进行校验。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// grpc.Dial负责和gRPC服务建立链接</span></span><br><span class="line">conn, err := grpc.Dial(<span class="string">&quot;localhost:1234&quot;</span>, grpc.WithInsecure())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHelloServiceClient函数基于已经建立的链接构造HelloServiceClient对象,</span></span><br><span class="line"><span class="comment">// 返回的client其实是一个HelloServiceClient接口对象</span></span><br><span class="line">client := pb.NewHelloServiceClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加认证信息</span></span><br><span class="line">crendential := metadata.MD&#123;server.ClientHeaderKey: []<span class="type">string</span>&#123;<span class="string">&quot;admin&quot;</span>&#125;, server.ClientSecretKey: []<span class="type">string</span>&#123;<span class="string">&quot;1234567&quot;</span>&#125;&#125;</span><br><span class="line">ctx := metadata.NewOutgoingContext(context.Background(), crendential)</span><br><span class="line"><span class="comment">// 通过接口定义的方法就可以调用服务端对应的gRPC服务提供的方法</span></span><br><span class="line"><span class="comment">// 每次带上凭证信息</span></span><br><span class="line">reply, err := client.Hello(ctx, &amp;pb.Request&#123;Value: <span class="string">&quot;张三&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply.GetValue())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Client携带认证-改进">Client携带认证(改进)</h4><p>如果我们每次都 怎么传递, 是不是有点蠢, 我们为啥不封装一个类似 客户端中间件的函数, 每次发送的时候调用下喃?</p><p>你的这种想法 作者也知道, 因此他为我们设计了一种机制: WithPerRPCCredentials, 每次调用的时候, 都从获取凭证 注入到metadata中:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithPerRPCCredentials returns a DialOption which sets credentials and places</span></span><br><span class="line"><span class="comment">// auth state on each outbound RPC.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPerRPCCredentials</span><span class="params">(creds credentials.PerRPCCredentials)</span></span> DialOption &#123;</span><br><span class="line"><span class="keyword">return</span> newFuncDialOption(<span class="function"><span class="keyword">func</span><span class="params">(o *dialOptions)</span></span> &#123;</span><br><span class="line">o.copts.PerRPCCredentials = <span class="built_in">append</span>(o.copts.PerRPCCredentials, creds)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以看到 PerRPCCredentials 是一个接口:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PerRPCCredentials defines the common interface for the credentials which need to</span></span><br><span class="line"><span class="comment">// attach security information to every RPC (e.g., oauth2).</span></span><br><span class="line"><span class="keyword">type</span> PerRPCCredentials <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// GetRequestMetadata gets the current request metadata, refreshing</span></span><br><span class="line"><span class="comment">// tokens if required. This should be called by the transport layer on</span></span><br><span class="line"><span class="comment">// each request, and the data should be populated in headers or other</span></span><br><span class="line"><span class="comment">// context. If a status code is returned, it will be used as the status</span></span><br><span class="line"><span class="comment">// for the RPC. uri is the URI of the entry point for the request.</span></span><br><span class="line"><span class="comment">// When supported by the underlying implementation, ctx can be used for</span></span><br><span class="line"><span class="comment">// timeout and cancellation. Additionally, RequestInfo data will be</span></span><br><span class="line"><span class="comment">// available via ctx to this call.</span></span><br><span class="line"><span class="comment">// TODO(zhaoq): Define the set of the qualified keys instead of leaving</span></span><br><span class="line"><span class="comment">// it as an arbitrary string.</span></span><br><span class="line">GetRequestMetadata(ctx context.Context, uri ...<span class="type">string</span>) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line"><span class="comment">// RequireTransportSecurity indicates whether the credentials requires</span></span><br><span class="line"><span class="comment">// transport security.</span></span><br><span class="line">RequireTransportSecurity() <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那接下来我们实现该接口, 就实现了我们的客户端认证的携带机制:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> auther</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;context&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClientAuthentication</span><span class="params">(clientId, clientSecret <span class="type">string</span>)</span></span> *Authentication &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Authentication&#123;</span><br><span class="line">clientID:     clientId,</span><br><span class="line">clientSecret: clientSecret,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Authentication todo</span></span><br><span class="line"><span class="keyword">type</span> Authentication <span class="keyword">struct</span> &#123;</span><br><span class="line">clientID     <span class="type">string</span></span><br><span class="line">clientSecret <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WithClientCredentials todo</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Authentication)</span></span> WithClientCredentials(clientID, clientSecret <span class="type">string</span>) &#123;</span><br><span class="line">a.clientID = clientID</span><br><span class="line">a.clientSecret = clientSecret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetRequestMetadata todo</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Authentication)</span></span> GetRequestMetadata(context.Context, ...<span class="type">string</span>) (</span><br><span class="line"><span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>,</span><br><span class="line">) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;client-id&quot;</span>:     a.clientID,</span><br><span class="line"><span class="string">&quot;client-secret&quot;</span>: a.clientSecret,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RequireTransportSecurity todo</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Authentication)</span></span> RequireTransportSecurity() <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样我们在建立grpc的连接的时候，就传递我们的Credential, 就实现了客户端携带凭证</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// grpc.Dial负责和gRPC服务建立链接</span></span><br><span class="line">conn, err := grpc.Dial(<span class="string">&quot;localhost:1234&quot;</span>, grpc.WithInsecure(), grpc.WithPerRPCCredentials(auther.NewClientAuthentication(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>)))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHelloServiceClient函数基于已经建立的链接构造HelloServiceClient对象,</span></span><br><span class="line"><span class="comment">// 返回的client其实是一个HelloServiceClient接口对象</span></span><br><span class="line">client := pb.NewHelloServiceClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加认证信息</span></span><br><span class="line"><span class="comment">// crendential := metadata.MD&#123;auther.ClientHeaderKey: []string&#123;&quot;admin&quot;&#125;, auther.ClientSecretKey: []string&#123;&quot;123456&quot;&#125;&#125;</span></span><br><span class="line"><span class="comment">// ctx := metadata.NewOutgoingContext(context.Background(), crendential)</span></span><br><span class="line"></span><br><span class="line">ctx := metadata.NewOutgoingContext(context.Background(), metadata.Pairs())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过接口定义的方法就可以调用服务端对应的gRPC服务提供的方法</span></span><br><span class="line"><span class="comment">// 每次带上凭证信息</span></span><br><span class="line">reply, err := client.Hello(ctx, &amp;pb.Request&#123;Value: <span class="string">&quot;张三&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply.GetValue())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端需要先调用Channel方法获取返回的流对象</span></span><br><span class="line">stream, err := client.Channel(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在客户端我们将发送和接收操作放到两个独立的Goroutine。</span></span><br><span class="line"><span class="comment">// 首先是向服务端发送数据</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := stream.Send(&amp;pb.Request&#123;Value: <span class="string">&quot;hi&quot;</span>&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后在循环中接收服务端返回的数据</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">reply, err := stream.Recv()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply.GetValue())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Stream-认证">Stream 认证</h3><p>stream认证 不同于 request reponse认证模式, 因为客户端和服务端是建立的长连接, 就行TCP一样, 因此一般我们只需要在 连接建立开始做下认证, 传递过程中 我们无需对每次交互做认证。</p><h4 id="原理-2">原理</h4><p>和http中间件一样, stream模式下，grpc也提供了一个钩子:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./grpc-stream-unr.png" alt="avatar"></p><ul><li>srv service信息</li><li>ss Server 了数据流</li><li>info 服务端相关数据, 不用理解这个</li><li>handler 处理请求的handler, 相当于next()</li><li>err rpc 错误</li></ul><p>我们的任务就是实现一个这样的函数, 在函数中添加认证逻辑</p><h4 id="编写中间件-2">编写中间件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *grpcAuther)</span></span> streamAuth(srv <span class="keyword">interface</span>&#123;&#125;, ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler) <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// 从上下文中获取认证信息</span></span><br><span class="line">md, ok := metadata.FromIncomingContext(ss.Context())</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;ctx is not an grpc incoming context&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;gprc header info: &quot;</span>, md)</span><br><span class="line"></span><br><span class="line">clientId, clientSecret := a.getClientCredentialsFromMeta(md)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验调用的客户端凭证是否有效</span></span><br><span class="line"><span class="keyword">if</span> err := a.validateServiceCredential(clientId, clientSecret); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handler(srv, ss)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Server添加认证-2">Server添加认证</h4><p>然后我们补充上 stream的认证中间件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先是通过grpc.NewServer()构造一个gRPC服务对象</span></span><br><span class="line">grpcServer := grpc.NewServer(</span><br><span class="line"><span class="comment">// 添加认证中间件, 如果有多个中间件需要添加 使用ChainUnaryInterceptor</span></span><br><span class="line">grpc.UnaryInterceptor(auther.GrpcAuthUnaryServerInterceptor()),</span><br><span class="line"><span class="comment">// 添加stream API的拦截器</span></span><br><span class="line">grpc.StreamInterceptor(auther.GrpcAuthStreamServerInterceptor()),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="客户端携带认证">客户端携带认证</h4><p>客户端提供凭证的逻辑和 Request Reponse模式一样</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Protobuf编解码</title>
      <link href="/20230227/golang-20230227-Protobuf%E7%BC%96%E8%A7%A3%E7%A0%81/"/>
      <url>/20230227/golang-20230227-Protobuf%E7%BC%96%E8%A7%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./protobuf.jpg" alt="avatar"></p><p>Protobuf是Protocol Buffers的简称，它是Google公司开发的一种数据描述语言，并于2008年对外开源。Protobuf刚开源时的定位类似于XML、JSON等数据描述语言，通过附带工具生成代码并实现将结构化数据序列化的功能。但是我们更关注的是Protobuf作为接口规范的描述语言，可以作为设计安全的跨语言PRC接口的基础工具</p><p><a href="https://developers.google.com/protocol-buffers">官网</a></p><h2 id="为什么选择Protobuf">为什么选择Protobuf</h2><p>一般而言我们需要一种编解码工具会参考:</p><ul><li>编解码效率</li><li>高压缩比</li><li>多语言支持</li></ul><p>其中压缩与效率 最被关注的点:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./protobuf-bytes-vs.png" alt="avatar"></p><h2 id="使用流程">使用流程</h2><p>首先需要定义我们的数据，通过编译器，来生成不同语言的代码<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./protoc-compiler.png" alt="avatar"></p><p>之前我们的RPC要么使用的Gob, 要么使用的json, 接下来我们将使用probuf</p><p>首先创建hello.proto文件，其中包装HelloService服务中用到的字符串类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> hello;</span><br><span class="line">option go_package=<span class="string">&quot;pbrpc/pb&quot;</span>;</span><br><span class="line"></span><br><span class="line">message String &#123;</span><br><span class="line">    <span class="type">string</span> value = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>syntax: 表示采用proto3的语法。第三版的Protobuf对语言进行了提炼简化，所有成员均采用类似Go语言中的零值初始化（不再支持自定义默认值），因此消息成员也不再需要支持required特性。</li><li>package：指明当前是main包（这样可以和Go的包名保持一致，简化例子代码），当然用户也可以针对不同的语言定制对应的包路径和名称。</li><li>option：protobuf的一些选项参数, 这里指定的是要生成的Go语言package路径, 其他语言参数各不相同</li><li>message: 关键字定义一个新的String类型，在最终生成的Go语言代码中对应一个String结构体。String类型中只有一个字符串类型的value成员，该成员编码时用1编号代替名字</li></ul><div class="note primary no-icon flat"><p><strong>关于数据编码:</strong></p><p>在XML或JSON等数据描述语言中，一般通过成员的名字来绑定对应的数据。但是Protobuf编码却是通过成员的唯一编号来绑定对应的数据，因此Protobuf编码后数据的体积会比较小，但是也非常不便于人类查阅。我们目前并不关注Protobuf的编码技术，最终生成的Go结构体可以自由采用JSON或gob等编码格式，因此大家可以暂时忽略Protobuf的成员编码部分,<br>但是我们如何把这个定义文件(IDL: 接口描述语言), 编译成不同语言的数据结构喃? 着就需要我们安装protobuf的编译器</p></div><h2 id="安装编译器">安装编译器</h2><p>protobuf的编译器叫: protoc(protobuf compiler), 我们需要到这里下载编译器: <a href="https://github.com/protocolbuffers/protobuf/releases">Github Protobuf</a></p><h2 id="安装Go语言插件">安装Go语言插件</h2><p>Protobuf核心的工具集是C++语言开发的，在官方的protoc编译器中并不支持Go语言。要想基于上面的hello.proto文件生成相应的Go代码，需要安装相应的插件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> install google.golang.org/protobuf/cmd/protoc-gen-<span class="keyword">go</span>@latest</span><br></pre></td></tr></table></figure><h2 id="编译proto文件">编译proto文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=./pb_rpc/codec/pb --go_out=./pb_rpc/codec/pb --go_opt=module=<span class="string">&quot;test-grpc/pb_rpc/codec/pb&quot;</span> ./pb_rpc/codec/pb<span class="comment">/*.proto</span></span><br></pre></td></tr></table></figure><ul><li>-I：-IPATH, --proto_path=PATH, 指定proto文件搜索的路径, 如果有多个路径 可以多次使用-I 来指定, 如果不指定默认为当前目录</li><li>–go_out: --go指插件的名称, 我们安装的插件为: protoc-gen-go, 而protoc-gen是插件命名规范, go是插件名称, 因此这里是–go, 而–go_out 表示的是 go插件的 out参数, 这里指编译产物的存放目录</li><li>–go_opt: protoc-gen-go插件opt参数, 这里的module指定了go module, 生成的go pkg 会去除掉module路径，生成对应pkg</li><li>pb/*.proto: 我们proto文件路径</li></ul><p>这样我们就在当前目录下生成了Go语言对应的pkg, 我们的message String 被生成为了一个Go Struct</p><h2 id="序列化与反序列化">序列化与反序列化</h2><p>基于上面生成的Go 数据结构, 我们就可以来进行 数据的交互了(序列化与反序列化)</p><p><a href="http://xn--google-hz8ig3bo82im51b.golang.org/protobuf/proto%E5%B7%A5%E5%85%B7%E6%8F%90%E4%BE%9B%E7%9A%84API%E6%9D%A5%E8%BF%9B%E8%A1%8C%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96:">我们使用google.golang.org/protobuf/proto工具提供的API来进行序列化与反序列化:</a></p><ul><li>Marshal: 序列化</li><li>Unmarshal: 反序列化</li></ul><p>下来来模拟一个 客户端 —&gt; 服务端 基于protobuf的数据交互过程</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/protobuf/proto&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;testpb/pb&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">clientObj := &amp;pb.String&#123;Value: <span class="string">&quot;hello proto3&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化</span></span><br><span class="line">out, err := proto.Marshal(clientObj)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to encode obj:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二进制编码</span></span><br><span class="line">fmt.Println(<span class="string">&quot;encode bytes: &quot;</span>, out)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化</span></span><br><span class="line">serverObj := &amp;pb.String&#123;&#125;</span><br><span class="line">err = proto.Unmarshal(out, serverObj)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to decode obj:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;decode obj: &quot;</span>, serverObj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// encode bytes:  [10 12 104 101 108 108 111 32 112 114 111 116 111 51]</span></span><br><span class="line"><span class="comment">// decode obj:  value:&quot;hello proto3&quot;</span></span><br></pre></td></tr></table></figure><h2 id="proto3语法">proto3语法</h2><h3 id="定义消息类型">定义消息类型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">/* SearchRequest represents a search query, with pagination options to</span><br><span class="line"> * indicate which results to include in the response. */</span><br><span class="line"></span><br><span class="line">message SearchRequest &#123;</span><br><span class="line">  string query = 1;</span><br><span class="line">  int32 page_number = 2; // Which page number do we want?</span><br><span class="line">  int32 result_per_page = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一行是protobuf的版本, 我们主要讲下 message 的定义语法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;comment&gt;</span><br><span class="line"></span><br><span class="line">message  &lt;message_name&gt; &#123;</span><br><span class="line">  &lt;filed_rule&gt;  &lt;filed_type&gt; &lt;filed_name&gt; = &lt;field_number&gt; </span><br><span class="line">        类型         名称             编号  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>comment: 注射 /* */或者 //</li><li>message_name: 同一个pkg内，必须唯一</li><li>filed_rule: 可以没有, 常用的有repeated, oneof</li><li>filed_type: 数据类型, protobuf定义的数据类型, 生产代码的会映射成对应语言的数据类型</li><li>filed_name: 字段名称, 同一个message 内必须唯一</li><li>field_number: 字段的编号, 序列化成二进制数据时的字段编号, 同一个message 内必须唯一, 1 ~ 15 使用1个Byte表示, 16 ～ 2047 使用2个Byte表示</li></ul><p>如果你想保留一个编号，以备后来使用可以使用 reserved 关键字声明</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">message Foo &#123;</span><br><span class="line">  reserved 2, 15, 9 to 11;</span><br><span class="line">  reserved &quot;foo&quot;, &quot;bar&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Value-Filed-Types">Value(Filed) Types</h3><p>protobuf 定义了很多Value Types, 他和其他语言的映射关系如下:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./proto3-lang-map-1.png" alt="avatar"></p><p>上面就是所有的protobuf基础类型, 光有这些基础类型是不够的, 下面是protobuf为我们提供的一些复合类型</p><h3 id="枚举类型">枚举类型</h3><p>使用enum来声明枚举类型:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum Corpus &#123;</span><br><span class="line">    UNIVERSAL = 0;</span><br><span class="line">    WEB = 1;</span><br><span class="line">    IMAGES = 2;</span><br><span class="line">    LOCAL = 3;</span><br><span class="line">    NEWS = 4;</span><br><span class="line">    PRODUCTS = 5;</span><br><span class="line">    VIDEO = 6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>枚举声明语法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">enum &lt;enum_name&gt; &#123;</span><br><span class="line">    &lt;element_name&gt; = &lt;element_number&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>enum_name: 枚举名称</li><li>element_name: pkg内全局唯一, 很重要</li><li>element_name: 必须从0开始, 0表示类型的默认值, 32-bit integer</li></ul><h3 id="别名">别名</h3><p>如果你的确有2个同名的枚举需求: 比如 TaskStatus 和 PipelineStatus 都需要Running，就可以添加一个: option allow_alias = true;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">message MyMessage1 &#123;</span><br><span class="line">  enum EnumAllowingAlias &#123;</span><br><span class="line">    option allow_alias = true;</span><br><span class="line">    UNKNOWN = 0;</span><br><span class="line">    STARTED = 1;</span><br><span class="line">    RUNNING = 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">message MyMessage2 &#123;</span><br><span class="line">  enum EnumNotAllowingAlias &#123;</span><br><span class="line">    UNKNOWN = 0;</span><br><span class="line">    STARTED = 1;</span><br><span class="line">    // RUNNING = 1;  // Uncommenting this line will cause a compile error inside Google and a warning message outside.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="预留值">预留值</h3><p>同理枚举也支持预留值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enum Foo &#123;</span><br><span class="line">  reserved 2, 15, 9 to 11, 40 to max;</span><br><span class="line">  reserved &quot;FOO&quot;, &quot;BAR&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数组类型">数组类型</h3><p>如果我们想声明: []string, []Item 这在数组类型怎么办? filed_rule: repeated 可以胜任</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message SearchResponse &#123;</span><br><span class="line">  repeated Result results = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 会编译为:</span><br><span class="line">// type SearchResponse SearchResponse &#123;</span><br><span class="line">//    results []*Result</span><br><span class="line">// &#125;</span><br></pre></td></tr></table></figure><h3 id="Map">Map</h3><p>如果我们想声明一个map, 可以如下进行:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map&lt;string, Project&gt; projects = 3;</span><br><span class="line">// projects map[string, Project]</span><br></pre></td></tr></table></figure><p>protobuf 声明map的语法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map&lt;key_type, value_type&gt; map_field = N;</span><br></pre></td></tr></table></figure><h3 id="Oneof">Oneof</h3><p>很像范型 比如 test_oneof 字段的类型 必须是 string name 和 SubMessage sub_message 其中之一:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">message Sub1 &#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Sub2 &#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message SampleMessage &#123;</span><br><span class="line">    oneof test_oneof &#123;</span><br><span class="line">        Sub1 sub1 = 1;</span><br><span class="line">        Sub2 sub2 = 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译过后结构体</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SampleMessage <span class="keyword">struct</span> &#123;</span><br><span class="line">state         protoimpl.MessageState</span><br><span class="line">sizeCache     protoimpl.SizeCache</span><br><span class="line">unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line"><span class="comment">// Types that are assignable to TestOneof:</span></span><br><span class="line"><span class="comment">//*SampleMessage_Sub1</span></span><br><span class="line"><span class="comment">//*SampleMessage_Sub2</span></span><br><span class="line">TestOneof isSampleMessage_TestOneof <span class="string">`protobuf_oneof:&quot;test_oneof&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Any">Any</h3><p>当我们无法明确定义数据类型的时候， 可以使用Any表示:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 这里是应用其他的proto文件, 后面会讲 ipmort用法</span><br><span class="line">import &quot;google/protobuf/any.proto&quot;;</span><br><span class="line"></span><br><span class="line">message ErrorStatus &#123;</span><br><span class="line">  string message = 1;</span><br><span class="line">  repeated google.protobuf.Any details = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>any本质上就是一个bytes数据结构</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ErrorStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">state         protoimpl.MessageState</span><br><span class="line">sizeCache     protoimpl.SizeCache</span><br><span class="line">unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">Message <span class="type">string</span>       <span class="string">`protobuf:&quot;bytes,1,opt,name=message,proto3&quot; json:&quot;message,omitempty&quot;`</span></span><br><span class="line">Details []*anypb.Any <span class="string">`protobuf:&quot;bytes,2,rep,name=details,proto3&quot; json:&quot;details,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是 any的定义</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `Any` contains an arbitrary serialized protocol buffer message along with a</span></span><br><span class="line"><span class="comment">// URL that describes the type of the serialized message.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Protobuf library provides support to pack/unpack Any values in the form</span></span><br><span class="line"><span class="comment">// of utility functions or additional generated methods of the Any type.</span></span><br><span class="line"><span class="comment">//  Example 4: Pack and unpack a message in Go</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      foo := &amp;pb.Foo&#123;...&#125;</span></span><br><span class="line"><span class="comment">//      any, err := anypb.New(foo)</span></span><br><span class="line"><span class="comment">//      if err != nil &#123;</span></span><br><span class="line"><span class="comment">//        ...</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//      ...</span></span><br><span class="line"><span class="comment">//      foo := &amp;pb.Foo&#123;&#125;</span></span><br><span class="line"><span class="comment">//      if err := any.UnmarshalTo(foo); err != nil &#123;</span></span><br><span class="line"><span class="comment">//        ...</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The pack methods provided by protobuf library will by default use</span></span><br><span class="line"><span class="comment">// &#x27;type.googleapis.com/full.type.name&#x27; as the type URL and the unpack</span></span><br><span class="line"><span class="comment">// methods only use the fully qualified type name after the last &#x27;/&#x27;</span></span><br><span class="line"><span class="comment">// in the type URL, for example &quot;foo.bar.com/x/y.z&quot; will yield type</span></span><br><span class="line"><span class="comment">// name &quot;y.z&quot;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// JSON</span></span><br><span class="line"><span class="comment">// ====</span></span><br><span class="line"><span class="comment">// The JSON representation of an `Any` value uses the regular</span></span><br><span class="line"><span class="comment">// representation of the deserialized, embedded message, with an</span></span><br><span class="line"><span class="comment">// additional field `@type` which contains the type URL. Example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     package google.profile;</span></span><br><span class="line"><span class="comment">//     message Person &#123;</span></span><br><span class="line"><span class="comment">//       string first_name = 1;</span></span><br><span class="line"><span class="comment">//       string last_name = 2;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     &#123;</span></span><br><span class="line"><span class="comment">//       &quot;@type&quot;: &quot;type.googleapis.com/google.profile.Person&quot;,</span></span><br><span class="line"><span class="comment">//       &quot;firstName&quot;: &lt;string&gt;,</span></span><br><span class="line"><span class="comment">//       &quot;lastName&quot;: &lt;string&gt;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If the embedded message type is well-known and has a custom JSON</span></span><br><span class="line"><span class="comment">// representation, that representation will be embedded adding a field</span></span><br><span class="line"><span class="comment">// `value` which holds the custom JSON in addition to the `@type`</span></span><br><span class="line"><span class="comment">// field. Example (for message [google.protobuf.Duration][]):</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     &#123;</span></span><br><span class="line"><span class="comment">//       &quot;@type&quot;: &quot;type.googleapis.com/google.protobuf.Duration&quot;,</span></span><br><span class="line"><span class="comment">//       &quot;value&quot;: &quot;1.212s&quot;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> Any <span class="keyword">struct</span> &#123;</span><br><span class="line">state         protoimpl.MessageState</span><br><span class="line">sizeCache     protoimpl.SizeCache</span><br><span class="line">unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"><span class="comment">// Note: this functionality is not currently available in the official</span></span><br><span class="line"><span class="comment">// protobuf release, and it is not used for type URLs beginning with</span></span><br><span class="line"><span class="comment">// type.googleapis.com.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Schemes other than `http`, `https` (or the empty scheme) might be</span></span><br><span class="line"><span class="comment">// used with implementation specific semantics.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">TypeUrl <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,1,opt,name=type_url,json=typeUrl,proto3&quot; json:&quot;type_url,omitempty&quot;`</span></span><br><span class="line"><span class="comment">// Must be a valid serialized protocol buffer of the above specified type.</span></span><br><span class="line">Value []<span class="type">byte</span> <span class="string">`protobuf:&quot;bytes,2,opt,name=value,proto3&quot; json:&quot;value,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="类型嵌套">类型嵌套</h3><p>我们可以再message里面嵌套message</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">message Outer &#123;                  // Level 0</span><br><span class="line">  message MiddleAA &#123;  // Level 1</span><br><span class="line">    message Inner &#123;   // Level 2</span><br><span class="line">      int64 ival = 1;</span><br><span class="line">      bool  booly = 2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  message MiddleBB &#123;  // Level 1</span><br><span class="line">    message Inner &#123;   // Level 2</span><br><span class="line">      int32 ival = 1;</span><br><span class="line">      bool  booly = 2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与Go结构体嵌套一样, 但是不允许 匿名嵌套, 必须指定字段名称</p><h3 id="引用包">引用包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 这里是应用其他的proto文件,  ipmort用法</span><br><span class="line">import &quot;google/protobuf/any.proto&quot;;</span><br></pre></td></tr></table></figure><p>上面这在情况就是读取的标准库, 我们在安装protoc的时候, 已经把改lib 挪到usr/local/include下面了，所以可以找到</p><p>如果我们proto文件并没有在/usr/local/include目录下, 我们如何导入，比如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;myproject/other_protos.proto&quot;;</span><br></pre></td></tr></table></figure><p>通过-I 可以添加搜索的路径, 这样就编译器就可以找到我们引入的包了</p><p>引入后通过包的名称.变量的方式使用</p><p>比如我们要应用该结构中的ErrorStatus</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">// 这里是应用其他的proto文件, 后面会讲 ipmort用法</span><br><span class="line">import &quot;google/protobuf/any.proto&quot;;</span><br><span class="line"></span><br><span class="line">package hello;</span><br><span class="line">option go_package=&quot;gitee.com/infraboard/go-course/day21/pb&quot;;</span><br><span class="line"></span><br><span class="line">message ErrorStatus &#123;</span><br><span class="line">  string message = 1;</span><br><span class="line">  repeated google.protobuf.Any details = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引入ErrorStatus</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">// 由于这个文件的pkg 也叫hello, 因此我们可以不用添加 pkg前缀</span><br><span class="line">//  如果不是同一个pkg 就需要添加 pkg名称前缀, 比如hello.ErrorStatus</span><br><span class="line">import &quot;pb/any.proto&quot;;</span><br><span class="line"></span><br><span class="line">package hello;</span><br><span class="line">option go_package=&quot;gitee.com/infraboard/go-course/day21/pb&quot;;</span><br><span class="line"></span><br><span class="line">message ErrorStatusExt &#123;</span><br><span class="line">    ErrorStatus error_status = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go语言RPC</title>
      <link href="/20230219/golang-20230219-go%E8%AF%AD%E8%A8%80RPC/"/>
      <url>/20230219/golang-20230219-go%E8%AF%AD%E8%A8%80RPC/</url>
      
        <content type="html"><![CDATA[<h2 id="概念">概念</h2><p>RPC是远程过程调用的简称，是分布式系统中不同节点间流行的通信方式。在互联网时代，RPC已经和IPC一样成为一个不可或缺的基础构件。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./rpc-model.png" alt="avatar"></p><ul><li>RPC传输协议</li><li>消息序列化与反序列化</li></ul><p>下面是一个基于HTTP的 JSON的 RPC:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./rpc-http-model.png" alt="avatar"></p><h2 id="Go语言RPC">Go语言RPC</h2><p>Go语言的标准库也提供了一个简单的RPC实现, 包的路径为net/rpc，也就是放在了net包目录下面。因此我们可以猜测该RPC包是建立在net包基础之上的</p><p>由上图可知一个rpc服务由2个部分组成:</p><ul><li>server</li><li>client</li></ul><h2 id="基础的RPC服务">基础的RPC服务</h2><h3 id="RPC-Server">RPC Server</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hello的逻辑 就是 将对方发送的消息前面添加一个Hello 然后返还给对方</span></span><br><span class="line"><span class="comment">// 由于我们是一个rpc服务, 因此参数上面还是有约束：</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//第一个参数是请求</span></span><br><span class="line"><span class="comment">//第二个参数是响应</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 可以类比Http handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">*reply = fmt.Sprintf(<span class="string">&quot;hello, %s&quot;</span>, request)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 把我们的对象注册成一个rpc的 receiver</span></span><br><span class="line"><span class="comment">// 其中rpc.Register函数调用会将对象类型中所有满足RPC规则的对象方法注册为RPC函数，</span></span><br><span class="line"><span class="comment">// 所有注册的方法会放在“HelloService”服务空间之下</span></span><br><span class="line">rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, &amp;HelloService&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后我们建立一个唯一的TCP链接</span></span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;ListenTCP error:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过rpc.ServeConn函数在该TCP链接上为对方提供RPC服务。</span></span><br><span class="line"><span class="comment">// 每Accept一个请求，就创建一个goroutie进行处理</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> rpc.ServeConn(conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>RPC Client</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 首先是通过rpc.Dial拨号RPC服务, 建立连接</span></span><br><span class="line">client, err := rpc.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后通过client.Call调用具体的RPC方法</span></span><br><span class="line"><span class="comment">// 在调用client.Call时:</span></span><br><span class="line"><span class="comment">// 第一个参数是用点号链接的RPC服务名字和方法名字，</span></span><br><span class="line"><span class="comment">// 第二个参数是 请求参数</span></span><br><span class="line"><span class="comment">//      第三个是请求响应, 必须是一个指针, 由底层rpc服务帮你赋值</span></span><br><span class="line">err = client.Call(<span class="string">&quot;HelloService.Hello&quot;</span>, <span class="string">&quot;ZHANGSAN&quot;</span>, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;reply: %v\n&quot;</span>, reply)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>rpc服务最多的优点就是 我们可以像使用本地函数一样使用 远程服务上的函数, 因此有几个关键点:</p><ul><li>远程连接: 类似于我们的pkg</li><li>函数名称: 要表用的函数名称</li><li>函数参数: 这个需要符合RPC服务的调用签名, 及第一个参数是请求，第二个参数是响应</li><li>函数返回: rpc函数的返回是 连接异常信息, 真正的业务Response不能作为返回值</li></ul><h2 id="基于接口的RPC">基于接口的RPC</h2><p>interface</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HelloServiceName = <span class="string">&quot;HelloService&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">interface</span> &#123;</span><br><span class="line">Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>server</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/service&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ service.HelloService = <span class="built_in">new</span>(HelloService)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">*reply = fmt.Sprintf(<span class="string">&quot;hello, %s&quot;</span>, request)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;ListenTCP error:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, <span class="built_in">new</span>(HelloService))</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> rpc.ServeConn(conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>client</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/service&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ service.HelloService = <span class="built_in">new</span>(HelloServiceClient)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServiceClient <span class="keyword">struct</span> &#123;</span><br><span class="line">client *rpc.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *HelloServiceClient)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">err := c.client.Call(fmt.Sprintf(<span class="string">&quot;%s.Hello&quot;</span>, service.HelloServiceName), <span class="string">&quot;alice&quot;</span>, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHelloServiceClient</span><span class="params">(net, address <span class="type">string</span>)</span></span> (*HelloServiceClient, <span class="type">error</span>) &#123;</span><br><span class="line">client, err := rpc.Dial(net, address)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;HelloServiceClient&#123;</span><br><span class="line">client: client,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">client, err := NewHelloServiceClient(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line">err = client.Hello(<span class="string">&quot;alice&quot;</span>, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gob编码">gob编码</h2><p>标准库的RPC默认采用Go语言特有的gob编码, 标准库gob是golang提供的“私有”的编解码方式，它的效率会比json，xml等更高，特别适合在Go语言程序间传递数据</p><p>gob的使用很简单, 和之前使用base64编码理念一样, 有 Encoder和Decoder</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GobEncode</span><span class="params">(val <span class="keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">buf := bytes.NewBuffer([]<span class="type">byte</span>&#123;&#125;)</span><br><span class="line">encoder := gob.NewEncoder(buf)</span><br><span class="line"><span class="keyword">if</span> err := encoder.Encode(val); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>&#123;&#125;, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> buf.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GobDecode</span><span class="params">(data []<span class="type">byte</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">reader := bytes.NewReader(data)</span><br><span class="line">decoder := gob.NewDecoder(reader)</span><br><span class="line"><span class="keyword">return</span> decoder.Decode(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写个测试用例测测</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGobEncode</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">should := assert.New(t)</span><br><span class="line">t1 := &amp;TestStruct&#123;Name: <span class="string">&quot;张三&quot;</span>, Value: <span class="number">10</span>&#125;</span><br><span class="line">b, err := service.GobEncode(t1)</span><br><span class="line"><span class="keyword">if</span> should.NoError(err) &#123;</span><br><span class="line">s := strings.Replace(strings.Trim(fmt.Sprint(b), <span class="string">&quot;[]&quot;</span>), <span class="string">&quot; &quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="number">-1</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGobDecode</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">should := assert.New(t)</span><br><span class="line">t2 := &amp;TestStruct&#123;&#125;</span><br><span class="line">data := []<span class="type">byte</span>&#123;<span class="number">43</span>, <span class="number">255</span>, <span class="number">129</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">117</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">255</span>, <span class="number">130</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">78</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">255</span>, <span class="number">130</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">229</span>, <span class="number">188</span>, <span class="number">160</span>, <span class="number">228</span>, <span class="number">184</span>, <span class="number">137</span>, <span class="number">1</span>, <span class="number">20</span>, <span class="number">0</span>&#125;</span><br><span class="line">err := service.GobDecode(data, t2)</span><br><span class="line"><span class="keyword">if</span> should.NoError(err) &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;t2: %+v\n&quot;</span>, t2)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Json-ON-TCP">Json ON TCP</h2><p>gob是golang提供的“私有”的编解码方式，因此从其它语言调用Go语言实现的RPC服务将比较困难</p><p>因此我们可以选用所有语言都支持的比较好的一些编码:</p><ul><li>MessagePack: 高效的二进制序列化格式。它允许你在多种语言(如JSON)之间交换数据。但它更快更小</li><li>JSON: 文本编码</li><li>XML：文本编码</li><li>Protobuf 二进制编码</li></ul><p>Go语言的RPC框架有两个比较有特色的设计：</p><ul><li>RPC数据打包时可以通过插件实现自定义的编码和解码；</li><li>RPC建立在抽象的io.ReadWriteCloser接口之上的，我们可以将RPC架设在不同的通讯协议之上。</li></ul><p>这里我们将尝试通过官方自带的net/rpc/jsonrpc扩展实现一个跨语言的RPC。</p><p>server</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/jsonrpc_tcp/service&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ service.HelloService = <span class="built_in">new</span>(HelloService)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">*reply = fmt.Sprintf(<span class="string">&quot;hello, %s&quot;</span>, request)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;ListenTCP error:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, <span class="built_in">new</span>(HelloService))</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用jsonrpc进行编码</span></span><br><span class="line"><span class="keyword">go</span> rpc.ServeCodec(jsonrpc.NewServerCodec(conn))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>client</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/jsonrpc_tcp/service&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ service.HelloService = <span class="built_in">new</span>(HelloServiceClient)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServiceClient <span class="keyword">struct</span> &#123;</span><br><span class="line">client *rpc.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *HelloServiceClient)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">err := c.client.Call(fmt.Sprintf(<span class="string">&quot;%s.Hello&quot;</span>, service.HelloServiceName), <span class="string">&quot;alice&quot;</span>, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHelloServiceClient</span><span class="params">(network, address <span class="type">string</span>)</span></span> (*HelloServiceClient, <span class="type">error</span>) &#123;</span><br><span class="line">conn, err := net.Dial(network, address)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用jsonrpc进行解码</span></span><br><span class="line">client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn))</span><br><span class="line"><span class="keyword">return</span> &amp;HelloServiceClient&#123;</span><br><span class="line">client: client,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">client, err := NewHelloServiceClient(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line">err = client.Hello(<span class="string">&quot;alice&quot;</span>, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(reply)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用nc模拟访问</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]<span class="comment"># echo -e &#x27;&#123;&quot;method&quot;:&quot;HelloService.Hello&quot;,&quot;params&quot;:[&quot;zhangsan&quot;],&quot;id&quot;:1&#125;&#x27; | nc 192.168.10.1 1234</span></span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:1,<span class="string">&quot;result&quot;</span>:<span class="string">&quot;hello, zhangsan&quot;</span>,<span class="string">&quot;error&quot;</span>:null&#125;</span><br></pre></td></tr></table></figure><h2 id="Json-ON-HTTP">Json ON HTTP</h2><p>Go语言内在的RPC框架已经支持在Http协议上提供RPC服务, 为了支持跨语言，编码我们依然使用Json</p><p>新的RPC服务其实是一个类似REST规范的接口，接收请求并采用相应处理流程</p><p>首先我们依然要解决JSON编解码的问题, 我们需要将HTTP接口的Handler参数传递给jsonrpc, 因此需要满足jsonrpc接口, 因此我们需要提前构建也给conn io.ReadWriteCloser, writer现成的 reader就是request的body, 直接内嵌就可以</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRPCReadWriteCloserFromHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> *RPCReadWriteCloser &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;RPCReadWriteCloser&#123;w, r.Body&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RPCReadWriteCloser <span class="keyword">struct</span> &#123;</span><br><span class="line">io.Writer</span><br><span class="line">io.ReadCloser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>server</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line"><span class="string">&quot;test-grpc/jsonrpc_http/service&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ service.HelloService = <span class="built_in">new</span>(HelloService)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">*reply = fmt.Sprintf(<span class="string">&quot;hello, %s&quot;</span>, request)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Calc(req *service.CalcRequest, reply *<span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">*reply = req.A + req.B</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RPCReadWriteCloser <span class="keyword">struct</span> &#123;</span><br><span class="line">io.Writer</span><br><span class="line">io.ReadCloser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRPCReadWriteCloserFromHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> *RPCReadWriteCloser &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;RPCReadWriteCloser&#123;w, r.Body&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, <span class="built_in">new</span>(HelloService))</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/jsonrpc&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 使用jsonrpc进行编码</span></span><br><span class="line">rpc.ServeCodec(jsonrpc.NewServerCodec(NewRPCReadWriteCloserFromHTTP(w, r)))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">err := http.ListenAndServe(<span class="string">&quot;:1234&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>验证</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]<span class="comment"># curl -X POST -d &#x27;&#123;&quot;method&quot;:&quot;HelloService.Hello&quot;,&quot;params&quot;:[&quot;hello&quot;],&quot;id&quot;:1&#125;&#x27; 192.168.10.1:1234/jsonrpc</span></span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:1,<span class="string">&quot;result&quot;</span>:<span class="string">&quot;hello, hello&quot;</span>,<span class="string">&quot;error&quot;</span>:null&#125;</span><br><span class="line">[root@control ~]<span class="comment"># curl -X POST -d &#x27;&#123;&quot;method&quot;:&quot;HelloService.Calc&quot;,&quot;params&quot;:[&#123;&quot;a&quot;:1,&quot;b&quot;:2&#125;],&quot;id&quot;:2&#125;&#x27; 192.168.10.1:1234/jsonrpc</span></span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:2,<span class="string">&quot;result&quot;</span>:3,<span class="string">&quot;error&quot;</span>:null&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang命令行</title>
      <link href="/20230211/golang-20230211-golang%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
      <url>/20230211/golang-20230211-golang%E5%91%BD%E4%BB%A4%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="flag">flag</h2><p><strong>案例</strong></p><p>使用阿里云oss实现文件中转站</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/aliyun/aliyun-oss-go-sdk/oss&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">endpint        = <span class="string">&quot;oss-cn-beijing.aliyuncs.com&quot;</span></span><br><span class="line">ak             = <span class="string">&quot;xx&quot;</span></span><br><span class="line">sk             = <span class="string">&quot;xx&quot;</span></span><br><span class="line">bucketName     = <span class="string">&quot;clouds-station&quot;</span></span><br><span class="line">uploadFilePath = <span class="string">&quot;&quot;</span></span><br><span class="line">help           <span class="type">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">usage</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Fprintf(os.Stderr, <span class="string">`Usage: cloud-station -f &lt;uplaod_file_path&gt;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line">flag.PrintDefaults()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadParam</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">flag.BoolVar(&amp;help, <span class="string">&quot;h&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;help usage&quot;</span>)</span><br><span class="line">flag.StringVar(&amp;uploadFilePath, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;upload file path&quot;</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> uploadFilePath == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">usage()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> help &#123;</span><br><span class="line">usage()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(filePath <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">client, err := oss.New(endpint, ak, sk)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bucket, err := client.Bucket(bucketName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个参数: 上传到oss里面的文件的key(路径)</span></span><br><span class="line"><span class="comment">// 第二个参数: 需要上传的文件的路径</span></span><br><span class="line">err = bucket.PutObjectFromFile(filePath, filePath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印下载URL</span></span><br><span class="line"><span class="comment">// sts, 临时授权token(有效期1天)</span></span><br><span class="line">signedURL, err := bucket.SignURL(filePath, oss.HTTPGet, <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;sign file download url error, %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;upload file: %s success\n&quot;</span>, uploadFilePath)</span><br><span class="line">fmt.Printf(<span class="string">&quot;下载链接: %s\n&quot;</span>, signedURL)</span><br><span class="line">fmt.Println(<span class="string">&quot;\n注意: 文件下载有效期为1天, 中转站保存时间为3天, 请及时下载&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 读取用户输入的参数</span></span><br><span class="line">loadParam()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行文件上传</span></span><br><span class="line"><span class="keyword">if</span> err := upload(uploadFilePath); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;upload file error, %s\n&quot;</span>, err)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="cobra">cobra</h2><p>第三方库：<a href="http://github.com/spf13/cobra">github.com/spf13/cobra</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> RootCmd = &amp;cobra.Command&#123;</span><br><span class="line">Use:     <span class="string">&quot;cloud-station-cli&quot;</span>,</span><br><span class="line">Long:    <span class="string">&quot;欢迎使用云存储文件中转站&quot;</span>,</span><br><span class="line">Short:   <span class="string">&quot;欢迎使用云存储文件中转站&quot;</span>,</span><br><span class="line">Example: <span class="string">&quot;cloud-station-cli cmds&quot;</span>,</span><br><span class="line">RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> version &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;cloud-station cli v0.0.1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">version <span class="type">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">RootCmd.PersistentFlags().BoolVarP(&amp;version, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;show version&quot;</span>)</span><br><span class="line">    UploadCmd.PersistentFlags().StringVarP(&amp;accessKey, <span class="string">&quot;access_id&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;the ali oss access id&quot;</span>)</span><br><span class="line">UploadCmd.PersistentFlags().StringVarP(&amp;secretKey, <span class="string">&quot;secret_key&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;the ali oss access key&quot;</span>)</span><br><span class="line">UploadCmd.PersistentFlags().StringVarP(&amp;ossProvider, <span class="string">&quot;oss_provider&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;aliyun&quot;</span>, <span class="string">&quot;the oss provider [aliyun/qcloud]&quot;</span>)</span><br><span class="line">UploadCmd.PersistentFlags().StringVarP(&amp;ossEndpoint, <span class="string">&quot;oss_endpoint&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;oss-cn-beijing.aliyuncs.com&quot;</span>, <span class="string">&quot;oss store endpointer&quot;</span>)</span><br><span class="line">UploadCmd.PersistentFlags().StringVarP(&amp;bucketName, <span class="string">&quot;bucket_name&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;devcloud-station&quot;</span>, <span class="string">&quot;bucket name&quot;</span>)</span><br><span class="line">UploadCmd.PersistentFlags().StringVarP(&amp;uploadFile, <span class="string">&quot;upload_file&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;upload file&quot;</span>)</span><br><span class="line">RootCmd.AddCommand(UploadCmd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> UploadCmd = &amp;cobra.Command&#123;</span><br><span class="line">Use:     <span class="string">&quot;upload&quot;</span>,</span><br><span class="line">Long:    <span class="string">&quot;upload 文件上传&quot;</span>,</span><br><span class="line">Short:   <span class="string">&quot;upload 文件上传&quot;</span>,</span><br><span class="line">Example: <span class="string">&quot;upload -f filename&quot;</span>,</span><br><span class="line">RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// 设置ak默认值</span></span><br><span class="line">setAk()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">uploader store.Uploader</span><br><span class="line">err      <span class="type">error</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">switch</span> ossProvider &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;aliyun&quot;</span>:</span><br><span class="line">uploader, err = aliyun.NewAliOssStore(ossEndpoint, accessKey, secretKey)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;qcloud&quot;</span>:</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;not support oss storage provider&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用uploader上传</span></span><br><span class="line"><span class="keyword">return</span> uploader.Upload(bucketName, uploadFile, uploadFile)</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := RootCmd.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="加密输入">加密输入</h2><p>第三方库：<a href="https://github.com/go-survey/survey">https://github.com/go-survey/survey</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/AlecAivazis/survey/v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> aliSecretKey <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">getSecretKeyFromInputV2()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSecretKeyFromInputV2</span><span class="params">()</span></span> &#123;</span><br><span class="line">prompt := &amp;survey.Password&#123;</span><br><span class="line">Message: <span class="string">&quot;请输入access key: &quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;aliSecretKey)</span><br><span class="line">fmt.Printf(<span class="string">&quot;aliSecretKey: %v\n&quot;</span>, aliSecretKey)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>运行</strong><br>PS C:\Users\ren\Desktop\新建文件夹&gt; go run .\main.go<br>? 请输入access key:  *******</p><h2 id="进度条">进度条</h2><p>UI库：<a href="http://github.com/schollz/progressbar">github.com/schollz/progressbar</a></p><p><strong>阿里云oss sdk上传进度条实现</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> aliyun</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/aliyun/aliyun-oss-go-sdk/oss&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/schollz/progressbar/v3&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProgressListener <span class="keyword">struct</span> &#123;</span><br><span class="line">bar *progressbar.ProgressBar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ProgressListener)</span></span> ProgressChanged(event *oss.ProgressEvent) &#123;</span><br><span class="line"><span class="keyword">switch</span> event.EventType &#123;</span><br><span class="line"><span class="keyword">case</span> oss.TransferStartedEvent:</span><br><span class="line">p.bar = progressbar.DefaultBytes(</span><br><span class="line">event.TotalBytes,</span><br><span class="line"><span class="string">&quot;文件上传中&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">case</span> oss.TransferDataEvent:</span><br><span class="line">p.bar.Add64(event.RwBytes)</span><br><span class="line"><span class="keyword">case</span> oss.TransferCompletedEvent:</span><br><span class="line">fmt.Printf(<span class="string">&quot;\n上传完成\n&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> oss.TransferFailedEvent:</span><br><span class="line">fmt.Printf(<span class="string">&quot;\n上传失败\n&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultProgressListener</span><span class="params">()</span></span> *ProgressListener &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;ProgressListener&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>文件上传中 100% |███████████████████████████| (1.9/1.9 kB, 86.513 kB/s)</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang数据库编程</title>
      <link href="/20230129/golang-20230129-golang%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/"/>
      <url>/20230129/golang-20230129-golang%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="SQL语法简介">SQL语法简介</h2><p>  SQL(i/ˈsiːkwəl/; Structured Query Language)是一套语法标准，不区分大小写。MySQL、sql-server和Oracle都是关系型数据库，在一些高级语法上跟标准SQL略有出入。</p><p>以管理员登录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h localhost -P 3306 -u root -p&#x27;123456&#x27;</span><br></pre></td></tr></table></figure><ul><li>-h：mysql server host，不写时默认是localhost。</li><li>-P：mysql server port，不写时默认是3306。</li><li>-u：user name，-u后可以加空格也可以不加。</li><li>-p：password，密码中可能包含空格，所以要加引号。高版本的mysql不允许在命令行中直接输入密码，此时只输入-p后面不要写密码即可。</li></ul><p>创建表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> auto_increment comment <span class="string">&#x27;主键自增id&#x27;</span>,</span><br><span class="line">    name <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    province <span class="type">char</span>(<span class="number">6</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">    city <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    addr <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">    score <span class="type">float</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;考试成绩&#x27;</span>,</span><br><span class="line">    enrollment <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (id),  <span class="keyword">unique</span> key idx_name (name),  </span><br><span class="line">    key idx_location (province,city)</span><br><span class="line">)<span class="keyword">default</span> charset<span class="operator">=</span>utf8 comment <span class="string">&#x27;学员基本信息&#x27;</span>;</span><br></pre></td></tr></table></figure><p>新增记录，必须给not null且无default值的列赋值。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (name,province,city,enrollment) <span class="keyword">values</span></span><br><span class="line">    (<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;2021-03-05&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;河南&#x27;</span>,<span class="string">&#x27;郑州&#x27;</span>,<span class="string">&#x27;2021-04-25&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;小丽&#x27;</span>,<span class="string">&#x27;四川&#x27;</span>,<span class="string">&#x27;成都&#x27;</span>,<span class="string">&#x27;2021-03-10&#x27;</span>);</span><br></pre></td></tr></table></figure><p>查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> province,<span class="built_in">avg</span>(score) <span class="keyword">as</span> avg_score <span class="keyword">from</span> student </span><br><span class="line">    <span class="keyword">where</span> score<span class="operator">&gt;</span><span class="number">0</span> </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> province <span class="keyword">having</span> avg_score<span class="operator">&gt;</span><span class="number">50</span> </span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> avg_score <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><p>修改</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> score<span class="operator">=</span>score<span class="operator">+</span><span class="number">10</span>,addr<span class="operator">=</span><span class="string">&#x27;海淀&#x27;</span> <span class="keyword">where</span> province<span class="operator">=</span><span class="string">&#x27;北京&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span></span><br><span class="line">    score<span class="operator">=</span><span class="keyword">case</span> province</span><br><span class="line">        <span class="keyword">when</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">then</span> score<span class="operator">+</span><span class="number">10</span>     </span><br><span class="line">        <span class="keyword">when</span> <span class="string">&#x27;四川&#x27;</span> <span class="keyword">then</span> score<span class="operator">+</span><span class="number">5</span> </span><br><span class="line">        <span class="keyword">else</span> score<span class="operator">+</span><span class="number">7</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    addr<span class="operator">=</span><span class="keyword">case</span> province</span><br><span class="line">        <span class="keyword">when</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;东城区&#x27;</span>        </span><br><span class="line">        <span class="keyword">when</span> <span class="string">&#x27;四川&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;幸福里&#x27;</span>        </span><br><span class="line">        <span class="keyword">else</span> <span class="string">&#x27;朝阳区&#x27;</span>    </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>删除</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> student <span class="keyword">where</span> city<span class="operator">=</span> <span class="string">&#x27;郑州&#x27;</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> student;<span class="comment">--删除表里的所有行</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> student;    <span class="comment">--删除表</span></span><br></pre></td></tr></table></figure><h2 id="MySQL最佳实践">MySQL最佳实践</h2><ul><li>写sql时一律使用小写。</li><li>建表时先判断表是否已存在if not exists。</li><li>所有的列和表都加comment。</li><li>字符串长度比较短时尽量使用char，定长有利于内存对齐，读写性能更好，而varchar字段频繁修改时容易产生内存碎片。</li><li>满足需求的前提下尽量使用短的数据类型，如tinyint vs int, float vs double, date vs datetime。</li></ul><p><strong>null</strong></p><ul><li>default null有别于default ''和default 0</li><li>is null, is not null有别于!= ‘’, !=0</li><li>尽量设为not null<ul><li>有些DB索引列不允许包含null</li><li>对含有null的列进行统计，结果可能不符合预期</li><li>null值有时候会严重拖慢系统性能</li></ul></li></ul><p><strong>索引</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./b_tree.png width=400 />     <ol><li>B即Balance，对于m叉树每个节点上最多有m个数据，最少有m/2个数据（根节点除外）。</li><li>叶节点上存储了所有数据，把叶节点链接起来可以顺序遍历所有数据。</li><li>每个节点设计成内存页的整倍数。MySQL的m=1200，树的前两层放在内存中。</li></ol><ul><li>MySQL索引默认使用B+树。（思考：为什么不用hash table？）</li><li>主键默认会加索引。按主键构建的B+树里包含所有列的数据，而普通索引的B+树里只存储了主键，还需要再查一次主键对应的B+树（回表）。</li><li>联合索引的前缀同样具有索引的效果。</li><li>sql语句前加explain可以查看索引使用情况。</li><li>如果MySQL没有选择最优的索引方案，可以在where前force index (index_name)。</li></ul><p>规避慢查询</p><ul><li>大部分的慢查询都是因为没有正确地使用索引。查看一条SQL语句使用索引的情况只需要在SQL前加个explain。</li><li>一次select不要超过1000行。</li><li>分页查询limit m,n会检索前m+n行，只是返回后n行，通常用id&gt;x来代替这种分页方式（stmt一节会展示遍历整个table的正确姿势）。</li><li>批量操作时最好一条sql语句搞定；其次打包成一个事务，一次性提交(高并发情况下减少对共享资源的争用)。</li><li>不要使用连表操作，join逻辑在业务代码里完成。</li></ul><h2 id="Go-SQL驱动接口解读">Go SQL驱动接口解读</h2><p>  Go官方没有提供数据库驱动，而是为开发数据库驱动定义了一些标准接口（即database/sql ），开发者可以根据定义的接口来开发相应的数据库驱动。Go中支持MySQL的驱动比较多，如</p><ul><li><a href="http://github.com/go-sql-driver/mysql">github.com/go-sql-driver/mysql</a> 支持 database/sql</li><li><a href="http://github.com/ziutek/mymysql">github.com/ziutek/mymysql</a> 支持 database/sql，也支持自定义的接口</li><li><a href="http://github.com/Philio/GoMySQL">github.com/Philio/GoMySQL</a> 不支持 database/sql，自定义接口</li></ul><p><strong>Driver</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Driver <span class="keyword">interface</span> &#123; </span><br><span class="line">    Open(name <span class="type">string</span>) (Conn, <span class="type">error</span>) </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> d = Driver&#123;proto: <span class="string">&quot;tcp&quot;</span>, raddr: <span class="string">&quot;127.0.0.1:3306&quot;</span>&#125;</span><br><span class="line">sql.Register(<span class="string">&quot;mysql&quot;</span>, &amp;d)    <span class="comment">//注册数据库驱动</span></span><br></pre></td></tr></table></figure><p><strong>Conn</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Conn <span class="keyword">interface</span> &#123;</span><br><span class="line">    Prepare(query <span class="type">string</span>) (Stmt, <span class="type">error</span>)  <span class="comment">//把一个查询query传给Prepare，返回Stmt(statement)</span></span><br><span class="line">    Close() <span class="type">error</span>  <span class="comment">//关闭数据库连接</span></span><br><span class="line">    Begin() (Tx, <span class="type">error</span>)  <span class="comment">//返回一个事务Tx(transaction)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Stmt</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stmt <span class="keyword">interface</span> &#123;</span><br><span class="line">    Close() <span class="type">error</span>  <span class="comment">//关闭当前的链接状态</span></span><br><span class="line">    NumInput() <span class="type">int</span>  <span class="comment">//返回当前预留参数的个数</span></span><br><span class="line">    Exec(args []Value) (Result, <span class="type">error</span>)  <span class="comment">//执行Prepare准备好的 sql，传入参数执行 update/insert 等操作，返回 Result 数据</span></span><br><span class="line">    Query(args []Value) (Rows, <span class="type">error</span>)  <span class="comment">//执行Prepare准备好的 sql，传入需要的参数执行 select 操作，返回 Rows 结果集</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Tx</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Tx <span class="keyword">interface</span> &#123;</span><br><span class="line">    Commit() <span class="type">error</span>  <span class="comment">//提交事务</span></span><br><span class="line">    Rollback() <span class="type">error</span>  <span class="comment">//回滚事务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Result</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Result <span class="keyword">interface</span> &#123;</span><br><span class="line">    LastInsertId() (<span class="type">int64</span>, <span class="type">error</span>)  <span class="comment">//返回由数据库执行插入操作得到的自增ID号。如果使用单个INSERT将多行插入到表中，则LastInsertId是第一条数据使用的id</span></span><br><span class="line">    RowsAffected() (<span class="type">int64</span>, <span class="type">error</span>)  <span class="comment">//返回操作影响的数据条目数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>RowsAffected</strong><br>  RowsAffected是int64的别名，它实现了Result接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RowsAffected <span class="type">int64</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(RowsAffected)</span></span> LastInsertId() (<span class="type">int64</span>, <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v RowsAffected)</span></span> RowsAffected() (<span class="type">int64</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p><strong>Rows</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Rows <span class="keyword">interface</span> &#123;</span><br><span class="line">    Columns() []<span class="type">string</span>  <span class="comment">//查询所需要的表字段</span></span><br><span class="line">    Close() <span class="type">error</span>  <span class="comment">//关闭迭代器</span></span><br><span class="line">    Next(dest []Value) <span class="type">error</span>  <span class="comment">//返回下一条数据，把数据赋值给dest，dest里面的元素必须是 driver.Value的值。如果最后没数据了，Next 函数返回 io.EOF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Value</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>  Value 要么是 nil，要么是下面的任意一种</p><ul><li>int64</li><li>float64</li><li>bool</li><li>[]byte</li><li>string</li><li>time.Time<br><strong>ValueConverter</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ValueConverter <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">//把数据库里的数据类型转换成Value允许的数据类型</span></span><br><span class="line">    ConvertValue(v <span class="keyword">interface</span>&#123;&#125;) (Value, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据库增删改查">数据库增删改查</h2><p>下载第三方库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/go-sql-driver/mysql</span><br></pre></td></tr></table></figure><p>连接数据库</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:@tcp(localhost:3306)/test?charset=utf8&quot;</span>)</span><br></pre></td></tr></table></figure><p>  DSN(data source name)格式：<br>[username[:password]@][protocol[(address)]]/dbname[?param1=value1&amp;…&amp;paramN=valueN]<br>  例如user:password@tcp(localhost:5555)/dbname?charset=utf8mb4&amp;parseTime=True<br>  如果是本地MySQl，且采用默认的3306端口，可简写为：user:password@/dbname<br>连接参数<br>  要支持完整的UTF-8编码，您需要将charset=utf8更改为charset=utf8mb4<br>  想要正确的处理time.Time ，您需要带上parseTime参数<br>增删改</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*sql.DB)</span></span>.Exec(sql <span class="type">string</span>) (sql.Result, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>查</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*sql.DB)</span></span>.Query(sql <span class="type">string</span>) (*sql.Rows, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>crud.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckError</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert 插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//一条sql，插入2行记录</span></span><br><span class="line">res, err := db.Exec(<span class="string">&quot;insert into student (name,province,city,enrollment) values (&#x27;小明&#x27;, &#x27;深圳&#x27;, &#x27;深圳&#x27;, &#x27;2021-04-18&#x27;), (&#x27;小红&#x27;, &#x27;上海&#x27;, &#x27;上海&#x27;, &#x27;2021-04-26&#x27;)&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//ID自增，用过的id（即使对应的行已delete）不会重复使用。如果使用单个INSERT语句将多行插入到表中，则LastInsertId是第一条数据使用的id</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after insert last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//插入2行，所以影响了2行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// replace 插入(覆盖)数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replace</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//由于name字段上有唯一索引，insert重复的name会报错。而使用replace会先删除，再插入</span></span><br><span class="line">res, err := db.Exec(<span class="string">&quot;replace into student (name,province,city,enrollment) values (&#x27;小明&#x27;, &#x27;深圳&#x27;, &#x27;深圳&#x27;, &#x27;2021-04-20&#x27;), (&#x27;小红&#x27;, &#x27;上海&#x27;, &#x27;上海&#x27;, &#x27;2021-04-26&#x27;)&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//ID自增，用过的id（即使对应的行已delete）不会重复使用</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after insert last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//先删除，后插入，影响了4行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update 修改数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//不同的city加不同的分数</span></span><br><span class="line">res, err := db.Exec(<span class="string">&quot;update student set score=score+10 where city=&#x27;上海&#x27;&quot;</span>) <span class="comment">//上海加10分</span></span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//0, 仅插入操作才会给LastInsertId赋值</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after update last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//where city=?命中了几行，就会影响几行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;update affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query 查询数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">rows, err := db.Query(<span class="string">&quot;select id,name,city,score,enrollment from student where id&gt;2&quot;</span>) <span class="comment">//查询得分大于2的记录</span></span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123; <span class="comment">//没有数据或发生error时返回false</span></span><br><span class="line"><span class="keyword">var</span> id <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> score <span class="type">float32</span></span><br><span class="line"><span class="keyword">var</span> name, city <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> enrollment time.Time</span><br><span class="line">err = rows.Scan(&amp;id, &amp;name, &amp;city, &amp;score, &amp;enrollment) <span class="comment">//通过scan把db里的数据赋给go变量</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, score=%.2f, name=%s, city=%s enrollment=%s \n&quot;</span>, id, score, name, city, enrollment.Format(<span class="string">&quot;2006-01-02&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delete 删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delete</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">res, err := db.Exec(<span class="string">&quot;delete from student where id&gt;13&quot;</span>) <span class="comment">//删除得分大于13的记录</span></span><br><span class="line">CheckError(err)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//where id&gt;13命中了几行，就会影响几行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx@tcp(192.168.10.10:3306)/testops?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">// delete(db)</span></span><br><span class="line"><span class="comment">// insert(db)</span></span><br><span class="line"><span class="comment">// replace(db)</span></span><br><span class="line">update(db)</span><br><span class="line"><span class="comment">// query(db)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="stmt">stmt</h2><p>  首先看两个sql注入攻击的例子。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;select username,password from user where username=&#x27;&quot;</span> + username + <span class="string">&quot;&#x27; and password=&#x27;&quot;</span> + password + <span class="string">&quot;&#x27;&quot;</span>; </span><br></pre></td></tr></table></figure><p>  变量username和password从前端输入框获取，如果用户输入的username为lily， password为aaa’ or ‘1’='1，则完整的sql为select username,password from user where username=‘lily’ and password=‘aaa’ or ‘1’=‘1’。会返回表里的所有记录，如果记录数大于0就允许登录，则lily的账号被盗。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql=<span class="string">&quot;insert into student (name) values (&#x27;&quot;</span>+username+<span class="string">&quot; &#x27;) &quot;</span>;</span><br></pre></td></tr></table></figure><p>  变量username从前端输入框获取，如果用户输入的username为lily’); drop table student;–。完整sql为insert into student (name) values (‘lily’); drop table student;–‘)。通过注释符–屏蔽掉了末尾的’)，删除了整个表。<br>防止sql注入的方法：</p><ul><li>前端输入要加正则校验、长度限制。</li><li>对特殊符号(&lt;&gt;&amp;*; '&quot;等)进行转义或编码转换，Go的text/template 包里面的HTMLEscapeString函数可以对字符串进行转义处理。</li><li>不要将用户输入直接嵌入到sql语句中，而应该使用参数化查询接口，如Prepare、Query、Exec(query string, args …interface{})。</li><li>使用专业的SQL注入检测工具进行检测，如sqlmap、SQLninja。</li><li>避免网站打印出SQL错误信息，以防止攻击者利用这些错误信息进行SQL注入。</li></ul><p>参数化查询</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;merchant_id = ?&quot;</span>, merchantId)</span><br></pre></td></tr></table></figure><p>拼接sql</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Where(fmt.Sprintf(<span class="string">&quot;merchant_id = %s&quot;</span>, merchantId))</span><br></pre></td></tr></table></figure><p>定义一个sql模板</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stmt, err := db.Prepare(<span class="string">&quot;update student set score=score+? where city=?&quot;</span>)</span><br></pre></td></tr></table></figure><p>多次使用模板</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res, err := stmt.Exec(<span class="number">10</span>, <span class="string">&quot;上海&quot;</span>)</span><br><span class="line">res, err = stmt.Exec(<span class="number">9</span>, <span class="string">&quot;深圳&quot;</span>) </span><br></pre></td></tr></table></figure><p><strong>SQL预编译</strong><br>  DB执行sql分为3步：</p><ol><li>词法和语义解析。</li><li>优化SQL语句，制定执行计划。</li><li>执行并返回结果。</li></ol><p>  SQL预编译技术是指将用户输入用占位符?代替，先对这个模板化的sql进行预编译，实际运行时再将用户输入代入。除了可以防止SQL注入，还可以对预编译的SQL语句进行缓存，之后的运行就省去了解析优化SQL语句的过程。</p><p>stmt_demo.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> TIME_LAYOUT = <span class="string">&quot;2006-01-02&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">loc *time.Location</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">loc, _ = time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckError</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert 通过stmt插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//一条sql，插入2行记录</span></span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;insert into student (name,province,city,enrollment) values (?,?,?,?), (?,?,?,?)&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//字符串解析为时间。注意要使用time.ParseInLocation()函数指定时区，time.Parse()函数使用默认的UTC时区</span></span><br><span class="line">date1, err := time.ParseInLocation(TIME_LAYOUT, <span class="string">&quot;2021-03-18&quot;</span>, loc)</span><br><span class="line">CheckError(err)</span><br><span class="line">date2, err := time.ParseInLocation(TIME_LAYOUT, <span class="string">&quot;2021-03-26&quot;</span>, loc)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//执行修改操作通过stmt.Exec，执行查询操作通过stmt.Query</span></span><br><span class="line">res, err := stmt.Exec(<span class="string">&quot;小明&quot;</span>, <span class="string">&quot;深圳&quot;</span>, <span class="string">&quot;深圳&quot;</span>, date1, <span class="string">&quot;小红&quot;</span>, <span class="string">&quot;上海&quot;</span>, <span class="string">&quot;上海&quot;</span>, date2)</span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//ID自增，用过的id（即使对应的行已delete）不会重复使用</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after insert last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//插入2行，所以影响了2行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// replace 通过stmt插入(覆盖)数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replace</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//由于name字段上有唯一索引，insert重复的name会报错。而使用replace会先删除，再插入</span></span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;replace into student (name,province,city,enrollment) values (?,?,?,?), (?,?,?,?)&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//字符串解析为时间。注意要使用time.ParseInLocation()函数指定时区，time.Parse()函数使用默认的UTC时区</span></span><br><span class="line">date1, err := time.ParseInLocation(TIME_LAYOUT, <span class="string">&quot;2021-04-18&quot;</span>, loc)</span><br><span class="line">CheckError(err)</span><br><span class="line">date2, err := time.ParseInLocation(TIME_LAYOUT, <span class="string">&quot;2021-04-26&quot;</span>, loc)</span><br><span class="line">fmt.Printf(<span class="string">&quot;day of 2021-04-26 is %d\n&quot;</span>, date2.Local().Day())</span><br><span class="line"><span class="comment">//执行修改操作通过stmt.Exec，执行查询操作通过stmt.Query</span></span><br><span class="line">res, err := stmt.Exec(<span class="string">&quot;小明&quot;</span>, <span class="string">&quot;深圳&quot;</span>, <span class="string">&quot;深圳&quot;</span>, date1, <span class="string">&quot;小红&quot;</span>, <span class="string">&quot;上海&quot;</span>, <span class="string">&quot;上海&quot;</span>, date2)</span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//ID自增，用过的id（即使对应的行已delete）不会重复使用</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after insert last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//先删除，后插入，影响了4行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update 通过stmt修改数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//不同的city加不同的分数</span></span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;update student set score=score+? where city=?&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//执行修改操作通过stmt.Exec，执行查询操作通过stmt.Query</span></span><br><span class="line">res, err := stmt.Exec(<span class="number">10</span>, <span class="string">&quot;上海&quot;</span>) <span class="comment">//上海加10分</span></span><br><span class="line">CheckError(err)</span><br><span class="line">res, err = stmt.Exec(<span class="number">9</span>, <span class="string">&quot;深圳&quot;</span>) <span class="comment">//深圳加9分</span></span><br><span class="line">CheckError(err)</span><br><span class="line">lastId, err := res.LastInsertId() <span class="comment">//0, 仅插入操作才会给LastInsertId赋值</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;after update last id %d\n&quot;</span>, lastId)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//where city=?命中了几行，就会影响几行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;update affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query 通过stmt查询数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;select id,name,city,score from student where id&gt;?&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//执行修改操作通过stmt.Exec，执行查询操作通过stmt.Query</span></span><br><span class="line">rows, err := stmt.Query(<span class="number">2</span>) <span class="comment">//查询得分大于2的记录</span></span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123; <span class="comment">//没有数据或发生error时返回false</span></span><br><span class="line"><span class="keyword">var</span> id <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> score <span class="type">float32</span></span><br><span class="line"><span class="keyword">var</span> name, city <span class="type">string</span></span><br><span class="line">err = rows.Scan(&amp;id, &amp;name, &amp;city, &amp;score) <span class="comment">//通过scan把db里的数据赋给go变量</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, score=%.2f, name=%s, city=%s \n&quot;</span>, id, score, name, city)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delete 通过stmt删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delete</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;delete from student where id&gt;?&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">//执行修改操作通过stmt.Exec，执行查询操作通过stmt.Query</span></span><br><span class="line">res, err := stmt.Exec(<span class="number">13</span>) <span class="comment">//删除得分大于13的记录</span></span><br><span class="line">CheckError(err)</span><br><span class="line">rows, err := res.RowsAffected() <span class="comment">//where id&gt;?命中了几行，就会影响几行</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete affect %d row\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hugeInsert</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">begin := time.Now()</span><br><span class="line">stmt, err := db.Prepare(<span class="string">&quot;insert into student (name,province,city,enrollment) values (?,?,?,?)&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line">date, err := time.ParseInLocation(<span class="string">&quot;20060102&quot;</span>, <span class="string">&quot;20211204&quot;</span>, loc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line">stmt.Exec(<span class="string">&quot;宋江&quot;</span>+strconv.Itoa(i), <span class="string">&quot;山西&quot;</span>, <span class="string">&quot;大同&quot;</span>, date)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;huge insert use %d ms\n&quot;</span>, time.Since(begin).Milliseconds())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// traverse1 通过limit offset,n遍历表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">traverse1</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> offset <span class="type">int</span></span><br><span class="line">begin := time.Now()</span><br><span class="line">stmt, _ := db.Prepare(<span class="string">&quot;select id,name,province from student limit ?,100&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">t0 := time.Now()</span><br><span class="line">rows, _ := stmt.Query(offset)</span><br><span class="line">offset += <span class="number">100</span></span><br><span class="line">fmt.Println(i, time.Since(t0))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> id <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> province <span class="type">string</span></span><br><span class="line">rows.Scan(&amp;id, &amp;name, &amp;province)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;total&quot;</span>, time.Since(begin))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// traverse2 借助于主健自增ID，通过where id&gt;maxid遍历表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">traverse2</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> maxid <span class="type">int</span></span><br><span class="line">begin := time.Now()</span><br><span class="line">stmt, _ := db.Prepare(<span class="string">&quot;select id,name,province from student where id&gt;? limit 100&quot;</span>) <span class="comment">//limit m,n  limit 0,n</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">t0 := time.Now()</span><br><span class="line">rows, _ := stmt.Query(maxid)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d %dus\n&quot;</span>, i, time.Since(t0).Microseconds())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> id <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> province <span class="type">string</span></span><br><span class="line">rows.Scan(&amp;id, &amp;name, &amp;province)</span><br><span class="line"><span class="keyword">if</span> id &gt; maxid &#123;</span><br><span class="line">maxid = id</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;total&quot;</span>, time.Since(begin))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx@tcp(192.168.10.10:3306)/testops?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="comment">// insert(db)</span></span><br><span class="line"><span class="comment">// replace(db)</span></span><br><span class="line"><span class="comment">// update(db)</span></span><br><span class="line">query(db)</span><br><span class="line"><span class="comment">// delete(db)</span></span><br><span class="line"><span class="comment">// fmt.Println()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// hugeInsert(db)</span></span><br><span class="line"><span class="comment">// traverse1(db)</span></span><br><span class="line"><span class="comment">// traverse2(db)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="SQLBuilder">SQLBuilder</h2><h3 id="Go-SQLBuilder">Go-SQLBuilder</h3><p>  Go-SQLBuilder是一个用于创建SQL语句的工具函数库，提供一系列灵活的、与原生SQL语法一致的链式函数。归属于艾润物联公司。安装方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/parkingwang/go-sqlbuilder</span><br></pre></td></tr></table></figure><p>  Go-SQLBuilder通过函数链来构造sql语句，比如select语句的构造</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">()</span></span> &#123;</span><br><span class="line">sql := gsb.NewContext().Select(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;city&quot;</span>).</span><br><span class="line">From(<span class="string">&quot;student&quot;</span>).</span><br><span class="line">OrderBy(<span class="string">&quot;score&quot;</span>).DESC().</span><br><span class="line">Column(<span class="string">&quot;name&quot;</span>).ASC().</span><br><span class="line">Limit(<span class="number">10</span>).Offset(<span class="number">20</span>).</span><br><span class="line">ToSQL()</span><br><span class="line">fmt.Println(sql)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么需要SQLBuilder？</p><ol><li>写一句很长的sql容易出错，且出错后不好定位。</li><li>函数式编程可以直接定位到是哪个函数的问题。</li><li>函数式编程比一长串sql更容易编写和理解。</li></ol><h3 id="Gendry">Gendry</h3><p>  Gendry是一个用于辅助操作数据库的Go包。基于go-sql-driver /mysql，它提供了一系列的方法来为你调用标准库database/sql中的方法准备参数。安装方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get –u github.com/didi/gendry</span><br></pre></td></tr></table></figure><p>  Gendry倾向于把复杂的筛选条件放在map中，并且跟stmt技术结合得比较紧密。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">(db *sql.DB)</span></span> &#123;</span><br><span class="line">where := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;city&quot;</span>:     []<span class="type">string</span>&#123;<span class="string">&quot;北京&quot;</span>, <span class="string">&quot;上海&quot;</span>, <span class="string">&quot;杭州&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;score&lt;&quot;</span>:   <span class="number">30</span>,</span><br><span class="line"><span class="string">&quot;addr&quot;</span>:     builder.IsNotNull,</span><br><span class="line"><span class="string">&quot;_orderby&quot;</span>: <span class="string">&quot;score desc&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">table := <span class="string">&quot;student&quot;</span></span><br><span class="line">fields := []<span class="type">string</span>&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;city&quot;</span>, <span class="string">&quot;score&quot;</span>&#125;</span><br><span class="line"><span class="comment">//准备stmt模板</span></span><br><span class="line">template, values, err := builder.BuildSelect(table, where, fields)</span><br><span class="line">database.CheckError(err)</span><br><span class="line"><span class="comment">//执行stmt模板</span></span><br><span class="line">rows, err := db.Query(template, values...)</span><br><span class="line">database.CheckError(err)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> id <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> name, city <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> score <span class="type">float32</span></span><br><span class="line">err := rows.Scan(&amp;id, &amp;name, &amp;city, &amp;score)</span><br><span class="line">database.CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d %s %s %.2f\n&quot;</span>, id, name, city, score)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自行实现SQLBuilder">自行实现SQLBuilder</h3><p>  作为练习，我们自行实现一个SQLBuilder，它最终应该支持如下函数链式的编程风格。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql := NewSelectBuilder(<span class="string">&quot;student&quot;</span>).Column(<span class="string">&quot;id,name,city&quot;</span>).</span><br><span class="line">Where(<span class="string">&quot;id&gt;0&quot;</span>).</span><br><span class="line">And(<span class="string">&quot;city=&#x27;郑州&#x27;&quot;</span>).</span><br><span class="line">Or(<span class="string">&quot;city=&#x27;北京&#x27;&quot;</span>).</span><br><span class="line">OrderBy(<span class="string">&quot;score&quot;</span>).Desc().</span><br><span class="line">Limit(<span class="number">0</span>, <span class="number">10</span>).ToString()<span class="string">`</span></span><br></pre></td></tr></table></figure><p>  Builder设计模式的精髓在于<strong>Builder对象的方法还是返回一个Builder</strong>。首先定义一个Builder接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Builder <span class="keyword">interface</span> &#123;</span><br><span class="line">toString() <span class="type">string</span></span><br><span class="line">getPrev() Builder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  select、where、limit、orderby这些都是Builder，这里详细讲解WhereBuilder的设计与实现。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WhereBuilder <span class="keyword">struct</span> &#123;</span><br><span class="line">sb strings.Builder<span class="comment">//拼接where条件字符串</span></span><br><span class="line">orderby *OrderByBuilder<span class="comment">//where后面可能会接order by</span></span><br><span class="line">limit *LimitBuilder<span class="comment">// where后面可能会接limit</span></span><br><span class="line">prev Builder<span class="comment">//where前面是select</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  WhereBuilder中的sb负责当下，orderby和limit负责维护后面节点，prev负责维护前面的节点。<br>  where表达式中可能包含and和or，把它们定义为WhereBuilder的方法，并且这两个方法依赖返回WhereBuilder自身。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *WhereBuilder)</span></span> And(condition <span class="type">string</span>) *WhereBuilder &#123;</span><br><span class="line">self.sb.WriteString(<span class="string">&quot; and &quot;</span>)</span><br><span class="line">self.sb.WriteString(condition)</span><br><span class="line"><span class="keyword">return</span> self</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *WhereBuilder)</span></span> Or(condition <span class="type">string</span>) *WhereBuilder &#123;</span><br><span class="line">self.sb.WriteString(<span class="string">&quot; or &quot;</span>)</span><br><span class="line">self.sb.WriteString(condition)</span><br><span class="line"><span class="keyword">return</span> self</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  where表达式后面可能会跟order by表达式，把OrderBy定义为WhereBuilder的方法，该方法返回OrderByBuilder。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *WhereBuilder)</span></span> OrderBy(column <span class="type">string</span>) *OrderByBuilder &#123;</span><br><span class="line">orderby := newOrderByBuilder(column)</span><br><span class="line">self.orderby = orderby</span><br><span class="line">orderby.prev = self</span><br><span class="line"><span class="keyword">return</span> orderby</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  函数链上的最后一个Builder调用ToString()方法生成写成的sql语句。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *LimitBuilder)</span></span> ToString() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">var</span> root Builder</span><br><span class="line">root = self</span><br><span class="line"><span class="keyword">for</span> root.getPrev() != <span class="literal">nil</span> &#123;</span><br><span class="line">root = root.getPrev()    <span class="comment">//递归找到最前面的Builder</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> root.toString()    <span class="comment">//在最前面的Builder（即SelectBuilder）上调用toString()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  每个Builder都有toString()方法，以WhereBuilder为例，它在构造函数里把where表达式放入sb成员变量里，WhereBuilder在toString()方法里调用where后面的节点的toString()方法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWhereBuilder</span><span class="params">(condition <span class="type">string</span>)</span></span> *WhereBuilder &#123;</span><br><span class="line">builder := &amp;WhereBuilder&#123;&#125;</span><br><span class="line">builder.sb.WriteString(<span class="string">&quot; where &quot;</span>)</span><br><span class="line">builder.sb.WriteString(condition)</span><br><span class="line"><span class="keyword">return</span> builder</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *WhereBuilder)</span></span> toString() <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">//递归调用后续Builder的ToString()</span></span><br><span class="line"><span class="keyword">if</span> self.orderby != <span class="literal">nil</span> &#123;</span><br><span class="line">self.sb.WriteString(self.orderby.toString())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> self.limit != <span class="literal">nil</span> &#123;</span><br><span class="line">self.sb.WriteString(self.limit.toString())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> self.sb.String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="GORM">GORM</h2><p>  ORM即Object Relational Mapping，对象关系映射。Relational指各种sql类的关系型数据库。Object指面向对象编程(object-oriented programming)中的对象。ORM在数据库记录和程序对象之间做一层映射转换，使程序中不用再去编写原生SQL，而是面向对象的思想去编写类、对象、调用相应的方法来完成数据库操作。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get -u gorm.io/gorm</span><br><span class="line">go get -u gorm.io/driver/mysql</span><br></pre></td></tr></table></figure><p>  GORM是一个全能的、友好的、基于golang的ORM库。<br>GORM 倾向于约定，而不是配置。默认情况下，GORM 使用ID作为主键，使用结构体名的【蛇形复数】作为表名，字段名的【蛇形】作为列名，并使用CreatedAt、UpdatedAt字段追踪创建、更新时间。<br>  GORM完全是在操作struct，看不到sql的影子。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Id         <span class="type">int</span>    <span class="string">`gorm:&quot;column:id;primaryKey&quot;`</span></span><br><span class="line">Name       <span class="type">string</span> <span class="string">`gorm:&quot;column:name&quot;`</span></span><br><span class="line">Province   <span class="type">string</span></span><br><span class="line">City       <span class="type">string</span>    <span class="string">`gorm:&quot;column:city&quot;`</span></span><br><span class="line">Address    <span class="type">string</span>    <span class="string">`gorm:&quot;column:addr&quot;`</span></span><br><span class="line">Score      <span class="type">float32</span>   <span class="string">`gorm:&quot;column:score&quot;`</span></span><br><span class="line">Enrollment time.Time <span class="string">`gorm:&quot;column:enrollment;type:date&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line">student := Student&#123;</span><br><span class="line">Name: <span class="string">&quot;光绪&quot;</span>, </span><br><span class="line">Province: <span class="string">&quot;北京&quot;</span>, </span><br><span class="line">City: <span class="string">&quot;北京&quot;</span>, </span><br><span class="line">Score: <span class="number">38</span>, </span><br><span class="line">Enrollment: time.Now()</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;student)</span><br></pre></td></tr></table></figure><p>  GORM同时支持使用函数链的方式写sql语句。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认情况下，GORM 使用 ID 作为主键，使用结构体名的 蛇形复数 作为表名，字段名的 蛇形 作为列名</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Id         <span class="type">int</span>    <span class="string">`gorm:&quot;column:id;primaryKey&quot;`</span></span><br><span class="line">Name       <span class="type">string</span> <span class="string">`gorm:&quot;column:name&quot;`</span></span><br><span class="line">Province   <span class="type">string</span></span><br><span class="line">City       <span class="type">string</span>    <span class="string">`gorm:&quot;column:city&quot;`</span></span><br><span class="line">Address    <span class="type">string</span>    <span class="string">`gorm:&quot;column:addr&quot;`</span></span><br><span class="line">Score      <span class="type">float32</span>   <span class="string">`gorm:&quot;column:score&quot;`</span></span><br><span class="line">Enrollment time.Time <span class="string">`gorm:&quot;column:enrollment;type:date&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用TableName()来修改默认的表名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Student)</span></span> TableName() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;student&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckError</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">普通的where查询</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//返回一条记录</span></span><br><span class="line"><span class="keyword">var</span> student Student</span><br><span class="line">db.Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).First(&amp;student) <span class="comment">//有First就有Last</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;student: %+v\n&quot;</span>, student)</span><br><span class="line"><span class="comment">//返回多条记录</span></span><br><span class="line"><span class="keyword">var</span> students []Student</span><br><span class="line">db.Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//清空student，防止前后影响</span></span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Where(<span class="string">&quot;city in ?&quot;</span>, []<span class="type">string</span>&#123;<span class="string">&quot;郑州&quot;</span>, <span class="string">&quot;北京&quot;</span>&#125;).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据主键查询</span></span><br><span class="line">student = Student&#123;&#125; <span class="comment">//清空student，防止前后影响</span></span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.First(&amp;student, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// db.Where(&quot;id=?&quot;,1).First(&amp;student)</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;student: %+v\n&quot;</span>, student)</span><br><span class="line"></span><br><span class="line">db.Find(&amp;students, []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment">// db.Where(&quot;id in ?&quot;, []int&#123;1, 2, 3&#125;).Find(&amp;students)</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据map查询</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;city&quot;</span>: <span class="string">&quot;郑州&quot;</span>, <span class="string">&quot;score&quot;</span>: <span class="number">0</span>&#125;).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//OR查询</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).Or(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;北京&quot;</span>).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//order by</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).Order(<span class="string">&quot;score&quot;</span>).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//limit</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).Order(<span class="string">&quot;score&quot;</span>).Limit(<span class="number">1</span>).Offset(<span class="number">0</span>).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line"></span><br><span class="line"><span class="comment">//选择特定的字段</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">db.Select(<span class="string">&quot;name&quot;</span>).Take(&amp;student)                                     <span class="comment">//Take从结果中取一个，不保证是第一个或最后一个</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;name=%s, province=%s\n&quot;</span>, student.Name, student.Province) <span class="comment">//只select了name，所以province是空的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询所有行</span></span><br><span class="line">student = Student&#123;&#125;</span><br><span class="line">students = []Student&#123;&#125;</span><br><span class="line">db.Select(<span class="string">&quot;*&quot;</span>).Find(&amp;students)</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %v\n&quot;</span>, students)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//根据where更新一列</span></span><br><span class="line">db.Model(&amp;Student&#123;&#125;).Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;北京&quot;</span>).Update(<span class="string">&quot;score&quot;</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">//更新多列</span></span><br><span class="line">db.Model(&amp;Student&#123;&#125;).Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;北京&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;score&quot;</span>: <span class="number">3</span>, <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;海淀区&quot;</span>&#125;)</span><br><span class="line"><span class="comment">//where里加入object的ID</span></span><br><span class="line">student := Student&#123;Id: <span class="number">2</span>, City: <span class="string">&quot;太原&quot;</span>&#125;</span><br><span class="line"><span class="comment">//相当于where id=2 and city=&#x27;郑州&#x27;</span></span><br><span class="line">db = db.Model(&amp;student).Where(<span class="string">&quot;city=?&quot;</span>, <span class="string">&quot;郑州&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;score&quot;</span>: <span class="number">10</span>, <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;中原区&quot;</span>&#125;)</span><br><span class="line">fmt.Printf(<span class="string">&quot;update %d rows\n&quot;</span>, db.RowsAffected)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//插入一条记录</span></span><br><span class="line">student := Student&#123;Name: <span class="string">&quot;光绪&quot;</span>, Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">38</span>, Enrollment: time.Now()&#125;</span><br><span class="line">db.Create(&amp;student)</span><br><span class="line"><span class="comment">//一次性插入多条</span></span><br><span class="line">students := []Student&#123;&#123;Name: <span class="string">&quot;无极&quot;</span>, Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">38</span>, Enrollment: time.Now()&#125;, &#123;Name: <span class="string">&quot;小王&quot;</span>, Province: <span class="string">&quot;上海&quot;</span>, City: <span class="string">&quot;上海&quot;</span>, Score: <span class="number">12</span>, Enrollment: time.Now()&#125;, &#123;Name: <span class="string">&quot;小亮&quot;</span>, Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">20</span>, Enrollment: time.Now()&#125;&#125;</span><br><span class="line">db.Create(students)</span><br><span class="line"><span class="comment">//量太大时分批插入</span></span><br><span class="line">students = []Student&#123;&#123;Name: <span class="string">&quot;大壮&quot;</span>, Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">38</span>, Enrollment: time.Now()&#125;, &#123;Name: <span class="string">&quot;刘二&quot;</span>, Province: <span class="string">&quot;上海&quot;</span>, City: <span class="string">&quot;上海&quot;</span>, Score: <span class="number">12</span>, Enrollment: time.Now()&#125;, &#123;Name: <span class="string">&quot;文明&quot;</span>, Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">20</span>, Enrollment: time.Now()&#125;&#125;</span><br><span class="line">db = db.CreateInBatches(students, <span class="number">2</span>) <span class="comment">//一次插入2条</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;insert %d rows\n&quot;</span>, db.RowsAffected)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delete</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line"><span class="comment">//用where删除</span></span><br><span class="line">db = db.Where(<span class="string">&quot;city in ?&quot;</span>, []<span class="type">string</span>&#123;<span class="string">&quot;常州&quot;</span>, <span class="string">&quot;成都&quot;</span>&#125;).Delete(&amp;Student&#123;&#125;)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete %d rows\n&quot;</span>, db.RowsAffected)</span><br><span class="line"><span class="comment">//用主键删除</span></span><br><span class="line">db = db.Delete(&amp;Student&#123;&#125;, <span class="number">27</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete %d rows\n&quot;</span>, db.RowsAffected)</span><br><span class="line">db = db.Delete(&amp;Student&#123;&#125;, []<span class="type">int</span>&#123;<span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>&#125;)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete %d rows\n&quot;</span>, db.RowsAffected)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transaction</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">tx := db.Begin()</span><br><span class="line"><span class="keyword">defer</span> tx.Rollback() <span class="comment">//调用commit后也可以调用rollback，相当于rollback没起任何作用</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">student := Student&#123;Name: <span class="string">&quot;学生&quot;</span> + strconv.Itoa(i), Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">38</span>, Enrollment: time.Now()&#125;</span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;student).Error; err != <span class="literal">nil</span> &#123; <span class="comment">//注意是tx.Create，不是db.Create</span></span><br><span class="line"><span class="keyword">return</span> <span class="comment">//函数返回</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">tx.Commit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transaction2</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">tx := db.Begin()</span><br><span class="line"><span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">student := Student&#123;Name: <span class="string">&quot;学生&quot;</span> + strconv.Itoa(i), Province: <span class="string">&quot;北京&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">38</span>, Enrollment: time.Now()&#125;</span><br><span class="line"><span class="keyword">if</span> err := tx.Create(&amp;student).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">5</span> &#123;</span><br><span class="line">tx.Rollback() <span class="comment">//Rollback之后事务就被关闭了，不能再调用tx.Create()了</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">tx.Commit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//想要正确的处理time.Time ，您需要带上parseTime参数</span></span><br><span class="line"><span class="comment">//要支持完整的UTF-8编码，您需要将charset=utf8更改为charset=utf8mb4</span></span><br><span class="line">dsn := <span class="string">&quot;ops:xxx@tcp(192.168.10.10:3306)/testops?charset=utf8mb4&amp;parseTime=True&quot;</span></span><br><span class="line">db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">CheckError(err)</span><br><span class="line">db.AutoMigrate(&amp;Student&#123;&#125;) <span class="comment">//让数据库之前存储的记录的表格字段和程序中最新使用的表格字段保持一致（只增不减）</span></span><br><span class="line">query(db)</span><br><span class="line"><span class="comment">// update(db)</span></span><br><span class="line"><span class="comment">// create(db)</span></span><br><span class="line"><span class="comment">// delete(db)</span></span><br><span class="line"><span class="comment">// transaction(db)</span></span><br><span class="line"><span class="comment">// transaction2(db)</span></span><br><span class="line"><span class="comment">// db.Where(&quot;name like ?&quot;, &quot;学生%&quot;).Delete(&amp;Student&#123;&#125;) //删除name以&quot;学生&quot;为前缀的记录</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Go操作MongoDB">Go操作MongoDB</h2><p>  NoSQL泛指非关系型数据库，如mongo,redis,HBase。mongo使用高效的二进制数据存储，文件存储格式为 BSON （ 一种json的扩展，比json性能更好，功能更强大）。MySQL中表的概念在mongo里叫集合(collection)， MySQL中行的概念在mongo中叫文档(document)，一个文档看上去像一个json。<br>  安装mongo前先配置yum源: vim /etc/yum.repos.d/mongodb-org-4.2.repo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongodb-org-4.2]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.2/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.2.asc</span><br></pre></td></tr></table></figure><p>  一键安装mongo: sudo yum install -y mongodb-org<br>  启动mongo: systemctl start mongod<br>mongo常用命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">show databases</span><br><span class="line">show collections</span><br><span class="line">use test;  切换到test库，如果没有则（创建集合时）会自动创建</span><br><span class="line">db.createCollection(&quot;student&quot;);  创建collection</span><br><span class="line">db.createUser(&#123;user: &quot;tester&quot;,pwd: &quot;123456&quot;, roles: [&#123;role: &quot;dbAdmin&quot;, db: &quot;test&quot;&#125;]&#125;);创建用户</span><br><span class="line">登录mongo --port 27017 -u &quot;tester&quot; -p &quot;123456&quot; --authenticationDatabase &quot;test&quot;</span><br><span class="line">db.student.createIndex(&#123;&quot;name&quot;:1&#125;);在name上创建索引,不是唯一索引</span><br><span class="line"> db.student.insertOne(&#123;name:&quot;张三&quot;,city:&quot;北京&quot;&#125;);</span><br><span class="line">db.student.find(&#123;name:&quot;张三&quot;&#125;);</span><br><span class="line">db.student.update(&#123;name:&quot;张三&quot;&#125;,&#123;name:&quot;张三&quot;,city:&quot;上海&quot;&#125;)</span><br><span class="line">db.student.deleteOne(&#123;name:&quot;张三&quot;&#125;);</span><br></pre></td></tr></table></figure><p>安装go mongo-driver</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go get go.mongodb.org/mongo-driver</span><br><span class="line">go get go.mongodb.org/mongo-driver/x/bsonx/bsoncore@v1.7.1</span><br><span class="line">go get go.mongodb.org/mongo-driver/x/mongo/driver@v1.7.1</span><br><span class="line">go get go.mongodb.org/mongo-driver/mongo/options@v1.7.1</span><br><span class="line">go get go.mongodb.org/mongo-driver/x/mongo/driver/topology@v1.7.1</span><br><span class="line">go get go.mongodb.org/mongo-driver/mongo@v1.7.1</span><br></pre></td></tr></table></figure><p>示例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/bson&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo/options&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span></span><br><span class="line">City  <span class="type">string</span></span><br><span class="line">Score <span class="type">float32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckError</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(ctx context.Context, collection *mongo.Collection)</span></span> &#123;</span><br><span class="line"><span class="comment">//插入一个doc</span></span><br><span class="line">doc := Student&#123;Name: <span class="string">&quot;张三&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">39</span>&#125;</span><br><span class="line">res, err := collection.InsertOne(ctx, doc)</span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert id %v\n&quot;</span>, res.InsertedID) <span class="comment">//每个doc都会有一个全世界唯一的ID(时间+空间唯一)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//插入多个docs</span></span><br><span class="line">docs := []<span class="keyword">interface</span>&#123;&#125;&#123;Student&#123;Name: <span class="string">&quot;李四&quot;</span>, City: <span class="string">&quot;北京&quot;</span>, Score: <span class="number">24</span>&#125;, Student&#123;Name: <span class="string">&quot;王五&quot;</span>, City: <span class="string">&quot;南京&quot;</span>, Score: <span class="number">21</span>&#125;&#125;</span><br><span class="line">manyRes, err := collection.InsertMany(ctx, docs)</span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;insert many ids %v\n&quot;</span>, manyRes.InsertedIDs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(ctx context.Context, collection *mongo.Collection)</span></span> &#123;</span><br><span class="line">filter := bson.D&#123;&#123;<span class="string">&quot;city&quot;</span>, <span class="string">&quot;北京&quot;</span>&#125;&#125;</span><br><span class="line">update := bson.D&#123;&#123;<span class="string">&quot;$inc&quot;</span>, bson.D&#123;&#123;<span class="string">&quot;score&quot;</span>, <span class="number">5</span>&#125;&#125;&#125;&#125;</span><br><span class="line">res, err := collection.UpdateMany(ctx, filter, update) <span class="comment">//或用UpdateOne</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;update %d doc\n&quot;</span>, res.ModifiedCount)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delete</span><span class="params">(ctx context.Context, collection *mongo.Collection)</span></span> &#123;</span><br><span class="line">filter := bson.D&#123;&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张三&quot;</span>&#125;&#125;</span><br><span class="line">res, err := collection.DeleteMany(ctx, filter) <span class="comment">//或用DeleteOne</span></span><br><span class="line">CheckError(err)</span><br><span class="line">fmt.Printf(<span class="string">&quot;delete %d doc\n&quot;</span>, res.DeletedCount)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">query</span><span class="params">(ctx context.Context, collection *mongo.Collection)</span></span> &#123;</span><br><span class="line">sort := bson.D&#123;&#123;<span class="string">&quot;Score&quot;</span>, <span class="number">1</span>&#125;&#125;                    <span class="comment">//1升序，-1降序</span></span><br><span class="line">filter := bson.D&#123;&#123;<span class="string">&quot;score&quot;</span>, bson.D&#123;&#123;<span class="string">&quot;$gt&quot;</span>, <span class="number">3</span>&#125;&#125;&#125;&#125; <span class="comment">//score&gt;3，gt代表greater than</span></span><br><span class="line">findOption := options.Find()</span><br><span class="line">findOption.SetSort(sort)</span><br><span class="line">findOption.SetLimit(<span class="number">10</span>) <span class="comment">//最多返回10个</span></span><br><span class="line">findOption.SetSkip(<span class="number">0</span>)   <span class="comment">//跳过前3个</span></span><br><span class="line"></span><br><span class="line">cursor, err := collection.Find(ctx, filter, findOption)</span><br><span class="line">CheckError(err)</span><br><span class="line"><span class="keyword">defer</span> cursor.Close(ctx) <span class="comment">//关闭迭代器</span></span><br><span class="line"></span><br><span class="line">students := <span class="built_in">make</span>([]Student, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">var</span> student Student</span><br><span class="line"><span class="keyword">for</span> cursor.Next(ctx) &#123;</span><br><span class="line">err := cursor.Decode(&amp;student)</span><br><span class="line">CheckError(err)</span><br><span class="line">students = <span class="built_in">append</span>(students, student)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;students: %+v\n&quot;</span>, students)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line">option := options.Client().ApplyURI(<span class="string">&quot;mongodb://192.168.10.10:27017&quot;</span>).</span><br><span class="line">SetConnectTimeout(time.Second). <span class="comment">//连接超时时长</span></span><br><span class="line"><span class="comment">//AuthSource代表Database</span></span><br><span class="line">SetAuth(options.Credential&#123;Username: <span class="string">&quot;tester&quot;</span>, Password: <span class="string">&quot;123456&quot;</span>, AuthSource: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">client, err := mongo.Connect(ctx, option)</span><br><span class="line">CheckError(err)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Connect没有返回error并不代表连接成功，ping成功才代表连接成功</span></span><br><span class="line">err = client.Ping(ctx, <span class="literal">nil</span>)</span><br><span class="line">CheckError(err)</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放链接</span></span><br><span class="line"><span class="keyword">defer</span> client.Disconnect(ctx)</span><br><span class="line"></span><br><span class="line">collection := client.Database(<span class="string">&quot;test&quot;</span>).Collection(<span class="string">&quot;student&quot;</span>)</span><br><span class="line"><span class="comment">// create(ctx, collection)</span></span><br><span class="line"><span class="comment">// update(ctx, collection)</span></span><br><span class="line"><span class="comment">// delete(ctx, collection)</span></span><br><span class="line">query(ctx, collection)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang中websocket编程</title>
      <link href="/20230120/golang-20230120-golang%E4%B8%ADwebsocket%E7%BC%96%E7%A8%8B/"/>
      <url>/20230120/golang-20230120-golang%E4%B8%ADwebsocket%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="WebSocket协议解读">WebSocket协议解读</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./websocket.png" alt="avatar"><br>websocket和http协议的关联：</p><ul><li>都是应用层协议，都基于tcp传输协议。</li><li>跟http有良好的兼容性，ws和http的默认端口都是80，wss和https的默认端口都是443。</li><li>websocket在握手阶段采用http发送数据。</li></ul><p>websocket和http协议的差异：</p><ul><li>http是半双工，而websocket通过多路复用实现了全双工。</li><li>http只能由client主动发起数据请求，而websocket还可以由server主动向client推送数据。在需要及时刷新的场景中，http只能靠client高频地轮询，浪费严重。</li><li>http是短连接(也可以实现长连接, HTTP1.1 的连接默认使用长连接)，每次数据请求都得经过三次握手重新建立连接，而websocket是长连接。</li><li>http长连接中每次请求都要带上header，而websocket在传输数据阶段不需要带header。</li></ul><p>  WebSocket是HTML5下的产物，能更好的节省服务器资源和带宽，websocket应用场景举例：</p><ul><li>html5多人游戏</li><li>聊天室</li><li>协同编辑</li><li>基于实时位置的应用</li><li>股票实时报价</li><li>弹幕</li><li>视频会议</li></ul><p>websocket握手协议:<br><strong>Request Header</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Sec-Websocket-Version:13</span><br><span class="line">Upgrade:websocket</span><br><span class="line">Connection:Upgrade</span><br><span class="line">Sec-Websocket-Key:duR0pUQxNgBJsRQKj2Jxsw==</span><br></pre></td></tr></table></figure><p><strong>Response Header</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Upgrade:websocket</span><br><span class="line">Connection:Upgrade</span><br><span class="line">Sec-Websocket-Accept:a1y2oy1zvgHsVyHMx+hZ1AYrEHI=</span><br></pre></td></tr></table></figure><ul><li>Upgrade:websocket和Connection:Upgrade指明使用WebSocket协议。</li><li>Sec-WebSocket-Version 指定Websocket协议版本。</li><li>Sec-WebSocket-Key是一个Base64 encode的值，是浏览器随机生成的。</li><li>服务端收到Sec-WebSocket-Key后拼接上一个固定的GUID，进行一次SHA-1摘要，再转成Base64编码，得到Sec-WebSocket-Accept返回给客户端。客户端对本地的Sec-WebSocket-Key执行同样的操作跟服务端返回的结果进行对比，如果不一致会返回错误关闭连接。如此操作是为了把websocket header跟http header区分开。</li></ul><h2 id="WebSocket-CS架构实现">WebSocket CS架构实现</h2><p>  首先需要安装gorilla的websocket包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/gorilla/websocket</span><br></pre></td></tr></table></figure><ol><li>将http升级到WebSocket协议。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *Upgrader)</span></span> Upgrade(w http.ResponseWriter, r *http.Request, responseHeader http.Header) (*websocket.Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><ol start="2"><li>客户端发起握手，请求建立连接。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*websocket.Dialer)</span></span> Dial(urlStr <span class="type">string</span>, requestHeader http.Header) (*websocket.Conn, *http.Response, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><ol start="3"><li>基于connection进行read和write。</li></ol><p>ws_server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WsServer <span class="keyword">struct</span> &#123;</span><br><span class="line">listener net.Listener</span><br><span class="line">addr     <span class="type">string</span></span><br><span class="line">upgrade  *websocket.Upgrader</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWsServer</span><span class="params">(port <span class="type">int</span>)</span></span> *WsServer &#123;</span><br><span class="line">ws := <span class="built_in">new</span>(WsServer)</span><br><span class="line">ws.addr = <span class="string">&quot;0.0.0.0:&quot;</span> + strconv.Itoa(port)</span><br><span class="line">ws.upgrade = &amp;websocket.Upgrader&#123;</span><br><span class="line">HandshakeTimeout: <span class="number">5</span> * time.Second, <span class="comment">//握手超时时间</span></span><br><span class="line">ReadBufferSize:   <span class="number">2048</span>,            <span class="comment">//读缓冲大小</span></span><br><span class="line">WriteBufferSize:  <span class="number">1024</span>,            <span class="comment">//写缓冲大小</span></span><br><span class="line"><span class="comment">//请求检查函数，用于统一的链接检查，以防止跨站点请求伪造。如果Origin请求头存在且原始主机不等于请求主机头，则返回false</span></span><br><span class="line">CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;request url %s\n&quot;</span>, r.URL)</span><br><span class="line">log.Println(<span class="string">&quot;handshake request header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> r.Header &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, key, values[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//http错误响应函数</span></span><br><span class="line">Error: <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, status <span class="type">int</span>, reason <span class="type">error</span>)</span></span> &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ws</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// httpHandler必须实现ServeHTTP接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *WsServer)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line"><span class="keyword">if</span> r.URL.Path != <span class="string">&quot;/add&quot;</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;path error&quot;</span>)</span><br><span class="line">http.Error(w, <span class="string">&quot;请求的路径不存在&quot;</span>, <span class="number">222</span>) <span class="comment">//把出错的话术写到ResponseWriter里</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">conn, err := ws.upgrade.Upgrade(w, r, <span class="literal">nil</span>) <span class="comment">//将http协议升级到websocket协议</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;upgrade http to websocket error: %v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;establish conection to client %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="keyword">go</span> ws.handleConnection(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理连接里发来的请求数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *WsServer)</span></span> handleConnection(conn *websocket.Conn) &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123; <span class="comment">//20秒关闭连接</span></span><br><span class="line">conn.SetReadDeadline(time.Now().Add(<span class="number">20</span> * time.Second))</span><br><span class="line"><span class="keyword">var</span> request Request</span><br><span class="line"><span class="keyword">if</span> err := conn.ReadJSON(&amp;request); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">//判断是不是超时</span></span><br><span class="line"><span class="keyword">if</span> netError, ok := err.(net.Error); ok &#123; <span class="comment">//如果ok==true，说明类型断言成功</span></span><br><span class="line"><span class="keyword">if</span> netError.Timeout() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;read message timeout, remote %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//忽略websocket.CloseGoingAway/websocket.CloseNormalClosure这2种closeErr，如果是其他closeErr就打一条错误日志</span></span><br><span class="line"><span class="keyword">if</span> websocket.IsUnexpectedCloseError(err, websocket.CloseGoingAway, websocket.CloseNormalClosure) &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;client %s %v\n&quot;</span>, conn.RemoteAddr().String(), err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="comment">//只要ReadMessage发生错误，就关闭这条连接</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">response := Response&#123;Sum: request.A + request.B&#125;</span><br><span class="line"><span class="keyword">if</span> err = conn.WriteJSON(&amp;response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;write response failed: %v&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;write response %d\n&quot;</span>, response.Sum)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ws *WsServer)</span></span> Start() (err <span class="type">error</span>) &#123;</span><br><span class="line">ws.listener, err = net.Listen(<span class="string">&quot;tcp&quot;</span>, ws.addr) <span class="comment">//http和websocket都是建立在tcp之上的</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;listen error:%s\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">err = http.Serve(ws.listener, ws) <span class="comment">//开始对外提供http服务。可以接收很多连接请求，其他一个连接处理出错了，也不会影响其他连接</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;http server error: %v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if err:=http.ListenAndServe(ws.addr, ws);err!=nil&#123;//Listen和Serve两步合成一步</span></span><br><span class="line"><span class="comment">// fmt.Printf(&quot;http server error: %v\n&quot;, err)</span></span><br><span class="line"><span class="comment">// return</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ws := NewWsServer(<span class="number">5657</span>)</span><br><span class="line">ws.Start()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ws_client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dialer := &amp;websocket.Dialer&#123;&#125;</span><br><span class="line">header := http.Header&#123;</span><br><span class="line"><span class="string">&quot;Cookie&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;name=zcy&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">conn, resp, err := dialer.Dial(<span class="string">&quot;ws://localhost:5657/add&quot;</span>, header) <span class="comment">//Dial:握手阶段，会发送一条http请求。请求一个不存在的路径试试看</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;dial server error:%v\n&quot;</span>, err)</span><br><span class="line">fmt.Println(resp.StatusCode)</span><br><span class="line">msg, _ := ioutil.ReadAll(resp.Body)</span><br><span class="line">fmt.Println(<span class="type">string</span>(msg))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;handshake response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, key, values[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// time.Sleep(5 * time.Second)</span></span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">request := Request&#123;A: <span class="number">7</span>, B: <span class="number">4</span>&#125;</span><br><span class="line">requestBytes, _ := json.Marshal(request)</span><br><span class="line">err = conn.WriteJSON(request) <span class="comment">//websocket.Conn直接提供发json序列化和反序列化方法</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;write request %s\n&quot;</span>, <span class="type">string</span>(requestBytes))</span><br><span class="line"><span class="keyword">var</span> response Response</span><br><span class="line">err = conn.ReadJSON(&amp;response)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;receive response: %d\n&quot;</span>, response.Sum)</span><br><span class="line">time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  websocket发送的消息类型有5种：TextMessag,BinaryMessage, CloseMessag,PingMessage,PongMessage。TextMessag和BinaryMessage分别表示发送文本消息和二进制消息。CloseMessage关闭帧，接收方收到这个消息就关闭连接<br>PingMessage和PongMessage是保持心跳的帧，发送方接收方是PingMessage，接收方发送方是PongMessage，目前浏览器没有相关api发送ping给服务器，只能由服务器发ping给浏览器，浏览器返回pong消息。</p><h2 id="聊于室实现">聊于室实现</h2><p>  gorilla的websocket项目中有一个聊天室的demo，此处讲一下它的设计思路。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./chat.png" alt="avatar"><br>Hub</p><ul><li>Hub持有每一个Client的指针，broadcast管道里有数据时把它写入每一个Client的send管道中。</li><li>注销Client时关闭Client的send管道。</li></ul><p>Client</p><ul><li>前端(browser)请求建立websocket连接时，为这条websocket连接专门启一个协程，创建一个client。</li><li>client把前端发过来的数据写入hub的broadcast管道。</li><li>client把自身send管道里的数据写给前端。</li><li>client跟前端的连接断开时请求从hub那儿注销自己。</li></ul><p>Front</p><ul><li>当打开浏览器页面时，前端会请求建立websocket连接。</li><li>关闭浏览器页面时会主动关闭websocket连接。</li></ul><p>存活监测</p><ul><li>当hub发现client的send管道写不进数据时，把client注销掉。</li><li>client给websocket连接设置一个读超时，并周期性地给前端发ping消息，如果没有收到pong消息则下一次的conn.read()会报出超时错误，此时client关闭websocket连接。</li></ul><h3 id="服务端">服务端</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨域问题</span></span><br><span class="line"><span class="keyword">var</span> upgrader = websocket.Upgrader&#123;</span><br><span class="line">CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveHome</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">http.ServeFile(w, r, <span class="string">&quot;C:/Users/ren/Desktop/新建文件夹/chat/home.html&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建用户端类型</span></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">hub      *Hub            <span class="comment">//总线类型</span></span><br><span class="line">conn     *websocket.Conn <span class="comment">//websocket连接</span></span><br><span class="line">username []<span class="type">byte</span>          <span class="comment">//用户名</span></span><br><span class="line">send     <span class="keyword">chan</span> []<span class="type">byte</span>     <span class="comment">//每个用户收发消息管道</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从websocket连接读出数据，发给hub</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(client *Client)</span></span> read() &#123;</span><br><span class="line"><span class="comment">//收尾工作</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//从hub那注销client</span></span><br><span class="line">client.hub.unregister &lt;- client</span><br><span class="line">log.Printf(<span class="string">&quot;%s offline\n&quot;</span>, client.username)</span><br><span class="line">log.Printf(<span class="string">&quot;close connection to %s\n&quot;</span>, client.conn.RemoteAddr().String())</span><br><span class="line"><span class="comment">//关闭websocket管道</span></span><br><span class="line">client.conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_, message, err := client.conn.ReadMessage()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// 如果前端主动断开连接，会触发报错，退出循环读取</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 换行符用空格替代，并且把首位连续的空格去掉</span></span><br><span class="line">message = bytes.TrimSpace(bytes.Replace(message, []<span class="type">byte</span>&#123;<span class="string">&#x27;\n&#x27;</span>&#125;, []<span class="type">byte</span>&#123;<span class="string">&#x27; &#x27;</span>&#125;, <span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(client.username) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// 约定：第一次发言设置为用户名，该信息不进行广播</span></span><br><span class="line">client.username = message</span><br><span class="line">log.Printf(<span class="string">&quot;%s online\n&quot;</span>, client.username)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 要广播的内容前面加上用户名</span></span><br><span class="line">client.hub.broadcast &lt;- bytes.Join([][]<span class="type">byte</span>&#123;client.username, message&#125;, []<span class="type">byte</span>(<span class="string">&quot;: &quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从hub的broadcast读取数据，写到websocket连接里</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(client *Client)</span></span> write() &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 给前端写数据失败，就可以关闭连接了</span></span><br><span class="line">log.Printf(<span class="string">&quot;close connection to %s\n&quot;</span>, client.conn.RemoteAddr().String())</span><br><span class="line">client.conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">msg, ok := &lt;-client.send</span><br><span class="line"><span class="comment">// 正常情况是hub发来了数据，如果前端断开了连接，read()会触发client.send管道关闭，从而执行!ok</span></span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">client.conn.WriteMessage(websocket.CloseMessage, []<span class="type">byte</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通过NextWriter创建一个新的writer,主要是为了确保上一个writer已经被关闭，即它想写的内容已经flush到conn里去了</span></span><br><span class="line">writer, err := client.conn.NextWriter(websocket.TextMessage)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">writer.Write(msg)</span><br><span class="line">writer.Write([]<span class="type">byte</span>&#123;<span class="string">&#x27;\n&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果client.send里还有消息，则一次都写给前端</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(client.send); i++ &#123;</span><br><span class="line">writer.Write(&lt;-client.send)</span><br><span class="line">writer.Write([]<span class="type">byte</span>&#123;<span class="string">&#x27;\n&#x27;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 必须调用close,否则下次调用client.conn.NextWriter时本条消息才会发送到前端</span></span><br><span class="line">err = writer.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建总线类型</span></span><br><span class="line"><span class="keyword">type</span> Hub <span class="keyword">struct</span> &#123;</span><br><span class="line">clients    []*Client    <span class="comment">//维护所有Client</span></span><br><span class="line">register   <span class="keyword">chan</span> *Client <span class="comment">//Client注册请求通过管道来接收</span></span><br><span class="line">unregister <span class="keyword">chan</span> *Client <span class="comment">//Client注销请求通过管道来接收</span></span><br><span class="line">broadcast  <span class="keyword">chan</span> []<span class="type">byte</span>  <span class="comment">//需要广播的消息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总线启动方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(hub *Hub)</span></span> Run() &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> client := &lt;-hub.register:</span><br><span class="line">hub.clients = <span class="built_in">append</span>(hub.clients, client)</span><br><span class="line"><span class="keyword">case</span> client := &lt;-hub.unregister:</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> hub.clients &#123;</span><br><span class="line"><span class="keyword">if</span> client == v &#123;</span><br><span class="line"><span class="comment">// 注销client</span></span><br><span class="line">hub.clients = <span class="built_in">append</span>(hub.clients[:i], hub.clients[i+<span class="number">1</span>:]...)</span><br><span class="line"><span class="comment">// hub从此不再向该client广播消息</span></span><br><span class="line"><span class="built_in">close</span>(client.send)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-hub.broadcast:</span><br><span class="line"><span class="comment">// 一人发消息，广播到所有用户管道</span></span><br><span class="line"><span class="keyword">for</span> _, client := <span class="keyword">range</span> hub.clients &#123;</span><br><span class="line">client.send &lt;- msg</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SeveWs</span><span class="params">(hub *Hub, w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">//http升级到websocket协议</span></span><br><span class="line">conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;upgrade error: %v\n&quot;</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;connect to client %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="comment">//每来一个前端请求，就会创建一个client</span></span><br><span class="line">client := &amp;Client&#123;hub: hub, conn: conn, send: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">byte</span>, <span class="number">256</span>)&#125;</span><br><span class="line"><span class="comment">//向hub注册client</span></span><br><span class="line">client.hub.register &lt;- client</span><br><span class="line"></span><br><span class="line"><span class="comment">//websocket是全双工模式，可以同时read和write</span></span><br><span class="line"><span class="keyword">go</span> client.read()</span><br><span class="line"><span class="keyword">go</span> client.write()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总线构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHub</span><span class="params">()</span></span> *Hub &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Hub&#123;</span><br><span class="line"><span class="comment">// 维护所有用户</span></span><br><span class="line">clients:    <span class="built_in">make</span>([]*Client, <span class="number">0</span>),</span><br><span class="line">register:   <span class="built_in">make</span>(<span class="keyword">chan</span> *Client),</span><br><span class="line">unregister: <span class="built_in">make</span>(<span class="keyword">chan</span> *Client),</span><br><span class="line"><span class="comment">// 同步管道，确保hub里消息不会堆积，如果同时有多个client想给hub发数据就阻塞</span></span><br><span class="line">broadcast: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">byte</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 总线阻塞在子协程</span></span><br><span class="line">hub := NewHub()</span><br><span class="line"><span class="keyword">go</span> hub.Run()</span><br><span class="line"><span class="comment">// http监听,启动home主页</span></span><br><span class="line">port := flag.String(<span class="string">&quot;port&quot;</span>, <span class="string">&quot;5656&quot;</span>, <span class="string">&quot;http service port&quot;</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/&quot;</span>, serveHome)</span><br><span class="line"><span class="comment">// websocket路由</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/chat&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">SeveWs(hub, w, r)</span><br><span class="line">&#125;)</span><br><span class="line">log.Printf(<span class="string">&quot;http serve on port %s\n&quot;</span>, *port)</span><br><span class="line">err := http.ListenAndServe(<span class="string">&quot;:&quot;</span>+*port, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="客户端">客户端</h3><p><strong>go客户端</strong></p><p>writer</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息管道</span></span><br><span class="line"><span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">byte</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendMessage</span><span class="params">(conn websocket.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;close connection to %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line">conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">msg, ok := &lt;-ch</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">conn.WriteMessage(websocket.CloseMessage, []<span class="type">byte</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通过NextWriter创建一个新的writer,主要是为了确保上一个writer已经被关闭，即它想写的内容已经flush到conn里去了</span></span><br><span class="line">writer, err := conn.NextWriter(websocket.TextMessage)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">writer.Write(msg)</span><br><span class="line">writer.Write([]<span class="type">byte</span>&#123;<span class="string">&#x27;\n&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果ch里还有消息，则一次都写给前端</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(ch); i++ &#123;</span><br><span class="line">writer.Write(&lt;-ch)</span><br><span class="line">writer.Write([]<span class="type">byte</span>&#123;<span class="string">&#x27;\n&#x27;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 必须调用close,否则下次调用client.conn.NextWriter时本条消息才会发送到前端</span></span><br><span class="line">err = writer.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dialer := &amp;websocket.Dialer&#123;&#125;</span><br><span class="line">header := http.Header&#123;</span><br><span class="line"><span class="string">&quot;Cookie&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;name=zcy&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Dial:握手阶段，会发送一条http请求</span></span><br><span class="line">conn, resp, err := dialer.Dial(<span class="string">&quot;ws://localhost:5656/chat&quot;</span>, header)</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;dial server error:%v\n&quot;</span>, err)</span><br><span class="line">log.Println(resp.StatusCode)</span><br><span class="line">msg, _ := ioutil.ReadAll(resp.Body)</span><br><span class="line">log.Println(<span class="type">string</span>(msg))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动一个子协程阻塞监听管道消息，发送给服务端</span></span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> SendMessage(*conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始发言</span></span><br><span class="line">fmt.Println(<span class="string">&quot;please input your name and enter exit to exit&quot;</span>)</span><br><span class="line">scanner := bufio.NewScanner(os.Stdin)</span><br><span class="line"><span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">s := scanner.Text()</span><br><span class="line"><span class="keyword">if</span> s == <span class="string">&quot;exit&quot;</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 协定第一条消息为名字</span></span><br><span class="line">ch &lt;- []<span class="type">byte</span>(s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := scanner.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(ch)</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>reader</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadMessage</span><span class="params">(conn websocket.Conn)</span></span> &#123;</span><br><span class="line"><span class="comment">// defer wg.Done()</span></span><br><span class="line"><span class="comment">//收尾工作</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;close connection to %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="comment">//关闭websocket管道</span></span><br><span class="line">conn.Close()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_, message, err := conn.ReadMessage()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// 如果前端主动断开连接，会触发报错，退出循环读取</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 换行符用空格替代，并且把首位连续的空格去掉</span></span><br><span class="line"><span class="comment">// message = bytes.TrimSpace(bytes.Replace(message, []byte&#123;&#x27;\n&#x27;&#125;, []byte&#123;&#x27; &#x27;&#125;, -1))</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%s&quot;</span>, message)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dialer := &amp;websocket.Dialer&#123;&#125;</span><br><span class="line">header := http.Header&#123;</span><br><span class="line"><span class="string">&quot;Cookie&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;name=zcy&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Dial:握手阶段，会发送一条http请求</span></span><br><span class="line">conn, resp, err := dialer.Dial(<span class="string">&quot;ws://localhost:5656/chat&quot;</span>, header)</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;dial server error:%v\n&quot;</span>, err)</span><br><span class="line">log.Println(resp.StatusCode)</span><br><span class="line">msg, _ := ioutil.ReadAll(resp.Body)</span><br><span class="line">log.Println(<span class="type">string</span>(msg))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">ReadMessage(*conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang中socket编程</title>
      <link href="/20230114/golang-20230114-golang%E4%B8%ADsocket%E7%BC%96%E7%A8%8B/"/>
      <url>/20230114/golang-20230114-golang%E4%B8%ADsocket%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="网络通信过程">网络通信过程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png" alt="avatar"></p><ul><li>DMA：网卡和磁盘数据拷贝到内存流程比较固定，不涉及到运算操作，且非常耗时。在磁盘嵌入一个DMA芯片，完成上述拷贝工作，把CPU解脱出来，让CPU专注于运算。</li><li>mmap：用户空间和内核空间映射同一块内存空间，从而达到省略将数据从内核缓冲区拷贝到用户空间的操作，用户空间通过映射直接操作内核缓冲区的数据。</li></ul><p>阻塞式网络I/O</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E9%98%BB%E5%A1%9E%E5%BC%8F%E7%BD%91%E7%BB%9CIO.png" alt="avatar"></p><p>非阻塞式网络I/O</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E9%9D%9E%E9%98%BB%E5%A1%9E%E7%BD%91%E7%BB%9CIO.png" alt="avatar"></p><p>多路复用网络I/O</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%BD%91%E7%BB%9CIO.png" alt="avatar"></p><p>  socket把复杂的传输层协议封装成简单的接口，使应用层可以像读写文件一样进行网络数据的传输。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./socket%E5%B1%82.png" alt="avatar"></p><p>socket通信过程</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./socket%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png" alt="avatar"></p><h2 id="TCP-CS架构">TCP CS架构</h2><h3 id="网络通信模型">网络通信模型</h3><p>OSI参考模型</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./osi.png" alt="avatar"></p><p>TCP/IP模型</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tcp_ip.png" alt="avatar"><br>  传输层数据大小的上限为MSS(Maximum Segment Size, 最大分段大小)，网络接口层数据大小的上限为MTU(Maximum Transmit Unit, 最大传输单元)。</p><h3 id="TCP协议解读">TCP协议解读</h3><p>  MSS=MTU-ip首部-tcp首部，MTU视网络接口层的不同而不同。TCP在建立连接时通常需要协商双方的MSS值。应用层传输的数据大于MSS时需要分段。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tcp_segment.png" alt="avatar"><br>TCP首部<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tcp_head.png" alt="avatar"></p><ul><li>前20个字节是固定的，后面还4N个可选字节（TCP选项）。</li><li>数据偏移：TCP数据部分距TCP开头的偏移量（一个偏移量是4个字节， TCP选项占4N个字节），亦即TCP首部的长度。所以TCP首部的最大长度是15*4=60个字节，即TCP选项最多有40个字节。</li><li>端口在tcp层指定，ip在IP层指定。端口占2个字节，则最大端口号为2^16-1=65535。</li><li>由于应用层的数据被分段了，为了在接收端对数据按顺序重组，需要为每段数据编个“序号”。</li><li>TCP规定在连接建立后所有传送的报文段都必须把ACK设置为1。</li></ul><p>TCP建立连接<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tcp_connect.png" alt="avatar"></p><ul><li>第一次握手：TCP首部SYN=1，初始化一个序号=J。SYN报文段不能携带数据。</li><li>第二次握手：TCP首部SYN=1，ACK=1，确认号=J+1，初始化一个序号=K。此报文同样不携带数据。</li><li>第三次握手：SYN=1，ACK=1，序号=J+1，确认号=K+1。此次一般会携带真正需要传输的数据。</li><li>确认号：即希望下次对方发过来的序号值。</li><li>SYN Flood 攻击始终不进行第三次握手，属于DDOS攻击的一种。</li></ul><p>TCP释放连接<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tcp_disconect.png" alt="avatar"></p><ul><li>TCP的连接是全双工（可以同时发送和接收）的连接，因此在关闭连接的时候，必须关闭传送和接收两个方向上的连接。</li><li>第一次挥手：FIN=1，序号=M。</li><li>第二次挥手：ACK=1，序号=M+1。</li><li>第三次挥手：FIN=1，序号=N。</li><li>第四次挥手：ACK=1，序号=N+1。</li><li>从TIME_WAIT进入CLOSED需要经过2个MSL（Maxinum Segment Lifetime），RFC793建议MSL=2分钟。</li></ul><h3 id="Go-TCP编程">Go TCP编程</h3><ul><li>用三元给（ip地址，协议，端口号）唯一标示网络中的一个进程，如（172.122.121.111, tcp, 5656）。</li><li>IPv4的地址位数为32位，分为4段，每段最大取值为255。</li><li>IPv6的地址位数为128位，分为8段，各段用16进制表示，最大取值为ffff。</li><li>端口：0~1023被熟知的应用程序占用（普通应用程序不可以使用），49152~65535客户端程序运行时动态选择使用。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ResolveTCPAddr</span><span class="params">(net, addr <span class="type">string</span>)</span></span> (*TCPAddr, os.Error)</span><br></pre></td></tr></table></figure><p>  net参数是“tcp4”、“tcp6”、“tcp”中的任意一个，分别表示TCP（IPv4-only），TCP（IPv6-only）或者TCP（IPv4,、IPv6的任意一个）。addr表示域名或者IP地址，例如&quot; <a href="http://www.qq.com:80">www.qq.com:80</a>&quot; 或者&quot;127.0.0.1:22&quot;。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DialTCP</span><span class="params">(network <span class="type">string</span>, laddr, raddr *TCPAddr)</span></span> (*TCPConn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  network参数是&quot;tcp4&quot;、“tcp6”、&quot;tcp&quot;中的任意一个。laddr表示本机地址，一般设置为nil。raddr表示远程的服务地址。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">net</span>.<span class="title">DialTimeout</span><span class="params">(network <span class="type">string</span>, address <span class="type">string</span>, timeout time.Duration)</span></span> (net.Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  创建连接时设置超时时间。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*net.conn)</span></span> Write(b []<span class="type">byte</span>) (<span class="type">int</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  通过conn发送数据。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(net.Conn)</span></span>.Read(b []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  从conn里读取数据，如果没有数据可读，会阻塞。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ioutil</span>.<span class="title">ReadAll</span><span class="params">(r io.Reader)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  从conn中读取所有内容，直到遇到error(比如连接关闭)或EOF。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenTCP</span><span class="params">(network <span class="type">string</span>, laddr *TCPAddr)</span></span> (*TCPListener, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  监听端口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *TCPListener)</span></span> Accept() (Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  阻塞，直到有客户端请求建立连接。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*net.conn)</span></span> Close() <span class="type">error</span></span><br></pre></td></tr></table></figure><p>  关闭连接。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *TCPConn)</span></span> SetReadDeadline(t time.Time) <span class="type">error</span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *TCPConn)</span></span> SetWriteDeadline(t time.Time) <span class="type">error</span></span><br></pre></td></tr></table></figure><p>  设置从一个tcp连接上读取和写入的超时时间。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *TCPConn)</span></span> SetKeepAlive(keepalive <span class="type">bool</span>) os.Error</span><br></pre></td></tr></table></figure><p>  当一个tcp连接上没有数据时，操作系统会间隔性地发送心跳包，如果长时间没有收到心跳包会认为连接已经断开。</p><p>tcp_server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleRequest2</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line"><span class="comment">//30秒后conn.Read会报出i/o timeout</span></span><br><span class="line">conn.SetReadDeadline(time.Now().Add(<span class="number">30</span> * time.Second))</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"><span class="comment">//长连接，即连接建立后进行多轮的读写交互</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">//初始化后byte数组每个元素都是0</span></span><br><span class="line">requestBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">256</span>)</span><br><span class="line">read_len, err := conn.Read(requestBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;read from socket error: %s\n&quot;</span>, err.Error())</span><br><span class="line"><span class="comment">//到达deadline后，退出for循环，关闭连接。client再用这个连接读写会发生错误</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//[]byte转string时，0后面的会自动被截掉</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;receive request %s\n&quot;</span>, <span class="type">string</span>(requestBytes[:read_len]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> request Request</span><br><span class="line"><span class="comment">//json反序列化时会把0都考虑在内，所以需要指定只读前read_len个字节</span></span><br><span class="line">json.Unmarshal(requestBytes[:read_len], &amp;request)</span><br><span class="line">response := Response&#123;Sum: request.A + request.B&#125;</span><br><span class="line"></span><br><span class="line">responseBytes, _ := json.Marshal(response)</span><br><span class="line">_, err = conn.Write(responseBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;write response %s\n&quot;</span>, <span class="type">string</span>(responseBytes))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 长连接</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ip := <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port := <span class="number">5656</span></span><br><span class="line">tcpAddr, err := net.ResolveTCPAddr(<span class="string">&quot;tcp4&quot;</span>, ip+<span class="string">&quot;:&quot;</span>+strconv.Itoa(port))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">listener, err := net.ListenTCP(<span class="string">&quot;tcp4&quot;</span>, tcpAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;waiting for client connection ......&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//操作系统会随机给客户端分配一个49152~65535上的端口号</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;establish connection to client %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="keyword">go</span> handleRequest2(conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>tcp_client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 长连接</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">conn, err := net.DialTimeout(<span class="string">&quot;tcp4&quot;</span>, <span class="string">&quot;127.0.0.1:5656&quot;</span>, <span class="number">30</span>*time.Minute)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;establish connection to server %s\n&quot;</span>, conn.RemoteAddr().String())</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"><span class="comment">//长连接，即连接建立后进行多轮的读写交互</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line">request := Request&#123;A: rand.Intn(<span class="number">100</span>), B: rand.Intn(<span class="number">100</span>)&#125;</span><br><span class="line">requestBytes, _ := json.Marshal(request)</span><br><span class="line">_, err = conn.Write(requestBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;write request %s\n&quot;</span>, <span class="type">string</span>(requestBytes))</span><br><span class="line"><span class="comment">//初始化后byte数组每个元素都是0</span></span><br><span class="line">responseBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">256</span>)</span><br><span class="line">read_len, err := conn.Read(responseBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> response Response</span><br><span class="line"><span class="comment">//json反序列化时会把0都考虑在内，所以需要指定只读前read_len个字节</span></span><br><span class="line">json.Unmarshal(responseBytes[:read_len], &amp;response)</span><br><span class="line">fmt.Printf(<span class="string">&quot;receive response: %d\n&quot;</span>, response.Sum)</span><br><span class="line">time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="UDP-CS架构">UDP CS架构</h2><h3 id="UDP协议解读">UDP协议解读</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./udp_datagram.png" alt="avatar"></p><ul><li>UDP首部占8个字节，所以UDP报文长度最小是8B。</li><li>不需要建立连接，直接收发数据，效率很高</li><li>面向报文。对应用层交下来的报文，既不合并也不拆分，直接加上边界交给IP层。TCP是面向字节流，TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送；如果应用程序一次只发送一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去。</li><li>从机制上不保证顺序（在IP层要对数据分段），可能会丢包（检验和如果出差错就会把这个报文丢弃掉）。在内网环境下分片乱序和数据丢包极少发生。</li><li>支持一对一、一对多、多对一和多对多的交互通信。</li></ul><h3 id="Go-UDP编程">Go UDP编程</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">net</span>.<span class="title">Dial</span><span class="params">(network <span class="type">string</span>, address <span class="type">string</span>)</span></span> (net.Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  netwok指定为udp，建立udp连接（伪连接）。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">net</span>.<span class="title">DialTimeout</span><span class="params">(network <span class="type">string</span>, address <span class="type">string</span>, timeout time.Duration)</span></span> (net.Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  netwok指定为udp，建立连接时指定超时。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">net</span>.<span class="title">ResolveUDPAddr</span><span class="params">(network <span class="type">string</span>, address <span class="type">string</span>)</span></span> (*net.UDPAddr, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  解析成udp地址。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">net</span>.<span class="title">ListenUDP</span><span class="params">(network <span class="type">string</span>, laddr *net.UDPAddr)</span></span> (*net.UDPConn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  直接调用Listen就返回一个udp连接。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*net.UDPConn)</span></span>.ReadFromUDP(b []<span class="type">byte</span>) (<span class="type">int</span>, *net.UDPAddr, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  读数据，会返回remote的地址。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*net.UDPConn)</span></span>.WriteToUDP(b []<span class="type">byte</span>, addr *net.UDPAddr) (<span class="type">int</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>  写数据，需要指定remote的地址。<br>udp_server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ip := <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port := <span class="number">5656</span></span><br><span class="line">udpAddr, err := net.ResolveUDPAddr(<span class="string">&quot;udp&quot;</span>, ip+<span class="string">&quot;:&quot;</span>+strconv.Itoa(port))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//UDP不需要创建连接，所以不需要像TCP那样通过Accept()创建连接，这里的conn是个假连接</span></span><br><span class="line">conn, err := net.ListenUDP(<span class="string">&quot;udp&quot;</span>, udpAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 30秒后断开连接</span></span><br><span class="line"><span class="comment">// conn.SetReadDeadline(time.Now().Add(30 * time.Second))</span></span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">//初始化后byte数组每个元素都是0</span></span><br><span class="line">requestBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">256</span>)</span><br><span class="line"><span class="comment">//一个conn可以对应多个client，ReadFrom表示返回是哪个</span></span><br><span class="line">read_len, remoteAddr, err := conn.ReadFromUDP(requestBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;read from socket error: %s\n&quot;</span>, err.Error())</span><br><span class="line"><span class="comment">//到达deadline后，退出for循环，关闭连接。client再用这个连接读写会发生错误</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//[]byte转string时，0后面的会自动被截掉</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;receive request %s from %s\n&quot;</span>, <span class="type">string</span>(requestBytes), remoteAddr.String())</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> request Request</span><br><span class="line"><span class="comment">//json反序列化时会把0都考虑在内，所以需要指定只读前read_len个字节</span></span><br><span class="line">json.Unmarshal(requestBytes[:read_len], &amp;request)</span><br><span class="line">response := Response&#123;Sum: request.A + request.B&#125;</span><br><span class="line"></span><br><span class="line">responseBytes, _ := json.Marshal(response)</span><br><span class="line"><span class="comment">//由于UDP conn支持多对多通信，所以通信对方可能有多个EndPoint，通过WriteTo指定要写给哪个EndPoint</span></span><br><span class="line">_, err = conn.WriteToUDP(responseBytes, remoteAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;write response %s to %s\n&quot;</span>, <span class="type">string</span>(responseBytes), remoteAddr.String())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>udp_client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">Request <span class="keyword">struct</span> &#123;</span><br><span class="line">A <span class="type">int</span></span><br><span class="line">B <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">Response <span class="keyword">struct</span> &#123;</span><br><span class="line">Sum <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ip := <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port := <span class="number">5656</span></span><br><span class="line"><span class="comment">//跟tcp_client的唯一区别就是这行代码</span></span><br><span class="line">conn, err := net.DialTimeout(<span class="string">&quot;udp&quot;</span>, ip+<span class="string">&quot;:&quot;</span>+strconv.Itoa(port), <span class="number">30</span>*time.Minute) <span class="comment">//一个conn绑定一个本地端口</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"><span class="keyword">const</span> P = <span class="number">10</span></span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(P)</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; P; i++ &#123;</span><br><span class="line">request := Request&#123;A: rand.Intn(<span class="number">100</span>), B: rand.Intn(<span class="number">100</span>)&#125;</span><br><span class="line">requestBytes, _ := json.Marshal(request)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//多协程，共用一个conn</span></span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">_, err = conn.Write(requestBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;write request %s\n&quot;</span>, <span class="type">string</span>(requestBytes))</span><br><span class="line">responseBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">256</span>)</span><br><span class="line">read_len, err := conn.Read(responseBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> response Response</span><br><span class="line"><span class="comment">//json反序列化时会把0都考虑在内，所以需要指定只读前read_len个字节</span></span><br><span class="line">json.Unmarshal(responseBytes[:read_len], &amp;response)</span><br><span class="line">fmt.Printf(<span class="string">&quot;receive response: %d\n&quot;</span>, response.Sum)</span><br><span class="line">time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>  由于UDP不需要建立连接，所以通过Dial()创建的是一个虚拟连接， Dial()总是会立即返回成功，即使对方还没有准备好。所以UDP可以先启client，再启server。由于是虚拟连接所以多个client可以共用一个conn，所以Server端往conn里写数据时需要指定写给哪个client，同理从conn里读数据会返回client的Address，即WriteToUDP (b []byte, addr *net.UDPAddr)和ReadFromUDP(b []byte) (int, *net.UDPAddr, error)。由于UDP是无连接和，对方关闭连接后，本方再在conn上调用Write和Read不会报错。<br>  应用层的一条完整数据称为报文。TCP是面向字节流的，一次Read到的数据可能包含了多个报文，也可能只包含了半个报文，一条报文在什么地方结束需要通信双方事先约定好。UDP是面向报文的，一次Read只读一个报文，如果没有把一个报文读完，后面的内容会被丢弃掉，下次就读不到了。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库http</title>
      <link href="/20230112/golang-20230112-golang%E6%A0%87%E5%87%86%E5%BA%93http/"/>
      <url>/20230112/golang-20230112-golang%E6%A0%87%E5%87%86%E5%BA%93http/</url>
      
        <content type="html"><![CDATA[<h2 id="http协议">http协议</h2><ul><li>http：超文本传输协议Hyper Text Transfer Protocol。</li><li>http属于应用层协议，它在传输层用的是tcp协议。</li><li>无状态，对事务处理没有记忆能力（对比TCP协议里的确认号）。如果要保存状态需要引用其他技术，如cookie。</li><li>无连接，每次连接只处理一个请求。早期带宽和计算资源有限，这么做是为了追求传输速度快，后来通过Connection: Keep-Alive实现长连接。http1.1废弃了Keep-Alive，默认支持长连接。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./request.png width=700 />  <h3 id="请求方法">请求方法</h3><table><thead><tr><th style="text-align:center">请求方法</th><th style="text-align:left">解释</th></tr></thead><tbody><tr><td style="text-align:center">GET</td><td style="text-align:left">请求获取Request-URI所标识的资源</td></tr><tr><td style="text-align:center">POST</td><td style="text-align:left">向URI提交数据（例如提交表单或上传数据）</td></tr><tr><td style="text-align:center">HEAD</td><td style="text-align:left">类似于GET，返回的响应中没有具体的内容，用于获取报头</td></tr><tr><td style="text-align:center">PUT</td><td style="text-align:left">对服务器上已存在的资源进行更新</td></tr><tr><td style="text-align:center">DELETE</td><td style="text-align:left">请求服务器删除指定的页面</td></tr><tr><td style="text-align:center">CONNECT</td><td style="text-align:left">HTTP/1.1预留，能够将连接改为管道方式的代理服务器</td></tr><tr><td style="text-align:center">OPTIONS</td><td style="text-align:left">查看服务端性能</td></tr><tr><td style="text-align:center">TRACE</td><td style="text-align:left">回显服务器收到的请求，主要用于测试或诊断</td></tr><tr><td style="text-align:center">PATCH</td><td style="text-align:left">同PUT，可只对资源的一部分更新，资源不存在时会创建</td></tr></tbody></table><p>  GET、POST和HEAD是http1.0就有的，后面的请求方法是http1.1新增的。客户端发起一个请求时，这个请求可能要穿过防火墙、代理、网关或其他一些应用程序。每个中间节点都可能会修改原始的HTTP请求。TRACE 方法允许客户端在 最终将请求发送给服务器时，看看它变成了什么样子。TRACE请求会在目的服务器端发起一个环回诊断。行程最后一站的服务器会弹回一条TRACE响应，并在响应主体中携带它收到的原始请求报文。这样客户端就可以查看在所有中间HTTP应用程序组成的请求/响应链上，原始报文是否，以及如何被毁坏或修改过。CONNECT方法是HTTP/1.1协议预留的，能够将连接改为管道方式的代理服务器。通常用于SSL加密服务器的链接与非加密的HTTP代理服务器的通信。OPTIONS方法请求Web服务器告知其支持的各种功能。通过使用OPTIONS，客户端可以在与服务器进行交互之前，确定服务器的能力，这样它就可以更方便地与具备不同特性的代理和服务器进行互操作了。<br>  实际中server对各种request method的处理方式可能不是按协义标准来的，比如server收到PUT请求时偏偏执行DELETE操作，同理仅用一个GET方法也能实现增删改查的全部功能。大多数浏览器只支持GET和POST。</p><h3 id="URL">URL</h3><ul><li>URI：uniform resource identifier，统一资源标识符，用来唯一的标识一个资源。</li><li>URL： uniform resource locator，统一资源定位器，它是一种具体的URI，指明了如何locate这个资源。</li><li>URL举例：</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./url.png width=700 /><h3 id="协议版本">协议版本</h3><p>  现在广泛应用的协议版本是HTTP/1.1。</p><h3 id="请求头">请求头</h3><table><thead><tr><th style="text-align:center">Header</th><th style="text-align:left">解释</th><th style="text-align:left">示例</th></tr></thead><tbody><tr><td style="text-align:center">Accept</td><td style="text-align:left">指定客户端能够接收的内容类型</td><td style="text-align:left">Accept: text/plain, text/html</td></tr><tr><td style="text-align:center">Accept-Charset</td><td style="text-align:left">浏览器可以接受的字符编码集</td><td style="text-align:left">Accept-Charset: iso-8859-5</td></tr><tr><td style="text-align:center">Accept-Encoding</td><td style="text-align:left">指定浏览器可以支持的web服务器返回内容压缩编码类型</td><td style="text-align:left">Accept-Encoding: compress, gzip</td></tr><tr><td style="text-align:center">Accept-Language</td><td style="text-align:left">浏览器可接受的语言</td><td style="text-align:left">Accept-Language: en,zh</td></tr><tr><td style="text-align:center">Authorization</td><td style="text-align:left">HTTP授权的授权证书</td><td style="text-align:left">Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</td></tr><tr><td style="text-align:center">Cache-Control</td><td style="text-align:left">指定请求和响应遵循的缓存机制</td><td style="text-align:left">Cache-Control: no-cache</td></tr><tr><td style="text-align:center">Connection</td><td style="text-align:left">表示是否需要持久连接（HTTP 1.1默认进行持久连接）</td><td style="text-align:left">Connection: close</td></tr><tr><td style="text-align:center">Cookie</td><td style="text-align:left">HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器</td><td style="text-align:left">Cookie: $Version=1; Skin=new;</td></tr><tr><td style="text-align:center">Content-Length</td><td style="text-align:left">请求的内容长度</td><td style="text-align:left">Content-Length: 348</td></tr><tr><td style="text-align:center">Content-Type</td><td style="text-align:left">指定正文(body)的数据格式</td><td style="text-align:left">Content-Type: application/x-www-form-urlencoded</td></tr><tr><td style="text-align:center">User-Agent</td><td style="text-align:left">浏览器信息</td><td style="text-align:left">Mozilla/5.0 (Windows NT 6.1; Win64; x64)</td></tr></tbody></table><p>Content-Type</p><ul><li>application/x-www-form-urlencoded<ul><li>浏览器的原生form表单，如果不设置 Content-Type 属性，则默认以 application/x-www-form-urlencoded 方式传输数据</li><li>正文例如：name=manu&amp;message=this_is_great</li></ul></li><li>multipart/form-data<ul><li>上传文件时使用multipart/form-data，支持多种文件格式</li><li>正文例如： name=&quot;text&quot;name=“file”; filename=&quot;chrome.png&quot;Content-Type: image/png… content of chrome.png</li></ul></li><li>application/json<ul><li>正文例如：{“title”:“test”,“sub”:[1,2,3]}</li></ul></li><li>text/xml<ul><li>正文例如：<?xml version="1.0"?><methodCall>    <methodName>examples.getStateName</methodName>    </methodCall></li></ul></li></ul><h3 id="请求正文">请求正文</h3><p>  GET请求没有请求正文。POST即可以把一部分参数放在url里，也可以把一部分参数放在请求正文里，如下是一个完整的POST请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /post?id=1234&amp;page=1 HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">name=manu&amp;message=this_is_great</span><br></pre></td></tr></table></figure><p>GET和POST的区别：</p><ol><li>get的请求参数全部在url里，参数变时url就变；post可以把参数放到请求正文里，参数变时url不变。</li><li>虽然http协议并没有对url和请求正文做长度限制，但在实际中浏览器对url的长度限制比请求正文要小很多，所以post可以提交的数据比get要大得多。</li><li>get比post更容易受到攻击（源于get的参数直接暴露在url里）。</li></ol><h3 id="http-response">http response</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./response.png width=550 /><p>响应状态及话术</p><table><thead><tr><th style="text-align:center">code</th><th style="text-align:left">phrase</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:center">200</td><td style="text-align:left">Ok</td><td style="text-align:left">请求成功</td></tr><tr><td style="text-align:center">400</td><td style="text-align:left">Bad Request</td><td style="text-align:left">客户端有语法错误，服务端不理解</td></tr><tr><td style="text-align:center">401</td><td style="text-align:left">Unauthorized</td><td style="text-align:left">请求未经授权</td></tr><tr><td style="text-align:center">403</td><td style="text-align:left">Forbidden</td><td style="text-align:left">服务端拒绝提供服务</td></tr><tr><td style="text-align:center">404</td><td style="text-align:left">Not Found</td><td style="text-align:left">请求资源不存在</td></tr><tr><td style="text-align:center">500</td><td style="text-align:left">Internal Server Error</td><td style="text-align:left">服务器发生不可预期的错误</td></tr><tr><td style="text-align:center">503</td><td style="text-align:left">Server Unavailable</td><td style="text-align:left">服务器当前有问题，过段时间可能恢复</td></tr></tbody></table><p>响应头</p><table><thead><tr><th style="text-align:center">Header</th><th style="text-align:left">解释</th><th style="text-align:left">示例</th></tr></thead><tbody><tr><td style="text-align:center">Allow</td><td style="text-align:left">对某网络资源的有效的请求行为</td><td style="text-align:left">Allow: GET, HEAD</td></tr><tr><td style="text-align:center">Date</td><td style="text-align:left">原始服务器消息发出的时间</td><td style="text-align:left">Date: Tue, 15 Nov 2010 08:12:31 GMT</td></tr><tr><td style="text-align:center">Content-Encoding</td><td style="text-align:left">服务器支持的返回内容压缩编码类型</td><td style="text-align:left">Content-Encoding: gzip</td></tr><tr><td style="text-align:center">Content-Language</td><td style="text-align:left">响应体的语言</td><td style="text-align:left">Content-Language: en,zh</td></tr><tr><td style="text-align:center">Content-Length</td><td style="text-align:left">响应体的长度</td><td style="text-align:left">Content-Length: 348</td></tr><tr><td style="text-align:center">Cache-Control</td><td style="text-align:left">指定请求和响应遵循的缓存机制</td><td style="text-align:left">Cache-Control: no-cache</td></tr><tr><td style="text-align:center">Content-Type</td><td style="text-align:left">返回内容的MIME类型</td><td style="text-align:left">Content-Type: text/html; charset=utf-8</td></tr></tbody></table><p>  响应正文可以是html、json、xml、普通文本，等等。<br>完整http response举例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK </span><br><span class="line">Date: Fri, 22 May 2009 06:07:21 GMT </span><br><span class="line">Content-Type: text/html; charset=UTF-8 </span><br><span class="line"></span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;head&gt;&lt;/head&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line"> &lt;!--body goes here--&gt; </span><br><span class="line">&lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="https">https</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./https.png width=400 /><p>HTTP + 加密 + 认证 + 完整性保护 = HTTPS（HTTP Secure）</p><h2 id="go语言http标准库">go语言http标准库</h2><p>http_server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Println(<span class="string">&quot;---------------------------------------------------&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request method: %s\n&quot;</span>, r.Method)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request host: %s\n&quot;</span>, r.Host)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request url: %s\n&quot;</span>, r.URL)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request proto: %s\n&quot;</span>, r.Proto)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> r.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;request header %s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, cookie := <span class="keyword">range</span> r.Cookies() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;request cookie: name=%s vaue=%s\n&quot;</span>, cookie.Name, cookie.Value)</span><br><span class="line">&#125;</span><br><span class="line">BodyData, _ := io.ReadAll(r.Body)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request body:: %v\n&quot;</span>, BodyData)</span><br><span class="line"><span class="comment">//把返回的内容写入http.ResponseWriter</span></span><br><span class="line">fmt.Fprint(w, <span class="string">&quot;Hello Boy&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//路由，请求要目录时去执行HelloHandler</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/&quot;</span>, HelloHandler)</span><br><span class="line"><span class="comment">//ListenAndServe如果不发生error会一直阻塞。为每一个请求单独创建一个协程去处理</span></span><br><span class="line"><span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:5656&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>request method: POST<br>request host: 127.0.0.1:5656<br>request url: /<br>request proto: HTTP/1.1<br>request header Accept-Encoding: [gzip]<br>request header User-Agent: [Go-http-client/1.1]<br>request header Content-Length: [12]<br>request header Content-Type: [text/plain]<br>request body:: Hello Server</p><p>http_client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">simpleGet</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5656&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 响应体</span></span><br><span class="line">b, err2 := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;response body: %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">simplePost</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//把string转成io.Reader</span></span><br><span class="line">reader := strings.NewReader(<span class="string">&quot;Hello Server&quot;</span>)</span><br><span class="line"><span class="comment">//Content-Type为text/plain，表示一个朴素的字符串</span></span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://127.0.0.1:5656&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, reader); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(<span class="string">&quot;response body: &quot;</span>)</span><br><span class="line"><span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">io.Copy(os.Stdout, resp.Body)</span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    simpleGet()</span><br><span class="line">    simplePost()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>response proto: HTTP/1.1<br>response status: 200 OK<br>response header<br>Date: [Fri, 13 Jan 2023 14:21:03 GMT]<br>Content-Length: [9]<br>Content-Type: [text/plain; charset=utf-8]<br>response body: Hello Boy</p><h2 id="路由插件">路由插件</h2><ul><li>安装 go get -u <a href="http://github.com/julienschmidt/httprouter">github.com/julienschmidt/httprouter</a></li><li>Router实现了http.Handler接口。</li><li>为各种request method提供了便捷的路由方式。</li><li>支持restful请求方式。</li><li>支持ServeFiles访问静态文件。</li><li>可以自定义捕获panic的方法。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/julienschmidt/httprouter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(w http.ResponseWriter, r *http.Request, params httprouter.Params)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;request method: %s\n&quot;</span>, r.Method)</span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;Hi boy, you request get&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">post</span><span class="params">(w http.ResponseWriter, r *http.Request, params httprouter.Params)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;request method: %s\n&quot;</span>, r.Method)</span><br><span class="line">fmt.Printf(<span class="string">&quot;request body: &quot;</span>)</span><br><span class="line">b, err := io.ReadAll(r.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;request body: %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;post success&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">restfulPost</span><span class="params">(rw http.ResponseWriter, r *http.Request, p httprouter.Params)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;name:%s, type:%s, addr:%s\n&quot;</span>, p.ByName(<span class="string">&quot;name&quot;</span>), p.ByName(<span class="string">&quot;type&quot;</span>), p.ByName(<span class="string">&quot;addr&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">panic</span><span class="params">(w http.ResponseWriter, r *http.Request, params httprouter.Params)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> arr []<span class="type">int</span></span><br><span class="line">_ = arr[<span class="number">1</span>] <span class="comment">//数组越界panic</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := httprouter.New()</span><br><span class="line"><span class="comment">//通过recover捕获panic</span></span><br><span class="line">router.PanicHandler = <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request, err <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="comment">//设置response status</span></span><br><span class="line">w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">log.Println(err)</span><br><span class="line">fmt.Fprintf(w, <span class="string">&quot;内部错误&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">router.GET(<span class="string">&quot;/panic&quot;</span>, <span class="built_in">panic</span>)</span><br><span class="line">router.GET(<span class="string">&quot;/&quot;</span>, get)</span><br><span class="line">router.POST(<span class="string">&quot;/post&quot;</span>, post)</span><br><span class="line"><span class="comment">// *只能有一个，且必须放path的末尾。</span></span><br><span class="line">router.POST(<span class="string">&quot;/user/:name/:type/*addr&quot;</span>, restfulPost)</span><br><span class="line"><span class="comment">// 静态文件必须以/*filepath结尾，因为要获取我们要访问的路径信息</span></span><br><span class="line">router.ServeFiles(<span class="string">&quot;/file/*filepath&quot;</span>, http.Dir(<span class="string">&quot;./static&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//Router实现了ServerHTTP接口，所以它是一种http.Handler</span></span><br><span class="line">http.ListenAndServe(<span class="string">&quot;:5656&quot;</span>, router)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="结合gin路由">结合gin路由</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: http.StatusOK, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;hello test&quot;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 关闭debug</span></span><br><span class="line"><span class="comment">// gin.SetMode(gin.ReleaseMode)</span></span><br><span class="line">r := gin.Default()</span><br><span class="line">r.GET(<span class="string">&quot;/test&quot;</span>, test)</span><br><span class="line">server := http.Server&#123;</span><br><span class="line">ReadHeaderTimeout: <span class="number">60</span> * time.Second,</span><br><span class="line">ReadTimeout:       <span class="number">60</span> * time.Second,</span><br><span class="line">WriteTimeout:      <span class="number">60</span> * time.Second,</span><br><span class="line">IdleTimeout:       <span class="number">60</span> * time.Second,</span><br><span class="line">MaxHeaderBytes:    <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="comment">// 1M</span></span><br><span class="line">Addr:              <span class="string">&quot;127.0.0.1:8080&quot;</span>,</span><br><span class="line">Handler:           r,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="请求校验">请求校验</h2><p>  首先安装go get <a href="http://github.com/go-playground/validator">github.com/go-playground/validator</a></p><p>范围约束</p><ul><li>对于字符串、切片、数组和map，约束其长度。len=10, min=6, max=10, gt=10。</li><li>对于数值，约束其取值。min, max, eq, ne, gt, gte, lt, lte, oneof=6 8。</li></ul><p>跨字段约束</p><ul><li>跨字段就在范围约束的基础上加field后缀。</li><li>如果还跨结构体(cross struct)就在跨字段的基础上在field前面加cs：范围约束 cs field。</li></ul><p>字符串约束</p><ul><li>contains包含子串。</li><li>containsany包含任意unicode字符， containsany=abcd。</li><li>containsrune包含rune字符， containsrune= ☻。</li><li>excludes不包含子串。</li><li>excludesall不包含任意的unicode字符，excludesall=abcd。</li><li>excludesrune不包含rune字符，excludesrune=☻。</li><li>startswith以子串为前缀。</li><li>endswith以子串为后缀。</li></ul><p>唯一性uniq</p><ul><li>对于数组和切片，约束没有重复的元素。</li><li>对于map，约束没的重复的value。</li><li>对于元素类型为结构体的切片，unique约束结构体对象的某个字段不重复，通过unqiue=field指定这个字段名。<br>Friends []User <code>validate:&quot;unique=Name&quot;</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;regexp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/go-playground/validator&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val = validator.New()</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RegistRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">UserName   <span class="type">string</span> <span class="string">`validate:&quot;gt=0&quot;`</span>             <span class="comment">// &gt;0  长度大于0</span></span><br><span class="line">PassWord   <span class="type">string</span> <span class="string">`validate:&quot;min=6,max=12&quot;`</span>     <span class="comment">//密码长度[6, 12]</span></span><br><span class="line">PassRepeat <span class="type">string</span> <span class="string">`validate:&quot;eqfield=PassWord&quot;`</span> <span class="comment">//跨字段相等校验</span></span><br><span class="line">Email      <span class="type">string</span> <span class="string">`validate:&quot;email&quot;`</span>            <span class="comment">//需要满足email的格式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> InnerRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">Pass  <span class="type">string</span> <span class="string">`validate:&quot;min=6,max=12&quot;`</span> <span class="comment">//密码长度[6, 12]</span></span><br><span class="line">Email <span class="type">string</span> <span class="string">`validate:&quot;email&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OutterRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">PassWord   <span class="type">string</span> <span class="string">`validate:&quot;eqcsfield=Nest.Pass&quot;`</span> <span class="comment">//跨结构体相等校验</span></span><br><span class="line">PassRepeat <span class="type">string</span> <span class="string">`validate:&quot;eqfield=PassWord&quot;`</span>    <span class="comment">//跨字段相等校验</span></span><br><span class="line">Nest       InnerRequest</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validateEmail</span><span class="params">(fl validator.FieldLevel)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">input := fl.Field().String()</span><br><span class="line"><span class="keyword">if</span> pass, _ := regexp.MatchString(<span class="string">`^([\w\.\_]&#123;2,10&#125;)@(\w&#123;1,&#125;)\.([a-z]&#123;2,4&#125;)$`</span>, input); pass &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processErr</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给Validate.Struct()函数传了一个非法的参数</span></span><br><span class="line">invalid, ok := err.(*validator.InvalidValidationError)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;param error:&quot;</span>, invalid)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ValidationErrors是一个错误切片，它保存了每个字段违反的每个约束信息</span></span><br><span class="line">validationErrs := err.(validator.ValidationErrors)</span><br><span class="line"><span class="keyword">for</span> _, validationErr := <span class="keyword">range</span> validationErrs &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;field %s 不满足条件 %s\n&quot;</span>, validationErr.Field(), validationErr.Tag())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//注册一个自定义的validator</span></span><br><span class="line">val.RegisterValidation(<span class="string">&quot;email&quot;</span>, validateEmail)</span><br><span class="line"></span><br><span class="line">req := RegistRequest&#123;</span><br><span class="line">UserName:   <span class="string">&quot;zcy&quot;</span>,</span><br><span class="line">PassWord:   <span class="string">&quot;12345&quot;</span>,</span><br><span class="line">PassRepeat: <span class="string">&quot;1234568&quot;</span>,</span><br><span class="line">Email:      <span class="string">&quot;123qq.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Struct()返回的error分为两种类型：InvalidValidationError和ValidationErrors</span></span><br><span class="line">processErr(val.Struct(req))</span><br><span class="line">processErr(val.Struct(<span class="number">3</span>))</span><br><span class="line">fmt.Println(<span class="string">&quot;==============&quot;</span>)</span><br><span class="line"></span><br><span class="line">inreq := InnerRequest&#123;</span><br><span class="line">Pass:  <span class="string">&quot;1234567&quot;</span>,</span><br><span class="line">Email: <span class="string">&quot;123qq.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">outreq := OutterRequest&#123;</span><br><span class="line">PassWord:   <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">PassRepeat: <span class="string">&quot;1234568&quot;</span>,</span><br><span class="line">Nest:       inreq,</span><br><span class="line">&#125;</span><br><span class="line">processErr(val.Struct(outreq))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>field PassWord 不满足条件 min<br>field PassRepeat 不满足条件 eqfield<br>field Email 不满足条件 email<br>param error: validator: (nil int)<br>==============<br>field PassWord 不满足条件 eqcsfield<br>field PassRepeat 不满足条件 eqfield<br>field Email 不满足条件 email</p><h2 id="http中间件">http中间件</h2><p>  中间件的作用：将业务代码和非业务代码解耦。非业务代码指限流、超时控制、打日志等等。<br>  中间件的实现原理：传入一个http.Handler，外面套上一些非业务功能代码，再返回一个http.Handler。支持中间件层层嵌套。通过HandlerFunc把一个func(rw http.ResponseWriter, r *http.Request)函数转为Handler。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最多并发处理100个请求</span></span><br><span class="line"><span class="keyword">var</span> limitCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getBoy</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">150</span> * time.Millisecond)</span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;hi boy&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getGirl</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">150</span> * time.Millisecond)</span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;hi girl&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeMiddleWare</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="comment">//通过HandlerFunc把一个func(rw http.ResponseWriter, r *http.Request)函数转为Handler</span></span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">begin := time.Now()</span><br><span class="line">next.ServeHTTP(rw, r)</span><br><span class="line">timeElapsed := time.Since(begin)</span><br><span class="line">log.Printf(<span class="string">&quot;request %s use %d ms\n&quot;</span>, r.URL.Path, timeElapsed.Milliseconds())</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">limitMiddleWare</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="comment">//通过HandlerFunc返回一个Handler</span></span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">//并发度达到100时就会阻塞</span></span><br><span class="line">limitCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;concurrence %d\n&quot;</span>, <span class="built_in">len</span>(limitCh))</span><br><span class="line">next.ServeHTTP(rw, r)</span><br><span class="line">&lt;-limitCh</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">以下演示更优雅的中间件组织形式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> middleware <span class="function"><span class="keyword">func</span><span class="params">(http.Handler)</span></span> http.Handler</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Router <span class="keyword">struct</span> &#123;</span><br><span class="line">middlewareChain []middleware</span><br><span class="line">mux             <span class="keyword">map</span>[<span class="type">string</span>]http.Handler <span class="comment">//mux通常表示路由策略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouter</span><span class="params">()</span></span> *Router &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Router&#123;</span><br><span class="line">middlewareChain: <span class="built_in">make</span>([]middleware, <span class="number">0</span>, <span class="number">10</span>),</span><br><span class="line">mux:             <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]http.Handler, <span class="number">10</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *Router)</span></span> Use(m middleware) &#123;</span><br><span class="line">self.middlewareChain = <span class="built_in">append</span>(self.middlewareChain, m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *Router)</span></span> Add(path <span class="type">string</span>, handler http.Handler) &#123;</span><br><span class="line"><span class="keyword">var</span> mergedHandler = handler</span><br><span class="line"><span class="keyword">for</span> i := <span class="built_in">len</span>(self.middlewareChain) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">mergedHandler = self.middlewareChain[i](mergedHandler) <span class="comment">//中间件层层嵌套</span></span><br><span class="line">&#125;</span><br><span class="line">self.mux[path] = mergedHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// http.Handle(&quot;/&quot;, timeMiddleWare(limitMiddleWare(http.HandlerFunc(getBoy))))      //中间层层嵌套</span></span><br><span class="line"><span class="comment">// http.Handle(&quot;/home&quot;, timeMiddleWare(limitMiddleWare(http.HandlerFunc(getGirl)))) //跟上面一行存在重复代码</span></span><br><span class="line"></span><br><span class="line">router := NewRouter()</span><br><span class="line">router.Use(limitMiddleWare)</span><br><span class="line">router.Use(timeMiddleWare)</span><br><span class="line"><span class="comment">//以下演示了2个路径（还可以更多），每个路径都使用相同的middlewareChain</span></span><br><span class="line">router.Add(<span class="string">&quot;/&quot;</span>, http.HandlerFunc(getBoy))</span><br><span class="line">router.Add(<span class="string">&quot;/home&quot;</span>, http.HandlerFunc(getGirl))</span><br><span class="line"><span class="keyword">for</span> path, handler := <span class="keyword">range</span> router.mux &#123;</span><br><span class="line">http.Handle(path, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:5656&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="GIN">GIN</h2><p>  Gin是一款高性能的、简单轻巧的http Web框架。安装方式go get -u <a href="http://github.com/gin-gonic/gin%E3%80%82">github.com/gin-gonic/gin。</a></p><h3 id="路由">路由</h3><p>  Gin的路由是基于httprouter做的，支持GET、POST、PUT、PATCH、DELETE、OPTIONS、HEAD。支持路由分组，不用重复写上级路径。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">boy</span><span class="params">(c *gin.Context)</span></span> &#123; <span class="comment">//你所需要的东西全都封装在了gin.Context里面，包括http.Request和ResponseWriter</span></span><br><span class="line">c.String(http.StatusOK, <span class="string">&quot;hi boy&quot;</span>) <span class="comment">//通过gin.Context.String返回一个text/plain类型的正文</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">girl</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.String(http.StatusOK, <span class="string">&quot;hi girl&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//发布模式，默认是Debug模式</span></span><br><span class="line"><span class="comment">// gin.SetMode(gin.ReleaseMode)</span></span><br><span class="line"><span class="comment">//默认的engine已自带了Logger和Recovery两个中间件</span></span><br><span class="line">engine := gin.Default()</span><br><span class="line">engine.GET(<span class="string">&quot;/&quot;</span>, boy)</span><br><span class="line">engine.POST(<span class="string">&quot;/&quot;</span>, girl)</span><br><span class="line"></span><br><span class="line"><span class="comment">//路由分组</span></span><br><span class="line">oldVersion := engine.Group(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">oldVersion.GET(<span class="string">&quot;/student&quot;</span>, boy) <span class="comment">//http://localhost:5656/v1/student</span></span><br><span class="line">oldVersion.GET(<span class="string">&quot;/teacher&quot;</span>, boy) <span class="comment">//http://localhost:5656/v1/teacher</span></span><br><span class="line"></span><br><span class="line">newVersion := engine.Group(<span class="string">&quot;/v2&quot;</span>)</span><br><span class="line">newVersion.GET(<span class="string">&quot;/student&quot;</span>, girl) <span class="comment">//http://localhost:5656/v2/student</span></span><br><span class="line">newVersion.GET(<span class="string">&quot;/teacher&quot;</span>, girl) <span class="comment">//http://localhost:5656/v2/teacher</span></span><br><span class="line"></span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="参数获取">参数获取</h3><ul><li>c.Query() 从GET请求的URL中获取参数。</li><li>c.Param()从Restful风格的url中获取参数。</li><li>c.PostForm() 从post表单中获取参数。</li><li>c.FormFile() 获取上传的文件，消息类型为form-data。</li><li>c. MultipartForm() multipart/form-data可以上传多个form-data 并且用分隔符进行分割。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// 从GET请求的URL中获取参数</span></span><br><span class="line">name := ctx.Query(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="comment">//如果没传addr参数，则默认为China</span></span><br><span class="line">addr := ctx.DefaultQuery(<span class="string">&quot;addr&quot;</span>, <span class="string">&quot;China&quot;</span>)</span><br><span class="line">ctx.String(http.StatusOK, name+<span class="string">&quot; live in &quot;</span>+addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从Restful风格的url中获取参数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">restfulunc</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">name := ctx.Param(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">addr := ctx.Param(<span class="string">&quot;addr&quot;</span>)</span><br><span class="line">ctx.String(http.StatusOK, name+<span class="string">&quot; live in &quot;</span>+addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">student</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// 从post表单中获取参数</span></span><br><span class="line">name := ctx.PostForm(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="comment">//如果没传addr参数，则默认为China</span></span><br><span class="line">addr := ctx.DefaultPostForm(<span class="string">&quot;addr&quot;</span>, <span class="string">&quot;China&quot;</span>)</span><br><span class="line">ctx.String(http.StatusOK, name+<span class="string">&quot; live in &quot;</span>+addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传单个文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload_file</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">file, err := ctx.FormFile(<span class="string">&quot;file&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;get file error %v\n&quot;</span>, err)</span><br><span class="line">ctx.String(http.StatusInternalServerError, <span class="string">&quot;upload file failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//把用户上传的文件存到data目录下</span></span><br><span class="line">ctx.SaveUploadedFile(file, <span class="string">&quot;./data/&quot;</span>+file.Filename)</span><br><span class="line">ctx.String(http.StatusOK, file.Filename)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传多个文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload_multi_file</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">form, err := ctx.MultipartForm() <span class="comment">//MultipartForm中不止包含多个文件</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.String(http.StatusBadRequest, err.Error())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//从MultipartForm中获取上传的文件</span></span><br><span class="line">files := form.File[<span class="string">&quot;files&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">ctx.SaveUploadedFile(file, <span class="string">&quot;./data/&quot;</span>+file.Filename) <span class="comment">//把用户上传的文件存到data目录下</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ctx.String(http.StatusOK, <span class="string">&quot;upload &quot;</span>+strconv.Itoa(<span class="built_in">len</span>(files))+<span class="string">&quot; files&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span> <span class="string">`form:&quot;username&quot; json:&quot;name&quot; uri:&quot;user&quot; xml:&quot;user&quot; yaml:&quot;user&quot; binding:&quot;required&quot;`</span></span><br><span class="line">Addr <span class="type">string</span> <span class="string">`form:&quot;addr&quot; json:&quot;addr&quot; uri:&quot;addr&quot; xml:&quot;addr&quot; yaml:&quot;addr&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="comment">//跟ShouldBind对应的是MustBind。MustBind内部会调用ShouldBind，如果ShouldBind发生error会直接c.AbortWithError(http.StatusBadRequest, err)</span></span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBind(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, stu.Name+<span class="string">&quot; live in &quot;</span>+stu.Addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">jsonBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBindJSON(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, stu.Name+<span class="string">&quot; live in &quot;</span>+stu.Addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uriBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">fmt.Println(ctx.Request.URL)</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBindUri(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, stu.Name+<span class="string">&quot; live in &quot;</span>+stu.Addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">xmlBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBindXML(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, stu.Name+<span class="string">&quot; live in &quot;</span>+stu.Addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">yamlBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBindYAML(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, stu.Name+<span class="string">&quot; live in &quot;</span>+stu.Addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line"></span><br><span class="line">engine.GET(<span class="string">&quot;/student&quot;</span>, get)                    <span class="comment">//http://localhost:5656/student?name=zcy&amp;addr=bj</span></span><br><span class="line">engine.GET(<span class="string">&quot;/student/:name/*addr&quot;</span>, restfulunc) <span class="comment">//http://localhost:5656/student/zcy/bj/haidian</span></span><br><span class="line">engine.POST(<span class="string">&quot;/student&quot;</span>, student)               <span class="comment">//用postman模拟一个post请求，注意body类型选择x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">//限制表单上传大小为8M，默认上限是32M</span></span><br><span class="line">engine.MaxMultipartMemory = <span class="number">8</span> &lt;&lt; <span class="number">20</span></span><br><span class="line">engine.POST(<span class="string">&quot;/upload_file&quot;</span>, upload_file) <span class="comment">//用postman模拟一个post请求，注意body类型选择form-data，key在类型选择file</span></span><br><span class="line"></span><br><span class="line">engine.POST(<span class="string">&quot;/upload_files&quot;</span>, upload_multi_file) <span class="comment">//用postman模拟一个post请求，注意body类型选择form-data，key在类型选择file。多个key可以都叫files，value对应不同的文件</span></span><br><span class="line"></span><br><span class="line">engine.POST(<span class="string">&quot;/stu/form&quot;</span>, formBind)           <span class="comment">//用postman提交 localhost:5656/stu/form?username=zcy&amp;addr=bj</span></span><br><span class="line">engine.POST(<span class="string">&quot;/stu/json&quot;</span>, jsonBind)           <span class="comment">//用postman提交  body--&gt;raw,json</span></span><br><span class="line">engine.POST(<span class="string">&quot;/stu/uri/:user/:addr&quot;</span>, uriBind) <span class="comment">//http://localhost:5656/stu/uri/zcy/bj</span></span><br><span class="line">engine.POST(<span class="string">&quot;/stu/xml&quot;</span>, xmlBind)             <span class="comment">//用postman提交  body--&gt;raw,xml</span></span><br><span class="line">engine.POST(<span class="string">&quot;/stu/yaml&quot;</span>, yamlBind)           <span class="comment">//用postman提交  body--&gt;raw,text</span></span><br><span class="line"></span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="利用postman提交http请求">利用postman提交http请求</h3><p>提交普通post请求<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./post.png" alt="avatar"></p><p>上传文件<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./file.png" alt="avatar"></p><p>提交json<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./json.png" alt="avatar"></p><p>提交xml<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./xml.png" alt="avatar"></p><p>提交yaml<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./yaml.png" alt="avatar"></p><h3 id="生成response">生成response</h3><ul><li>c.String() response Content-Type=text/plain。</li><li>c.JSON() response Content-Type= application/json。</li><li>c.XML() response Content-Type= application/xml。</li><li>c.HTML() 前端写好模板，后端往里面填值。</li><li>c.Redirect() 重定向。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">text</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.GET(<span class="string">&quot;/user/text&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.String(http.StatusOK, <span class="string">&quot;hi boy&quot;</span>) <span class="comment">//response Content-Type:text/plain</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">json1</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.GET(<span class="string">&quot;/user/json1&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;zcy&quot;</span>, <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;bj&quot;</span>&#125;) <span class="comment">//response Content-Type:application/json</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">json2</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu <span class="keyword">struct</span> &#123; <span class="comment">//匿名结构体</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">stu.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">stu.Addr = <span class="string">&quot;bj&quot;</span></span><br><span class="line">engine.GET(<span class="string">&quot;/user/json2&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.JSON(http.StatusOK, stu) <span class="comment">//response Content-Type:application/json</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">jsonp</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stu <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">stu.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">stu.Addr = <span class="string">&quot;bj&quot;</span></span><br><span class="line">engine.GET(<span class="string">&quot;/user/jsonp&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">//如果请求参数里有callback=xxx，则response Content-Type为application/javascript，否则response Content-Type为application/json</span></span><br><span class="line">ctx.JSONP(http.StatusOK, stu)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">xml</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu = student&#123;Name: <span class="string">&quot;zcy&quot;</span>, Addr: <span class="string">&quot;bj&quot;</span>&#125;</span><br><span class="line">engine.GET(<span class="string">&quot;/user/xml&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.XML(http.StatusOK, stu)</span><br><span class="line"><span class="comment">// c.XML(http.StatusOK, gin.H&#123;&quot;name&quot;: &quot;zcy&quot;, &quot;addr&quot;: &quot;bj&quot;&#125;) //response Content-Type:application/xml</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">yaml</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">stu.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">stu.Addr = <span class="string">&quot;bj&quot;</span></span><br><span class="line">engine.GET(<span class="string">&quot;/user/yaml&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.YAML(http.StatusOK, stu)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">html</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.LoadHTMLFiles(<span class="string">&quot;http/static/template.html&quot;</span>)</span><br><span class="line">engine.GET(<span class="string">&quot;/user/html&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">//通过json往前端页面上传值</span></span><br><span class="line">c.HTML(http.StatusOK, <span class="string">&quot;template.html&quot;</span>, gin.H&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;用户信息&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;zcy&quot;</span>, <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;bj&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">redirect</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.GET(<span class="string">&quot;/not_exists&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.Redirect(http.StatusMovedPermanently, <span class="string">&quot;http://localhost:5656/user/html&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line">text(engine)     <span class="comment">//http://localhost:5656/user/text</span></span><br><span class="line">json1(engine)    <span class="comment">//http://localhost:5656/user/json1</span></span><br><span class="line">json2(engine)    <span class="comment">//http://localhost:5656/user/json2</span></span><br><span class="line">jsonp(engine)    <span class="comment">//http://localhost:5656/user/jsonp?callback=yyds</span></span><br><span class="line">xml(engine)      <span class="comment">//http://localhost:5656/user/xml</span></span><br><span class="line">yaml(engine)     <span class="comment">//http://localhost:5656/user/yaml</span></span><br><span class="line">html(engine)     <span class="comment">//http://localhost:5656/user/html</span></span><br><span class="line">redirect(engine) <span class="comment">//http://localhost:5656/not_exists</span></span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="参数检验">参数检验</h3><p>  GIN的参数检验是基于go-playground/validator实现的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin/binding&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/go-playground/validator/v10&quot;</span> <span class="comment">//注意要用新版本v10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name       <span class="type">string</span>    <span class="string">`form:&quot;name&quot; binding:&quot;required&quot;`</span>                                                                <span class="comment">//required:必须上传name参数</span></span><br><span class="line">Score      <span class="type">int</span>       <span class="string">`form:&quot;score&quot; binding:&quot;gt=0&quot;`</span>                                                                   <span class="comment">//score必须为正数</span></span><br><span class="line">Enrollment time.Time <span class="string">`form:&quot;enrollment&quot; binding:&quot;required,before_today&quot; time_format:&quot;2006-01-02&quot; time_utc:&quot;8&quot;`</span>       <span class="comment">//自定义验证before_today，日期格式东8区</span></span><br><span class="line">Graduation time.Time <span class="string">`form:&quot;graduation&quot; binding:&quot;required,gtfield=Enrollment&quot; time_format:&quot;2006-01-02&quot; time_utc:&quot;8&quot;`</span> <span class="comment">//毕业时间要晚于入学时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义验证器</span></span><br><span class="line"><span class="keyword">var</span> beforeToday validator.Func = <span class="function"><span class="keyword">func</span><span class="params">(fl validator.FieldLevel)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">if</span> date, ok := fl.Field().Interface().(time.Time); ok &#123;</span><br><span class="line">today := time.Now()</span><br><span class="line"><span class="keyword">if</span> date.Before(today) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processErr</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给Validate.Struct()函数传了一个非法的参数</span></span><br><span class="line">invalid, ok := err.(*validator.InvalidValidationError)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;param error:&quot;</span>, invalid)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ValidationErrors是一个错误切片，它保存了每个字段违反的每个约束信息</span></span><br><span class="line">validationErrs := err.(validator.ValidationErrors)</span><br><span class="line"><span class="keyword">for</span> _, validationErr := <span class="keyword">range</span> validationErrs &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;field %s 不满足条件 %s\n&quot;</span>, validationErr.Field(), validationErr.Tag())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册验证器</span></span><br><span class="line"><span class="keyword">if</span> v, ok := binding.Validator.Engine().(*validator.Validate); ok &#123;</span><br><span class="line">v.RegisterValidation(<span class="string">&quot;before_today&quot;</span>, beforeToday)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">engine.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBind(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">processErr(err) <span class="comment">//校验不符合时，打印出哪时不符合</span></span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse parameter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.JSON(http.StatusOK, stu)</span><br><span class="line">&#125;</span><br><span class="line">&#125;) <span class="comment">//http://localhost:5656?name=zcy&amp;score=1&amp;enrollment=2021-08-23&amp;graduation=2021-09-23</span></span><br><span class="line"></span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>{“Name”:“zcy”,“Score”:1,“Enrollment”:“2021-08-23T00:00:00+08:00”,“Graduation”:“2021-09-23T00:00:00+08:00”}</p><h3 id="中间件">中间件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> limitCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">100</span>) <span class="comment">//最多并发处理100个请求</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeMiddleWare</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">begin := time.Now()</span><br><span class="line">ctx.Next() <span class="comment">//执行业务逻辑</span></span><br><span class="line">timeElapsed := time.Since(begin)</span><br><span class="line">log.Printf(<span class="string">&quot;request %s use %d ms\n&quot;</span>, ctx.Request.URL.Path, timeElapsed.Milliseconds())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">limitMiddleWare</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">limitCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//并发度达到100时就会阻塞</span></span><br><span class="line">log.Printf(<span class="string">&quot;concurrence %d\n&quot;</span>, <span class="built_in">len</span>(limitCh))</span><br><span class="line">ctx.Next() <span class="comment">//执行业务逻辑</span></span><br><span class="line">&lt;-limitCh</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line">engine.Use(timeMiddleWare()) <span class="comment">//全局MiddleWare</span></span><br><span class="line">engine.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">ctx.String(http.StatusOK, <span class="string">&quot;hi boy&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">engine.GET(<span class="string">&quot;/girl&quot;</span>, limitMiddleWare(), <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123; <span class="comment">//局部MiddleWare</span></span><br><span class="line">ctx.String(http.StatusOK, <span class="string">&quot;hi girl&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  <a href="https://github.com/gin-gonic/contrib/blob/master/README.md">gin-gonic/contrib</a>上提供了丰富的第三方中间件。</p><h3 id="会话">会话</h3><p>  http是无状态的，即服务端不知道两次请求是否来自于同一个客户端。Cookie由服务端生成，发送给客户端，客户端保存在本地。客户端每次发起请求时把Cookie带上，以证明自己的身份。HTTP请求中的Cookie头只会包含name和value信息（服务端只能取到name和value），domain、path、expires等cookie属性是由浏览器使用的，对服务器来说没有意义。Cookie可以被浏览器禁用。<br>server_session.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">authMap sync.Map</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//cookie name需要符合规则，否则该cookie会被Gin框架默默地丢弃掉</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genCookieName</span><span class="params">(ctx *gin.Context)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> base64.StdEncoding.EncodeToString([]<span class="type">byte</span>(ctx.Request.RemoteAddr))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">login</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.POST(<span class="string">&quot;/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">//为客户端生成cookie</span></span><br><span class="line">cookie_key := genCookieName(ctx)</span><br><span class="line">cookie_value := strconv.Itoa(time.Now().Nanosecond())</span><br><span class="line"><span class="comment">//服务端维护所有客户端的cookie，用于对客户端进行认证</span></span><br><span class="line">authMap.Store(cookie_key, cookie_value)</span><br><span class="line"><span class="comment">//把cookie发给客户端</span></span><br><span class="line">ctx.SetCookie(cookie_key, cookie_value,</span><br><span class="line"><span class="number">3000</span>,        <span class="comment">//maxAge，cookie的有效时间，时间单位秒</span></span><br><span class="line"><span class="string">&quot;/&quot;</span>,         <span class="comment">//path，cookie存放目录</span></span><br><span class="line"><span class="string">&quot;localhost&quot;</span>, <span class="comment">//cookie从属的域名</span></span><br><span class="line"><span class="literal">false</span>,       <span class="comment">//是否只能通过https访问</span></span><br><span class="line"><span class="literal">true</span>,        <span class="comment">//是否允许别人通过js获取自己的cookie</span></span><br><span class="line">)</span><br><span class="line">fmt.Printf(<span class="string">&quot;set cookie %s = %s to client\n&quot;</span>, cookie_key, cookie_value)</span><br><span class="line">ctx.String(http.StatusOK, <span class="string">&quot;登录成功&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户中心</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">userCenter</span><span class="params">(engine *gin.Engine)</span></span> &#123;</span><br><span class="line">engine.POST(<span class="string">&quot;/center&quot;</span>, authMiddleWare(), <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123; <span class="comment">//为&quot;/center&quot;加个认证中间件</span></span><br><span class="line">ctx.String(http.StatusOK, <span class="string">&quot;您已通过身份认证，这里是你的私人空间&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">authMiddleWare</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">cookie_key := genCookieName(ctx)</span><br><span class="line"><span class="keyword">var</span> cookie_value <span class="type">string</span></span><br><span class="line"><span class="comment">//读取客户端的cookie</span></span><br><span class="line"><span class="keyword">for</span> _, cookie := <span class="keyword">range</span> ctx.Request.Cookies() &#123;</span><br><span class="line"><span class="keyword">if</span> cookie.Name == cookie_key &#123;</span><br><span class="line">cookie_value = cookie.Value</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//验证Cookie Value是否正确</span></span><br><span class="line"><span class="keyword">if</span> v, ok := authMap.Load(cookie_key); !ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;INVALID auth cookie %s = %s\n&quot;</span>, cookie_key, cookie_value)</span><br><span class="line">ctx.JSON(http.StatusForbidden, gin.H&#123;cookie_key: cookie_value&#125;)</span><br><span class="line">ctx.Abort() <span class="comment">//验证不通过，调用Abort</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> v.(<span class="type">string</span>) == cookie_value &#123;</span><br><span class="line">ctx.Next() <span class="comment">//本中间件顺利通过</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;INVALID auth cookie %s = %s\n&quot;</span>, cookie_key, cookie_value)</span><br><span class="line">ctx.JSON(http.StatusForbidden, gin.H&#123;cookie_key: cookie_value&#125;)</span><br><span class="line">ctx.Abort() <span class="comment">//验证不通过，调用Abort</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">//路由</span></span><br><span class="line">login(engine)</span><br><span class="line">userCenter(engine)</span><br><span class="line"></span><br><span class="line">gin.SetMode(gin.ReleaseMode) <span class="comment">//发布模式，屏蔽debug信息</span></span><br><span class="line">engine.Run(<span class="string">&quot;127.0.0.1:5656&quot;</span>) <span class="comment">//测试方法，运行http/client/main.go里的authLogin()方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client_session.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://127.0.0.1:5656/login&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">loginCookies := resp.Cookies() <span class="comment">//读取服务端返回的Cookie</span></span><br><span class="line">resp.Body.Close()</span><br><span class="line"><span class="keyword">if</span> req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://127.0.0.1:5656/center&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//下次请求再带上cookie</span></span><br><span class="line"><span class="keyword">for</span> _, cookie := <span class="keyword">range</span> loginCookies &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;receive cookie %s = %s\n&quot;</span>, cookie.Name, cookie.Value)</span><br><span class="line"><span class="comment">// cookie.Value += &quot;1&quot; //修改cookie后认证不通过</span></span><br><span class="line">req.AddCookie(cookie)</span><br><span class="line">&#125;</span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> resp, err := client.Do(req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Beego">Beego</h2><p>  beego是一个大而全的http框架，用于快速开发go应用程序。bee工具提供诸多命令，帮助我们进行 beego 项目的创建、热编译、开发、测试、和部署。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/astaxie/beego</span><br><span class="line">go get github.com/beego/bee</span><br><span class="line">cd $GOPATH/src</span><br><span class="line">bee new myweb</span><br><span class="line">cd myweb</span><br><span class="line">go build -mod=mod</span><br><span class="line">bee run</span><br></pre></td></tr></table></figure><p>  beego的八大模块互相独立，高度解耦，开发者可任意选取：</p><ol><li>日志模块</li><li>ORM模块</li><li>Context模块。封装了request和response</li><li>Cache模块。封装了memcache、redis、ssdb</li><li>Config模块。解析.ini、.yaml、.xml、.json、.env等配置文件</li><li>httplib模块</li><li>Session模块。session保存在服务端，用于标识客户身份，跟踪会话</li><li>toolbox模块。健康检查、性能调试、访问统计、计划任务</li></ol><p>MVC开发模式</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./mvc.png width=500 /><p>  在Model层可以使用beego提供的ORM功能。</p><h2 id="client">client</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">simpleGet</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5656&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 响应体</span></span><br><span class="line">b, err2 := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;response body: %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">simplePost</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//把string转成io.Reader</span></span><br><span class="line">reader := strings.NewReader(<span class="string">&quot;Hello Server&quot;</span>)</span><br><span class="line"><span class="comment">//Content-Type为text/plain，表示一个朴素的字符串</span></span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://127.0.0.1:5656/student&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, reader); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(<span class="string">&quot;response body: &quot;</span>)</span><br><span class="line"><span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">io.Copy(os.Stdout, resp.Body)</span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">restful</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//Content-Type为text/plain，表示一个朴素的字符串</span></span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://127.0.0.1:5656/user/xiaoming/vip/bj/haidian&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">postForm</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//通过form表单提交一些参数键值对</span></span><br><span class="line"><span class="keyword">if</span> resp, err := http.PostForm(<span class="string">&quot;http://127.0.0.1:5656/stu/form&quot;</span>, url.Values&#123;<span class="string">&quot;name&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;zcy&quot;</span>&#125;, <span class="string">&quot;age&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;18&quot;</span>&#125;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">head</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//HEAD类似于GET，但HEAD方法只能取到http response报文头部，取不到resp.Body</span></span><br><span class="line"><span class="keyword">if</span> resp, err := http.Head(<span class="string">&quot;http://127.0.0.1:5656&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close() <span class="comment">//注意：一定要调用resp.Body.Close()，否则会协程泄漏（同时引发内存泄漏）</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//resp.Body为空</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (*http.Client).Do允许我们构造复杂的http request</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">complexRequest</span><span class="params">()</span></span> &#123;</span><br><span class="line">reader := strings.NewReader(<span class="string">&quot;Hello Server&quot;</span>)</span><br><span class="line"><span class="comment">//HEAD、GET、POST 默认都属于简单请求 Simple Request，通过http.NewRequest可以支持全部的request method</span></span><br><span class="line"><span class="keyword">if</span> req, err := http.NewRequest(<span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;http://127.0.0.1:5656&quot;</span>, reader); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//自定义请求头</span></span><br><span class="line">req.Header.Add(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;花果山&quot;</span>)</span><br><span class="line">req.Header.Add(<span class="string">&quot;King&quot;</span>, <span class="string">&quot;孙悟空&quot;</span>)</span><br><span class="line"><span class="comment">//自定义Cookie</span></span><br><span class="line"><span class="comment">//HTTP请求中的Cookie头只会包含name和value信息（服务端只能取到name和value），domain、path、expires等cookie属性是由浏览器使用的，对服务器来说没有意义</span></span><br><span class="line">req.AddCookie(&amp;http.Cookie&#123;</span><br><span class="line">Name:   <span class="string">&quot;auth&quot;</span>,</span><br><span class="line">Value:  <span class="string">&quot;pass&quot;</span>,</span><br><span class="line">Path:   <span class="string">&quot;/&quot;</span>,</span><br><span class="line">Domain: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//设置请求超时</span></span><br><span class="line">client := &amp;http.Client&#123;</span><br><span class="line">Timeout: <span class="number">500</span> * time.Millisecond,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> resp, err := client.Do(req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">具体看一下http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;response proto: %s\n&quot;</span>, resp.Proto)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestBook</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://book.dianshang:5656&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123; <span class="comment">//Content-Type为text/plain，表示一个朴素的字符串</span></span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestFood</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://food.dianshang:5656&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123; <span class="comment">//Content-Type为text/plain，表示一个朴素的字符串</span></span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestPanic</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5656/panic&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Printf(<span class="string">&quot;response status: %s\n&quot;</span>, resp.Status)</span><br><span class="line">fmt.Println(<span class="string">&quot;response header&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: %v\n&quot;</span>, key, values)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">authLogin</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> resp, err := http.Post(<span class="string">&quot;http://127.0.0.1:5656/login&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">loginCookies := resp.Cookies() <span class="comment">//读取服务端返回的Cookie</span></span><br><span class="line">resp.Body.Close()</span><br><span class="line"><span class="keyword">if</span> req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://127.0.0.1:5656/center&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//下次请求再带上cookie</span></span><br><span class="line"><span class="keyword">for</span> _, cookie := <span class="keyword">range</span> loginCookies &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;receive cookie %s = %s\n&quot;</span>, cookie.Name, cookie.Value)</span><br><span class="line">cookie.Value += <span class="string">&quot;1&quot;</span> <span class="comment">//修改cookie后认证不通过</span></span><br><span class="line">req.AddCookie(cookie)</span><br><span class="line">&#125;</span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> resp, err := client.Do(req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Println(<span class="string">&quot;response body&quot;</span>)</span><br><span class="line">io.Copy(os.Stdout, resp.Body) <span class="comment">//两个io数据流的拷贝</span></span><br><span class="line">os.Stdout.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// simpleGet()</span></span><br><span class="line"><span class="comment">// simplePost()</span></span><br><span class="line"><span class="comment">// restful()</span></span><br><span class="line">postForm()</span><br><span class="line"><span class="comment">// head()</span></span><br><span class="line"><span class="comment">// complexRequest()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// requestPanic()</span></span><br><span class="line"><span class="comment">// requestBook()</span></span><br><span class="line"><span class="comment">// requestFood()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//测试限流中间件</span></span><br><span class="line"><span class="comment">// const P = 130</span></span><br><span class="line"><span class="comment">// wg := sync.WaitGroup&#123;&#125;</span></span><br><span class="line"><span class="comment">// wg.Add(P)</span></span><br><span class="line"><span class="comment">// for i := 0; i &lt; P; i++ &#123;</span></span><br><span class="line"><span class="comment">// go func() &#123;</span></span><br><span class="line"><span class="comment">// defer wg.Done()</span></span><br><span class="line"><span class="comment">// if resp, err := http.Get(&quot;http://127.0.0.1:5656&quot;); err == nil &#123;</span></span><br><span class="line"><span class="comment">// resp.Body.Close()</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;()</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// wg.Wait()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// authLogin()</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="模板">模板</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span> <span class="string">`form:&quot;username&quot; json:&quot;name&quot; uri:&quot;user&quot; xml:&quot;user&quot; yaml:&quot;user&quot; binding:&quot;required&quot;`</span></span><br><span class="line">Addr <span class="type">string</span> <span class="string">`form:&quot;addr&quot; json:&quot;addr&quot; uri:&quot;addr&quot; xml:&quot;addr&quot; yaml:&quot;addr&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBind(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 从GET请求的URL中获取参数</span></span><br><span class="line">name := ctx.Query(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="comment">//如果没传addr参数，则默认为China</span></span><br><span class="line">addr := ctx.DefaultQuery(<span class="string">&quot;addr&quot;</span>, <span class="string">&quot;China&quot;</span>)</span><br><span class="line">ctx.String(http.StatusOK, name+<span class="string">&quot; live in &quot;</span>+addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">jsonBind</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">if</span> err := ctx.ShouldBindJSON(&amp;stu); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err)</span><br><span class="line">ctx.String(http.StatusBadRequest, <span class="string">&quot;parse paramter failed&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx.JSON(http.StatusOK, stu)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.Default()</span><br><span class="line"></span><br><span class="line">engine.GET(<span class="string">&quot;/student&quot;</span>, get)</span><br><span class="line">engine.POST(<span class="string">&quot;/stu/json&quot;</span>, jsonBind)</span><br><span class="line"></span><br><span class="line">engine.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> album <span class="keyword">struct</span> &#123;</span><br><span class="line">Id     <span class="type">int</span>     <span class="string">`json:id binding:&quot;required&quot;`</span></span><br><span class="line">Title  <span class="type">string</span>  <span class="string">`json:&quot;title&quot; binding:&quot;required&quot;`</span></span><br><span class="line">Artist <span class="type">string</span>  <span class="string">`json:&quot;artist&quot; binding:&quot;required&quot;`</span></span><br><span class="line">Price  <span class="type">float64</span> <span class="string">`json:&quot;price&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> albums = []album&#123;</span><br><span class="line">&#123;Id: <span class="number">1</span>, Title: <span class="string">&quot;Blue Train&quot;</span>, Artist: <span class="string">&quot;John Coltrane&quot;</span>, Price: <span class="number">56.99</span>&#125;,</span><br><span class="line">&#123;Id: <span class="number">2</span>, Title: <span class="string">&quot;Jeru&quot;</span>, Artist: <span class="string">&quot;Gerry Mulligan&quot;</span>, Price: <span class="number">17.99</span>&#125;,</span><br><span class="line">&#123;Id: <span class="number">3</span>, Title: <span class="string">&quot;Sarah Vaughan and Clifford Brown&quot;</span>, Artist: <span class="string">&quot;Sarah Vaughan&quot;</span>, Price: <span class="number">39.99</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getAlbums</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.IndentedJSON(http.StatusOK, albums)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">postAlbums</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> newAlbum album</span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBindJSON(&amp;newAlbum); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(err.Error())</span><br><span class="line">c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">albums = <span class="built_in">append</span>(albums, newAlbum)</span><br><span class="line">c.IndentedJSON(http.StatusCreated, newAlbum)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := gin.Default()</span><br><span class="line">router.GET(<span class="string">&quot;/albums&quot;</span>, getAlbums)</span><br><span class="line">router.POST(<span class="string">&quot;/albums&quot;</span>, postAlbums)</span><br><span class="line">router.Run(<span class="string">&quot;:5656&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang并发编程</title>
      <link href="/20230105/golang-20230105-golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
      <url>/20230105/golang-20230105-golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="并发模型">并发模型</h2><p>  任何语言的并行，到操作系统层面，都是内核线程的并行。同一个进程内的多个线程共享系统资源，进程的创建、销毁、切换比线程大很多。从进程到线程再到协程, 其实是一个不断共享, 不断减少切换成本的过程。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./1v1.png" width="410" /><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./1v1t.png" width="310" /><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./mvn.png" width="230" /></p><table><thead><tr><th style="text-align:center"></th><th style="text-align:left">协程</th><th style="text-align:left">线程</th></tr></thead><tbody><tr><td style="text-align:center">创建数量</td><td style="text-align:left">轻松创建上百万个协程而不会导致系统资源衰竭</td><td style="text-align:left">通常最多不能超过1万个</td></tr><tr><td style="text-align:center">内存占用</td><td style="text-align:left">初始分配4k堆栈，随着程序的执行自动增长删除</td><td style="text-align:left">创建线程时必须指定堆栈且是固定的，通常以M为单位</td></tr><tr><td style="text-align:center">切换成本</td><td style="text-align:left">协程切换只需保存三个寄存器，耗时约200纳秒</td><td style="text-align:left">线程切换需要保存几十个寄存器，耗时约1000纳秒</td></tr><tr><td style="text-align:center">调度方式</td><td style="text-align:left">非抢占式，由Go runtime主动交出控制权（对于开发者而言是抢占式）</td><td style="text-align:left">在时间片用完后，由 CPU 中断任务强行将其调度走，这时必须保存很多信息</td></tr><tr><td style="text-align:center">创建销毁</td><td style="text-align:left">goroutine因为是由Go runtime负责管理的，创建和销毁的消耗非常小，是用户级的</td><td style="text-align:left">创建和销毁开销巨大，因为要和操作系统打交道，是内核级的，通常解决的办法就是线程池</td></tr></tbody></table><p>查看逻辑核心数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(runtime.NumCPU())</span><br></pre></td></tr></table></figure><p>Go语言的MPG并发模型<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./mpg.png" width="150" /><br>  M(Machine)对应一个内核线程。P(Processor)虚拟处理器，代表M所需的上下文环境，是处理用户级代码逻辑的处理器。P的数量由环境变量中的GOMAXPROCS决定，默认情况下就是核数。G(Goroutine)本质上是轻量级的线程，G0正在执行，其他G在等待。M和内核线程的对应关系是确定的。G0阻塞(如系统调用)时，P与G0、M0解绑，P被挂到其他M上，然后继续执行G队列。G0解除阻塞后，如果有空闲的P，就绑定M0并执行G0；否则G0进入全局可运行队列(runqueue)。P会周期性扫描全局runqueue，使上面的G得到执行；如果全局runqueue为空，就从其他P的等待队列里偷一半G过来。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./mpg_detail.png" width="800" /></p><h2 id="Goroutine的使用">Goroutine的使用</h2><p>  启动协程的两种常见方式：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Add&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> Add(<span class="number">2</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;add&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;(<span class="number">2</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>  优雅地等子协程结束:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(<span class="number">10</span>) <span class="comment">//加10</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> &#123; <span class="comment">//开N个子协程</span></span><br><span class="line"><span class="keyword">defer</span> wg.Done() <span class="comment">//减1</span></span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line">&#125;(i, i+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait() <span class="comment">//等待减为0</span></span><br></pre></td></tr></table></figure><p>  父协程结束后，子协程并不会结束。main协程结束后，所有协程都会结束。<br>向协程内传递变量</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> arr &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d\t&quot;</span>, v) <span class="comment">//用的是协程外面的全局变量v。输出4 4 4 4</span></span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Duration(<span class="number">1</span>) * time.Second)</span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> arr &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(value <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d\t&quot;</span>, value) <span class="comment">//输出1 4 2 3</span></span><br><span class="line">&#125;(v) <span class="comment">//把v的副本传到协程内部</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Duration(<span class="number">1</span>) * time.Second)</span><br><span class="line">fmt.Println()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  有时候需要确保在高并发的场景下有些事情只执行一次，比如加载配置文件、关闭管道等。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> loadResourceOnce sync.Once <span class="function"><span class="keyword">func</span> <span class="title">LoadResource</span><span class="params">()</span></span> &#123;</span><br><span class="line">loadResourceOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">resource[<span class="string">&quot;1&quot;</span>] = <span class="string">&quot;A&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>单例模式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Singleton <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> singleton *Singleton</span><br><span class="line"><span class="keyword">var</span> singletonOnce sync.Once</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetSingletonInstance</span><span class="params">()</span></span> *Singleton &#123;</span><br><span class="line">singletonOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">singleton = &amp;Singleton&#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> singleton</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  何时会发生panic:</p><ul><li>运行时错误会导致panic，比如数组越界、除0。</li><li>程序主动调用panic(error)。</li></ul><p>  panic会执行什么：</p><ol><li>逆序执行当前goroutine的defer链（recover从这里介入）。</li><li>打印错误信息和调用堆栈。</li><li>调用exit(2)结束整个进程。</li></ol><p>关于defer</p><ul><li>defer在函数退出前被调用，注意不是在代码的return语句之前执行，因为return语句不是原子操作。</li><li>如果发生panic，则之后注册的defer不会执行。</li><li>defer服从先进后出原则，即一个函数里如果注册了多个defer，则按注册的逆序执行。</li><li>defer后面可以跟一个匿名函数。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goo</span><span class="params">(x <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;x=%d\n&quot;</span>, x)</span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(a, b <span class="type">int</span>, p <span class="type">bool</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">c := a*<span class="number">3</span> + <span class="number">9</span></span><br><span class="line"><span class="comment">//defer是先进后出，即逆序执行</span></span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;first defer&quot;</span>)</span><br><span class="line">d := c + <span class="number">5</span></span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;second defer&quot;</span>)</span><br><span class="line">e := d / b <span class="comment">//如果发生panic，则后面的defer不会执行</span></span><br><span class="line"><span class="keyword">if</span> p &#123;</span><br><span class="line"><span class="built_in">panic</span>(errors.New(<span class="string">&quot;my error&quot;</span>)) <span class="comment">//主动panic</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;third defer&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> goo(e) <span class="comment">//defer是在函数临退出前执行，不是在代码的return语句之前执行，因为return语句不是原子操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  recover会阻断panic的执行。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">soo</span><span class="params">(a, b <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//recover必须在defer中才能生效</span></span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;soo函数中发生了panic:%s\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="built_in">panic</span>(errors.New(<span class="string">&quot;my error&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Channel的同步与异步">Channel的同步与异步</h2><p>  很多语言通过共享内存来实现线程间的通信，通过加锁来访问共享数据，如数组、map或结构体。go语言也实现了这种并发模型。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./share_mem.png" width="500" /></p><p>  CSP(communicating sequential processes)讲究的是“以通信的方式来共享内存”，在go语言里channel是这种模式的具体实现。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./csp.png" width="600" /></p><p>异步管道</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asynChann := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>  channel底层维护一个环形队列（先进先出），make初始化时指定队列的长度。队列满时，写阻塞；队列空时，读阻塞。sendx指向下一次写入的位置， recvx指向下一次读取的位置。 recvq维护因读管道而被阻塞的协程，sendq维护因写管道而被阻塞的协程。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./queue.png" width="400" /></p><p>  同步管道可以认为队列容量为0，当读协程和写协程同时就绪时它们才会彼此帮对方解除阻塞。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syncChann := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br></pre></td></tr></table></figure><p>  channel仅作为协程间同步的工具，不需要传递具体的数据，管道类型可以用struct{}。空结构体变量的内存占用为0，因此struct{}类型的管道比bool类型的管道还要省内存。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">sc &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure><p>关于channel的死锁与阻塞</p><ol><li>Channel满了，就阻塞写；Channel空了，就阻塞读。</li><li>阻塞之后会交出cpu，去执行其他协程，希望其他协程能帮自己解除阻塞。</li><li>如果阻塞发生在main协程里，并且没有其他子协程可以执行，那就可以确定“希望永远等不来”，自已把自己杀掉，报一个fatal error:deadlock出来。</li><li>如果阻塞发生在子协程里，就不会发生死锁，因为至少main协程是一个值得等待的“希望”，会一直等（阻塞）下去。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//有1个缓冲可以用，无需阻塞，可以立即执行</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;      <span class="comment">//子协程1</span></span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second) <span class="comment">//sleep一个很长的时间</span></span><br><span class="line">&lt;-ch                        <span class="comment">//如果把本行代码注释掉，main协程5秒钟后会报fatal error</span></span><br><span class="line">fmt.Println(<span class="string">&quot;sub routine 1 over&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//由于子协程1已经启动，寄希望于子协程1帮自己解除阻塞，所以会一直等子协程1执行结束。如果子协程1执行结束后没帮自己解除阻塞，则希望完全破灭，报出deadlock</span></span><br><span class="line">fmt.Println(<span class="string">&quot;send to channel in main routine&quot;</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//子协程2</span></span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//channel已满，子协程2会一直阻塞在这一行</span></span><br><span class="line">fmt.Println(<span class="string">&quot;sub routine 2 over&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line">time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">fmt.Println(<span class="string">&quot;main routine exit&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关闭channel</p><ul><li>只有当管道关闭时，才能通过range遍历管道里的数据，否则会发生fatal error。</li><li>管道关闭后读操作会立即返回，如果缓冲已空会返回“0值”。</li><li>ele, ok := &lt;-ch  ok==true代表ele是管道里的真实数据。</li><li>向已关闭的管道里send数据会发生panic。</li><li>不能重复关闭管道，不能关闭值为nil的管道，否则都会panic。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cloch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">var</span> cloch2 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">traverseChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> ele := <span class="keyword">range</span> cloch &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;receive %d\n&quot;</span>, ele)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">traverseChannel2</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> ele, ok := &lt;-cloch2; ok &#123; <span class="comment">//ok==true代表管道还没有close</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;receive %d\n&quot;</span>, ele)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//管道关闭后，读操作会立即返回“0值”</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;channel have been closed, receive %d\n&quot;</span>, ele)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">cloch &lt;- <span class="number">1</span></span><br><span class="line"><span class="built_in">close</span>(cloch)</span><br><span class="line">traverseChannel() <span class="comment">//如果不close就直接通过range遍历管道，会发生fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line">fmt.Println(<span class="string">&quot;==================&quot;</span>)</span><br><span class="line"><span class="keyword">go</span> traverseChannel2()</span><br><span class="line">cloch2 &lt;- <span class="number">1</span></span><br><span class="line"><span class="built_in">close</span>(cloch2)</span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  channel在并发编程中有多种玩法，经常用channel来实现协程间的同步。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./sync.png" width="500" /></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upstream</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">15</span> * time.Millisecond)</span><br><span class="line">fmt.Println(<span class="string">&quot;一个上游协程执行结束&quot;</span>)</span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downstream</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">&lt;-ch</span><br><span class="line">fmt.Println(<span class="string">&quot;下游协程开始执行&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">upstreamNum := <span class="number">4</span>   <span class="comment">//上游协程的数量</span></span><br><span class="line">downstreamNum := <span class="number">5</span> <span class="comment">//下游协程的数量</span></span><br><span class="line"></span><br><span class="line">upstreamCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, upstreamNum)</span><br><span class="line">downstreamCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, downstreamNum)</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动上游协程和下游协程，实际下游协程会先阻塞</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; upstreamNum; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> upstream(upstreamCh)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; downstreamNum; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> downstream(downstreamCh)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同步点</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; upstreamNum; i++ &#123;</span><br><span class="line">&lt;-upstreamCh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过管道让下游协程开始执行</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; downstreamNum; i++ &#123;</span><br><span class="line">downstreamCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Millisecond) <span class="comment">//等下游协程执行结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="并发安全性">并发安全性</h2><p>  多协程并发修改同一块内存，产生资源竞争。go run或go build时添加-race参数检查资源竞争情况。<br>  n++不是原子操作，并发执行时会存在脏写。n++分为3步：取出n，加1，结果赋给n。测试时需要开1000个并发协程才能观察到脏写。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./n++.png" width="500" /><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">atomic</span>.<span class="title">AddInt32</span><span class="params">(addr *<span class="type">int32</span>, delta <span class="type">int32</span>)</span></span> (<span class="built_in">new</span> <span class="type">int32</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">atomic</span>.<span class="title">LoadInt32</span><span class="params">(addr *<span class="type">int32</span>)</span></span> (val <span class="type">int32</span>)</span><br></pre></td></tr></table></figure><p>  把n++封装成原子操作，解除资源竞争，避免脏写。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lock sync.RWMutex<span class="comment">//声明读写锁，无需初始化</span></span><br><span class="line">lock.Lock() lock.Unlock()<span class="comment">//加写锁和释放写锁</span></span><br><span class="line">lock.RLock() lock.RUnlock()<span class="comment">//加读锁和释放读锁</span></span><br></pre></td></tr></table></figure><p>  任意时刻只可以加一把写锁，且不能加读锁。没加写锁时，可以同时加多把读锁，读锁加上之后不能再加写锁。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> n <span class="type">int32</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> lock sync.RWMutex</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inc1</span><span class="params">()</span></span> &#123;</span><br><span class="line">n++ <span class="comment">//n++不是原子操作，它分为3步：取出n，加1，结果赋给n</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inc2</span><span class="params">()</span></span> &#123;</span><br><span class="line">atomic.AddInt32(&amp;n, <span class="number">1</span>) <span class="comment">//封装成原子操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inc3</span><span class="params">()</span></span> &#123;</span><br><span class="line">lock.Lock()   <span class="comment">//加写锁</span></span><br><span class="line">n++           <span class="comment">//任一时刻，只有一个协程能进入临界区域</span></span><br><span class="line">lock.Unlock() <span class="comment">//释放写锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> P = <span class="number">1000</span> <span class="comment">//开大量协程才能把脏写问题测出来</span></span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(P)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; P; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">inc1()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Printf(<span class="string">&quot;finally n=%d\n&quot;</span>, n) <span class="comment">//多运行几次，n经常不等于1000</span></span><br><span class="line">fmt.Println(<span class="string">&quot;===========================&quot;</span>)</span><br><span class="line">n = <span class="number">0</span> <span class="comment">//重置n</span></span><br><span class="line">wg = sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(P)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; P; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">inc2()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Printf(<span class="string">&quot;finally n=%d\n&quot;</span>, atomic.LoadInt32(&amp;n))</span><br><span class="line">fmt.Println(<span class="string">&quot;===========================&quot;</span>)</span><br><span class="line">n = <span class="number">0</span> <span class="comment">//重置n</span></span><br><span class="line">wg = sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(P)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; P; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">inc3()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">lock.RLock() <span class="comment">//加读锁。当写锁被其他协程持有时，加读锁操作将被阻塞；否则，如果其他协程持有读锁，加读锁操作不会被阻塞</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;finally n=%d\n&quot;</span>, n)</span><br><span class="line">lock.RUnlock() <span class="comment">//释放读锁</span></span><br><span class="line">fmt.Println(<span class="string">&quot;===========================&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  数组、slice、struct允许并发修改（可能会脏写），并发修改map有时会发生panic。如果需要并发修改map请使用sync.Map。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>]<span class="type">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> m = sync.Map&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//写偶数位</span></span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i += <span class="number">2</span> &#123;</span><br><span class="line">arr[i] = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//写奇数位</span></span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(arr); i += <span class="number">2</span> &#123;</span><br><span class="line">arr[i] = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(arr) <span class="comment">//输出[0 1 0 1 0 1 0 1 0 1]</span></span><br><span class="line">fmt.Println(<span class="string">&quot;=======================&quot;</span>)</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">var</span> stu Student</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">stu.Name = <span class="string">&quot;Fred&quot;</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">stu.Age = <span class="number">20</span></span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s %d\n&quot;</span>, stu.Name, stu.Age)</span><br><span class="line">fmt.Println(<span class="string">&quot;=======================&quot;</span>)</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">m.Store(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">m.Store(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v2&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(m.Load(<span class="string">&quot;k1&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="多路复用">多路复用</h2><p>  操作系统级的I/O模型有：</p><ul><li>阻塞I/O</li><li>非阻塞I/O</li><li>信号驱动I/O</li><li>异步I/O</li><li>多路复用I/O<br>  Linux下，一切皆文件。包括普通文件、目录文件、字符设备文件（键盘、鼠标）、块设备文件（硬盘、光驱）、套接字socket等等。文件描述符（File descriptor，FD）是访问文件资源的抽象句柄，读写文件都要通过它。文件描述符就是个非负整数，每个进程默认都会打开3个文件描述符：0标准输入、1标准输出、2标准错误。由于内存限制，文件描述符是有上限的，可通过ulimit –n查看，文件描述符用完后应及时关闭。</li></ul><p>阻塞I/O</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./block.png width=570 />  <p>非阻塞I/O</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./non_block.png width=600 /> <p>  read和write默认是阻塞模式。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>; </span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes)</span>;</span><br></pre></td></tr></table></figure><p>  通过系统调用fcntl可将文件描述符设置成非阻塞模式。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> flags = fcntl(fd, F_GETFL, <span class="number">0</span>); </span><br><span class="line">fcntl(fd, F_SETFL, flags | O_NONBLOCK);</span><br></pre></td></tr></table></figure><p>多路复用I/O<br>  select系统调用可同时监听1024个文件描述符的可读或可写状态。poll用链表存储文件描述符，摆脱了1024的上限。各操作系统实现了自己的I/O多路复用函数，如epoll、 evport 和kqueue等。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./select.png width=300 /> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./multi_reuse.png width=700 /> <p>  go多路复用函数以netpoll为前缀，针对不同的操作系统做了不同的封装，以达到最优的性能。在编译go语言时会根据目标平台选择特定的分支进行编译。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./go_multi_reuse.png width=300 /> <p>  利用go channel的多路复用实现倒计时发射的demo。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./bububu.png width=500 /> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//倒计时</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">countDown</span><span class="params">(countCh <span class="keyword">chan</span> <span class="type">int</span>, n <span class="type">int</span>, finishCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123; <span class="comment">//从n开始倒数</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">ticker := time.NewTicker(<span class="number">1</span> * time.Second) <span class="comment">//创建一个周期性的定时器，每隔1秒执行一次</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">countCh &lt;- n <span class="comment">//把n放入管道</span></span><br><span class="line">&lt;-ticker.C   <span class="comment">//等1秒钟</span></span><br><span class="line">n--          <span class="comment">//n减1</span></span><br><span class="line"><span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;  <span class="comment">//n减到0时退出</span></span><br><span class="line">ticker.Stop()          <span class="comment">//停止定时器</span></span><br><span class="line">finishCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//成功结束</span></span><br><span class="line"><span class="keyword">break</span>                  <span class="comment">//退出for循环</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中止</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">abort</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">buffer := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>)</span><br><span class="line">os.Stdin.Read(buffer) <span class="comment">//阻塞式IO，如果标准输入里没数据，该行一直阻塞。注意在键盘上敲完后要按下Enter才会把输入发给Stdin</span></span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">countCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">finishCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> countDown(countCh, <span class="number">10</span>, finishCh) <span class="comment">//开一个子协程，去往countCh和finishCh里放数据</span></span><br><span class="line">abortCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> abort(abortCh) <span class="comment">//开一个子协程，去往abortCh里放数据</span></span><br><span class="line"></span><br><span class="line">LOOP:</span><br><span class="line"><span class="keyword">for</span> &#123; <span class="comment">//循环监听</span></span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//同时监听3个channel，谁先准备好就执行谁，然后进入下一次for循环</span></span><br><span class="line"><span class="keyword">case</span> n := &lt;-countCh:</span><br><span class="line">fmt.Println(n)</span><br><span class="line"><span class="keyword">case</span> &lt;-finishCh:</span><br><span class="line">fmt.Println(<span class="string">&quot;finish&quot;</span>)</span><br><span class="line"><span class="keyword">break</span> LOOP <span class="comment">//退出for循环。在使用for select时，单独一个break不能退出for循环</span></span><br><span class="line"><span class="keyword">case</span> &lt;-abortCh:</span><br><span class="line">fmt.Println(<span class="string">&quot;abort&quot;</span>)</span><br><span class="line"><span class="keyword">break</span> LOOP <span class="comment">//退出for循环</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  函数超时控制的4种实现。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">WorkUseTime = <span class="number">500</span> * time.Millisecond</span><br><span class="line">Timeout     = <span class="number">100</span> * time.Millisecond</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个耗时较长的任务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LongTimeWork</span><span class="params">()</span></span> &#123;</span><br><span class="line">time.Sleep(WorkUseTime)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个接口处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle1</span><span class="params">()</span></span> &#123;</span><br><span class="line">deadline := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">workDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//把要控制超时的函数放到一个协程里</span></span><br><span class="line">LongTimeWork()</span><br><span class="line">workDone &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//把要控制超时的函数放到一个协程里</span></span><br><span class="line">time.Sleep(Timeout)</span><br><span class="line">deadline &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//下面的case只执行最早到来的那一个</span></span><br><span class="line"><span class="keyword">case</span> &lt;-workDone:</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork return&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-deadline:</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个接口处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle2</span><span class="params">()</span></span> &#123;</span><br><span class="line">workDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//把要控制超时的函数放到一个协程里</span></span><br><span class="line">LongTimeWork()</span><br><span class="line">workDone &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//下面的case只执行最早到来的那一个</span></span><br><span class="line"><span class="keyword">case</span> &lt;-workDone:</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork return&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(Timeout):</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个接口处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle3</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//通过显式sleep再调用cancle()来实现对函数的超时控制</span></span><br><span class="line"><span class="comment">//调用cancel()将关闭ctx.Done()对应的管道</span></span><br><span class="line">ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">workDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//把要控制超时的函数放到一个协程里</span></span><br><span class="line">LongTimeWork()</span><br><span class="line">workDone &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//100毫秒后调用cancel()，关闭ctx.Done()</span></span><br><span class="line">time.Sleep(Timeout)</span><br><span class="line">cancel()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//下面的case只执行最早到来的那一个</span></span><br><span class="line"><span class="keyword">case</span> &lt;-workDone:</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork return&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//ctx.Done()是一个管道，调用了cancel()都会关闭这个管道，然后读操作就会立即返回</span></span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个接口处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle4</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//借助于带超时的context来实现对函数的超时控制</span></span><br><span class="line"><span class="comment">//调用cancel()或到达超时时间都将关闭ctx.Done()对应的管道</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), Timeout)</span><br><span class="line"><span class="keyword">defer</span> cancel() <span class="comment">//纯粹出于良好习惯，函数退出前调用cancel()</span></span><br><span class="line">workDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//把要控制超时的函数放到一个协程里</span></span><br><span class="line">LongTimeWork()</span><br><span class="line">workDone &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//下面的case只执行最早到来的那一个</span></span><br><span class="line"><span class="keyword">case</span> &lt;-workDone:</span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork return&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//ctx.Done()是一个管道，context超时或者调用了cancel()都会关闭这个管道，然后读操作就会立即返回</span></span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">Handle1()</span><br><span class="line">Handle2()</span><br><span class="line">Handle3()</span><br><span class="line">Handle4()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="协程泄漏">协程泄漏</h2><p>  协程阻塞，未能如期结束，导致协程数量不断攀升的现象称为协程泄漏。协程阻塞最常见的原因都跟channel有关。由于每个协程都要占用内存，所以协程泄漏也会导致内存泄漏。<br>routine_leaky.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个耗时较长的任务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span></span> &#123;</span><br><span class="line">time.Sleep(time.Duration(<span class="number">500</span>) * time.Millisecond)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟一个接口处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//借助于带超时的context来实现对函数的超时控制</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*<span class="number">100</span>) <span class="comment">//改成1000试试</span></span><br><span class="line"><span class="keyword">defer</span> cancel()                                                                 <span class="comment">//纯粹出于良好习惯，函数退出前调用cancel()</span></span><br><span class="line"><span class="comment">// begin := time.Now()</span></span><br><span class="line">workDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="comment">//创建一个无缓冲管道</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                     <span class="comment">//启动一个子协程</span></span><br><span class="line">work()</span><br><span class="line">workDone &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//work()结束后到，走到这行代码会一直阻塞，子协程无法结束，导致协程泄漏</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">select</span> &#123; <span class="comment">//下面的case只执行最早到来的那一个</span></span><br><span class="line"><span class="keyword">case</span> &lt;-workDone: <span class="comment">//永远执行不到</span></span><br><span class="line">fmt.Println(<span class="string">&quot;LongTimeWork return&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//ctx.Done()是一个管道，context超时或者调用了cancel()都会关闭这个管道，然后读操作就会立即返回</span></span><br><span class="line"><span class="comment">// fmt.Printf(&quot;LongTimeWork timeout %d ms\n&quot;, time.Since(begin).Milliseconds())</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">handle()</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second)                      <span class="comment">//等所有work()结束</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;当前协程数：%d\n&quot;</span>, runtime.NumGoroutine()) <span class="comment">//11，10个阻塞的子协程 加 main协程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  在以上代码中workDone是同步管道，子协程向workDone里send数据时总是会阻塞（如果每次都超时的话），子协程因阻塞而一直不能退出，导致子协程数量不断累积。<br>  下面讲排查协程泄漏的方法。首先在一个端口上开启http监听：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;localhost:8080&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  上述代码在8080端口上开启了监听，那我们在本地把程序跑起来，然后在浏览器上访问127.0.0.1:8080/debug/pprof/goroutine?debug=1。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak1.png width=900 />  <p>  从截图上我们看到协程数量确实多得超出预期，并且明确提示出源代码第25行导致了内存泄漏。还可以通过go tool pprof定位协程泄漏，在终端运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof http://0.0.0.0:8080/debug/pprof/goroutine</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak2.png width=800 />  <p>  注意上面截图中显示生成了一个文件/Users/zhangchaoyang/pprof/pprof.goroutine.001.pb.gz，后面我们会用到它。从截图可以看到main.handle.func1创建的协程最多，通过list命令查看这个函数里到底是哪行代码导致的协程泄漏</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak3.png width=900 /> <p>  也可能通过traces打印调用堆栈，下面截图显示main.handle.func1由于调用了chansend1而阻塞了1132个协程。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak4.png width=400 /> <p>  在pprof中输入web命令，相当于是traces命令的可视化。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak5.png width=500 />   <p>  其实终端执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof --http=:8081 /Users/zhangchaoyang/pprof/pprof.goroutine.001.pb.gz  </span><br></pre></td></tr></table></figure><p>在source view下可看到哪行代码生成的协程最多。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./leak6.png width=700 /> <h2 id="协程管理">协程管理</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runtime.GOMAXPROCS(<span class="number">2</span>)<span class="comment">//分配2个逻辑处理器给调度器使用</span></span><br><span class="line">runtime.Gosched()<span class="comment">//当前goroutine从当前线程退出，并放回到队列</span></span><br><span class="line">runtime.NumGoroutine()<span class="comment">//查看当前存在的协程数</span></span><br></pre></td></tr></table></figure><p>  通过带缓冲的channel可以实现对goroutine数量的控制。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Glimit <span class="keyword">struct</span> &#123;</span><br><span class="line">limit <span class="type">int</span></span><br><span class="line">ch    <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGlimit</span><span class="params">(limit <span class="type">int</span>)</span></span> *Glimit &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Glimit&#123;</span><br><span class="line">limit: limit,</span><br><span class="line">ch:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, limit), <span class="comment">//缓冲长度为limit，运行的协程不会超过这个值</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Glimit)</span></span> Run(f <span class="function"><span class="keyword">func</span><span class="params">()</span></span>) &#123;</span><br><span class="line">g.ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">//创建子协程前往管道里send一个数据</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">f()</span><br><span class="line">&lt;-g.ch <span class="comment">//子协程退出时从管理里取出一个数据</span></span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//每隔1秒打印一次协程数量</span></span><br><span class="line">ticker := time.NewTicker(<span class="number">1</span> * time.Second)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&lt;-ticker.C</span><br><span class="line">fmt.Printf(<span class="string">&quot;当前协程数：%d\n&quot;</span>, runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">work := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line">time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">glimit := NewGlimit(<span class="number">10</span>) <span class="comment">//限制协程数为10</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">glimit.Run(work) <span class="comment">//不停地通过Run创建子协程</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  守护协程：独立于控制终端和用户请求的协程，它一直存在，周期性执行某种任务或等待处理某些发生的事件。伴随着main协程的退出，守护协程也退出。<br>  kill命令不是杀死进程，它只是向进程发送信号kill –s pid，s的默认值是15。常见的终止信号如下：</p><table><thead><tr><th style="text-align:center">信号</th><th style="text-align:center">值</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">SIGINT</td><td style="text-align:center">2</td><td style="text-align:center">Ctrl+C触发</td></tr><tr><td style="text-align:center">SIGKILL</td><td style="text-align:center">9</td><td style="text-align:center">无条件结束程序，不能捕获、阻塞或忽略</td></tr><tr><td style="text-align:center">SIGTERM</td><td style="text-align:center">15</td><td style="text-align:center">结束程序，可以捕获、阻塞或忽略</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)</span><br></pre></td></tr></table></figure><p>  当Context的deadline到期或调用了CancelFunc后，Context的Done()管道会关闭，该管道上关联的读操作会解除阻塞，然后执行协程退出前的清理工作。<br>  下面的代码演示了如何优雅地退出守护协程。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;os/signal&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">wg     sync.WaitGroup</span><br><span class="line">ctx    context.Context</span><br><span class="line">cancle context.CancelFunc</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg = sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(<span class="number">3</span>)                                              <span class="comment">//3个子协程，1个用于接收终止信号，其他2个是业务需要的后台协程</span></span><br><span class="line">ctx, cancle = context.WithCancel(context.Background()) <span class="comment">//父context</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listenSignal</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line"><span class="comment">//监听指定信号 SIGINT和SIGTERM。按下control+c向进程发送SIGINT信号</span></span><br><span class="line">signal.Notify(c, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//调用cancle()时，管道ctx.Done()会被关闭，从ctx.Done()中读数据会立即返回0值</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> sig := &lt;-c: <span class="comment">//接收到终止信息</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;got signal %d\n&quot;</span>, sig)</span><br><span class="line">cancle() <span class="comment">//取消，通知用到ctx的所有协程</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listenHttp</span><span class="params">(port <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">server := &amp;http.Server&#123;Addr: <span class="string">&quot;:&quot;</span> + strconv.Itoa(port), Handler: <span class="literal">nil</span>&#125; <span class="comment">//在端口port上开启http服务</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">server.Close() <span class="comment">//调用Close后才会释放端口</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &#123; <span class="comment">//如果不发生error，该行代码会一直阻塞，直到server.Close()</span></span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;stop listen on port %d\n&quot;</span>, port)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//下面3个协程关联到了同一个context，通过cancle()可以通知彼此</span></span><br><span class="line"><span class="keyword">go</span> listenSignal()</span><br><span class="line"><span class="keyword">go</span> listenHttp(<span class="number">8080</span>)</span><br><span class="line"><span class="keyword">go</span> listenHttp(<span class="number">8081</span>)</span><br><span class="line">wg.Wait() <span class="comment">//等待3个子协程优雅退出后，main协程再退出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例-4">案例</h2><h3 id="并发读写文件">并发读写文件</h3><p>3个线程三个文件写入channel，1个协程读取写入文件，不要求文件顺序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> lineChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">10000</span>)</span><br><span class="line"><span class="keyword">var</span> writeDone = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFiles</span><span class="params">(fileName <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">f, err := os.Open(fileName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">r := bufio.NewReader(f)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">s, err2 := r.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</span><br><span class="line">s += <span class="string">&quot;\n&quot;</span></span><br><span class="line">lineChan &lt;- s</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">lineChan &lt;- s</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFiles</span><span class="params">(fileName <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(writeDone)</span><br><span class="line">f, err := os.OpenFile(fileName, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">w := bufio.NewWriter(f)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> line, ok := &lt;-lineChan; ok &#123;</span><br><span class="line">w.WriteString(line)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">w.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line">fileName := <span class="string">&quot;dir/&quot;</span> + strconv.Itoa(i)</span><br><span class="line"><span class="keyword">go</span> ReadFiles(fileName)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> WriteFiles(<span class="string">&quot;dir/merge&quot;</span>)</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="comment">// 所有读协程完成后关闭通道</span></span><br><span class="line"><span class="built_in">close</span>(lineChan)</span><br><span class="line"><span class="comment">// 利用同步管道阻塞写协程</span></span><br><span class="line">&lt;-writeDone</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang数据结构与算法</title>
      <link href="/20230104/golang-20230104-golang%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
      <url>/20230104/golang-20230104-golang%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="链表">链表</h2><p>链表是一种非连续的存储容器，由多个节点组成，节点通过一些变量记录彼此之间的关系，链表有多种实现方法，如单链表、双链表等<br>在Go语言中，链表使用 container/list 包来实现，内部的实现原理是双链表，链表能够高效地进行任意位置的元素插入和删除操作。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./单双向链表.png width=800 />  <h3 id="初始化列表">初始化列表</h3><p>list 的初始化有两种方法：分别是使用 New() 函数和 var 关键字声明，两种方法的初始化效果都是一致的。</p><ol><li>通过 container/list 包的 New() 函数初始化 list</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">变量名 := list.New()</span><br></pre></td></tr></table></figure><ol start="2"><li>通过 var 关键字声明初始化 list</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> 变量名 list.List</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>链表与切片和 map 不同的是，链表并没有具体元素类型的限制，因此，链表的元素可以是任意类型，这既带来了便利，也引来一些问题，例如给链表中放入了一个 interface{} 类型的值，取出值后，如果要将 interface{} 转换为其他类型将会发生宕机。</p></div><h3 id="在链表中插入元素">在链表中插入元素</h3><p>双链表支持从队列前方或后方插入元素，分别对应的方法是 PushFront 和 PushBack。</p><div class="note warning no-icon flat"><p><strong>提示</strong><br>这两个方法都会返回一个 *list.Element 结构，如果在以后的使用中需要删除插入的元素，则只能通过 *list.Element 配合 Remove() 方法进行删除，这种方法可以让删除更加效率化，同时也是双链表特性之一。</p></div><p>下面代码展示如何给 list 添加元素：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l := list.New()</span><br><span class="line">l.PushBack(<span class="string">&quot;fist&quot;</span>)</span><br><span class="line">l.PushFront(<span class="number">67</span>)</span><br></pre></td></tr></table></figure><p>代码说明如下：</p><ul><li>第 1 行，创建一个链表实例。</li><li>第 3 行，将 fist 字符串插入到列表的尾部，此时列表是空的，插入后只有一个元素。</li><li>第 4 行，将数值 67 放入列表，此时，列表中已经存在 fist 元素，67 这个元素将被放在 fist 的前面。</li></ul><p>链表插入元素的方法如下表所示。</p><table><thead><tr><th>方法</th><th>功能</th></tr></thead><tbody><tr><td>InsertAfter(v interface {}, mark * Element) * Element</td><td>在 mark 点之后插入元素，mark 点由其他插入函数提供</td></tr><tr><td>InsertBefore(v interface {}, mark * Element) *Element</td><td>在 mark 点之前插入元素，mark 点由其他插入函数提供</td></tr><tr><td>PushBackList(other *List)</td><td>添加 other 列表元素到尾部</td></tr><tr><td>PushFrontList(other *List)</td><td>添加 other 列表元素到头部</td></tr></tbody></table><h3 id="从链表中删除元素">从链表中删除元素</h3><p>链表插入函数的返回值会提供一个 *list.Element 结构，这个结构记录着列表元素的值以及与其他节点之间的关系等信息，从链表中删除元素时，需要用到这个结构进行快速删除。</p><p>列表操作元素：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;container/list&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l := list.New()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尾部添加</span></span><br><span class="line">    l.PushBack(<span class="string">&quot;canon&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 头部添加</span></span><br><span class="line">    l.PushFront(<span class="number">67</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尾部添加后保存元素句柄</span></span><br><span class="line">    element := l.PushBack(<span class="string">&quot;fist&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在fist之后添加high</span></span><br><span class="line">    l.InsertAfter(<span class="string">&quot;high&quot;</span>, element)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在fist之前添加noon</span></span><br><span class="line">    l.InsertBefore(<span class="string">&quot;noon&quot;</span>, element)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用</span></span><br><span class="line">    l.Remove(element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码说明如下：</p><ul><li>第 6 行，创建列表实例。</li><li>第 9 行，将字符串 canon 插入到列表的尾部。</li><li>第 12 行，将数值 67 添加到列表的头部。</li><li>第 15 行，将字符串 fist 插入到列表的尾部，并将这个元素的内部结构保存到 element 变量中。</li><li>第 18 行，使用 element 变量，在 element 的位置后面插入 high 字符串。</li><li>第 21 行，使用 element 变量，在 element 的位置前面插入 noon 字符串。</li><li>第 24 行，移除 element 变量对应的元素。</li></ul><p>下表中展示了每次操作后列表的实际元素情况。</p><p>列表元素操作的过程</p><table><thead><tr><th>操作内容</th><th>列表元素</th></tr></thead><tbody><tr><td>l.PushBack(“canon”)</td><td>canon</td></tr><tr><td>l.PushFront(67)</td><td>67, canon</td></tr><tr><td>element := l.PushBack(“fist”)</td><td>67, canon, fist</td></tr><tr><td>l.InsertAfter(“high”, element)</td><td>67, canon, fist, high</td></tr><tr><td>l.InsertBefore(“noon”, element)</td><td>67, canon, noon, fist, high</td></tr><tr><td>l.Remove(element)</td><td>67, canon, noon, high</td></tr></tbody></table><h3 id="遍历列表">遍历列表</h3><p>访问列表的每一个元素</p><p>遍历双链表需要配合 Front() 函数获取头元素，遍历时只要元素不为空就可以继续进行，每一次遍历都会调用元素的 Next() 函数，代码如下所示</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l := list.New()</span><br><span class="line"><span class="comment">// 尾部添加</span></span><br><span class="line">l.PushBack(<span class="string">&quot;canon&quot;</span>)</span><br><span class="line"><span class="comment">// 头部添加</span></span><br><span class="line">l.PushFront(<span class="number">67</span>)</span><br><span class="line"><span class="keyword">for</span> i := l.Front(); i != <span class="literal">nil</span>; i = i.Next() &#123;</span><br><span class="line">    fmt.Println(i.Value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码输出如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">67</span></span><br><span class="line">canon</span><br></pre></td></tr></table></figure><p>代码说明如下：</p><ul><li>第 1 行，创建一个列表实例。</li><li>第 4 行，将 canon 放入列表尾部。</li><li>第 7 行，在队列头部放入 67。</li><li>第 9 行，使用 for 语句进行遍历，其中 i:=l.Front() 表示初始赋值，只会在一开始执行一次，每次循环会进行一次 i != nil 语句判断，如果返回 false，表示退出循环，反之则会执行 i = i.Next()。</li><li>第 10 行，使用遍历返回的 *list.Element 的 Value 成员取得放入列表时的原值。</li></ul><h3 id="循环链表">循环链表</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./循环链表.png width=600 /> <p>  ring的应用：基于滑动窗口的统计。比如最近100次接口调用的平均耗时、最近10笔订单的平均值、最近30个交易日股票的最高点。ring的容量即为滑动窗口的大小，把待观察变量按时间顺序不停地写入ring即可。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;container/ring&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//必须指定长度，各元素被初始化为nil</span></span><br><span class="line">ring := ring.New(<span class="number">5</span>)</span><br><span class="line"><span class="comment">// 链表中插入元素</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">ring.Value = i</span><br><span class="line">ring = ring.Next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过Do()来遍历ring，内部实际上调用了Next()而非Prev()</span></span><br><span class="line">ring.Do(<span class="function"><span class="keyword">func</span><span class="params">(a any)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;a: %v\n&quot;</span>, a)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="应用案例">应用案例</h3><p>  LRU(Least Recently Used, 最近最少使用)缓存淘汰的总体思路：缓存的key放到链表中，头部的元素表示最近刚使用。</p><ul><li>如果命中缓存，从链表中找到对应的key，移到链表头部。</li><li>如果没命中缓存：<ul><li>如果缓存容量没超，放入缓存，并把key放到链表头部。</li><li>如果超出缓存容量，删除链表尾部元素，再把key放到链表头部。</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;container/list&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LRUCache <span class="keyword">struct</span> &#123;</span><br><span class="line">cache <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span></span><br><span class="line">lst   list.List</span><br><span class="line">Cap   <span class="type">int</span> <span class="comment">//缓存容量的上限</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLRUCache</span><span class="params">(<span class="built_in">cap</span> <span class="type">int</span>)</span></span> *LRUCache &#123;</span><br><span class="line">lru := <span class="built_in">new</span>(LRUCache)</span><br><span class="line">lru.Cap = <span class="built_in">cap</span></span><br><span class="line">lru.cache = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="built_in">cap</span>)</span><br><span class="line">lru.lst = list.List&#123;&#125;</span><br><span class="line"><span class="keyword">return</span> lru</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span></span> Add(key <span class="type">int</span>, value <span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(lru.cache) &lt; lru.Cap &#123; <span class="comment">//还没有到达缓存容量上限</span></span><br><span class="line"><span class="comment">//直接把key value放到缓存中去</span></span><br><span class="line">lru.cache[key] = value</span><br><span class="line">lru.lst.PushFront(key)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//刚刚到达缓存容量上限</span></span><br><span class="line"><span class="comment">//先从缓存中淘汰一个元素</span></span><br><span class="line">back := lru.lst.Back()</span><br><span class="line"><span class="built_in">delete</span>(lru.cache, back.Value.(<span class="type">int</span>)) <span class="comment">//interface &#123;&#125; is nil, not int</span></span><br><span class="line">lru.lst.Remove(back)</span><br><span class="line"><span class="comment">//然后再把key value放到缓存中去</span></span><br><span class="line">lru.cache[key] = value</span><br><span class="line">lru.lst.PushFront(key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span></span> find(key <span class="type">int</span>) *list.Element &#123;</span><br><span class="line"><span class="keyword">if</span> lru.lst.Len() == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">head := lru.lst.Front()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> head == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> head.Value.(<span class="type">int</span>) == key &#123;</span><br><span class="line"><span class="keyword">return</span> head</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">head = head.Next()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span></span> Get(key <span class="type">int</span>) (<span class="type">string</span>, <span class="type">bool</span>) &#123;</span><br><span class="line">value, exists := lru.cache[key]</span><br><span class="line">ele := lru.find(key)</span><br><span class="line"><span class="keyword">if</span> ele != <span class="literal">nil</span> &#123;</span><br><span class="line">lru.lst.MoveToFront(ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> value, exists</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testLRU</span><span class="params">()</span></span> &#123;</span><br><span class="line">lru := NewLRUCache(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">lru.Add(i, strconv.Itoa(i)) <span class="comment">//9 8 7 6 5 4 3 2 1 0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i += <span class="number">2</span> &#123;</span><br><span class="line">lru.Get(i) <span class="comment">//8 6 4 2 0 9 7 5 3 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">10</span>; i &lt; <span class="number">15</span>; i++ &#123;</span><br><span class="line">lru.Add(i, strconv.Itoa(i)) <span class="comment">//14 13 12 11 10 8 6 4 2 0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">_, exists := lru.Get(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;key %d exists %t\n&quot;</span>, i, exists) <span class="comment">//9 7 5 3 1不存在，8 6 4 2 0存在</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">testLRU()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>key 0 exists true<br>key 1 exists false<br>key 2 exists true<br>key 3 exists false<br>key 4 exists true<br>key 5 exists false<br>key 6 exists true<br>key 7 exists false<br>key 8 exists true<br>key 9 exists false</p><h2 id="栈">栈</h2><p>  栈是一种先进后出的数据结构，push把元素压入栈底，pop弹出栈顶的元素。编程语言的编译系统也用到了栈的思想。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./栈.png width=600 /> <p>  go自带的List已经包含了栈的功能，这里实现一个线程安全的栈。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> (</span><br><span class="line">node <span class="keyword">struct</span> &#123;</span><br><span class="line">value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">prev  *node</span><br><span class="line">&#125;</span><br><span class="line">MyStack <span class="keyword">struct</span> &#123;</span><br><span class="line">top    *node</span><br><span class="line">length <span class="type">int</span></span><br><span class="line">lock   *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMyStack</span><span class="params">()</span></span> *MyStack &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;MyStack&#123;<span class="literal">nil</span>, <span class="number">0</span>, &amp;sync.RWMutex&#123;&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stack *MyStack)</span></span> Push(value <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">stack.lock.Lock()</span><br><span class="line"><span class="keyword">defer</span> stack.lock.Unlock()</span><br><span class="line">n := &amp;node&#123;value, stack.top&#125;</span><br><span class="line">stack.top = n</span><br><span class="line">stack.length++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stack *MyStack)</span></span> Pop() <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">stack.lock.Lock()</span><br><span class="line"><span class="keyword">defer</span> stack.lock.Unlock()</span><br><span class="line"><span class="keyword">if</span> stack.length == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">n := stack.top</span><br><span class="line">stack.top = n.prev</span><br><span class="line">stack.length--</span><br><span class="line"><span class="keyword">return</span> n.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stack *MyStack)</span></span> Peak() <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">stack.lock.RLock()</span><br><span class="line"><span class="keyword">defer</span> stack.lock.RUnlock()</span><br><span class="line"><span class="keyword">if</span> stack.length == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> stack.top.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stack *MyStack)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> stack.length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(stack *MyStack)</span></span> Empty() <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> stack.Len() == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="栈应用">栈应用</h3><p>利用栈容器实现斐波那契序列计算<br>11235813…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;container/list&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fib</span><span class="params">(n <span class="type">int</span>, stack *list.List)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">if</span> n == <span class="number">1</span> || n == <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">stack.PushBack(<span class="number">1</span>)</span><br><span class="line">stack.PushBack(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; n; i++ &#123;</span><br><span class="line">a := stack.Back()</span><br><span class="line">stack.Remove(a)</span><br><span class="line">b := stack.Back()</span><br><span class="line">stack.Remove(b)</span><br><span class="line">stack.PushBack(a.Value.(<span class="type">int</span>))</span><br><span class="line">stack.PushBack(a.Value.(<span class="type">int</span>) + b.Value.(<span class="type">int</span>))</span><br><span class="line">&#125;</span><br><span class="line">ret := stack.Back().Value.(<span class="type">int</span>)</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">l := list.New()</span><br><span class="line">i := Fib(<span class="number">5000</span>, l)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="堆">堆</h2><p>  堆是一棵二叉树。大根堆即任意节点的值都大于等于其子节点。反之为小根堆。<br>  用数组来表示堆，下标为 i 的结点的父结点下标为(i-1)/2，其左右子结点分别为 (2i + 1)、(2i + 2)。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./堆的底层实现.png width=600 />  <p>构建堆</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./构建堆.png width=650 />   <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//AdjustTraingle 如果只是修改slice里的元素，不需要传slice的指针；如果要往slice里append或让slice指向新的子切片，则需要传slice指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AdjustTraingle</span><span class="params">(arr []<span class="type">int</span>, parent <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">left := <span class="number">2</span>*parent + <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> left &gt;= <span class="built_in">len</span>(arr) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">right := <span class="number">2</span>*parent + <span class="number">2</span></span><br><span class="line">minIndex := parent</span><br><span class="line">minValue := arr[minIndex]</span><br><span class="line"><span class="keyword">if</span> arr[left] &lt; minValue &#123;</span><br><span class="line">minValue = arr[left]</span><br><span class="line">minIndex = left</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> right &lt; <span class="built_in">len</span>(arr) &#123;</span><br><span class="line"><span class="keyword">if</span> arr[right] &lt; minValue &#123;</span><br><span class="line">minValue = arr[right]</span><br><span class="line">minIndex = right</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> minIndex != parent &#123;</span><br><span class="line">arr[minIndex], arr[parent] = arr[parent], arr[minIndex]</span><br><span class="line">AdjustTraingle(arr, minIndex) <span class="comment">//递归。每当有元素调整下来时，要对以它为父节点的三角形区域进行调整</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReverseAdjust</span><span class="params">(arr []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">n := <span class="built_in">len</span>(arr)</span><br><span class="line"><span class="keyword">if</span> n &lt;= <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">lastIndex := n / <span class="number">2</span> * <span class="number">2</span></span><br><span class="line">fmt.Println(lastIndex)</span><br><span class="line"><span class="keyword">for</span> i := lastIndex; i &gt; <span class="number">0</span>; i -= <span class="number">2</span> &#123; <span class="comment">//逆序检查每一个三角形区域</span></span><br><span class="line">right := i</span><br><span class="line">parent := (right - <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">fmt.Println(parent)</span><br><span class="line">AdjustTraingle(arr, parent)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildHeap</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">62</span>, <span class="number">40</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">49</span>&#125;</span><br><span class="line">ReverseAdjust(arr)</span><br><span class="line">fmt.Println(arr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  每当有元素调整下来时，要对以它为父节点的三角形区域进行调整。</p><p>插入元素</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./插入元素.png width=650 />   <p>删除堆顶</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./删除堆顶.png width=650 />  <p>下面讲几个堆的应用。<br>堆排序</p><ol><li>构建堆O(N)。</li><li>不断地删除堆顶O(NlogN)。</li></ol><p>求集合中最大的K个元素</p><ol><li>用集合的前K个元素构建小根堆。</li><li>逐一遍历集合的其他元素，如果比堆顶小直接丢弃；否则替换掉堆顶，然后向下调整堆。</li></ol><p>把超时的元素从缓存中删除</p><ol><li>按key的到期时间把key插入小根堆中。</li><li>周期扫描堆顶元素，如果它的到期时间早于当前时刻，则从堆和缓存中删除，然后向下调整堆。<br>  golang中的container/heap实现了小根堆，但需要自己定义一个类，实现以下接口：</li></ol><ul><li>Len() int</li><li>Less(i, j int) bool</li><li>Swap(i, j int)</li><li>Push(x interface{})</li><li>Pop() x interface{}</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</span><br><span class="line">Value    <span class="type">string</span></span><br><span class="line">priority <span class="type">int</span> <span class="comment">//优先级，数字越大，优先级越高</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PriorityQueue []*Item</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(pq)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> pq[i].priority &gt; pq[j].priority <span class="comment">//golang默认提供的是小根堆，而优先队列是大根堆，所以这里要反着定义Less</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">pq[i], pq[j] = pq[j], pq[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//往slice里append,需要传slice指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span></span> Push(x <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">item := x.(*Item)</span><br><span class="line">*pq = <span class="built_in">append</span>(*pq, item)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//让slice指向新的子切片，需要传slice指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span></span> Pop() <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">old := *pq</span><br><span class="line">n := <span class="built_in">len</span>(old)</span><br><span class="line">item := old[n<span class="number">-1</span>]   <span class="comment">//数组最后一个元素</span></span><br><span class="line">*pq = old[<span class="number">0</span> : n<span class="number">-1</span>] <span class="comment">//去掉最一个元素</span></span><br><span class="line"><span class="keyword">return</span> item</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Trie树">Trie树</h2><p>  trie树又叫字典权。<br>  现有term集合：{分散，分散精力，分散投资，分布式，工程，工程师}，把它们放到Trie树里如下图:</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./trie.png width=500 /><p>  Trie树的根节点是总入口，不存储字符。对于英文，第个节点有26个子节点，子节点可以存到数组里；中文由于汉字很多，用数组存子节点太浪费内存，可以用map存子节点。从根节点到叶节点的完整路径是一个term。从根节点到某个中间节点也可能是一个term，即一个term可能是另一个term的前缀。上图中红圈表示从根节点到本节点是一个完整的term。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TrieNode <span class="keyword">struct</span> &#123;</span><br><span class="line">Word     <span class="type">rune</span>               <span class="comment">//当前节点存储的字符。byte只能表示英文字符，rune可以表示任意字符</span></span><br><span class="line">Children <span class="keyword">map</span>[<span class="type">rune</span>]*TrieNode <span class="comment">//孩子节点，用一个map存储</span></span><br><span class="line">Term     <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TrieTree <span class="keyword">struct</span> &#123;</span><br><span class="line">root *TrieNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//add 把words[beginIndex:]插入到Trie树中</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *TrieNode)</span></span> add(words []<span class="type">rune</span>, term <span class="type">string</span>, beginIndex <span class="type">int</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> beginIndex &gt;= <span class="built_in">len</span>(words) &#123; <span class="comment">//words已经遍历完了</span></span><br><span class="line">node.Term = term</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> node.Children == <span class="literal">nil</span> &#123;</span><br><span class="line">node.Children = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">rune</span>]*TrieNode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">word := words[beginIndex] <span class="comment">//把这个word放到node的子节点中</span></span><br><span class="line"><span class="keyword">if</span> child, exists := node.Children[word]; !exists &#123;</span><br><span class="line">newNode := &amp;TrieNode&#123;Word: word&#125;</span><br><span class="line">node.Children[word] = newNode</span><br><span class="line">newNode.add(words, term, beginIndex+<span class="number">1</span>) <span class="comment">//递归</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">child.add(words, term, beginIndex+<span class="number">1</span>) <span class="comment">//递归</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//walk words[0]就是当前节点上存储的字符，按照words的指引顺着树往下走，最终返回words最后一个字符对应的节点</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *TrieNode)</span></span> walk(words []<span class="type">rune</span>, beginIndex <span class="type">int</span>) *TrieNode &#123;</span><br><span class="line"><span class="keyword">if</span> beginIndex == <span class="built_in">len</span>(words)<span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br><span class="line">beginIndex += <span class="number">1</span></span><br><span class="line">word := words[beginIndex]</span><br><span class="line"><span class="keyword">if</span> child, exists := node.Children[word]; exists &#123;</span><br><span class="line"><span class="keyword">return</span> child.walk(words, beginIndex)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//traverseTerms 遍历一个node下面所有的term。注意要传数组的指针，才能真正修改这个数组</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *TrieNode)</span></span> traverseTerms(terms *[]<span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(node.Term) &gt; <span class="number">0</span> &#123;</span><br><span class="line">*terms = <span class="built_in">append</span>(*terms, node.Term)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, child := <span class="keyword">range</span> node.Children &#123;</span><br><span class="line">child.traverseTerms(terms)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tree *TrieTree)</span></span> AddTerm(term <span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(term) &lt;= <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">words := []<span class="type">rune</span>(term)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> tree.root == <span class="literal">nil</span> &#123;</span><br><span class="line">tree.root = <span class="built_in">new</span>(TrieNode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tree.root.add(words, term, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tree *TrieTree)</span></span> Retrieve(prefix <span class="type">string</span>) []<span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">if</span> tree.root == <span class="literal">nil</span> || <span class="built_in">len</span>(tree.root.Children) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">words := []<span class="type">rune</span>(prefix)</span><br><span class="line">firstWord := words[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> child, exists := tree.root.Children[firstWord]; exists &#123;</span><br><span class="line">end := child.walk(words, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> end == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">terms := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">end.traverseTerms(&amp;terms)</span><br><span class="line"><span class="keyword">return</span> terms</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">tree := <span class="built_in">new</span>(TrieTree)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;分散&quot;</span>)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;分散精力&quot;</span>)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;分散投资&quot;</span>)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;分布式&quot;</span>)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;工程&quot;</span>)</span><br><span class="line">tree.AddTerm(<span class="string">&quot;工程师&quot;</span>)</span><br><span class="line"></span><br><span class="line">terms := tree.Retrieve(<span class="string">&quot;分散&quot;</span>)</span><br><span class="line">fmt.Println(terms)</span><br><span class="line">terms = tree.Retrieve(<span class="string">&quot;人工&quot;</span>)</span><br><span class="line">fmt.Println(terms)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang加密算法</title>
      <link href="/20230103/golang-20230103-golang%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/"/>
      <url>/20230103/golang-20230103-golang%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="对称加密">对称加密</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./对称加密.png width=300 /><p>  加密过程的每一步都是可逆的。加密和解密用的是同一组密钥。异或是最简单的对称加密算法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XOR 异或运算，要求plain和key的长度相同</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">XOR</span><span class="params">(plain <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">bPlain := []<span class="type">byte</span>(plain)</span><br><span class="line">bCipher := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(key))</span><br><span class="line"><span class="keyword">for</span> i, k := <span class="keyword">range</span> key &#123;</span><br><span class="line">bCipher[i] = k ^ bPlain[i]</span><br><span class="line">&#125;</span><br><span class="line">cipher := <span class="type">string</span>(bCipher)</span><br><span class="line"><span class="keyword">return</span> cipher</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  DES（Data Encryption Standard）数据加密标准，是目前最为流行的加密算法之一。对原始数据（明文）进行分组，每组64位，最后一组不足64位时按一定规则填充。每一组上单独施加DES算法。<br>DES子密钥生成<br>  初始密钥64位，实际有效位56位，每隔7位有一个校验位。根据初始密钥生成16个48位的子密钥。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./DES子密钥生成.png width=650 />  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./DES子密钥生成2.png width=650 />   <p>  N取值从1到16，N和x有固定的映射表。</p><p>DES加密过程</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./DES加密过程1.png width=450 />  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./DES加密过程2.png width=600 />  <p>  L1, R1 = f(L0, R0, K1)，依此循环，得到L16和R16。<br>  S盒替换。输入48位，输出32位。各分为8组，输入每组6位，输出每组4位。分别在每组上施加S盒替换，一共8个S盒。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./S盒替换.png width=650 />   <p>DES加密过程</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./DES加密过程3.png width=650 />   <p>  分组模式。CBC（Cipher Block Chaining ）密文分组链接模式，将当前明文分组与前一个密文分组进行异或运算，然后再进行加密。其他分组模式还有ECB, CTR, CFR, OFB。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesEncryptCBC</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src := []<span class="type">byte</span>(text)</span><br><span class="line">block, err := des.NewCipher(key) <span class="comment">//用des创建一个加密器cipher</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">blockSize := block.BlockSize()           <span class="comment">//分组的大小，blockSize=8</span></span><br><span class="line">src = common.ZeroPadding(src, blockSize) <span class="comment">//填充</span></span><br><span class="line"></span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))                   <span class="comment">//密文和明文的长度一致</span></span><br><span class="line">encrypter := cipher.NewCBCEncrypter(block, key) <span class="comment">//CBC分组模式加密</span></span><br><span class="line">encrypter.CryptBlocks(out, src)</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesDecryptCBC</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src, err := hex.DecodeString(text) <span class="comment">//转成[]byte</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">block, err := des.NewCipher(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))                   <span class="comment">//密文和明文的长度一致</span></span><br><span class="line">encrypter := cipher.NewCBCDecrypter(block, key) <span class="comment">//CBC分组模式解密</span></span><br><span class="line">encrypter.CryptBlocks(out, src)</span><br><span class="line">out = common.ZeroUnPadding(out) <span class="comment">//反填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  AES（Advanced Encryption Standard）高级加密标准，旨在取代DES。</p><h2 id="非对称加密">非对称加密</h2><ul><li>使用公钥加密，使用私钥解密。</li><li>公钥和私钥不同。</li><li>公钥可以公布给所有人。</li><li>私钥只有自己保存。</li><li>相比于对称加密，运算速度非常慢。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./非对称加密.png width=280 /> <p>  对称加密和非对称加密结合使用的案例。小明要给小红传输机密文件，他俩先交换各自的公钥，然后：</p><ol><li>小明生成一个随机的AES口令，然后用小红的公钥通过RSA加密这个口令，并发给小红。</li><li>小红用自己的RSA私钥解密得到AES口令。</li><li>双方使用这个共享的AES口令用AES加密通信。</li></ol><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./加密通信.png width=500 />   <p>  RSA是三个发明人名字的缩写：Ron Rivest，Adi Shamir，Leonard Adleman。密钥越长，越难破解。 目前768位的密钥还无法破解（至少没人公开宣布）。因此可以认为1024位的RSA密钥基本安全，2048位的密钥极其安全。RSA的算法原理主要用到了数论。<br>RSA加密过程</p><ol><li>随机选择两个不相等的质数p和q。p=61, q=53</li><li>计算p和q的乘积n。n=3233</li><li>计算n的欧拉函数φ(n) = (p-1)(q-1)。 φ(n) =3120</li><li>随机选择一个整数e，使得1&lt; e &lt; φ(n)，且e与φ(n) 互质。e=17</li><li>计算e对于φ(n)的模反元素d，即求解e*d+ φ(n)*y=1。d=2753, y=-15</li><li>将n和e封装成公钥，n和d封装成私钥。公钥=(3233，17)，公钥=(3233，2753)</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RSA加密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RsaEncrypt</span><span class="params">(origData []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">//解密pem格式的公钥</span></span><br><span class="line">block, _ := pem.Decode(publicKey)</span><br><span class="line"><span class="keyword">if</span> block == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;public key error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解析公钥</span></span><br><span class="line">pubInterface, err := x509.ParsePKIXPublicKey(block.Bytes) <span class="comment">//目前的数字证书一般都是基于ITU（国际电信联盟）制定的X.509标准</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 类型断言</span></span><br><span class="line">pub := pubInterface.(*rsa.PublicKey)</span><br><span class="line"><span class="comment">//加密</span></span><br><span class="line"><span class="keyword">return</span> rsa.EncryptPKCS1v15(rand.Reader, pub, origData)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RSA解密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RsaDecrypt</span><span class="params">(ciphertext []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">//解密</span></span><br><span class="line">block, _ := pem.Decode(privateKey)</span><br><span class="line"><span class="keyword">if</span> block == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;private key error!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析PKCS1格式的私钥</span></span><br><span class="line">priv, err := x509.ParsePKCS1PrivateKey(block.Bytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解密</span></span><br><span class="line"><span class="keyword">return</span> rsa.DecryptPKCS1v15(rand.Reader, priv, ciphertext)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  ECC（Elliptic Curve Cryptography）椭圆曲线加密算法，相比RSA，ECC可以使用更短的密钥，来实现与RSA相当或更高的安全。定义了椭圆曲线上的加法和二倍运算。椭圆曲线依赖的数学难题是：k为正整数，P是椭圆曲线上的点（称为基点）, k*P=Q , 已知Q和P，很难计算出k。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genPrivateKey</span><span class="params">()</span></span> (*ecies.PrivateKey, <span class="type">error</span>) &#123;</span><br><span class="line">pubkeyCurve := elliptic.P256() <span class="comment">// 初始化椭圆曲线</span></span><br><span class="line"><span class="comment">// 随机挑选基点,生成私钥</span></span><br><span class="line">p, err := ecdsa.GenerateKey(pubkeyCurve, rand.Reader) <span class="comment">//用golang标准库生成公私钥对</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ecies.ImportECDSA(p), <span class="literal">nil</span> <span class="comment">//转换成以太坊的公私钥对</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ECCEncrypt 椭圆曲线加密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ECCEncrypt</span><span class="params">(plain <span class="type">string</span>, pubKey *ecies.PublicKey)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src := []<span class="type">byte</span>(plain)</span><br><span class="line"><span class="keyword">return</span> ecies.Encrypt(rand.Reader, pubKey, src, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ECCDecrypt 椭圆曲线解密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ECCDecrypt</span><span class="params">(cipher []<span class="type">byte</span>, prvKey *ecies.PrivateKey)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> src, err := prvKey.Decrypt(cipher, <span class="literal">nil</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(src), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="哈希算法">哈希算法</h2><p>哈希函数的基本特征</p><ol><li>输入可以是任意长度。</li><li>输出是固定长度。</li><li>根据输入很容易计算出输出。</li><li>根据输出很难计算出输入（几乎不可能）。</li><li>两个不同的输入几乎不可能得到相同的输出。</li></ol><p>  SHA（Secure Hash Algorithm） 安全散列算法，是一系列密码散列函数，有多个不同安全等级的版本：SHA-1,SHA-224,SHA-256,SHA-384,SHA-512。其作用是防伪装，防窜扰，保证信息的合法性和完整性。<br>sha-1算法大致过程</p><ol><li>填充。使得数据长度对512求余的结果为448。</li><li>在信息摘要后面附加64bit，表示原始信息摘要的长度。</li><li>初始化h0到h4，每个h都是32位。</li><li>h0到h4历经80轮复杂的变换。</li><li>把h0到h4拼接起来，构成160位，返回。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sha1</span><span class="params">(data <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">sha1 := sha1.New()</span><br><span class="line">sha1.Write([]<span class="type">byte</span>(data))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(sha1.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  MD5（Message-Digest Algorithm 5）信息-摘要算法5，算法流程跟SHA-1大体相似。MD5的输出是128位，比SHA-1短了32位。MD5相对易受密码分析的攻击，运算速度比SHA-1快。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Md5</span><span class="params">(data <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">md5 := md5.New()</span><br><span class="line">md5.Write([]<span class="type">byte</span>(data))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(md5.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>哈希函数的应用场景</p><ul><li>用户密码的存储。</li><li>文件上传/下载完整性校验。</li><li>mysql大字段的快速对比。<br>数字签名</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./数字签名.png width=550 />   <p>  比特币中验证交易记录的真实性用的就是数字签名。先hash再用私钥加密的原因是：非对称加密计算量比较大，先hash可以把原始数据转一条很短的信息，提高计算效率。</p><h2 id="案例-3">案例</h2><h3 id="对称加密AES">对称加密AES</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/aes&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ZeroPadding</span><span class="params">(ciphertext []<span class="type">byte</span>, blockSize <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">padding := blockSize - <span class="built_in">len</span>(ciphertext)%blockSize</span><br><span class="line">padtext := bytes.Repeat([]<span class="type">byte</span>&#123;<span class="number">0</span>&#125;, padding) <span class="comment">//用0填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">append</span>(ciphertext, padtext...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZeroUnPadding 这种方法不严谨，末尾的0不一定全是padding出来的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ZeroUnPadding</span><span class="params">(origData []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line"><span class="keyword">return</span> bytes.TrimFunc(origData,</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(r <span class="type">rune</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r == <span class="type">rune</span>(<span class="number">0</span>) <span class="comment">//截掉尾部连续的0</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AesEncrypt</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">blockSize := aes.BlockSize <span class="comment">//AES的分组大小为16</span></span><br><span class="line">src := []<span class="type">byte</span>(text)</span><br><span class="line">src = ZeroPadding(src, blockSize) <span class="comment">//填充</span></span><br><span class="line">encrypted := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))</span><br><span class="line">block, err := aes.NewCipher(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">encrypter := cipher.NewCBCEncrypter(block, key) <span class="comment">//CBC分组模式加密</span></span><br><span class="line">encrypter.CryptBlocks(encrypted, src)</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(encrypted), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AesDecrypt</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src, err := hex.DecodeString(text) <span class="comment">//转为[]byte</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">decrypted := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))</span><br><span class="line">block, err := aes.NewCipher(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">edecrypter := cipher.NewCBCDecrypter(block, key) <span class="comment">//CBC分组模式解密</span></span><br><span class="line">edecrypter.CryptBlocks(decrypted, src)</span><br><span class="line">out := ZeroUnPadding(decrypted) <span class="comment">//反填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">key := []<span class="type">byte</span>(<span class="string">&quot;ir489u58ir489u54&quot;</span>) <span class="comment">//key必须是长度为16的byte数组</span></span><br><span class="line">plain := <span class="string">&quot;因为我们没有什么不同&quot;</span></span><br><span class="line">cipher, err := AesEncrypt(plain, key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;密文：%s\n&quot;</span>, cipher)</span><br><span class="line"></span><br><span class="line">plain, err = AesDecrypt(cipher, key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;明文：%s\n&quot;</span>, plain)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>密文：854deaf62920930fa266eff575fb8fdd8d1473a3ebe345a3ebf87fd4232c1a2f<br>明文：因为我们没有什么不同</p><h3 id="对称加密DES">对称加密DES</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/des&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ZeroPadding</span><span class="params">(ciphertext []<span class="type">byte</span>, blockSize <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">padding := blockSize - <span class="built_in">len</span>(ciphertext)%blockSize</span><br><span class="line">padtext := bytes.Repeat([]<span class="type">byte</span>&#123;<span class="number">0</span>&#125;, padding) <span class="comment">//用0填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">append</span>(ciphertext, padtext...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZeroUnPadding 这种方法不严谨，末尾的0不一定全是padding出来的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ZeroUnPadding</span><span class="params">(origData []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line"><span class="keyword">return</span> bytes.TrimFunc(origData,</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(r <span class="type">rune</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r == <span class="type">rune</span>(<span class="number">0</span>) <span class="comment">//截掉尾部连续的0</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DesEncrypt DES加密</span></span><br><span class="line"><span class="comment">// 密钥必须是64位，所以key必须是长度为8的byte数组</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesEncrypt</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src := []<span class="type">byte</span>(text)</span><br><span class="line">block, err := des.NewCipher(key) <span class="comment">//用des创建一个加密器cipher</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">blockSize := block.BlockSize()    <span class="comment">//分组的大小，blockSize=8</span></span><br><span class="line">src = ZeroPadding(src, blockSize) <span class="comment">//填充</span></span><br><span class="line"></span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src)) <span class="comment">//密文和明文的长度一致</span></span><br><span class="line">dst := out</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">len</span>(src) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">//分组加密</span></span><br><span class="line">block.Encrypt(dst, src[:blockSize]) <span class="comment">//对src进行加密，加密结果放到dst里</span></span><br><span class="line"><span class="comment">//移到下一组</span></span><br><span class="line">src = src[blockSize:]</span><br><span class="line">dst = dst[blockSize:]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DesDecrypt DES解密</span></span><br><span class="line"><span class="comment">// 密钥必须是64位，所以key必须是长度为8的byte数组</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesDecrypt</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src, err := hex.DecodeString(text) <span class="comment">//转成[]byte</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">block, err := des.NewCipher(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blockSize := block.BlockSize()</span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))</span><br><span class="line">dst := out</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">len</span>(src) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">//分组解密</span></span><br><span class="line">block.Decrypt(dst, src[:blockSize])</span><br><span class="line">src = src[blockSize:]</span><br><span class="line">dst = dst[blockSize:]</span><br><span class="line">&#125;</span><br><span class="line">out = ZeroUnPadding(out) <span class="comment">//反填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesEncryptCBC</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src := []<span class="type">byte</span>(text)</span><br><span class="line">block, err := des.NewCipher(key) <span class="comment">//用des创建一个加密器cipher</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">blockSize := block.BlockSize()    <span class="comment">//分组的大小，blockSize=8</span></span><br><span class="line">src = ZeroPadding(src, blockSize) <span class="comment">//填充</span></span><br><span class="line"></span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))                   <span class="comment">//密文和明文的长度一致</span></span><br><span class="line">encrypter := cipher.NewCBCEncrypter(block, key) <span class="comment">//CBC分组模式加密</span></span><br><span class="line">encrypter.CryptBlocks(out, src)</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DesDecryptCBC</span><span class="params">(text <span class="type">string</span>, key []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src, err := hex.DecodeString(text) <span class="comment">//转成[]byte</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line">block, err := des.NewCipher(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(src))                   <span class="comment">//密文和明文的长度一致</span></span><br><span class="line">encrypter := cipher.NewCBCDecrypter(block, key) <span class="comment">//CBC分组模式解密</span></span><br><span class="line">encrypter.CryptBlocks(out, src)</span><br><span class="line">out = ZeroUnPadding(out) <span class="comment">//反填充</span></span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(out), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">key := []<span class="type">byte</span>(<span class="string">&quot;ir489u58&quot;</span>) <span class="comment">//key必须是长度为8的byte数组</span></span><br><span class="line">plain := <span class="string">&quot;因为我们没有什么不同&quot;</span></span><br><span class="line">cipher, err := DesEncrypt(plain, key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;密文：%s\n&quot;</span>, cipher)</span><br><span class="line"></span><br><span class="line">plain, err = DesDecrypt(cipher, key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;明文：%s\n&quot;</span>, plain)</span><br><span class="line">fmt.Println(<span class="string">&quot;-------------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">cipher, _ = DesEncryptCBC(plain, key)</span><br><span class="line">fmt.Printf(<span class="string">&quot;密文：%s\n&quot;</span>, cipher)</span><br><span class="line">plain, err = DesDecryptCBC(cipher, key)</span><br><span class="line">fmt.Printf(<span class="string">&quot;明文：%s\n&quot;</span>, plain)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>密文：5dc1bc67723d97493e27e5f4993c5a8f743179e15671e34a63067838ce25311f<br>明文：因为我们没有什么不同<br>-------------------------------------<br>密文：3323587cb8e1c03f524cd87fbb0c2585fc71c713f5416cc9ae1ee3ca1350b28d<br>明文：因为我们没有什么不同</p><h3 id="非对称加密ECC">非对称加密ECC</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/ethereum/go-ethereum/crypto/ecies&quot;</span> <span class="comment">//以太坊加密库，要求go版本升级到1.15</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genPrivateKey</span><span class="params">()</span></span> (*ecies.PrivateKey, <span class="type">error</span>) &#123;</span><br><span class="line">pubkeyCurve := elliptic.P256() <span class="comment">// 初始化椭圆曲线</span></span><br><span class="line"><span class="comment">// 随机挑选基点,生成私钥</span></span><br><span class="line">p, err := ecdsa.GenerateKey(pubkeyCurve, rand.Reader) <span class="comment">//用golang标准库生成公私钥对</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ecies.ImportECDSA(p), <span class="literal">nil</span> <span class="comment">//转换成以太坊的公私钥对</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ECCEncrypt 椭圆曲线加密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ECCEncrypt</span><span class="params">(plain <span class="type">string</span>, pubKey *ecies.PublicKey)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">src := []<span class="type">byte</span>(plain)</span><br><span class="line"><span class="keyword">return</span> ecies.Encrypt(rand.Reader, pubKey, src, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ECCDecrypt 椭圆曲线解密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ECCDecrypt</span><span class="params">(cipher []<span class="type">byte</span>, prvKey *ecies.PrivateKey)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> src, err := prvKey.Decrypt(cipher, <span class="literal">nil</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="type">string</span>(src), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">prvKey, err := genPrivateKey()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">pubKey := prvKey.PublicKey</span><br><span class="line">plain := <span class="string">&quot;因为我们没有什么不同&quot;</span></span><br><span class="line">cipher, err := ECCEncrypt(plain, &amp;pubKey)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">plain, err = ECCDecrypt(cipher, prvKey)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;明文：%s\n&quot;</span>, plain)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="非对称加密RSA">非对称加密RSA</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/rsa&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/pem&quot;</span></span><br><span class="line"><span class="string">&quot;errors&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">生成1024位的RSA私钥：</span></span><br><span class="line"><span class="comment">openssl genrsa -out data/rsa_private_key.pem 1024</span></span><br><span class="line"><span class="comment">根据私钥生成公钥：</span></span><br><span class="line"><span class="comment">openssl rsa -in data/rsa_private_key.pem -pubout -out data/rsa_public_key.pem</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">pem是一种标准格式，它通常包含页眉和页脚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">publicKey  []<span class="type">byte</span></span><br><span class="line">privateKey []<span class="type">byte</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(keyFile <span class="type">string</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> f, err := os.Open(keyFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">content := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line"><span class="keyword">if</span> n, err := f.Read(content); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> content[:n], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadRSAKey</span><span class="params">(publicKeyFile, privateKeyFile <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> publicKey, err = ReadFile(publicKeyFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> privateKey, err = ReadFile(privateKeyFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RSA加密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RsaEncrypt</span><span class="params">(origData []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">//解密pem格式的公钥</span></span><br><span class="line">block, _ := pem.Decode(publicKey)</span><br><span class="line"><span class="keyword">if</span> block == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;public key error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解析公钥</span></span><br><span class="line">pubInterface, err := x509.ParsePKIXPublicKey(block.Bytes) <span class="comment">//目前的数字证书一般都是基于ITU（国际电信联盟）制定的X.509标准</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 类型断言</span></span><br><span class="line">pub := pubInterface.(*rsa.PublicKey)</span><br><span class="line"><span class="comment">//加密</span></span><br><span class="line"><span class="keyword">return</span> rsa.EncryptPKCS1v15(rand.Reader, pub, origData)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RSA解密</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RsaDecrypt</span><span class="params">(ciphertext []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">//解密</span></span><br><span class="line">block, _ := pem.Decode(privateKey)</span><br><span class="line"><span class="keyword">if</span> block == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;private key error!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析PKCS1格式的私钥</span></span><br><span class="line">priv, err := x509.ParsePKCS1PrivateKey(block.Bytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解密</span></span><br><span class="line"><span class="keyword">return</span> rsa.DecryptPKCS1v15(rand.Reader, priv, ciphertext)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ReadRSAKey(<span class="string">&quot;D:\\rsa_public_key.pem&quot;</span>, <span class="string">&quot;D:\\rsa_private_key.pem&quot;</span>)</span><br><span class="line"></span><br><span class="line">plain := <span class="string">&quot;因为我们没有什么不同&quot;</span></span><br><span class="line">cipher, _ := RsaEncrypt([]<span class="type">byte</span>(plain))</span><br><span class="line">fmt.Printf(<span class="string">&quot;密文：%s\n&quot;</span>, hex.EncodeToString(cipher))</span><br><span class="line">bPlain, _ := RsaDecrypt(cipher)</span><br><span class="line">fmt.Printf(<span class="string">&quot;明文：%s\n&quot;</span>, <span class="type">string</span>(bPlain))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>密文：03eb4e1a6b1444d5996d06e106f126ccb7803a3f3fb4d6ba7751734e410136cc442603b6adcdfaeef2bd7309931fc9f05a404c14ae31fffee7e48808e8b112d630568bbc39ccd5d799f0dfc6e021592c01ed8fac9b618030491813620fe69c891946b21e1dafcd4d8ca3897f6436a85f5548c8bf9e49ef2f13a70f8c0118efeb<br>明文：因为我们没有什么不同</p><h3 id="数字签名验证">数字签名验证</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/rsa&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha1&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/pem&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(keyFile <span class="type">string</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> f, err := os.Open(keyFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">content := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line"><span class="keyword">if</span> n, err := f.Read(content); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> content[:n], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// go标准库不支持私钥加密，但直接提供了签名函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DigitalSignature</span><span class="params">(trade <span class="type">string</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">sha1 := sha1.New()</span><br><span class="line">sha1.Write([]<span class="type">byte</span>(trade))</span><br><span class="line">digest := sha1.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line">privateKey, _ := ReadFile(<span class="string">&quot;D:\\rsa_private_key.pem&quot;</span>)</span><br><span class="line">block, _ := pem.Decode(privateKey)</span><br><span class="line">priv, _ := x509.ParsePKCS1PrivateKey(block.Bytes)</span><br><span class="line"><span class="comment">//用私钥生成签名</span></span><br><span class="line">signature, _ := rsa.SignPKCS1v15(<span class="literal">nil</span>, priv, crypto.Hash(<span class="number">0</span>), digest)</span><br><span class="line"><span class="keyword">return</span> signature</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证数字签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">VerifySignature</span><span class="params">(trade <span class="type">string</span>, signature []<span class="type">byte</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">sha1 := sha1.New()</span><br><span class="line">sha1.Write([]<span class="type">byte</span>(trade))</span><br><span class="line">digest := sha1.Sum([]<span class="type">byte</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line">publicKey, _ := ReadFile(<span class="string">&quot;D:\\rsa_public_key.pem&quot;</span>)</span><br><span class="line">block, _ := pem.Decode(publicKey)</span><br><span class="line">pubInterface, _ := x509.ParsePKIXPublicKey(block.Bytes)</span><br><span class="line">pub := pubInterface.(*rsa.PublicKey)</span><br><span class="line"></span><br><span class="line"><span class="comment">//用公钥验证签名</span></span><br><span class="line"><span class="keyword">return</span> rsa.VerifyPKCS1v15(pub, crypto.Hash(<span class="number">0</span>), digest, signature) == <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">trade := <span class="string">&quot;zhangsan transfer 10 BTC to lisi&quot;</span></span><br><span class="line">signature := DigitalSignature(trade)</span><br><span class="line">fmt.Println(<span class="string">&quot;验证数字签名&quot;</span>, VerifySignature(trade, signature))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>验证数字签名 true</p><h3 id="哈希">哈希</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha1&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sha1</span><span class="params">(data []<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">sha1 := sha1.New()</span><br><span class="line">sha1.Write(data)</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(sha1.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Md5</span><span class="params">(data []<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">md5 := md5.New()</span><br><span class="line">md5.Write(data)</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(md5.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">data := <span class="string">&quot;因为我们没有什么不同&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;SHA-1: %s\n&quot;</span>, Sha1([]<span class="type">byte</span>(data)))</span><br><span class="line">fmt.Printf(<span class="string">&quot;MD5: %s\n&quot;</span>, Md5([]<span class="type">byte</span>(data)))</span><br><span class="line"></span><br><span class="line">f, err := os.Open(<span class="string">&quot;go.sum&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">r := bufio.NewReader(f)</span><br><span class="line">b, err2 := ioutil.ReadAll(r)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Sha1(b): %v\n&quot;</span>, Sha1(b))</span><br><span class="line">fmt.Printf(<span class="string">&quot;Md5(b): %v\n&quot;</span>, Md5(b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>SHA-1: 0cfea402af137e3793a6c8a80152b5ab74ba380b<br>MD5: 78cfcd6021c4f04e7e709cb8148aa4dd<br>Sha1(b): 4c8180f36e736ae3158767fc2a9f959bb3c86448<br>Md5(b): c82232187701537f2dd16d5ca836be72</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang反射</title>
      <link href="/20221230/golang-20221230-golang%E5%8F%8D%E5%B0%84/"/>
      <url>/20221230/golang-20221230-golang%E5%8F%8D%E5%B0%84/</url>
      
        <content type="html"><![CDATA[<h2 id="反射介绍">反射介绍</h2><p>  反射就是在运行期间（不是编译期间）探知对象的类型信息和内存结构、更新变量、调用它们的方法。<br>  反射的使用场景：</p><ul><li>函数的参数类型是interface{}，需要在运行时对原始类型进行判断，针对不同的类型采取不同的处理方式。比如json.Marshal(v interface{})。</li><li>在运行时根据某些条件动态决定调用哪个函数，比如根据配置文件执行相应的算子函数。</li></ul><p>  Go标准库里的json序列化就使用了反射。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age <span class="type">int</span></span><br><span class="line">    Sex <span class="type">byte</span> <span class="string">`json:&quot;gender&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line">user := User&#123;</span><br><span class="line">    Name: <span class="string">&quot;钱钟书&quot;</span>,</span><br><span class="line">    Age: <span class="number">57</span>,</span><br><span class="line">    Sex: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line">json.Marshal(user)  <span class="comment">//返回 &#123;&quot;Name&quot;:&quot;钱钟书&quot;,&quot;Age&quot;:57,&quot;gender&quot;:1&#125;</span></span><br></pre></td></tr></table></figure><p>  反射的弊端：</p><ul><li>代码难以阅读，难以维护。</li><li>编译期间不能发现类型错误，覆盖测试难度很大，有些bug需要到线上运行很长时间才能发现，可能会造成严重用后果。</li><li>反射性能很差，通常比正常代码慢一到两个数量级。在对性能要求很高，或大量反复调用的代码块里建议不要使用反射。</li></ul><h2 id="反射的基础数据类型">反射的基础数据类型</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./reflect.png width=750 />  <p>  reflect.Type用于获取类型相关的信息。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Type <span class="keyword">interface</span> &#123;</span><br><span class="line">Method(<span class="type">int</span>) Method  <span class="comment">//第i个方法</span></span><br><span class="line">MethodByName(<span class="type">string</span>) (Method, <span class="type">bool</span>) <span class="comment">//根据名称获取方法</span></span><br><span class="line">NumMethod() <span class="type">int</span>  <span class="comment">//方法的个数</span></span><br><span class="line">Name() <span class="type">string</span>   <span class="comment">//获取结构体名称</span></span><br><span class="line">PkgPath() <span class="type">string</span> <span class="comment">//包路径</span></span><br><span class="line">Size() <span class="type">uintptr</span>  <span class="comment">//占用内存的大小</span></span><br><span class="line">String() <span class="type">string</span>  <span class="comment">//获取字符串表述</span></span><br><span class="line">Kind() Kind  <span class="comment">//数据类型</span></span><br><span class="line">Implements(u Type) <span class="type">bool</span>  <span class="comment">//判断是否实现了某接口</span></span><br><span class="line">AssignableTo(u Type) <span class="type">bool</span>  <span class="comment">//能否赋给另外一种类型</span></span><br><span class="line">ConvertibleTo(u Type) <span class="type">bool</span>  <span class="comment">//能否转换为另外一种类型</span></span><br><span class="line">Elem() Type  <span class="comment">//解析指针</span></span><br><span class="line">Field(i <span class="type">int</span>) StructField  <span class="comment">//第i个成员</span></span><br><span class="line">FieldByIndex(index []<span class="type">int</span>) StructField  <span class="comment">//根据index路径获取嵌套成员</span></span><br><span class="line">FieldByName(name <span class="type">string</span>) (StructField, <span class="type">bool</span>)  <span class="comment">//根据名称获取成员</span></span><br><span class="line">FieldByNameFunc(match <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">bool</span>) (StructField, <span class="type">bool</span>)  <span class="comment">//</span></span><br><span class="line">Len() <span class="type">int</span>  <span class="comment">//容器的长度</span></span><br><span class="line">NumIn() <span class="type">int</span>  <span class="comment">//输出参数的个数</span></span><br><span class="line">NumOut() <span class="type">int</span>  <span class="comment">//返回参数的个数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  通过reflect.Value获取、修改原始数据类型里的值。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Value <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// 代表的数据类型</span></span><br><span class="line">typ *rtype</span><br><span class="line"><span class="comment">// 指向原始数据的指针</span></span><br><span class="line">ptr unsafe.Pointer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="反射API">反射API</h2><h3 id="reflect-Type">reflect.Type</h3><h4 id="如何得到Type">如何得到Type</h4><p>通过TypeOf()得到Type类型。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typeI := reflect.TypeOf(<span class="number">1</span>)       </span><br><span class="line">typeS := reflect.TypeOf(<span class="string">&quot;hello&quot;</span>) </span><br><span class="line">fmt.Println(typeI)               <span class="comment">//int</span></span><br><span class="line">fmt.Println(typeS)               <span class="comment">//string</span></span><br><span class="line"></span><br><span class="line">typeUser := reflect.TypeOf(&amp;common.User&#123;&#125;) </span><br><span class="line">fmt.Println(typeUser)                     <span class="comment">//*common.User</span></span><br><span class="line">fmt.Println(typeUser.Kind())                 <span class="comment">//ptr</span></span><br><span class="line">fmt.Println(typeUser.Elem().Kind())    <span class="comment">//struct</span></span><br></pre></td></tr></table></figure><h4 id="指针Type转为非指针Type">指针Type转为非指针Type</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typeUser := reflect.TypeOf(&amp;common.User&#123;&#125;) </span><br><span class="line">typeUser2 := reflect.TypeOf(common.User&#123;&#125;)</span><br><span class="line">assert.IsEqual(typeUser.Elem(), typeUser2)</span><br></pre></td></tr></table></figure><h4 id="获取struct成员变量的信息">获取struct成员变量的信息</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typeUser := reflect.TypeOf(common.User&#123;&#125;) <span class="comment">//需要用struct的Type，不能用指针的Type</span></span><br><span class="line">fieldNum := typeUser.NumField()           <span class="comment">//成员变量的个数</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; fieldNum; i++ &#123;</span><br><span class="line">field := typeUser.Field(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d %s offset %d anonymous %t type %s exported %t json tag %s\n&quot;</span>, i,</span><br><span class="line">field.Name,            <span class="comment">//变量名称</span></span><br><span class="line">field.Offset,          <span class="comment">//相对于结构体首地址的内存偏移量，string类型会占据16个字节</span></span><br><span class="line">field.Anonymous,       <span class="comment">//是否为匿名成员</span></span><br><span class="line">field.Type,            <span class="comment">//数据类型，reflect.Type类型</span></span><br><span class="line">field.IsExported(),    <span class="comment">//包外是否可见（即是否以大写字母开头）</span></span><br><span class="line">field.Tag.Get(<span class="string">&quot;json&quot;</span>)) <span class="comment">//获取成员变量后面``里面定义的tag</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以通过FieldByName获取Field</span></span><br><span class="line"><span class="keyword">if</span> nameField, ok := typeUser.FieldByName(<span class="string">&quot;Name&quot;</span>); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Name is exported %t\n&quot;</span>, nameField.IsExported())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//也可以根据FieldByIndex获取Field</span></span><br><span class="line">thirdField := typeUser.FieldByIndex([]<span class="type">int</span>&#123;<span class="number">2</span>&#125;) <span class="comment">//参数是个slice，因为有struct嵌套的情况</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;third field name %s\n&quot;</span>, thirdField.Name)</span><br></pre></td></tr></table></figure><h4 id="获取struct成员方法的信息">获取struct成员方法的信息</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">typeUser := reflect.TypeOf(common.User&#123;&#125;)</span><br><span class="line">methodNum := typeUser.NumMethod() <span class="comment">//成员方法的个数。接收者为指针的方法【不】包含在内</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; methodNum; i++ &#123;</span><br><span class="line">method := typeUser.Method(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;method name:%s ,type:%s, exported:%t\n&quot;</span>, method.Name, method.Type, method.IsExported())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line">typeUser2 := reflect.TypeOf(&amp;common.User&#123;&#125;)</span><br><span class="line">methodNum = typeUser2.NumMethod() <span class="comment">//成员方法的个数。接收者为指针或值的方法【都】包含在内，也就是说值实现的方法指针也实现了（反之不成立）</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; methodNum; i++ &#123;</span><br><span class="line">method := typeUser2.Method(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;method name:%s ,type:%s, exported:%t\n&quot;</span>, method.Name, method.Type, method.IsExported())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="获取函数的信息">获取函数的信息</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typeFunc := reflect.TypeOf(Add) <span class="comment">//获取函数类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;is function type %t\n&quot;</span>, typeFunc.Kind() == reflect.Func)</span><br><span class="line">argInNum := typeFunc.NumIn()   <span class="comment">//输入参数的个数</span></span><br><span class="line">argOutNum := typeFunc.NumOut() <span class="comment">//输出参数的个数</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; argInNum; i++ &#123;</span><br><span class="line">argTyp := typeFunc.In(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;第%d个输入参数的类型%s\n&quot;</span>, i, argTyp)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; argOutNum; i++ &#123;</span><br><span class="line">argTyp := typeFunc.Out(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;第%d个输出参数的类型%s\n&quot;</span>, i, argTyp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="判断类型是否实现了某接口">判断类型是否实现了某接口</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过reflect.TypeOf((*&lt;interface&gt;)(nil)).Elem()获得接口类型。因为People是个接口不能创建实例，所以把nil强制转为*common.People类型</span></span><br><span class="line">typeOfPeople := reflect.TypeOf((*common.People)(<span class="literal">nil</span>)).Elem()</span><br><span class="line">fmt.Printf(<span class="string">&quot;typeOfPeople kind is interface %t\n&quot;</span>, typeOfPeople.Kind() == reflect.Interface)</span><br><span class="line">t1 := reflect.TypeOf(common.User&#123;&#125;)</span><br><span class="line">t2 := reflect.TypeOf(&amp;common.User&#123;&#125;)</span><br><span class="line"><span class="comment">//如果值类型实现了接口，则指针类型也实现了接口；反之不成立</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;t1 implements People interface %t\n&quot;</span>, t1.Implements(typeOfPeople))</span><br></pre></td></tr></table></figure><h3 id="reflect-Value">reflect.Value</h3><h4 id="如果获得Value">如果获得Value</h4><p>通过ValueOf()得到Value。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iValue := reflect.ValueOf(<span class="number">1</span>)</span><br><span class="line">sValue := reflect.ValueOf(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">userPtrValue := reflect.ValueOf(&amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;)</span><br><span class="line">fmt.Println(iValue)       <span class="comment">//1</span></span><br><span class="line">fmt.Println(sValue)       <span class="comment">//hello</span></span><br><span class="line">fmt.Println(userPtrValue) <span class="comment">//&amp;&#123;7 杰克逊  65 1.68&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Value转为Type">Value转为Type</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iType := iValue.Type()</span><br><span class="line">sType := sValue.Type()</span><br><span class="line">userType := userPtrValue.Type()</span><br><span class="line"><span class="comment">//在Type和相应Value上调用Kind()结果一样的</span></span><br><span class="line">fmt.Println(iType.Kind() == reflect.Int, iValue.Kind() == reflect.Int, iType.Kind() == iValue.Kind())  </span><br><span class="line">fmt.Println(sType.Kind() == reflect.String, sValue.Kind() == reflect.String, sType.Kind() == sValue.Kind()) </span><br><span class="line">fmt.Println(userType.Kind() == reflect.Ptr, userPtrValue.Kind() == reflect.Ptr, userType.Kind() == userPtrValue.Kind())</span><br></pre></td></tr></table></figure><h4 id="指针Value和非指针Value互相转换">指针Value和非指针Value互相转换</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">userValue := userPtrValue.Elem()                    <span class="comment">//Elem() 指针Value转为非指针Value</span></span><br><span class="line">fmt.Println(userValue.Kind(), userPtrValue.Kind())  <span class="comment">//struct ptr</span></span><br><span class="line">userPtrValue3 := userValue.Addr()                   <span class="comment">//Addr() 非指针Value转为指针Value</span></span><br><span class="line">fmt.Println(userValue.Kind(), userPtrValue3.Kind()) <span class="comment">//struct ptr</span></span><br></pre></td></tr></table></figure><h4 id="得到Value对应的原始数据">得到Value对应的原始数据</h4><p>通过Interface()函数把Value转为interface{}，再从interface{}强制类型转换，转为原始数据类型。或者在Value上直接调用Int()、String()等一步到位。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;origin value iValue is %d %d\n&quot;</span>, iValue.Interface().(<span class="type">int</span>), iValue.Int())</span><br><span class="line">fmt.Printf(<span class="string">&quot;origin value sValue is %s %s\n&quot;</span>, sValue.Interface().(<span class="type">string</span>), sValue.String())</span><br><span class="line">user := userValue.Interface().(common.User)</span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d name=%s weight=%.2f height=%.2f\n&quot;</span>, user.Id, user.Name, user.Weight, user.Height)</span><br><span class="line">user2 := userPtrValue.Interface().(*common.User)</span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d name=%s weight=%.2f height=%.2f\n&quot;</span>, user2.Id, user2.Name, user2.Weight, user2.Height)</span><br></pre></td></tr></table></figure><h4 id="空Value的判断">空Value的判断</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125; <span class="comment">//接口没有指向具体的值</span></span><br><span class="line">v := reflect.ValueOf(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;v持有值 %t, type of v is Invalid %t\n&quot;</span>, v.IsValid(), v.Kind() == reflect.Invalid)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> user *common.User = <span class="literal">nil</span></span><br><span class="line">v = reflect.ValueOf(user) <span class="comment">//Value指向一个nil</span></span><br><span class="line"><span class="keyword">if</span> v.IsValid() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;v持有的值是nil %t\n&quot;</span>, v.IsNil()) <span class="comment">//调用IsNil()前先确保IsValid()，否则会panic</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> u common.User <span class="comment">//只声明，里面的值都是0值</span></span><br><span class="line">v = reflect.ValueOf(u)</span><br><span class="line"><span class="keyword">if</span> v.IsValid() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;v持有的值是对应类型的0值 %t\n&quot;</span>, v.IsZero()) <span class="comment">//调用IsZero()前先确保IsValid()，否则会panic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="通过Value修改原始数据的值">通过Value修改原始数据的值</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">10</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span> = <span class="string">&quot;hello&quot;</span></span><br><span class="line">user := common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">valueI := reflect.ValueOf(&amp;i) <span class="comment">//由于go语言所有函数传的都是值，所以要想修改原来的值就需要传指针</span></span><br><span class="line">valueS := reflect.ValueOf(&amp;s)</span><br><span class="line">valueUser := reflect.ValueOf(&amp;user)</span><br><span class="line">valueI.Elem().SetInt(<span class="number">8</span>) <span class="comment">//由于valueI对应的原始对象是指针，通过Elem()返回指针指向的对象</span></span><br><span class="line">valueS.Elem().SetString(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">valueUser.Elem().FieldByName(<span class="string">&quot;Weight&quot;</span>).SetFloat(<span class="number">68.0</span>) <span class="comment">//FieldByName()通过Name返回类的成员变量</span></span><br></pre></td></tr></table></figure><p>强调一下，要想修改原始数据的值，给ValueOf传的必须是指针，而指针Value不能调用Set和FieldByName方法，所以得先通过Elem()转为非指针Value。<br>未导出成员的值不能通过反射进行修改。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">addrValue := valueUser.Elem().FieldByName(<span class="string">&quot;addr&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> addrValue.CanSet() &#123;</span><br><span class="line">addrValue.SetString(<span class="string">&quot;北京&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;addr是未导出成员，不可Set&quot;</span>) <span class="comment">//以小写字母开头的成员相当于是私有成员</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="通过Value修改Slice">通过Value修改Slice</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">users := <span class="built_in">make</span>([]*common.User, <span class="number">1</span>, <span class="number">5</span>) <span class="comment">//len=1，cap=5</span></span><br><span class="line">users[<span class="number">0</span>] = &amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sliceValue := reflect.ValueOf(&amp;users) <span class="comment">//准备通过Value修改users，所以传users的地址</span></span><br><span class="line"><span class="keyword">if</span> sliceValue.Elem().Len() &gt; <span class="number">0</span> &#123;      <span class="comment">//取得slice的长度</span></span><br><span class="line">sliceValue.Elem().Index(<span class="number">0</span>).Elem().FieldByName(<span class="string">&quot;Name&quot;</span>).SetString(<span class="string">&quot;令狐一刀&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;1st user name change to %s\n&quot;</span>, users[<span class="number">0</span>].Name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>甚至可以修改slice的cap，新的cap必须位于原始的len到cap之间，即只能把cap改小。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sliceValue.Elem().SetCap(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>通过把len改大，可以实现向slice中追加元素的功能。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sliceValue.Elem().SetLen(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//调用reflect.Value的Set()函数修改其底层指向的原始数据</span></span><br><span class="line">sliceValue.Elem().Index(<span class="number">1</span>).Set(reflect.ValueOf(&amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">8</span>,</span><br><span class="line">Name:   <span class="string">&quot;李达&quot;</span>,</span><br><span class="line">Weight: <span class="number">80</span>,</span><br><span class="line">Height: <span class="number">180</span>,</span><br><span class="line">&#125;))</span><br><span class="line">fmt.Printf(<span class="string">&quot;2nd user name %s\n&quot;</span>, users[<span class="number">1</span>].Name)</span><br></pre></td></tr></table></figure><h4 id="修改map">修改map</h4><p>Value.SetMapIndex()函数：往map里添加一个key-value对。<br>Value.MapIndex()函数： 根据Key取出对应的map。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">u1 := &amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line">u2 := &amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">8</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line">userMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]*common.User, <span class="number">5</span>)</span><br><span class="line">userMap[u1.Id] = u1</span><br><span class="line"></span><br><span class="line">mapValue := reflect.ValueOf(&amp;userMap)                                                         <span class="comment">//准备通过Value修改userMap，所以传userMap的地址</span></span><br><span class="line">mapValue.Elem().SetMapIndex(reflect.ValueOf(u2.Id), reflect.ValueOf(u2))                      <span class="comment">//SetMapIndex 往map里添加一个key-value对</span></span><br><span class="line">mapValue.Elem().MapIndex(reflect.ValueOf(u1.Id)).Elem().FieldByName(<span class="string">&quot;Name&quot;</span>).SetString(<span class="string">&quot;令狐一刀&quot;</span>) <span class="comment">//MapIndex 根据Key取出对应的map</span></span><br><span class="line"><span class="keyword">for</span> k, user := <span class="keyword">range</span> userMap &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;key %d name %s\n&quot;</span>, k, user.Name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="调用函数">调用函数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">valueFunc := reflect.ValueOf(Add) <span class="comment">//函数也是一种数据类型</span></span><br><span class="line">typeFunc := reflect.TypeOf(Add)</span><br><span class="line">argNum := typeFunc.NumIn()            <span class="comment">//函数输入参数的个数</span></span><br><span class="line">args := <span class="built_in">make</span>([]reflect.Value, argNum) <span class="comment">//准备函数的输入参数</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; argNum; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> typeFunc.In(i).Kind() == reflect.Int &#123;</span><br><span class="line">args[i] = reflect.ValueOf(<span class="number">3</span>) <span class="comment">//给每一个参数都赋3</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">sumValue := valueFunc.Call(args) <span class="comment">//返回[]reflect.Value，因为go语言的函数返回可能是一个列表</span></span><br><span class="line"><span class="keyword">if</span> typeFunc.Out(<span class="number">0</span>).Kind() == reflect.Int &#123;</span><br><span class="line">sum := sumValue[<span class="number">0</span>].Interface().(<span class="type">int</span>) <span class="comment">//从Value转为原始数据类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;sum=%d\n&quot;</span>, sum)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="调用成员方法">调用成员方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line">valueUser := reflect.ValueOf(&amp;user)              <span class="comment">//必须传指针，因为BMI()在定义的时候它是指针的方法</span></span><br><span class="line">bmiMethod := valueUser.MethodByName(<span class="string">&quot;BMI&quot;</span>)       <span class="comment">//MethodByName()通过Name返回类的成员变量</span></span><br><span class="line">resultValue := bmiMethod.Call([]reflect.Value&#123;&#125;) <span class="comment">//无参数时传一个空的切片</span></span><br><span class="line">result := resultValue[<span class="number">0</span>].Interface().(<span class="type">float32</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;bmi=%.2f\n&quot;</span>, result)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Think()在定义的时候用的不是指针，valueUser可以用指针也可以不用指针</span></span><br><span class="line">thinkMethod := valueUser.MethodByName(<span class="string">&quot;Think&quot;</span>)</span><br><span class="line">thinkMethod.Call([]reflect.Value&#123;&#125;)</span><br><span class="line"></span><br><span class="line">valueUser2 := reflect.ValueOf(user)</span><br><span class="line">thinkMethod = valueUser2.MethodByName(<span class="string">&quot;Think&quot;</span>)</span><br><span class="line">thinkMethod.Call([]reflect.Value&#123;&#125;)</span><br></pre></td></tr></table></figure><h3 id="创建对象">创建对象</h3><h4 id="创建struct">创建struct</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user :=t := reflect.TypeOf(common.User&#123;&#125;)</span><br><span class="line">value := reflect.New(t) <span class="comment">//根据reflect.Type创建一个对象，得到该对象的指针，再根据指针提到reflect.Value</span></span><br><span class="line">value.Elem().FieldByName(<span class="string">&quot;Id&quot;</span>).SetInt(<span class="number">10</span>)</span><br><span class="line">user := value.Interface().(*common.User) <span class="comment">//把反射类型转成go原始数据类型Call([]reflect.Value&#123;&#125;)</span></span><br></pre></td></tr></table></figure><h4 id="创建slice">创建slice</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice []common.User</span><br><span class="line">sliceType := reflect.TypeOf(slice)</span><br><span class="line">sliceValue := reflect.MakeSlice(sliceType, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">sliceValue.Index(<span class="number">0</span>).Set(reflect.ValueOf(common.User&#123;</span><br><span class="line">Id:     <span class="number">8</span>,</span><br><span class="line">Name:   <span class="string">&quot;李达&quot;</span>,</span><br><span class="line">Weight: <span class="number">80</span>,</span><br><span class="line">Height: <span class="number">180</span>,</span><br><span class="line">&#125;))</span><br><span class="line">users := sliceValue.Interface().([]common.User)</span><br><span class="line">fmt.Printf(<span class="string">&quot;1st user name %s\n&quot;</span>, users[<span class="number">0</span>].Name)</span><br></pre></td></tr></table></figure><h4 id="创建map">创建map</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userMap <span class="keyword">map</span>[<span class="type">int</span>]*common.User</span><br><span class="line">mapType := reflect.TypeOf(userMap)</span><br><span class="line"><span class="comment">// mapValue:=reflect.MakeMap(mapType)</span></span><br><span class="line">mapValue := reflect.MakeMapWithSize(mapType, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">user := &amp;common.User&#123;</span><br><span class="line">Id:     <span class="number">7</span>,</span><br><span class="line">Name:   <span class="string">&quot;杰克逊&quot;</span>,</span><br><span class="line">Weight: <span class="number">65.5</span>,</span><br><span class="line">Height: <span class="number">1.68</span>,</span><br><span class="line">&#125;</span><br><span class="line">key := reflect.ValueOf(user.Id)</span><br><span class="line">mapValue.SetMapIndex(key, reflect.ValueOf(user))                    <span class="comment">//SetMapIndex 往map里添加一个key-value对</span></span><br><span class="line">mapValue.MapIndex(key).Elem().FieldByName(<span class="string">&quot;Name&quot;</span>).SetString(<span class="string">&quot;令狐一刀&quot;</span>) <span class="comment">//MapIndex 根据Key取出对应的map</span></span><br><span class="line">userMap = mapValue.Interface().(<span class="keyword">map</span>[<span class="type">int</span>]*common.User)</span><br><span class="line">fmt.Printf(<span class="string">&quot;user name %s %s\n&quot;</span>, userMap[<span class="number">7</span>].Name, user.Name)</span><br></pre></td></tr></table></figure><p>reflect包里除了MakeSlice()和MakeMap()，还有MakeChan()和MakeFunc()。</p><h2 id="自行实现json序列化">自行实现json序列化</h2><p>  所谓序列化即把struct实例转为string。比如定义了User和Book两个struct。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age <span class="type">int</span></span><br><span class="line">    Sex <span class="type">byte</span> <span class="string">`json:&quot;gender&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Book <span class="keyword">struct</span> &#123;</span><br><span class="line">    ISBN <span class="type">string</span> <span class="string">`json:&quot;isbn&quot;`</span></span><br><span class="line">    Author User <span class="string">`json:&quot;author&quot;`</span></span><br><span class="line">    Keywords []<span class="type">string</span> <span class="string">`json:&quot;kws&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  Book的实例序列化后为</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;isbn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4243547567&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;钱钟书&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Age&quot;</span><span class="punctuation">:</span> <span class="number">57</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;kws&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;爱情&quot;</span><span class="punctuation">,</span> <span class="string">&quot;民国&quot;</span><span class="punctuation">,</span> <span class="string">&quot;留学&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>  序列化实现思路：</p><ul><li>从内向外、从简单到复杂地考虑序列化问题。<ol><li>如果要序列化一个int、float、string，很简单。</li><li>如果要序列化一个slice，则在第1步的基础上用[]括起来。</li><li>如果要序列化一个struct，FieldName直接打印出来，FieldValue的序列化可以参考第1、2步。</li><li>如果struct内部还嵌套了struct，则递归调用第3步。</li></ol></li><li>通过反射解析struct，得到json key和struct FieldName的对应关系。</li><li>如果FieldValue是基本的值类型，则通过反射给FieldValue赋值很简单。</li><li>如果FieldValue是slice类型，则需要通过反射先创建一个slice，再给slice里的每个元素赋值。</li><li>如果FieldValue是是内嵌struct，则递归调用反序列化函数，给FieldValue赋值。</li><li>如果FieldValue是是内嵌struct指针，则需要创建内嵌struct对应的实例（申请内存空间），再递归调用反序列化函数，给FieldValue赋值。</li></ul><h2 id="案例-2">案例</h2><h3 id="序列化json">序列化json</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">Sex  <span class="type">byte</span> <span class="string">`json:&quot;gender&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Book <span class="keyword">struct</span> &#123;</span><br><span class="line">ISBN     <span class="type">string</span> <span class="string">`json:&quot;isbn&quot;`</span></span><br><span class="line">Name     <span class="type">string</span></span><br><span class="line">Price    <span class="type">float32</span>      <span class="string">`json:&quot;price&quot;`</span></span><br><span class="line">Author   *User        <span class="string">`json:&quot;author&quot;`</span> <span class="comment">//把指针去掉试试</span></span><br><span class="line">Keywords []<span class="type">string</span>     <span class="string">`json:&quot;kws&quot;`</span></span><br><span class="line">Local    <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">bool</span> <span class="comment">//暂不支持map</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Marshal</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">value := reflect.ValueOf(v)</span><br><span class="line">typ := value.Type() <span class="comment">//跟typ := reflect.TypeOf(v)等价</span></span><br><span class="line"><span class="keyword">if</span> typ.Kind() == reflect.Ptr &#123;</span><br><span class="line"><span class="keyword">if</span> value.IsNil() &#123; <span class="comment">//如果指向nil，直接输出null</span></span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(<span class="string">&quot;null&quot;</span>), <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//如果传的是指针类型，先解析指针</span></span><br><span class="line">typ = typ.Elem()</span><br><span class="line">value = value.Elem()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">bf := bytes.Buffer&#123;&#125; <span class="comment">//存放序列化结果</span></span><br><span class="line"><span class="keyword">switch</span> typ.Kind() &#123;</span><br><span class="line"><span class="keyword">case</span> reflect.String:</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;\&quot;%s\&quot;&quot;</span>, value.String())), <span class="literal">nil</span> <span class="comment">//取得reflect.Value对应的原始数据的值</span></span><br><span class="line"><span class="keyword">case</span> reflect.Bool:</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;%t&quot;</span>, value.Bool())), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> reflect.Float32,</span><br><span class="line">reflect.Float64:</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;%f&quot;</span>, value.Float())), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> reflect.Uint,</span><br><span class="line">reflect.Uint8,</span><br><span class="line">reflect.Uint16,</span><br><span class="line">reflect.Uint32,</span><br><span class="line">reflect.Uint64,</span><br><span class="line">reflect.Int,</span><br><span class="line">reflect.Int8,</span><br><span class="line">reflect.Int16,</span><br><span class="line">reflect.Int32,</span><br><span class="line">reflect.Int64:</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, value.Interface())), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> reflect.Slice:</span><br><span class="line"><span class="keyword">if</span> value.IsValid() &amp;&amp; value.IsNil() &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(<span class="string">&quot;null&quot;</span>), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> value.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; value.Len(); i++ &#123; <span class="comment">//取得slice的长度</span></span><br><span class="line"><span class="keyword">if</span> bs, err := Marshal(value.Index(i).Interface()); err != <span class="literal">nil</span> &#123; <span class="comment">//对slice的第i个元素进行序列化。递归</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bf.Write(bs)</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">bf.Truncate(<span class="built_in">len</span>(bf.Bytes()) - <span class="number">1</span>) <span class="comment">//删除最后一个逗号</span></span><br><span class="line">&#125;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> bf.Bytes(), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> reflect.Map:</span><br><span class="line"><span class="keyword">if</span> value.IsValid() &amp;&amp; value.IsNil() &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(<span class="string">&quot;null&quot;</span>), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&#123;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> value.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> value.MapKeys() &#123;</span><br><span class="line"><span class="keyword">if</span> keyBs, err := Marshal(key.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">bf.Write(keyBs)</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">v := value.MapIndex(key)</span><br><span class="line"><span class="keyword">if</span> vBs, err := Marshal(v.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bf.Write(vBs)</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">bf.Truncate(<span class="built_in">len</span>(bf.Bytes()) - <span class="number">1</span>) <span class="comment">//删除最后一个逗号</span></span><br><span class="line">&#125;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> bf.Bytes(), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> reflect.Struct:</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&#123;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> value.NumField() &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; value.NumField(); i++ &#123;</span><br><span class="line">fieldValue := value.Field(i)</span><br><span class="line">fieldType := typ.Field(i)</span><br><span class="line"><span class="keyword">if</span> fieldType.IsExported() &#123;</span><br><span class="line">name := fieldType.Name <span class="comment">//如果没有json Tag，默认使用成员变量的名称</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(fieldType.Tag.Get(<span class="string">&quot;json&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">name = fieldType.Tag.Get(<span class="string">&quot;json&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">bf.WriteString(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">bf.WriteString(name)</span><br><span class="line">bf.WriteString(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">bf.WriteString(<span class="string">&quot;:&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> bs, err := Marshal(fieldValue.Interface()); err != <span class="literal">nil</span> &#123; <span class="comment">//对value递归调用Marshal序列化</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bf.Write(bs)</span><br><span class="line">&#125;</span><br><span class="line">bf.WriteString(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">bf.Truncate(<span class="built_in">len</span>(bf.Bytes()) - <span class="number">1</span>) <span class="comment">//删除最后一个逗号</span></span><br><span class="line">&#125;</span><br><span class="line">bf.WriteByte(<span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> bf.Bytes(), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;\&quot;暂不支持该数据类型:%s\&quot;&quot;</span>, typ.Kind().String())), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">book := Book&#123;</span><br><span class="line">ISBN:     <span class="string">&quot;4243547567&quot;</span>,</span><br><span class="line">Name:     <span class="string">&quot;围城&quot;</span>,</span><br><span class="line">Price:    <span class="number">34.8</span>,</span><br><span class="line">Author:   &amp;User&#123;Name: <span class="string">&quot;钱钟书&quot;</span>, Age: <span class="number">55</span>, Sex: <span class="number">1</span>&#125;, <span class="comment">//改成nil试试</span></span><br><span class="line">Keywords: []<span class="type">string</span>&#123;<span class="string">&quot;爱情&quot;</span>, <span class="string">&quot;民国&quot;</span>, <span class="string">&quot;留学&quot;</span>&#125;,          <span class="comment">//把这一行注释掉试一下，测测null</span></span><br><span class="line">Local:    <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">bool</span>&#123;<span class="number">2</span>: <span class="literal">true</span>, <span class="number">3</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> b, err := Marshal(book); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;序列化失败: %v\n&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：<br>{“isbn”:“4243547567”,“Name”:“围城”,“price”:34.799999,“author”:{“Name”:“钱钟书”,“Age”:55,“gender”:1},“kws”:[“爱情”,“民国”,“留学”],“Local”:{“2”:true,“3”:false}}</p><h3 id="反序列化json">反序列化json</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;container/list&quot;</span></span><br><span class="line"><span class="string">&quot;errors&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;reflect&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">Sex  <span class="type">byte</span> <span class="string">`json:&quot;gender&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Book <span class="keyword">struct</span> &#123;</span><br><span class="line">ISBN     <span class="type">string</span> <span class="string">`json:&quot;isbn&quot;`</span></span><br><span class="line">Name     <span class="type">string</span></span><br><span class="line">Price    <span class="type">float32</span>      <span class="string">`json:&quot;price&quot;`</span></span><br><span class="line">Author   *User        <span class="string">`json:&quot;author&quot;`</span> <span class="comment">//把指针去掉试试</span></span><br><span class="line">Keywords []<span class="type">string</span>     <span class="string">`json:&quot;kws&quot;`</span></span><br><span class="line">Local    <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">bool</span> <span class="comment">//暂不支持map</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于json字符串里存在&#123;&#125;[]等嵌套情况，直接按,分隔是不合适的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitJson</span><span class="params">(json <span class="type">string</span>)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">rect := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">stack := list.New() <span class="comment">//list是双端队列，用它来模拟栈</span></span><br><span class="line">beginIndex := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, r := <span class="keyword">range</span> json &#123;</span><br><span class="line"><span class="keyword">if</span> r == <span class="type">rune</span>(<span class="string">&#x27;&#123;&#x27;</span>) || r == <span class="type">rune</span>(<span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">stack.PushBack(<span class="keyword">struct</span>&#123;&#125;&#123;&#125;) <span class="comment">//我们不关心栈里是什么，只关心栈里有没有元素</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> r == <span class="type">rune</span>(<span class="string">&#x27;&#125;&#x27;</span>) || r == <span class="type">rune</span>(<span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">ele := stack.Back()</span><br><span class="line"><span class="keyword">if</span> ele != <span class="literal">nil</span> &#123;</span><br><span class="line">stack.Remove(ele) <span class="comment">//删除栈顶元素</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> r == <span class="type">rune</span>(<span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> stack.Len() == <span class="number">0</span> &#123; <span class="comment">//栈为空时才可以按,分隔</span></span><br><span class="line">rect = <span class="built_in">append</span>(rect, json[beginIndex:i])</span><br><span class="line">beginIndex = i + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rect = <span class="built_in">append</span>(rect, json[beginIndex:])</span><br><span class="line"><span class="keyword">return</span> rect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Unmarshal</span><span class="params">(data []<span class="type">byte</span>, v <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">s := <span class="type">string</span>(data)</span><br><span class="line"><span class="comment">//去除前后的连续空格</span></span><br><span class="line">s = strings.TrimLeft(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line">s = strings.TrimRight(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">typ := reflect.TypeOf(v)</span><br><span class="line">value := reflect.ValueOf(v)</span><br><span class="line"><span class="keyword">if</span> typ.Kind() != reflect.Ptr &#123; <span class="comment">//因为要修改v，必须传指针</span></span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;must pass pointer parameter&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typ = typ.Elem() <span class="comment">//解析指针</span></span><br><span class="line">value = value.Elem()</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> typ.Kind() &#123;</span><br><span class="line"><span class="keyword">case</span> reflect.String:</span><br><span class="line"><span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; s[<span class="built_in">len</span>(s)<span class="number">-1</span>] == <span class="string">&#x27;&quot;&#x27;</span> &#123;</span><br><span class="line">value.SetString(s[<span class="number">1</span> : <span class="built_in">len</span>(s)<span class="number">-1</span>]) <span class="comment">//去除前后的&quot;&quot;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// return errors.New(fmt.Sprintf(&quot;invalid json part: %s&quot;, s))</span></span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Bool:</span><br><span class="line"><span class="keyword">if</span> b, err := strconv.ParseBool(s); err == <span class="literal">nil</span> &#123;</span><br><span class="line">value.SetBool(b)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Float32,</span><br><span class="line">reflect.Float64:</span><br><span class="line"><span class="keyword">if</span> f, err := strconv.ParseFloat(s, <span class="number">64</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">value.SetFloat(f) <span class="comment">//通过reflect.Value修改原始数据的值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Int,</span><br><span class="line">reflect.Int8,</span><br><span class="line">reflect.Int16,</span><br><span class="line">reflect.Int32,</span><br><span class="line">reflect.Int64:</span><br><span class="line"><span class="keyword">if</span> i, err := strconv.ParseInt(s, <span class="number">10</span>, <span class="number">64</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">value.SetInt(i) <span class="comment">//有符号整型通过SetInt</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Uint,</span><br><span class="line">reflect.Uint8,</span><br><span class="line">reflect.Uint16,</span><br><span class="line">reflect.Uint32,</span><br><span class="line">reflect.Uint64:</span><br><span class="line"><span class="keyword">if</span> i, err := strconv.ParseUint(s, <span class="number">10</span>, <span class="number">64</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">value.SetUint(i) <span class="comment">//无符号整型需要通过SetUint</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Slice:</span><br><span class="line"><span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span> &amp;&amp; s[<span class="built_in">len</span>(s)<span class="number">-1</span>] == <span class="string">&#x27;]&#x27;</span> &#123;</span><br><span class="line">arr := SplitJson(s[<span class="number">1</span> : <span class="built_in">len</span>(s)<span class="number">-1</span>]) <span class="comment">//去除前后的[]</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) &gt; <span class="number">0</span> &#123;</span><br><span class="line">slice := reflect.ValueOf(v).Elem()                    <span class="comment">//别忘了，v是指针</span></span><br><span class="line">slice.Set(reflect.MakeSlice(typ, <span class="built_in">len</span>(arr), <span class="built_in">len</span>(arr))) <span class="comment">//通过反射创建slice</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</span><br><span class="line">eleValue := slice.Index(i)</span><br><span class="line">eleType := eleValue.Type()</span><br><span class="line"><span class="keyword">if</span> eleType.Kind() != reflect.Ptr &#123;</span><br><span class="line">eleValue = eleValue.Addr() <span class="comment">//Elem</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(arr[i]), eleValue.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> s != <span class="string">&quot;null&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Map:</span><br><span class="line"><span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&#x27;&#123;&#x27;</span> &amp;&amp; s[<span class="built_in">len</span>(s)<span class="number">-1</span>] == <span class="string">&#x27;&#125;&#x27;</span> &#123;</span><br><span class="line">arr := SplitJson(s[<span class="number">1</span> : <span class="built_in">len</span>(s)<span class="number">-1</span>]) <span class="comment">//去除前后的&#123;&#125;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) &gt; <span class="number">0</span> &#123;</span><br><span class="line">mapValue := reflect.ValueOf(v).Elem()                <span class="comment">//别忘了，v是指针</span></span><br><span class="line">mapValue.Set(reflect.MakeMapWithSize(typ, <span class="built_in">len</span>(arr))) <span class="comment">//通过反射创建map</span></span><br><span class="line"></span><br><span class="line">kType := typ.Key()  <span class="comment">//获取map的key的Type</span></span><br><span class="line">vType := typ.Elem() <span class="comment">//获取map的value的Type</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</span><br><span class="line">brr := strings.Split(arr[i], <span class="string">&quot;:&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(brr) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, arr[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kValue := reflect.New(kType) <span class="comment">//根据Type创建指针型的Value</span></span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(brr[<span class="number">0</span>]), kValue.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">vValue := reflect.New(vType) <span class="comment">//根据Type创建指针型的Value</span></span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(brr[<span class="number">1</span>]), vValue.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">mapValue.SetMapIndex(kValue.Elem(), vValue.Elem()) <span class="comment">//往map里面赋值</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> s != <span class="string">&quot;null&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> reflect.Struct:</span><br><span class="line"><span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&#x27;&#123;&#x27;</span> &amp;&amp; s[<span class="built_in">len</span>(s)<span class="number">-1</span>] == <span class="string">&#x27;&#125;&#x27;</span> &#123;</span><br><span class="line">arr := SplitJson(s[<span class="number">1</span> : <span class="built_in">len</span>(s)<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) &gt; <span class="number">0</span> &#123;</span><br><span class="line">fieldCount := typ.NumField()</span><br><span class="line"><span class="comment">//建立json tag到FieldName的映射关系</span></span><br><span class="line">tag2Field := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, fieldCount)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; fieldCount; i++ &#123;</span><br><span class="line">fieldType := typ.Field(i)</span><br><span class="line">name := fieldType.Name</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(fieldType.Tag.Get(<span class="string">&quot;json&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">name = fieldType.Tag.Get(<span class="string">&quot;json&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">tag2Field[name] = fieldType.Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, ele := <span class="keyword">range</span> arr &#123;</span><br><span class="line">brr := strings.SplitN(ele, <span class="string">&quot;:&quot;</span>, <span class="number">2</span>) <span class="comment">//json的value里可能存在嵌套，所以用:分隔时限定个数为2</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(brr) == <span class="number">2</span> &#123;</span><br><span class="line">tag := strings.Trim(brr[<span class="number">0</span>], <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> tag[<span class="number">0</span>] == <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; tag[<span class="built_in">len</span>(tag)<span class="number">-1</span>] == <span class="string">&#x27;&quot;&#x27;</span> &#123; <span class="comment">//json的key肯定是带&quot;&quot;的</span></span><br><span class="line">tag = tag[<span class="number">1</span> : <span class="built_in">len</span>(tag)<span class="number">-1</span>]                        <span class="comment">//去除json key前后的&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> fieldName, exists := tag2Field[tag]; exists &#123; <span class="comment">//根据json key(即json tag)找到对应的FieldName</span></span><br><span class="line">fieldValue := value.FieldByName(fieldName)</span><br><span class="line">fieldType := fieldValue.Type()</span><br><span class="line"><span class="keyword">if</span> fieldType.Kind() != reflect.Ptr &#123;</span><br><span class="line"><span class="comment">//如果内嵌不是指针，则声明时已经用0值初始化了，此处只需要根据json改写它的值</span></span><br><span class="line">fieldValue = fieldValue.Addr()                                            <span class="comment">//确保fieldValue指向指针类型，因为接下来要把fieldValue传给Unmarshal</span></span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(brr[<span class="number">1</span>]), fieldValue.Interface()); err != <span class="literal">nil</span> &#123; <span class="comment">//递归调用Unmarshal，给fieldValue的底层数据赋值</span></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//如果内嵌的是指针，则需要通过New()创建一个实例(申请内存空间)。不能给New()传指针型的Type，所以调一下Elem()</span></span><br><span class="line">newValue := reflect.New(fieldType.Elem())                               <span class="comment">//newValue代表的是指针</span></span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(brr[<span class="number">1</span>]), newValue.Interface()); err != <span class="literal">nil</span> &#123; <span class="comment">//递归调用Unmarshal，给fieldValue的底层数据赋值</span></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">value.FieldByName(fieldName).Set(newValue) <span class="comment">//把newValue赋给value的Field</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;字段%s找不到\n&quot;</span>, tag)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, tag)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, ele)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> s != <span class="string">&quot;null&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid json part: %s&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Printf(<span class="string">&quot;暂不支持类型:%s\n&quot;</span>, typ.Kind().String())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">json_str := <span class="string">`&#123;&quot;isbn&quot;:&quot;4243547567&quot;,&quot;Name&quot;:&quot;围城&quot;,&quot;price&quot;:34.799999,&quot;author&quot;:&#123;&quot;Name&quot;:&quot;钱钟书&quot;,&quot;Age&quot;:55,&quot;gender&quot;:1&#125;,&quot;kws&quot;:[&quot;爱情&quot;,&quot;民国&quot;,&quot;留学&quot;],&quot;Local&quot;:&#123;&quot;2&quot;:true,&quot;3&quot;:false&#125;&#125;`</span></span><br><span class="line"><span class="keyword">var</span> book Book <span class="comment">//必须先声明值类型，再通过&amp;给Unmarshal传一个指针参数。因为声明值类型会初始化为0值，而声明指针都没有创建底层的内存空间</span></span><br><span class="line"><span class="keyword">if</span> err := Unmarshal([]<span class="type">byte</span>(json_str), &amp;book); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;err: %v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;book: %+v\n&quot;</span>, book)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>book: {ISBN:4243547567 Name:围城 Price:34.8 Author:0xc000050440 Keywords:[爱情 民国 留学] Local:map[2:true 3:false]}</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang泛型</title>
      <link href="/20221230/golang-20221230-golang%E6%B3%9B%E5%9E%8B/"/>
      <url>/20221230/golang-20221230-golang%E6%B3%9B%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<p>  在有泛型之前，同样的功能需要为不同的参数类型单独实现一个函数。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add4int</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add4float32</span><span class="params">(a, b <span class="type">float32</span>)</span></span> <span class="type">float32</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add4string</span><span class="params">(a, b <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用泛型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Addable <span class="keyword">interface</span>&#123;</span><br><span class="line"><span class="keyword">type</span> <span class="type">int</span>, <span class="type">int8</span>, <span class="type">int16</span>, <span class="type">int32</span>, <span class="type">int64</span>,</span><br><span class="line"><span class="type">uint</span>, <span class="type">uint8</span>, <span class="type">uint16</span>, <span class="type">uint32</span>, <span class="type">uint64</span>, <span class="type">uintptr</span>,</span><br><span class="line"><span class="type">float32</span>, <span class="type">float64</span>, <span class="type">complex64</span>, <span class="type">complex128</span>,<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span>[<span class="title">T</span> <span class="title">Addable</span>]<span class="params">(a,b T)</span></span>T&#123;</span><br><span class="line"><span class="keyword">return</span> a+b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  在go1.17中泛型默认没有开启，如果想用需要加-gcflags=-G=3，或者设置环境变量export GOFLAGS=“-gcflags=-G=3”。泛型正式版将在go 1.18中发布，但是Go语言之父Rob Pike建议不在Go 1.18的标准库中使用泛型。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang压缩</title>
      <link href="/20221230/golang-20221230-golang%E5%8E%8B%E7%BC%A9/"/>
      <url>/20221230/golang-20221230-golang%E5%8E%8B%E7%BC%A9/</url>
      
        <content type="html"><![CDATA[<h2 id="1-zip">1. zip</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;archive/zip&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">new_zip</span><span class="params">(files []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// 创建压缩文件</span></span><br><span class="line">fout, err2 := os.OpenFile(<span class="string">&quot;test2.zip&quot;</span>, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fout.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建zip writer</span></span><br><span class="line">w := zip.NewWriter(fout)</span><br><span class="line"><span class="keyword">defer</span> w.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩指定文件</span></span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line"><span class="comment">// 打开被压缩文件</span></span><br><span class="line">fin, err := os.Open(file)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fin.Close()</span><br><span class="line"></span><br><span class="line">f, _ := w.Create(file)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line">n, err2 := fin.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">f.Write(buf[:n])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">unzip</span><span class="params">(zipfile <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// 打开一个zip格式文件</span></span><br><span class="line">r, err := zip.OpenReader(zipfile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> r.Close()</span><br><span class="line"><span class="comment">// 解压目录</span></span><br><span class="line">dest_dir := strings.Trim(zipfile, <span class="string">&quot;.zip&quot;</span>)</span><br><span class="line">err2 := os.Mkdir(dest_dir, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 迭代解压缩文件中的文件</span></span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> r.File &#123;</span><br><span class="line"><span class="comment">// 跳过目录</span></span><br><span class="line"><span class="keyword">if</span> f.Mode().IsDir() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;跳过目录&quot;</span>, f.Name)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">f2, err3 := os.Create(filepath.Join(dest_dir, f.Name))</span><br><span class="line"><span class="keyword">if</span> err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err3)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 打开压缩文件</span></span><br><span class="line">rc, err := f.Open()</span><br><span class="line"><span class="keyword">defer</span> rc.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">io.Copy(f2, rc)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// files := []string&#123;&quot;test2.txt&quot;, &quot;go.mod&quot;, &quot;go.sum&quot;&#125;</span></span><br><span class="line"><span class="comment">// new_zip(files)</span></span><br><span class="line">unzip(<span class="string">&quot;test2.zip&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-gzip">2. gzip</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;compress/gzip&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">new_gzip</span><span class="params">(infile, outfile <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// 打开被压缩文件</span></span><br><span class="line"><span class="comment">// fin, err := os.Open(&quot;D:\\ISO\\ubuntu-16.04.7-server-amd64.iso&quot;)</span></span><br><span class="line">fin, err := os.Open(infile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建压缩文件</span></span><br><span class="line">fout, err2 := os.OpenFile(outfile, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fin.Close()</span><br><span class="line"><span class="keyword">defer</span> fout.Close()</span><br><span class="line"><span class="comment">// 创建zip writer</span></span><br><span class="line">w := gzip.NewWriter(fout)</span><br><span class="line"><span class="keyword">defer</span> w.Close()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">bs := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line">n, err2 := fin.Read(bs)</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">w.Write(bs[:n])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ungzip</span><span class="params">(infile, outfile <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">fin, err := os.Open(infile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fout, err2 := os.OpenFile(outfile, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fin.Close()</span><br><span class="line"><span class="keyword">defer</span> fout.Close()</span><br><span class="line"><span class="comment">// 创建gzip reader</span></span><br><span class="line">r, err3 := gzip.NewReader(fin)</span><br><span class="line"><span class="keyword">defer</span> r.Close()</span><br><span class="line"><span class="keyword">if</span> err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err3)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">io.Copy(fout, r)</span><br><span class="line"><span class="comment">// for &#123;</span></span><br><span class="line"><span class="comment">// bs := make([]byte, 1024)</span></span><br><span class="line"><span class="comment">// n, err4 := r.Read(bs)</span></span><br><span class="line"><span class="comment">// if err4 != nil &#123;</span></span><br><span class="line"><span class="comment">// if err4 == io.EOF &#123;</span></span><br><span class="line"><span class="comment">// break</span></span><br><span class="line"><span class="comment">// &#125; else &#123;</span></span><br><span class="line"><span class="comment">// log.Fatal(err4)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// fout.Write(bs[:n])</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// new_gzip(&quot;test2.txt&quot;, &quot;test2.txt.gz&quot;)</span></span><br><span class="line">ungzip(<span class="string">&quot;test2.txt.gz&quot;</span>, <span class="string">&quot;test2_new.txt&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-base64编码-解码">3. base64编码/解码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">base64Encode</span><span class="params">(file <span class="type">string</span>)</span></span> (encodestr <span class="type">string</span>) &#123;</span><br><span class="line">f, err := os.Open(file)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">b, err2 := ioutil.ReadAll(f)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">s := base64.StdEncoding.EncodeToString(b)</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">base64Decode</span><span class="params">(encodestr, destfile <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">f, err := os.OpenFile(destfile, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">b, err2 := base64.StdEncoding.DecodeString(encodestr)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">f.Write(b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := base64Encode(<span class="string">&quot;.\\O1CN01lzzceP1HxtQVhXvl4_!!2934640825.jpg&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">base64Decode(s, <span class="string">&quot;./new.jpg&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git</title>
      <link href="/20221225/git-20221225-git%E5%85%A5%E9%97%A8/"/>
      <url>/20221225/git-20221225-git%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<p>Git是一个开源的分布式版本控制软件，用来管理项目版本。Git最初是由Linus Torvalds设计开发的，用于管理Linux内核开发。</p><h2 id="1-为什么需要本本控制">1. 为什么需要本本控制</h2><ol><li>备份用</li><li>团队协同开发</li></ol><h2 id="2-Git的历史">2. Git的历史</h2><p>很多人都知道，Linus在1991年创建了开源的Linux,从此Linux系统不断发展，已经称为最大的服务器系统软件。<br>Linus虽然创建了Linux，但Linux的壮大是靠全世界热心的志愿者参与的，这么多人在世界各地为Linux编写代码，那Linux的代码是如何管理的呢?</p><p>事实上，在2002年以前，世界各地的志愿者把代码文件通过diff的方式发给Linus,然后由Linus本人通过手工方式合并代码<br>你也许会想，为什么Linus不把Linux代码放到版本控制系统里呢？不是有CVS、SVN这些免费的版本控制系统码？因为Linus坚定的反对CVS和SVN，这些集中式的版本控制系统不但速度慢，而且必须联网才能使用。有一些商用的版本控制系统，虽然比CVS、SVN好用，但那时付费的，和Linux的开源精神不符。</p><p>不过，到了2002年，Linux系统已经发展了十年了，代码库之大让Linus很难继续通过手工方式管理了，社区的弟兄们也对这种方式表达了强烈不满，于是Linus选择了一种商业版本控制系统BitKeeper，BitKeeper的东家BitMover公司出于人道主义精神，授权Linux免费使用这个版本控制系统。</p><p>安定团结的大好局面在2005年被打破了，原因是Linux社区牛人聚集，不免沾染了一些梁山好汉的江湖习气。开发Samba的Andrew试图破解BitKeeper的协议，被BitMover公司发现了，于是BitMover公司怒了，要收回Linux社区的免费使用权。</p><p>Linus花了两周时间自己用C写了一个分布式版本控制系统，这就是Git，一个月之内，Linux系统的源码已经由Git管理了，</p><p>Git迅速成为最流行的分布式版本控制系统，尤其在2008年，GitHub网站上线了，它为开源项目免费提供了Git存储，无数开源项目开始迁移到GitHub，包括JQuery,PHP,Ruby等等。</p><p>历史就是这么偶然，如果不是当年BitMover公司威胁Linux社区，可能现在我们就没有免费而超级好用的Git了。</p><h2 id="3-Git的官网">3. Git的官网</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://git-scm.com</span><br></pre></td></tr></table></figure><h2 id="2-Git的安装和配置">2. Git的安装和配置</h2><p>下载Git<br><a href="https://git-scm.comdownload/">https://git-scm.comdownload/</a></p><h2 id="3-Git的四个工作区域">3. Git的四个工作区域</h2><p>Git本地有四个工作区域：工作目录（Working Directory）、暂存区（Stage/Index）、资源库（Repository）或Git Directory、git仓库（Remote Directory）文件在这四个区域之间的转换关系如下：</p><ul><li><strong>Workspace</strong>：工作区，就是你平时存放项目代码的地方</li><li><strong>Index/Stage</strong>：暂存区，用于临时存放你的改动，事实上它只是一个文件，保存即将提交到文件列表信息</li><li><strong>Repository</strong>：（仓库区），就是安全存放数据的位置，这里面有你提交到所有版本的数据。其中HEAD指向最新放入仓库的版本。</li><li><strong>Remote</strong>：远程仓库，托管代码的服务器，可以简单的认为是你项目组中的一台电脑用于远程数据交换</li></ul><h2 id="4-Git文件的四种状态">4. Git文件的四种状态</h2><p>git的工作流程一般是这样的：</p><ol><li>在工作目录中添加、修改文件</li><li>将需要进行版本管理的文件放入暂存区域</li><li>将暂存区域的文件提交到git仓库</li></ol><p>因此，git管理的文件有三种状态：已修改（modified）,已暂存（staged）,已提交（committed）</p><p>版本控制就是对文件的版本控制，要对文件进行修改、提交等操作，首先要直到文件当前在什么状态，不然可能会提交了现在还不想提交的文件，或者想要提交的文件没提交上。</p><p>GIT不关心文件两个版本之间的具体区别，而是关心文件的整体是否有改变，若文件被改变，在添加提交时就生成文件新版本的快照，而判断文件整体是否改变的方法就是用SHA-1算法计算文件的校验和。</p><ul><li>Untracked：未跟中，此文件在文件夹中，但并没有添加到git库，不参与版本控制，通过<code>git add</code> 状态变为<code>Staged</code></li><li>Unmodify：文件已经入库，未修改，即版本库中的文件快照内容与文件夹中完全一致，这种类型的文件有两种去处，如果它被修改，而变为Modified，如果使用<code>git rm</code> 移出版本库，则称为<code>Untracked</code>文件</li><li>Modified：文件已修改，仅仅时修改，并没有进行其他的操作，这个文件也有两个去处，通过<code>git add</code>可进入暂存<code>Staged</code>状态，使用<code>git checkout</code>则丢弃修改，返回到<code>unmodify</code>状态，这个<code>git checkout</code>即从库中去处文件，覆盖当前修改</li><li>Staged：暂存状态，执行<code>git commit</code>则将修改同步到库中，这时库中的文件和本地文件又变为一致，文件为<code>Unmodify</code>状态，执行<code>git reset HEAD filename</code>取消暂存，文件状态变<code>Modified</code></li></ul><ol><li>新建文件–&gt; Untracked</li><li>使用add命令将新建文件加入到暂存区–&gt; Staged</li><li>使用commit命令将暂存区的文件提交到本地仓库–&gt; Unmodified</li><li>如果对Unmodified状态的文件进行修改—&gt; modified</li><li>如果对Unmodified状态的文件进行remove操作–&gt; Untracked</li></ol><h2 id="5-常用命令">5. 常用命令</h2><p>git branch 查看本地所有分支<br>git status 查看当前状态<br>git commit 提交<br>git branch -a 查看所有的分支<br>git branch -r 查看远程所有分支<br>git commit -am “init” 提交并且加注释<br>git remote add origin <a href="mailto:git@127.0.0.1">git@127.0.0.1</a>:ndshow  添加远程仓库<br>git push origin master 将文件给推到服务器上<br>git remote show origin 显示远程库origin里的资源<br>git push origin master:develop<br>git push origin master:hb-dev 将本地库与服务器上的库进行关联<br>git checkout --track origin/dev 切换到远程dev分支<br>git branch -D master develop 删除本地库develop<br>git checkout -b dev 建立一个新的本地分支dev<br>git merge origin/dev 将分支dev与当前分支进行合并<br>git checkout dev 切换到本地dev分支<br>git remove show 查看远程库<br>git add .<br>git rm 文件名（包含路径）从git中删除指定文件<br>git clone git://github.com/schacon/grit.git 从服务器上将代码拉下来<br>git config --list 查看所有用户<br>git ls-files 看已经被提交的文件<br>git rm [file name] 删除一个文件<br>git commit -a 提交当前repos的所有的改变<br>git add [file name] 添加一个文件到git index<br>git commit -v 当你用-v参数时候可以看commit的差异<br>git commit -m “this is the message describing the commit” 添加commit信息<br>git commit -a -a 是代表add,把所有的change加到git index里然后再commit<br>git commit -a -V 一般提交命令<br>git log 看你commit的日志<br>git diff 查看尚未暂存的更新<br>git rm a.a 移除文件（从暂存区和工作区中删除）<br>git rm --cached a.a 移除文件（只从暂存区中删除）<br>git commit -m “remove” 移除文件（从Git中删除）<br>git rm -f a.a 强行移除修改后文件（从暂存区和工作区中删除）<br>git diff --cached 或 git diff --staged 查看尚未提交的更新<br>git stash push 将文件给push到一个临时空间中<br>git stash pop 将文件从临时空间pop下来</p><p>-----------------------------------<br>git remove add origin <a href="mailto:git@github.com">git@github.com</a>:username/Hello-World.git<br>git push origin master 将本地项目提交到服务器中<br>git pull 本地与服务器端同步<br>git push (远程仓库名)（分支名）将本地分支推送到服务器上去<br>git push origin serverfix:awesomebranch<br>-----------------------------------<br>git fetch 相当于从远程获取最新版本到本地，不会自动merge<br>git commit -a -m “log_message” (-a 是提交所有改动，-m是加入log信息)本地修改同步至服务器端<br>git branch branch_0.1 master 从主分支master创建branch_01分钟<br>git branch -m branch_0.1 branch_1.0 将branch_0.1重命名为branch_1.0</p><p>git branch 删除远程branch<br>git push origin :branch_remote_name<br>git branch -r -d branch_remote_name</p><p>初始化版本库，并提交到远程服务端<br>mkdir WebApp<br>cd WebApp<br>git init 本地初始化<br>touch README<br>git add README<br>git commit -m “first commit”<br>git remote add origin <a href="mailto:git@github.com">git@github.com</a>:renmcc/WebApp.git</p><h2 id="6-配置用户签名">6. 配置用户签名</h2><p>如果想要将本地的项目提交到远程仓库的话，必须要设置签名。签名的作用就是用来标识用户，以区别不同的开发人员。</p><h3 id="6-1-设置方式">6.1 设置方式</h3><p>设置签名有两种方式：</p><ol><li>一种是为单个仓库单独设置，这种方式只针对单个仓库有效</li><li>另一种是全局配置，采用这种方式配置后，所有仓库都有效，如果对两种方式都进行了配置，那么会优先使用单个仓库配置方式的配置信息</li></ol><p><strong>单个仓库有效</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name</span><br><span class="line">git config user.email</span><br></pre></td></tr></table></figure><blockquote><p>用户名和邮箱自行设置<br>邮箱可以是假邮箱，即只要符合邮箱格式即可<br>该中方式配置信息会保存再当前仓库目录下.git/config文件中，打开查看发现保存的格式为</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[user]</span><br><span class="line">  name = 用户名</span><br><span class="line">  Email = 邮箱</span><br></pre></td></tr></table></figure><p><strong>全局有效</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name</span><br><span class="line">git config --global user.email</span><br></pre></td></tr></table></figure><p>该种方式配置信息会保存再系统盘的系统用户目录下.gitconfig文件中，保存格式同上面一样。</p>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang操作mysql</title>
      <link href="/20221224/golang-20221224-golang%E6%93%8D%E4%BD%9Cmysql/"/>
      <url>/20221224/golang-20221224-golang%E6%93%8D%E4%BD%9Cmysql/</url>
      
        <content type="html"><![CDATA[<h2 id="1-准备表">1. 准备表</h2><p><strong>创建数据库</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database go_db <span class="keyword">DEFAULT</span> CHARSET utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure><p><strong>创建表</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_tb1(</span><br><span class="line">    id <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    `password` <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>添加数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_tb1(username,password) <span class="keyword">VALUES</span>(&quot;tom&quot;, &quot;123&quot;);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_tb1(username,password) <span class="keyword">VALUES</span>(&quot;kite&quot;, &quot;456&quot;);</span><br></pre></td></tr></table></figure><h2 id="2-安装驱动">2. 安装驱动</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get -u github.com/<span class="keyword">go</span>-sql-driver/mysql</span><br></pre></td></tr></table></figure><p><strong>初始化模块</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> mod init m</span><br></pre></td></tr></table></figure><p><strong>更新依赖</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> mod tidy</span><br></pre></td></tr></table></figure><h2 id="3-获取连接">3. 获取连接</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@/go_db&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>初始化连接</strong><br>Open函数可能只是验证其参数格式是否正确，实际上并不创建与数据库的连接。如果要检查数据源的名称是否真实有效。应该调用ping方法。</p><p>返回的DB对象可以安全的被多个goroutine并发使用，并且维护其自己的空闲连接池。因此，Open函数应该仅被调用一次，很少需要关闭这个DB对象</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-插入数据">4. 插入数据</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertData</span><span class="params">()</span></span> &#123;</span><br><span class="line">sqlStr := <span class="string">&quot;insert into user_tb1(username,password) values(?,?)&quot;</span></span><br><span class="line">ret, err := db.Exec(sqlStr, <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;zs123&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;insert failed, err: %v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">theID, err2 := ret.LastInsertId() <span class="comment">// 新插入数据的id</span></span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;get lastinsert ID failed, err:%v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;theID: %v\n&quot;</span>, theID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">insertData()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-查询操作">5. 查询操作</h2><p>单行查询<code>db.QueryRow()</code>执行一次查询，并期望返回最多一行结果（即Row）。QueryRow总是返回非nil的值，直到返回的Scan方法被调用时，才会返回被延迟的错误。</p><h3 id="5-1-定义一个结构体">5.1 定义一个结构体</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">    id <span class="type">int</span></span><br><span class="line">    username <span class="type">string</span></span><br><span class="line">    password <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-单行查询">5.2 单行查询</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">id       <span class="type">int</span></span><br><span class="line">username <span class="type">string</span></span><br><span class="line">password <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询一条用户数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryRowDemo</span><span class="params">()</span></span> user &#123;</span><br><span class="line">sqlStr := <span class="string">&quot;select id,username,password from user_tb1 where id=?&quot;</span></span><br><span class="line"><span class="keyword">var</span> u user</span><br><span class="line"><span class="comment">// 确保QueryRow之后调用Scan方法，否则持有的数据库连接不会被释放</span></span><br><span class="line">err := db.QueryRow(sqlStr, <span class="number">1</span>).Scan(&amp;u.id, &amp;u.username, &amp;u.password)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> u</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret := queryRowDemo()</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行结果：</p><p>初始化成功<br>ret: {1 tom 123}</p><h3 id="5-3-多行查询">5.3 多行查询</h3><p>多行查询<code>db.Query()</code>执行一次查询，返回多行结果（即Rows），一般用于执行select命令，参数args表示query中的展位参数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">id       <span class="type">int</span></span><br><span class="line">username <span class="type">string</span></span><br><span class="line">password <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询一条用户数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryRowDemo</span><span class="params">(id <span class="type">int</span>)</span></span> []user &#123;</span><br><span class="line">sqlStr := <span class="string">&quot;select id,username,password from user_tb1 where id&gt;?&quot;</span></span><br><span class="line"><span class="comment">// 确保QueryRow之后调用Scan方法，否则持有的数据库连接不会被释放</span></span><br><span class="line">rows, err := db.Query(sqlStr, id)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 非常重要，关闭rows释放持有的数据库链接</span></span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环读取结果集中的数据</span></span><br><span class="line"><span class="keyword">var</span> u user</span><br><span class="line">ret := <span class="built_in">make</span>([]user, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">err2 := rows.Scan(&amp;u.id, &amp;u.username, &amp;u.password)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;scan failed, err:%v\n&quot;</span>, err2)</span><br><span class="line">&#125;</span><br><span class="line">ret = <span class="built_in">append</span>(ret, u)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret := queryRowDemo(<span class="number">1</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>初始化成功<br>ret: [{2 kite 456} {3 张三 zs123}]</p><h3 id="5-4-更新操作">5.4 更新操作</h3><p>插入、更新和删除操作都是使用<code>Exec</code>方法</p><p><code>func (db *DB) Exec(query string, args ...interface&#123;&#125;) (Result, error)</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">id       <span class="type">int</span></span><br><span class="line">username <span class="type">string</span></span><br><span class="line">password <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateData</span><span class="params">()</span></span> &#123;</span><br><span class="line">sql := <span class="string">&quot;update user_tb1 set username=?,password=? where id=?&quot;</span></span><br><span class="line">ret, err := db.Exec(sql, <span class="string">&quot;kite2&quot;</span>, <span class="string">&quot;Kite123&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">rows, err2 := ret.RowsAffected()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">&quot;更新失败&quot;</span>, err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;更新成功,更新行数: %v\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">updateData()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果:</p><p>初始化成功<br>更新成功,更新行数: 1</p><h3 id="5-5-删除操作">5.5 删除操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">id       <span class="type">int</span></span><br><span class="line">username <span class="type">string</span></span><br><span class="line">password <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;ops:xxx.@tcp(192.168.10.10:3306)/go_db?charset=utf8mb4&amp;parseTime=True&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最大连接时长</span></span><br><span class="line">db.SetConnMaxLifetime(time.Minute * <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 空闲连接数</span></span><br><span class="line">db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 尝试与数据库建立连接</span></span><br><span class="line">err2 := db.Ping()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delData</span><span class="params">()</span></span> &#123;</span><br><span class="line">sql := <span class="string">&quot;delete from user_tb1 where id=?&quot;</span></span><br><span class="line">r, err := db.Exec(sql, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">rows, err2 := r.RowsAffected()</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;删除行失败，%v\n&quot;</span>, err2)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;删除成功，删除的行数: %v\n&quot;</span>, rows)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := initDB()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;初始化成功&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">delData()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>初始化成功<br>删除成功，删除的行数: 1</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库math</title>
      <link href="/20221224/golang-20221224-golang%E6%A0%87%E5%87%86%E5%BA%93math/"/>
      <url>/20221224/golang-20221224-golang%E6%A0%87%E5%87%86%E5%BA%93math/</url>
      
        <content type="html"><![CDATA[<p>该包包含一些常量和一些有用的数学计算函数，例如：三角函数、随机数、绝对值、平方根等</p><h2 id="数学常量">数学常量</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">math.E<span class="comment">//自然对数的底，2.718281828459045</span></span><br><span class="line">math.Pi<span class="comment">//圆周率，3.141592653589793</span></span><br><span class="line">math.Phi<span class="comment">//黄金分割，长/短，1.618033988749895</span></span><br><span class="line">math.MaxInt<span class="comment">//9223372036854775807</span></span><br><span class="line"><span class="type">uint64</span>(math.MaxUint)<span class="comment">//得先把MaxUint转成uint64才能输出，18446744073709551615</span></span><br><span class="line">math.MaxFloat64<span class="comment">//1.7976931348623157e+308</span></span><br><span class="line">math.SmallestNonzeroFloat64<span class="comment">//最小的非0且正的浮点数，5e-324</span></span><br></pre></td></tr></table></figure><p>NaN(Not a Number)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f := math.NaN()</span><br><span class="line">math.IsNaN(f)</span><br></pre></td></tr></table></figure><h2 id="常用函数">常用函数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">math.Ceil(<span class="number">1.1</span>)<span class="comment">//向上取整，2</span></span><br><span class="line">math.Floor(<span class="number">1.9</span>)<span class="comment">//向下取整，1。 math.Floor(-1.9)=-2</span></span><br><span class="line">math.Trunc(<span class="number">1.9</span>)<span class="comment">//取整数部分，1</span></span><br><span class="line">math.Modf(<span class="number">2.5</span>)<span class="comment">//返回整数部分和小数部分，2  0.5</span></span><br><span class="line">math.Abs(<span class="number">-2.6</span>)<span class="comment">//绝对值，2.6</span></span><br><span class="line">math.Max(<span class="number">4</span>, <span class="number">8</span>)<span class="comment">//取二者的较大者，8</span></span><br><span class="line">math.Min(<span class="number">4</span>, <span class="number">8</span>)<span class="comment">//取二者的较小者，4</span></span><br><span class="line">math.Mod(<span class="number">6.5</span>, <span class="number">3.5</span>)<span class="comment">//x-Trunc(x/y)*y结果的正负号和x相同，3</span></span><br><span class="line">math.Sqrt(<span class="number">9</span>)<span class="comment">//开平方，3</span></span><br><span class="line">math.Cbrt(<span class="number">9</span>)<span class="comment">//开三次方，2.08008</span></span><br></pre></td></tr></table></figure><h2 id="三角函数">三角函数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">math.Sin(<span class="number">1</span>)</span><br><span class="line">math.Cos(<span class="number">1</span>)</span><br><span class="line">math.Tan(<span class="number">1</span>)</span><br><span class="line">math.Tanh(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="对数和指数">对数和指数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">math.Log(<span class="number">5</span>)<span class="comment">//自然对数，1.60943</span></span><br><span class="line">math.Log1p(<span class="number">4</span>)<span class="comment">//等价于Log(1+p)，确保结果为正数，1.60943</span></span><br><span class="line">math.Log10(<span class="number">100</span>)<span class="comment">//以10为底数，取对数，2</span></span><br><span class="line">math.Log2(<span class="number">8</span>)<span class="comment">//以2为底数，取对数，3</span></span><br><span class="line">math.Pow(<span class="number">3</span>, <span class="number">2</span>)<span class="comment">//x^y，9</span></span><br><span class="line">math.Pow10(<span class="number">2</span>)<span class="comment">//10^x，100</span></span><br><span class="line">math.Exp(<span class="number">2</span>)<span class="comment">//e^x，7.389</span></span><br></pre></td></tr></table></figure><h2 id="随机数生成器">随机数生成器</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个Rand</span></span><br><span class="line">source := rand.NewSource(<span class="number">1</span>) <span class="comment">//seed相同的情况下，随机数生成器产生的数列是相同的</span></span><br><span class="line">rander := rand.New(source)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%d &quot;</span>, rander.Intn(<span class="number">100</span>))</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">source.Seed(<span class="number">1</span>) <span class="comment">//必须重置一下Seed</span></span><br><span class="line">rander2 := rand.New(source)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%d &quot;</span>, rander2.Intn(<span class="number">100</span>))</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用全局Rand</span></span><br><span class="line">rand.Seed(time.Now().UnixNano())                <span class="comment">//如果对两次运行没有一致性要求，可以不设seed</span></span><br><span class="line">fmt.Println(rand.Int())     <span class="comment">//随机生成一个整数</span></span><br><span class="line">fmt.Println(rand.Float32()) <span class="comment">//随机生成一个浮点数</span></span><br><span class="line">fmt.Println(rand.Intn(<span class="number">100</span>)) <span class="comment">//100以内的随机整数，[0,100)</span></span><br><span class="line">fmt.Println(rand.Perm(<span class="number">100</span>)) <span class="comment">//把[0,100)上的整数随机打乱</span></span><br><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</span><br><span class="line">rand.Shuffle(<span class="built_in">len</span>(arr), <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> &#123; <span class="comment">//随机打乱一个给定的slice</span></span><br><span class="line">    arr[i], arr[j] = arr[j], arr[i]</span><br><span class="line">&#125;)</span><br><span class="line">fmt.Println(arr)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库xml</title>
      <link href="/20221224/golang-20221224-golang%E6%A0%87%E5%87%86%E5%BA%93xml/"/>
      <url>/20221224/golang-20221224-golang%E6%A0%87%E5%87%86%E5%BA%93xml/</url>
      
        <content type="html"><![CDATA[<p>xml包实现xml解析</p><h2 id="1-核心的两个函数-2">1. 核心的两个函数</h2><p><code>func Marsha1(v interface&#123;&#125;) ([]byte, error)</code></p><p>将struct编码成xml，可以接收任意类型</p><p><code>func Unmarshal(data []byte, v interface&#123;&#125;) error</code></p><p>将xml转码成struct</p><h2 id="2-两个核心结构体-2">2. 两个核心结构体</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Decoder <span class="keyword">struct</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从输入流读取并解析xml</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Encoder <span class="keyword">struct</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写xml到输出流</p><h2 id="3-实例-3">3. 实例</h2><h3 id="3-1-结构体转xml">3.1 结构体转xml</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/xml&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">XMLName xml.Name <span class="string">`xml:&quot;persion&quot;`</span></span><br><span class="line">Name    <span class="type">string</span>   <span class="string">`xml:&quot;name&quot;`</span></span><br><span class="line">Age     <span class="type">int</span>      <span class="string">`xml:&quot;age&quot;`</span></span><br><span class="line">Email   <span class="type">string</span>   <span class="string">`xml:&quot;email&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">p := Person&#123;</span><br><span class="line">Name:  <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">Age:   <span class="number">22</span>,</span><br><span class="line">Email: <span class="string">&quot;e@mail.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">b, err := xml.MarshalIndent(&amp;p, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p> <persion>  <name>张三</name>  <age>22</age>  <email>e@mail.com</email> </persion><h3 id="3-2-xml转结构体">3.2 xml转结构体</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/xml&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">XMLName xml.Name <span class="string">`xml:&quot;persion&quot;`</span></span><br><span class="line">Name    <span class="type">string</span>   <span class="string">`xml:&quot;name&quot;`</span></span><br><span class="line">Age     <span class="type">int</span>      <span class="string">`xml:&quot;age&quot;`</span></span><br><span class="line">Email   <span class="type">string</span>   <span class="string">`xml:&quot;email&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">`</span></span><br><span class="line"><span class="string">&lt;persion&gt;</span></span><br><span class="line"><span class="string">&lt;name&gt;张三&lt;/name&gt;</span></span><br><span class="line"><span class="string">&lt;age&gt;22&lt;/age&gt;</span></span><br><span class="line"><span class="string">&lt;email&gt;e@mail.com&lt;/email&gt;</span></span><br><span class="line"><span class="string">   &lt;/persion&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">var</span> p Person</span><br><span class="line">err := xml.Unmarshal([]<span class="type">byte</span>(s), &amp;p)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;p: %v\n&quot;</span>, p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>p:</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库json</title>
      <link href="/20221223/golang-20221223-golang%E6%A0%87%E5%87%86%E5%BA%93json/"/>
      <url>/20221223/golang-20221223-golang%E6%A0%87%E5%87%86%E5%BA%93json/</url>
      
        <content type="html"><![CDATA[<p>这个包可以实现json编码和解码，就是将json字符串转换为struct，或者将struct转换为json</p><h2 id="1-核心的两个函数">1. 核心的两个函数</h2><p><code>func Marshl(v interface&#123;&#125;) ([]byte, error)</code></p><div class="note success no-icon flat"><p>将struct编码成json,可以接收任意类型</p></div><p><code>func Unmarshl(data []byte, v interface&#123;&#125;) error</code></p><div class="note success no-icon flat"><p>将json转码成struct</p></div><h2 id="2-两个核心结构体">2. 两个核心结构体</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Decoder <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>从输入流取并解析json</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Encoder <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>写json到输入流</p></div><h2 id="3-实例-2">3. 实例</h2><h3 id="3-1-结构体转json">3.1 结构体转json</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span></span><br><span class="line">Age   <span class="type">int</span></span><br><span class="line">Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">p := Person&#123;</span><br><span class="line">Name:  <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">Age:   <span class="number">11</span>,</span><br><span class="line">Email: <span class="string">&quot;s@mail.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">b, err := json.Marshal(p)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %s\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>b: {“Name”:“张三”<a href="mailto:,%22Age%22:11,%22Email%22:%22s@mail.com">,“Age”:11,“Email”:&quot;s@mail.com</a>&quot;}</p><h3 id="3-2-json转结构体">3.2 json转结构体</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span></span><br><span class="line">Age   <span class="type">int</span></span><br><span class="line">Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">`&#123;&quot;Name&quot;:&quot;张三&quot;,&quot;Age&quot;:11,&quot;Email&quot;:&quot;s@mail.com&quot;&#125;`</span></span><br><span class="line">b := []<span class="type">byte</span>(s)</span><br><span class="line"><span class="keyword">var</span> p Person</span><br><span class="line">err := json.Unmarshal(b, &amp;p)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;p: %T %v\n&quot;</span>, p, p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>p: main.Person {张三 11 <a href="mailto:s@mail.com">s@mail.com</a>}</p><h3 id="3-3-自动解析类型">3.3 自动解析类型</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">`&#123;&quot;Name&quot;:&quot;张三&quot;,&quot;Age&quot;:11,&quot;Email&quot;:&quot;s@mail.com&quot;,&quot;Parents&quot;:[&quot;tom&quot;, &quot;kite&quot;]&#125;`</span></span><br><span class="line">b := []<span class="type">byte</span>(s)</span><br><span class="line"><span class="keyword">var</span> f <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">err := json.Unmarshal(b, &amp;f)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;f: %T\n %v\n&quot;</span>, f, f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>f: map[string]interface {}<br>map[Age:11 <a href="mailto:Email:s@mail.com">Email:s@mail.com</a> Name:张三 Parents:[tom kite]]</p><p><strong>或者提前准备好类型</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name    <span class="type">string</span></span><br><span class="line">Age     <span class="type">int</span></span><br><span class="line">email   <span class="type">string</span></span><br><span class="line">Parents []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">`&#123;&quot;Name&quot;:&quot;张三&quot;,&quot;Age&quot;:11,&quot;Email&quot;:&quot;s@mail.com&quot;,&quot;Parents&quot;:[&quot;tom&quot;, &quot;kite&quot;]&#125;`</span></span><br><span class="line">b := []<span class="type">byte</span>(s)</span><br><span class="line"><span class="keyword">var</span> f Person</span><br><span class="line">err := json.Unmarshal(b, &amp;f)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;f: %T\n %v\n&quot;</span>, f, f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>f: main.Person<br>{张三 11  [tom kite]}</p><h3 id="3-4-io流Reader">3.4 io流Reader</h3><p>从文件读取json解析</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.Open(<span class="string">&quot;a.json&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">dec := json.NewDecoder(f)</span><br><span class="line"><span class="keyword">var</span> v <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">err2 := dec.Decode(&amp;v)</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;v: %v\n&quot;</span>, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>v: map[Age:11 <a href="mailto:Email:s@mail.com">Email:s@mail.com</a> Name:张三 Parents:[tom kite]]</p><p><strong>指定类型</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name    <span class="type">string</span></span><br><span class="line">Age     <span class="type">int</span></span><br><span class="line">email   <span class="type">string</span></span><br><span class="line">Parents []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.Open(<span class="string">&quot;a.json&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">dec := json.NewDecoder(f)</span><br><span class="line"><span class="keyword">var</span> v Person</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">err2 := dec.Decode(&amp;v)</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;v: %v\n&quot;</span>, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>v: {张三 11  [tom kite]}</p><h3 id="3-5-结构体写入文件">3.5 结构体写入文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name    <span class="type">string</span></span><br><span class="line">Age     <span class="type">int</span></span><br><span class="line">email   <span class="type">string</span></span><br><span class="line">Parents []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">p := Person&#123;</span><br><span class="line">Name:    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">Age:     <span class="number">22</span>,</span><br><span class="line">email:   <span class="string">&quot;e@mail.com&quot;</span>,</span><br><span class="line">Parents: []<span class="type">string</span>&#123;<span class="string">&quot;kit&quot;</span>, <span class="string">&quot;zzt&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">f, err := os.OpenFile(<span class="string">&quot;b.json&quot;</span>, os.O_WRONLY|os.O_CREATE, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">e := json.NewEncoder(f)</span><br><span class="line">e.Encode(&amp;p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库time</title>
      <link href="/20221223/golang-20221223-golang%E6%A0%87%E5%87%86%E5%BA%93time/"/>
      <url>/20221223/golang-20221223-golang%E6%A0%87%E5%87%86%E5%BA%93time/</url>
      
        <content type="html"><![CDATA[<p>time包提供测量和显示时间的功能</p><h2 id="1-基本使用">1. 基本使用</h2><p>打印显示出现在的时间<br>其中now为<code>time.Time</code>类型，Month为<code>time.Month</code>类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now() <span class="comment">// 获取当前时间</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;now: %v\n&quot;</span>, now)</span><br><span class="line">year := now.Year()</span><br><span class="line">month := now.Month()</span><br><span class="line">day := now.Day()</span><br><span class="line">hour := now.Hour()</span><br><span class="line">minute := now.Minute()</span><br><span class="line">second := now.Second()</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d\n&quot;</span>, year, month, day, hour, minute, second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>now: 2022-12-23 22:18:19.6534443 +0800 CST m=+0.003755601<br>2022-12-23 22:18:19</p><h2 id="2-时间戳">2. 时间戳</h2><p>在编程中对于时间戳的应用也尤为广泛，例如在web开发中做cookies有效期，接口加密，Redis中的key有效期等等，大部分都是使用到了时间戳。</p><p>时间戳是自1970年1月1日(08:00:00GMT)至当前时间的总毫秒数。它被称为Unix时间戳（UnixTimeStamp)</p><p>在Golang中获取时间戳</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now() <span class="comment">// 获取当前时间</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;now.Unix(): %v\n&quot;</span>, now.Unix())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>now.Unix(): 1671806040</p><p><strong>纳秒时间戳</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now().UnixNano() <span class="comment">// 获取当前时间</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;now: %v\n&quot;</span>, now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>now: 1671806136617680600</p><h2 id="3-时间戳转换">3. 时间戳转换</h2><p>在<code>go</code>语言中可以<code>time.Unix</code>来直接将时间戳转化为当前时间格式，实现瞬间转换</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">timestamp := time.Now().Unix() <span class="comment">// 获取当前时间</span></span><br><span class="line">t := time.Unix(timestamp, <span class="number">0</span>)   <span class="comment">// 将时间戳转为时间格式</span></span><br><span class="line">fmt.Println(t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>2022-12-23 22:39:40 +0800 CST</p><h2 id="4-时间操作">4. 时间操作</h2><h3 id="4-1-ADD">4.1 ADD</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(h, m, s, mls, msc, ns time.Duration)</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line">ret := now.Add(time.Hour*h + time.Minute*m + time.Second*s + time.Millisecond*mls + time.Microsecond*msc + time.Nanosecond*ns)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">Add(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ret: 2022-12-24 01:49:24.823784708 +0800 CST m=+11045.009693109</p><div class="note success no-icon flat"><p>在这里并不能增加年月日，仅能增加时分秒</p></div><h3 id="4-2-Sub">4.2 Sub</h3><p>时间相减</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line">t := now.Add(time.Hour)</span><br><span class="line">ret := t.Sub(now)</span><br><span class="line">fmt.Printf(<span class="string">&quot;now: %v\n&quot;</span>, now)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">sub()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>now: 2022-12-23 22:52:36.6196345 +0800 CST m=+0.003240001<br>ret: 1h0m0s</p><h3 id="4-3-Equal">4.3 Equal</h3><p>判断两个时间是否相同，会考虑时区的影响，因此不同时区标准的时间也可以正确比较</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">equal</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line">t := now.Add(time.Hour)</span><br><span class="line">ret := now.Equal(t)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">equal()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ret: false</p><h3 id="4-4-Before">4.4 Before</h3><p><code>func (t Time) Before(u Time) bool</code></p><p>如果t代表的时间点在u之前，返回真，否则返回假</p><h3 id="4-5-After">4.5 After</h3><p><code>func (t Time) After(u Time) bool</code></p><p>如果t代表的时间在u之后，返回真，否则返回假</p><h2 id="5-定时器">5. 定时器</h2><p>使用<code>time.Tick(时间戳)</code>来这是定时器，定时器的本质上是一个通道（channel）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ticker := time.Tick(time.Second * <span class="number">10</span>) <span class="comment">// 定义一个10秒间隔的定时器</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> ticker &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i) <span class="comment">// 每10秒执行一次任务</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果;</p><p>i: 2022-12-23 23:04:42.4054642 +0800 CST m=+10.017507601<br>i: 2022-12-23 23:04:52.4007804 +0800 CST m=+20.012823801</p><h2 id="6-时间格式化">6. 时间格式化</h2><p>时间类型有一个自带的方法<code>Format</code>进行格式化，需要注意的是Go语言中格式化时间模板不是常见的<code>Y-m-d H:M:S</code>而是使用Go的贪生时间2006年1月2号15点04分</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line"><span class="comment">// 24小时制</span></span><br><span class="line">fmt.Println(now.Format(<span class="string">&quot;2006-01-02 15:04:05.000 Mon Jan&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 12小时制</span></span><br><span class="line">fmt.Println(now.Format(<span class="string">&quot;2006-01-02 03:04:05.000 PM Mon Jan&quot;</span>))</span><br><span class="line">fmt.Println(<span class="string">&quot;2006-01-02 15:04&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;2006/01/02 15:04&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;15:04 2006/01/02&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;2006/01/02&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>2022-12-23 23:13:51.394 Fri Dec<br>2022-12-23 11:13:51.394 PM Fri Dec<br>2006-01-02 15:04<br>2006/01/02 15:04<br>15:04 2006/01/02<br>2006/01/02</p><div class="note success no-icon flat"><p>补充：如果想格式化为12小时方式，需要指定<code>PM</code></p></div><h2 id="7-解析字符串格式时间">7. 解析字符串格式时间</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line">fmt.Printf(<span class="string">&quot;now: %v\n&quot;</span>, now)</span><br><span class="line"><span class="comment">// 加载时区</span></span><br><span class="line">l, err := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 按照指定时区和指定格式解析字符串时间</span></span><br><span class="line">t, err2 := time.ParseInLocation(<span class="string">&quot;2006/01/02 15:04&quot;</span>, <span class="string">&quot;2022/12/23 23:19&quot;</span>, l)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;t: %v\n&quot;</span>, t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>now: 2022-12-23 23:19:55.3991544 +0800 CST m=+0.003196701<br>t: 2022-12-23 23:19:00 +0800 CST</p><h2 id="8-延迟执行">8. 延迟执行</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">tm := time.NewTimer(<span class="number">3</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> tm.Stop()</span><br><span class="line">fmt.Printf(<span class="string">&quot;time.Now(): %v\n&quot;</span>, time.Now())</span><br><span class="line">&lt;-tm.C</span><br><span class="line">fmt.Printf(<span class="string">&quot;time.Now(): %v\n&quot;</span>, time.Now())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>time.Now(): 2022-12-29 22:16:38.2135219 +0800 CST m=+0.004761801<br>time.Now(): 2022-12-29 22:16:41.226425 +0800 CST m=+3.017664901</p><p><strong>或者用time.After()</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;time.Now(): %v\n&quot;</span>, time.Now())</span><br><span class="line">&lt;-time.After(<span class="number">3</span> * time.Second)</span><br><span class="line">fmt.Printf(<span class="string">&quot;time.Now(): %v\n&quot;</span>, time.Now())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-打乱数组">9. 打乱数组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ret := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line">rand.Shuffle(<span class="built_in">len</span>(ret), <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">ret[i], ret[j] = ret[j], ret[i]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %v\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ret: [8 7 4 3 5 6 2 1]</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库sort包</title>
      <link href="/20221222/golang-20221222-golang%E6%A0%87%E5%87%86%E5%BA%93sort%E5%8C%85/"/>
      <url>/20221222/golang-20221222-golang%E6%A0%87%E5%87%86%E5%BA%93sort%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<p>sort包提供了排序切片和用户自动逸数据集以及相关功能的函数<br>sort包主要针对<code>[]int</code>、<code>[]float64</code>、<code>[]string</code>、以及其他自定义切片的排序</p><h2 id="1-结构体">1. 结构体</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> IntSlice <span class="keyword">struct</span></span><br><span class="line"><span class="keyword">type</span> Float64Slice</span><br><span class="line"><span class="keyword">type</span> StringSlice</span><br></pre></td></tr></table></figure><h2 id="2-函数">2. 函数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Ints</span><span class="params">(a []<span class="type">int</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IntsAreSorted</span><span class="params">(a []<span class="type">int</span>)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchInts</span><span class="params">(a []<span class="type">int</span>, x <span class="type">int</span>)</span></span> <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64s</span><span class="params">(a []<span class="type">float64</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64sAreSorted</span><span class="params">(a []<span class="type">float64</span>)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchFloat64s</span><span class="params">(a []<span class="type">float64</span>, x <span class="type">float64</span>)</span></span> <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Strings</span><span class="params">(a []<span class="type">string</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringsAreSorted</span><span class="params">(a []<span class="type">string</span>)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchStrings</span><span class="params">(a []<span class="type">string</span>, x <span class="type">string</span>)</span></span> <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Interface)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stable</span><span class="params">(data Interface)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reverse</span><span class="params">(data Interface)</span></span> <span class="keyword">interface</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ISSorted</span><span class="params">(data Interface)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Search</span><span class="params">(n <span class="type">int</span>, f <span class="keyword">func</span>(<span class="type">int</span>)</span></span> <span class="type">bool</span>) <span class="type">int</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := []<span class="type">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">6</span>&#125;</span><br><span class="line">sort.Ints(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">fmt.Println(sort.IntsAreSorted(i))</span><br><span class="line">fmt.Println(sort.SearchInts(i, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">f := []<span class="type">float64</span>&#123;<span class="number">5.34</span>, <span class="number">3.1</span>, <span class="number">4.2</span>, <span class="number">5</span>, <span class="number">5</span>&#125;</span><br><span class="line">sort.Float64s(f)</span><br><span class="line">fmt.Printf(<span class="string">&quot;f: %v\n&quot;</span>, f)</span><br><span class="line">fmt.Println(sort.Float64sAreSorted(f))</span><br><span class="line"></span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;你好&quot;</span>, <span class="string">&quot;golang&quot;</span>&#125;</span><br><span class="line">sort.Strings(s)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">fmt.Println(sort.StringsAreSorted(s))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>i: [1 2 3 4 5 6]<br>true<br>2<br>f: [3.1 4.2 5 5 5.34]<br>true<br>s: [golang 你好]<br>true</p><h3 id="3-自定义类型">3. 自定义类型</h3><p>接口</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Len() <span class="type">int</span>  <span class="comment">// Len方法返回集合中的元素个数</span></span><br><span class="line">    Less(i,j <span class="type">int</span>) <span class="type">bool</span> <span class="comment">// i&gt;j,该方法返回索引i的元素是否比索引j的元素小</span></span><br><span class="line">    Swap(i,j <span class="type">int</span>) <span class="comment">// 交换i，j的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NewInts []<span class="type">uint</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n NewInts)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n NewInts)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> n[i] &lt; n[j]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n NewInts)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">n[i], n[j] = n[j], n[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u := []<span class="type">uint</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">2</span>&#125;</span><br><span class="line">sort.Sort(NewInts(u))</span><br><span class="line">fmt.Printf(<span class="string">&quot;u: %v\n&quot;</span>, u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>u: [1 2 3 3 5]</p><h3 id="4-二维数组排序">4. 二维数组排序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> testSlice [][]<span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(l)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">l[i], l[j] = l[j], l[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> l[i][<span class="number">1</span>] &lt; l[j][<span class="number">1</span>]  <span class="comment">// 根据第一个元素进行排序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ls := testSlice&#123;</span><br><span class="line">&#123;<span class="number">1</span>, <span class="number">3</span>&#125;,</span><br><span class="line">&#123;<span class="number">2</span>, <span class="number">4</span>&#125;,</span><br><span class="line">&#123;<span class="number">2</span>, <span class="number">1</span>&#125;,</span><br><span class="line">&#123;<span class="number">5</span>, <span class="number">6</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">sort.Sort(ls)</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>[[1 3] [2 4] [2 1] [5 6]]<br>[[2 1] [1 3] [2 4] [5 6]]</p><h2 id="5-复杂类型排序">5. 复杂类型排序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> testSlice []<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(l)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">l[i], l[j] = l[j], l[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> l[i][<span class="string">&quot;a&quot;</span>] &lt; l[j][<span class="string">&quot;a&quot;</span>]   <span class="comment">// 根据key排序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ls := testSlice&#123;</span><br><span class="line">&#123;<span class="string">&quot;a&quot;</span>: <span class="number">4.2</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;a&quot;</span>: <span class="number">444</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;a&quot;</span>: <span class="number">32.2</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">sort.Sort(ls)</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>[map[a:4.2] map[a:444] map[a:32.2]]<br>[map[a:4.2] map[a:32.2] map[a:444]]</p><h2 id="6-结构体排序">6. 结构体排序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> People <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> testSlice []People</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(l)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">l[i], l[j] = l[j], l[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l testSlice)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> l[i].Age &lt; l[j].Age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ls := testSlice&#123;</span><br><span class="line">&#123;Name: <span class="string">&quot;张三&quot;</span>, Age: <span class="number">22</span>&#125;,</span><br><span class="line">&#123;Name: <span class="string">&quot;里斯&quot;</span>, Age: <span class="number">33</span>&#125;,</span><br><span class="line">&#123;Name: <span class="string">&quot;赵六&quot;</span>, Age: <span class="number">50</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">sort.Sort(ls)</span><br><span class="line">fmt.Println(ls)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>[{张三 22} {里斯 33} {赵六 50}]<br>[{张三 22} {里斯 33} {赵六 50}]</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库errors</title>
      <link href="/20221221/golang-20221221-golang%E6%A0%87%E5%87%86%E5%BA%93errors/"/>
      <url>/20221221/golang-20221221-golang%E6%A0%87%E5%87%86%E5%BA%93errors/</url>
      
        <content type="html"><![CDATA[<p>errors包实现了操作错误的函数。语言使用error类型来返回函数执行过程中遇到的错误，如果返回的error值为nil，则表示未遇到错误，否则error会返回一个字符串。用于说明遇到了什么错误。</p><h2 id="1-error结构">1. error结构</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">error</span> <span class="keyword">interface</span> &#123;</span><br><span class="line">    Error() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你可以用任何类型去实现它(只要添加一个Error()方法即可)，也就是说，error可以是任何类型，这意味着，函数返回的error值实际可以包含任意信息，不一定是字符串。</p><p>error不一定表示一个错误，它可以表示任何信息，比如io包中就用error类型的<code>io.EOF</code>表示数据读取结束，而不是遇到了什么错误。</p><p>errors包实现了一个最简单的error类型，只包含一个字符串，它可以记录大多数情况下遇到的错误信息，errors包的用法也很简单，只有一个<code>New</code>函数，用于生产一个最简单的error对象</p><p><code>func New(text string) error</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;errors&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(s <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> s == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">err := errors.New(<span class="string">&quot;字符串不能为空&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s, err := check(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>返回结果：</p><p>2022/12/21 17:58:32 字符串不能为空</p><h2 id="2-自定义error类型">2. 自定义error类型</h2><p>核心是实现Error()方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</span><br><span class="line">When time.Time</span><br><span class="line">What <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v: %v&quot;</span>, e.When, e.What)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">oops</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> MyError&#123;</span><br><span class="line">When: time.Now(),</span><br><span class="line">What: <span class="string">&quot;the file system has gone away&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := oops()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果:</p><p>2022-12-21 18:06:29.391674 +0800 CST m=+0.003703701: the file system has gone away</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库bytes</title>
      <link href="/20221221/golang-20221221-golang%E6%A0%87%E5%87%86%E5%BA%93bytes/"/>
      <url>/20221221/golang-20221221-golang%E6%A0%87%E5%87%86%E5%BA%93bytes/</url>
      
        <content type="html"><![CDATA[<p>bytes包提供了对<strong>字节切片</strong>进行读写操作的一系列函数，字节切片处理的函数比较多分为基本处理函数、比较函数、后缀检查函数、索引函数、分割函数、大小写处理函数和子切片处理函数等。</p><h2 id="1-常用函数-2">1. 常用函数</h2><p><strong>bytes.Contains</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := []<span class="type">byte</span>(<span class="string">&quot;golang.google.cn&quot;</span>)</span><br><span class="line">sublice1 := []<span class="type">byte</span>(<span class="string">&quot;golang.google&quot;</span>)</span><br><span class="line">sublice2 := []<span class="type">byte</span>(<span class="string">&quot;Golang.google&quot;</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(bytes.Contains(b, sublice1))</span><br><span class="line">fmt.Println(bytes.Contains(b, sublice2))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>true<br>false</p><p><strong>bytes.Count</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := []<span class="type">byte</span>(<span class="string">&quot;hellooooooooo&quot;</span>)</span><br><span class="line">sep1 := []<span class="type">byte</span>(<span class="string">&quot;h&quot;</span>)</span><br><span class="line">sep2 := []<span class="type">byte</span>(<span class="string">&quot;l&quot;</span>)</span><br><span class="line">sep3 := []<span class="type">byte</span>(<span class="string">&quot;o&quot;</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(bytes.Count(b, sep1))</span><br><span class="line">fmt.Println(bytes.Count(b, sep2))</span><br><span class="line">fmt.Println(bytes.Count(b, sep3))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>1<br>2<br>9</p><p><strong>bytes.Repeat</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := []<span class="type">byte</span>(<span class="string">&quot;hi&quot;</span>)</span><br><span class="line">fmt.Println(<span class="type">string</span>(bytes.Repeat(b, <span class="number">2</span>)))</span><br><span class="line">fmt.Println(<span class="type">string</span>(bytes.Repeat(b, <span class="number">10</span>)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果:</p><p>hihi<br>hihihihihihihihihihi</p><p><strong>bytes.Replace</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := []<span class="type">byte</span>(<span class="string">&quot;hello,world&quot;</span>)</span><br><span class="line">old := []<span class="type">byte</span>(<span class="string">&quot;o&quot;</span>)</span><br><span class="line"><span class="built_in">new</span> := []<span class="type">byte</span>(<span class="string">&quot;O&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bytes.Replace(b, old, <span class="built_in">new</span>, <span class="number">0</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bytes.Replace(b, old, <span class="built_in">new</span>, <span class="number">1</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bytes.Replace(b, old, <span class="built_in">new</span>, <span class="number">2</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bytes.Replace(b, old, <span class="built_in">new</span>, <span class="number">-1</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>hello,world<br>hellO,world<br>hellO,wOrld<br>hellO,wOrld</p><p><strong>byte.Runes</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := []<span class="type">byte</span>(<span class="string">&quot;hello 世界&quot;</span>)</span><br><span class="line">r := bytes.Runes(b)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;转换前字符串长度：&quot;</span>, <span class="built_in">len</span>(b))</span><br><span class="line">fmt.Println(<span class="string">&quot;转换后字符串长度：&quot;</span>, <span class="built_in">len</span>(r))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>转换前字符串长度： 12<br>转换后字符串长度： 8</p><p><strong>bytes.Join</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b1 := []<span class="type">byte</span>(<span class="string">&quot;你好&quot;</span>)</span><br><span class="line">b2 := []<span class="type">byte</span>(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">sep1 := []<span class="type">byte</span>(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">b := [][]<span class="type">byte</span>&#123;b1, b2&#125;</span><br><span class="line">ret := bytes.Join(b, sep1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ret: %s\n&quot;</span>, ret)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ret: 你好,golang</p><h2 id="2-Reader类型">2. Reader类型</h2><p>Reader实现了<code>io.Reader, io.ReaderAt, io.WriterTo, io.Seeker, io.ByteScanner, io.RuneScanner</code>接口，Reader是只读的、可以seek</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">data := <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="comment">// 通过[]byte创建Reader</span></span><br><span class="line">r := bytes.NewReader([]<span class="type">byte</span>(data))</span><br><span class="line"><span class="comment">// 返回未读取部分长度</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;r.Len(): %v\n&quot;</span>, r.Len())</span><br><span class="line"><span class="comment">// 返回底层数据总长度</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;r.Size(): %v\n&quot;</span>, r.Size())</span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">n, err := r.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="type">string</span>(buf[:n]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;====================================&quot;</span>)</span><br><span class="line"><span class="comment">// 设置偏移量</span></span><br><span class="line">r.Seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次读取一个字节</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">b, err := r.ReadByte()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;====================================&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.Seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">off := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定偏移量</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">n, err := r.ReadAt(buf, off)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">off += <span class="type">int64</span>(n)</span><br><span class="line">fmt.Println(off, <span class="type">string</span>(buf[:n]))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>r.Len(): 3<br>r.Size(): 3<br>12<br>3<br>====================================<br>1<br>2<br>3<br>====================================<br>2 12</p><h2 id="3-Buffer类型">3. Buffer类型</h2><p>缓冲区是具有读取和写入方法的可变大小的字节缓冲区。Buffer的零值是准备使用的空缓冲区。</p><h3 id="3-1-声明一个Buffer">3.1 声明一个Buffer</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b bytes.Buffer <span class="comment">// 直接定义一个Buffer变量，不用初始化，可以直接使用</span></span><br><span class="line">b := <span class="built_in">new</span>(bytes.Buffer) <span class="comment">// 使用New返回Buffer变量</span></span><br><span class="line">b := bytes.NewBuffer(s []<span class="type">byte</span>) <span class="comment">// 从一个[]byte切片，构造一个Buffer</span></span><br><span class="line">b := bytes.NewBufferString(s <span class="type">string</span>) <span class="comment">// 从一个string变量，构造一个Buffer</span></span><br></pre></td></tr></table></figure><h3 id="3-2-往Buffer中写入数据">3.2 往Buffer中写入数据</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b.Write(d []<span class="type">byte</span>) <span class="comment">// 将切片d写入Buffer尾部</span></span><br><span class="line">b.WriteString(s sting) <span class="comment">// 将字符串s写入Buffer尾部</span></span><br><span class="line">b.WriteByte(c <span class="type">byte</span>) <span class="comment">// 将字符c写入Buffer尾部</span></span><br><span class="line">b.WriteRune(r <span class="type">rune</span>) <span class="comment">// 将一个rune类型的数据写入缓冲区尾部</span></span><br><span class="line">b.WriteTo(w io.Writer) <span class="comment">// 将Buffer中的内容输出到实现了io.Writer接口的可写入对象中</span></span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>注：将文件中的内容写入Buffer,则使用ReadFrom(i io.Reader)</p></div><h3 id="3-3-从Buffer中读取数据">3.3 从Buffer中读取数据</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)</span><br><span class="line">b.Read(c) <span class="comment">// 一次读取8个byte到c容器中，每次读取新的8个byte覆盖c中原来的内容</span></span><br><span class="line">b.ReadByte() <span class="comment">// 读取第一个byte,b的第一个byte被拿掉，赋值给a =&gt; a,_ := b.ReadByte()</span></span><br><span class="line">b.ReadRune() <span class="comment">// 读取第一个rune，b的第一个rune被拿掉，赋值给r =&gt; r,_ := b.ReadRune()</span></span><br><span class="line">b.ReadBytes(delimiter <span class="type">byte</span>) <span class="comment">// 需要一个byte作为分隔符，读的时候从缓冲器里找第一个出现的分隔符(delim)，找到后，把从缓冲器头部开始到分隔符之间的所有byte进行返回，作为byte类型的slice，返回后，缓冲器也会空掉一部分</span></span><br><span class="line">b.ReadString(delimiter <span class="type">byte</span>) <span class="comment">//需要一个byte作为分隔符，读的时候从缓冲器里找第一个出现的分隔符(delim)，找到后，把从缓冲器头部开始到分隔符之间的所有byte进行返回，返回后，缓冲器也会空掉一部分</span></span><br><span class="line">b.ReadFrom(i io.Reader) <span class="comment">// 从一个实现io.Reader接口的r，把r里的内容读到缓冲器里，n返回读到的数量</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.Open(<span class="string">&quot;a.txt&quot;</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b := bytes.NewBufferString(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line"><span class="comment">// 将a.txt内容追加到缓冲器尾部</span></span><br><span class="line">b.ReadFrom(f)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, b.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>Hello World你好 golang</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库builtion</title>
      <link href="/20221219/golang-20221219-golang%E6%A0%87%E5%87%86%E5%BA%93builtion/"/>
      <url>/20221219/golang-20221219-golang%E6%A0%87%E5%87%86%E5%BA%93builtion/</url>
      
        <content type="html"><![CDATA[<p>这个包提供了一些类型声明、变量和常量声明，还有一些便利函数，这个包不需要导入，这些变量和函数就可以直接使用。</p><h2 id="1-常用函数">1. 常用函数</h2><h3 id="1-1-append">1.1 append</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(slice []<span class="keyword">type</span>, elems ...Type)</span></span> []Type</span><br><span class="line"></span><br><span class="line">slice = <span class="built_in">append</span>(slice, elem1, elem2)  <span class="comment">// 直接在slice后面添加单个元素，添加元素类型可以和slice相同，可以不同</span></span><br><span class="line">slice = <span class="built_in">append</span>(slice, anotherSlice...) <span class="comment">//直接将另外一个slice添加到slice后面，但其本质还是将anotherSlice中的元素一个一个添加到slice中。</span></span><br></pre></td></tr></table></figure><p><strong>实例</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">i = <span class="built_in">append</span>(i, <span class="number">4</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line"></span><br><span class="line">i2 := []<span class="type">int</span>&#123;<span class="number">7</span>, <span class="number">9</span>, <span class="number">9</span>&#125;</span><br><span class="line">i2 = <span class="built_in">append</span>(i2, i...)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i2: %v\n&quot;</span>, i2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>i: [1 3 4 5 4]<br>i2: [7 9 9 1 3 4 5 4]</p><h3 id="1-2-len">1.2 len</h3><p>返回数组、切片、字符串、通道的长度</p><h3 id="1-3-print、println">1.3 print、println</h3><p>打印输出到控制台</p><h3 id="1-4-panic">1.4 panic</h3><p>抛出一个panic异常</p><h3 id="1-5-new和make">1.5 new和make</h3><p><code>new</code>和<code>make</code>区别：</p><ol><li><code>make</code>只能用来分配及初始化类型为<code>slice</code>,<code>map</code>,<code>chan</code>的数据；<code>new</code>可以分配任意类型的数据</li><li><code>new</code>分配返回的是指针，即类型<code>*T</code>；<code>make</code>返回引用，即<code>T</code></li><li><code>new</code>分配的空间被清零，<code>make</code>分配后，会进行初始化</li></ol><p><strong>new</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := <span class="built_in">new</span>(<span class="type">bool</span>)</span><br><span class="line">fmt.Println(*b)</span><br><span class="line">i := <span class="built_in">new</span>(<span class="type">int</span>)</span><br><span class="line">fmt.Println(*i)</span><br><span class="line"></span><br><span class="line">s := <span class="built_in">new</span>(<span class="type">string</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %q\n&quot;</span>, *s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>false<br>0<br>s: “”</p><p><strong>make</strong></p><div class="note success no-icon flat"><p>内建函数make(T,args)与new(T)的用途不一样，它只用来创建slice,map和channel，并且返回一个初始化(而不是置零)，类型为T的值(而不是*T)。之所以有所不同，是因为这三个类型的背后引用了使用前必须初始化的数据结构。例如，slice是一个三元描述符，包含一个指向数组的指针，长度，以及容量，在这些项被初始化之前，slice都是nil。对于slice、map、channel，make初始化这些内部数据结构，并准备号可用的值</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>分配一个有100个int的数组，然后创建一个长度为10,容量为100的切片，该切片引用包含前10个元素的数组。对应的，new([]int)返回一个指向新分配的，被置零的slice结构的指针，即指向为nil的slice的指针</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库log</title>
      <link href="/20221219/golang-20221219-golang%E6%A0%87%E5%87%86%E5%BA%93log/"/>
      <url>/20221219/golang-20221219-golang%E6%A0%87%E5%87%86%E5%BA%93log/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-2">1. 简介</h2><p>golang内置了<code>log</code>包，实现简单的日志服务。通过调用<code>log</code>包的函数，可以实现简单的日志打印功能。</p><h2 id="2-log使用">2. log使用</h2><p>log包中有3个系列的日志打印函数，分别<code>print</code>系列、<code>panic</code>系列、<code>fatal</code>系列</p><table><thead><tr><th>函数系列</th><th>作用</th></tr></thead><tbody><tr><td>print</td><td>单纯打印日志</td></tr><tr><td>panic</td><td>打印日志，抛出panic异常</td></tr><tr><td>fatal</td><td>打印日志，强制结束程序（os.Exit(1)）,<code>defer</code>函数不会执行</td></tr></tbody></table><h2 id="3-实例">3. 实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;发生了 panic错误。&quot;</span>)</span><br><span class="line">log.Print(<span class="string">&quot;my log&quot;</span>)</span><br><span class="line">log.Printf(<span class="string">&quot;my log %d\n&quot;</span>, <span class="number">100</span>)</span><br><span class="line">name := <span class="string">&quot;tom&quot;</span></span><br><span class="line">age := <span class="number">20</span></span><br><span class="line">log.Println(name, <span class="string">&quot;,&quot;</span>, age)</span><br><span class="line">log.Panic(<span class="string">&quot;致命错误&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;end....&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>2022/12/19 22:28:52 my log<br>2022/12/19 22:28:52 my log 100<br>2022/12/19 22:28:52 tom , 20<br>2022/12/19 22:28:52 致命错误<br>发生了 panic错误。<br>panic: 致命错误</p><p>goroutine 1 [running]:<br>log.Panic({0xc000109f00?, 0x3?, 0xc000109f00?})<br>C:/Program Files/Go/src/log/log.go:388 +0x65<br>main.main()<br>d:/github/GO_PRO/main.go:15 +0x195<br>exit status 2</p><h2 id="4-log配置">4. log配置</h2><h3 id="4-1-标准log配置">4.1 标准log配置</h3><p>默认情况下log只会打印出时间，但是实际情况下我们可能还需要获取文件名，行号等信息，log包提供给我定制的接口<br>log包提供两个标准log配置相关方法：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flags</span><span class="params">()</span></span> <span class="type">int</span> <span class="comment">//返回标准log输出配置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetFlags</span><span class="params">(flag <span class="type">int</span>)</span></span> <span class="comment">// 设置标志log输出配置</span></span><br></pre></td></tr></table></figure><p><strong>flag参数</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">Ldate         = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span>     <span class="comment">// the date in the local time zone: 2009/01/23</span></span><br><span class="line">Ltime                         <span class="comment">// the time in the local time zone: 01:23:23</span></span><br><span class="line">Lmicroseconds                 <span class="comment">// microsecond resolution: 01:23:23.123123.  assumes Ltime.</span></span><br><span class="line">Llongfile                     <span class="comment">// full file name and line number: /a/b/c/d.go:23</span></span><br><span class="line">Lshortfile                    <span class="comment">// final file name element and line number: d.go:23. overrides Llongfile</span></span><br><span class="line">LUTC                          <span class="comment">// if Ldate or Ltime is set, use UTC rather than the local time zone</span></span><br><span class="line">Lmsgprefix                    <span class="comment">// move the &quot;prefix&quot; from the beginning of the line to before the message</span></span><br><span class="line">LstdFlags     = Ldate | Ltime <span class="comment">// initial values for the standard logger</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.SetFlags(log.Ldate | log.Ltime | log.Lmicroseconds | log.Lshortfile)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := log.Flags()</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">log.Println(<span class="string">&quot;this is a log&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>i: 23<br>2022/12/19 22:44:52.651161 main.go:15: this is a log</p><h3 id="4-2-日志前缀配置">4.2 日志前缀配置</h3><p>log包提供两个日志前缀相关函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Prefix</span><span class="params">()</span></span> <span class="type">string</span> <span class="comment">// 返回日志的前缀配置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetPrefix</span><span class="params">(prefix <span class="type">string</span>)</span></span> <span class="comment">// 设置日志前缀</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.SetFlags(log.Ldate | log.Ltime | log.Lmicroseconds | log.Lshortfile)</span><br><span class="line">log.SetPrefix(<span class="string">&quot;Mylog: &quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := log.Flags()</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">log.Println(<span class="string">&quot;this is a log&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>Mylog: 2022/12/19 22:49:59.694932 main.go:16: this is a log</p><h3 id="4-3-日志输出位置配置">4.3 日志输出位置配置</h3><p>golang的log包还支持将日志输出到文件中，log包提供了<code>func SetOutPut(w io.Writer)</code>函数，将日志输出到文件中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.SetFlags(log.Ldate | log.Ltime | log.Lmicroseconds | log.Lshortfile)</span><br><span class="line">log.SetPrefix(<span class="string">&quot;Mylog: &quot;</span>)</span><br><span class="line">f, err := os.OpenFile(<span class="string">&quot;a.log&quot;</span>, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0664</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">log.SetOutput(f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := log.Flags()</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">log.Println(<span class="string">&quot;this is a log&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库io包</title>
      <link href="/20221213/golang-20221213-golang%E6%A0%87%E5%87%86%E5%BA%93io%E5%8C%85/"/>
      <url>/20221213/golang-20221213-golang%E6%A0%87%E5%87%86%E5%BA%93io%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<p>Go语言中，为了方便开发者使用，将IO操作封装在了如下几个包中：</p><ul><li>io为IO原语(I/O primitives)提供基本的接口</li><li>io/ioutil封装一些实用的I/O函数</li><li>fmt实现格式化I/O，类似C语言中的printf和scanf</li><li>bufio实现带缓冲I/O</li></ul><h2 id="1-基本的IO接口">1. 基本的IO接口</h2><p>在io包中最重要的两个接口：Reader和Writer接口，所提到的各种IO包，都跟这两个接口有关，也就说，只要实现了这两个接口，他就有了IO的功能</p><h3 id="1-1-Reader接口">1.1 Reader接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-Writer接口">1.2 Writer接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-哪些类型实现了Reader和Writer接口">1.3 哪些类型实现了Reader和Writer接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">os.File 同时实现了io.Reader和io.Writer</span><br><span class="line">strings.Reader 实现了io.Reader</span><br><span class="line">bufio.Reader/Writer 分别实现了io.Reader和io.Writer</span><br><span class="line">bytes.Buffer 同时实现了io.Reader和io.Writer</span><br><span class="line">bytes.Reader 实现了io.Reader</span><br><span class="line">compress/gzio.Reader/Writer 分别实现了io.Reader和io。Writer</span><br><span class="line">crypto/cipher.StreamReader/StreamWriter 分别实现了io.Reader和io.Writer</span><br><span class="line">crypto/tls.Conn 同时实现了io.Reader和io.Writer</span><br><span class="line">encoding/csv.Reader/Writer 分别实现了io.Reader和io.Writer</span><br></pre></td></tr></table></figure><h2 id="2-io-ioutil包">2. io/ioutil包</h2><p>封装一些实用的I/O函数</p><table><thead><tr><th>名称</th><th>作用</th></tr></thead><tbody><tr><td>ReadAll</td><td>读取数据，返回读到的字节slice</td></tr><tr><td>ReadDir</td><td>读取一个目录，返回目录入口数据[]os.FileInfo</td></tr><tr><td>ReadFile</td><td>读一个文件，返回文件内容(字节slice)</td></tr><tr><td>WriteFile</td><td>根据文件路径，写入字节slice</td></tr><tr><td>TempDir</td><td>在一个目录中创建指定前缀名的临时目录，返回新目录的路径</td></tr><tr><td>TempFile</td><td>在一个目录中创建指定前缀名的临时文件，返回os.File</td></tr></tbody></table><h3 id="2-1-实例">2.1 实例</h3><p><strong>ReadAll</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;Go is a general-purpose language designed with systems programming in mind.&quot;</span>)</span><br><span class="line"></span><br><span class="line">b, err := ioutil.ReadAll(r)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;%s&quot;</span>, b)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>Go is a general-purpose language designed with systems programming in mind.</p><p><strong>读取文件</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.Open(<span class="string">&quot;test2.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">b, err := ioutil.ReadAll(f)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;%s&quot;</span>, b)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>遍历当前目录</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fi, err := ioutil.ReadDir(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> fi &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;v.Name(): %v\n&quot;</span>, v.Name())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>读取文件</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b, err := ioutil.ReadFile(<span class="string">&quot;./test2.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;string(b): %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>写文件</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := ioutil.WriteFile(<span class="string">&quot;./a.txt&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;hehe&quot;</span>), <span class="number">0664</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">b, err2 := os.ReadFile(<span class="string">&quot;./a.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;string(b): %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-bufio-读相关操作">3. bufio 读相关操作</h2><p>bufio包实现了有缓冲的I/O，它包装了一个io.Reader或io.Writer接口对象，创建另一个也实现了该接口，且同时还提供了缓冲和一些文本I/O的帮助函数对象。</p><h3 id="3-1-type-Reader">3.1 type Reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">struct</span> &#123;</span><br><span class="line">buf          []<span class="type">byte</span></span><br><span class="line">rd           io.Reader <span class="comment">// reader provided by the client</span></span><br><span class="line">r, w         <span class="type">int</span>       <span class="comment">// buf read and write positions</span></span><br><span class="line">err          <span class="type">error</span></span><br><span class="line">lastByte     <span class="type">int</span> <span class="comment">// last byte read for UnreadByte; -1 means invalid</span></span><br><span class="line">lastRuneSize <span class="type">int</span> <span class="comment">// size of last rune read for UnreadRune; -1 means invalid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>Reader实现了给一个io.Reader接口对象附加缓冲</p></div><h3 id="3-2-func-NewReader">3.2 func NewReader</h3><p><code>func NewReader(rd io.Reader) *Reader</code></p><div class="note success no-icon flat"><p>NewReader创建一个具有默认大小缓冲，从r读取的*Reader。NewReader相当于NewReaderSize(rd,4096)</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;this is a test message&quot;</span>)</span><br><span class="line">    <span class="comment">// 转换成带缓冲的*Reader接口</span></span><br><span class="line">r2 := bufio.NewReader(r)</span><br><span class="line">b, _ := ioutil.ReadAll(r2)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %s\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-func-NewReaderSize">3.3 func NewReaderSize</h3><p><code>func NewReaderSize(rd io.Reader, size int) *Reader</code></p><div class="note success no-icon flat"><p>NewReaderSize创建一个具有最少有size尺寸的缓冲、从r读取的Reader.如果参数r已经是一个具有足够大缓冲的Reader类型值，会返回r</p></div><h3 id="3-4-func-Reader-Read">3.4 func (*Reader)Read</h3><p><code>func (b *Reader) Reset(r io.Reader) </code></p><div class="note success no-icon flat"><p>Rest丢弃缓冲中的数据，清除任何错误，将b重设为其下层从r读取数据</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;ABCD&quot;</span>)</span><br><span class="line">str := strings.NewReader(<span class="string">&quot;abcd&quot;</span>)</span><br><span class="line">br := bufio.NewReader(s)</span><br><span class="line">b, _ := ioutil.ReadAll(br)</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %s\n&quot;</span>, b)</span><br><span class="line">br.Reset(str)</span><br><span class="line">b2, _ := ioutil.ReadAll(str)</span><br><span class="line">fmt.Printf(<span class="string">&quot;b2: %s\n&quot;</span>, b2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-func-Reader-Read">3.5 func (*Reader)Read</h3><p><code>func (b *Reader) Read(p []byte) (n int, err error)</code></p><div class="note success no-icon flat"><p>Read读取数据写入p，本方法返回写入p的字节数，本方法一次调用最多会调用下层Reader接口一次Read方法，因此返回值n可能小于len§。读取到达结尾时，返回值n将为0而err将为io.EOF</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;ABCEEEWJREW&quot;</span>)</span><br><span class="line">r := bufio.NewReader(s)</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">n, err := r.Read(b)</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s&quot;</span>, b[:n])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ABCEEEWJREW</p><h3 id="3-6-func-Reader-ReadByte">3.6 func (*Reader)ReadByte</h3><p><code>func (b *Reader) ReadByte() (c byte, err error)</code></p><div class="note success no-icon flat"><p>ReadByte读取并返回一个字节。如果没有可用的数据，会返回错误</p></div><h3 id="3-7-func-Reader-UnreadByte">3.7 func (*Reader)UnreadByte</h3><p><code>func (b *Reader) UnreadByte() error</code></p><div class="note success no-icon flat"><p>UnreadByte吐出最近一次读取操作读取的最后一个字节。(只能吐出最后一个，多次调用会出问题)</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;ABCD&quot;</span>)</span><br><span class="line">r := bufio.NewReader(s)</span><br><span class="line">b, _ := r.ReadByte()</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %c\n&quot;</span>, b)</span><br><span class="line"></span><br><span class="line">b2, _ := r.ReadByte()</span><br><span class="line">fmt.Printf(<span class="string">&quot;b2: %c\n&quot;</span>, b2)</span><br><span class="line"></span><br><span class="line">err := r.UnreadByte() <span class="comment">// 吐出一个字符</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">b3, _ := r.ReadByte()</span><br><span class="line">fmt.Printf(<span class="string">&quot;b3: %c\n&quot;</span>, b3)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>b: A<br>b2: B<br>b3: B</p><h3 id="3-8-func-Reader-ReadRunne">3.8 func (* Reader)ReadRunne</h3><p><code>func (b *Reader) ReadRune() (r rune, size int, err error)</code></p><div class="note success no-icon flat"><p>ReadRune读取一个utf-8编码的unicode码值，返回该码值、其编码长度和可能的错误。如果utf-8编码非法、读取位置只能移动1字节，返回U+FFFD，返回值size为1而err为nil，如果没有可用的数据，会返回错误。</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;你好 golang&quot;</span>)</span><br><span class="line">br := bufio.NewReader(s)</span><br><span class="line"></span><br><span class="line">r, size, _ := br.ReadRune()</span><br><span class="line">fmt.Printf(<span class="string">&quot;r: %c,size: %d\n&quot;</span>, r, size)</span><br><span class="line">r2, size, _ := br.ReadRune()</span><br><span class="line">fmt.Printf(<span class="string">&quot;r2: %c,size: %d\n&quot;</span>, r2, size)</span><br><span class="line">r3, size, _ := br.ReadRune()</span><br><span class="line">fmt.Printf(<span class="string">&quot;r3: %c,size: %d\n&quot;</span>, r3, size)</span><br><span class="line">r4, size, _ := br.ReadRune()</span><br><span class="line">fmt.Printf(<span class="string">&quot;r4: %c,size: %d\n&quot;</span>, r4, size)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>r: 你,size: 3<br>r2: 好,size: 3<br>r3:  ,size: 1<br>r4: g,size: 1</p><h3 id="3-9-func-Reader-ReadLine">3.9 func (*Reader)ReadLine</h3><p><code>func (b *Reader) ReadLine() (line []byte, isPrefix bool, err error)</code></p><div class="note success no-icon flat"><p>ReadLine是一个低水平的行数据读取原语。大多数调用者应使用ReadBytes(“\n”)或ReadString(“\n”)代替，或者使用Scanner</p><p>ReadLine尝试返回一行数据，不包括行尾标志的字节。如果行太长超过了缓冲，返回值isPrefix会被设为true，并返回行的前面一部分。该行剩下的部分将在之后调用中返回。返回值isPrefix会在返回改行最后一个片段时才设为false.返回切片时缓冲的子切片，只在下一次读取操作之前有效。ReadLine要么返回一个非nil的line，要么返回一个非nil的err,两个返回值至少一个非nil</p><p>返回的文本不好含行尾的标志字节（“\n&quot;或”\r\n&quot;）.如果输入流结束时没有行尾标志字节，方法不会出错，也不会指出这一情况，在调用ReadLine之后调用UnreadByte会总是吐出最后一个读取的字节（很可能时该行行尾标志字节），即使该字节不是ReadLine返回值的一部分。</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;你好\ngolang\n&quot;</span>)</span><br><span class="line">br := bufio.NewReader(s)</span><br><span class="line"></span><br><span class="line">line, isPrefix, _ := br.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">&quot;line: %s,isPrefix: %v\n&quot;</span>, line, isPrefix)</span><br><span class="line">line2, isPrefix, _ := br.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">&quot;line2: %s,isPrefix: %v\n&quot;</span>, line2, isPrefix)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>line: 你好,isPrefix: false<br>line2: golang,isPrefix: false</p><h3 id="3-10-func-Reader-ReadSlice">3.10 func (*Reader)ReadSlice</h3><p><code>func (b *Reader) ReadSlice(delim byte) (line []byte, err error)</code></p><div class="note success no-icon flat"><p>ReadSlice读取直到第一次遇到delim字节，返回缓冲里包含已读取的数据和delim字节的切片。该返回值只在下一次读取操作之前合法。如果ReadSlice放在读取到delim之前遇到了错误，它会返回在错误之前读取的数据在缓冲中的切片以及该错误（一般时io.EOF）.如果在读取到delim之前缓冲就被写满了，ReadSlice失败并返回ErrBufferFull。因为ReadSlice的返回值被下一次I/O操作重写，调用者应尽量使用ReadBytes或ReadString代替本方法。当且仅当ReadBytes方法返回的切片不以delim结尾时，会返回一个非nil的错误</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;你好,golang,&quot;</span>)</span><br><span class="line">br := bufio.NewReader(s)</span><br><span class="line">line, _ := br.ReadSlice(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;line: %s\n&quot;</span>, line)</span><br><span class="line">line2, _ := br.ReadSlice(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;line2: %s\n&quot;</span>, line2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>line: 你好,<br>line2: golang,</p><h3 id="3-11-func-Reader-ReadBytes">3.11 func (*Reader)ReadBytes</h3><p><code>func (b *Reader) ReadBytes(delim byte) ([]byte, error)</code></p><div class="note success no-icon flat"><p>ReadBytes读取直到第一次遇到delim字节，返回一个包含一度去的数据和delim字节的切片。如果ReadBytes方法在读取到delim之前遇到了错误，它会返回在错误之前读取的数据以及该错误（一般时io.EOF）.当且仅当ReadBytes方法返回的切片不以delim结尾时，会返回一个非nil的错误</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">&quot;你好，golang,&quot;</span></span><br><span class="line">r := strings.NewReader(s)</span><br><span class="line">br := bufio.NewReader(r)</span><br><span class="line">line, _ := br.ReadBytes(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;line: %s\n&quot;</span>, line)</span><br><span class="line">line2, _ := br.ReadBytes(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;line2: %s\n&quot;</span>, line2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>line: 你好,<br>line2: golang,</p><h3 id="3-12-func-Reader-ReadString">3.12 func (*Reader)ReadString</h3><p><code>func (b *Reader) ReadString(delim byte) (string, error)</code></p><div class="note success no-icon flat"><p>ReadString读取直到第一次遇到delim字节，返回一个包含已读数据和delim字节的字符串。如果ReadString方法在读取到delim之前遇到了错误，它会返回在错误之前读取的数据以及该错误（一般时io.EOF）。当且仅当ReadString方法返回的切片不以delim结尾时，会返回一个非nil的错误</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">&quot;你好,golang,&quot;</span></span><br><span class="line">r := strings.NewReader(s)</span><br><span class="line">br := bufio.NewReader(r)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">line, err := br.ReadString(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;line: %v\n&quot;</span>, line)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>line: 你好,<br>line: golang,</p><h3 id="3-13-func-Reader-WriteTo">3.13 func (*Reader)WriteTo</h3><p><code>func (b *Reader) WriteTo(w io.Writer) (n int64, err error)</code></p><div class="note success no-icon flat"><p>WriteTo方法实现了io.WriterTo接口</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := strings.NewReader(<span class="string">&quot;abcdEFDG&quot;</span>)</span><br><span class="line">r := bufio.NewReader(s)</span><br><span class="line">b := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">r.WriteTo(b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %v\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>b: abcdEFDG</p><h2 id="4-bufio-写相关操作">4. bufio 写相关操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Writer <span class="keyword">struct</span> &#123;</span><br><span class="line">    err <span class="type">error</span></span><br><span class="line">    buf []<span class="type">byte</span></span><br><span class="line">    n   <span class="type">int</span></span><br><span class="line">    wr  io.Writer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>Writer实现了为io.Writer接口对象提供缓冲。如果在向一个Writer类型值写入时遇到了错误，该对象将不再接受任何数据，且所有写操作都会返回该错误，再说有数据都写入后，调用者有义务调用Flush方法以切薄所有数据都交给了下层的io.Writer</p></div><h3 id="4-1-func-NewWriter">4.1 func NewWriter</h3><p><code>func NewWriter(w io.Writer) *Writer</code></p><div class="note success no-icon flat"><p>NewWriter创建一个具有默认大小缓冲、写入w的*Writer。NewWriter相当于NewWriterSize(wr,4096)</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.OpenFile(<span class="string">&quot;a.txt&quot;</span>, os.O_RDWR, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">w := bufio.NewWriter(f)</span><br><span class="line">w.WriteString(<span class="string">&quot;你好 golang&quot;</span>)</span><br><span class="line">w.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-2-func-NewWriterSize">4.2 func NewWriterSize</h3><p><code>func NewWriterSize(w io.Writer, size int) *Writer</code></p><div class="note success no-icon flat"><p>NewWriterSize创建一个具有最少有size尺寸的缓冲、写入w的Writer。如果参数w已经是一个具有足够大缓冲的Writer类型值，会返回w</p></div><h3 id="4-3-func-Writer-Reset">4.3 func (*Writer)Reset</h3><p><code>func (b *Writer) Reset(w io.Writer)</code></p><div class="note success no-icon flat"><p>Reset丢弃缓冲中的数据，清除任何错误，将b重设为将其输出写入w</p></div><h3 id="4-4-func-Writer-Bufferd">4.4 func (*Writer)Bufferd</h3><p><code>func (b *Writer) Buffered() int</code></p><div class="note success no-icon flat"><p>Buffered返回缓冲中已使用的字节数</p></div><h3 id="4-5-func-Writer-Available">4.5 func(*Writer)Available</h3><p><code>func (b *Writer) Available() int</code></p><div class="note success no-icon flat"><p>Available返回缓冲中还有多少字节未使用</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>))</span><br><span class="line">w := bufio.NewWriter(b)</span><br><span class="line">fmt.Println(w.Available())</span><br><span class="line">fmt.Println(w.Buffered())</span><br><span class="line"></span><br><span class="line">w.WriteString(<span class="string">&quot;ABCDEFGHIGK&quot;</span>)</span><br><span class="line">fmt.Println(w.Available())</span><br><span class="line">fmt.Println(w.Buffered())</span><br><span class="line"></span><br><span class="line">w.Flush()</span><br><span class="line">fmt.Println(w.Available())</span><br><span class="line">fmt.Println(w.Buffered())</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %v\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>4096<br>0<br>4085<br>11<br>4096<br>0<br>b: ABCDEFGHIGK</p><h3 id="4-5-func-Writer-Write">4.5 func(*Writer)Write</h3><p><code>func (b *Writer) Write(p []byte) (nn int, err error)</code></p><div class="note success no-icon flat"><p>Write将p的内容写入缓冲，返回写入的字节数。如果返回值nn &lt; len§,还会返回一个错误说明原因</p></div><h3 id="4-5-func-Writer-WriteString">4.5 func(*Writer)WriteString</h3><p><code>func (b *Writer) WriteString(s string) (int, error)</code></p><div class="note success no-icon flat"><p>WriteString写入一个字符串。返回写入的字节数。如果返回值nn &lt; len(s),还会返回一个错误说明原因</p></div><h3 id="4-6-func-Writer-WriteByte">4.6 func(*Writer)WriteByte</h3><p><code>func (b *Writer) WriteByte(c byte) error</code></p><div class="note success no-icon flat"><p>WriteByte写入单个字节</p></div><h3 id="4-7-func-Writer-WriteRune">4.7 func(*Writer)WriteRune</h3><p><code>func (b *Writer) WriteRune(r rune) (size int, err error)</code></p><div class="note success no-icon flat"><p>WriteRune写入一个unicode码值，返回写入的字节数和可能的错误</p></div><h3 id="4-8-func-Writer-Flush">4.8 func(*Writer)Flush</h3><p><code>func (b *Writer) Flush() error</code></p><div class="note success no-icon flat"><p>Flush方法将缓冲中的数据写入下层的io.Writer接口</p></div><h3 id="4-8-func-Writer-ReadFrom">4.8 func(*Writer)ReadFrom</h3><p><code>func (b *Writer) ReadFrom(r io.Reader) (n int64, err error)</code></p><div class="note success no-icon flat"><p>ReadFrom实现了io.ReaderFrom接口，无需flush</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>))</span><br><span class="line">w := bufio.NewWriter(b)</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;hello 世界&quot;</span>)</span><br><span class="line">w.ReadFrom(r)</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %v\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>b: hello 世界</p><h3 id="4-9-func-NewReadWriter">4.9 func NewReadWriter</h3><p><code>func NewReadWriter(r *Reader, w *Writer) *ReadWriter</code></p><div class="note success no-icon flat"><p>ReadWriter申请创建一个新的、将读写操作分派给r和w的ReadWriter</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>))</span><br><span class="line">w := bufio.NewWriter(b)</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;123&quot;</span>)</span><br><span class="line">r2 := bufio.NewReader(r)</span><br><span class="line"></span><br><span class="line">rw := bufio.NewReadWriter(r2, w)</span><br><span class="line">s, _ := rw.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">rw.WriteString(<span class="string">&quot;adwerw&quot;</span>)</span><br><span class="line">rw.Flush()</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %v\n&quot;</span>, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>s: 123<br>b: adwerw</p><h2 id="5-Scanner">5. Scanner</h2><p>type Scanner</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scanner <span class="keyword">struct</span> &#123;</span><br><span class="line">r    io.Reader</span><br><span class="line">split SplitFunc</span><br><span class="line">maxTokenSize <span class="type">int</span></span><br><span class="line">token  []<span class="type">byte</span></span><br><span class="line">buf []<span class="type">byte</span></span><br><span class="line">start <span class="type">int</span></span><br><span class="line">end <span class="type">int</span></span><br><span class="line">err <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note success no-icon flat"><p>Scanner类型提供了方便的读取数据的接口，如从换行符分割的文本里读取每一行。成功调用的Scan方法会逐步提供文件的token，跳过token之间的字节。token由SplitFunc类型的分割函数指定；默认的分割函数会将输入分割为多个行，并去掉行尾的换行标志。</p></div><h3 id="5-1-func-NewScanner">5.1 func NewScanner</h3><p><code>func NewScanner(r io.Reader) *Scanner</code></p><div class="note success no-icon flat"><p>NewScanner创建并返回一个从r读取数据的Scanner,默认的分割函数时ScanLines</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bufio&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;abcd efg hijk&quot;</span>)</span><br><span class="line">bs := bufio.NewScanner(r)</span><br><span class="line">bs.Split(bufio.ScanWords)</span><br><span class="line"><span class="keyword">for</span> bs.Scan() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;bs.Text(): %v\n&quot;</span>, bs.Text())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>bs.Text(): abcd<br>bs.Text(): efg<br>bs.Text(): hijk</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang标准库os模块</title>
      <link href="/20221212/golang-20221212-golang%E6%A0%87%E5%87%86%E5%BA%93os%E6%A8%A1%E5%9D%97/"/>
      <url>/20221212/golang-20221212-golang%E6%A0%87%E5%87%86%E5%BA%93os%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<p>os标准库实现了平台(操作系统)相关的编程接口</p><h2 id="1-文件目录相关">1. 文件目录相关</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createFile</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> f, err := os.Create(<span class="string">&quot;test.txt&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;f: %v\n&quot;</span>, f)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createDir</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 创建单个目录</span></span><br><span class="line">err := os.Mkdir(<span class="string">&quot;test&quot;</span>, os.ModePerm)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 递归创建目录</span></span><br><span class="line"><span class="keyword">if</span> err := os.MkdirAll(<span class="string">&quot;test2/a/b&quot;</span>, os.ModePerm); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeDir</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 删除文件或空目录</span></span><br><span class="line"><span class="comment">// if err := os.Remove(&quot;test.txt&quot;); err != nil &#123;</span></span><br><span class="line"><span class="comment">// log.Fatal(err)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">if</span> err := os.Remove(<span class="string">&quot;test&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 递归删除</span></span><br><span class="line"><span class="keyword">if</span> err := os.RemoveAll(<span class="string">&quot;test2&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">walk</span><span class="params">(path <span class="type">string</span>)</span></span> ([]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> fileInfos, err := ioutil.ReadDir(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ret := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> _, fileInfo := <span class="keyword">range</span> fileInfos &#123;</span><br><span class="line"><span class="keyword">if</span> fileInfo.IsDir() &#123; <span class="comment">//如果是目录，就递归子遍历</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;子目录: %v\n&quot;</span>, fileInfo.Name())</span><br><span class="line"><span class="keyword">if</span> _, err := walk(filepath.Join(path, fileInfo.Name())); err != <span class="literal">nil</span> &#123; <span class="comment">//通过filepath.Join连接父目录和当前目录</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ret = <span class="built_in">append</span>(ret, filepath.Join(path, fileInfo.Name()))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取工作目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getWd</span><span class="params">()</span></span> &#123;</span><br><span class="line">dir, err := os.Getwd()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(dir)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改工作目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chWd</span><span class="params">()</span></span> &#123;</span><br><span class="line">err := os.Chdir(<span class="string">&quot;d:/&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取临时目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getTemp</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := os.TempDir()</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重命名文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">renameFile</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := os.Rename(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test2.txt&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFile</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> b, err := os.ReadFile(<span class="string">&quot;test2.txt&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;b: %v\n&quot;</span>, <span class="type">string</span>(b))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeFile</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">&quot;你好 golang&quot;</span></span><br><span class="line">os.WriteFile(<span class="string">&quot;test2.txt&quot;</span>, []<span class="type">byte</span>(s), os.ModePerm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readDir</span><span class="params">()</span></span> &#123;</span><br><span class="line">de, err := os.ReadDir(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> de &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;v.IsDir(): %v\n&quot;</span>, v.IsDir())</span><br><span class="line">fmt.Printf(<span class="string">&quot;v.Name: %v\n&quot;</span>, v.Name())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">createFile()</span><br><span class="line">createDir()</span><br><span class="line">removeDir()</span><br><span class="line">getWd()</span><br><span class="line">getTemp()</span><br><span class="line">renameFile()</span><br><span class="line">writeFile()</span><br><span class="line">readFile()</span><br><span class="line">    readDir()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>f: &amp;{0xc000004a00}<br>d:\github\GO_PRO<br>s: C:\Users\ren\AppData\Local\Temp<br>b: 你好 golang<br>hev.IsDir(): true<br><a href="http://v.Name">v.Name</a>: b<br>v.IsDir(): true<br><a href="http://v.Name">v.Name</a>: c</p><h2 id="2-File文件读操作">2. File文件读操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开关闭文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">openCloseFile</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 只读</span></span><br><span class="line">f, err := os.Open(<span class="string">&quot;test2.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;f.Name(): %v\n&quot;</span>, f.Name())</span><br><span class="line">f.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据第二个参数，可以读写或者创建</span></span><br><span class="line">f2, err := os.OpenFile(<span class="string">&quot;a1.txt&quot;</span>, os.O_RDWR|os.O_CREATE, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">defer</span> f2.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;f2.Name(): %v\n&quot;</span>, f2.Name())</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readOps</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 循环读取</span></span><br><span class="line">f, err := os.Open(<span class="string">&quot;test2.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">10</span>)</span><br><span class="line">n, err2 := f.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err2 == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v&quot;</span>, <span class="type">string</span>(buf[:n]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment">// 按需读取，从7开始读取10个字节</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">10</span>)</span><br><span class="line">n, err2 := f.ReadAt(buf, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v&quot;</span>, <span class="type">string</span>(buf[:n]))</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment">// 定位，从第三个字节开始读取</span></span><br><span class="line">f.Seek(<span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">10</span>)</span><br><span class="line">n2, err3 := f.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err3)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v&quot;</span>, <span class="type">string</span>(buf[:n2]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// openCloseFile()</span></span><br><span class="line">readOps()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>你好 golang<br>hello world<br>golang<br>he<br>好 golang</p><h2 id="3-File文件写操作">3. File文件写操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写数组</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.OpenFile(<span class="string">&quot;a.txt&quot;</span>, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">f.Write([]<span class="type">byte</span>(<span class="string">&quot;hello golang&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写字符串</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeSting</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.OpenFile(<span class="string">&quot;a.txt&quot;</span>, os.O_RDWR|os.O_CREATE|os.O_TRUNC, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">f.WriteString(<span class="string">&quot;hello world....&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定位置写</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeAt</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.OpenFile(<span class="string">&quot;a.txt&quot;</span>, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0755</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">f.WriteAt([]<span class="type">byte</span>(<span class="string">&quot;aaaaa&quot;</span>), <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">write()</span><br><span class="line">writeSting()</span><br><span class="line">writeAt()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4-进程相关操作">4. 进程相关操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 获取当前运行进程id</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;os.Getpid(): %v\n&quot;</span>, os.Getpid())</span><br><span class="line"><span class="comment">// 父id</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;os.Getppid(): %v\n&quot;</span>, os.Getppid())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置新进程的属性</span></span><br><span class="line">attr := &amp;os.ProcAttr&#123;</span><br><span class="line"><span class="comment">// files指定新进程继承的活动文件对象</span></span><br><span class="line"><span class="comment">// 前三个分别为，标准输入、标准输出、标准错误输出</span></span><br><span class="line">Files: []*os.File&#123;os.Stdin, os.Stdout, os.Stderr&#125;,</span><br><span class="line"><span class="comment">// 新进程的环境变量</span></span><br><span class="line">Env: os.Environ(),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 开始一个新进程</span></span><br><span class="line">p, err := os.StartProcess(<span class="string">&quot;c:\\Windows\\System32\notepad.exe&quot;</span>, []<span class="type">string</span>&#123;<span class="string">&quot;c:\\Windows\\System32\\notepad.exe&quot;</span>, <span class="string">&quot;D:\a.txt&quot;</span>&#125;, attr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(p)</span><br><span class="line">fmt.Println(<span class="string">&quot;进程ID&quot;</span>, p.Pid)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过进程ID查找进程</span></span><br><span class="line">p2, err2 := os.FindProcess(p.Pid)</span><br><span class="line"><span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err2)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(p2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待10秒执行函数</span></span><br><span class="line">time.AfterFunc(time.Second*<span class="number">10</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 向p进程发送退出信号</span></span><br><span class="line">p.Signal(os.Kill)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 等待进程p的退出，返回进程状态</span></span><br><span class="line">ps, err3 := p.Wait()</span><br><span class="line"><span class="keyword">if</span> err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err3)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;ps.String(): %v\n&quot;</span>, ps.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果:<br>os.Getpid(): 20048<br>os.Getppid(): 15896<br>2022/12/12 23:52:19 fork/exec c:\Windows\System32<br>otepad.exe: The filename, directory name, or volume label syntax is incorrect.<br>exit status 1</p><h2 id="5-环境相关的方法">5. 环境相关的方法</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//获得所有环境变量</span></span><br><span class="line">s := os.Environ()</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line"><span class="comment">// 获得某个环境变量</span></span><br><span class="line">s2 := os.Getenv(<span class="string">&quot;GOPATH&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s2: %v\n&quot;</span>, s2)</span><br><span class="line"><span class="comment">// 设置环变量</span></span><br><span class="line">os.Setenv(<span class="string">&quot;env1&quot;</span>, <span class="string">&quot;env1&quot;</span>)</span><br><span class="line"><span class="comment">// 查找</span></span><br><span class="line">s3, b := os.LookupEnv(<span class="string">&quot;env1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> b &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;s3: %v\n&quot;</span>, s3)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;没找到&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 替换</span></span><br><span class="line">os.Setenv(<span class="string">&quot;NAME&quot;</span>, <span class="string">&quot;gopher&quot;</span>)</span><br><span class="line">    os.Setenv(<span class="string">&quot;BURROW&quot;</span>, <span class="string">&quot;/usr/gopher&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;os.ExpandEnv(\&quot; lives in .\&quot;): %v\n&quot;</span>, os.ExpandEnv(<span class="string">&quot; lives in .&quot;</span>))</span><br><span class="line"><span class="comment">// 清空环境变量</span></span><br><span class="line"><span class="comment">// os.Clearenv()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-系统调用">6. 系统调用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行系统命令</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sys_call</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//查看系统命令所在的目录，确保命令已安装</span></span><br><span class="line">cmd_path, err := exec.LookPath(<span class="string">&quot;df&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;could not found command echo&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;command echo in path %s\n&quot;</span>, cmd_path) <span class="comment">// /bin/df</span></span><br><span class="line"></span><br><span class="line">cmd := exec.Command(<span class="string">&quot;df&quot;</span>, <span class="string">&quot;-h&quot;</span>) <span class="comment">//相当于命令df -h，注意Command的每一个参数都不能包含空格</span></span><br><span class="line"><span class="comment">//cmd.Output()运行命令并获得其输出结果</span></span><br><span class="line"><span class="keyword">if</span> output, err := cmd.Output(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;got output failed&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="type">string</span>(output))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cmd = exec.Command(<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;./data/test.log&quot;</span>)</span><br><span class="line"><span class="comment">//如果不需要获得命令的输出，直接调用cmd.Run()即可</span></span><br><span class="line">err = cmd.Run()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;run failed&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-从标准输入读入数据">7. 从标准输入读入数据</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scan</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;please input a word&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> word <span class="type">string</span></span><br><span class="line">fmt.Scan(&amp;word) <span class="comment">//读入第1个空格前的单词</span></span><br><span class="line">fmt.Println(word)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;please input two word&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> word1 <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> word2 <span class="type">string</span></span><br><span class="line">fmt.Scan(&amp;word1, &amp;word2) <span class="comment">//读入多个单词，空格分隔。如果输入了更多单词会被缓存起来，丢给下一次scan</span></span><br><span class="line">fmt.Println(word1, word2)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;please input an int&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span></span><br><span class="line">fmt.Scanf(<span class="string">&quot;%d&quot;</span>, &amp;i) <span class="comment">//类似于Scan，转为特定格式的数据</span></span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang并发编程</title>
      <link href="/20221211/golang-20221211-golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
      <url>/20221211/golang-20221211-golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="1-协程">1. 协程</h2><p>Golang中的并发是<strong>函数</strong>相互独立运行的能力。Goroutines是并发运行的函数。Golang提供了Goroutines作为并发处理操作的一种方式。</p><p>创建一个携程非常简单，就是在一个任务函数前面添加一个go关键字</p><h3 id="1-实例">1. 实例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">show</span><span class="params">(msg <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;msg: %v\n&quot;</span>, msg)</span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> show(<span class="string">&quot;java&quot;</span>)</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(<span class="string">&quot;end...&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>msg: golang<br>msg: java<br>msg: java<br>msg: golang<br>msg: golang<br>msg: java<br>msg: golang<br>msg: java<br>msg: golang<br>msg: java<br>end…</p><p><strong>实例2</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">responseSize</span><span class="params">(url <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">fmt.Println(<span class="string">&quot;Step1: &quot;</span>, url)</span><br><span class="line">response, err := http.Get(url)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;step2: &quot;</span>, url)</span><br><span class="line"><span class="keyword">defer</span> response.Body.Close()</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;step3: &quot;</span>, url)</span><br><span class="line">body, err := ioutil.ReadAll(response.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;step4: &quot;</span>, <span class="built_in">len</span>(body))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">urls := []<span class="type">string</span>&#123;<span class="string">&quot;https://baidu.com&quot;</span>, <span class="string">&quot;https://jd.com&quot;</span>, <span class="string">&quot;https://qq.com&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> urls &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> responseSize(v)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>Step1:  <a href="https://qq.com">https://qq.com</a><br>Step1:  <a href="https://jd.com">https://jd.com</a><br>Step1:  <a href="https://baidu.com">https://baidu.com</a><br>step2:  <a href="https://baidu.com">https://baidu.com</a><br>step3:  <a href="https://baidu.com">https://baidu.com</a><br>step4:  374448<br>step2:  <a href="https://jd.com">https://jd.com</a><br>step3:  <a href="https://jd.com">https://jd.com</a><br>step4:  159234<br>step2:  <a href="https://qq.com">https://qq.com</a><br>step3:  <a href="https://qq.com">https://qq.com</a><br>step4:  228<br>end…</p><h2 id="2-通道channel">2. 通道channel</h2><p>Go提供了一种称为通道的机制，用于在goroutine之间<strong>共享数据</strong>。当您作为goroutine执行并发激活时，需要在goroutine之间共享资源或数据。通道充当goroutine之间的管道并提供了一种机制来保证同步交换。</p><p>需要在声明通道时指定数据类型，我们可以共享内置、命名、结构和引用类型的值和指针。数据在通道上传递：在任何给定时间只有一个gouroutine可以访问数据项：因此按照设计不会发生数据竞争。</p><p>根据数据交换的行为，有两种类型的通道：无缓冲通道和有缓冲通道。无缓冲通道用于执行goroutine之间的同步通信，而缓冲通道用于执行异步通信。无缓冲通道保证在发送和接受发生的瞬间执行两个goroutine之间交换。缓冲通道没有这样的保证。</p><p><strong>通道由 make函数创建，该函数指定chan关键字和通道元素类型</strong></p><h3 id="2-1-语法">2.1 语法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Unbuffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>) <span class="comment">// 整型无缓冲通道</span></span><br><span class="line">buffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">10</span>) <span class="comment">// 整型有缓冲通道</span></span><br></pre></td></tr></table></figure><p>使用内置函数<code>make</code>创建啊无缓冲和有缓冲通道。<code>make</code>的第一个参数需要关键字<code>chan</code>,然后时通道允许交换的数据类型</p><p><strong>将值发送到通道的代码块使用<code>&lt;-</code>运算符</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">goroutine1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">5</span>) <span class="comment">// 字符串缓冲通道</span></span><br><span class="line">goroutine1 &lt;- <span class="string">&quot;Australia&quot;</span>  <span class="comment">// 通过通道发送字符串</span></span><br></pre></td></tr></table></figure><p><strong>从通道接收值</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data := &lt;-goroutine1</span><br></pre></td></tr></table></figure><h3 id="2-2-通道发送和接收特性">2.2 通道发送和接收特性</h3><ol><li>对于同一个通道，发送操作之间是互斥的，接收操作之间也是互斥的。</li><li>发送操作和接收操作中对元素的处理都是不可分割的。</li><li>发送操作在完全完成之前会被阻塞，接收操作也是如此。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> values = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> &#123;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line">value := rand.Intn(<span class="number">10</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;value: %v\n&quot;</span>, value)</span><br><span class="line">    time.Sleep(time.Millisecond * <span class="number">5000</span>)</span><br><span class="line">values &lt;- value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 从通道接收值</span></span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(values)</span><br><span class="line"><span class="keyword">go</span> send()</span><br><span class="line">fmt.Println(<span class="string">&quot;wait...&quot;</span>)</span><br><span class="line">value := &lt;-values</span><br><span class="line">fmt.Printf(<span class="string">&quot;value: %v\n&quot;</span>, value)</span><br><span class="line">fmt.Println(<span class="string">&quot;end...&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>wait…<br>value: 5<br>value: 5<br>end…</p><h3 id="2-3-channel的遍历">2.3 channel的遍历</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> values = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line">value := rand.Intn(<span class="number">10</span>)</span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">values &lt;- value</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">close</span>(values)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">receive</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> values &#123;</span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> send()</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> receive()</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>6<br>4<br>0<br>1<br>2<br>1<br>2<br>2<br>7<br>1</p><h2 id="3-WaitGroup">3. WaitGroup</h2><p>通过WaitGroup实现多个协程同步</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done() <span class="comment">// goroutine结束就登记-1</span></span><br><span class="line">fmt.Println(<span class="string">&quot;hello goroutine!&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>) <span class="comment">//启动一个goroutine就登记+1</span></span><br><span class="line"><span class="keyword">go</span> hello(i)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait() <span class="comment">// 等待所有登记的goroutine都结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>hello goroutine! 0<br>hello goroutine! 8<br>hello goroutine! 5<br>hello goroutine! 3<br>hello goroutine! 4<br>hello goroutine! 7<br>hello goroutine! 6<br>hello goroutine! 2<br>hello goroutine! 9<br>hello goroutine! 1</p><h2 id="4-runtime包">4. runtime包</h2><p>runtime包里定义了一些协程管理相关的api</p><h3 id="4-1-runtime-Gosched">4.1 runtime.Gosched()</h3><p>让出CPU时间片，重新等待安排任务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">show</span><span class="params">(s <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> show(<span class="string">&quot;java&quot;</span>)</span><br><span class="line"><span class="comment">// 主协程</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line"></span><br><span class="line">runtime.Gosched()</span><br><span class="line">fmt.Println(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>s: java<br>s: java<br>golang<br>golang</p><h3 id="4-2-runtime-Goexit">4.2 runtime.Goexit()</h3><p>退出当前协程</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">show</span><span class="params">(s <span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i &gt;= <span class="number">5</span> &#123;</span><br><span class="line">runtime.Goexit()</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;s: %v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> show(<span class="string">&quot;java&quot;</span>)</span><br><span class="line"><span class="comment">// 主协程</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">runtime.Gosched()</span><br><span class="line">fmt.Println(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>s: java<br>golang<br>s: java<br>golang<br>s: java<br>s: java<br>s: java</p><h3 id="4-3-runtime-GOMAXPROCS">4.3 runtime.GOMAXPROCS</h3><p>设置最大CPU核心数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">fmt.Println(<span class="string">&quot;A&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line"><span class="comment">// time.Sleep(time.Millisecond * 200)</span></span><br><span class="line">fmt.Println(<span class="string">&quot;b&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;runtime.NumCPU(): %v\n&quot;</span>, runtime.NumCPU())</span><br><span class="line">runtime.GOMAXPROCS(<span class="number">1</span>)</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> a()</span><br><span class="line"><span class="keyword">go</span> b()</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>runtime.NumCPU(): 8<br>b 0<br>b 1<br>b 2<br>b 3<br>b 4<br>A 0<br>A 1<br>A 2<br>A 3<br>A 4</p><h2 id="5-Mutex互斥锁实现同步">5. Mutex互斥锁实现同步</h2><p>除了使用channel实现同步之外，还可以使用Mutex互斥锁的方式实现同步</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lock sync.Mutex</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">lock.Lock()</span><br><span class="line">a += <span class="number">1</span></span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">20</span>)</span><br><span class="line">lock.Unlock()</span><br><span class="line">fmt.Printf(<span class="string">&quot;a++: %v\n&quot;</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">lock.Lock()</span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">a -= <span class="number">1</span></span><br><span class="line">lock.Unlock()</span><br><span class="line">fmt.Printf(<span class="string">&quot;a--: %v\n&quot;</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> add()</span><br><span class="line"><span class="keyword">go</span> sub()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Printf(<span class="string">&quot;a: %v\n&quot;</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>a++: 101<br>a–: 100<br>a++: 101<br>a–: 100<br>a–: 99<br>a++: 100<br>a++: 101<br>a++: 102<br>a–: 101<br>a++: 102<br>a–: 101<br>a++: 102<br>a–: 101<br>a++: 102<br>a–: 101<br>a–: 100<br>a++: 101<br>a–: 100<br>a++: 101<br>a–: 100<br>a: 100</p><h2 id="6-select">6. select</h2><ol><li>select是Go中的一个控制结构，类似于<code>switch</code>语句，用于处理异步IO操作。<code>select</code>会监听case语句中channel的读写操作，当case中channel读写操作为非阻塞状态（即能读写）时，将会出发相应的动作。</li></ol><div class="note success no-icon flat"><p>select中的case语句必须是一个channel操作<br>select中的default子句总是可运行的</p></div><ol start="2"><li>如果有多个<code>case</code>都可以运行时，<code>select</code>会随机公平的选出一个执行，其他不会执行</li><li>如果没有可运行的<code>case</code>语句，且有<code>default</code>语句，那么就会执行<code>defalut</code>语句</li><li>如果没有可运行的<code>case</code>语句，且没有<code>default</code>语句，<code>select</code>将阻塞，直到某个<code>case</code>通信可以运行</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> chanInt = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">var</span> chanStr = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">chanInt &lt;- <span class="number">100</span></span><br><span class="line">chanStr &lt;- <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">close</span>(chanInt)</span><br><span class="line"><span class="built_in">close</span>(chanStr)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> r := &lt;-chanInt:</span><br><span class="line">fmt.Printf(<span class="string">&quot;r: %v\n&quot;</span>, r)</span><br><span class="line"><span class="keyword">case</span> r := &lt;-chanStr:</span><br><span class="line">fmt.Printf(<span class="string">&quot;r: %v\n&quot;</span>, r)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;default...&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果:</p><p>default…<br>r: 100<br>r: hello<br>r: 0<br>r: 0<br>r: 0<br>r: 0<br>r:<br>r: 0<br>r:<br>r:<br>…</p><h2 id="7-Timer">7. Timer</h2><p>Timer顾名思义，就是定时器的意思，可以是实现一些定时操作，内部也是通过channel来实现</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">timer1 := time.NewTimer(time.Second * <span class="number">2</span>)</span><br><span class="line">t1 := time.Now()</span><br><span class="line">fmt.Printf(<span class="string">&quot;t1: %v\n&quot;</span>, t1)</span><br><span class="line"></span><br><span class="line">t2 := &lt;-timer1.C</span><br><span class="line">fmt.Printf(<span class="string">&quot;t2: %v\n&quot;</span>, t2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果只是想单纯的等待的话，可以使用time.Sleep来实现</span></span><br><span class="line">timer2 := time.NewTimer(time.Second * <span class="number">2</span>)</span><br><span class="line">&lt;-timer2.C</span><br><span class="line">fmt.Println(<span class="string">&quot;2s后...&quot;</span>)</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;再一次2s后...&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;-time.After(time.Second * <span class="number">2</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;再一次2s后...&quot;</span>)</span><br><span class="line"></span><br><span class="line">timer3 := time.NewTimer(time.Second)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-timer3.C</span><br><span class="line">fmt.Println(<span class="string">&quot;Timer 3 expired&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">stop := timer3.Stop() <span class="comment">// 停止定时器</span></span><br><span class="line"><span class="keyword">if</span> stop &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;timer3 stopped&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;before&quot;</span>)</span><br><span class="line">timer4 := time.NewTimer(time.Second * <span class="number">5</span>)</span><br><span class="line">timer4.Reset(time.Second * <span class="number">1</span>) <span class="comment">// 重新设置时间</span></span><br><span class="line">&lt;-timer4.C</span><br><span class="line">fmt.Println(<span class="string">&quot;after&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>t1: 2022-12-12 18:07:49.2467015 +0800 CST m=+0.003300201<br>t2: 2022-12-12 18:07:51.2579347 +0800 CST m=+2.014628401<br>2s后…<br>再一次2s后…<br>再一次2s后…<br>timer3 stopped<br>before<br>after</p><h2 id="8-Ticker">8. Ticker</h2><p>Timer只执行一次，Ticker可以周期性执行</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">chanInt := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">ticker := time.NewTicker(time.Second)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _ = <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> chanInt &lt;- <span class="number">1</span>:</span><br><span class="line"><span class="keyword">case</span> chanInt &lt;- <span class="number">2</span>:</span><br><span class="line"><span class="keyword">case</span> chanInt &lt;- <span class="number">3</span>:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">sum := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> chanInt &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;接收: %v\n&quot;</span>, v)</span><br><span class="line">sum += v</span><br><span class="line"><span class="keyword">if</span> sum &gt;= <span class="number">10</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;sum: %v\n&quot;</span>, sum)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>接收: 3<br>接收: 1<br>接收: 3<br>接收: 2<br>接收: 2<br>sum: 11</p><h2 id="9-并发之原子操作">9. 并发之原子操作</h2><p>第一种方式通过互斥锁sync.Mutex,第二种方式通过sync/atomic<br>atomic提供的原子操作能够确保任一时刻只有一个goroutine对变量进行操作，善用atomic能够避免程序中出现大量的锁操作</p><p>atomic常见操作有：</p><ul><li>增减</li><li>载入</li><li>比较并交换cas</li><li>交换</li><li>存储</li></ul><h3 id="9-1-增减操作">9.1 增减操作</h3><ul><li>func AddInt32(addr *int32, delta int32) (new int32)</li><li>func AddInt64(addr *int64, delta int64) (new int64)</li><li>func AddUint32(addr *uint32, delta uint632) (new uint32)</li><li>func AddUint64(addr *uint64, delta uint64) (new uint64)</li><li>func AddUintptr(addr *uintptr, delta uintptr) (new uintptr)</li></ul><h3 id="9-2-载入操作">9.2 载入操作</h3><p>atomic包中提供了如下以Load为前缀的增减操作</p><ul><li>func LoadInt32(addr *int32) (var int32)</li><li>func LoadInt64(addr *int64) (var int64)</li><li>func LoadPointer(addr *unsafe.Pointer) (var unsafe.Pointer)</li><li>func LoadUint32(addr *uint32) (var uint32)</li><li>func LoadUint64(addr *uint64) (var uint64)</li><li>func LoadUintptr(addr *uintptr) (var uintptr)</li></ul><div class="note success no-icon flat"><p>载入操作能够保证原子的读变量的值，当读取的时候，任何其他CPU操作都无法对该变量进行读写，其实现机制受到底层硬件的支持。</p></div><h3 id="9-2-比较并交换">9.2 比较并交换</h3><p>该操作简称 CAS(Compare And Swap)这类操作的前缀为<code>CompareAndSwap</code></p><ul><li>func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)</li><li>func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool)<br>…</li></ul><div class="note success no-icon flat"><p>该操作在进行交换前首先确保变量的值未被更改，即仍然保持参数<code>old</code>所记录的值，满足此前提下才进行交换操作，CAS的做法乐死操作数据库时的乐观锁机制</p></div><h3 id="9-3-交换">9.3 交换</h3><p>此类操作的前缀为<code>Swap</code></p><ul><li>func SwapInt32(addr *int32, new int32) (old int32)<br>…</li></ul><div class="note success no-icon flat"><p>相对于CAS，明显此类操作更为暴力直接，并不管变量的旧值是否被改变，直接赋予新值然后返回被替换的值</p></div><h3 id="9-4-存储">9.4 存储</h3><p>此类操作的前缀为<code>Store</code>:</p><ul><li>func StoreInt32(addr *int32, val int32)</li><li>func StoreInt64(addr *int64, val int64)<br>…</li></ul><div class="note success no-icon flat"><p>此类操作确保了写变量的原子性，避免其他操作读到了修改变量过程中的脏数据</p></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i <span class="type">int64</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">atomic.AddInt64(&amp;i, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">atomic.AddInt64(&amp;i, <span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> add()</span><br><span class="line"><span class="keyword">go</span> sub()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>i: 100</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang面向对象</title>
      <link href="/20221211/golang-20221211-golang%E7%BB%A7%E6%89%BF/"/>
      <url>/20221211/golang-20221211-golang%E7%BB%A7%E6%89%BF/</url>
      
        <content type="html"><![CDATA[<h2 id="面向对象的概念">面向对象的概念</h2><p>  洗衣服过程剖析：</p><ol><li>给洗衣机里加脏衣服和洗衣粉。</li><li>启动洗衣机。</li><li>洗衣机自动注水，然后滚动。</li><li>脏衣服从黑颜色变成白颜色。</li><li>洗衣机自动停止。</li></ol><p>  用面向过程的思想实现代码。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//准备洗衣服</span></span><br><span class="line"><span class="comment">//输入参数：</span></span><br><span class="line"><span class="comment">//powder 洗衣机里放多少洗衣粉</span></span><br><span class="line"><span class="comment">//closes 洗衣机里放多少衣服</span></span><br><span class="line"><span class="comment">//clean 衣服是否是干净的</span></span><br><span class="line"><span class="comment">//返回值：</span></span><br><span class="line"><span class="comment">//洗衣机是否开启</span></span><br><span class="line"><span class="comment">//准备洗多少衣服</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(powder <span class="type">int</span>, closes <span class="type">int</span>, clean <span class="type">bool</span>)</span></span> (<span class="type">bool</span>, <span class="type">int</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> powder &lt;= <span class="number">0</span> || closes &lt;= <span class="number">0</span> || clean == <span class="literal">true</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>, closes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始洗衣服</span></span><br><span class="line"><span class="comment">//输入参数：</span></span><br><span class="line"><span class="comment">//washer_state 洗衣机是否开启</span></span><br><span class="line"><span class="comment">//closes 准备洗多少衣服</span></span><br><span class="line"><span class="comment">//返回值：</span></span><br><span class="line"><span class="comment">//衣服是否是干净的</span></span><br><span class="line"><span class="comment">//洗了多少衣服</span></span><br><span class="line"><span class="comment">//洗衣机是否开启</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wash</span><span class="params">(washer_state <span class="type">bool</span>, closes <span class="type">int</span>)</span></span> (<span class="type">bool</span>, <span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> washer_state == <span class="literal">false</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">false</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;注水&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;滚动&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;关机&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>, closes, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查最终状态</span></span><br><span class="line"><span class="comment">//输入参数：</span></span><br><span class="line"><span class="comment">//clean 衣服是否是干净的</span></span><br><span class="line"><span class="comment">//closes 洗了多少衣服</span></span><br><span class="line"><span class="comment">//washer_state 洗衣机是否开启</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(clean <span class="type">bool</span>, closes <span class="type">int</span>, washer_state <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> clean &amp;&amp; closes &gt; <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;洗干净了%d件衣服\n&quot;</span>, closes)</span><br><span class="line"><span class="keyword">if</span> washer_state &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;你忘关洗衣机了&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;洗衣失败&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//整个洗衣服的过程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WashProcedure</span><span class="params">(powder, closes <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">washer_state := <span class="literal">false</span></span><br><span class="line">clean := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">washer_state, closes = prepare(powder, closes, clean)</span><br><span class="line">clean, closes, washer_state = wash(washer_state, closes)</span><br><span class="line">check(clean, closes, washer_state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  面向过程编程整个过程分为若干步，每一步对应一个函数，函数之间要传递大量的参数。<br>  面向对象编程把大量参数封装到一个结构体里面，给结构体赋予方法，方法里面去修改结构体的成员变量。go语言面向对象的好处：打包参数，继承，面向接口编程。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//洗衣机</span></span><br><span class="line"><span class="keyword">type</span> Washer <span class="keyword">struct</span> &#123;</span><br><span class="line">State  <span class="type">bool</span></span><br><span class="line">Powder <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//衣服</span></span><br><span class="line"><span class="keyword">type</span> Closes <span class="keyword">struct</span> &#123;</span><br><span class="line">Clean <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(washer *Washer)</span></span> prepare(closes []*Closes) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> washer.State == <span class="literal">true</span> || washer.Powder &lt;= <span class="number">0</span> || <span class="built_in">len</span>(closes) &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;请确保在关机的状态下加入适量衣物和洗衣粉&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(washer *Washer)</span></span> wash(closes []*Closes) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := washer.prepare(closes); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;开机&quot;</span>)</span><br><span class="line">washer.State = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//检查是否有脏衣服</span></span><br><span class="line">clean := <span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> _, ele := <span class="keyword">range</span> closes &#123;</span><br><span class="line"><span class="keyword">if</span> ele.Clean == <span class="literal">false</span> &#123;</span><br><span class="line">clean = <span class="literal">false</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> clean &#123;</span><br><span class="line">washer.State = <span class="literal">false</span></span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;所有衣服都是干净的，不需要洗&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始洗衣服</span></span><br><span class="line">fmt.Println(<span class="string">&quot;注水&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;滚动&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;关机&quot;</span>)</span><br><span class="line">washer.State = <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> _, ele := <span class="keyword">range</span> closes &#123;</span><br><span class="line">ele.Clean = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(washer *Washer)</span></span> check(err <span class="type">error</span>, closes []*Closes) &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;洗衣失败:%v\n&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;洗干净了%d件衣服\n&quot;</span>, <span class="built_in">len</span>(closes))</span><br><span class="line"><span class="keyword">if</span> washer.State == <span class="literal">true</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;你忘关洗衣机了&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="构造函数">构造函数</h2><p>  定义User结构体。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="comment">//&quot;&quot;表示未知</span></span><br><span class="line">    Age <span class="type">int</span> <span class="comment">//-1表示未知</span></span><br><span class="line">    Sex <span class="type">byte</span> <span class="comment">//1男，2女，3未知</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>u := User{}构造一个空的User，各字段都取相应数据类型的默认值。</li><li>up := new(User)构造一个空的User，并返回其指针。</li></ul><p>  自定义构造函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultUser</span><span class="params">()</span></span> *User &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;User&#123;</span><br><span class="line">        Name: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        Age: <span class="number">-1</span>,</span><br><span class="line">        Sex: <span class="number">3</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUser</span><span class="params">(name <span class="type">string</span>, age <span class="type">int</span>, sex <span class="type">byte</span>)</span></span> *User &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;User&#123;</span><br><span class="line">        Name: name,</span><br><span class="line">        Age: age,</span><br><span class="line">        Sex: sex,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  单例模式，确保在并发的情况下，整个进程里只会创建struct的一个实例。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    sUser *User</span><br><span class="line">    uOnce sync.Once</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInstance</span><span class="params">()</span></span> *User &#123;</span><br><span class="line">    uOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//确保即使在并发的情况下，下面的3行代码在整个go进程里只会被执行一次</span></span><br><span class="line">    <span class="keyword">if</span> sUser == <span class="literal">nil</span> &#123;</span><br><span class="line">        sUser = NewDefaultUser()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> sUser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用GetUserInstance()得到的是同一个User实例</span></span><br><span class="line">su1 := GetUserInstance()</span><br><span class="line">su2 := GetUserInstance()</span><br><span class="line"><span class="comment">//修改su1会影响su2</span></span><br></pre></td></tr></table></figure><h2 id="继承与重写">继承与重写</h2><p>  通过嵌入匿名结构体，变相实现“继承”的功能，因为访问匿名成员时可以跳过成员名直接访问它的内部成员。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Plane <span class="keyword">struct</span> &#123;</span><br><span class="line">color <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Bird <span class="keyword">struct</span> &#123;</span><br><span class="line">Plane </span><br><span class="line">&#125;</span><br><span class="line">bird := Bird &#123;&#125;</span><br><span class="line">bird.Plane.color</span><br><span class="line">bird.color</span><br></pre></td></tr></table></figure><p>重写</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(plane Plane)</span></span> fly() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">500</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写父类(Plane)的fly方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bird Bird)</span></span> fly() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> bird.Plane.fly()+<span class="number">100</span> <span class="comment">//调用父类的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  正规来讲，Go语言并不支持继承，它只是支持组合。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Plane <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="comment">//Bird组合了Plane和Car的功能</span></span><br><span class="line"><span class="keyword">type</span> Bird <span class="keyword">struct</span> &#123;</span><br><span class="line">Plane </span><br><span class="line">Car</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang包与工程化</title>
      <link href="/20221211/golang-20221209-golang%E5%8C%85%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%8C%96/"/>
      <url>/20221211/golang-20221209-golang%E5%8C%85%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="用go-mod管理工程">用go mod管理工程</h2><p>  初始化项目:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod init $module_name</span><br></pre></td></tr></table></figure><p>$module_name和目录名可以不一样。上述命令会生成go.mod文件，该文件内容形如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module go-course</span><br><span class="line"></span><br><span class="line">go 1.17</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">    github.com/ethereum/go-ethereum v1.10.8</span><br><span class="line">    github.com/gin-gonic/gin v1.7.4</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>  Go依次从当前项目、GOROOT、GOPATH下寻找依赖包。</p><ol><li>从当前go文件所在的目录逐级向上查找go.mod文件（假设go.mod位于目录mode_path下），里面定义了module_name，则引入包的路径为&quot;module_name/包相对于mode_path的路径&quot;。</li><li>go标准库提供的包在GOROOT/src下。</li><li>第三方依赖包在GOPATH/pkg/mod下。</li></ol><p>  从go1.7开始，go get只负责下载第三方依赖包，并把它加到go.mod文件里，由go install负责安装二进制文件。</p><ul><li>go get <a href="http://github.com/mailru/easyjson%E4%BC%9A%E5%9C%A8GOPATH/pkg/mod%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%94%9F%E6%88%90github.com/mailru/easyjson%E7%9B%AE%E5%BD%95%E3%80%82">github.com/mailru/easyjson会在GOPATH/pkg/mod目录下生成github.com/mailru/easyjson目录。</a></li><li>go install <a href="http://github.com/mailru/easyjson/easyjson%E4%BC%9A%E5%9C%A8GOPATH/bin%E4%B8%8B%E7%94%9F%E6%88%90easyjson%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E3%80%82">github.com/mailru/easyjson/easyjson会在GOPATH/bin下生成easyjson二进制可执行文件。</a></li></ul><p>  go mod tidy通过扫描当前项目中的所有代码来添加未被记录的依赖至go.mod文件或从go.mod文件中删除不再被使用的依赖。</p><h2 id="包引入规则">包引入规则</h2><p>包的声明</p><ul><li>go文件的第一行声明 package xxx。</li><li>在包声明的上面可写关于包的注释，包注释也可以专门写在doc.go里。</li><li>包名跟目录名可以不同。</li><li>同一个目录下，所有go文件的包名必须一致。</li></ul><p>包的引用</p><ul><li>可以直接使用同目录下其他go文件里的变量、函数、结构体。</li><li>跨目录使用则需要变量前加入包名，并且引入包所在的目录。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imoprt <span class="string">&quot;go-course/package&quot;</span>      <span class="comment">//go-course是model名，package是目录名</span></span><br><span class="line">mypackage.Add()     <span class="comment">//mypackage是包名，它对应的目录是package</span></span><br></pre></td></tr></table></figure><ul><li>在import块里可以引用父目录，也可以引用子目录。</li><li>引用关系不能构成一个环。</li><li>在import的目录前面可以给包起一个别名。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imoprt asd <span class="string">&quot;go-course/package&quot;</span></span><br><span class="line">asd.Add()</span><br></pre></td></tr></table></figure><h2 id="init调用链">init调用链</h2><p>  main函数是go程序的唯一入口，所以main函数只能存在一个。main函数必须位于main包中。在main函数执行之前会先执行init()函数。在一个目录，甚至一个go文件里，init()可以重复定义。引入其他包时，相应包里的init()函数也会在main()函数之前被调用。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./init链.png width=800 />  <pre><code class="language-Go">import _ &quot;net/http/pprof&quot;</code></pre><p>  在目录前加一个_，代码里却没有显式地使用这个包里的函数或变量，实际上是想执行这个包里的init()函数。</p><h2 id="可见性">可见性</h2><ul><li>以小写字母开头命名的函数、变量、结构体只能在本包内访问。</li><li>以大写字母开头命名的函数、变量、结构体在其他包中也可以访问。</li><li>如果结构体名字以大写字母开头，而其成员变量、成员方法以小写字母开头，则这样的成员只能在本包内访问。</li></ul><p>  Go中命名为internal的package，可以被平级目录和上一级目录所访问，更上层的目录不能访问。如下图c目录（internal的上一级目录）及其子孙目录之间可以任意import，但a目录和b目录不能import internal及其下属的所有目录。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./path.png width=300 /> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./internal.png width=400 />   ]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang接口</title>
      <link href="/20221209/golang-20221209-golang%E6%8E%A5%E5%8F%A3/"/>
      <url>/20221209/golang-20221209-golang%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="接口的基本概念">接口的基本概念</h2><p>  接口是一组行为规范的集合。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transporter <span class="keyword">interface</span> &#123; <span class="comment">//定义接口。通常接口名以er结尾</span></span><br><span class="line">    <span class="comment">//接口里面只定义方法，不定义变量</span></span><br><span class="line">    move(src <span class="type">string</span>, dest <span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>) <span class="comment">//方法名 (参数列表) 返回值列表</span></span><br><span class="line">    whistle(<span class="type">int</span>) <span class="type">int</span> <span class="comment">//参数列表和返回值列表里的变量名可以省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  只要结构体拥有接口里声明的所有方法，就称该结构体“实现了接口”。一个struct可以同时实现多个接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123; <span class="comment">//定义结构体时无需要显式声明它要实现什么接口</span></span><br><span class="line">    price <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(car Car)</span></span> move(src <span class="type">string</span>, dest <span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> car.price, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(car Car)</span></span> whistle(n <span class="type">int</span>) <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  接口值有两部分组成, 一个指向该接口的具体类型的指针和另外一个指向该具体类型真实数据的指针。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">car := Car&#123;<span class="string">&quot;宝马&quot;</span>, <span class="number">100</span>&#125;</span><br><span class="line"><span class="keyword">var</span> transporter Transporter</span><br><span class="line">transporter = car</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./interface.png width=200 />  <p>接口的使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transport</span><span class="params">(src, dest <span class="type">string</span>, transporter Transporter)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"> _,err := transporter.move(src, dest)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> car Car<span class="comment">//Car实现了Transporter接口</span></span><br><span class="line"><span class="keyword">var</span> ship Shiper<span class="comment">// Shiper实现了Transporter接口</span></span><br><span class="line">transport(<span class="string">&quot;北京&quot;</span>, <span class="string">&quot;天津&quot;</span>, car)</span><br><span class="line">transport(<span class="string">&quot;北京&quot;</span>, <span class="string">&quot;天津&quot;</span>, ship)</span><br></pre></td></tr></table></figure><p>接口的赋值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(car Car)</span></span> whistle(n <span class="type">int</span>) <span class="type">int</span> &#123;…&#125;<span class="comment">//方法接收者是值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ship *Shiper)</span></span> whistle(n <span class="type">int</span>) <span class="type">int</span> &#123;…&#125; <span class="comment">//方法接收者用指针，则实现接口的是指针类型</span></span><br><span class="line">car := Car&#123;&#125;</span><br><span class="line">ship := Shiper&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> transporter Transporter</span><br><span class="line">transporter = car </span><br><span class="line">transporter = &amp;car     <span class="comment">//值实现的方法，指针同样也实现了</span></span><br><span class="line">transporter = &amp;ship</span><br></pre></td></tr></table></figure><h2 id="接口嵌入">接口嵌入</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transporter <span class="keyword">interface</span> &#123;</span><br><span class="line">whistle(<span class="type">int</span>) <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Steamer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Transporter <span class="comment">//接口嵌入。相当于Transporter接口定义的行为集合是Steamer的子集</span></span><br><span class="line">    displacement() <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="空接口">空接口</h2><p>  空接口类型用interface{}表示，注意有{}。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125; </span><br></pre></td></tr></table></figure><p>  空接口没有定义任何方法，因此任意类型都实现了空接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">5</span></span><br><span class="line">i = a</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">square</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span>&#123;&#125; <span class="comment">//该函数可以接收任意数据类型</span></span><br></pre></td></tr></table></figure><p>  slice的元素、map的key和value都可以是空接口类型。map中的key可以是任意能够用==操作符比较的类型，不能是函数、map、切片，以及包含上述3中类型成员变量的的struct。map的value可以是任意类型。</p><h2 id="类型断言">类型断言</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> v, ok := i.(<span class="type">int</span>); ok &#123;<span class="comment">//若断言成功，则ok为true，v是具体的类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;i是int类型，其值为%d\n&quot;</span>, v)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;i不是int类型&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  当要判断的类型比较多时，就需要写很多if-else，更好的方法是使用switch i.(type)。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> v := i.(<span class="keyword">type</span>) &#123;    <span class="comment">//隐式地在每个case中声明了一个变量v</span></span><br><span class="line"><span class="keyword">case</span> <span class="type">int</span>:  <span class="comment">//v已被转为int类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;ele is int, value is %d\n&quot;</span>, v)</span><br><span class="line"><span class="comment">//在 Type Switch 语句的 case 子句中不能使用fallthrough</span></span><br><span class="line"><span class="keyword">case</span> <span class="type">float64</span>:      <span class="comment">//v已被转为float64类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;ele is float64, value is %f\n&quot;</span>, v)</span><br><span class="line"><span class="keyword">case</span> <span class="type">int8</span>, <span class="type">int32</span>, <span class="type">byte</span>: <span class="comment">//如果case后面跟多种type，则v还是interface&#123;&#125;类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;ele is %T, value is %d\n&quot;</span>, v, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="面向接口编程">面向接口编程</h2><p>电商推荐流程<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=./rec.png width=700 /></p><p>为每一个步骤定义一个接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Recaller <span class="keyword">interface</span> &#123;</span><br><span class="line">    Recall(n <span class="type">int</span>) []*common.Product <span class="comment">//生成一批推荐候选集</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Sorter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Sort([]*common.Product) []*common.Product <span class="comment">//传入一批商品，返回排序之后的商品</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Filter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Filter([]*common.Product) []*common.Product <span class="comment">//传入一批商品，返回过滤之后的商品</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Recommender <span class="keyword">struct</span> &#123;</span><br><span class="line">    Recallers []recall.Recaller</span><br><span class="line">    Sorter sort.Sorter</span><br><span class="line">    Filters []filter.Filter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用纯接口编写推荐主流程。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rec *Recommender)</span></span> Rec() []*common.Product &#123;</span><br><span class="line">RecallMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]*common.Product, <span class="number">100</span>)</span><br><span class="line"><span class="comment">//顺序执行多路召回</span></span><br><span class="line"><span class="keyword">for</span> _, recaller := <span class="keyword">range</span> rec.Recallers &#123;</span><br><span class="line">products := recaller.Recall(<span class="number">10</span>) <span class="comment">//统一设置每路最多召回10个商品</span></span><br><span class="line"><span class="keyword">for</span> _, product := <span class="keyword">range</span> products &#123;</span><br><span class="line">RecallMap[product.Id] = product <span class="comment">//把多路召回的结果放到map里，按Id进行排重</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把map转成slice</span></span><br><span class="line">RecallSlice := <span class="built_in">make</span>([]*common.Product, <span class="number">0</span>, <span class="built_in">len</span>(RecallMap))</span><br><span class="line"><span class="keyword">for</span> _, product := <span class="keyword">range</span> RecallMap &#123;</span><br><span class="line">RecallSlice = <span class="built_in">append</span>(RecallSlice, product)</span><br><span class="line">&#125;</span><br><span class="line">SortedResult := rec.Sorter.Sort(RecallSlice) <span class="comment">//对召回的结果进行排序</span></span><br><span class="line"><span class="comment">//顺序执行多种过滤规则</span></span><br><span class="line">FilteredResult := SortedResult</span><br><span class="line"><span class="keyword">for</span> _, filter := <span class="keyword">range</span> rec.Filters &#123;</span><br><span class="line">FilteredResult = filter.Filter(FilteredResult)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> FilteredResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  面向接口编程，在框架层面全是接口。具体的实现由不同的开发者去完成，每种实现单独放到一个go文件里，大家的代码互不干扰。通过配置选择采用哪种实现，也方便进行效果对比。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang结构体</title>
      <link href="/20221209/golang-20221209-golang%E7%BB%93%E6%9E%84%E4%BD%93/"/>
      <url>/20221209/golang-20221209-golang%E7%BB%93%E6%9E%84%E4%BD%93/</url>
      
        <content type="html"><![CDATA[<h2 id="结构体创建、访问与修改">结构体创建、访问与修改</h2><p>定义结构体</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">    id <span class="type">int</span></span><br><span class="line">    score <span class="type">float32</span></span><br><span class="line">    enrollment time.Time</span><br><span class="line">    name, addr <span class="type">string</span> <span class="comment">//多个字段类型相同时可以简写到一行里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>声明和初始化结构体</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> u user <span class="comment">//声明，会用相应类型的默认值初始化struct里的每一个字段</span></span><br><span class="line">u = user&#123;&#125; <span class="comment">//用相应类型的默认值初始化struct里的每一个字段</span></span><br><span class="line">u = user&#123;id: <span class="number">3</span>, name: <span class="string">&quot;zcy&quot;</span>&#125; <span class="comment">//赋值初始化</span></span><br><span class="line">u = user&#123;<span class="number">4</span>, <span class="number">100.0</span>, time.Now(), <span class="string">&quot;zcy&quot;</span>, <span class="string">&quot;beijing&quot;</span>&#125; <span class="comment">//赋值初始化，可以不写字段名，但需要跟结构体定义里的字段顺序一致</span></span><br></pre></td></tr></table></figure><p>访问与修改结构体</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u.enrollment = time.Now() <span class="comment">//给结构体的成员变量赋值</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.id, u.enrollment, u.name)<span class="comment">//访问结构体的成员变量</span></span><br></pre></td></tr></table></figure><p>成员方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以把user理解为hello函数的参数，即hello(u user, man string)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span></span> hello(man <span class="type">string</span>) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//函数里不需要访问user的成员，可以传匿名，甚至_也不传</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_ user)</span></span> think(man <span class="type">string</span>) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, do you know my name?&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为自定义类型添加方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> UserMap <span class="keyword">map</span>[<span class="type">int</span>]User <span class="comment">//自定义类型</span></span><br><span class="line"><span class="comment">//可以给自定义类型添加任意方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(um UserMap)</span></span> GetUser(id <span class="type">int</span>) User &#123;</span><br><span class="line">    <span class="keyword">return</span> um[id]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结构体的可见性：</p><ul><li>go语言关于可见的统一规则：大写字母开头跨package也可以访问；否则只能本package内部访问。</li><li>结构体名称以大写开头时，package外部可见，在此前提下，结构体中以大写开头在成员变量或成员方法在package外部也可见。</li></ul><p>匿名结构体</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stu <span class="keyword">struct</span> &#123; <span class="comment">//声明stu是一个结构体，但这个结构体是匿名的</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">stu.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">stu.Addr = <span class="string">&quot;bj&quot;</span></span><br></pre></td></tr></table></figure><p>  匿名结构体通常用于只使用一次的情况。<br>结构体中含有匿名成员</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Id <span class="type">int</span></span><br><span class="line"><span class="type">string</span> <span class="comment">//匿名字段</span></span><br><span class="line"><span class="type">float32</span> <span class="comment">//直接使用数据类型作为字段名，所以匿名字段中不能出现重复的数据类型</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> stu = Student&#123;Id: <span class="number">1</span>, <span class="type">string</span>: <span class="string">&quot;zcy&quot;</span>, <span class="type">float32</span>: <span class="number">79.5</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;anonymous_member string member=%s float member=%f\n&quot;</span>, stu.<span class="type">string</span>, stu.<span class="type">float32</span>)   <span class="comment">//直接使用数据类型访问匿名成员</span></span><br></pre></td></tr></table></figure><h2 id="结构体指针">结构体指针</h2><p>创建结构体指针</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> u User</span><br><span class="line">user := &amp;u <span class="comment">//通过取址符&amp;得到指针</span></span><br><span class="line">user = &amp;User&#123; <span class="comment">//直接创建结构体指针</span></span><br><span class="line">    Id: <span class="number">3</span>, Name: <span class="string">&quot;zcy&quot;</span>, addr: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">user = <span class="built_in">new</span>(User) <span class="comment">//通过new()函数实体化一个结构体，并返回其指针</span></span><br></pre></td></tr></table></figure><p>构造函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数。返回指针是为了避免值拷贝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUser</span><span class="params">(id <span class="type">int</span>, name <span class="type">string</span>)</span></span> *User &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;User&#123;</span><br><span class="line">Id: id,</span><br><span class="line">Name: name,</span><br><span class="line">addr: <span class="string">&quot;China&quot;</span>,</span><br><span class="line">Score: <span class="number">59</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法接收指针</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//user传的是值，即传的是整个结构体的拷贝。在函数里修改结构体不会影响原来的结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(u user, man <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    u.name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传的是user指针，在函数里修改user的成员会影响原来的结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello2</span><span class="params">(u *user, man <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    u.name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把user理解为hello()的参数，即hello(u user, man string)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span></span> hello(man <span class="type">string</span>) &#123;</span><br><span class="line">    u.name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//可以理解为hello2(u *user, man string)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *user)</span></span> hello2(man <span class="type">string</span>) &#123;</span><br><span class="line">    u.name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结构体嵌套">结构体嵌套</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    sex <span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> paper <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    auther user <span class="comment">//结构体嵌套</span></span><br><span class="line">&#125;</span><br><span class="line">p := <span class="built_in">new</span>(paper)</span><br><span class="line">p.name = <span class="string">&quot;论文标题&quot;</span></span><br><span class="line">p.auther.name = <span class="string">&quot;作者姓名&quot;</span></span><br><span class="line">p.auther.sex = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">    length <span class="type">int</span></span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    user<span class="comment">//匿名字段,可用数据类型当字段名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结构体嵌套时字段名冲突的问题</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v := <span class="built_in">new</span>(vedio)</span><br><span class="line">v.length = <span class="number">13</span></span><br><span class="line">v.name = <span class="string">&quot;视频名称&quot;</span></span><br><span class="line">v.user.sex = <span class="number">0</span> <span class="comment">//通过字段名逐级访问</span></span><br><span class="line">v.sex = <span class="number">0</span> <span class="comment">//对于匿名字段也可以跳过中间字段名，直接访问内部的字段名</span></span><br><span class="line">v.user.name = <span class="string">&quot;作者姓名&quot;</span> <span class="comment">//由于内部、外部结构体都有name这个字段，名字冲突了，所以需要指定中间字段名</span></span><br></pre></td></tr></table></figure><h2 id="深拷贝与浅拷贝">深拷贝与浅拷贝</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">Length <span class="type">int</span></span><br><span class="line">Author User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  Go语言里的赋值都会发生值拷贝。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./deep_copy.png" alt="avatar"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">Length <span class="type">int</span></span><br><span class="line">Author *User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./shallow_copy.png" alt="avatar"></p><ul><li>深拷贝，拷贝的是值，比如Vedio.Length。</li><li>浅拷贝，拷贝的是指针，比如Vedio.Author。</li><li>深拷贝开辟了新的内存空间，修改操作不影响原先的内存。</li><li>浅拷贝指向的还是原来的内存空间，修改操作直接作用在原内存空间上。</li></ul><p>  传slice，对sclice的3个字段进行了拷贝，拷贝的是底层数组的指针，所以修改底层数组的元素会反应到原数组上。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">users := []User&#123;&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_users</span><span class="params">(users []User)</span></span> &#123;</span><br><span class="line">    users[<span class="number">0</span>].Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例">案例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义User结构体</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">//成员变量</span></span><br><span class="line">Id         <span class="type">int</span></span><br><span class="line">Score      <span class="type">float32</span></span><br><span class="line">enrollment time.Time</span><br><span class="line">Name, addr <span class="type">string</span> <span class="comment">//多个字段类型相同时可以简写到一行里</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_struct</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> u User                                                                <span class="comment">//声明，会用相应类型的默认值初始化struct里的每一个字段</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.Id, u.enrollment, u.Name) <span class="comment">//访问结构体的成员变量</span></span><br><span class="line">u = User&#123;&#125;                                                                <span class="comment">//相应类型的默认值初始化struct里的每一个字段</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.Id, u.enrollment, u.Name)</span><br><span class="line">u = User&#123;Id: <span class="number">3</span>, Name: <span class="string">&quot;zcy&quot;</span>&#125; <span class="comment">//赋值初始化</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.Id, u.enrollment, u.Name)</span><br><span class="line">u.enrollment = time.Now()                                                 <span class="comment">//给结构体的成员变量赋值</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.Id, u.enrollment, u.Name) <span class="comment">//访问结构体的成员变量</span></span><br><span class="line">u = User&#123;<span class="number">4</span>, <span class="number">100.0</span>, time.Now(), <span class="string">&quot;zcy&quot;</span>, <span class="string">&quot;beijing&quot;</span>&#125;                          <span class="comment">//赋值初始化，可以不写字段，但需要跟结构体定义里的字段顺序一致</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;id=%d, enrollment=%v, name=%s\n&quot;</span>, u.Id, u.enrollment, u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//成员函数。可以把user理解为hello函数的参数，即hello(u user, man string)</span></span><br><span class="line"><span class="comment">//值实现的方法，指针也实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u User)</span></span> hello(man <span class="type">string</span>) &#123;</span><br><span class="line">u.Name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//user传的是值，即传的是整个结构体的拷贝。在函数里修改结构体不会影响原来的结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(u User, man <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">u.Name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以理解为hello2(u *user, man string)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> hello2(man <span class="type">string</span>) &#123;</span><br><span class="line">u.Name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传的是user指针，在函数里修改user的成员会影响原来的结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello2</span><span class="params">(u *User, man <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">u.Name = <span class="string">&quot;杰克&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, my name is &quot;</span> + u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数里不需要访问user的成员，可以传匿名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_ User)</span></span> think(man <span class="type">string</span>) &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;hi &quot;</span> + man + <span class="string">&quot;, do you know my name?&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_struct_ptr</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> u User</span><br><span class="line">user := &amp;u    <span class="comment">//通过取址符&amp;得到指针</span></span><br><span class="line">user = &amp;User&#123; <span class="comment">//直接创建结构体指针</span></span><br><span class="line">Id: <span class="number">3</span>, Name: <span class="string">&quot;zcy&quot;</span>, addr: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">user = <span class="built_in">new</span>(User) <span class="comment">//通过new()函数实体化一个结构体，并返回其指针</span></span><br><span class="line">user.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">fmt.Println(user.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造函数。返回指针是为了避免值拷贝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUser</span><span class="params">(id <span class="type">int</span>, name <span class="type">string</span>)</span></span> *User &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;User&#123;</span><br><span class="line">Id:    id,</span><br><span class="line">Name:  name,</span><br><span class="line">addr:  <span class="string">&quot;China&quot;</span>,</span><br><span class="line">Score: <span class="number">59</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserMap <span class="keyword">map</span>[<span class="type">int</span>]User <span class="comment">//自定义类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//可以给自定义类型添加任意方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(um UserMap)</span></span> GetUser(id <span class="type">int</span>) User &#123;</span><br><span class="line"><span class="keyword">return</span> um[id]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//匿名结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">anonymous_struct</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> stu <span class="keyword">struct</span> &#123; <span class="comment">//声明stu是一个结构体，但这个结构体是匿名的</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Addr <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">stu.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">stu.Addr = <span class="string">&quot;bj&quot;</span></span><br><span class="line"><span class="comment">//匿名结构体通常用于只使用一次的情况</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;anonymous_struct name is %s\n&quot;</span>, stu.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结构体的匿名成员</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">anonymous_member</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Id      <span class="type">int</span></span><br><span class="line"><span class="type">string</span>  <span class="comment">//匿名字段</span></span><br><span class="line"><span class="type">float32</span> <span class="comment">//直接使用数据类型作为字段名，所以匿名字段中不能出现重复的数据类型</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> stu = Student&#123;Id: <span class="number">1</span>, <span class="type">string</span>: <span class="string">&quot;zcy&quot;</span>, <span class="type">float32</span>: <span class="number">79.5</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;anonymous_member string member=%s float member=%f\n&quot;</span>, stu.<span class="type">string</span>, stu.<span class="type">float32</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结构体嵌套</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nest_struct</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">sex  <span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> paper <span class="keyword">struct</span> &#123;</span><br><span class="line">name   <span class="type">string</span></span><br><span class="line">auther user <span class="comment">//结构体嵌套</span></span><br><span class="line">&#125;</span><br><span class="line">p := <span class="built_in">new</span>(paper)</span><br><span class="line">p.name = <span class="string">&quot;论文标题&quot;</span></span><br><span class="line">p.auther.name = <span class="string">&quot;作者姓名&quot;</span></span><br><span class="line">p.auther.sex = <span class="number">0</span></span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="keyword">type</span> vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">length <span class="type">int</span></span><br><span class="line">name   <span class="type">string</span></span><br><span class="line">user   <span class="comment">//匿名字段，可能直接使用数据类型当字段名</span></span><br><span class="line">&#125;</span><br><span class="line">v := <span class="built_in">new</span>(vedio)</span><br><span class="line">v.length = <span class="number">13</span></span><br><span class="line">v.name = <span class="string">&quot;视频名称&quot;</span></span><br><span class="line">v.user.sex = <span class="number">0</span>       <span class="comment">//通过字段名逐级访问</span></span><br><span class="line">v.sex = <span class="number">0</span>            <span class="comment">//对于匿名字段也可以跳过中间字段名，直接访问内部的字段名</span></span><br><span class="line">v.user.name = <span class="string">&quot;作者姓名&quot;</span> <span class="comment">//由于内部、外部结构体都有name这个字段，名字冲突了，所以需要指定中间字段名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deep_copy</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">Length <span class="type">int</span></span><br><span class="line">Name   <span class="type">string</span></span><br><span class="line">Author User <span class="comment">//如果改成指针类型，对于Author字段就是浅拷贝</span></span><br><span class="line">&#125;</span><br><span class="line">v1 := Vedio&#123;Length: <span class="number">13</span>, Name: <span class="string">&quot;西游记&quot;</span>, Author: User&#123;Name: <span class="string">&quot;吴承恩&quot;</span>, Age: <span class="number">37</span>&#125;&#125;</span><br><span class="line">v2 := v1      <span class="comment">//深拷贝，会为v2申请一块新的内存空间，把v1的成员变量的值都拷贝过去</span></span><br><span class="line">v2.Length = <span class="number">5</span> <span class="comment">//修改v2的成员不会影响到v1</span></span><br><span class="line">v2.Author.Name = <span class="string">&quot;李白&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;length of v1 is %d, author of v1 is %s\n&quot;</span>, v1.Length, v1.Author.Name)</span><br><span class="line">fmt.Printf(<span class="string">&quot;v1 address %p, v2 address %p\n&quot;</span>, &amp;v1, &amp;v2) <span class="comment">//v1跟v2的内存地址不一样</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">shallow_copy</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Vedio <span class="keyword">struct</span> &#123;</span><br><span class="line">Length <span class="type">int</span></span><br><span class="line">Name   <span class="type">string</span></span><br><span class="line">Author User <span class="comment">//如果改成指针类型，对于Author字段就是浅拷贝</span></span><br><span class="line">&#125;</span><br><span class="line">v1 := &amp;Vedio&#123;Length: <span class="number">13</span>, Name: <span class="string">&quot;西游记&quot;</span>, Author: User&#123;Name: <span class="string">&quot;吴承恩&quot;</span>, Age: <span class="number">37</span>&#125;&#125;</span><br><span class="line">v2 := v1      <span class="comment">//v1是个指针，其值是一个地址，把这个地址赋给了v2，所发是浅拷贝，没有发生内存拷贝</span></span><br><span class="line">v2.Length = <span class="number">5</span> <span class="comment">//通过v2（指针）直接修改原内存空间里存的数据，v1也指向这块内存</span></span><br><span class="line">v2.Author.Name = <span class="string">&quot;李白&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;length of v1 is %d, author of v1 is %s\n&quot;</span>, v1.Length, v1.Author.Name)</span><br><span class="line">fmt.Printf(<span class="string">&quot;v1 address %p, v2 address %p\n&quot;</span>, v1, v2) <span class="comment">//v1跟v2的内存地址是一样的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传的是值，深拷贝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_user1</span><span class="params">(user User)</span></span> &#123;</span><br><span class="line">user.Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传的是指针，浅拷贝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_user2</span><span class="params">(user *User)</span></span> &#123;</span><br><span class="line">user.Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传slice，对sclice的3个字段进行了拷贝，拷贝的是底层数组的指针，所以修改底层数组的元素会反应到原数组上</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_users1</span><span class="params">(user []User)</span></span> &#123;</span><br><span class="line">user[<span class="number">0</span>].Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_users2</span><span class="params">(user []*User)</span></span> &#123;</span><br><span class="line">user[<span class="number">0</span>].Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_users3</span><span class="params">(user *[]User)</span></span> &#123;</span><br><span class="line">(*user)[<span class="number">0</span>].Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_users4</span><span class="params">(user *[]*User)</span></span> &#123;</span><br><span class="line">(*user)[<span class="number">0</span>].Name = <span class="string">&quot;光绪&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">init_struct()</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> u User</span><br><span class="line">u.Name = <span class="string">&quot;zcy&quot;</span></span><br><span class="line">u.hello(<span class="string">&quot;Tom&quot;</span>) <span class="comment">//调用成员函数</span></span><br><span class="line">hello(u, <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">fmt.Println(u.Name)</span><br><span class="line">u.hello2(<span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">fmt.Println(u.Name)</span><br><span class="line">hello2(&amp;u, <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">u.think(<span class="string">&quot;Tome&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">init_struct_ptr()</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">um := <span class="built_in">make</span>(UserMap, <span class="number">10</span>)</span><br><span class="line">um[<span class="number">2</span>] = User&#123;Id: <span class="number">2</span>, Name: <span class="string">&quot;zcy&quot;</span>, enrollment: time.Now()&#125;</span><br><span class="line">fmt.Println(um.GetUser(<span class="number">2</span>).Name)</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">anonymous_struct()</span><br><span class="line">anonymous_member()</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">nest_struct()</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">deep_copy()</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">shallow_copy()</span><br><span class="line">fmt.Println(<span class="string">&quot;===================&quot;</span>)</span><br><span class="line">user := User&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;</span><br><span class="line">update_user1(user)</span><br><span class="line">fmt.Println(user.Name)</span><br><span class="line">user = User&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;</span><br><span class="line">update_user2(&amp;user)</span><br><span class="line">fmt.Println(user.Name)</span><br><span class="line">users := []User&#123;&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;&#125;</span><br><span class="line">update_users1(users)</span><br><span class="line">fmt.Println(users[<span class="number">0</span>].Name)</span><br><span class="line">users = []User&#123;&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;&#125;</span><br><span class="line">update_users3(&amp;users)</span><br><span class="line">fmt.Println(users[<span class="number">0</span>].Name)</span><br><span class="line">usersPtr := []*User&#123;&amp;User&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;&#125;</span><br><span class="line">update_users2(usersPtr)</span><br><span class="line">fmt.Println(usersPtr[<span class="number">0</span>].Name)</span><br><span class="line">usersPtr = []*User&#123;&amp;User&#123;Name: <span class="string">&quot;康熙&quot;</span>&#125;&#125;</span><br><span class="line">update_users4(&amp;usersPtr)</span><br><span class="line">fmt.Println(usersPtr[<span class="number">0</span>].Name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang指针</title>
      <link href="/20221209/golang-20221209-golang%E6%8C%87%E9%92%88/"/>
      <url>/20221209/golang-20221209-golang%E6%8C%87%E9%92%88/</url>
      
        <content type="html"><![CDATA[<p>Go语言中的函数传参都是值拷贝，当我们想要修改某个变量的时候，我们可以创建一个指向该变量地址的指针变量。传递数据使用指针，而无需拷贝数据。</p><p>类型指针不能进行偏移和运算</p><p>Go语言中的指针操作非常简单，只需要记住两个符号：<code>&amp;</code>(取地址)和<code>*</code>(根据地址取值)</p><h2 id="1-指针地址和指针类型">1. 指针地址和指针类型</h2><p>每个变量在运行时都拥有一个地址，这个地址代表变量在内存中的位置。Go语言中使用<code>&amp;</code>字符放在变量前面对变量进行<strong>取地址</strong>操作。Go语言中的值类型<code>(int、float、bool、string、array、struct)</code>都有对应的指针类型。如<code>*init、*init64、*string</code>等。</p><h2 id="2-指针语法">2. 指针语法</h2><p>一个指针变量指向了一个值的内存地址。(也就是我们声明了一个指针之后，可以像变量赋值一样，把一个值的内存地址放入到指针当中)</p><p>类似于变量和常量，在使用指针前你需要声明指针。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> var_name *<span class="keyword">var</span>-<span class="keyword">type</span></span><br></pre></td></tr></table></figure><p><code>var-type</code>：为指针类型<br><code>var_name</code>：为指针变量名<br><code>*</code>：用于指定变量是作为一个指针</p><h2 id="3-指针声明">3. 指针声明</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ip *<span class="type">int</span> <span class="comment">// 指向整型</span></span><br><span class="line"><span class="keyword">var</span> fp *<span class="type">float32</span> <span class="comment">// 指向浮点型</span></span><br></pre></td></tr></table></figure><h2 id="4-指针使用实例">4. 指针使用实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">20</span></span><br><span class="line"><span class="keyword">var</span> ip *<span class="type">int</span></span><br><span class="line">ip = &amp;a</span><br><span class="line">fmt.Printf(<span class="string">&quot;ip: %T\n&quot;</span>, ip)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ip: %x\n&quot;</span>, ip)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ip: %v\n&quot;</span>, *ip)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ip: *int<br>ip: c0000a6058<br>ip: 20</p><h2 id="5-指向数组的指针">5. 指向数组的指针</h2><h3 id="5-1-语法">5.1 语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var ptr [MAX]*int // 表示数组里面的元素的类型是指针类型</span><br></pre></td></tr></table></figure><h3 id="5-2-实例">5.2 实例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MAX <span class="type">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">43</span>&#125;</span><br><span class="line"><span class="keyword">var</span> ptr [MAX]*<span class="type">int</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;ptr: %v\n&quot;</span>, ptr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; MAX; i++ &#123;</span><br><span class="line">ptr[i] = &amp;a[i]</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;ptr: %v\n&quot;</span>, ptr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; MAX; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, *ptr[i])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>ptr: [<nil> <nil> <nil>]<br>ptr: [0xc0000ba078 0xc0000ba080 0xc0000ba088]<br>i: 1<br>i: 2<br>i: 43</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang函数</title>
      <link href="/20221208/golang-20221208-golang%E5%87%BD%E6%95%B0/"/>
      <url>/20221208/golang-20221208-golang%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="函数的基本形式">函数的基本形式</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//函数定义。a,b是形参</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">argf</span><span class="params">(a <span class="type">int</span>, b <span class="type">int</span>)</span></span> &#123; </span><br><span class="line">a = a + b </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> x, y <span class="type">int</span> = <span class="number">3</span>, <span class="number">6</span></span><br><span class="line">argf(x, y) <span class="comment">//函数调用。x,y是实参</span></span><br></pre></td></tr></table></figure><ul><li>形参是函数内部的局部变量，实参的值会拷贝给形参。</li><li>函数定义时的第一个的大括号不能另起一行。</li><li>形参可以有0个或多个。</li><li>参数类型相同时可以只写一次，比如argf(a,b int)。</li><li>在函数内部修改形参的值，实参的值不受影响。</li><li>如果想通过函数修改实参，就需要指针类型。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">argf</span><span class="params">(a, b *<span class="type">int</span>)</span></span> &#123; </span><br><span class="line">    *a = *a + *b</span><br><span class="line">    *b = <span class="number">888</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> x, y <span class="type">int</span> = <span class="number">3</span>, <span class="number">6</span></span><br><span class="line">argf(&amp;x, &amp;y)</span><br></pre></td></tr></table></figure><p>  slice、map、channel都是引用类型，它们作为函数参数时其实跟普通struct没什么区别，都是对struct内部的各个字段做一次拷贝传到函数内部。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slice_arg_1</span><span class="params">(arr []<span class="type">int</span>)</span></span> &#123; <span class="comment">//slice作为参数，实际上是把slice的arrayPointer、len、cap拷贝了一份传进来</span></span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">1</span>           <span class="comment">//修改底层数据里的首元素</span></span><br><span class="line">arr = <span class="built_in">append</span>(arr, <span class="number">1</span>) <span class="comment">//arr的len和cap发生了变化，不会影响实参</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">8</span>&#125;</span><br><span class="line">slice_arg_1(arr)</span><br><span class="line">fmt.Println(arr[<span class="number">0</span>])   <span class="comment">//1</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(arr)) <span class="comment">//1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于函数返回值</p><ul><li>可以返回0个或多个参数。</li><li>可以在func行直接声明要返回的变量。</li><li>return后面的语句不会执行。</li><li>无返回参数时return可以不写。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">returnf</span><span class="params">(a, b <span class="type">int</span>)</span></span> (c <span class="type">int</span>) &#123; <span class="comment">//返回变量c已经声明好了</span></span><br><span class="line">    a = a + b</span><br><span class="line">    c = a <span class="comment">//直接使用c</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">//由于函数要求有返回值，即使给c赋过值了，也需要显式写return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  不定长参数实际上是slice类型。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">variable_ength_arg</span><span class="params">(a <span class="type">int</span>, other ...<span class="type">int</span>)</span></span> <span class="type">int</span> &#123; </span><br><span class="line">    sum := a</span><br><span class="line">    <span class="keyword">for</span> _, ele := <span class="keyword">range</span> other &#123;<span class="comment">//不定长参数实际上是slice类型</span></span><br><span class="line">        sum += ele</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;len %d cap %d\n&quot;</span>, <span class="built_in">len</span>(other), <span class="built_in">cap</span>(other))</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line">variable_ength_arg(<span class="number">1</span>)</span><br><span class="line">variable_ength_arg(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>  append函数接收的就是不定长参数。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">arr = <span class="built_in">append</span>(arr, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">arr = <span class="built_in">append</span>(arr, <span class="number">7</span>)</span><br><span class="line">arr = <span class="built_in">append</span>(arr)</span><br><span class="line">slice := <span class="built_in">append</span>([]<span class="type">byte</span>(<span class="string">&quot;hello &quot;</span>), <span class="string">&quot;world&quot;</span>...) <span class="comment">//...自动把&quot;world&quot;转成byte切片，等价于[]byte(&quot;world&quot;)...</span></span><br><span class="line">slice2 := <span class="built_in">append</span>([]<span class="type">rune</span>(<span class="string">&quot;hello &quot;</span>), []<span class="type">rune</span>(<span class="string">&quot;world&quot;</span>)...) <span class="comment">//需要显式把&quot;world&quot;转成rune切片</span></span><br></pre></td></tr></table></figure><p>  在很多场景下string都隐式的转换成了byte切片，而非rune切片，比如&quot;a中&quot;[1]是228而非&quot;中&quot;。<br>递归函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fibonacci</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> || n == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n <span class="comment">//凡是递归，一定要有终止条件，否则会进入无限循环</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Fibonacci(n<span class="number">-1</span>) + Fibonacci(n<span class="number">-2</span>) <span class="comment">//递归调用函数自身</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="匿名函数">匿名函数</h2><p>  函数也是一种数据类型。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">function_arg1</span><span class="params">(f <span class="keyword">func</span>(a, b <span class="type">int</span>)</span></span> <span class="type">int</span>, b <span class="type">int</span>) <span class="type">int</span> &#123; <span class="comment">//f参数是一种函数类型</span></span><br><span class="line">a := <span class="number">2</span> * b</span><br><span class="line"><span class="keyword">return</span> f(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> foo <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> <span class="comment">//foo是一种函数类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">function_arg2</span><span class="params">(f foo, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123; <span class="comment">//参数类型看上去简洁多了</span></span><br><span class="line">    a := <span class="number">2</span> * b</span><br><span class="line">    <span class="keyword">return</span> f(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    bye foo <span class="comment">//bye的类型是foo，而foo代表一种函数类型</span></span><br><span class="line">    hello <span class="function"><span class="keyword">func</span><span class="params">(name <span class="type">string</span>)</span></span> <span class="type">string</span> <span class="comment">//使用匿名函数来声明struct字段的类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span>, <span class="number">10</span>)</span><br><span class="line">ch &lt;- <span class="function"><span class="keyword">func</span><span class="params">(name <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;  <span class="comment">//使用匿名函数</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello &quot;</span> + name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="闭包">闭包</h2><p>  闭包（Closure）是引用了自由变量的函数，自由变量将和函数一同存在，即使已经离开了创造它的环境。闭包复制的是原对象的指针。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//闭包（Closure）是引用了自由变量的函数。自由变量将和函数一同存在，即使已经离开了创造它的环境。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := <span class="number">10</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;i)</span><br><span class="line">b := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;i addr %p\n&quot;</span>, &amp;i) <span class="comment">//闭包复制的是原对象的指针</span></span><br><span class="line">i--                           <span class="comment">//b函数内部引用了变量i</span></span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> b <span class="comment">//返回了b函数，变量i和b函数将一起存在，即使已经离开函数sub()</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外部引用函数参数局部变量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(base <span class="type">int</span>)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;base addr %p\n&quot;</span>, &amp;base)</span><br><span class="line">base += i</span><br><span class="line"><span class="keyword">return</span> base</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">b := sub()</span><br><span class="line">b()</span><br><span class="line">b()</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line">tmp1 := add(<span class="number">10</span>)</span><br><span class="line">fmt.Println(tmp1(<span class="number">1</span>), tmp1(<span class="number">2</span>)) <span class="comment">//11,13</span></span><br><span class="line"><span class="comment">// 此时tmp1和tmp2不是一个实体了</span></span><br><span class="line">tmp2 := add(<span class="number">100</span>)</span><br><span class="line">fmt.Println(tmp2(<span class="number">1</span>), tmp2(<span class="number">2</span>)) <span class="comment">//101,103</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="递归函数">递归函数</h2><p>  函数内部调用函数自身的函数称为递归函数</p><p>  使用递归函数最重要的三点：</p><ol><li>递归就是自己调用自己</li><li>必须先定义函数的退出条件，没有退出条件，递归将称为死循环</li><li>go语言递归函数很可能会产生一大堆的goroutine，也很可能会出现栈空间内存溢出问题</li></ol><p><strong>阶乘</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">n := <span class="number">5</span></span><br><span class="line">r := a(n)</span><br><span class="line">fmt.Printf(<span class="string">&quot;r: %v\n&quot;</span>, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="comment">// 返回条件</span></span><br><span class="line"><span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 自己调用自己</span></span><br><span class="line"><span class="keyword">return</span> n * a(n<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>r: 120</p><p><strong>斐波那契序列</strong><br>计算公式 <code>f(n)=f(n-1)+f(n-2)</code>且<code>f(2)=f(1)=1</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := f(<span class="number">6</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i: %v\n&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="comment">// 退出点判断</span></span><br><span class="line"><span class="keyword">if</span> n == <span class="number">1</span> || n == <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 递归表达式</span></span><br><span class="line"><span class="keyword">return</span> f(n<span class="number">-1</span>) + f(n<span class="number">-2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行结果：</p><p>i: 8</p><h2 id="延迟调用defer">延迟调用defer</h2><ul><li>defer用于注册一个延迟调用（在函数返回之前调用）。</li><li>defer典型的应用场景是释放资源，比如关闭文件句柄，释放数据库连接等。</li><li>如果同一个函数里有多个defer，则后注册的先执行。</li><li>defer后可以跟一个func，func内部如果发生panic，会把panic暂时搁置，当把其他defer执行完之后再来执行这个。</li><li>defer后不是跟func，而直接跟一条执行语句，则相关变量在注册defer时被拷贝或计算。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">basic</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="number">1</span>) fmt.Println(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">    <span class="comment">//如果同一个函数里有多个defer，则后注册的先执行</span></span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="number">2</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">defer_exe_time</span><span class="params">()</span></span> (i <span class="type">int</span>) &#123;</span><br><span class="line">i = <span class="number">9</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//defer后可以跟一个func</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;first i=%d\n&quot;</span>, i) <span class="comment">//打印5，而非9。充分理解“defer在函数返回前执行”的含义，不是在“return语句前执行defer”</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;second i=%d\n&quot;</span>, i) <span class="comment">//打印9</span></span><br><span class="line">&#125;(i)</span><br><span class="line"><span class="keyword">defer</span> fmt.Printf(<span class="string">&quot;third i=%d\n&quot;</span>, i) <span class="comment">//defer后不是跟func，而直接跟一条执行语句，则相关变量在注册defer时被拷贝或计算</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="异常处理">异常处理</h2><p>  go语言没有try catch，它提倡返回error。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">int</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>, errors.New(<span class="string">&quot;divide by zero&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> res, err := divide(<span class="number">3</span>, <span class="number">0</span>); err != <span class="literal">nil</span> &#123;<span class="comment">//函数调用方判断error是否为nil</span></span><br><span class="line">    fmt.Println(err.Error())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  Go语言定义了error这个接口，自定义的error要实现Error()方法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;    <span class="comment">//自定义error</span></span><br><span class="line">    path <span class="type">string</span></span><br><span class="line">    op <span class="type">string</span></span><br><span class="line">    createTime <span class="type">string</span></span><br><span class="line">    message <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(err PathError)</span></span> Error() <span class="type">string</span> &#123;    <span class="comment">//error接口要求实现Error() string方法</span></span><br><span class="line"><span class="keyword">return</span> err.createTime + <span class="string">&quot;: &quot;</span> + err.op + <span class="string">&quot; &quot;</span> + err.path + <span class="string">&quot; &quot;</span> + err.message</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>何时会发生panic:</p><ul><li>运行时错误会导致panic，比如数组越界、除0。</li><li>程序主动调用panic(error)。</li></ul><p>panic会执行什么：</p><ol><li>逆序执行当前goroutine的defer链（recover从这里介入）。</li><li>打印错误信息和调用堆栈。</li><li>调用exit(2)结束整个进程。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">soo</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;enter soo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//去掉这个defer试试，看看panic的流程。把这个defer放到soo函数末尾试试</span></span><br><span class="line"><span class="comment">//recover必须在defer中才能生效</span></span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;soo函数中发生了panic:%s\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">fmt.Println(<span class="string">&quot;regist recover&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">n := <span class="number">0</span></span><br><span class="line">_ = <span class="number">3</span> / n <span class="comment">//除0异常，发生panic，下一行的defer没有注册成功</span></span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;how are you&quot;</span>)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang流程控制</title>
      <link href="/20221203/golang-20221203-golang%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/"/>
      <url>/20221203/golang-20221203-golang%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="if">if</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="number">5</span> &gt; <span class="number">9</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;5&gt;9&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果逻辑表达式成立，就会执行{}里的内容。</li><li>逻辑表达式不需要加()。</li><li>&quot;{&quot;必须紧跟在逻辑表达式后面，不能另起一行。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c, d, e := <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>; c &lt; d &amp;&amp; (c &gt; e || c &gt; <span class="number">3</span>) &#123; <span class="comment">//初始化多个局部变量。复杂的逻辑表达式</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;fit&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>逻辑表达中可以含有变量或常量。</li><li>if句子中允许包含1个(仅1个)分号，在分号前初始化一些局部变量(即只在if块内可见)。</li></ul><p>if-else的用法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">color := <span class="string">&quot;black&quot;</span></span><br><span class="line"><span class="keyword">if</span> color == <span class="string">&quot;red&quot;</span> &#123; <span class="comment">//if只能有一个</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> color == <span class="string">&quot;green&quot;</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;go&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> color == <span class="string">&quot;yellow&quot;</span> &#123; <span class="comment">//else if可以有0个、一个或者连续多个</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//else有0个或1个</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;invalid traffic signal: %s\n&quot;</span>, strings.ToUpper(color))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>if表达式嵌套</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> xxx &#123;</span><br><span class="line">    <span class="keyword">if</span> xxx &#123;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> xxx&#123;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> xxx &#123;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  注意太深的嵌套不利于代码的维护，比如</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="switch">switch</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">color := <span class="string">&quot;black&quot;</span></span><br><span class="line"><span class="keyword">switch</span> color &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;green&quot;</span> :<span class="comment">//相当于  if color== &quot;green&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;go&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;red&quot;</span> :<span class="comment">//相当于else if color== &quot;red&quot; </span></span><br><span class="line">fmt.Println(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>: <span class="comment">//相当于else </span></span><br><span class="line">fmt.Printf(<span class="string">&quot;invalid traffic signal: %s\n&quot;</span>, strings.ToUpper(color))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>switch-case-default可能模拟if-else if-else，但只能实现相等判断。</li><li>switch和case后面可以跟常量、变量或函数表达式，只要它们表示的数据类型相同就行。</li><li>case后面可以跟多个值，只要有一个值满足就行。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">switch_expression</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">switch</span> add(a) &#123; <span class="comment">//switch后跟一个函数表达式</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">15</span>: <span class="comment">//case后跟一个常量</span></span><br><span class="line">fmt.Println(<span class="string">&quot;right&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;wrong&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> B = <span class="number">15</span></span><br><span class="line"><span class="keyword">switch</span> B &#123; <span class="comment">//switch后跟一个常量</span></span><br><span class="line"><span class="keyword">case</span> add(a): <span class="comment">//case后跟一个函数表达式</span></span><br><span class="line">fmt.Println(<span class="string">&quot;right&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;wrong&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  switch后带表达式时，switch-case只能模拟相等的情况；如果switch后不带表达式，case后就可以跟任意的条件表达式。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">switch_condition</span><span class="params">()</span></span> &#123;</span><br><span class="line">color := <span class="string">&quot;yellow&quot;</span></span><br><span class="line"><span class="keyword">switch</span> color &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;green&quot;</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;go&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;red&quot;</span>, <span class="string">&quot;yellow&quot;</span>: <span class="comment">//用逗号分隔多个condition，它们之间是“或”的关系，只需要有一个condition满足就行</span></span><br><span class="line">fmt.Println(<span class="string">&quot;stop&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//switch后带表达式时，switch-case只能模拟相等的情况；如果switch后不带表达式，case后就可以跟任意的条件表达式</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> add(<span class="number">5</span>) &gt; <span class="number">10</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;right&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;wrong&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>switch Type</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">switch_type</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> num <span class="keyword">interface</span>&#123;&#125; = <span class="number">6.5</span></span><br><span class="line"><span class="keyword">switch</span> num.(<span class="keyword">type</span>) &#123; <span class="comment">//获取interface的具体类型。.(type)只能用在switch后面</span></span><br><span class="line"><span class="keyword">case</span> <span class="type">int</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;int&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="type">float32</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;float32&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="type">float64</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;float64&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="type">byte</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;byte&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;neither&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> value := num.(<span class="keyword">type</span>) &#123; <span class="comment">//相当于在每个case内部申明了一个变量value</span></span><br><span class="line"><span class="keyword">case</span> <span class="type">int</span>: <span class="comment">//value已被转换为int类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;number is int %d\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">case</span> <span class="type">float64</span>: <span class="comment">//value已被转换为float64类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;number is float64 %f\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">case</span> <span class="type">byte</span>, <span class="type">string</span>: <span class="comment">//如果case后有多个类型，则value还是interface&#123;&#125;类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;number is inerface %v\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;neither&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等价形式</span></span><br><span class="line"><span class="keyword">switch</span> num.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="type">int</span>:</span><br><span class="line">value := num.(<span class="type">int</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;number is int %d\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">case</span> <span class="type">float64</span>:</span><br><span class="line">value := num.(<span class="type">float64</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;number is float64 %f\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">case</span> <span class="type">byte</span>:</span><br><span class="line">value := num.(<span class="type">byte</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;number is byte %d\n&quot;</span>, value)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;neither&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fallthrough，当命中某一个case时，强行进入下一个case。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fall_throth</span><span class="params">(age <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;您的年龄是%d, 您可以：\n&quot;</span>, age)</span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">50</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;出任国家首脑&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">25</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;生育子女&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">22</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;结婚&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">38</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;开车&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">16</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;参加工作&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">15</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;上高中&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> age &gt; <span class="number">3</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;上幼儿园&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="for">for</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123; <span class="comment">//正序遍历切片</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%d: %d\n&quot;</span>, i, arr[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>for 初始化局部变量;条件表达式;后续操作</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sum, i := <span class="number">0</span>, <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr) &amp;&amp; sum &lt; <span class="number">100</span>; sum, i = sum*<span class="number">1</span>, i+<span class="number">1</span></span><br></pre></td></tr></table></figure><ul><li>局部变量指仅在for块内可见。</li><li>初始化变量可以放在for上面。</li><li>后续操作可以放在for块内部。</li><li>只有条件判断时，前后的分号可以不要。</li><li>for{}是一个无限循环。</li></ul><p>for range</p><ul><li>遍历数组或切片<ul><li>for i, ele := range arr</li></ul></li><li>遍历string<ul><li>for i, ele := range “我会唱ABC”//ele是rune类型</li></ul></li><li>遍历map，go不保证遍历的顺序<ul><li>for key, value := range m</li></ul></li><li>遍历channel，遍历前一定要先close<ul><li>for ele := range ch</li><li>for range拿到的是数据的拷贝</li></ul></li></ul><p>for嵌套<br>  矩阵乘法需要用到三层for循环嵌套。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./mat_mul.png" alt="avatar"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nest_for</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> SIZE = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">A := [SIZE][SIZE]<span class="type">float64</span>&#123;&#125;</span><br><span class="line"><span class="comment">//初始化二维数组</span></span><br><span class="line"><span class="comment">//两层for循环嵌套</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line">A[i][j] = rand.Float64() <span class="comment">//[0,1)上的随机数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B := [SIZE][SIZE]<span class="type">float64</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line">B[i][j] = rand.Float64() <span class="comment">//[0,1)上的随机数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rect := [SIZE][SIZE]<span class="type">float64</span>&#123;&#125;</span><br><span class="line"><span class="comment">//三层for循环嵌套</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line">prod := <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> k := <span class="number">0</span>; k &lt; SIZE; k++ &#123;</span><br><span class="line">prod += A[i][k] * B[k][j]</span><br><span class="line">&#125;</span><br><span class="line">rect[i][j] = prod</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i, j := <span class="number">2</span>, <span class="number">1</span></span><br><span class="line">fmt.Println(A[i]) <span class="comment">//二维数组第i行</span></span><br><span class="line"><span class="comment">//打印二维数组的第j列</span></span><br><span class="line"><span class="comment">//注意：B[:][j]这不是二维数组第j列，这是二维数组第j行！</span></span><br><span class="line"><span class="keyword">for</span> _, row := <span class="keyword">range</span> B &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%g &quot;</span>, row[j])</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">fmt.Println(rect[i][j])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="break与continue">break与continue</h2><ul><li>break与continue用于控制for循环的代码流程，并且只针对最靠近自己的外层for循环。</li><li>break:退出for循环，且本轮break下面的代码不再执行。</li><li>continue:本轮continue下面的代码不再执行，进入for循环的下一轮。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//break和continue都是针对for循环的，不针对if或switch</span></span><br><span class="line"><span class="comment">//break和continue都是针对套在自己外面的最靠里的那层for循环，不针对更外层的for循环（除非使用Label）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">complex_break_continue</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> SIZE = <span class="number">5</span></span><br><span class="line">arr := [SIZE][SIZE]<span class="type">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;开始检查第%d行\n&quot;</span>, i)</span><br><span class="line"><span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;开始检查第%d列\n&quot;</span>, j)</span><br><span class="line"><span class="keyword">if</span> arr[i][j]%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span> <span class="comment">//针对第二层for循环</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;将要检查第%d列\n&quot;</span>, j+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span> <span class="comment">//针对第一层for循环</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="goto与Label">goto与Label</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">4</span></span><br><span class="line">MY_LABEL:</span><br><span class="line">i += <span class="number">3</span></span><br><span class="line">fmt.Println(i)</span><br><span class="line"><span class="keyword">goto</span> MY_LABEL <span class="comment">//返回定义MY_LABEL的那一行，把代码再执行一遍（会进入一个无限循环）</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> L1 <span class="comment">//Label指示的是某一行代码，并没有圈定一个代码块，所以goto L1也会执行L2后的代码</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> L2<span class="comment">//先使用Label</span></span><br><span class="line">&#125;</span><br><span class="line">L1: </span><br><span class="line">i += <span class="number">3</span></span><br><span class="line">L2: <span class="comment">//后定义Label。Label定义后必须在代码的某个地方被使用</span></span><br><span class="line">i *= <span class="number">3</span></span><br></pre></td></tr></table></figure><p>  goto与Label结合可以实现break的功能，甚至比break更强大。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line">L2:</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line"><span class="keyword">goto</span> L1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">L1:</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure><ul><li>break、continue与Label结合使用可以跳转到更外层的for循环。</li><li>continue和break针对的Label必须写在for前面，而goto可以针对任意位置的Label。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">break_label</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> SIZE = <span class="number">5</span></span><br><span class="line">arr := [SIZE][SIZE]<span class="type">int</span>&#123;&#125;</span><br><span class="line">L1:</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; SIZE; i++ &#123;</span><br><span class="line">L2:</span><br><span class="line">fmt.Printf(<span class="string">&quot;开始检查第%d行\n&quot;</span>, i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line">L3:</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; SIZE; j++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;开始检查第%d列\n&quot;</span>, j)</span><br><span class="line"><span class="keyword">if</span> arr[i][j]%<span class="number">3</span> == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">break</span> L1 <span class="comment">//直接退出最外层的fot循环</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> arr[i][j]%<span class="number">3</span> == <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> L2 <span class="comment">//continue和break针对的Label必须写在for前面，而goto可以针对任意位置的Label</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span> L3</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang格式化输出</title>
      <link href="/20221202/golang-20221202-golang%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA/"/>
      <url>/20221202/golang-20221202-golang%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WebSite <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> site = WebSite&#123;Name: <span class="string">&quot;ren123&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="普通占位符">普通占位符</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%v</td><td>相应值的默认格式</td><td>fmt.Printf(“site: %v\n”, site)</td><td>site: {ren123}</td></tr><tr><td>%#v</td><td>响应值的Go语法表示</td><td>fmt.Printf(“site: %#v\n”, site)</td><td>site: main.WebSite{Name:“ren123”}</td></tr><tr><td>%T</td><td>相应值的类型的Go语法表示</td><td>fmt.Printf(“site: %T\n”, site)</td><td>site: main.WebSite</td></tr><tr><td>%%</td><td>字面上的百分号，并非值的占位符</td><td>fmt.Printf(“site: %%\n”, site)</td><td>site: %</td></tr></tbody></table><h2 id="布尔占位符">布尔占位符</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%t</td><td>单词true或false</td><td>fmt.Printf(“b: %t\n”, b)</td><td>b: true</td></tr></tbody></table><h2 id="整数占位符">整数占位符</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%b</td><td>二进制表示</td><td>fmt.Printf(“%b\n”, 5)</td><td>101</td></tr><tr><td>%c</td><td>相应Unicode码点所表示的字符</td><td>fmt.Printf(“%c\n”, 0x4E2D)</td><td>中</td></tr><tr><td>%d</td><td>十进制表示</td><td>fmt.Printf(“%d\n”, 0x12)</td><td>18</td></tr><tr><td>%o</td><td>八进制表示</td><td>fmt.Printf(“%o\n”, 0x12)</td><td>22</td></tr><tr><td>%q</td><td>单引号围绕的字符字面值，由Go语法安全的转义</td><td>fmt.Printf(“%q\n”, 0x4E2D)</td><td>‘中’</td></tr><tr><td>%x</td><td>十六进制表示，字母形式为小写a-f</td><td>fmt.Printf(“%x\n”, 13)</td><td>d</td></tr><tr><td>%X</td><td>十六进制表示，字母形式为大写A-F</td><td>fmt.Printf(“%X\n”, 13)</td><td>D</td></tr><tr><td>%U</td><td>Unicode格式，U+1234，等于&quot;U+%04X&quot;</td><td>fmt.Printf(“%U\n”, 0x4E2D)</td><td>U+4E2D</td></tr></tbody></table><h2 id="浮点数和复数的组成部分（实部和虚部）">浮点数和复数的组成部分（实部和虚部）</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%b</td><td>无小数部分的，指数为二的幂的科学计数法，与strconv.FormatFloat的<code>'b'</code>转换格式一致。例如-12345p-78</td><td>fmt.Printf(“%b\n”, 10.2)</td><td>5742089524897382p-49</td></tr><tr><td>%e</td><td>科学计数法，例如-1234.456e+78</td><td>fmt.Printf(“%e\n”, 10.2)</td><td>1.020000e+01</td></tr><tr><td>%E</td><td>科学计数法，例如-1234.456E+78</td><td>fmt.Printf(“%E\n”, 10.2)</td><td>1.020000E+01</td></tr><tr><td>%f</td><td>有小数点而无指数，例如123.456</td><td>fmt.Printf(“%f\n”, 10.2)}</td><td>10.200000</td></tr><tr><td>%g</td><td>根据情况选择%e或%f以产生更紧凑的(无末尾的0)输出</td><td>fmt.Printf(“%g\n”, 10.2)</td><td>10.2</td></tr><tr><td>%G</td><td>根据情况选择%E或%f以产生更紧凑的(无末尾的0)输出</td><td>fmt.Printf(“%G\n”, 10.2)</td><td>10.2</td></tr></tbody></table><h2 id="字符串与字节切片">字符串与字节切片</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%s</td><td>输出字符串表示(string类型或[]byte)</td><td>fmt.Printf(“%s\n”, []byte(“叫爸爸”))</td><td>叫爸爸</td></tr><tr><td>%q</td><td>双引号围绕的字符串，由Go语法安全的转义</td><td>fmt.Printf(“%q\n”, []byte(“叫爸爸”))</td><td>“叫爸爸”</td></tr><tr><td>%x</td><td>十六进制，小写字母，每个字节两个字符</td><td>fmt.Printf(“%x\n”, “golang”)</td><td>676f6c616e67</td></tr><tr><td>%X</td><td>十六进制，大写字母，每个字节两个字符</td><td>fmt.Printf(“%X\n”, “golang”)</td><td>676F6C616E67</td></tr></tbody></table><h2 id="指针">指针</h2><table><thead><tr><th>占位符</th><th>说明</th><th>举例</th><th>输出</th></tr></thead><tbody><tr><td>%p</td><td>十六进制表示，前缀0x</td><td>fmt.Printf(“site: %p\n”, &amp;site)</td><td>site: 0x6ae020</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang数据类型</title>
      <link href="/20221125/golang-20221125-golang%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
      <url>/20221125/golang-20221125-golang%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="数据类型概览">数据类型概览</h2><p>基础数据类型</p><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">长度(字节)</th><th style="text-align:center">默认值</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">bool</td><td style="text-align:center">1</td><td style="text-align:center">false</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">byte</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">uint8，取值范围[0,255]</td></tr><tr><td style="text-align:center">rune</td><td style="text-align:center">4</td><td style="text-align:center">0</td><td style="text-align:center">Unicode Code Point, int32</td></tr><tr><td style="text-align:center">int, uint</td><td style="text-align:center">4或8</td><td style="text-align:center">0</td><td style="text-align:center">32 或 64 位，取决于操作系统</td></tr><tr><td style="text-align:center">int8, uint8</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">-128 ~ 127, 0 ~ 255</td></tr><tr><td style="text-align:center">int16, uint16</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">-32768 ~ 32767, 0 ~ 65535</td></tr><tr><td style="text-align:center">int32, uint32</td><td style="text-align:center">4</td><td style="text-align:center">0</td><td style="text-align:center">-21亿~ 21亿, 0 ~ 42亿，rune是int32 的别名</td></tr><tr><td style="text-align:center">int64, uint64</td><td style="text-align:center">8</td><td style="text-align:center">0</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">float32</td><td style="text-align:center">4</td><td style="text-align:center">0.0</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">float64</td><td style="text-align:center">8</td><td style="text-align:center">0.0</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">complex64</td><td style="text-align:center">8</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">complex128</td><td style="text-align:center">16</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">uintptr</td><td style="text-align:center">4或8</td><td style="text-align:center"></td><td style="text-align:center">以存储指针的 uint32 或 uint64 整数</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;os arch %s, int size %d\n&quot;</span>, runtime.GOARCH, strconv.IntSize) <span class="comment">//int是4字节还是8字节，取决于操作系统是32位还是64位</span></span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">int8</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> c <span class="type">int16</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> d <span class="type">int32</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> e <span class="type">int64</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> f <span class="type">uint</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> g <span class="type">uint8</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> h <span class="type">uint16</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> i <span class="type">uint32</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> j <span class="type">uint64</span> = <span class="number">5</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;a=%d, b=%d, c=%d, d=%d, e=%d, f=%d, g=%d, h=%d, i=%d, j=%d\n&quot;</span>, a, b, c, d, e, f, g, h, i, j)</span><br><span class="line"><span class="keyword">var</span> k <span class="type">float32</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">var</span> l <span class="type">float64</span> = <span class="number">5</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;k=%f, l=%.2f\n&quot;</span>, k, l) <span class="comment">//%.2f保留2位小数</span></span><br><span class="line"><span class="keyword">var</span> m <span class="type">complex128</span> = <span class="built_in">complex</span>(<span class="number">4</span>, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">var</span> n <span class="type">complex64</span> = <span class="built_in">complex</span>(<span class="number">4</span>, <span class="number">7</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;type of m is %T, type of n is %T\n&quot;</span>, m, n) <span class="comment">//%T输出变量类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;m=%v, n=%v\n&quot;</span>, m, n)                       <span class="comment">//按值的本来值输出</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;m=%+v, n=%+v\n&quot;</span>, m, n)                     <span class="comment">//在 %v 基础上，对结构体字段名和值进行展开</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;m=%#v, n=%#v\n&quot;</span>, m, n)                     <span class="comment">//输出 Go 语言语法格式的值</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;m的实部%f, m的虚部%f\n&quot;</span>, <span class="built_in">real</span>(m), <span class="built_in">imag</span>(m))</span><br><span class="line">fmt.Printf(<span class="string">&quot;m的实部%e, m的虚部%g\n&quot;</span>, <span class="built_in">real</span>(m), <span class="built_in">imag</span>(m)) <span class="comment">//%e科学计数法，%g根据实际情况采用%e或%f格式（以获得更简洁、准确的输出）</span></span><br><span class="line">o := <span class="literal">true</span>                                        <span class="comment">//等价于var o bool = true</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;o=%t\n&quot;</span>, o)                          <span class="comment">//%t布尔变量</span></span><br><span class="line"><span class="keyword">var</span> pointer unsafe.Pointer = unsafe.Pointer(&amp;a)</span><br><span class="line"><span class="keyword">var</span> p <span class="type">uintptr</span> = <span class="type">uintptr</span>(pointer)</span><br><span class="line"><span class="keyword">var</span> ptr *<span class="type">int</span> = &amp;a</span><br><span class="line">fmt.Printf(<span class="string">&quot;p=%x pointer=%p ptr=%p\n&quot;</span>, p, pointer, ptr) <span class="comment">//%p输出地址，%x十六进制</span></span><br><span class="line"><span class="keyword">var</span> q <span class="type">byte</span> = <span class="number">100</span>                                        <span class="comment">//byte是uint，取值范围[0,255]</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;q=%d, binary of q is %b\n&quot;</span>, q, q)           <span class="comment">//%b输出二进制</span></span><br><span class="line"><span class="keyword">var</span> r <span class="type">rune</span> = <span class="string">&#x27;☻&#x27;</span>                                        <span class="comment">//rune实际上是int32，即可以表示2147483647种字符，包括所有汉字和各种特殊符号</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;r=%d, r=%U\n&quot;</span>, r, r)                        <span class="comment">//%U Unicode 字符</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span> = <span class="string">&quot;I&#x27;m 张朝阳&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s=%s\n&quot;</span>, s)</span><br><span class="line"><span class="keyword">var</span> t <span class="type">error</span> = errors.New(<span class="string">&quot;my error&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;error is %v\n&quot;</span>, t)</span><br><span class="line">fmt.Printf(<span class="string">&quot;error is %+v\n&quot;</span>, t) <span class="comment">//在 %v 基础上，对结构体字段名和值进行展开</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;error is %#v\n&quot;</span>, t) <span class="comment">//输出 Go 语言语法格式的值</span></span><br></pre></td></tr></table></figure><p>  数值型变量的默认值是0，字符串的默认值是空字符串，布尔型变量的默认值是false，引用类型、函数、指针、接口的默认值是nil。数组的默认值取每个元素对应类型的默认值，结构体的默认值取每个成员变量对应类型的默认值。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">byte</span></span><br><span class="line"><span class="keyword">var</span> f <span class="type">float32</span></span><br><span class="line"><span class="keyword">var</span> t <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> r <span class="type">rune</span></span><br><span class="line"><span class="keyword">var</span> arr [<span class="number">3</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> slc []<span class="type">int</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of int %d\n&quot;</span>, a)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of byte %d\n&quot;</span>, b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of float %.2f\n&quot;</span>, f)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of bool %t\n&quot;</span>, t)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of string [%s]\n&quot;</span>, s)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default value of rune %d, [%c]\n&quot;</span>, r, r)</span><br><span class="line">fmt.Printf(<span class="string">&quot;default int array is %v\n&quot;</span>, arr) <span class="comment">//取每个元素对应类型的默认值</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;default slice is nil %t\n&quot;</span>, slc == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line"><span class="keyword">default</span> value of <span class="type">int</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">default</span> value of <span class="type">byte</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">default</span> value of float <span class="number">0.00</span></span><br><span class="line"><span class="keyword">default</span> value of <span class="type">bool</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">default</span> value of <span class="type">string</span> []</span><br><span class="line"><span class="keyword">default</span> value of <span class="type">rune</span> <span class="number">0</span>, []</span><br><span class="line"><span class="keyword">default</span> <span class="type">int</span> array is [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"><span class="keyword">default</span> slice is <span class="literal">nil</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>复合数据类型</p><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">默认值</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">array</td><td style="text-align:center">取每个元素对应类型的默认值</td><td style="text-align:center">值类型</td></tr><tr><td style="text-align:center">struct</td><td style="text-align:center">取每个成员变量对应类型的默认值</td><td style="text-align:center">值类型</td></tr><tr><td style="text-align:center">string</td><td style="text-align:center">“”</td><td style="text-align:center">UTF-8 字符串</td></tr><tr><td style="text-align:center">slice</td><td style="text-align:center">nil</td><td style="text-align:center">引用类型</td></tr><tr><td style="text-align:center">map</td><td style="text-align:center">nil</td><td style="text-align:center">引用类型</td></tr><tr><td style="text-align:center">channel</td><td style="text-align:center">nil</td><td style="text-align:center">引用类型</td></tr><tr><td style="text-align:center">interface</td><td style="text-align:center">nil</td><td style="text-align:center">接口</td></tr><tr><td style="text-align:center">function</td><td style="text-align:center">nil</td><td style="text-align:center">函数</td></tr></tbody></table><h2 id="自定义类型">自定义类型</h2><p>类型别名</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">byte</span> = <span class="type">uint8</span></span><br><span class="line"><span class="keyword">type</span> <span class="type">rune</span> = <span class="type">int32</span></span><br><span class="line"><span class="keyword">type</span> semaphore = <span class="type">uint8</span></span><br></pre></td></tr></table></figure><p>自定义类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;name <span class="type">string</span>;age <span class="type">int</span>&#125;  <span class="comment">//用分号把多行代码隔开</span></span><br><span class="line"><span class="keyword">type</span> signal <span class="type">uint8</span></span><br><span class="line"><span class="keyword">type</span> ms <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line"><span class="keyword">type</span> add <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span></span><br></pre></td></tr></table></figure><h2 id="数组">数组</h2><p>  数组是块连续的内存空间，在声明的时候必须指定长度，且长度不能改变。所以数组在声明的时候就可以把内存空间分配好，并赋上默认值，即完成了初始化。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./array.png" alt="avatar"></p><p>一维数组初始化</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr1 [<span class="number">5</span>]<span class="type">int</span> = [<span class="number">5</span>]<span class="type">int</span>&#123;&#125; <span class="comment">//数组必须指定长度和类型，且长度和类型指定后不可改变</span></span><br><span class="line"><span class="keyword">var</span> arr2 = [<span class="number">5</span>]<span class="type">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> arr3 = [<span class="number">5</span>]<span class="type">int</span>&#123;<span class="number">3</span>, <span class="number">2</span>&#125; <span class="comment">//给前2个元素赋值</span></span><br><span class="line"><span class="keyword">var</span> arr4 = [<span class="number">5</span>]<span class="type">int</span>&#123;<span class="number">2</span>: <span class="number">15</span>, <span class="number">4</span>: <span class="number">30</span>&#125; <span class="comment">//指定index赋值</span></span><br><span class="line"><span class="keyword">var</span> arr5 = [...]<span class="type">int</span>&#123;<span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>&#125;<span class="comment">//根据&#123;&#125;里元素的个数推断出数组的长度</span></span><br><span class="line"><span class="keyword">var</span> arr6 = [...]<span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">&#125;&#123;&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;, &#123;<span class="string">&quot;Jim&quot;</span>, <span class="number">20</span>&#125;&#125; <span class="comment">//数组的元素类型由匿名结构体给定</span></span><br></pre></td></tr></table></figure><p>二维数组初始化</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//5行3列，只给前2行赋值，且前2行的所有列还没有赋满</span></span><br><span class="line"><span class="keyword">var</span> arr1 = [<span class="number">5</span>][<span class="number">3</span>]<span class="type">int</span>&#123;&#123;<span class="number">1</span>&#125;, &#123;<span class="number">2</span>, <span class="number">3</span>&#125;&#125;</span><br><span class="line"><span class="comment">//第1维可以用...推测，第2维不能用...</span></span><br><span class="line"><span class="keyword">var</span> arr2 = [...][<span class="number">3</span>]<span class="type">int</span>&#123;&#123;<span class="number">1</span>&#125;, &#123;<span class="number">2</span>, <span class="number">3</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>访问数组里的元素</p><ul><li>通过index访问<ul><li>首元素 arr[0]</li><li>末元素 arr[len(arr)-1]</li></ul></li><li>访问二维数组里的元素<ul><li>位于第三行第四列的元素 arr[2][3]</li></ul></li></ul><p>遍历数组</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历数组里的元素</span></span><br><span class="line"><span class="keyword">for</span> i, ele := <span class="keyword">range</span> arr &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;index=%d, element=%d\n&quot;</span>, i, ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者这样遍历数组</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123; <span class="comment">//len(arr)获取数组的长度</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;index=%d, element=%d\n&quot;</span>, i, arr[i])</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//遍历二维数组</span></span><br><span class="line"><span class="keyword">for</span> row, array := <span class="keyword">range</span> arr &#123; <span class="comment">//先取出某一行</span></span><br><span class="line">    <span class="keyword">for</span> col, ele := <span class="keyword">range</span> array &#123; <span class="comment">//再遍历这一行</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;arr[%d][%d]=%d\n&quot;</span>, row, col, ele)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  通过for range遍历数组时取得的是数组里每一个元素的拷贝。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arr := [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, ele := <span class="keyword">range</span> arr &#123; <span class="comment">//ele是arr中元素的拷贝</span></span><br><span class="line">    arr[i] += <span class="number">8</span> <span class="comment">//修改arr里的元素，不影响ele</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%d %d %d\n&quot;</span>, i, arr[i], ele)</span><br><span class="line">    ele += <span class="number">1</span> <span class="comment">//修改ele不影响arr</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%d %d %d\n&quot;</span>, i, arr[i], ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%d %d\n&quot;</span>, i, arr[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在数组上调用cap()函数表示capacity容量，即给数组分配的内存空间可以容纳多少个元素；len()函数代表length长度，即目前数组里有几个元素。由于数组初始化之后长度不会改变，不需要给它预留内存空间，所以len(arr)==cap(arr)。对于多维数组，其cap和len指第一维的长度。<br>  数组的长度和类型都是数组类型的一部分，函数传递数组类型时这两部分都必须吻合。go语言没有按引用传参，全都是按值传参，即传递数组实际上传的是数组的拷贝，当数组的长度很大时，仅传参开销都很大。如果想修改函数外部的数组，就把它的指针（数组在内存里的地址）传进来。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数必须是长度为5的int型数组（注意长度必须是5）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_array1</span><span class="params">(arr [5]<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;array in function, address is %p\n&quot;</span>, &amp;arr[<span class="number">0</span>])</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">888</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_array2</span><span class="params">(arr *[5]<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;array in function, address is %p\n&quot;</span>, &amp;((*arr)[<span class="number">0</span>]))</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">888</span> <span class="comment">//因为传的是数组指针，所以直接在原来的内存空间上进行修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="切片">切片</h2><p>  切片是一个结构体，包含三个成员变量，array指向一块连续的内存空间，cap表示这块内存的大小，len表示目前该内存里存储了多少元素。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123; </span><br><span class="line">    array unsafe.Pointer </span><br><span class="line">    <span class="built_in">len</span> <span class="type">int</span> </span><br><span class="line">    <span class="built_in">cap</span> <span class="type">int</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./array.png" alt="avatar"></p><p>切片的初始化</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s []<span class="type">int</span> <span class="comment">//切片声明，len=cap=0</span></span><br><span class="line">s = []<span class="type">int</span>&#123;&#125; <span class="comment">//初始化，len=cap=0</span></span><br><span class="line">s = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>) <span class="comment">//初始化，len=cap=3</span></span><br><span class="line">s = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">5</span>) <span class="comment">//初始化，len=3，cap=5</span></span><br><span class="line">s = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125; <span class="comment">//初始化，len=cap=5</span></span><br><span class="line">s2d := [][]<span class="type">int</span>&#123;</span><br><span class="line">    &#123;<span class="number">1</span>&#125;,&#123;<span class="number">2</span>, <span class="number">3</span>&#125;, <span class="comment">//二维数组各行的列数相等，但二维切片各行的len可以不等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  切片相对于数组最大的特点就是可以追加元素，可以自动扩容。追加的元素放到预留的内存空间里，同时len加1。如果预留空间已用完，则会重新申请一块更大的内存空间，capacity大约变成之前的2倍(cap&lt;1024)或1.25倍(cap&gt;1024)。把原内存空间的数据拷贝过来，在新内存空间上执行append操作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">    s[i] = i + <span class="number">1</span></span><br><span class="line">&#125; <span class="comment">//s=[1,2,3]</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s[0] address %p, s=%v\n&quot;</span>, &amp;s[<span class="number">0</span>], s)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">capacity还够用，直接把追加的元素放到预留的内存空间上</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">4</span>, <span class="number">5</span>) <span class="comment">//可以一次append多个元素</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s[0] address %p, s=%v\n&quot;</span>, &amp;s[<span class="number">0</span>], s)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">capacity不够用了，得申请一片新的内存，把老数据先拷贝过来，在新内存上执行append操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">6</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s[0] address %p, s=%v\n&quot;</span>, &amp;s[<span class="number">0</span>], s)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//探究capacity扩容规律</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">expansion</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">prevCap := <span class="built_in">cap</span>(s)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">s = <span class="built_in">append</span>(s, i)</span><br><span class="line">currCap := <span class="built_in">cap</span>(s)</span><br><span class="line"><span class="keyword">if</span> currCap &gt; prevCap &#123;</span><br><span class="line"><span class="comment">//每次扩容都是扩到原先的2倍</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;capacity从%d变成%d\n&quot;</span>, prevCap, currCap)</span><br><span class="line">prevCap = currCap</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  通过指定起止下标，可以从大切片中截取一个子切片。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">5</span>)<span class="comment">//len=3, cap=5</span></span><br><span class="line">sub_slice = s[<span class="number">1</span>:<span class="number">3</span>]<span class="comment">//len=2, cap=4</span></span><br></pre></td></tr></table></figure><p>  刚开始，子切片和母切片共享底层的内存空间，修改子切片会反映到母切片上，在子切片上执行append会把新元素放到母切片预留的内存空间上。当子切片不断执行append，耗完了母切片预留的内存空间，子切片跟母切片就会发生内存分离，此后两个切片没有任何关系。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./sub_slice.png" alt="avatar"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub_slice</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">截取一部分，创造子切片，此时子切片与母切片(或母数组)共享底层内存空间，母切片的capacity子切片可能直接用</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">s[i] = i + <span class="number">1</span></span><br><span class="line">&#125; <span class="comment">//s=[1,2,3]</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s[1] address %p\n&quot;</span>, &amp;s[<span class="number">1</span>])</span><br><span class="line">sub_slice := s[<span class="number">1</span>:<span class="number">3</span>] <span class="comment">//从切片创造子切片，len=cap=2</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;len %d cap %d\n&quot;</span>, <span class="built_in">len</span>(sub_slice), <span class="built_in">cap</span>(sub_slice))</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">母切片的capacity还允许子切片执行append操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sub_slice = <span class="built_in">append</span>(sub_slice, <span class="number">6</span>, <span class="number">7</span>) <span class="comment">//可以一次append多个元素</span></span><br><span class="line">sub_slice[<span class="number">0</span>] = <span class="number">8</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s=%v, sub_slice=%v, s[1] address %p, sub_slice[0] address %p\n&quot;</span>, s, sub_slice, &amp;s[<span class="number">1</span>], &amp;sub_slice[<span class="number">0</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">母切片的capacity用完了，子切片再执行append就得申请一片新的内存，把老数据先拷贝过来，在新内存上执行append操作。此时的append操作跟母切片没有任何关系</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sub_slice = <span class="built_in">append</span>(sub_slice, <span class="number">8</span>)</span><br><span class="line">sub_slice[<span class="number">0</span>] = <span class="number">9</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s=%v, sub_slice=%v, s[1] address %p, sub_slice[0] address %p\n&quot;</span>, s, sub_slice, &amp;s[<span class="number">1</span>], &amp;sub_slice[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">arr := [<span class="number">5</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;arr[1] address %p\n&quot;</span>, &amp;arr[<span class="number">1</span>])</span><br><span class="line">sub_slice = arr[<span class="number">1</span>:<span class="number">3</span>] <span class="comment">//从数组创造子切片，len=cap=2</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;len %d cap %d\n&quot;</span>, <span class="built_in">len</span>(sub_slice), <span class="built_in">cap</span>(sub_slice))</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">母数组的capacity还允许子切片执行append操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sub_slice = <span class="built_in">append</span>(sub_slice, <span class="number">6</span>, <span class="number">7</span>) <span class="comment">//可以一次append多个元素</span></span><br><span class="line">sub_slice[<span class="number">0</span>] = <span class="number">8</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;arr=%v, sub_slice=%v, arr[1] address %p, sub_slice[0] address %p\n&quot;</span>, arr, sub_slice, &amp;arr[<span class="number">1</span>], &amp;sub_slice[<span class="number">0</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">母数组的capacity用完了，子切片再执行append就得申请一片新的内存，把老数据先拷贝过来，在新内存上执行append操作。此时的append操作跟母数组没有任何关系</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sub_slice = <span class="built_in">append</span>(sub_slice, <span class="number">8</span>)</span><br><span class="line">sub_slice[<span class="number">0</span>] = <span class="number">9</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;arr=%v, sub_slice=%v, arr[1] address %p, sub_slice[0] address %p\n&quot;</span>, arr, sub_slice, &amp;arr[<span class="number">1</span>], &amp;sub_slice[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  go语言函数传参，传的都是值，即传切片会把切片的{arrayPointer, len, cap}这3个字段拷贝一份传进来。由于传的是底层数组的指针，所以可以直接修改底层数组里的元素。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update_slice</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">s[<span class="number">0</span>] = <span class="number">888</span></span><br><span class="line">&#125;</span><br><span class="line">s := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">update_slice(s)</span><br><span class="line">fmt.Printf(<span class="string">&quot;s=%v\n&quot;</span>, s)</span><br></pre></td></tr></table></figure><h2 id="字符串">字符串</h2><p>  字符串里可以包含任意Unicode字符。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">&quot; My name is 张朝阳☻&quot;</span> </span><br></pre></td></tr></table></figure><p>  字符串里可以包含转义字符。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">&quot;He say:\&quot;I&#x27;m fine.\&quot; \n\\Thank\tyou.\\&quot;</span> </span><br></pre></td></tr></table></figure><p>  字符串也可以用反引号来定义，反引号里的转义字符无效。反引号里的内容原封不动地输出，包括空白符和换行符。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">`here is first line. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  there is third line.</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>字符串常用操作</p><table><thead><tr><th style="text-align:center">方法</th><th style="text-align:center">介绍</th></tr></thead><tbody><tr><td style="text-align:center">len(str)</td><td style="text-align:center">求长度</td></tr><tr><td style="text-align:center">strings.Split</td><td style="text-align:center">分割</td></tr><tr><td style="text-align:center">strings.Contains</td><td style="text-align:center">判断是否包含</td></tr><tr><td style="text-align:center">strings.HasPrefix,strings.HasSuffix</td><td style="text-align:center">前缀/后缀判断</td></tr><tr><td style="text-align:center">strings.Index(),strings.LastIndex()</td><td style="text-align:center">子串出现的位置</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">&quot;born to win, born to die.&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;sentence length %d\n&quot;</span>, <span class="built_in">len</span>(s))</span><br><span class="line">fmt.Printf(<span class="string">&quot;\&quot;s\&quot; length %d\n&quot;</span>, <span class="built_in">len</span>(<span class="string">&quot;s&quot;</span>))  <span class="comment">//英文字母的长度为1</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;\&quot;中\&quot;  length %d\n&quot;</span>, <span class="built_in">len</span>(<span class="string">&quot;中&quot;</span>)) <span class="comment">//一个汉字占3个长度</span></span><br><span class="line">arr := strings.Split(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;arr[3]=%s\n&quot;</span>, arr[<span class="number">3</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;contain die %t\n&quot;</span>, strings.Contains(s, <span class="string">&quot;die&quot;</span>))          <span class="comment">//包含子串</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;contain wine %t\n&quot;</span>, strings.Contains(s, <span class="string">&quot;wine&quot;</span>))        <span class="comment">//包含子串</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;first index of born %d\n&quot;</span>, strings.Index(s, <span class="string">&quot;born&quot;</span>))    <span class="comment">//寻找子串第一次出现的位置</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;last index of born %d\n&quot;</span>, strings.LastIndex(s, <span class="string">&quot;born&quot;</span>)) <span class="comment">//寻找子串最后一次出现的位置</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;begin with born %t\n&quot;</span>, strings.HasPrefix(s, <span class="string">&quot;born&quot;</span>))    <span class="comment">//以xxx开头</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;end with die. %t\n&quot;</span>, strings.HasSuffix(s, <span class="string">&quot;die.&quot;</span>))      <span class="comment">//以xxx结尾</span></span><br></pre></td></tr></table></figure><p>  把多个字符串拼接成一个长的字符串有多种方式。</p><ol><li>加号连接。</li><li>func fmt.Sprintf(format string, a …interface{}) string</li><li>func strings.Join(elems []string, sep string) string</li><li>当有大量的string需要拼接时，用strings.Builder效率最高</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">s1 := <span class="string">&quot;Hello&quot;</span></span><br><span class="line">s2 := <span class="string">&quot;how&quot;</span></span><br><span class="line">s3 := <span class="string">&quot;are&quot;</span></span><br><span class="line">s4 := <span class="string">&quot;you&quot;</span></span><br><span class="line">merged := s1 + <span class="string">&quot; &quot;</span> + s2 + <span class="string">&quot; &quot;</span> + s3 + <span class="string">&quot; &quot;</span> + s4</span><br><span class="line">fmt.Println(merged)</span><br><span class="line">merged = fmt.Sprintf(<span class="string">&quot;%s %s %s %s&quot;</span>, s1, s2, s3, s4)</span><br><span class="line">fmt.Println(merged)</span><br><span class="line">merged = strings.Join([]<span class="type">string</span>&#123;s1, s2, s3, s4&#125;, <span class="string">&quot; &quot;</span>)</span><br><span class="line">fmt.Println(merged)</span><br><span class="line"><span class="comment">//当有大量的string需要拼接时，用strings.Builder效率最高</span></span><br><span class="line">sb := strings.Builder&#123;&#125;</span><br><span class="line">sb.WriteString(s1)</span><br><span class="line">sb.WriteString(<span class="string">&quot; &quot;</span>)</span><br><span class="line">sb.WriteString(s2)</span><br><span class="line">sb.WriteString(<span class="string">&quot; &quot;</span>)</span><br><span class="line">sb.WriteString(s3)</span><br><span class="line">sb.WriteString(<span class="string">&quot; &quot;</span>)</span><br><span class="line">sb.WriteString(s4)</span><br><span class="line">sb.WriteString(<span class="string">&quot; &quot;</span>)</span><br><span class="line">merged = sb.String()</span><br><span class="line">fmt.Println(merged)</span><br></pre></td></tr></table></figure><p>  string中每个元素叫“字符”，字符有两种：</p><ol><li>byte：1个字节， 代表ASCII码的一个字符。</li><li>rune：4个字节，代表一个UTF-8字符，一个汉字可用一个rune表示。</li></ol><p>  string是常量，不能修改其中的字符。<br>  string可以转换为[]byte或[]rune类型。<br>  string底层是byte数组，string的长度就是该byte数组的长度， UTF-8编码下一个汉字占3个byte，即一个汉字占3个长度。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">s1 := <span class="string">&quot;My name is 张朝阳&quot;</span></span><br><span class="line">arr := []<span class="type">byte</span>(s1)</span><br><span class="line">brr := []<span class="type">rune</span>(s1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;last byte %d\n&quot;</span>, arr[<span class="built_in">len</span>(arr)<span class="number">-1</span>]) <span class="comment">//string可以转换为[]byte或[]rune类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;last byte %c\n&quot;</span>, arr[<span class="built_in">len</span>(arr)<span class="number">-1</span>]) <span class="comment">//byte或rune可以转为string</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;last rune %d\n&quot;</span>, brr[<span class="built_in">len</span>(brr)<span class="number">-1</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;last rune %c\n&quot;</span>, brr[<span class="built_in">len</span>(brr)<span class="number">-1</span>])</span><br><span class="line">L := <span class="built_in">len</span>(s1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;string len %d byte array len %d rune array len %d\n&quot;</span>, L, <span class="built_in">len</span>(arr), <span class="built_in">len</span>(brr))</span><br><span class="line"><span class="keyword">for</span> _, ele := <span class="keyword">range</span> s1 &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%c &quot;</span>, ele) <span class="comment">//string中的每个元素是字符</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; L; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%c &quot;</span>, s1[i]) <span class="comment">//[i]前面应该出现数组或切片，这里自动把string转成了[]byte（而不是[]rune）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据类型转换">数据类型转换</h2><p>  强制类型转换的基本方法就是把目标类型放在变量前面，把变量括起来。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">9</span></span><br><span class="line"><span class="keyword">var</span> by <span class="type">byte</span> = <span class="type">byte</span>(i)<span class="comment">//int转为byte</span></span><br><span class="line">i = <span class="type">int</span>(by)<span class="comment">//byte转为int</span></span><br></pre></td></tr></table></figure><ul><li>低精度向高精度转换没问题，高精度向低精度转换会丢失位数。</li><li>无符号向有符号转换，最高位是符号位。</li><li>byte和int可以互相转换。</li><li>float和int可以互相转换，小数位会丢失。</li><li>bool和int不能相互转换。</li><li>不同长度的int或float之间可以相互转换。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//高精度向低精度转换，数字很小时这种转换没问题</span></span><br><span class="line"><span class="keyword">var</span> ua <span class="type">uint64</span> = <span class="number">1</span></span><br><span class="line">i8 := <span class="type">int8</span>(ua)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i8=%d\n&quot;</span>, i8)</span><br><span class="line"></span><br><span class="line"><span class="comment">//最高位的1变成了符号位</span></span><br><span class="line">ua = <span class="type">uint64</span>(math.MaxUint64)</span><br><span class="line">i64 := <span class="type">int64</span>(ua)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i64=%d\n&quot;</span>, i64)</span><br><span class="line"></span><br><span class="line"><span class="comment">//位数丢失</span></span><br><span class="line">ui32 := <span class="type">uint32</span>(ua)</span><br><span class="line">fmt.Printf(<span class="string">&quot;ui32=%d\n&quot;</span>, ui32)</span><br><span class="line"></span><br><span class="line"><span class="comment">//单个字符可以转为int</span></span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="type">int</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i=%d\n&quot;</span>, i)</span><br><span class="line"></span><br><span class="line"><span class="comment">//bool和int不能相互转换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//byte和int可以互相转换</span></span><br><span class="line"><span class="keyword">var</span> by <span class="type">byte</span> = <span class="type">byte</span>(i)</span><br><span class="line">i = <span class="type">int</span>(by)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i=%d\n&quot;</span>, i)</span><br><span class="line"></span><br><span class="line"><span class="comment">//float和int可以互相转换，小数位会丢失</span></span><br><span class="line"><span class="keyword">var</span> ft <span class="type">float32</span> = <span class="type">float32</span>(i)</span><br><span class="line">i = <span class="type">int</span>(ft)</span><br><span class="line">fmt.Printf(<span class="string">&quot;i=%d\n&quot;</span>, i)</span><br></pre></td></tr></table></figure><p>string和其他数据类型互转。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">8</span></span><br><span class="line"><span class="keyword">var</span> i64 <span class="type">int64</span> = <span class="type">int64</span>(i)</span><br><span class="line"><span class="comment">//int转string</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span> = strconv.Itoa(i) <span class="comment">//内部调用FormatInt</span></span><br><span class="line">s = strconv.FormatInt(i64, <span class="number">10</span>)</span><br><span class="line"><span class="comment">//string转int</span></span><br><span class="line">i, err = strconv.Atoi(s)</span><br><span class="line"><span class="comment">//string转int64</span></span><br><span class="line">i64, err = strconv.ParseInt(s, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//float转string</span></span><br><span class="line"><span class="keyword">var</span> f <span class="type">float64</span> = <span class="number">8.123456789</span></span><br><span class="line">s = strconv.FormatFloat(f, <span class="string">&#x27;f&#x27;</span>, <span class="number">2</span>, <span class="number">64</span>) <span class="comment">//保留2位小数</span></span><br><span class="line">fmt.Println(s)</span><br><span class="line"><span class="comment">//string转float</span></span><br><span class="line">f, err = strconv.ParseFloat(s, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//string&lt;--&gt;[]byte</span></span><br><span class="line"><span class="keyword">var</span> arr []<span class="type">byte</span> = []<span class="type">byte</span>(s)</span><br><span class="line">s = <span class="type">string</span>(arr)</span><br><span class="line"></span><br><span class="line"><span class="comment">//string&lt;--&gt;[]rune</span></span><br><span class="line"><span class="keyword">var</span> brr []<span class="type">rune</span> = []<span class="type">rune</span>(s)</span><br><span class="line">s = <span class="type">string</span>(brr)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;err %v\n&quot;</span>, err)</span><br></pre></td></tr></table></figure><h2 id="map">map</h2><p>  go map的底层实现是hash table，根据key查找value的时间复杂度是O(1)。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./map.png" alt="avatar"></p><p>map的初始化</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span> <span class="comment">//声明map，指定key和value的数据类型</span></span><br><span class="line">m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>) <span class="comment">//初始化，容量为0</span></span><br><span class="line">m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>, <span class="number">200</span>) <span class="comment">//初始化，容量为5。强烈建议初始化时给一个合适的容量，减少扩容的概率</span></span><br><span class="line">m = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;语文&quot;</span>: <span class="number">0</span>, <span class="string">&quot;数学&quot;</span>: <span class="number">39</span>&#125; <span class="comment">//初始化时直接赋值</span></span><br></pre></td></tr></table></figure><p>添加和删除key</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m[<span class="string">&quot;英语&quot;</span>] = <span class="number">59</span> <span class="comment">//往map里添加key-value对</span></span><br><span class="line">m [<span class="string">&quot;英语&quot;</span>] = <span class="number">70</span> <span class="comment">//会覆盖之前的值</span></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">&quot;数学&quot;</span>) <span class="comment">//从map里删除key-value对</span></span><br></pre></td></tr></table></figure><p>  len(m)获取map的长度，go不支持对map上执行cap函数。<br>  读取key对应的value时，如果key不存在，则返回value类型的默认值，所以强烈建议先判断key是否存在。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> value, exists := m[<span class="string">&quot;语文&quot;</span>]; exists &#123;</span><br><span class="line">    fmt.Println(value)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;map里不存在[语文]这个key&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>遍历map</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历map</span></span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s=%d\n&quot;</span>, key, value)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;-----------&quot;</span>)</span><br><span class="line"><span class="comment">//多次遍历map返回的顺序是不一样的，但相对顺序是一样的，因为每次随机选择一个开始位置，然后顺序遍历</span></span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s=%d\n&quot;</span>, key, value)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;-----------&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//一边遍历一边修改</span></span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    m[key] = value + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s=%d\n&quot;</span>, key, value)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;-----------&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//for range取得的是值拷贝</span></span><br><span class="line"><span class="keyword">for</span> _, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    value = value + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s=%d\n&quot;</span>, key, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  map中的key可以是任意能够用==操作符比较的类型，不能是函数、map、切片，以及包含上述3中类型成员变量的的struct。map的value可以是任意类型。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> f <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">int</span>)</span></span> <span class="type">bool</span></span><br><span class="line"><span class="keyword">type</span> m <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">byte</span></span><br><span class="line"><span class="keyword">type</span> s []<span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> i <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> m1 <span class="keyword">map</span>[i]f</span><br><span class="line">fmt.Println(m1)</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 函数、map、切片不能当key **/</span></span><br><span class="line"><span class="comment">// var m2 map[f]bool</span></span><br><span class="line"><span class="comment">// fmt.Println(m2)</span></span><br><span class="line"><span class="comment">// var m3 map[m]bool</span></span><br><span class="line"><span class="comment">// fmt.Println(m3)</span></span><br><span class="line"><span class="comment">// var m4 map[s]bool</span></span><br><span class="line"><span class="comment">// fmt.Println(m4)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">scores <span class="type">float32</span> <span class="comment">//如果scores是slice，则user不能作为map的key</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u := user&#123;&#125;</span><br><span class="line">m5 := <span class="built_in">make</span>(<span class="keyword">map</span>[user]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">m5[u] = <span class="number">5</span></span><br><span class="line">fmt.Println(m5)</span><br></pre></td></tr></table></figure><h2 id="channel">channel</h2><p>  channel(管道)底层是一个环形队列(先进先出)，send(插入)和recv(取走)从同一个位置沿同一个方向顺序执行。sendx表示最后一次插入元素的位置，recvx表示最后一次取走元素的位置。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./channel.png" alt="avatar"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="type">int</span> <span class="comment">//管道的声明</span></span><br><span class="line">ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">8</span>) <span class="comment">//管道的初始化，环形队列里可容纳8个int</span></span><br><span class="line">ch &lt;- <span class="number">1</span>                <span class="comment">//往管道里写入(send)数据</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line">ch &lt;- <span class="number">3</span></span><br><span class="line">ch &lt;- <span class="number">4</span></span><br><span class="line">ch &lt;- <span class="number">5</span></span><br><span class="line">v := &lt;-ch <span class="comment">//从管道里取走(recv)数据</span></span><br><span class="line">fmt.Println(v)</span><br><span class="line">v = &lt;-ch</span><br><span class="line">fmt.Println(v)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_only := <span class="built_in">make</span> (&lt;-<span class="keyword">chan</span> <span class="type">int</span>)   <span class="comment">//定义只读的channel</span></span><br><span class="line">write_only := <span class="built_in">make</span> (<span class="keyword">chan</span>&lt;- <span class="type">int</span>)   <span class="comment">//定义只写的channel</span></span><br></pre></td></tr></table></figure><p>  定义只读和只写的channel意义不大，一般用于在参数传递中。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只能向channel里写数据 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(c <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123; </span><br><span class="line">    c &lt;- <span class="number">1</span> </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//只能取channel中的数据 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(c &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">_ = &lt;-c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回一个只读channel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span></span> Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  可以通过for range的方式遍历管道，遍历前必须先关闭管道，禁止再写入元素。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">close</span>(ch) <span class="comment">//遍历前必须先关闭管道，禁止再写入元素</span></span><br><span class="line"><span class="comment">//遍历管道里剩下的元素</span></span><br><span class="line"><span class="keyword">for</span> ele := <span class="keyword">range</span> ch &#123;</span><br><span class="line">    fmt.Println(ele)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  slice、map和channel是go语言里的3种引用类型，都可以通过make函数来进行初始化（申请内存分配）。因为它们都包含一个指向底层数据结构的指针，所以称之为“引用”类型。引用类型未初始化时都是nil，可以对它们执行len()函数，返回0。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang基础语法</title>
      <link href="/20221125/golang-20221125-golang%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"/>
      <url>/20221125/golang-20221125-golang%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="标识符与关键字">标识符与关键字</h2><p>  go变量、常量、自定义类型、包、函数的命名方式必须遵循以下规则：</p><ol><li>首字符可以是任意Unicode字符或下划线。</li><li>首字符之外的部分可以是Unicode字符、下划线或数字。</li><li>名字的长度无限制。</li></ol><blockquote><p>理论上名字里可以有汉字，甚至可以全是汉字，但实际中不要这么做。</p></blockquote><p>Go语言关键字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">break  default  func  interface  select  case  defer  go  map  struct  chan  else  goto  package  switch  const  if  range  type  continue  for  import  return  fallthrough  var</span><br></pre></td></tr></table></figure><p>常量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true  false  iota  nil   </span><br></pre></td></tr></table></figure><p>数据类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int  int8  int16  int32  int64  uint  uint8  uint16  uint32  uint64  uintptr  float32  float64  complex128  complex64  bool  byte  rune  string  error</span><br></pre></td></tr></table></figure><p>函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make  len  cap  new  append  copy  close  delete  complex  real  imag  panic  recover</span><br></pre></td></tr></table></figure><h2 id="操作符与表达式">操作符与表达式</h2><p>算法术运算符</p><table><thead><tr><th style="text-align:center">运算符</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">+</td><td style="text-align:center">相加</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">相减</td></tr><tr><td style="text-align:center">*</td><td style="text-align:center">相乘</td></tr><tr><td style="text-align:center">/</td><td style="text-align:center">相除</td></tr><tr><td style="text-align:center">%</td><td style="text-align:center">求余</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arithmetic 算术运算</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">arithmetic</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">float32</span> = <span class="number">8</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">float32</span> = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> c <span class="type">float32</span> = a + b</span><br><span class="line"><span class="keyword">var</span> d <span class="type">float32</span> = a - b</span><br><span class="line"><span class="keyword">var</span> e <span class="type">float32</span> = a * b</span><br><span class="line"><span class="keyword">var</span> f <span class="type">float32</span> = a / b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a=%.3f, b=%.3f, c=%.3f, d=%.3f, e=%.3f, f=%.3f\n&quot;</span>, a, b, c, d, e, f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关系运算符</p><table><thead><tr><th style="text-align:center">运算符</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">==</td><td style="text-align:left">检查两个值是否相等，如果相等返回 True 否则返回 False</td></tr><tr><td style="text-align:center">!=</td><td style="text-align:left">检查两个值是否不相等，如果不相等返回 True 否则返回 False</td></tr><tr><td style="text-align:center">&gt;</td><td style="text-align:left">检查左边值是否大于右边值，如果是返回 True 否则返回 False</td></tr><tr><td style="text-align:center">&gt;=</td><td style="text-align:left">检查左边值是否大于等于右边值，如果是返回 True 否则返回 False</td></tr><tr><td style="text-align:center">&lt;</td><td style="text-align:left">检查左边值是否小于右边值，如果是返回 True 否则返回 False</td></tr><tr><td style="text-align:center">&lt;=</td><td style="text-align:left">检查左边值是否小于等于右边值，如果是返回 True 否则返回 False</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//relational 关系运算符</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">relational</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">float32</span> = <span class="number">8</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">float32</span> = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> c <span class="type">float32</span> = <span class="number">8</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;a==b吗 %t\n&quot;</span>, a == b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a!=b吗 %t\n&quot;</span>, a != b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;b吗 %t\n&quot;</span>, a &gt; b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;=b吗 %t\n&quot;</span>, a &gt;= b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&lt;c吗 %t\n&quot;</span>, a &lt; b)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&lt;=c吗 %t\n&quot;</span>, a &lt;= c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逻辑运算符</p><table><thead><tr><th style="text-align:center">运算符</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">&amp;</td><td style="text-align:left">逻辑 AND 运算符。 如果两边的操作数都是 True，则为 True，否则为 False</td></tr><tr><td style="text-align:center">||</td><td style="text-align:left">逻辑 OR 运算符。 如果两边的操作数有一个 True，则为 True，否则为 False</td></tr><tr><td style="text-align:center">!</td><td style="text-align:left">逻辑 NOT 运算符。 如果条件为 True，则为 False，否则为 True</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//logistic 逻辑运算符</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logistic</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">float32</span> = <span class="number">8</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">float32</span> = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> c <span class="type">float32</span> = <span class="number">8</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;b &amp;&amp; b&gt;c吗 %t\n&quot;</span>, a &gt; b &amp;&amp; b &gt; c)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;b || b&gt;c吗 %t\n&quot;</span>, a &gt; b || b &gt; c)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;b不成立，对吗 %t\n&quot;</span>, !(a &gt; b))</span><br><span class="line">fmt.Printf(<span class="string">&quot;b&gt;c不成立，对吗 %t\n&quot;</span>, !(b &gt; c))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>位运算符</p><table><thead><tr><th style="text-align:center">运算符</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">&amp;</td><td style="text-align:left">参与运算的两数各对应的二进位相与（两位均为1才为1）</td></tr><tr><td style="text-align:center">|</td><td style="text-align:left">参与运算的两数各对应的二进位相或（两位有一个为1就为1）</td></tr><tr><td style="text-align:center">^</td><td style="text-align:left">参与运算的两数各对应的二进位相异或，当两对应的二进位相同时为0，不同时为1。作为一元运算符时表示按位取反，，符号位也跟着变</td></tr><tr><td style="text-align:center">&lt;&lt;</td><td style="text-align:left">左移n位就是乘以2的n次方。a&lt;&lt;b是把a的各二进位全部左移b位，高位丢弃，低位补0。通过左移，符号位可能会变</td></tr><tr><td style="text-align:center">&gt;&gt;</td><td style="text-align:left">右移n位就是除以2的n次方。a&gt;&gt;b是把a的各二进位全部右移b位，正数高位补0，负数高位补1</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bit_op 位运算</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bit_op</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;os arch %s, int size %d\n&quot;</span>, runtime.GOARCH, strconv.IntSize) <span class="comment">//int是4字节还是8字节，取决于操作系统是32位还是64位</span></span><br><span class="line"><span class="keyword">var</span> a <span class="type">int32</span> = <span class="number">260</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;260     %s\n&quot;</span>, util.BinaryFormat(a))</span><br><span class="line">fmt.Printf(<span class="string">&quot;-260    %s\n&quot;</span>, util.BinaryFormat(-a)) <span class="comment">//负数用补码表示。在对应正数二进制表示的基础上，按拉取反，再末位加1</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;260&amp;4   %s\n&quot;</span>, util.BinaryFormat(a&amp;<span class="number">4</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;260|3   %s\n&quot;</span>, util.BinaryFormat(a|<span class="number">3</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;260^7   %s\n&quot;</span>, util.BinaryFormat(a^<span class="number">7</span>))     <span class="comment">//^作为二元运算符时表示异或</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;^-260   %s\n&quot;</span>, util.BinaryFormat(^-a))     <span class="comment">//^作为一元运算符时表示按位取反，符号位也跟着变</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;-260&gt;&gt;10 %s\n&quot;</span>, util.BinaryFormat(-a&gt;&gt;<span class="number">10</span>)) <span class="comment">//正数高位补0，负数高位补1</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;-260&lt;&lt;3 %s\n&quot;</span>, util.BinaryFormat(-a&lt;&lt;<span class="number">3</span>))   <span class="comment">//负数左移，可能变成正数</span></span><br><span class="line"><span class="comment">//go语言没有循环（无符号）左/右移符号   &gt;&gt;&gt;  &lt;&lt;&lt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>赋值运算符</p><table><thead><tr><th style="text-align:center">运算符</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">=</td><td style="text-align:left">简单的赋值运算符，将一个表达式的值赋给一个左值</td></tr><tr><td style="text-align:center">+=</td><td style="text-align:left">相加后再赋值</td></tr><tr><td style="text-align:center">-=</td><td style="text-align:left">相减后再赋值</td></tr><tr><td style="text-align:center">*=</td><td style="text-align:left">相乘后再赋值</td></tr><tr><td style="text-align:center">/=</td><td style="text-align:left">相除后再赋值</td></tr><tr><td style="text-align:center">%=</td><td style="text-align:left">求余后再赋值</td></tr><tr><td style="text-align:center">&lt;&lt;=</td><td style="text-align:left">左移后赋值</td></tr><tr><td style="text-align:center">&gt;&gt;=</td><td style="text-align:left">右移后赋值</td></tr><tr><td style="text-align:center">&amp;=</td><td style="text-align:left">按位与后赋值</td></tr><tr><td style="text-align:center">|=</td><td style="text-align:left">按位或后赋值</td></tr><tr><td style="text-align:center">^=</td><td style="text-align:left">按位异或后赋值</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//assignment 赋值运算</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">assignment</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a, b <span class="type">int</span> = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a += b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a+=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a -= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a-=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a *= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a*=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a /= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a/=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a %= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a%%=b %d\n&quot;</span>, a) <span class="comment">//%在fmt里有特殊含意，所以需要前面再加个%转义一下</span></span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a &lt;&lt;= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&lt;&lt;=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a &gt;&gt;= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&gt;&gt;=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a &amp;= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a&amp;=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a |= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a|=b %d\n&quot;</span>, a)</span><br><span class="line">a, b = <span class="number">8</span>, <span class="number">3</span></span><br><span class="line">a ^= b</span><br><span class="line">fmt.Printf(<span class="string">&quot;a^=b %d\n&quot;</span>, a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="变量、常量、字面量">变量、常量、字面量</h2><h3 id="变量类型">变量类型</h3><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">go变量类型</th><th style="text-align:center">fmt输出</th></tr></thead><tbody><tr><td style="text-align:center">整型</td><td style="text-align:center">int int8 int16 int32 int64 uint uint8 uint16 uint32 uint64</td><td style="text-align:center">%d</td></tr><tr><td style="text-align:center">浮点型</td><td style="text-align:center">float32 float64</td><td style="text-align:center">%f %e %g</td></tr><tr><td style="text-align:center">布尔型</td><td style="text-align:center">bool</td><td style="text-align:center">%t</td></tr><tr><td style="text-align:center">指针</td><td style="text-align:center">uintptr</td><td style="text-align:center">%p</td></tr><tr><td style="text-align:center">引用</td><td style="text-align:center">map slice channel</td><td style="text-align:center">%v</td></tr><tr><td style="text-align:center">字节</td><td style="text-align:center">byte</td><td style="text-align:center">%c</td></tr><tr><td style="text-align:center">任意字符</td><td style="text-align:center">rune</td><td style="text-align:center">%c</td></tr><tr><td style="text-align:center">字符串</td><td style="text-align:center">string</td><td style="text-align:center">%s</td></tr><tr><td style="text-align:center">错误</td><td style="text-align:center">error</td><td style="text-align:center">%v</td></tr></tbody></table><h3 id="变量声明">变量声明</h3><p>  Go语言变量必须先声明再使用，所谓使用指读取或修改。<br>标题声明</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span> </span><br><span class="line"><span class="keyword">var</span> age <span class="type">int</span> </span><br><span class="line"><span class="keyword">var</span> isOk <span class="type">bool</span></span><br></pre></td></tr></table></figure><p>批量声明</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ( </span><br><span class="line">name <span class="type">string</span> </span><br><span class="line">age <span class="type">int</span> </span><br><span class="line">isOk <span class="type">bool</span> </span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="变量初始化">变量初始化</h3><p>  如果声明后未显式初始化，数值型初始化0，字符串初始化为空字符串，布尔型初始化为false，引用类型、函数、指针、接口初始化为nil。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">string</span>=<span class="string">&quot;china&quot;</span>  <span class="comment">//初始化一个变量</span></span><br><span class="line"><span class="keyword">var</span> a=<span class="string">&quot;china&quot;</span>  <span class="comment">//类型推断为string</span></span><br><span class="line"><span class="keyword">var</span> a,b <span class="type">int</span>=<span class="number">3</span>,<span class="number">7</span>  <span class="comment">//初始化多个变量</span></span><br><span class="line"><span class="keyword">var</span> a,b=<span class="string">&quot;china&quot;</span>,<span class="number">7</span>  <span class="comment">//初始化多个变量，每个变量都单独地执行类型推断     </span></span><br></pre></td></tr></table></figure><p>  函数内部的变量(非全局变量)可以通过:=声明并初始化。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:=<span class="number">3</span></span><br></pre></td></tr></table></figure><p>  下划线表示匿名变量。匿名变量不占命名空间，不会分配内存，因此可以重复使用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_=<span class="number">2</span>+<span class="number">4</span></span><br></pre></td></tr></table></figure><h3 id="常量">常量</h3><p>  常量在定义时必须赋值，且程序运行期间其值不能改变。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PI <span class="type">float32</span>=<span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    PI=<span class="number">3.14</span></span><br><span class="line">    E=<span class="number">2.71</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    a=<span class="number">100</span></span><br><span class="line">    b<span class="comment">//100，跟上一行的值相同</span></span><br><span class="line">    c<span class="comment">//100，跟上一行的值相同</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>iota</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    a=<span class="literal">iota</span><span class="comment">//0</span></span><br><span class="line">    b<span class="comment">//1</span></span><br><span class="line">    c<span class="comment">//2</span></span><br><span class="line">    d<span class="comment">//3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    a=<span class="literal">iota</span> <span class="comment">//0</span></span><br><span class="line">    b<span class="comment">//1</span></span><br><span class="line">    _<span class="comment">//2</span></span><br><span class="line">    d<span class="comment">//3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    a=<span class="literal">iota</span> <span class="comment">//0</span></span><br><span class="line">    b=<span class="number">30</span>    </span><br><span class="line">    c=<span class="literal">iota</span> <span class="comment">//2</span></span><br><span class="line">    d<span class="comment">//3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    _=<span class="literal">iota</span><span class="comment">// iota =0</span></span><br><span class="line">    KB=<span class="number">1</span>&lt;&lt;(<span class="number">10</span>* <span class="literal">iota</span>) <span class="comment">// iota =1</span></span><br><span class="line">    MB=<span class="number">1</span>&lt;&lt;(<span class="number">10</span>* <span class="literal">iota</span>) <span class="comment">// iota =2</span></span><br><span class="line">    GB=<span class="number">1</span>&lt;&lt;(<span class="number">10</span>* <span class="literal">iota</span>) <span class="comment">// iota =3</span></span><br><span class="line">    TB=<span class="number">1</span>&lt;&lt;(<span class="number">10</span>* <span class="literal">iota</span>) <span class="comment">// iota =4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>(</span><br><span class="line">    a,b=<span class="literal">iota</span>+<span class="number">1</span>, <span class="literal">iota</span>+<span class="number">2</span><span class="comment">//1,2  iota =0</span></span><br><span class="line">     c,d<span class="comment">//2,3  iota =1</span></span><br><span class="line">     e,f<span class="comment">//3,4  iota =2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="字面量">字面量</h3><p>  字面量–没有出现变量名，直接出现了值。基础类型的字面量相当于是常量。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%t\n&quot;</span>, <span class="number">04</span> == <span class="number">4.00</span>) <span class="comment">//用到了整型字面量和浮点型字面量</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, <span class="number">.4i</span>) <span class="comment">//虚数字面量 0.4i</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%t\n&quot;</span>, <span class="string">&#x27;\u4f17&#x27;</span> == <span class="string">&#x27;众&#x27;</span>) <span class="comment">//Unicode和rune字面量</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;Hello\nWorld\n!\n&quot;</span>) <span class="comment">//字符串字面量</span></span><br></pre></td></tr></table></figure><h2 id="变量作用域">变量作用域</h2><p>  对于全局变量，如果以大写字母开头，所有地方都可以访问，跨package访问时需要带上package名称；如果以小写字母开头，则本package内都可以访问。<br>  函数内部的局部变量，仅本函数内可以访问。{}可以固定一个作用域。内部声明的变量可以跟外部声明的变量有冲突，以内部的为准–就近原则。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    A=<span class="number">3</span><span class="comment">//所有地方都可以访问</span></span><br><span class="line">    b=<span class="number">4</span><span class="comment">//本package内可以访问</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    b:=<span class="number">5</span>  <span class="comment">//本函数内可以访问</span></span><br><span class="line">    &#123;</span><br><span class="line">        b:=<span class="number">6</span>  <span class="comment">//本作用域内可以访问</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注释与godoc">注释与godoc</h2><h3 id="注释的形式">注释的形式</h3><ul><li>单行注释，以//打头。</li><li>多行注释有2种形式：<ol><li>连续多行以//打头，注意多行注释之间不能出现空行。</li><li>在段前使用/*，段尾使用*/。</li></ol></li><li>注释行前加缩进即可写go代码。</li><li>注释中给定的关键词。NOTE: 引人注意，TODO: 将来需要优化，Deprecated: 变量或函数强烈建议不要再使用。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Add 2个整数相加</span></span><br><span class="line"><span class="comment">//返回和。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//<span class="doctag">NOTE:</span> 注释可以有多行，但中间不能出现空行（仅有//不算空行）。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Sub 函数使用示例：</span></span><br><span class="line"><span class="comment">  for i:=0;i&lt;3;i++&#123;</span></span><br><span class="line"><span class="comment">  Sub(i+1, i)</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">看到了吗？只需要行前缩进，注释里就可以写go代码，是不是很简单。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sub</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> Prod 该函数不能并发调用，需要优化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Prod</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a * b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deprecated: Div 不要再调用了</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Div</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a / b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="注释的位置">注释的位置</h3><p>  针对行的注释在行上方或右侧。函数的上方在func xxx()上方。结构体的注释在type xxx struct上方。包注释在package xxx的上方。一个包只需要在一个地方写包注释，通常会专门写一个doc.go，里面只有一行package xxx和关于包的注释。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FormatBool, FormatFloat, FormatInt, and FormatUint convert values to strings:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//s := strconv.FormatBool(true)</span></span><br><span class="line"><span class="comment">//s := strconv.FormatFloat(3.1415, &#x27;E&#x27;, -1, 64)</span></span><br><span class="line"><span class="comment">//s := strconv.FormatInt(-42, 16)</span></span><br><span class="line"><span class="comment">//s := strconv.FormatUint(42, 16)</span></span><br><span class="line"><span class="keyword">package</span> fmt</span><br></pre></td></tr></table></figure><h3 id="go-doc">go doc</h3><p>  go doc是go自带的命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go doc entrance_class/util</span><br></pre></td></tr></table></figure><p>上述命令查看entrance_class/util包的注释。</p><h3 id="godoc">godoc</h3><p>  godoc是第三方工具，可以为项目代码导出网页版的注释文档。安装godoc命令如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get -u golang.org/x/tools/cmd/godoc</span><br><span class="line">go install golang.org/x/tools/cmd/godoc@latest</span><br></pre></td></tr></table></figure><p>启动http服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">godoc -http=:6060</span><br></pre></td></tr></table></figure><p>用浏览器访问http://127.0.0.1:6060 ，可以查看go标准库的文档。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang简介</title>
      <link href="/20221125/golang-20221125-golang%E7%AE%80%E4%BB%8B/"/>
      <url>/20221125/golang-20221125-golang%E7%AE%80%E4%BB%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Go语言发展历史">Go语言发展历史</h2><h3 id="阵容豪华的创使人团队">阵容豪华的创使人团队</h3><p><strong>Ken Thompson</strong></p><ul><li>1966年：加入了贝尔实验室，在参与 Multics （多路信息计算）开发期间，创造出了B语言，并用一个月的时间用B语言开发了全新的操作系统UNICS，后来改名为我们所熟悉的UNIX 操作系统。</li><li>1971年：和丹尼斯·利奇（Dennis Ritchie）一起共同发明了C语言。</li><li>1973年：和丹尼斯·利奇（Dennis Ritchie）使用C语言重写了UNIX，并安装于PDP-11的机器之上。</li><li>1983年：美国计算机协会将图灵奖授予汤普森。</li><li>2000年：离开贝尔实验室，已退休的汤普森成为了一名飞行员。</li><li>2006年：加入Google工作。</li><li>2007年：64岁的高龄，与Rob Pike和Robert Griesemer主导了Go语言的开发。</li></ul><p><strong>Rob Pike</strong></p><ul><li>Go语言项目总负责人。</li><li>贝尔实验室Unix团队成员，参与的项目包括Plan 9，Inferno操作系统和Limbo编程语言。</li><li>UTF-8字符集规范唯二的发明人之一（另一位是Ken Thompson）。</li><li>《UNIX环境编程》和《程序设计实践》这两本书的作者之一。</li><li>第22届莫斯科夏季奥运会射箭项目的银牌得主。</li><li>业余天文学家，设计的珈玛射线望远镜差点被 NASA 用在航天飞机上。</li><li>他的媳妇Renee French 就是 Go 语言吉祥物的设计人。</li></ul><p><strong>Robert Griesemer</strong></p><ul><li>参与V8 JavaScript引擎的开发。</li><li>参与Java HotSpot虚拟机的研发。</li></ul><h3 id="起源">起源</h3><p>  2007年，Google的几位大牛正在用C++开发一些比较繁琐但是核心的工作，主要是分布式集群，大牛觉得很闹心。此时C++委员会来他们公司做技术演讲，说C++将要添加35个新特性，大牛心里飘过一万个CNM，“C++特性还不够多吗”。于是Rob Pike说要不自己搞个简单一点的语言吧，首先名字得简单好记，大腿一拍就叫“go”。<br>  把事情搞复杂很容易，把事情搞简单才更深刻。</p><h3 id="发展">发展</h3><ul><li>2007年9月21日，开始雏形设计。</li><li>2009年10月30日，Rob Pike宣布了Go语言的存在。</li><li>2009年11月10日，以完全开源的方式公布了Linux和Mac OSX上的版本，11月22日公布了Windows版本。</li><li>2010年1月8日，当选2009年年度语言。</li><li>2010年5月，谷歌投入使用。</li><li>2011年4月，谷歌开始抽调员工全职开发Go语言，并于5月宣布Google APP Engine支持Go语言。</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./tiobe_index_for_go.png" alt="avatar"></p><p>参考网站https://www.test.tiobe.com/tiobe-index/go。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./git_hut_pull_request_for_go1.png" alt="avatar"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./git_hut_pull_request_for_go2.png" alt="avatar"></p><p>参考网站https://madnight.github.io/githut/#/pull_requests。</p><h3 id="现状">现状</h3><p>  从世界范围看，Go语言在中国的发展势头最猛，且远超第二名。在很多互联网大厂Go已成为主要开发语言。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./chinese_company_use_go.png" alt="avatar"></p><p>  不论大小公司，对Go人才需求紧迫，薪酬很高。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./go_position.png" alt="avatar"></p><h2 id="Go语言的优劣">Go语言的优劣</h2><p><strong>优势</strong></p><ul><li>语法简单，易于学习。类C的语法，同时比C/C++简洁和干净。</li><li>自带GC，方便使用。</li><li>快速编译，高效执行。</li><li>简单的依赖管理。</li><li>并发编程，轻松驾驭。</li><li>静态类型，同时有一些动态语言的特征(var声明)。</li><li>标准类库，规范统一。<br><strong>劣势</strong></li><li>不支持动态加载代码。</li><li>发展时间短，生态不及Java、C++庞大，但是够用。</li></ul><h2 id="Go语言的应用场景">Go语言的应用场景</h2><h3 id="应用场景总览">应用场景总览</h3><ul><li>巨型中央服务器领域。</li><li>高性能分布式领域。</li><li>游戏服务端开发。</li><li>复杂事件处理。</li><li>对实时性要求很高的软件开发。</li><li>可以在Intel和ARM处理器上运行，因此也可以在安卓上运行。</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./application_of_go.png" alt="avatar"></p><h3 id="go微服务开发">go微服务开发</h3><ul><li>零依赖，让我们可以最小化我们的镜像,节省存储与拉取镜像带宽。</li><li>Runtime使用更小的内存，对比Java的JVM。</li><li>更好的并行能力，当你真的需求更多CPU的时候。</li><li>更高的性能，对比解释性语言，在处理数据已经并发方面优势明显。</li><li>简单，学习成本低，内部人员可以转入Go阵营。</li><li>使用Go能更接近云原生生态，比如docker，k8s, habor都是用Go开发的。</li></ul><h2 id="开发环境搭建">开发环境搭建</h2><ol><li>下载。到 <a href="https://studygolang.com/dl">https://studygolang.com/dl</a> 上下载最新的Go稳定版本。</li><li>安装。对于Windows和macOS用户，直接双击即可安装，留意一下安装路径。对于Linux用户，直接解压安装包即可，比如你打算把go安装到/usr/local目录下，则使用命令<br>tar zxvf goxxx.tar.gz –C /usr/local。这样go标准库及相关的可执行文件就安装到了/usr/local/go目录下，在后续的步骤中会把/usr/local/go赋给GOROOT环境变量。</li><li>准确GOPATH。在任意目录下创建一个空目录，将来用于存放go语言第三方库文件。比如你打算使用/data/go_path这个目录，则在Linux下使用命令mkdir -p /data/go_path。在GOPATH目录建3个子目录：src、bin、pkg。</li><li>配置环境变量。把第2步和第3步生成的目录分别赋给GOROOT和GOPATH环境变量，对于Linux和Mac用户在~/.bashrc文件中追加以下几行</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=/usr/local/go</span><br><span class="line">export GOPATH=/data/go_path</span><br><span class="line">export PATH=$PATH:$GOROOT/bin: :$GOPATH/bin</span><br></pre></td></tr></table></figure><p>  PATH环境变量下的可执行文件在任意目录下都可以直接访问。<br>  对于Windows用户，编辑用户环境变量，新增GOROOT和GOPATH，把GOROOT/bin和GOPATH/bin添加到Path里。如下图<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E8%AE%BE%E7%BD%AEgo%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F1.png" alt="avatar"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E8%AE%BE%E7%BD%AEgo%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F2.png" alt="avatar"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E8%AE%BE%E7%BD%AEgo%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F3.png" alt="avatar"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./%E8%AE%BE%E7%BD%AEgo%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F4.png" alt="avatar"></p><p>  在Windows下还可以通过go env -w来设置环境变量，比如设置GOPROXY用以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go env -w GOPROXY=https://goproxy.cn,direct </span><br></pre></td></tr></table></figure><p>  有很多网站支持在线编辑Go代码并查看运行结果，这里列举一些<br><a href="https://play.golang.wiki">https://play.golang.wiki</a><br><a href="https://play.studygolang.com">https://play.studygolang.com</a><br><a href="https://goplay.space">https://goplay.space</a><br><a href="https://goplay.tools">https://goplay.tools</a><br>  集成开发环境推荐GoLand和VSCode，后者是免费的。VSCode需要额外安装支持Go语言的插件，如下图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="./go_plugin_for_vscode.png" alt="avatar"></p><h2 id="第一个Go程序">第一个Go程序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  main()函数是Go程序的唯一入口，且main()函数必须位于package main中。fmt是Go标准库中的一个package，该package下有一个Println()函数用于输出字符串。Go语言会依次从以下3个目录里查找依赖包：</p><ol><li>当前工作目录</li><li>$GOPATH/pkg/mod</li><li>$GOROOT/src</li></ol><h2 id="Go命令介绍">Go命令介绍</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">(base) zcymac:~ zcy$ go help</span><br><span class="line">Go is a tool for managing Go source code.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line"></span><br><span class="line">go &lt;command&gt; [arguments]</span><br><span class="line"></span><br><span class="line">The commands are:</span><br><span class="line"></span><br><span class="line">bug         start a bug report</span><br><span class="line">build       compile packages and dependencies</span><br><span class="line">clean       remove object files and cached files</span><br><span class="line">doc         show documentation for package or symbol</span><br><span class="line">env         print Go environment information</span><br><span class="line">fix         update packages to use new APIs</span><br><span class="line">fmt         gofmt (reformat) package sources</span><br><span class="line">generate    generate Go files by processing source</span><br><span class="line">get         add dependencies to current module and install them</span><br><span class="line">install     compile and install packages and dependencies</span><br><span class="line">list        list packages or modules</span><br><span class="line">mod         module maintenance</span><br><span class="line">run         compile and run Go program</span><br><span class="line">test        test packages</span><br><span class="line">tool        run specified go tool</span><br><span class="line">version     print Go version</span><br><span class="line">vet         report likely mistakes in packages</span><br><span class="line"></span><br><span class="line">Use &quot;go help &lt;command&gt;&quot; for more information about a command.</span><br><span class="line"></span><br><span class="line">Additional help topics:</span><br><span class="line"></span><br><span class="line">buildconstraint build constraints</span><br><span class="line">buildmode       build modes</span><br><span class="line">c               calling between Go and C</span><br><span class="line">cache           build and test caching</span><br><span class="line">environment     environment variables</span><br><span class="line">filetype        file types</span><br><span class="line">go.mod          the go.mod file</span><br><span class="line">gopath          GOPATH environment variable</span><br><span class="line">gopath-get      legacy GOPATH go get</span><br><span class="line">goproxy         module proxy protocol</span><br><span class="line">importpath      import path syntax</span><br><span class="line">modules         modules, module versions, and more</span><br><span class="line">module-get      module-aware go get</span><br><span class="line">module-auth     module authentication using go.sum</span><br><span class="line">packages        package lists and patterns</span><br><span class="line">private         configuration for downloading non-public code</span><br><span class="line">testflag        testing flags</span><br><span class="line">testfunc        testing functions</span><br><span class="line">vcs             controlling version control with GOVCS</span><br><span class="line"></span><br><span class="line">Use &quot;go help &lt;topic&gt;&quot; for more information about that topic.</span><br></pre></td></tr></table></figure><p>go help: 查看帮助文档。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go help build</span><br></pre></td></tr></table></figure><p>go build: 对源代码和依赖的文件进行打包，生成可执行文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -o my_first_go_exe entrance_class/demo.go</span><br></pre></td></tr></table></figure><p>go install: 编译并安装包或依赖，安装到$GOPATH/bin下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install entrance_class/demo.go</span><br></pre></td></tr></table></figure><p>go get: 把依赖库添加到当前module中，如果本机之前从未下载过则先下载。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/tinylib/msgp </span><br></pre></td></tr></table></figure><p>以上命令会在$GOPATH/pkg/mod目录下会生成github.com/tinylib/msgp目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/tinylib/msgp@latest </span><br></pre></td></tr></table></figure><p>以上命令会在$GOPATH/bin下生成msgp可执行文件。<br>go mod init module_name<br>初始化一个Go项目。<br>go mod tidy通过扫描当前项目中的所有代码来添加未被记录的依赖至go.mod文件或从go.mod文件中删除不再被使用的依赖。<br>go run: 编译并运行程序。<br>go test: 执行测试代码。<br>go tool: 执行go自带的工具。go tool pprof对cpu、内存和协程进行监控；go tool trace跟踪协程的执行过程。<br>go vet: 检查代码中的静态错误。<br>go fmt: 对代码文件进行格式化，如果用了IDE这个命令就不需要了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go fmt entrance_class/demo.go</span><br></pre></td></tr></table></figure><p>go doc: 查看go标准库或第三方库的帮助文档。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go doc fmt</span><br><span class="line">go doc gonum.org/v1/gonum/stat</span><br></pre></td></tr></table></figure><p>go version: 查看go版本号。<br>go env: 查看go环境信息。</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx</title>
      <link href="/20221031/nginx-20221031-nginx/"/>
      <url>/20221031/nginx-20221031-nginx/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Nginx-简介">一、Nginx 简介</h2><p><strong>什么是 Nginx?</strong></p><p><strong>Nginx (engine x)</strong> 是一款轻量级的 Web 服务器 、反向代理服务器及电子邮件（IMAP/POP3）代理服务器。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221031/nginx-20221031-nginx/nginx.jpg" class=""><p><strong>什么是反向代理？</strong></p><p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221031/nginx-20221031-nginx/reverse-proxy.png" class=""><h2 id="二、Nginx-入门">二、Nginx 入门</h2><blockquote><p>详细安装方法请参考：<a href="docs/nginx-ops.md">Nginx 运维</a><br>nginx 的使用比较简单，就是几条命令。</p></blockquote><p>常用到的命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop       快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。</span><br><span class="line">nginx -s quit       平稳关闭Nginx，保存相关信息，有安排的结束web服务。</span><br><span class="line">nginx -s reload     因改变了Nginx相关配置，需要重新加载配置而重载。</span><br><span class="line">nginx -s reopen     重新打开日志文件。</span><br><span class="line">nginx -c filename   为 Nginx 指定一个配置文件，来代替缺省的。</span><br><span class="line">nginx -t            不运行，仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。</span><br><span class="line">nginx -v            显示 nginx 的版本。</span><br><span class="line">nginx -V            显示 nginx 的版本，编译器版本和配置参数。</span><br></pre></td></tr></table></figure><p>如果不想每次都敲命令，可以在 nginx 安装目录下新添一个启动批处理文件<strong>startup.bat</strong>，双击即可运行。内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">rem 如果启动前已经启动nginx并记录下pid文件，会kill指定进程</span><br><span class="line">nginx.exe -s stop</span><br><span class="line">rem 测试配置文件语法正确性</span><br><span class="line">nginx.exe -t -c conf/nginx.conf</span><br><span class="line">rem 显示版本信息</span><br><span class="line">nginx.exe -v</span><br><span class="line">rem 按照指定配置去启动nginx</span><br><span class="line">nginx.exe -c conf/nginx.conf</span><br></pre></td></tr></table></figure><p>如果是运行在 Linux 下，写一个 shell 脚本，大同小异。</p><h2 id="三、Nginx-实战">三、Nginx 实战</h2><p>我始终认为，各种开发工具的配置还是结合实战来讲述，会让人更易理解。</p><h3 id="Http-反向代理">Http 反向代理</h3><p>我们先实现一个小目标：不考虑复杂的配置，仅仅是完成一个 http 反向代理。</p><p><code>nginx.conf</code> 配置文件如下：</p><blockquote><p><strong><em>注：<code>conf/nginx.conf</code> 是 nginx 的默认配置文件。你也可以使用 nginx -c 指定你的配置文件</em></strong></p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行用户</span></span><br><span class="line"><span class="comment">#user somebody;</span></span><br><span class="line"><span class="comment">#启动进程,通常设置成和cpu的数量相等</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">#全局错误日志</span></span><br><span class="line"><span class="attribute">error_log</span>  D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/logs/<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">error_log</span>  D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/logs/<span class="literal">notice</span>.log  <span class="literal">notice</span>;</span><br><span class="line"><span class="attribute">error_log</span>  D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/logs/<span class="literal">info</span>.log  <span class="literal">info</span>;</span><br><span class="line"><span class="comment">#PID文件，记录当前启动的nginx的进程ID</span></span><br><span class="line"><span class="attribute">pid</span>        D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/logs/nginx.pid;</span><br><span class="line"><span class="comment">#工作模式及连接数上限</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;    <span class="comment">#单个后台worker process进程的最大并发链接数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment">#设定mime类型(邮件支持类型),类型由mime.types文件定义</span></span><br><span class="line">    <span class="attribute">include</span>       D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/conf/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志</span></span><br><span class="line"><span class="attribute">log_format</span>  main  <span class="string">&#x27;[<span class="variable">$remote_addr</span>] - [<span class="variable">$remote_user</span>] [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line">    <span class="attribute">access_log</span>    D:/Tools/nginx-<span class="number">1</span>.<span class="number">10</span>.<span class="number">1</span>/logs/access.log main;</span><br><span class="line">    <span class="attribute">rewrite_log</span>     <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，</span></span><br><span class="line">    <span class="comment">#必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    <span class="comment">#连接超时时间</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">120</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>        <span class="literal">on</span>;</span><br><span class="line"><span class="comment">#gzip压缩开关</span></span><br><span class="line"><span class="comment">#gzip  on;</span></span><br><span class="line">    <span class="comment">#设定实际的服务器列表</span></span><br><span class="line">    <span class="section">upstream</span> zp_server1&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:8089</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#HTTP服务器</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment">#监听80端口，80端口是知名端口号，用于HTTP协议</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        <span class="attribute">server_name</span>  www.helloworld.com;</span><br><span class="line"><span class="comment">#首页</span></span><br><span class="line"><span class="attribute">index</span> index.html</span><br><span class="line"><span class="comment">#指向webapp的目录</span></span><br><span class="line">root D:\01_Workspace\Project\github\zp\SpringNotes\spring-security\spring-shiro\src\main\webapp;</span><br><span class="line"><span class="comment">#编码格式</span></span><br><span class="line"><span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"><span class="comment">#代理配置参数</span></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">180</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">180</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">180</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarder-For <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="comment">#反向代理的路径（和upstream绑定），location 后面设置映射的路径</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://zp_server1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#静态文件，nginx自己处理</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ ^/(images|javascript|js|css|flash|media|static)/</span> &#123;</span><br><span class="line">            <span class="attribute">root</span> D:\01_Workspace\Project\github\zp\SpringNotes\spring-security\spring-shiro\src\main\webapp\views;</span><br><span class="line">            <span class="comment">#过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span></span><br><span class="line">            <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#设定查看Nginx状态的地址</span></span><br><span class="line">        <span class="section">location</span> /NginxStatus &#123;</span><br><span class="line">            <span class="attribute">stub_status</span>           <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">access_log</span>            <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">auth_basic</span>            <span class="string">&quot;NginxStatus&quot;</span>;</span><br><span class="line">            <span class="attribute">auth_basic_user_file</span>  conf/htpasswd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#禁止访问 .htxxx 文件</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ /\.ht</span> &#123;</span><br><span class="line">            <span class="attribute">deny</span> all;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">#错误处理页面（可选择性配置）</span></span><br><span class="line"><span class="comment">#error_page   404              /404.html;</span></span><br><span class="line"><span class="comment">#error_page   500 502 503 504  /50x.html;</span></span><br><span class="line">        <span class="comment">#location = /50x.html &#123;</span></span><br><span class="line">        <span class="comment">#    root   html;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了，让我们来试试吧：</p><ol><li>启动 webapp，注意启动绑定的端口要和 nginx 中的 <code>upstream</code> 设置的端口保持一致。</li><li>更改 host：在 C:\Windows\System32\drivers\etc 目录下的 host 文件中添加一条 DNS 记录</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.helloworld.com</span><br></pre></td></tr></table></figure><ol start="3"><li>启动前文中 startup.bat 的命令</li><li>在浏览器中访问 <a href="http://www.helloworld.com">www.helloworld.com</a>，不出意外，已经可以访问了。</li></ol><h3 id="Https-反向代理">Https 反向代理</h3><p>一些对安全性要求比较高的站点，可能会使用 HTTPS（一种使用 ssl 通信标准的安全 HTTP 协议）。</p><p>这里不科普 HTTP 协议和 SSL 标准。但是，使用 nginx 配置 https 需要知道几点：</p><ul><li>HTTPS 的固定端口号是 443，不同于 HTTP 的 80 端口</li><li>SSL 标准需要引入安全证书，所以在 nginx.conf 中你需要指定证书和它对应的 key</li></ul><p>其他和 http 反向代理基本一样，只是在 <code>Server</code> 部分配置有些不同。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#HTTP服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#监听443端口。443为知名端口号，主要用于HTTPS协议</span></span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">    <span class="attribute">server_name</span>  www.helloworld.com;</span><br><span class="line">    <span class="comment">#ssl证书文件位置(常见证书文件格式为：crt/pem)</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>      cert.pem;</span><br><span class="line">    <span class="comment">#ssl证书key位置</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>  cert.key;</span><br><span class="line">    <span class="comment">#ssl配置参数（选择性配置）</span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span>    shared:SSL:<span class="number">1m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;</span><br><span class="line">    <span class="comment">#数字签名，此处使用MD5</span></span><br><span class="line">    <span class="attribute">ssl_ciphers</span>  HIGH:!aNULL:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>   /root;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="负载均衡">负载均衡</h3><p>前面的例子中，代理仅仅指向一个服务器。</p><p>但是，网站在实际运营过程中，大部分都是以集群的方式运行，这时需要使用负载均衡来分流。</p><p>nginx 也可以实现简单的负载均衡功能。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221031/nginx-20221031-nginx/nginx-load-balance.png" class=""><p>假设这样一个应用场景：将应用部署在 192.168.1.11:80、192.168.1.12:80、192.168.1.13:80 三台 linux 环境的服务器上。网站域名叫 <a href="http://www.helloworld.com">www.helloworld.com</a>，公网 IP 为 192.168.1.11。在公网 IP 所在的服务器上部署 nginx，对所有请求做负载均衡处理（下面例子中使用的是加权轮询策略）。</p><p>nginx.conf 配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">     <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    <span class="attribute">access_log</span>    /var/log/nginx/access.log;</span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">    <span class="section">upstream</span> load_balance_server &#123;</span><br><span class="line">        <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.1.11:80</span>   weight=<span class="number">5</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.1.12:80</span>   weight=<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.1.13:80</span>   weight=<span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">#HTTP服务器</span></span><br><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment">#侦听80端口</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        <span class="attribute">server_name</span>  www.helloworld.com;</span><br><span class="line">        <span class="comment">#对所有请求进行负载均衡请求</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>        /root;                 <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">            <span class="attribute">index</span>       index.html index.htm;  <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">            <span class="attribute">proxy_pass</span>  http://load_balance_server ;<span class="comment">#请求转向load_balance_server 定义的服务器列表</span></span><br><span class="line">            <span class="comment">#以下是一些反向代理的配置(可选择性配置)</span></span><br><span class="line">            <span class="comment">#proxy_redirect off;</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">90</span>;          <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">            <span class="attribute">proxy_send_timeout</span> <span class="number">90</span>;             <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">90</span>;             <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">            <span class="attribute">proxy_buffer_size</span> <span class="number">4k</span>;              <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">            <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;               <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span></span><br><span class="line">            <span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>;       <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">            <span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>;    <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line">            <span class="attribute">client_max_body_size</span> <span class="number">10m</span>;          <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">            <span class="attribute">client_body_buffer_size</span> <span class="number">128k</span>;      <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="负载均衡策略">负载均衡策略</h4><p>Nginx 提供了多种负载均衡策略，让我们来一一了解一下：</p><p>负载均衡策略在各种分布式系统中基本上原理一致，对于原理有兴趣，不妨参考 <a href="https://dunwu.github.io/blog/design/theory/load-balance-theory/">负载均衡</a></p><h5 id="轮询">轮询</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  <span class="comment"># 默认所有服务器权重为 1</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="加权轮询">加权轮询</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span>   weight=<span class="number">3</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span>              <span class="comment"># default weight=1</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span>              <span class="comment"># default weight=1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="最少连接">最少连接</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  least_conn;</span><br><span class="line">  <span class="comment"># with default weight for all (weight=1)</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="加权最少连接">加权最少连接</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  least_conn;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span>   weight=<span class="number">3</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span>              <span class="comment"># default weight=1</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span>              <span class="comment"># default weight=1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="IP-Hash">IP Hash</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  ip_hash;</span><br><span class="line">  <span class="comment"># with default weight for all (weight=1)</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="普通-Hash">普通 Hash</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> bck_testing_01 &#123;</span><br><span class="line">  <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">  <span class="comment"># with default weight for all (weight=1)</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.250.220:8080</span></span><br><span class="line">  server <span class="number">192.168.250.221:8080</span></span><br><span class="line">  server <span class="number">192.168.250.222:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="网站有多个-webapp-的配置">网站有多个 webapp 的配置</h3><p>当一个网站功能越来越丰富时，往往需要将一些功能相对独立的模块剥离出来，独立维护。这样的话，通常，会有多个 webapp。</p><p>举个例子：假如 <a href="http://www.helloworld.com">www.helloworld.com</a> 站点有好几个 webapp，finance（金融）、product（产品）、admin（用户中心）。访问这些应用的方式通过上下文(context)来进行区分:</p><p><a href="http://www.helloworld.com/finance/">www.helloworld.com/finance/</a></p><p><a href="http://www.helloworld.com/product/">www.helloworld.com/product/</a></p><p><a href="http://www.helloworld.com/admin/">www.helloworld.com/admin/</a></p><p>我们知道，http 的默认端口号是 80，如果在一台服务器上同时启动这 3 个 webapp 应用，都用 80 端口，肯定是不成的。所以，这三个应用需要分别绑定不同的端口号。</p><p>那么，问题来了，用户在实际访问 <a href="http://www.helloworld.com">www.helloworld.com</a> 站点时，访问不同 webapp，总不会还带着对应的端口号去访问吧。所以，你再次需要用到反向代理来做处理。</p><p>配置也不难，来看看怎么做吧：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"><span class="comment">#此处省略一些基本配置</span></span><br><span class="line"><span class="section">upstream</span> product_server&#123;</span><br><span class="line"><span class="attribute">server</span> www.helloworld.com:<span class="number">8081</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">upstream</span> admin_server&#123;</span><br><span class="line"><span class="attribute">server</span> www.helloworld.com:<span class="number">8082</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">upstream</span> finance_server&#123;</span><br><span class="line"><span class="attribute">server</span> www.helloworld.com:<span class="number">8083</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"><span class="comment">#此处省略一些基本配置</span></span><br><span class="line"><span class="comment">#默认指向product的server</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://product_server;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /product/&#123;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://product_server;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /admin/ &#123;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://admin_server;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /finance/ &#123;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://finance_server;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="静态站点">静态站点</h3><p>有时候，我们需要配置静态站点(即 html 文件和一堆静态资源)。</p><p>举例来说：如果所有的静态资源都放在了 <code>/app/dist</code> 目录下，我们只需要在 <code>nginx.conf</code> 中指定首页以及这个站点的 host 即可。</p><p>配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"><span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line"><span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line"><span class="attribute">server_name</span>  static.zp.cn;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"><span class="attribute">root</span> /app/dist;</span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line"><span class="comment">#转发任何请求到 index.html</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，添加 HOST：</p><p>127.0.0.1 <a href="http://static.zp.cn">static.zp.cn</a></p><p>此时，在本地浏览器访问 <a href="http://static.zp.cn">static.zp.cn</a> ，就可以访问静态站点了。</p><h3 id="搭建文件服务器">搭建文件服务器</h3><p>有时候，团队需要归档一些数据或资料，那么文件服务器必不可少。使用 Nginx 可以非常快速便捷的搭建一个简易的文件服务。</p><p>Nginx 中的配置要点：</p><ul><li>将 autoindex 开启可以显示目录，默认不开启。</li><li>将 autoindex_exact_size 开启可以显示文件的大小。</li><li>将 autoindex_localtime 开启可以显示文件的修改时间。</li><li>root 用来设置开放为文件服务的根路径。</li><li>charset 设置为 <code>charset utf-8,gbk;</code>，可以避免中文乱码问题（windows 服务器下设置后，依然乱码，本人暂时没有找到解决方法）。</li></ul><p>一个最简化的配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">autoindex</span> <span class="literal">on</span>;<span class="comment"># 显示目录</span></span><br><span class="line"><span class="attribute">autoindex_exact_size</span> <span class="literal">on</span>;<span class="comment"># 显示文件大小</span></span><br><span class="line"><span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;<span class="comment"># 显示文件时间</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">charset</span>      utf-<span class="number">8</span>,gbk; <span class="comment"># windows 服务器下设置后，依然乱码，暂时无解</span></span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">9050</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">9050</span> default_server;</span><br><span class="line">    <span class="attribute">server_name</span>  _;</span><br><span class="line">    <span class="attribute">root</span>         /share/fs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解决跨域">解决跨域</h3><p>web 领域开发中，经常采用前后端分离模式。这种模式下，前端和后端分别是独立的 web 应用程序，例如：后端是 Java 程序，前端是 React 或 Vue 应用。</p><p>各自独立的 web app 在互相访问时，势必存在跨域问题。解决跨域问题一般有两种思路：</p><ol><li><strong>CORS</strong></li></ol><p>在后端服务器设置 HTTP 响应头，把你需要允许访问的域名加入 <code>Access-Control-Allow-Origin</code> 中。</p><ol start="2"><li><strong>jsonp</strong></li></ol><p>把后端根据请求，构造 json 数据，并返回，前端用 jsonp 跨域。</p><p>这两种思路，本文不展开讨论。</p><p>需要说明的是，nginx 根据第一种思路，也提供了一种解决跨域的解决方案。</p><p>举例：<a href="http://www.helloworld.com">www.helloworld.com</a> 网站是由一个前端 app ，一个后端 app 组成的。前端端口号为 9000， 后端端口号为 8080。</p><p>前端和后端如果使用 http 进行交互时，请求会被拒绝，因为存在跨域问题。来看看，nginx 是怎么解决的吧：</p><p>首先，在 enable-cors.conf 文件中设置 cors ：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow origin list</span></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$ACAO</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"><span class="comment"># set single origin</span></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$http_origin</span> <span class="regexp">~* (www.helloworld.com)$)</span> &#123;</span><br><span class="line">  <span class="attribute">set</span> <span class="variable">$ACAO</span> <span class="variable">$http_origin</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$cors</span> = <span class="string">&quot;trueget&quot;</span>) &#123;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&quot;<span class="variable">$http_origin</span>&quot;</span>;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;GET, POST, OPTIONS&#x27;</span>;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">  <span class="attribute">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>options&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">  <span class="attribute">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>get&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">  <span class="attribute">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>post&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，在你的服务器中 <code>include enable-cors.conf</code> 来引入跨域配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="comment"># 此文件为项目 nginx 配置片段</span></span><br><span class="line"><span class="comment"># 可以直接在 nginx config 中 include（推荐）</span></span><br><span class="line"><span class="comment"># 或者 copy 到现有 nginx 中，自行配置</span></span><br><span class="line"><span class="comment"># www.helloworld.com 域名需配合 dns hosts 进行配置</span></span><br><span class="line"><span class="comment"># 其中，api 开启了 cors，需配合本目录下另一份配置文件</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="section">upstream</span> front_server&#123;</span><br><span class="line">  <span class="attribute">server</span> www.helloworld.com:<span class="number">9000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">upstream</span> api_server&#123;</span><br><span class="line">  <span class="attribute">server</span> www.helloworld.com:<span class="number">8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  www.helloworld.com;</span><br><span class="line">  <span class="section">location</span> <span class="regexp">~ ^/api/</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> enable-cors.conf;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://api_server;</span><br><span class="line">    <span class="attribute">rewrite</span> <span class="string">&quot;^/api/(.*)$&quot;</span> /<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> <span class="regexp">~ ^/</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://front_server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到此，就完成了。</p>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis概述安装</title>
      <link href="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/"/>
      <url>/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="1-概述-2">1. 概述</h2><p>Redis是一个<font color=red size=2>开源</font>的<font color=red size=2>key-value</font>存储系统<br>和Memcached类似，它支持存储的value类型相对更多，包括<font color=red size=2>string</font>（字符串）、<font color=red size=2>list</font>（链表）、<font color=red size=2>set</font>（集合）、<font color=red size=2>zset</font>（sorted set --有序集合）和<font color=red size=2>hash</font>（哈希类型）<br>这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是<font color=red size=2>原子性</font>的。<br>在此基础上，为了保证效率，数据都是<font color=red size=2>缓存在内存</font>中。<br>区别的时Redis会<font color=red size=2>周期性</font>的把更新的<font color=red size=2>数据写入磁盘</font>或者把修改操作写入追加的记录文件。<br>并且在此基础上实现了<font color=red size=2>master-slave(主从)</font>同步。</p><h2 id="2-应用场景">2. 应用场景</h2><h3 id="2-1-配合关系型数据库做高速缓存">2.1 配合关系型数据库做高速缓存</h3><ul><li>高频次，热门访问的数据，降低数据库IO</li><li>分布式架构，做session共享</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%879.png" class=""><h3 id="2-2-多样的数据结构存储持久化数据">2.2 多样的数据结构存储持久化数据</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8710.png" class=""><h2 id="3-Redis相关知识">3. Redis相关知识</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-29-234722.png" class=""><p>Redis是单线程+多路IO复用技术</p><p>多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8712.png" class=""><p>（与Memcache三点不同: 支持多数据类型，支持持久化，单线程+多路IO复用）</p><h2 id="4-常见五大数据类型">4. 常见五大数据类型</h2><h3 id="4-1-Redis键（key）">4.1 Redis键（key）</h3><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>keys *</td><td>查看当前库所有key</td></tr><tr><td>exists key</td><td>判断某个key是否存在</td></tr><tr><td>type key</td><td>查看你的key是什么类型</td></tr><tr><td>del key</td><td>删除指定的key数据</td></tr><tr><td><font color=red size=2>unlink key </font></td><td>根据value选择非阻塞删除，仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作</td></tr><tr><td>expire key 10</td><td>10秒钟：为给定的key设置过期时间</td></tr><tr><td>ttl key</td><td>查看还有多少秒过期，-1表示永不过期，-2表示已过期</td></tr><tr><td>select</td><td>切换数据库</td></tr><tr><td>dbsize</td><td>查看当前数据的key数量</td></tr><tr><td>flushdb</td><td>清空当前库</td></tr><tr><td>flushall</td><td>通杀全部库</td></tr></tbody></table><h3 id="4-2-Redis字符串（String）">4.2 Redis字符串（String）</h3><p>String是Redis最基本的类型，可以理解成与Memcached一模一样的类型，一个key对应一个value。<br>String类型<font color=red size=2>是二进制安全的</font>。意味着Redis的string可以包含任何数据，比如jpg图片或者序列化的对象。<br>String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M</p><h4 id="4-2-1-数据结构">4.2.1 数据结构</h4><p>String的数据结构为简单动态字符串(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8714.png" class=""><p>如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p><h4 id="4-2-2-常用命令">4.2.2 常用命令</h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>set &lt;key&gt; &lt;value&gt;</td><td>添加键值对</td></tr><tr><td>get &lt;key&gt;</td><td>查询对应键值</td></tr><tr><td>append &lt;key&gt; &lt;value&gt;</td><td>将给定的&lt;value&gt;追加到原值末尾</td></tr><tr><td>strlen &lt;key&gt;</td><td>获得值的长度</td></tr><tr><td>setnx &lt;key&gt; &lt;value&gt;</td><td>只有在key不存在时，设置key的值</td></tr><tr><td>incr &lt;key&gt;</td><td>将key中存储的数字值增1，只能对数字值操作，如果为空，新增值为1</td></tr><tr><td>decr &lt;key&gt;</td><td>将key中存储的数字值减1</td></tr><tr><td>incrby / decrby &lt;key&gt; &lt;步长&gt;</td><td>将key中存储的数字值增减，自定义步长</td></tr><tr><td>mset &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt;</td><td>同时设置一个或多个key-value</td></tr><tr><td>mget &lt;key1&gt; &lt;key2&gt;</td><td>同时获取一个或多个value</td></tr><tr><td>msetnx &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt;</td><td>同时设置一个或多个key-value对，当且仅key不存在时</td></tr><tr><td>getrange &lt;key&gt; &lt;起始位置&gt;&lt;结束位置&gt;</td><td>获取值的范围，类似java中substring</td></tr><tr><td>setrange &lt;key&gt; &lt;起始位置&gt;&lt;value&gt;</td><td>用value覆写key所存储的值，从&lt;起始位置&gt;开始（索引从0开始）</td></tr><tr><td><font color=red size=2>setex &lt;key&gt;&lt;过期时间&gt;&lt;value&gt;</font></td><td>设置键值的同时，设置过期时间，单位秒</td></tr><tr><td>getset &lt;key&gt;&lt;value&gt;</td><td>以新换旧，设置新值同时获得旧值</td></tr></tbody></table><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8713.png" class=""><div class="note default no-icon flat"><p>*NX：当数据库中key不存在时，可以将key-value添加数据库<br>*XX：当数据库中key存在时，可以将key-value添加数据库，与NX参数互斥<br>*EX：key的超时秒数<br>*PX：key的超时毫秒数，与EX互斥</p></div><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-30-001439.png" class=""><h3 id="4-3-Redis列表（List）">4.3 Redis列表（List）</h3><p><strong>单键多值</strong></p><p>Redis列表时简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。<br>他的底层实际是个<font color=red size=2>双向链表</font>，对两端的操作性能很高，通过索引下标的操作中间额节点性能会较差。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8715.png" class=""><h4 id="4-3-1-数据结构">4.3.1 数据结构</h4><p>List的数据结构为快速链表quickList</p><p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构为ziplist，也即是压缩列表。<br>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p><p>当数据量比较多的时候才会改成quicklistl。</p><p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8716.png" class=""><p>Redis将链表和ziplist结合起来组成了quicklist，也就是将多个ziplist使用双向指针串起来使用。这样即满足了快速差人删除性能，又不会出现太大的空间冗余。</p><h4 id="4-3-2-常用命令">4.3.2 常用命令</h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>lpush/rpush &lt;key&gt;&lt;value&gt;&lt;value2&gt;</td><td>从左边/右边插入一个或多个值</td></tr><tr><td>lpop/rpop &lt;key&gt;</td><td>从左边/右边吐出一个值。<font color=red size=2>值在键在，值光键亡</font></td></tr><tr><td>rpop|push &lt;key1&gt;&lt;key2&gt;</td><td>从&lt;key1&gt;列表右边吐出一个值，插到&lt;key2&gt;列表左边</td></tr><tr><td>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</td><td>按照索引下标获得元素（从左到右）</td></tr><tr><td>lindex &lt;key&gt;&lt;index&gt;</td><td>按照索引下标获得元素（从左到右）</td></tr><tr><td>llen &lt;key&gt;</td><td>获得列表长度</td></tr><tr><td>linsert &lt;key&gt; before &lt;value&gt;&lt;newvalue&gt;</td><td>在&lt;value&gt;的后面插入&lt;newvalue&gt;插入值</td></tr><tr><td>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</td><td>从左边删除n个value（从左到右）</td></tr><tr><td>lset &lt;key&gt;&lt;index&gt;&lt;value&gt;</td><td>将列表key下标为index的值替换为value</td></tr></tbody></table><h3 id="4-4-Redis集合（Set）">4.4 Redis集合（Set）</h3><p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以<font color=red size=2>自动排重</font>的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否子啊一个set集合内的重要接口，这个也是list所不能提供的。</p><p>Redis的Set是string类型的<font color=red size=2>无序集合，它底层其实是一个value为null的hash表</font>，所以添加，删除，查找的<font  style="background: yellow; color: red" size=2>复杂度都是O(1)</font></p><p>一个算法，随着数据的增加，执行时间的长短，如果是O（1）,数据增加，查找数据的时间不变</p><h4 id="4-4-1-数据结构">4.4.1 数据结构</h4><p>Set数据结构是dist字典，字典是用哈希表实现的。</p><p>Java中HashSet的内部实现使用的是HashMap,只不过所有的value都指向同一个对象。<br>Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p><h4 id="4-4-2-常用命令">4.4.2 常用命令</h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt;</td><td>将一个或多个member元素加入到结合key中，已经存在的member元素将被忽略</td></tr><tr><td>smembers &lt;key&gt;</td><td>取出该集合的所有值</td></tr><tr><td>sismember &lt;key&gt;&lt;value&gt;</td><td>判断集合&lt;key&gt;是否为含有该&lt;value&gt;值，有1,没有0</td></tr><tr><td>scard &lt;value&gt;</td><td>返回该集合的元素个数</td></tr><tr><td>srem &lt;key&gt;&lt;value1&gt;&lt;value2&gt;</td><td>删除集合中的某个元素</td></tr><tr><td>spop &lt;key&gt;</td><td><font color=red size=2>随机从该集合中吐出一个值</font></td></tr><tr><td>srandmember &lt;key&gt;&lt;destination&gt;value</td><td>把集合中一个值从一个结合移动到另一个集合</td></tr><tr><td>sinter &lt;key1&gt;&lt;key2&gt;</td><td>返回两个结合的<font color=red size=2>交集</font>元素</td></tr><tr><td>sunion &lt;key1&gt;&lt;key2&gt;</td><td>返回两个集合的<font color=red size=2>并集</font>元素</td></tr><tr><td>sdiff &lt;key1&gt;&lt;key2&gt;</td><td>返回两个结合的<font color=red size=2>差集</font>元素</td></tr></tbody></table><h3 id="4-5-Redis哈希（Hash）">4.5 Redis哈希（Hash）</h3><p>Redis hash是一个键值对集合<br>Redis hash是一个string类型的<font color=red size=2>field</font>和<font color=red size=2>value</font>的映射表，hash特别适合用于存储对象。<br>类似Java里面的Map&lt;String,Object&gt;</p><p>用户ID为查找的key，存储的value用于对象包含姓名，年龄，生日等信息，如果用普通的key/value结构来存储<br>主要有以下2中存储方式：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-31-230057.png" class=""><h4 id="4-5-1-数据结构">4.5.1 数据结构</h4><p>Hash类型对应的数据结构有两种：ziplist（压缩列表），hashtable（哈希表），当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</p><h4 id="4-5-2-常用命令">4.5.2 常用命令</h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;</td><td>给&lt;key&gt;集合中的&lt;field&gt;键赋值&lt;value&gt;</td></tr><tr><td>hget &lt;key1&gt;&lt;field&gt;</td><td>从&lt;key1&gt;集合&lt;field&gt;取出value</td></tr><tr><td>hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;</td><td>批量设置hash的值</td></tr><tr><td>hexists&lt;key1&gt;&lt;field&gt;</td><td>查看哈希表key中，给定域field是否存在</td></tr><tr><td>hkeys &lt;key&gt;</td><td>列出该hash集合的所有field</td></tr><tr><td>hvals &lt;key&gt;</td><td>列出该hash集合的所有value</td></tr><tr><td>hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;</td><td>为哈希表key中的域field的值加上增量1</td></tr><tr><td>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;</td><td>将哈希表key中的域field的值设置为value,当且仅当域field不存在</td></tr></tbody></table><h3 id="4-6-Redis有序结合zset（sorted-set）">4.6 Redis有序结合zset（sorted set）</h3><p>Redis有序集合zset与普通结合set非常相似，是一个<font color=red size=2>没有重复元素</font>的字符串集合。</p><p>不同之处是有序集合的每个成员都关联了一个**<font color=red size=2>评分（score）</font>**,这个评分（score）被用来按照从第分到最高分的方式排序集合中的成员，<font color=red size=2>集合的成员是唯一的，单是评分可以重复的</font></p><p>因为元素是有序的，所有你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p><p>访问有序集合的中间元素也是非常快的，因此你能够使用有序集合作为一个没有重复成员的智能列表。</p><h4 id="4-6-1-数据结构">4.6.1 数据结构</h4><p>SortSet(zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String,Double&gt;,可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p><p>zset底层使用了两个数据结构<br>（1）hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值<br>（2）跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</p><h4 id="4-6-2-跳跃表">4.6.2 跳跃表</h4><p>1.简介<br>有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。</p><p>2.实例<br>对于有序列表和跳跃表，从链表中查询出51</p><p>（1）有序链表</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8718.png" class=""><p>要查找值为51的元素，需要从第一个元素开始依次查找，比较才能找到，共需要6次比较。</p><p>（2）跳跃表</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8719.png" class=""><p>从第2层开始，1节点比51节点小，向后比较。<br>21节点比51节点小，继续向后比较，后面就是NULL了，所以从21节点向下第1层在第1层，41节点比51节点小，继续向后，61节点比51节点大，所以从41向下在第0层，51节点为要查找的节点，节点被找到，共查找4此。</p><h4 id="4-6-3-常用命令">4.6.3 常用命令</h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>zadd &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;</td><td>将一个或多个member元素及其score值加入到有序集key当中</td></tr><tr><td><font color=red size=2>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;[WITHSCORES]</font></td><td>返回有序集key中，下标在&lt;start&gt;&lt;stop&gt;之间的元素带有WITHSCORES，可以让分数一起和值返回到结果集</td></tr><tr><td>zrangebyscore key <font color=red size=2>minmax</font> [withscores] [limit offset count]</td><td>返回有续集key中，所有score值介于min和max之间（包括等于min或max）的成员。有序集成员按score值递增（从小到大）次序排列</td></tr><tr><td>zrevrangebyscore key maxmin [withscores] [limit offset count]</td><td>同上，改为从大到小排列</td></tr><tr><td>zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;</td><td>为元素的score加上增量</td></tr><tr><td>zrem &lt;key&gt;&lt;value&gt;</td><td>删除该集合下，指定值的元素</td></tr><tr><td>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;</td><td>统计该集合下，指定值的元素</td></tr><tr><td>zrank &lt;key&gt;&lt;value&gt;</td><td>返回该值在集合中的排名，从0开始</td></tr></tbody></table><p>案例：如何利用zset实现一个文章访问量的排行榜？</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8717.png" class=""><h2 id="5-Redis安装">5. Redis安装</h2><table><thead><tr><th>Redis官方网站</th><th>Redis中文官方网站</th><th>安装版本</th></tr></thead><tbody><tr><td><a href="https://redis.io">https://redis.io</a></td><td><a href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></td><td>redis-6.2.1</td></tr></tbody></table><h3 id="5-1-准备工作">5.1 准备工作</h3><p>安装c语言编译环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-scl scl-utils-build</span><br><span class="line">yum install -y devtoolset-8-toolchain</span><br><span class="line">scl <span class="built_in">enable</span> devtoolset-8 bash</span><br></pre></td></tr></table></figure><p><strong>测试gcc版本</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-29-232701.png" class=""><h3 id="5-2-编译">5.2 编译</h3><p>在redis-6.2.1目录下执行make命令</p><p>如果没有准备好C语言编译环境，make会报错-Jemalloc/jemalloc.h:没有那个文件</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/%E5%9B%BE%E7%89%8711.png" class=""><h3 id="5-3-安装">5.3 安装</h3><p>跳过make test 继续执行make install</p><h3 id="5-4-安装目录">5.4 安装目录</h3><p>默认安装在/usr/local/bin</p><p>redis-benchmark:性能测试工具，可以在自己本子运行，看看自己本子性能如何<br>redis-check-aof：修复有问题的AOF文件，rdb和aof后面讲<br>redis-check-dump：修复有问题的dump.rdb文件<br>redis-sentinel：Redis集群使用<br>redis-server：Redis服务器启动命令<br>redis-cli：客户端，操作入口</p><h3 id="5-5-前台启动（不推荐）">5.5 前台启动（不推荐）</h3><p>前台启动，命令行窗口不能关闭，否则服务器停止</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-29-233808.png" class=""><h3 id="5-6-后台启动（推荐）">5.6 后台启动（推荐）</h3><p>拷贝一份redis.conf到其他目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /opt/module/redis-6.2.1/redis.conf /myredis/</span><br></pre></td></tr></table></figure><p>修改配置将daemonize no改成yes，让服务器在后台启动</p><p>启动redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server /myredis/redis.conf</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-29-234230.png" class=""><h3 id="5-7-客户端访问">5.7 客户端访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6379</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221029/redis-20221029-Redis%E6%A6%82%E8%BF%B0%E5%AE%89%E8%A3%85/2022-10-29-234414.png" class=""><h3 id="5-8-关闭">5.8 关闭</h3><p>单实例关闭</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NoSQL数据库简介</title>
      <link href="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/"/>
      <url>/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="1-技术发展">1. 技术发展</h2><ol><li>解决功能性问题：Java、Jsp、RDBMS、Tomcat、HTML、Linux、JDBC、SVN</li><li>解决扩展性问题：Struts、Spring、SpringMVC、Hibernate、Mybatis</li><li>解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、MQ、ElasticSearch</li></ol><h3 id="1-1-Web1-0时代">1.1 Web1.0时代</h3><p>Web1.0的时代，数据访问量很有限、用一夫当关的高性能的单点服务器可以解决大部分问题。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%871.png" class=""><h3 id="1-2-Web2-0时代">1.2 Web2.0时代</h3><p>随着Web2.0时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备普及，所有的互联网平台都面临了巨大的性能挑战。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%872.png" class=""><h3 id="1-3-解决CPU及内存压力">1.3 解决CPU及内存压力</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%873.png" class=""><h3 id="1-4-解决IO压力">1.4 解决IO压力</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%874.png" class=""><h2 id="2-NoSQL数据库概述">2. NoSQL数据库概述</h2><p>NoSQL(NoSQL = <font color=red size=2>Not Only SQL</font>)，意即“不仅仅是SQL”，泛指<font color=red size=2>非关系型的数据库</font>。<br>NoSQL不依赖业务逻辑方式存储，而以简单的<font color=red size=2>key-value</font>模式存储。因此大大的增加了数据库的扩展能力。</p><ul><li>不遵循SQL标准。</li><li>不支持ACID</li><li>远超于SQL的性能</li></ul><h2 id="3-适用场景">3. 适用场景</h2><ul><li>对数据高并发的读写</li><li>海量数据的读写</li><li>对数据高可扩展性</li></ul><h2 id="3-不适用场景">3. 不适用场景</h2><ul><li>需要事务支持</li><li>基于sql的结构化查询存储，处理复杂的关系，需要<font color=red size=2>即席</font>查询</li></ul><h2 id="4-NoSQL产品">4. NoSQL产品</h2><h3 id="4-1-Memcache">4.1 Memcache</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/2022-10-28-171451.png" class=""><h3 id="4-2-Redis">4.2 Redis</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/2022-10-28-171539.png" class=""><h3 id="4-3-MongoDB">4.3 MongoDB</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/2022-10-28-171627.png" class=""><h2 id="4-行式存储数据库（大数据时代）">4. 行式存储数据库（大数据时代）</h2><h3 id="4-1-行式数据库">4.1 行式数据库</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%875.png" class=""><h3 id="4-2-列式数据库">4.2 列式数据库</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%876.png" class=""><h3 id="4-3-Hbase">4.3 Hbase</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%877.png" class=""><p>HBase时<strong>Hadoop</strong>项目中的数据库，它用于需要对大量的数据进行随机、实时的读写操作的场景中。</p><p>HBase的目标就是处理数据量<font color=red size=2>非常庞大</font>的表，可以用<font color=red size=2>普通的计算机</font>处理超过<font color=red size=2>10亿行数据</font>，还可以处理有数百万<font color=red size=2>列</font>元素的数据表。</p><h2 id="5-图关系型数据库">5. 图关系型数据库</h2><p>主要应用：社会关系、公共交通网络、地图及网络拓扑</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/%E5%9B%BE%E7%89%878.png" class=""><h2 id="6-DB-Engines数据库排名">6. DB-Engines数据库排名</h2><p><a href="http://db-engines.com/en/ranking">http://db-engines.com/en/ranking</a></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221028/redis-20221028-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/2022-10-28-172949.png" class="">]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka安装部署</title>
      <link href="/20221023/kafka-20221023-kafka%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/20221023/kafka-20221023-kafka%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h2 id="1-集群规划">1. 集群规划</h2><table><thead><tr><th>hadoop101</th><th>hadoop102</th><th>hadoop103</th></tr></thead><tbody><tr><td>zk</td><td>zk</td><td>zk</td></tr><tr><td>kafka</td><td>kafka</td><td>kafka</td></tr></tbody></table><h2 id="2-集群部署">2. 集群部署</h2><p>官方下载地址：<a href="http://kafka.apache.org/downloads.html">http://kafka.apache.org/downloads.html</a></p><h3 id="2-1-解压安装包">2.1 解压安装包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /opt/module &amp;&amp; tar xf kafka_2.12-3.0.0.tgz -C /opt/module/</span><br></pre></td></tr></table></figure><h3 id="2-2-修改解压后的文件名称">2.2 修改解压后的文件名称</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka概述</title>
      <link href="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/"/>
      <url>/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-定义">1. 定义</h2><p><strong>Kafka传统定义：</strong> Kafka是一个<font color=red size=2>分布式</font>的基于<font color=red size=2>发布/订阅模式</font>的<font color=red size=2>消息队列</font>（MessageQueue），主要应用于大数据实时处理领域。</p><p><strong>发布/订阅：</strong> 消息的发布者不会将消息直接发送给特定的订阅者，而是<font color=red size=2>将发布的消息分为不同的类别</font>，订阅者<font color=red size=2>只接收感兴趣的消息</font>。</p><p><strong>kafka最新定义：</strong> Kafka是一个开源的<font color=red size=2>分布式事件流平台</font>（Event Streaming Platform），被数千家公司用于高性能<font color=red size=2>数据管道</font>、<font color=red size=2>流分析</font>、<font color=red size=2>数据集成</font>和<font color=red size=2>关键任务应用</font>。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-230-162617.png" class=""><h2 id="2-消息队列">2. 消息队列</h2><p>目前企业中比较常见的消息队列产品主要有 Kafka、ActiveMQ、RabbitMQ、RocketMQ等。</p><p>在大数据场景主要采用Kafka作为消息队列。在JavaEE开发中主要采用ActiveMQ、RabbitMQ、RocketMQ。</p><h3 id="2-1-传统消息队列的应用场景">2.1 传统消息队列的应用场景</h3><p>传统的消息队列的主要应用场景包括：<strong>缓存/消峰</strong>、<strong>解耦</strong>和<strong>异步通信</strong>。</p><h4 id="2-1-1-缓存-消峰">2.1.1 缓存/消峰</h4><p>有助于控制和优化数据流经过系统的速度，解决生产消息和消费消息的处理速度不一致的情况。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-23163511.png" class=""><h4 id="2-1-2-解耦">2.1.2 解耦</h4><p>允许你独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-23163803.png" class=""><h4 id="2-1-3-异步通信">2.1.3 异步通信</h4><p>允许用户把一个消息放入队列，但并不立即处理它，然后在需要的时候再去处理它们。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-23164001.png" class=""><h3 id="2-2-消息队列的两种模式">2.2 消息队列的两种模式</h3><h4 id="2-2-1-点对点模式">2.2.1 点对点模式</h4><p>消费者主动拉取数据，消息收到后消除消息</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-23164254.png" class=""><h4 id="2-2-2-发布-订阅模式">2.2.2 发布/订阅模式</h4><ul><li>可以有多个topic主题（浏览、点赞、收藏、评论等）</li><li>消费者消费数据之后，不删除数据</li><li>每个消费者相互独立、都可以消费到数据</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-23-164544.png" class=""><h2 id="3-Kafka基础架构">3. Kafka基础架构</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221023/kafka-20221023-Kafka%E6%A6%82%E8%BF%B0/2022-10-230-170404.png" class=""><ol><li>Producer：消息生产者，就是向Kafka broker发消息的客户端</li><li>Consumer：消息消费者，向Kafka broker取消息的客户端</li><li>Consumer Group (CG)：消费者组，由多个consumer组成。<font color=red size=2>消费者组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费：消费者组之间互不影响。</font>所有的消费者都属于某个消费者组，即<font color=red size=2>消费者组是逻辑上的一个订阅者。</font></li><li>Broker：一台Kafka服务器就是一个broker。一个集群由多个broker组成。一个broker可以容纳多个topic。</li><li>Topic：可以理解为一个队列，<font color=red size=2>生产者和消费者面向的都是一个topic</font></li><li>Partition：为了实现扩展性，一个非常大的topic可以分布到多个broker(即服务器)上，<font color=red size=2>一个topic可以分为多个partition</font>,每个partition是一个<font color=red size=2>有序的队列</font>。</li><li>Replica：副本。一个topic的每个分区都有若干个副本，一个<font color=red size=2>Leader</font>和若干额<font color=red size=2>Follower</font>。</li><li>Leader：每个分区多个<font color=red size=2>副本的&quot;主&quot;</font>，生产者发送数据的对象，以及消费者消费数据的对象都是Leader。</li><li>Follower：每个分区多个<font color=red size=2>副本中的“从”</font>，实时从Leader中同步数据，保持和Leader数据的同步。Leader发生故障时，某个Follower会成为新的Leader。</li></ol>]]></content>
      
      
      <categories>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8.envoy</title>
      <link href="/20221012/istio-20221012-8-envoy/"/>
      <url>/20221012/istio-20221012-8-envoy/</url>
      
        <content type="html"><![CDATA[<h2 id="1-配置文件结构">1. 配置文件结构</h2><p>侦听器Listener<br>监听进网关inbound的流量，listener只接受来自绑定端口的请求。任何通过其他端口进来的请求都不会被envoy看到或者处理，发送该请求的用户只会获得错误响应。<br>一旦请求被listener接受，他就会经过一条过滤链（filter chain），这个过滤链描述请求一旦进入到envoy之后会被如何处理。</p><p>filterchain 由一些列的filter组成。<br>filter决定请求是否继续传递到下一条filter，还是返回给用户404错误。<br>如果通过了所有的filter之后，route（filter chain的扩展）将httpd请求转发到正确的集群或者服务（k8s里的svc的概念）。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221012/istio-20221012-8-envoy/2022-10-12-213629.png" class=""><div class="note default no-icon flat"><p>listen–监听器<br> 1.监听的地址<br> 2.过滤链<br>  filter1<br>  filter2<br>  filter3</p><p>这里filter是用于限制过来的流量的<br>比如限速<br>比如修改报头信息等</p><p>cluster<br> 转发规则<br> endpoints<br> --指定后端地址</p></div><h2 id="2-自定义envoy">2. 自定义envoy</h2><h3 id="2-1-创建2个后端容器">2.1 创建2个后端容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name web1 --restart=always nginx</span><br><span class="line">docker run -d --name web2 --restart=always nginx</span><br></pre></td></tr></table></figure><h3 id="2-2-创建enovy配置文件">2.2 创建enovy配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">admin:</span></span><br><span class="line">  <span class="attr">access_log_path:</span> <span class="string">/tmp/admin_access.log</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">socket_address:</span> &#123; <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>, <span class="attr">port_value:</span> <span class="number">9901</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="attr">static_resources:</span></span><br><span class="line">  <span class="attr">listeners:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">listener_0</span></span><br><span class="line">    <span class="attr">address:</span></span><br><span class="line">      <span class="attr">socket_address:</span> &#123; <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>, <span class="attr">port_value:</span> <span class="number">10000</span> &#125;</span><br><span class="line">    <span class="attr">filter_chains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span></span><br><span class="line">          <span class="attr">stat_prefix:</span> <span class="string">ingress_http</span></span><br><span class="line">          <span class="attr">codec_type:</span> <span class="string">AUTO</span></span><br><span class="line">          <span class="attr">route_config:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">local_route</span></span><br><span class="line">            <span class="attr">virtual_hosts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local_service</span></span><br><span class="line">              <span class="attr">domains:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">              <span class="attr">routes:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span> &#123; <span class="attr">prefix:</span> <span class="string">&quot;/&quot;</span> &#125;</span><br><span class="line">                <span class="attr">route:</span> &#123; <span class="attr">cluster:</span> <span class="string">some_service</span> &#125;</span><br><span class="line">          <span class="attr">http_filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.http.lua</span></span><br><span class="line">            <span class="attr">typed_config:</span></span><br><span class="line">              <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span></span><br><span class="line">              <span class="comment">#inline_code: |</span></span><br><span class="line">              <span class="attr">inlineCode:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                function envoy_on_response(response_handle)</span></span><br><span class="line"><span class="string">                  response_handle:headers():add(&quot;X-User-Header&quot;, &quot;===XXX==&quot;)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span>          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.router</span></span><br><span class="line">  <span class="attr">clusters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">some_service</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">STATIC</span></span><br><span class="line">    <span class="comment">#type: LOGICAL_DNS</span></span><br><span class="line">    <span class="attr">dns_lookup_family:</span> <span class="string">V4_ONLY</span></span><br><span class="line">    <span class="attr">lb_policy:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">    <span class="attr">load_assignment:</span></span><br><span class="line">      <span class="attr">cluster_name:</span> <span class="string">some_service</span></span><br><span class="line">      <span class="attr">endpoints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">lb_endpoints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">endpoint:</span></span><br><span class="line">            <span class="attr">address:</span></span><br><span class="line">              <span class="attr">socket_address:</span></span><br><span class="line">                <span class="attr">address:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">                <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">endpoint:</span></span><br><span class="line">            <span class="attr">address:</span></span><br><span class="line">              <span class="attr">socket_address:</span></span><br><span class="line">                <span class="attr">address:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">                <span class="attr">port_value:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="2-3-创建envoy">2.3 创建envoy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 10000:10000 -v /root/envoy.yaml:/etc/envoy/envoy.yaml --name myenvoy envoyproxy/envoy:latest</span><br></pre></td></tr></table></figure><p>获取结果</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221012/istio-20221012-8-envoy/2022-10-12-230405.png" class=""><h2 id="3-envoyFilter">3. envoyFilter</h2><p>EnvoyFilter用来自定义 Istio Pilot 生成的 Envoy 配置。使用 EnvoyFilter 可以修改某些envoy的字段，添加特定的过滤器，甚至添加全新的监听器、集群等。必须谨慎使用此功能</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lua-filter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">      <span class="attr">listener:</span></span><br><span class="line">        <span class="attr">filterChain:</span></span><br><span class="line">          <span class="attr">filter:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">&quot;envoy.filters.network.http_connection_manager&quot;</span></span><br><span class="line">            <span class="attr">subFilter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">&quot;envoy.filters.http.router&quot;</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">envoy.lua</span></span><br><span class="line">       <span class="attr">typed_config:</span></span><br><span class="line">         <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">&quot;type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua&quot;</span></span><br><span class="line">         <span class="attr">inlineCode:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            function envoy_on_response(response_handle)</span></span><br><span class="line"><span class="string">                response_handle:headers():add(&quot;X-User-Header&quot;, &quot;===XXX==&quot;)</span></span><br><span class="line"><span class="string">            end</span></span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>workloadSelector: 用于指定作用在谁<br>configPatches：用于配置补丁，下面的属性包括3个大类</p><ul><li>apply_To: 应用到谁<br>match：指定匹配规则<br>patch：新的规则</li></ul><p>applyTo: 给哪个位置打补丁，可用的值包括<br> INVALID<br> LISTENER 将补丁应用到监听器<br> FILTER_CHAIN 将补丁应用到过滤器链<br> NETWORK_FILTER 将补丁应用到网络过滤器链<br> HTTP_FILTER 将补丁应用到HTTP过滤器链<br> ROUTE_CONFIGURATION<br> VIRTUAL_HOST<br> HTTP_ROUTE<br> CLUSTER</p></div>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7.安全管理</title>
      <link href="/20221011/istio-20221011-7-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86/"/>
      <url>/20221011/istio-20221011-7-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-6">1. 简介</h2><p>mTLS (mutual TLS，双向TLS)： 让客户端和服务器端通信的时候都必须进行TLS认证<br>默认情况下，在网格内部默认启用了mTLS了。</p><h2 id="2-启用tls网关">2. 启用tls网关</h2><h3 id="2-1-创建私钥">2.1 创建私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/istio/ingressgateway-certs/mykey.key -out /etc/istio/ingressgateway-certs/mycrt.crt -subj <span class="string">&quot;/CN=mytest/O=my-test&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-创建secret">2.2 创建secret</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic istio-ingressgateway-certs --from-file /etc/istio/ingressgateway-certs/mykey.key --from-file /etc/istio/ingressgateway-certs/mycrt.crt -n istio-system</span><br></pre></td></tr></table></figure><h3 id="2-3-创建gateway">2.3 创建gateway</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mygw</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;bb.rhce.cc&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;demoapp.rhce.cc&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">httpsRedirect:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line">      <span class="attr">serverCertificate:</span> <span class="string">/etc/istio/ingressgateway-certs/mycrt.crt</span></span><br><span class="line">      <span class="attr">privateKey:</span> <span class="string">/etc/istio/ingressgateway-certs/mykey.key</span></span><br></pre></td></tr></table></figure><h2 id="3-PeerAuthentication">3. PeerAuthentication</h2><p>用于设置别人在和网格里的pod进行通信的时候,是否要求mTLS</p><h3 id="3-1-默认策略">3.1 默认策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="comment">#mode: PERMISSIVE</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>PERMISSIVE：工作负载接受双向TLS和纯文本流量,当没有Sidecar的工作负载无法使用双向TLS时，此模式适合用在迁移过程。<br>通过使用sidecar注入迁移工作负载后，应该将模式切换为STRICT。<br>STRICT：工作负载仅接受双向TLS通信。</p></div><h3 id="3-2-选择性策略">3.2 选择性策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br><span class="line">  <span class="attr">portLevelMtls:</span></span><br><span class="line">    <span class="attr">80:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br></pre></td></tr></table></figure><h2 id="4-授权管理AuthorizationPolicy">4. 授权管理AuthorizationPolicy</h2><p>设置的是允许哪些客户端允许过来访问,功能类似k8s networkpolicy</p><p>拒绝优先级 &gt; 允许优先</p><h3 id="4-1-默认拒绝">4.1 默认拒绝</h3> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里就拒绝掉了所有的，虽然这里没有指定是允许还是拒绝，但是是拒绝的意思。<br>默认是拒绝的意思，且优先级最低</p></div><h3 id="4-2-允许访问pod1">4.2 允许访问pod1</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>一旦设置了允许，那么没有允许的也会被拒绝。这种写了action: DENY，然后在rules里写了{}，则是拒绝所有的，这种优先级最高，其他的allow都不会在生效</p></div><h3 id="4-3-基于名称空间过滤">4.3 基于名称空间过滤</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ns2</span></span><br></pre></td></tr></table></figure><h3 id="4-4-基于sa过滤">4.4 基于sa过滤</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">principals:</span> [<span class="string">&quot;cluster.local/ns/ns1/sa/default&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="4-5-基于IP地址过滤">4.5 基于IP地址过滤</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">ipBlocks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;0.0.0.0/0&quot;</span></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>ipBlocks: 允许的IP通信<br>notIpBlocks: 拒绝的ip</p></div><h3 id="4-6-基于头部信息过滤">4.6 基于头部信息过滤</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">remoteIpBlocks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;192.168.26.23&quot;</span></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>remoteIpBlocks: 允许的IP通信<br>notRemoteIpBlocks: 拒绝的ip</p></div><p>只有指定了X-Forwarded-For头部信息才可以访问</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221011/istio-20221011-7-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86/2022-10-12-011112.png" class=""><h3 id="4-7-限制请求方法">4.7 限制请求方法</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;GET&quot;</span>]</span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;svc2&quot;</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/demo1/*</span></span><br></pre></td></tr></table></figure><h3 id="4-8-when语句">4.8 when语句</h3><p>when和from这些是或的关系</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">when:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">request.headers[test]</span></span><br><span class="line">      <span class="attr">values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;test&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4-9-JWT过滤">4.9 JWT过滤</h3><p>JWT全称： Json Web Token<br>本质就是类似用户名和密码，客户端访问的时候，必须要提供这些token信息，不然访问不了。<br>这个token有固定的格式，采用JWK/JWKs格式的。<br>JWK： Json Web Key<br>JWKs ：JWK set</p><h4 id="4-9-1-生成token">4.9.1 生成token</h4><p>生成公钥和私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out key.pem 2048</span><br><span class="line">openssl rsa -<span class="keyword">in</span> key.pem -pubout -out pub.pem</span><br></pre></td></tr></table></figure><p>生成JWKs信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install boost-python36.x86_64 python3-pip.noarch</span><br><span class="line">pip3 install --upgrade pip</span><br><span class="line">pip3 install jwt</span><br><span class="line">pip3 install ipython jwcr</span><br></pre></td></tr></table></figure><p>脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#-*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> jwcrypto.jwk <span class="keyword">import</span> JWK</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">private_key = Path(<span class="string">&quot;key.pem</span></span><br><span class="line"><span class="string">&quot;</span>).read_bytes()</span><br><span class="line">jwk = JWK.from_pem(private_key)</span><br><span class="line"><span class="comment"># 导出公钥 RSA Public Key</span></span><br><span class="line">public_key = jwk.public().export_to_pem()</span><br><span class="line"><span class="built_in">print</span>(public_key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">30</span>)</span><br><span class="line"><span class="comment"># 导出 JWK</span></span><br><span class="line">jwk_bytes = jwk.public().export()</span><br><span class="line"><span class="built_in">print</span>(jwk_bytes)</span><br></pre></td></tr></table></figure><p>或在线生成 <a href="https://8gwifi.org/jwkconvertfunctions.jsp">https://8gwifi.org/jwkconvertfunctions.jsp</a></p><h4 id="4-9-2-创建ra">4.9.2 创建ra</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;security.istio.io/v1beta1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;RequestAuthentication&quot;</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;productpage&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">jwtRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">issuer:</span> <span class="string">&quot;testing@secure.istio.io&quot;</span></span><br><span class="line">    <span class="attr">jwks:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123; &quot;keys&quot;:</span></span><br><span class="line"><span class="string">         [</span></span><br><span class="line"><span class="string">           &#123;</span></span><br><span class="line"><span class="string">             &quot;e&quot;:&quot;AQAB&quot;,</span></span><br><span class="line"><span class="string">             &quot;kid&quot;:&quot;85d3c3fe-5c86-4482-a165-9b66dc3773c3&quot;,</span></span><br><span class="line"><span class="string">             &quot;kty&quot;:&quot;RSA&quot;,</span></span><br><span class="line"><span class="string">             &quot;n&quot;:&quot;ucu4hlGJFdEw4rLW1hmVCa_sHcAyKrHnBxtFYGUVVLvUBAGZ1pgU2YOmtTDoN5rrew_4-511U1q4IYmWKiwNjt-4-JLR7auTH8L_GIcpUh8LO77i8btsbExV7hduHc1ewiOI8fgTUQ4sADiLb-_hnZTYaAJTpNOVZKcyIakNo7rNTXFzaArKVp88GMZMIq6f9R2f-Sd-Hh70aMzwUFAA3bpWxRQYdYrQschKnBceVLNKXtXjQA0MZnb-dq6sjiVmkp0a20GBs8-ib-mIZROkM8Mno9mu4DXZVu0GLJRUwU_puwMZ6hQqB8ucsS0l2xMJtc_2uL05f-Vd5V9JLAdzJw&quot;</span></span><br><span class="line"><span class="string">           &#125;</span></span><br><span class="line"><span class="string">         ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br></pre></td></tr></table></figure><h4 id="4-9-3-创建AuthorizationPolicy">4.9.3 创建AuthorizationPolicy</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-pod1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">requestPrincipals:</span> [<span class="string">&quot;testing@secure.istio.io/testing@secure.istio.io&quot;</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6.workEntry</title>
      <link href="/20221010/istio-20221010-6-workEntry/"/>
      <url>/20221010/istio-20221010-6-workEntry/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-4">1. 简介</h2><p>目的是把其他主机纳入到service mesh里</p><h2 id="2-原理">2. 原理</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221010/istio-20221010-6-workEntry/2022-10-10-141302.png" class=""><h2 id="3-创建">3. 创建</h2><h3 id="3-1-启用自动注册">3.1 启用自动注册</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> profile=demo --<span class="built_in">set</span> values.pilot.env.PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-2-添加路由">3.2 添加路由</h3><p>集群外主机添加路由到istiod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -net 10.244.0.0 gw 192.168.10.33 netmask 255.255.0.0</span><br></pre></td></tr></table></figure><h3 id="3-3-安装sidecar">3.3 安装sidecar</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://storage.googleapis.com/istio-release/releases/1.14.1/deb/istio-sidecar.deb</span><br><span class="line"></span><br><span class="line">dpkg -i istio-sidecar.deb</span><br></pre></td></tr></table></figure><h3 id="3-4-创建wg">3.4 创建wg</h3><p>workloadgroup可以理解为是一个模板，类似于deployment，wg也有模板—这些节点有什么标签，以什么sa来运行等</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadGroup</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mywg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">ports:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><h3 id="3-5-安装证书">3.5 安装证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> 11</span><br><span class="line">istioctl x workload entry configure -f wg.yaml -o 11</span><br></pre></td></tr></table></figure><h3 id="3-6-启动sidecar">3.6 启动sidecar</h3><p><strong>在虚拟机上安装根证书</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/certs</span><br><span class="line"><span class="built_in">cp</span> 11/root-cert.pem /etc/certs/root-cert.pem</span><br></pre></td></tr></table></figure><p><strong>安装令牌</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/run/secrets/tokens</span><br><span class="line"><span class="built_in">cp</span> 11/istio-token /var/run/secrets/tokens/istio-token</span><br><span class="line"><span class="built_in">cp</span> 11/cluster.env /var/lib/istio/envoy/cluster.env</span><br></pre></td></tr></table></figure><p><strong>将网格配置安装到/etc/istio/config/mesh</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> 11/mesh.yaml /etc/istio/config/mesh</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/istio/proxy</span><br><span class="line"><span class="built_in">chown</span> -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /etc/istio/config /var/run/secrets /etc/certs/root-cert.pem</span><br></pre></td></tr></table></figure><p><strong>修改/etc/hosts</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.244.186.141 istiod.istio-system.svc</span><br></pre></td></tr></table></figure><p><strong>启动sidecar</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start istio</span><br></pre></td></tr></table></figure><h3 id="3-7-创建we">3.7 创建we</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-vm-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">vm2</span></span><br></pre></td></tr></table></figure><h3 id="3-8-创建svc">3.8 创建svc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vm-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http-vm</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8888</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><h3 id="3-9-创建vs">3.9 创建vs</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cc.rhce.cc</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">vm-svc</span></span><br></pre></td></tr></table></figure><h3 id="3-10-关闭mtls">3.10 关闭mtls</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="comment">#mode: PERMISSIVE</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br></pre></td></tr></table></figure><h3 id="3-11-测试">3.11 测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@control:~<span class="comment"># curl cc.rhce.cc</span></span><br><span class="line">test-nginx</span><br></pre></td></tr></table></figure><h3 id="3-12-创建se">3.12 创建se</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vm-svc</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><h3 id="3-13-测试">3.13 测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@pod1:/<span class="comment"># curl vm-svc</span></span><br><span class="line">test-nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5.出口流量serviceEntry</title>
      <link href="/20221009/istio-20221009-5-%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8FserviceEntry/"/>
      <url>/20221009/istio-20221009-5-%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8FserviceEntry/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-5">1. 简介</h2><p>如果想控制被注入的pod访问外部流量，那么需要把外界主机拉入到网格，serviceEntry把网格之外的主机，假象是在网格里，之后便可通过vs控制出口流量。</p><h2 id="2-创建se">2. 创建se</h2><h3 id="2-1-DNS解析">2.1 DNS解析</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myes</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">www.baidu.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>MESH_EXTERNAL – 网格外部<br>MESH_INTERNAL – 网格内</p></div><h3 id="2-2-静态指定">2.2 静态指定</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myes</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test.k8s.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.10</span></span><br></pre></td></tr></table></figure><h3 id="2-3-创建vs">2.3 创建vs</h3><p>延迟4秒响应</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test.k8s.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percent:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">4s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">test.k8s.com</span></span><br></pre></td></tr></table></figure><h3 id="2-4-exportTo">2.4 exportTo</h3><p>是否影响其他命名空间，如果是.则不影响，如果是*则影响，默认是 *</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myes</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test.k8s.com</span></span><br><span class="line">  <span class="attr">exportTo:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.10</span></span><br></pre></td></tr></table></figure><h2 id="3-默认策略">3. 默认策略</h2><p>默认允许访问所有地址，修改为只允许访问注入的地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> profile=demo -y --<span class="built_in">set</span> meshConfig.outboundTrafficPolicy.mode=REGISTRY_ONLY</span><br></pre></td></tr></table></figure><p>kubectl edit configmap istio -n istio-system</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">mesh:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">accessLogFile:</span> <span class="string">/dev/stdout</span></span><br><span class="line"><span class="attr">defaultConfig:</span></span><br><span class="line"><span class="attr">discoveryAddress:</span> <span class="string">istiod.istio-system.svc:15012</span></span><br><span class="line"><span class="attr">proxyMetadata:</span> &#123;&#125;</span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line"><span class="attr">zipkin:</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">zipkin.istio-system:9411</span></span><br><span class="line"><span class="attr">enablePrometheusMerge:</span> <span class="literal">true</span></span><br><span class="line"> <span class="attr">outboundTrafficPolicy:</span></span><br><span class="line"> <span class="attr">mode:</span> <span class="string">REGISTRY_ONLY</span></span><br><span class="line"><span class="attr">rootNamespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">trustDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="attr">meshNetworks:</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="string">networks: &#123;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="3-1-创建se">3.1 创建se</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myes</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">www.baidu.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4.使用dr流量管理</title>
      <link href="/20221008/istio-20221008-4-%E4%BD%BF%E7%94%A8dr%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/"/>
      <url>/20221008/istio-20221008-4-%E4%BD%BF%E7%94%A8dr%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-了解DR">1. 了解DR</h2><p>DestinationRule定义的是经过VS之后，已经到达service的流量，主要可以用于：</p><ol><li>定义子集</li><li>定义流量管理<ol><li>LB策略<br>LB算法<br>哈希一致性算法</li><li>连接池</li><li>异常处理</li></ol></li></ol><h2 id="2-定义子集">2. 定义子集</h2><p>定义dr的时候，要指定此dr用于在哪个service上</p><h3 id="2-1-创建dr">2.1 创建dr</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><h3 id="2-2-创建vs">2.2 创建vs</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">30</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">70</span></span><br></pre></td></tr></table></figure><p>验证流量</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221008/istio-20221008-4-%E4%BD%BF%E7%94%A8dr%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/2022-10-08-170657.png" class=""><h2 id="3-流量管理">3. 流量管理</h2><h3 id="3-1-tls">3.1 tls</h3><p>是否启用tls</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>DISABLE 不要设置到上游端点的 TLS 连接<br>SIMPLE 发起到上游端点的 TLS 连接<br>MUTUAL 通过提供客户端证书进行身份验证，使用双向 TLS 保护与上游的连接<br>ISTIO_MUTUAL 通过提供客户端证书进行身份验证，使用双向 TLS 保护与上游的连接。与 Mutual 模式相比，该模式使用 Istio 自动生成的证书进行 mTLS 身份验证。使用此模式时，所有其他字段ClientTLSSettings应为空。</p></div><h3 id="3-1-LB调度算法">3.1 LB调度算法</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">RANDOM</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221008/istio-20221008-4-%E4%BD%BF%E7%94%A8dr%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/2022-10-08-175034.png" class=""><h3 id="3-2-会话保持">3.2 会话保持</h3><p>会话保持的目的是，让同一个客户端访问的时候，访问到同一个pod上，istio用一致性哈希算法实现了会话保持。</p><p>在trafficPolicy.loadBalancer.consistentHash里的字段包括：<br>  httpHeaderName: 根据HTTP Header获取哈希值<br> httpCookie： 根据HTTP Cookie获取哈希值<br> userSourceIp： 根据源IP获取哈希值<br> minimumRingSize： 哈希环所需的最小虚拟节点数量，默认值为1024<br><nr/><br> 使用httpCookie时的字段：<br>  name: cookie的名称<br>  path： 设置cookie的路径<br>  ttl：cookie的生命期</p><h4 id="3-2-1-基于cookie会话保持">3.2.1 基于cookie会话保持</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">httpCookie:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">ttl:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><h4 id="3-2-1-基于IP地址的会话保持">3.2.1 基于IP地址的会话保持</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">userSourceIp:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><h2 id="4-熔断">4. 熔断</h2><p>当A服务访问B服务的时候，访问量大，会给B服务带来压力，所以这个时候可以禁止访问B服务。这个就叫做熔断。</p><h3 id="4-1-一些概念">4.1 一些概念</h3><p>连接数：<br>客户端向服务端发请求，需要建立TCP连接，那么建立TCP连接的数量就是连接数。<br>并发连接数（SBC）：每秒建立的TCP连接数<br><nr><br>请求数：<br>客户端建立连接后，先服务端发送GET/POST/HEAD数据包，服务器返回结果两种情况：<br> 1、http数据包头有close字段，关闭连接<br> 2、http数据包头有keep-live字段，本次连接不关闭，可以下一次继续发送请求，减少TCP连接<br>并发请求数（QPS）:每秒钟处理的请求数</p><h3 id="4-2-连接池">4.2 连接池</h3><p>熔断的定义是在DR里定义的，主要有2部分</p><p>trafficPolicy：<br> 用于定义连接池<br> 连接池的定义分成两类：<br>  TCP连接<br>   maxConncections: 到目标主机的最大连接数<br>   connectTimeOut： TCP连接超时，最小值必须要大于1ms</p><p>  Thttp连接<br>   http1MaxPendingReguests: 针对一个目标的HTTP请求最大排队数量，默认是1024<br>   http2MaxRequests: 对一个后端的最大请求数<br>   maxRequestsPerConnection:<br>   maxReties： 在给定的时间，集群所有主机最大重试数，默认值为3</p><h3 id="4-3-定义熔断">4.3 定义熔断</h3><p>最多允许2个并发连接数，最多1个排队</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">httpCookie:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">ttl:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><h3 id="4-4-压测">4.4 压测</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fortio load -c 2 -n 20 -qps 0 http://aa.rhce.cc</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>#命令解释如下：<br>-c 表示并发数<br>-n 一共多少请求<br>-qps 每秒查询数，0 表示不限制</p></div><h3 id="4-5-不同端口定义策略">4.5 不同端口定义策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">portLevelSettings:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">      <span class="attr">connectionPool:</span></span><br><span class="line">        <span class="attr">tcp:</span></span><br><span class="line">          <span class="attr">maxConnections:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">httpCookie:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">ttl:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure><h2 id="5-异常处理">5. 异常处理</h2><p>outlierDetection：用于定义熔断的条件，达到什么条件就开始熔断<br>consecutiveGatewayErrors: 1 连续错误几次开始熔断，该实例会被踢掉<br>interval：驱逐检查的时间间隔（驱逐检测的统计时间），默认为10秒</p><p>baseEjectionTime指定来一个实例被踢掉之后，最少多长时间之后加回来，如果连续触发熔断，熔断的时长会乘以相应的倍数,时间默认为30秒一个服务被驱逐的时间等于驱逐次数乘以最小驱逐时间,所以被驱逐的实例再被再次驱逐时会变得越来越长<br>maxEjectionPercent：服务的可驱逐故障实例的最大比例，默认为10%。官方不建议配置过高，过分的驱逐会影响服务的服务能力<br>minHealthPercent：最小健康比例，当负载的实例中，如果健康的实例数量低于这个比例，istio会进入恐慌模式，异常检查功能会被禁用，所有的服务不论是否是故障实例都可以接受请求。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">svc4</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">portLevelSettings:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">      <span class="attr">connectionPool:</span></span><br><span class="line">        <span class="attr">tcp:</span></span><br><span class="line">          <span class="attr">maxConnections:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">outlierDetection:</span></span><br><span class="line">      <span class="attr">consecutiveGatewayErrors:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">baseEjectionTime:</span> <span class="string">3m</span></span><br><span class="line">      <span class="attr">maxEjectionPercent:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">httpCookie:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">ttl:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod2</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3.使用vs流量管理</title>
      <link href="/20221004/istio-20221004-3-%E4%BD%BF%E7%94%A8vs%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/"/>
      <url>/20221004/istio-20221004-3-%E4%BD%BF%E7%94%A8vs%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-基本使用-2">1. 基本使用</h2><h3 id="1-1-创建网关">1.1 创建网关</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mygw</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-创建vs">1.2 创建vs</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br></pre></td></tr></table></figure><h2 id="2-svc走网格流量">2. svc走网格流量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br></pre></td></tr></table></figure><h2 id="3-特定端口访问">3. 特定端口访问</h2><h3 id="3-1-修改ingress控制器svc">3.1 修改ingress控制器svc</h3><p>暴露指定的端口</p><p>kubectl -n istio-system edit service istio-ingressgateway</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http3</span></span><br><span class="line">  <span class="attr">nodePort:</span> <span class="number">30138</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><h3 id="3-2-修改网关">3.2 修改网关</h3><p>网关添加端口拦截流量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mygw</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8888</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http2</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-vs添加8888流量转发">3.3 vs添加8888流量转发</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">custom</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h2 id="4-uri拦截">4. uri拦截</h2><p>规则从上向下匹配</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/demo1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/demo2</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br></pre></td></tr></table></figure><h2 id="5-带权重的vs">5. 带权重的vs</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">90</span></span><br></pre></td></tr></table></figure><h3 id="5-1-查看流量图">5.1 查看流量图</h3><p>通过kiali查看流量分布图</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221004/istio-20221004-3-%E4%BD%BF%E7%94%A8vs%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/2022-10-05-220228.png" class=""><h2 id="6-http重写">6. http重写</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aaa</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/demo1</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/demo2</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br></pre></td></tr></table></figure><h2 id="7-转发到其他命名空间">7. 转发到其他命名空间</h2><h3 id="7-1-ns2创建pod">7.1 ns2创建pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl kube-inject -f pod1.yaml | kubectl apply -f - -n ns2</span><br></pre></td></tr></table></figure><h3 id="7-2-创建svc">7.2 创建svc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ns2 expose --name svc1 pod pod1 --port 80</span><br></pre></td></tr></table></figure><h3 id="7-3-创建vs">7.3 创建vs</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br></pre></td></tr></table></figure><h3 id="7-4-转发到ns2空间vs">7.4 转发到ns2空间vs</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aaa</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/demo1</span></span><br><span class="line">    <span class="attr">delegate:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">ns2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br></pre></td></tr></table></figure><h2 id="8-基于头部转发">8. 基于头部转发</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">User-Agent:</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">.*(Chrome/([\d.]+)).*</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br></pre></td></tr></table></figure><h2 id="9-故障注入">9. 故障注入</h2><p>故障注入是在vs的fault字段定义，fault下主要有两个字段<br>abort：终止的意思 — 用于中断故障注入<br>percentage: 故障百分比–在value里指定具体数值，用于指定故障百分比，比如写100的话，则是所有访问都是故障<br>httpStatus：模拟错误，返回的错误代码<br>delay：延期的意思 — 用于延迟故障注入<br>percentage: 故障百分比–在value里指定具体数值，用于指定故障百分比，比如写100的话，则是所有访问都是故障<br>fixedDelay：用于设置延迟多久回应</p><h3 id="9-1-延迟响应">9.1 延迟响应</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percent:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">1s</span></span><br></pre></td></tr></table></figure><h3 id="9-2-中断故障">9.2 中断故障</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">abort:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">httpStatus:</span> <span class="number">503</span></span><br></pre></td></tr></table></figure><h2 id="10-超时重连">10. 超时重连</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221004/istio-20221004-3-%E4%BD%BF%E7%94%A8vs%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/2022-10-07-235007.png" class=""><h3 id="10-1-创建vs-proxy">10.1 创建vs-proxy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vs-proxy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;bb.rhce.cc&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">retries:</span> </span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span> </span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">3s</span> </span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">5xx</span></span><br></pre></td></tr></table></figure><h3 id="10-2-创建vs2">10.2 创建vs2</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vs2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc2</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc2</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">abort:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">httpStatus:</span> <span class="number">503</span></span><br></pre></td></tr></table></figure><h3 id="10-3-请求">10.3 请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl bb.rhce.cc</span><br></pre></td></tr></table></figure><p>查看proxy日志，当上游服务报错会自动重试</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20221004/istio-20221004-3-%E4%BD%BF%E7%94%A8vs%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/2022-10-07-235308.png" class=""><h2 id="11-流量镜像">11. 流量镜像</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myvs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;aa.rhce.cc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygw</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">svc1</span></span><br><span class="line">    <span class="attr">mirror:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">svc3</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.istio介绍及安装</title>
      <link href="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/"/>
      <url>/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-3">1. 简介</h2><p>istio主要解决原生k8s三个问题，流量管控、安全性、可观测性。<br>要想使用istio：<br>非网格里的设备的流量需要进入到网格里去必须要经过istio-ingress-gw<br>网格里的数据要进入到非网格里要经过istio-egress-gw</p><h3 id="1-1-主要能用到的资源类型">1.1 主要能用到的资源类型</h3><p>Gateway<br>VirtualService<br>DestinationRule<br>ServiceEntry</p><p>PeerAuthentication<br>AuthorizationPolicy<br>RequestAuthentication</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/2022-09-29-165626.png" class=""><h3 id="1-2-istio架构图">1.2 istio架构图</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/2022-09-29-165814.png" class=""><h3 id="1-3-pilot">1.3 pilot</h3><p>Discovery Services：pilot-discovery，扮演服务注册中心、istio控制面到envoy之间的桥梁作用：<br>1）监控服务注册中心(例如：k8s)的服务注册情况。k8s下会监控service、endpoint、pod、node等资源信息。<br>2）监控istio控制面信息变化，在k8s下，会监控routerule、virtualservice、Gateway、EgressRule、ServiceEntry等以k8s CRD形式存在的istio控制面配置信息。<br>3）将1）和2）的两类信息合并组合为envoy可以理解的xds配置信息，以gRPC协议提供给envoyAgent: pilot-agent，生成envoy配置文件，管理envoy生命周期：<br>1）生成envoy的配置<br>2）启动envoy<br>3) 监控和管理envoy的运行情况。</p><p>Citadel：<br>Istio的核心安全组件，负责服务的密钥和数字证书管理，用于提供自动生成、分发、轮换及撤销密钥和数据证书的功能。<br>Galley：<br>负责向Istio的其它组件提供支撑功能，可以理解为Istio的配置中心，它用于校验进入网络配置信息的格式内容正确性，并将这些配置信息提供给Pilot</p><h3 id="1-4-istio注入">1.4 istio注入</h3><p>不管是哪个k8s命名空间，或者是非kubernetes集群里的主机，只要被istio注入了，那么就在一个网络平面里了。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/2022-09-29-170348.png" class=""><h2 id="2-安装istio">2. 安装istio</h2><h3 id="2-1-安装istioctl">2.1 安装istioctl</h3><p>解压</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf istio-1.14.1-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>客户端工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> bin/istioctl /usr/local/bin/</span><br></pre></td></tr></table></figure><p>添加环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> &lt;(istioctl completion bash)</span><br></pre></td></tr></table></figure><h3 id="2-2-安装卸载">2.2 安装卸载</h3><p>查看可用的profile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl profile list</span><br></pre></td></tr></table></figure><p>安装demo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> profile=demo</span><br></pre></td></tr></table></figure><p>卸载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl x uninstall --purge</span><br></pre></td></tr></table></figure><h2 id="3-注入">3. 注入</h2><h3 id="3-1-手动注入">3.1 手动注入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl kube-inject -f pod1.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure><p>pod中会自动添加一个sidecar容器</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/2022-09-29-192059.png" class=""><h3 id="3-2-自动注入">3.2 自动注入</h3><p>以名称空间为最小单位，添加istio标签</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label ns ns1 istio-injection=enabled</span><br></pre></td></tr></table></figure><h2 id="4-安装观测工具">4. 安装观测工具</h2><p>安装kiali</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kiali.yaml </span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220929/istio-20220929-2-istio%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85/2022-09-29-200325.png" class="">]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubrnetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>24.审计</title>
      <link href="/20220926/kubernetes-20220926-24-%E5%AE%A1%E8%AE%A1/"/>
      <url>/20220926/kubernetes-20220926-24-%E5%AE%A1%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="1-启用审计">1. 启用审计</h2><p>添加配置</p><p>–audit-policy-file=/etc/kubernetes/logpolicy/audit.yaml<br>–audit-log-path=/var/log/0-audit.log</p><p>–audit-log-path 指定用来写入审计事件的日志文件路径。不指定此标志会禁用日志后端<br>–audit-log-maxage 定义了保留旧审计日志文件的最大天数<br>–audit-log-maxbackup 定义了要保留的审计日志文件的最大数量<br>–audit-log-maxsize 定义审计日志文件的最大大小（兆字节）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/kubernetes/logpolicy/audit.yaml</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">File</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/0-audit.log</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/logpolicy/audit.yaml</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">  <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/0-audit.log</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">  <span class="attr">readOnly:</span> <span class="string">fals</span></span><br></pre></td></tr></table></figure><h2 id="2-审计策略">2. 审计策略</h2><p>什么时候记<br>RequestReceived - 事件的 stage 将在审计处理器接收到请求后，并且在委托给其余处理器之前生成。<br>ResponseStarted - 在响应消息的头部发送后，但是响应消息体发送前。 这个阶段仅为长时间运行的请求生成（例如 watch）。<br>ResponseComplete - 当响应消息体完成并且没有更多数据需要传输的时候。<br>Panic - 当 panic 发生时生成。</p><p>记什么<br>None - 符合这条规则的日志将不会记录。<br>Metadata - 记录请求的元数据（请求的用户、时间戳、资源、动词等等）， 但是不记录请求或者响应的消息体。<br>Request - 记录事件的元数据和请求的消息体，但是不记录响应的消息体。 这不适用于非资源类型的请求。<br>RequestResponse - 记录事件的元数据，请求和响应的消息体。这不适用于非资源类型的请求</p><h2 id="3-创建策略">3. 创建策略</h2><p>从上往下开始匹配</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span> </span><br><span class="line"><span class="attr">omitStages:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;ResponseStarted&quot;</span> </span><br><span class="line"><span class="attr">rules:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span> </span><br><span class="line">    <span class="attr">resources:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span> </span><br><span class="line">    <span class="attr">groups:</span> [<span class="string">&quot;system:nodes&quot;</span>] </span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>] </span><br><span class="line">    <span class="attr">resources:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span> </span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>, <span class="string">&quot;services&quot;</span>,<span class="string">&quot;nodes&quot;</span>] </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span> </span><br><span class="line">    <span class="attr">groups:</span> [<span class="string">&quot;system:nodes&quot;</span>] </span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>] </span><br><span class="line">    <span class="attr">resources:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span> </span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>, <span class="string">&quot;services&quot;</span>] </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span> </span><br><span class="line">      <span class="attr">users:</span> [<span class="string">&quot;system:node:vms71&quot;</span>,<span class="string">&quot;system:node:vms72&quot;</span>] </span><br><span class="line">      <span class="attr">resources:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span> </span><br><span class="line">        <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>] </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span> </span><br><span class="line">        <span class="attr">resources:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span> </span><br><span class="line">          <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>23.供应链安全</title>
      <link href="/20220926/kubernetes-20220926-23-%E4%BE%9B%E5%BA%94%E9%93%BE%E5%AE%89%E5%85%A8/"/>
      <url>/20220926/kubernetes-20220926-23-%E4%BE%9B%E5%BA%94%E9%93%BE%E5%AE%89%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-准入控制器">1. 准入控制器</h2><p>其实就是kuberntes的功能控制，可以开启、关闭一些功能</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220926/kubernetes-20220926-23-%E4%BE%9B%E5%BA%94%E9%93%BE%E5%AE%89%E5%85%A8/2022-09-26-171242.png" class=""><p>查看支持的准入控制器<br>kubectl exec -it kube-apiserver-vms71 -n kube-system – kube-apiserver -h | grep enableadmission-plugins</p><p>可以关闭准入控制器</p><pre><code>#- --disable-admission-plugins=LimitRanger,ResourceQuot</code></pre><h3 id="1-1-资源限制">1.1 资源限制</h3><h4 id="1-1-1-限制svc">1.1.1 限制svc</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myrq</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure><h4 id="1-1-2-名称空间限制资源">1.1.2 名称空间限制资源</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-min-max-demo-lr</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure><h2 id="2-扫描镜像的安全">2. 扫描镜像的安全</h2><p>利用trivy检测镜像的安全性</p><p>扫描nginx镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@vms41:/etc/containerd<span class="comment"># trivy image nginx:latest</span></span><br><span class="line">2022-09-26T18:05:39.742+0800WARNYou should avoid using the :latest tag as it is cached. You need to specify <span class="string">&#x27;--clear-cache&#x27;</span> option when :latest image is changed</span><br><span class="line">2022-09-26T18:05:39.769+0800INFONeed to update DB</span><br><span class="line">2022-09-26T18:05:39.769+0800INFODownloading DB...</span><br><span class="line">29.62 MiB / 29.62 MiB [-----------------------------------------------------------------------------------------------------------------------------------------------------------------] 100.00% 4.87 MiB p/s 7s</span><br><span class="line">2022-09-26T18:06:09.560+0800INFODetecting Debian vulnerabilities...</span><br><span class="line">2022-09-26T18:06:09.568+0800INFOTrivy skips scanning programming language libraries because no supported file was detected</span><br><span class="line"></span><br><span class="line">nginx:latest (debian 11.5)</span><br><span class="line">==========================</span><br><span class="line">Total: 123 (UNKNOWN: 0, LOW: 13, MEDIUM: 63, HIGH: 42, CRITICAL: 5)</span><br><span class="line"></span><br><span class="line">+------------------+------------------+----------+-------------------------+------------------+-----------------------------------+--------------------------------------+</span><br><span class="line">|     LIBRARY      | VULNERABILITY ID | SEVERITY |    INSTALLED VERSION    |  FIXED VERSION   |               TITLE               |                 URL                  |</span><br><span class="line">+------------------+------------------+----------+-------------------------+------------------+-----------------------------------+--------------------------------------+</span><br><span class="line">| apt              | CVE-2011-3374    | LOW      | 2.2.4                   |                  | It was found that apt-key         | avd.aquasec.com/nvd/cve-2011-3374    |</span><br><span class="line">|                  |                  |          |                         |                  | <span class="keyword">in</span> apt, all versions, <span class="keyword">do</span> not      |                                      |</span><br><span class="line">|                  |                  |          |                         |                  | correctly...                      |                                      |</span><br><span class="line">+------------------+------------------+----------+-------------------------+------------------</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-扫描yum安全">3. 扫描yum安全</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/demo5<span class="comment"># ./kubesec scan ../demo4/pod3.yaml </span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;object&quot;</span>: <span class="string">&quot;Pod/pod3.default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;valid&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Passed with a score of 0 points&quot;</span>,</span><br><span class="line">    <span class="string">&quot;score&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;scoring&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;advise&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;selector&quot;</span>: <span class="string">&quot;.metadata .annotations .\&quot;container.apparmor.security.beta.kubernetes.io/nginx\&quot;&quot;</span>,</span><br><span class="line">          <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY&quot;</span>,</span><br><span class="line">          <span class="string">&quot;points&quot;</span>: 3</span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>22.最小化服务漏洞</title>
      <link href="/20220925/kubernetes-20220925-22-%E6%9C%80%E5%B0%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E/"/>
      <url>/20220925/kubernetes-20220925-22-%E6%9C%80%E5%B0%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-21">1. 简介</h2><p>利用kubernetes自带的一些功能及第三方的工具来提升kubernetes的安全性</p><h2 id="2-PSP">2. PSP</h2><p>pod安全策略</p><h3 id="2-1-启用psp">2.1 启用psp</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- --enable-admission-plugins=NodeRestriction,PodSecurityPolicy</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>一旦启用了PSP，且没有任何PSP规则的情况下，任何用户都不能再创建pod，包括管理员</p></div><h3 id="2-2-创建规则">2.2 创建规则</h3><h4 id="2-2-1-不允许创建特权pod">2.2.1 不允许创建特权pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>此时普通用户无法访问到psp，因此仍然无法创建pod</p></div><h4 id="2-2-2-创建权限">2.2.2 创建权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole crole2 --verb use --resource=psp --resource-name psp1</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding crolebind2 --clusterrole crole2 --user ren</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole psp-allow-kube-system --verb=use --resource=psp --resource-name=psp-allow-all</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding rolebind-allow-psp-kube-system --clusterrole=psp-allow-kube-system --group=system:serviceaccounts -n kube-system</span><br></pre></td></tr></table></figure><h4 id="2-2-2-允许使用宿主机网络空间">2.2.2 允许使用宿主机网络空间</h4><p>默认没写，不允许使用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3-只允许使用特定类型的卷">2.2.3 只允许使用特定类型的卷</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">projected</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4-hostPath限制宿主机目录">2.2.4 hostPath限制宿主机目录</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">projected</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPath:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/tmp&quot;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5-以特定用户运行pod">2.2.5 以特定用户运行pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">&#x27;MustRunAs&#x27;</span></span><br><span class="line">    <span class="attr">ranges:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">max:</span> <span class="number">1500</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">projected</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPath:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/tmp&quot;</span></span><br></pre></td></tr></table></figure><p>以普通用户运行pod容器进程</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod3</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms41.rhce.cc</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/centos</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-6-hostPorts范围限制">2.2.6 hostPorts范围限制</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostPorts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span> <span class="number">8880</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">&#x27;MustRunAs&#x27;</span></span><br><span class="line">    <span class="attr">ranges:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">max:</span> <span class="number">1500</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">projected</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPath:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/tmp&quot;</span></span><br></pre></td></tr></table></figure><h2 id="3-OPA">3. OPA</h2><p>Open Policy Agent<br>也是基于准入控制器–开发出来的一个功能，不是kubernetes自带的，而是第三方的，OPA并非只能用于kubernetes,可以用于很多地方，比如ssh，sudo，docker等</p><h3 id="3-1-OPA和docker整合">3.1 OPA和docker整合</h3><h4 id="3-1-1-创建策略目录">3.1.1 创建策略目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/docker/policies</span><br></pre></td></tr></table></figure><h4 id="3-1-2-安装策略插件">3.1.2 安装策略插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker plugin install openpolicyagent/opa-docker-authz-v2:0.4 opa-args=<span class="string">&quot;-policy-file /opa/policies/authz.rego&quot;</span></span><br></pre></td></tr></table></figure><h4 id="3-1-3-查看安装的插件">3.1.3 查看安装的插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:~<span class="comment">#  docker plugin list</span></span><br><span class="line">ID             NAME                                      DESCRIPTION                                     ENABLED</span><br><span class="line">a45c554aca67   openpolicyagent/opa-docker-authz-v2:0.4   A policy-enabled authorization plugin <span class="keyword">for</span> Do…   <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="3-1-4-启用opa">3.1.4 启用opa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:~<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://frz7i079.mirror.aliyuncs.com&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;authorization-plugins&quot;</span>: [<span class="string">&quot;openpolicyagent/opa-docker-authz-v2:0.4&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-5-创建rego规则">3.1.5 创建rego规则</h4><p>官方文档：<a href="https://www.openpolicyagent.org/docs/latest/docker-authorization/">https://www.openpolicyagent.org/docs/latest/docker-authorization/</a></p><h5 id="3-1-5-1-创建策略">3.1.5.1 创建策略</h5><p>拒绝开启所有系统调用<br>拒绝创建特权容器</p><p>cat /etc/docker/policies/authz.rego</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package docker.authz</span><br><span class="line"></span><br><span class="line">default allow = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  not deny</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deny &#123;</span><br><span class="line">  seccomp_unconfined</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">seccomp_unconfined &#123;</span><br><span class="line">  input.Body.HostConfig.SecurityOpt[_] == <span class="string">&quot;seccomp=unconfined&quot;</span></span><br><span class="line">  input.Body.HostConfig.Privileged == <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>input.Body是固定的,后面的是docker inspect 查看到的</p></div><h5 id="3-1-5-1-登录用户策略">3.1.5.1 登录用户策略</h5><p>限制harbor登录用户</p><p>bob用户只读权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:~<span class="comment"># cat /etc/docker/policies/authz.rego</span></span><br><span class="line">package docker.authz</span><br><span class="line">default allow = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  user_id := input.Headers[<span class="string">&quot;Authz-User&quot;</span>]</span><br><span class="line">  user := <span class="built_in">users</span>[user_id]</span><br><span class="line">  not user.readOnly</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  user_id := input.Headers[<span class="string">&quot;Authz-User&quot;</span>]</span><br><span class="line">  <span class="built_in">users</span>[user_id].readOnly</span><br><span class="line">  input.Method == <span class="string">&quot;GET&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">users</span> = &#123;</span><br><span class="line">  <span class="string">&quot;bob&quot;</span>: &#123;<span class="string">&quot;readOnly&quot;</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  <span class="string">&quot;alice&quot;</span>: &#123;<span class="string">&quot;readOnly&quot;</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-kubernetes中使用OPA">3.1 kubernetes中使用OPA</h3><p>gatekeeper项目是Kubernetes基于OPA的实现。gatekeeper允许我们以Kubernetes本机方式使用OPA来实施所需的策略<br>安装gatekeeper之后，<a href="http://xn--constrainttemplates-ks24ao46x1v4d.templates.gatekeeper.sh">会生成constrainttemplates.templates.gatekeeper.sh</a> 这个CRD<br>然后利用这个CRD 可以创建template<br>然后创建constraint</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220925/kubernetes-20220925-22-%E6%9C%80%E5%B0%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E/2022-09-26-133400.png" class=""><p>下载：<a href="https://github.com/open-policy-agent/gatekeeper/tree/master/deploy">https://github.com/open-policy-agent/gatekeeper/tree/master/deploy</a></p><h4 id="3-1-1-安装gatekeeper">3.1.1 安装gatekeeper</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f gatekeeper.yaml</span><br></pre></td></tr></table></figure><h4 id="3-1-2-查看crd">3.1.2 查看crd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/gatekeeper<span class="comment"># kubectl get crd|grep gatekeeper</span></span><br><span class="line">configs.config.gatekeeper.sh                          2022-09-26T05:38:20Z</span><br><span class="line">constraintpodstatuses.status.gatekeeper.sh            2022-09-26T05:38:20Z</span><br><span class="line">constrainttemplatepodstatuses.status.gatekeeper.sh    2022-09-26T05:38:20Z</span><br><span class="line">constrainttemplates.templates.gatekeeper.sh           2022-09-26T05:38:20Z</span><br><span class="line">providers.externaldata.gatekeeper.sh                  2022-09-26T05:38:20Z</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-1-3-自定义资源类型">3.1.3 自定义资源类型</h4><h4 id="3-1-3-1-拒绝特定镜像">3.1.3.1 拒绝特定镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: templates.gatekeeper.sh/v1beta1</span><br><span class="line">kind: ConstraintTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: blacklistimages</span><br><span class="line">spec:</span><br><span class="line">  crd:</span><br><span class="line">    spec:</span><br><span class="line">      names:</span><br><span class="line">        kind: BlacklistImages</span><br><span class="line">  targets:</span><br><span class="line">  - rego: |</span><br><span class="line">      package k8strustedimages</span><br><span class="line"></span><br><span class="line">      images &#123;</span><br><span class="line">        image := input.review.object.spec.containers[_].image</span><br><span class="line">        not startswith(image, <span class="string">&quot;docker-fake.io/&quot;</span>)</span><br><span class="line">        not startswith(image, <span class="string">&quot;google-gcr-fake.com/&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      violation[&#123;<span class="string">&quot;msg&quot;</span>: msg&#125;] &#123;</span><br><span class="line">        not images</span><br><span class="line">        msg := <span class="string">&quot;not trusted image!&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    target: admission.k8s.gatekeeper.sh</span><br></pre></td></tr></table></figure><h4 id="3-1-3-2-创建资源">3.1.3.2 创建资源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f gatekeeper-tmp.yaml </span><br></pre></td></tr></table></figure><h4 id="3-1-3-3-查看crd">3.1.3.3 查看crd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/gatekeeper<span class="comment"># kubectl get crd|grep blacklistimages</span></span><br><span class="line">blacklistimages.constraints.gatekeeper.sh             2022-09-26T05:51:28</span><br></pre></td></tr></table></figure><h4 id="3-1-3-4-创建资源类型对象">3.1.3.4 创建资源类型对象</h4><p>应用到pod上</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">BlacklistImages</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-trusted-images</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;14449&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure><h2 id="4-沙箱">4. 沙箱</h2><p>容器化部署，即使宿主机里没有安装mysql、启动mysql，但是在宿主机里仍然能够看到mysqld的进程，为了安全性，在宿主机里能否隔离容器里运行的容器</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220925/kubernetes-20220925-22-%E6%9C%80%E5%B0%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E/2022-09-26-151743.png" class=""><h3 id="4-1-gvisor运行时">4.1 gvisor运行时</h3><p>下载： <a href="https://gvisor.dev/docs/user_guide/install">https://gvisor.dev/docs/user_guide/install</a></p><p>gvisor运行时沙箱运行容器，宿主机看不到相关进程</p><h4 id="4-1-1-安装">4.1.1 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/usr/local/bin<span class="comment"># ./runsc  install</span></span><br><span class="line">2022/09/26 15:24:07 Added runtime <span class="string">&quot;runsc&quot;</span> with arguments [] to <span class="string">&quot;/etc/docker/daemon.json&quot;</span>.</span><br></pre></td></tr></table></figure><h4 id="4-1-2-重启docker">4.1.2 重启docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h4 id="4-1-3-创建容器">4.1.3 创建容器</h4><p>指定运行时</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name=web1 --restart=always --runtime=runsc nginx</span><br></pre></td></tr></table></figure><h4 id="4-1-4-宿主机查看进程">4.1.4 宿主机查看进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/usr/local/bin<span class="comment"># ps -ef |grep nginx</span></span><br><span class="line">root      14442 115329  0 15:29 pts/2    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure><h4 id="4-1-5-containerd中使用gvisor运行时">4.1.5 containerd中使用gvisor运行时</h4><h4 id="4-1-5-1-安装运行时">4.1.5.1 安装运行时</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/containerd-shim-runsc-v1</span><br></pre></td></tr></table></figure><h4 id="4-1-5-2-添加配置">4.1.5.2 添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes]</span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc]</span><br><span class="line">    base_runtime_spec = <span class="string">&quot;&quot;</span></span><br><span class="line">    cni_conf_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">    cni_max_conf_num = 0</span><br><span class="line">    container_annotations = []</span><br><span class="line">    pod_annotations = []</span><br><span class="line">    privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">    runtime_engine = <span class="string">&quot;&quot;</span></span><br><span class="line">    runtime_path = <span class="string">&quot;&quot;</span></span><br><span class="line">    runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">    runtime_type = <span class="string">&quot;io.containerd.runc.v2&quot;</span></span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">      SystemdCgroup = <span class="literal">true</span></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runsc]</span><br><span class="line">    runtime_type = <span class="string">&quot;io.containerd.runsc.v1&quot;</span></span><br></pre></td></tr></table></figure><h4 id="4-1-5-3-重启containerd">4.1.5.3 重启containerd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h4 id="4-1-5-4-查看info">4.1.5.4 查看info</h4><p>crictl info 查看已经有2个运行时</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;runtimes&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;runc&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;runtimeType&quot;</span>: <span class="string">&quot;io.containerd.runc.v2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;runtimePath&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;runtimeEngine&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;PodAnnotations&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;ContainerAnnotations&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;runtimeRoot&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;SystemdCgroup&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;privileged_without_host_devices&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;baseRuntimeSpec&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cniConfDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cniMaxConfNum&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;runsc&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;runtimeType&quot;</span>: <span class="string">&quot;io.containerd.runsc.v1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;runtimePath&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;runtimeEngine&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;PodAnnotations&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;ContainerAnnotations&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;runtimeRoot&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;options&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;privileged_without_host_devices&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;baseRuntimeSpec&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cniConfDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cniMaxConfNum&quot;</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="4-1-5-5-创建容器">4.1.5.5 创建容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=web1 --restart=always --runtime=runsc nginx</span><br></pre></td></tr></table></figure><h4 id="4-1-5-6-宿主机查看">4.1.5.6 宿主机查看</h4><p>宿主机是没有nginx进程的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep nginx</span><br></pre></td></tr></table></figure><h3 id="4-1-kata运行时">4.1 kata运行时</h3><p>使用kata创建出来的已经不是容器了，而是一个传统上虚拟机–kvm  胖pod<br>kvm–硬件辅助虚拟化，必须开启cpu的虚拟化功能</p><h3 id="4-1-在k8s里配置gvisor">4.1 在k8s里配置gvisor</h3><h4 id="4-1-1-修改containerd配置">4.1.1 修改containerd配置</h4><p>修改 /etc/containerd/config.toml<br>[plugins.“io.containerd.grpc.v1.cri”.containerd.runtimes]<br>[plugins.“io.containerd.grpc.v1.cri”.containerd.runtimes.runc]<br>runtime_type = “io.containerd.runc.v2”<br>在此条目下已经有了runc的配置，添加runsc的配置<br>[plugins.“io.containerd.grpc.v1.cri”.containerd.runtimes.runsc]<br>runtime_type = “io.containerd.runsc.v1”<br>此时containerd上支持了两种runtime，分别是runc和run</p><h4 id="4-1-2-修改kubelet参数，让其支持runsc作为runtime">4.1.2 修改kubelet参数，让其支持runsc作为runtime</h4><p>cat &gt; /etc/systemd/system/kubelet.service.d/0-cri-containerd.conf &lt;&lt;EOF<br>[Service]<br>Environment=“KUBELET_EXTRA_ARGS=–container-runtime=remote --runtime-request-timeout=15m<br>–container-runtime-endpoint=unix:///run/containerd/containerd.sock”<br>EOF</p><h4 id="4-1-3-创建runtimeClass">4.1.3 创建runtimeClass</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">rc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myclass</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">runsc</span> <span class="comment"># 对应的 CRI 配置的名称</span></span><br></pre></td></tr></table></figure><h4 id="4-1-4-创建pod">4.1.4 创建pod</h4><p>指定runc</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">runtimeClassName:</span> <span class="string">myclass</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms73.rhce.cc</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>21.系统强化</title>
      <link href="/20220925/kubernetes-20220925-21-%E7%B3%BB%E7%BB%9F%E5%BC%BA%E5%8C%96/"/>
      <url>/20220925/kubernetes-20220925-21-%E7%B3%BB%E7%BB%9F%E5%BC%BA%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-20">1. 简介</h2><p>Linux内核会根据需要从磁盘自动加载内核模块<br>与Kubernetes特别相关的是，即使没有特权的进程也可以通过创建适当类型的套接字来加载某些与网络协议相关的内核模块。<br>这可能使攻击者利用管理员认为未使用的内核模块中的安全漏洞。</p><h2 id="2-最小权限原则（POLP）">2. 最小权限原则（POLP）</h2><p>POLP principle of least privilege 够用就行，不用多给权限</p><p>提高安全性<br>降低被攻击面<br>增强系统稳定性</p><p>权限审核—确保所有用户只有能完成本职工作的权限<br>设置所有用户最低权限—根据需要提权<br>权限分离—管理员和普通用户</p><h2 id="3-apparmor">3. apparmor</h2><p>类似于centos、rhel系统里的selinux，主要作用是设置哪些进程能够访问哪些文件，不能访问哪些文件</p><h3 id="3-1-安装">3.1 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install apparmor-profiles apparmor-utils</span><br></pre></td></tr></table></figure><p><strong>规则目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/apparmor.d/</span><br></pre></td></tr></table></figure><h3 id="3-2-编写规则">3.2 编写规则</h3><p>对于apparmor来说，规则文件有几种类型：</p><h4 id="3-2-1-标准配置文件">3.2.1 标准配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;tunables/global&gt;</span><br><span class="line">/usr/sbin/nginx flags=(模式标志 相对标志 附加标志) &#123;</span><br><span class="line">...规则...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一行是#include表示加载其他的规则文件，&lt;&gt;里的内容指的是/etc/apparmor.d里的子目录里的文件，比如这里trunables/global，指的是加载/etc/apparmor.d/tunables/global这个文件，除了#include前面的#必须要加之外，其他的#开始的都是注释。<br>在下面的打括号里，也可以通过#include加载其他的文件</p><p>这里还有一个flags=,在编写apparmor规则文件的时候，需要使用到标志，含有三种类型的标志：模式标志，相对标志，附加标志。每种标志在flags里的顺序不重要，在flags里写的是标志列表：</p><ul><li>模式标志的值有<br>enforce – 不能写入在flags里，不写就是enforce<br>complain – 允许</li><li>相对标志的值有<br>chroot_relative<br>namespace_relative</li><li>附加标志的值有<br>attach_disconnected<br>no_attach_disconnected<br>上面两个值互斥<br>chroot_attach<br>chroot_no_attach<br>上面两个值互斥</li></ul><p>如果在flags里没有指定标志的话，默认是enforce,namespace_relative,no_attach_disconnected,chroot_no_attach</p><h4 id="3-2-2-未关联的配置文件">3.2.2 未关联的配置文件</h4><p>用于手动指定到需要限制的程序</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">profile profile1 &#123;</span><br><span class="line">#include &lt;abstractions/base&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-生成配置">3.3 生成配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aa-autodep nginx</span><br></pre></td></tr></table></figure><p>生成的是标准的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/etc/apparmor.d<span class="comment"># cat usr.sbin.nginx </span></span><br><span class="line"><span class="comment"># Last Modified: Sun Sep 25 19:18:44 2022</span></span><br><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/nginx flags=(complain) &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line"></span><br><span class="line">  /lib/x86_64-linux-gnu/ld-*.so mr,</span><br><span class="line">  /usr/sbin/nginx mr,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p><strong>了解规则文件的结构</strong><br>上面/usr/sbin/nginx指的是下面的规则是用于限制此程序的。complain模式</p></div><h4 id="3-3-1-设置enforce模式">3.3.1 设置enforce模式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aa-enforce nginx</span><br><span class="line">aa-logprof</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/etc/apparmor.d<span class="comment"># cat usr.sbin.nginx </span></span><br><span class="line"><span class="comment"># Last Modified: Sun Sep 25 19:36:40 2022</span></span><br><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/nginx &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  <span class="comment">#include &lt;abstractions/lxc/container-base&gt;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>在规则文件里没有了complain字样</p></div><h4 id="3-3-2-拒绝访问">3.3.2 拒绝访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/etc/apparmor.d<span class="comment"># cat usr.sbin.nginx</span></span><br><span class="line"><span class="comment"># Last Modified: Sun Sep 25 19:36:40 2022</span></span><br><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/nginx &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  <span class="comment">#include &lt;abstractions/lxc/container-base&gt;</span></span><br><span class="line">  deny /data/www/deny/* r,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里增加了一句deny /data/www/deny/* r, 意思是拒绝nginx进程读目录/data/www/deny/里的东西<br>这里的语法是<br>deny /path/file 权限1 权限2 权限3… 这里是拒绝程序对/path/file使用权限1权限2权限3…<br>allow path/file 权限1 权限2 权限3… 这里是允许程序对/path/file使用权限1权限2权限3…<br>如果没有写allow的话，默认就是allow，所以可以写成/path/file 权限1 权限2 权限3…</p><p>每行最后面要以逗号结束。常见的权限有：<br>r 读<br>w 写 和a互斥<br>a 追加写，和w互斥<br>x 可执行，但是单写x的话，只能在deny的后面写，在allow里不能独立用x，必须要ix，ux等组合使用<br>ix 继承执行<br>m 允许PROT_EXEC与mmap(2)调用<br>k 锁定，如果应用程序有权限访问文件，apparmor便允许锁定文件</p></div><h4 id="3-3-3-重读配置">3.3.3 重读配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apparmor_parser -r /etc/apparmor.d/usr.sbin.nginx</span><br></pre></td></tr></table></figure><h3 id="3-4-k8s环境里使用">3.4 k8s环境里使用</h3><p>在k8s环境里，使用apparmor只是对特定的pod做限制，并非限制worker节点上的某个进程，所以创建未关联的配置文件。</p><h4 id="3-4-1-先查看是否存在名字叫profile1的配置">3.4.1 先查看是否存在名字叫profile1的配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apparmor_status |grep profile1</span><br></pre></td></tr></table></figure><h4 id="3-4-2-创建一个配置">3.4.2 创建一个配置</h4><h5 id="3-4-2-1-允许特定文件">3.4.2.1 允许特定文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@node-0:/etc/apparmor.d<span class="comment"># cat aa.conf </span></span><br><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line">profile profile1 &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  <span class="comment">#include &lt;abstractions/bash&gt;</span></span><br><span class="line">  file,</span><br><span class="line">  allow /usr/bin/sleep rwix,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里是定义给未关联的配置文件，名字叫做 profile1，此文件里只加载了abstractions/base，基本上是不允许任何程序运行，然后添加此规则。</p></div><h5 id="3-4-2-2-拒绝目录">3.4.2.2 拒绝目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line">profile profile1 flags=(attach_disconnected) &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  file,</span><br><span class="line">  deny /tmp/ r, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这种写法是拒绝对/tmp 这个目录本身进行读取访问，但不影响读取此目录里的内容。注意这里/tmp/后面要带&quot;/“，写作”/tmp/&quot; 不能写成&quot;/tmp&quot;否则 deny 条目不生效。</p><p>这里可以看到是没法获取/tmp 目录里的内容，但是不影响读取访问/tmp 里子目录以及查看/tmp 里文件的内容的。</p></div><h5 id="3-4-2-3-拒绝文件">3.4.2.3 拒绝文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line">profile profile1 flags=(attach_disconnected) &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  file, </span><br><span class="line">  deny /tmp/* r, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里写成 deny /tmp/* r, 意思是拒绝读取/tmp 目录里的文件，但不影响访问/tmp 目录本身，也不影响访问/tmp 里子目录里的文件。</p><p>这里可以正常访问/tmp 里的内容，也能读取目录/tmp/xx 里的数据，能够查看/tmp/xx/xx.txt 的内容，但是没法访问/tmp/aa.txt。</p></div><h5 id="3-4-2-4-递归拒绝">3.4.2.4 递归拒绝</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line">profile profile1 flags=(attach_disconnected) &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  file, </span><br><span class="line">  deny /tmp/** r, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里写成 deny /tmp/** r, 意思是拒绝读取/tmp 目录里的文件以及/tmp 里子目录里的文件，但不影响访问/tmp 目录本身。</p><p>这里可以正常访问/tmp 里的内容，但是已经读取不到目录/tmp/xx 里的数据，也不能够查看/tmp/xx/xx.txt 的内容，也没法访问/tmp/aa.txt</p></div><h4 id="3-4-3-安装配置">3.4.3 安装配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apparmor_parser -q /etc/apparmor.d/aa.conf </span><br></pre></td></tr></table></figure><h3 id="3-4-4-创建pod">3.4.4 创建pod</h3><p>添加annotations应用配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@vms40:~/demo3#</span> <span class="string">cat</span> <span class="string">pod3.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod3</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">container.apparmor.security.beta.kubernetes.io/pod3:</span> <span class="string">localhost/profile1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms41.rhce.cc</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/centos</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>这里在 pod3 里添加了<br>annotations:<br>  <a href="http://container.apparmor.security.beta.kubernetes.io/pod3:">container.apparmor.security.beta.kubernetes.io/pod3:</a> localhost/profile1<br>这里的 pod1 是容器名，必须要和下面 containers 里定义的容器的名字保持一致，最后的 localhost/profile1 指的是此 pod 所在机器（localhost)上的 profile1 规则</p></div><h2 id="4-seccomp">4. seccomp</h2><p>seccomp（全称secure computing mode 安全计算模式）<br>是linux kernel从2.6.23版本开始所支持的一种安全机制。</p><p>在Linux系统里，大量的系统调用（systemcall）直接暴露给用户态程序。但是，并不是所有的系统调用都被需要，而且不安全的代码滥用系统调用会对系统造成安全威胁。通过seccomp，我们限制程序使用某些系统调用，这样可以减少系统的暴露面，同时是程序进入一种“安全”的状态。</p><h3 id="4-1-系统调用">4.1 系统调用</h3><p>简单执行cat查看系统调用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/demo3<span class="comment"># strace -fqc cat /etc/issue</span></span><br><span class="line">Ubuntu 18.04.5 LTS \n \l</span><br><span class="line"></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">  0.00    0.000000           0         3           <span class="built_in">read</span></span><br><span class="line">  0.00    0.000000           0         1           write</span><br><span class="line">  0.00    0.000000           0         6           close</span><br><span class="line">  0.00    0.000000           0         5           fstat</span><br><span class="line">  0.00    0.000000           0         7           mmap</span><br><span class="line">  0.00    0.000000           0         4           mprotect</span><br><span class="line">  0.00    0.000000           0         2           munmap</span><br><span class="line">  0.00    0.000000           0         3           brk</span><br><span class="line">  0.00    0.000000           0         3         3 access</span><br><span class="line">  0.00    0.000000           0         1           execve</span><br><span class="line">  0.00    0.000000           0         1           arch_prctl</span><br><span class="line">  0.00    0.000000           0         1           fadvise64</span><br><span class="line">  0.00    0.000000           0         4           openat</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.000000                    41         3 total</span><br></pre></td></tr></table></figure><h3 id="4-2-限制系统调用">4.2 限制系统调用</h3><p>SCMP_ACT_KILL：当进程进行对应的系统调用时，内核发出SIGSYS信号终止该进程，该进程不会接受到这个信号<br>SCMP_ACT_TRAP：当进程进行对应的系统调用时，该进程会接收到SIGSYS信号，并改变自身行为<br>SCMP_ACT_ERRNO：当进程进行对应的系统调用时，系统调用失败，进程会接收到errno返回值<br>SCMP_ACT_TRACE：当进程进行对应的系统调用时，进程会被跟踪<br>SCMP_ACT_ALLOW：允许进程进行对应的系统调用行为<br>SCMP_ACT_LOG：记录所有信息</p><p><strong>查看内容是否支持</strong><br>grep CONFIG_SECCOMP= /boot/config-$(uname -r)</p><h3 id="4-3-编写规则">4.3 编写规则</h3><p><a href="https://docs.docker.com/engine/security/seccomp/">https://docs.docker.com/engine/security/seccomp/</a><br>docker容器中默认禁用了44个系统调用</p><p>默认的配置<br><a href="https://raw.githubusercontent.com/moby/moby/master/profiles/seccomp/default.json">https://raw.githubusercontent.com/moby/moby/master/profiles/seccomp/default.json</a></p><h4 id="4-3-1-允许所有调用">4.3.1 允许所有调用</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat aa1.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;defaultAction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_ACT_ALLOW&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="4-3-2-拒绝所有调用">4.3.2 拒绝所有调用</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat bb.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;defaultAction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_ACT_ERRNO&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="4-3-3-自定义调用规则">4.3.3 自定义调用规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --security-opt seccomp=./aa1.json hello-word</span><br><span class="line"></span><br><span class="line">等同于unconfined（允许所有）</span><br><span class="line">docker run -it --<span class="built_in">rm</span> --name=c1 --security-opt seccomp=unconfined hello-world</span><br></pre></td></tr></table></figure><h4 id="4-3-4-sysdig">4.3.4 sysdig</h4><p>使用sysdig监测容器，看看使用了哪些系统调用</p><h5 id="4-3-4-1-安装sysdig">4.3.4.1 安装sysdig</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public | sudo apt-key add -</span><br><span class="line">sudo curl -s -o /etc/apt/sources.list.d/draios.list</span><br><span class="line">https://s3.amazonaws.com/download.draios.com/stable/deb/draios.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install linux-headers-$(<span class="built_in">uname</span> -r)</span><br><span class="line">sudo apt-get -y install sysd</span><br></pre></td></tr></table></figure><p><strong>以容器方式运行</strong><br>docker run -i -dt --name sysdig --restart=always --privileged -v /var/run/docker.sock:/host/var/run/docker.sock -v<br>/dev:/host/dev -v /proc:/host/proc:ro -v /boot:/host/boot:ro -v /lib/modules:/host/lib/modules:ro -v<br>/usr:/host/usr:ro sysdig/sysdig<br>alias xxx='docker exec -it sysdig sysdi</p><h5 id="4-3-4-2-sysdig使用">4.3.4.2 sysdig使用</h5><pre><code>sysdig -p &quot;*%evt.time,%proc.name,%evt.type&quot; container.id=5c9431eb8723</code></pre><p>evt.num： 递增的事件号<br>evt.time： 事件发生的时间<br>evt.cpu： 事件被捕获时所在的 CPU，也就是系统调用是在哪个 CPU 执行的。比较上面的例子中，值 0 代表机器的第一个 CPU<br><a href="http://proc.name">proc.name</a>： 生成事件的进程名字，也就是哪个进程在运行<br>thread.tid： 线程的 id，如果是单线程的程序，这也是进程的 pid<br>evt.dir： 事件的方向（direction），&gt; 代表进入事件，&lt; 代表退出事件<br>evt.type： 事件的名称，比如 open、stat等，一般是系统调用<br>evt.args： 事件的参数。如果是系统调用，这些对应着系统调用的参数</p><h4 id="4-3-5-k8s中使用seccomp">4.3.5 k8s中使用seccomp</h4><p>官网文档：<a href="https://kubernetes.io/docs/tutorials/security/seccomp/">https://kubernetes.io/docs/tutorials/security/seccomp/</a></p><h5 id="4-3-5-1-创建规则">4.3.5.1 创建规则</h5><p>存放规则的目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/lib/kubelet/seccomp/</span><br></pre></td></tr></table></figure><p>创建规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@vms41:/var/lib/kubelet/seccomp<span class="comment"># cat aa.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;defaultAction&quot;</span>: <span class="string">&quot;SCMP_ACT_LOG&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-3-5-2-创建pod">4.3.5.2 创建pod</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">audit-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">audit-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">seccompProfile:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Localhost</span></span><br><span class="line">      <span class="attr">localhostProfile:</span> <span class="string">aa.json</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hashicorp/http-echo:0.2.3</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-text=just made some syscalls!&quot;</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>20.mTLS</title>
      <link href="/20220922/kubernetes-20220922-20-mTLS/"/>
      <url>/20220922/kubernetes-20220922-20-mTLS/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-19">1. 简介</h2><p>两台主机通信的时候，如果是通过明文的方式通信两者之间的数据很容易被截获，两台主机要安全通信，需要在两者之间实现数据的加密。主要涉及到对称加密，非对称加密，哈希函数。</p><h2 id="2-对称加密">2. 对称加密</h2><p>所谓对称加密，即加密和解密使用相同的密钥，这个密钥可以理解为就是密码。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550238917.png" class=""><p>这里A用一个对称加密密钥haha001加密了一个数据，然后把加密之后的数据发送给B之后，因为是加密数据，所以B是打不开的。所以A需要把密码告诉B才行。但是如何告诉B密钥是haha001呢？这是一个问题，因为这个过程很可能被别人监测到。</p><h2 id="3-非对称加密">3. 非对称加密</h2><p>对于非对称加密算法来说，包括2个密钥一个是公钥，一个是私钥。公钥是可以公开的，私钥需要保护好。对于非对称加密来说主要作用有两个，一是数据加密，而是数字签名。</p><h3 id="3-1数据加密">3.1数据加密</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550269579.png" class=""><p>上图里锁的图标表示公钥，钥匙的图标表示私钥。</p><ul><li>第一步：B把公钥发送给A</li><li>第二步：A用B的公钥加密数据</li><li>第三步：A把加密后的数据发送给B</li><li>第四步：B用自己的私钥对加密数据进行解密</li></ul><p>因为别人获取不到B的私钥，所以在第三步里即便数据被接获了也解密不了，因为只有B的私钥才能解密。</p><p>如果把对称加密和非对称加密结合使用的话，这样利用非对称加密就可以解决了前面对称加密算法中，对称加密私钥不方便传输的问题了。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550288439.png" class=""><ul><li>第一步： B把公钥发送给A</li><li>第二步：A用B的公钥加密对称加密密钥haha001</li><li>第三步：A把加密后的密钥发送给B</li><li>第四步：B用自己的私钥解密A发送过来的数据，得到对称加密的密钥haha001</li><li>第五步：B用haha001解密A发送过来的对称加密数据</li></ul><p>这样A用对称加密的数据发送给B之后，B也能顺利的打开了，这种方式看起来安全，但其实很容易受到中间人攻击，因为第一步里我们假设的是A获取的就是B的公钥，而不是别人冒充的。</p><p>下面我们看一下中间人攻击的过程，这里假设C是中间人</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550312207.png" class=""><ul><li>第一步：B把公钥发送给A，但C把原本发送给A的公钥截获了，此时C有了B的公钥。</li><li>第二步：C把自己的公钥发送给A，但是宣称是“B的公钥”，A不明真相，以为就是B的公钥</li><li>第三步：A用“B的公钥”（其实是C的公钥）加密对称加密的密钥</li><li>第四步：把加密后的对称加密的密钥发送给B，但是这个又被C截获了，因为实际用的是C的公钥加密的，所以C用自己的私钥是能够解密的。此时C获取了对称加密的密钥haha001</li><li>第五步：C用B的公钥加密对称加密密钥haha001，之后发送给B</li><li>第六步：B用自己的私钥解密数据，得到对称密钥haha001</li><li>第七步：A把用对称加密后的护具发送给B，但也被C截获了，因为C知道了对称加密密钥，所以C是能看到数据里的内容并做修改的。</li><li>第八步：C再次用对称密钥haha001加密数据之后转发给B</li><li>第九步：B用对称密钥haha001解密数据</li></ul><p>整个过程A和B都以为他们是直接通信的，殊不知这中间所有的数据都被C看到了，这就是中间人攻击。<br>那么如何解决这个问题呢？我们先了解数字签名。</p><h2 id="4-数字签名">4. 数字签名</h2><p>数字签名是私钥加密数据，公钥解密数据。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550339488.png" class=""><ul><li>第一步：B先把公钥发送给A</li><li>第二步：B然后用哈希函数对所要传输的数据求的哈希值hash1，哈希函数的特点是输入不定长的值总是得到定长的值，比如：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@vms61:~<span class="comment"># wc -c /etc/hosts</span></span><br><span class="line">291 /etc/hosts</span><br><span class="line">root@vms61:~<span class="comment"># wc -c /etc/services </span></span><br><span class="line">19183 /etc/services</span><br><span class="line">root@vms61:~<span class="comment"># </span></span><br><span class="line">root@vms61:~<span class="comment"># </span></span><br><span class="line">root@vms61:~<span class="comment"># md5sum /etc/hosts</span></span><br><span class="line">219ebb29a192b6e41af2dc98865df58e  /etc/hosts</span><br><span class="line">root@vms61:~<span class="comment"># md5sum /etc/services </span></span><br><span class="line">567c100888518c1163b3462993de7d47  /etc/services</span><br><span class="line">root@vms61:~<span class="comment">#</span></span><br></pre></td></tr></table></figure><ul><li>第三步：B会用自己的私钥对哈希值hash1进行加密</li><li>第四步：B把原始数据和加密后的哈希值发送给A</li><li>第五步：A先用B的公钥把收到的加密后的哈希值hash1解密，得到hash1，这个hash1和第2步生成hash1是一样的。</li><li>第六步：B会对收到的数据data求得哈希值hash2</li><li>第七步：B对比hash1和hash2来判断data在传输过程中是不是被修改过。如果两个hash值是一样的，就说明数据data在传输过程中是没有被修改的，如果两个哈希值不一样说明数据传输过程中被修改过。</li></ul><p>这里会带来两个问题：</p><ul><li>第一：这里也会遇到中间人攻击的问题，即第一步的公钥被C截获了，然后把自己的公钥发送给了A。在第四步里，数据data和hash1被C截获，然后C修改了data的数据，然后求得哈希值之后用自己的私钥做数据签名。其实所有的中间人攻击的根本在于此。</li><li>第二：即使没有中间人攻击，B的密钥对跟B这个主体之间没有必然的联系，因为B可以随时删除掉自己的密钥对，然后重新生成。</li></ul><h2 id="5-证书中心">5. 证书中心</h2><p>在互联网上存在一种权威机构叫做证书中心（简称CA），一个前提就是我们都要信任CA。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/image-1653550378823.png" class=""><p>前面讲中间人攻击的主要原因就是A获取B的公钥可能是假冒的，所以A不会信任别人发给他的公钥，且B也知道他直接把他自己生成的公钥发送给别人，别人也不信任，所以B不会再生成私钥了。</p><ul><li>第一步：B会用自己的私钥生成一个证书请求文件（类似于申请书）</li><li>第二步：B把证书请求文件发送到CA去申请证书。</li><li>第三步：CA会审核B的身份，之后会颁发证书给B，这个证书其实就是公钥，只是上面有了CA的数字签名，以证明这个证书是CA颁发的。这一步解决了”数字签名“部分B和他的密钥对之间每有必然联系的问题，因为这里有CA来证明这个密钥对就是B的，B不能抵赖。</li><li>第四步：B会把证书发送给A，说这是我的证书并且上面有CA的数字签名，不会被别人伪冒。</li><li>第五步：A是持怀疑态度的，到底是不是真的由CA颁发的，还是别人伪冒的呢？所以A要验证这个证书的真伪性。此时A需要CA的公钥（像浏览器里都内置了权威CA的公钥），然后会用权威CA的公钥验证B证书的公钥上的数字签名。</li></ul><p>之后，A会用B的证书加密对称加密算法的密钥发送给B，B用私钥解密，这样A和B就可以安全的传输数据了，整个过程叫做TLS（传输层安全）<br>这里只有A验证了B的证书合法性，所以叫做单向TLS，如果A也有自己的私钥及CA颁发的证书，那么除了A要验证B证书的合法性之外，B也要验证A证书的合法性，即两边互相验证，这个就叫做mTLS（mutual TLS，双向TLS）了。</p><h2 id="6-k8s里的mTLS">6. k8s里的mTLS</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/2022-09-23-120031.png" class=""><p>kubeadm方式部署，创建2个CA中心，kubernetes组件一个，etcd组件一个。组件签发证书为1年，CA证书为10年。</p><h3 id="6-1-验证tls">6.1 验证tls</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 10</span><br><span class="line"><span class="built_in">cat</span> bb.csv</span><br><span class="line">56247b326b6e5bf83198,admin2,3</span><br><span class="line"></span><br><span class="line">- --token-auth-file=/etc/kubernetes/pki/bb.csv</span><br><span class="line"></span><br><span class="line">kubectl -s=<span class="string">&quot;https://192.168.26.51:6443&quot;</span> --insecure-skip-tls-verify=<span class="literal">true</span> --token=<span class="string">&quot;56247b326b6e5bf83198&quot;</span> get pods -n kube-system</span><br></pre></td></tr></table></figure><h2 id="7-cfssl工具签发私有证书">7. cfssl工具签发私有证书</h2><p>下载地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -OL https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">curl -OL https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">curl -OL https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br></pre></td></tr></table></figure><p>修改文件名权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> * ; <span class="keyword">do</span> n=<span class="variable">$&#123;i%_*&#125;</span> ; <span class="built_in">mv</span> <span class="variable">$i</span> <span class="variable">$n</span>; <span class="keyword">done</span> ; <span class="built_in">chmod</span> +x</span><br></pre></td></tr></table></figure><h3 id="7-1-概念">7.1 概念</h3><p>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；<br>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；<br>server auth：表示client可以用该 CA 对server提供的证书进行验证；<br>client auth：表示server可以用该CA对client提供的证书进行验证；</p><p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。<br>C: Country， 国家<br>L: Locality，地区，城市<br>ST: State，州，省<br>O: Organization Name，组织名称，公司名称<br>OU: Organization Unit Name，组织单位名称，公司部门</p><h3 id="7-2-生成ca配置文件">7.2 生成ca配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults config &gt; ca-config.json</span><br></pre></td></tr></table></figure><p>ca-config.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;signing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1680h&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;profiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;www&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8760h&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;usages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;signing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;server auth&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">             <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="7-3-生成证书请求文件配置">7.3 生成证书请求文件配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; ca-csr.json</span><br></pre></td></tr></table></figure><p>root@vms41:~/CA# cat ca-csr.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ck8s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ecdsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jiangsu&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Xuzhou&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lduan&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cks&quot;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="7-4-生成自签名证书">7.4 生成自签名证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@vms41:~/CA<span class="comment"># ll</span></span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 2 root root 4096 Sep 23 15:26 ./</span><br><span class="line">drwx------ 6 root root 4096 Sep 23 12:18 ../</span><br><span class="line">-rw-r--r-- 1 root root  343 Sep 23 12:13 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  460 Sep 23 15:26 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  265 Sep 23 12:18 ca-csr.json</span><br><span class="line">-rw------- 1 root root  227 Sep 23 15:26 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  810 Sep 23 15:26 ca.pem</span><br></pre></td></tr></table></figure><h3 id="7-5-生成用户证书请求文件">7.5 生成用户证书请求文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; client-csr.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ck8s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ecdsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;www1.ck8s.com&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Xuzhou&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jiangsu&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lduan&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cks&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="7-6-签发client证书">7.6 签发client证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www client-csr.json| cfssljson -bare client</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@vms41:~/CA<span class="comment"># ll</span></span><br><span class="line">total 44</span><br><span class="line">drwxr-xr-x 2 root root 4096 Sep 23 15:36 ./</span><br><span class="line">drwx------ 6 root root 4096 Sep 23 15:33 ../</span><br><span class="line">-rw-r--r-- 1 root root  343 Sep 23 12:13 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  460 Sep 23 15:26 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  265 Sep 23 12:18 ca-csr.json</span><br><span class="line">-rw------- 1 root root  227 Sep 23 15:26 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  810 Sep 23 15:26 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root  517 Sep 23 15:36 client.csr</span><br><span class="line">-rw-r--r-- 1 root root  306 Sep 23 15:33 client-csr.json</span><br><span class="line">-rw------- 1 root root  227 Sep 23 15:36 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  871 Sep 23 15:36 client.pem</span><br></pre></td></tr></table></figure><h2 id="8-cert-manager">8. cert-manager</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220922/kubernetes-20220922-20-mTLS/2022-09-23-163531.png" class=""><p>官方文档：<a href="https://letsencrypt.org/zh-cn/docs/">https://letsencrypt.org/zh-cn/docs/</a><br>运行方式：<a href="https://letsencrypt.org/zh-cn/how-it-works/">https://letsencrypt.org/zh-cn/how-it-works/</a><br>安装文档：<a href="https://letsencrypt.org/zh-cn/how-it-works/">https://letsencrypt.org/zh-cn/how-it-works/</a></p><h3 id="8-1-创建">8.1 创建</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f cert-manager.yaml</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/yaml/cert-manager<span class="comment"># kubectl -n cert-manager get all</span></span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/cert-manager-594bcb5484-22467              1/1     Running   0          55s</span><br><span class="line">pod/cert-manager-cainjector-544bcd9bfc-bzzzp   1/1     Running   0          55s</span><br><span class="line">pod/cert-manager-webhook-5999fd64fb-gzx9c      1/1     Running   0          55s</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/cert-manager           ClusterIP   10.103.180.45   &lt;none&gt;        9402/TCP   55s</span><br><span class="line">service/cert-manager-webhook   ClusterIP   10.98.222.244   &lt;none&gt;        443/TCP    55s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/cert-manager              1/1     1            1           55s</span><br><span class="line">deployment.apps/cert-manager-cainjector   1/1     1            1           55s</span><br><span class="line">deployment.apps/cert-manager-webhook      1/1     1            1           55s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/cert-manager-594bcb5484              1         1         1       55s</span><br><span class="line">replicaset.apps/cert-manager-cainjector-544bcd9bfc   1         1         1       55s</span><br><span class="line">replicaset.apps/cert-manager-webhook-5999fd64fb      1         1         1       55s</span><br></pre></td></tr></table></figure><h3 id="8-2-创建clusterIssuer">8.2 创建clusterIssuer</h3><p><strong>创建secret</strong><br>dns的token</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudflare-api-token-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cert-manager</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">api-token:</span> <span class="string">were2wrj234lk4rj23l</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="8-3-创建clusterissue">8.3 创建clusterissue</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">letsencrypt-dns01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">acme:</span></span><br><span class="line">    <span class="attr">privateKeySecretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">letsencrypt-dns01</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class="line">    <span class="attr">solvers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">dns01:</span></span><br><span class="line">        <span class="attr">cloudflare:</span></span><br><span class="line">          <span class="attr">email:</span> <span class="string">my-cloudflare-acc@example.com</span></span><br><span class="line">          <span class="attr">apiTokenSecretRef:</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">api-token</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">cloudflare-api-token-secret</span></span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>DNS-01 的校验原理是利用 DNS 提供商的 API Key 拿到你的 DNS控制权限， 在 Let’s Encrypt 为 ACME 客户端提供令牌后，ACME 客户端 (cert-manager) 将创建从该令牌和您的帐户密钥派生的 TXT 记录，并将该记录放在 _acmechallenge.&lt;YOUR_DOMAIN&gt;。Let’s Encrypt 将向 DNS 系统查询该记录，如果找到匹配项，就可以颁发证书。此方法不需要你的服务使用 Ingress，并且支持泛域名证书。</p></div><h3 id="8-3-申请证书">8.3 申请证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f certificate.yaml </span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Certificate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">www-ck8s-com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">dnsNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">www.ck8s.com</span></span><br><span class="line">  <span class="attr">issuerRef:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">letsencrypt-dns01</span></span><br><span class="line">  <span class="attr">secretName:</span> <span class="string">www-ck8s-com-tls</span></span><br></pre></td></tr></table></figure><p><strong>查看证书申请</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/yaml/cert-manager<span class="comment"># kubectl get certificaterequests.cert-manager.io </span></span><br><span class="line">NAME                 APPROVED   DENIED   READY   ISSUER              REQUESTOR                                         AGE</span><br><span class="line">www-ck8s-com-dfwlq   True                False   letsencrypt-dns01   system:serviceaccount:cert-manager:cert-manager   27s</span><br></pre></td></tr></table></figure><p><strong>查看签发状态</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/yaml/cert-manager<span class="comment"># kubectl get challenges.acme.cert-manager.io </span></span><br><span class="line">NAME                                       STATE     DOMAIN         AGE</span><br><span class="line">www-ck8s-com-dfwlq-3476287311-2898304443   pending   www.ck8s.com   63s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>查看证书</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@vms40:~/yaml/cert-manager<span class="comment"># kubectl get certificate</span></span><br><span class="line">NAME           READY   SECRET             AGE</span><br><span class="line">www-ck8s-com   False   www-ck8s-com-tls   2m38s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>修改ingress使用签发的证书</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mying</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">www1.ck8s.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">www-ck8s-com-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www1.ck8s.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><strong>自动申请证书</strong><br>创建ingress自动去ClusterIssuer申请证书</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">solo-ingress</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="attr">kubernietes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> </span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">tls:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">www.ck8s.com</span> </span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">rhce-tls</span> </span><br><span class="line"><span class="attr">rules:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.ck8s.com</span> </span><br><span class="line">  <span class="attr">http:</span> </span><br><span class="line">    <span class="attr">paths:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> </span><br><span class="line">      <span class="attr">backend:</span> </span><br><span class="line">        <span class="attr">serviceName:</span> <span class="string">svc1</span> </span><br><span class="line">        <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="8-4-使用自签名CA">8.4 使用自签名CA</h3><h4 id="8-4-1-创建secret">8.4.1 创建secret</h4><p>把CA的证书和密钥写入到 secre</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls ca-key --cert=ca.pem --key=ca-key.pem --namespace=cert-manager</span><br></pre></td></tr></table></figure><h4 id="8-4-2-创建clusterissuer">8.4.2 创建clusterissuer</h4><p>用自己的CA模拟签发机构</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cert-manager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ca:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">ca-ke</span></span><br></pre></td></tr></table></figure><h4 id="8-4-3-创建ingress">8.4.3 创建ingress</h4><p>ingress中指定签发机构</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">solo-ingress</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="attr">kubernietes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> </span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">tls:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">www.ck8s.com</span> </span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">rhce-tls</span> </span><br><span class="line"><span class="attr">rules:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.ck8s.com</span> </span><br><span class="line">  <span class="attr">http:</span> </span><br><span class="line">    <span class="attr">paths:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> </span><br><span class="line">      <span class="attr">backend:</span> </span><br><span class="line">        <span class="attr">serviceName:</span> <span class="string">svc1</span> </span><br><span class="line">        <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>19.kubeadm高可用部署</title>
      <link href="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/"/>
      <url>/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前言-2">1. 前言</h2><div class="note warning no-icon flat"><p>官网：<a href="https://kubernetes.io/">https://kubernetes.io/</a><br>官方文档：<a href="https://kubernetes.io/zh-cn/docs/home/">https://kubernetes.io/zh-cn/docs/home/</a></p></div><h2 id="2-前期准备（所有节点）">2. 前期准备（所有节点）</h2><h3 id="2-1-修改主机名和配置-hosts">2.1 修改主机名和配置 hosts</h3><p>先部署 1master 和 2node 节点，后面再加一个 master 节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在192.168.0.113执行</span></span><br><span class="line">hostnamectl set-hostname  k8s-master-168-0-113</span><br><span class="line"><span class="comment"># 在192.168.0.114执行</span></span><br><span class="line">hostnamectl set-hostname k8s-node1-168-0-114</span><br><span class="line"><span class="comment"># 在192.168.0.115执行</span></span><br><span class="line">hostnamectl set-hostname k8s-node2-168-0-115</span><br></pre></td></tr></table></figure><p>配置 hosts</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.0.113 k8s-master-168-0-113</span></span><br><span class="line"><span class="string">192.168.0.114 k8s-node1-168-0-114</span></span><br><span class="line"><span class="string">192.168.0.115 k8s-node2-168-0-115</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="2-2-配置ssh互信">2.2 配置ssh互信</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接一直回车就行</span></span><br><span class="line">ssh-keygen</span><br><span class="line"> </span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-master-168-0-113</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node1-168-0-114</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node2-168-0-115</span><br></pre></td></tr></table></figure><h3 id="2-3-时间同步">2.3 时间同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install chrony -y</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line">chronyc sources</span><br></pre></td></tr></table></figure><h3 id="2-4-关闭防火墙">2.4 关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h3 id="2-5-关闭swap">2.5 关闭swap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭；关闭swap主要是为了性能考虑</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 可以通过这个命令查看swap是否关闭了</span></span><br><span class="line">free</span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure><h3 id="2-6-禁用SELinux">2.6 禁用SELinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久禁用</span></span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2-7-允许-iptables-检查桥接流量（可选，所有节点）">2.7 允许 iptables 检查桥接流量（可选，所有节点）</h3><p>若要显式加载此模块，请运行 sudo modprobe br_netfilter，通过运行 lsmod | grep br_netfilter 来验证 br_netfilter 模块是否已加载，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe br_netfilter</span><br><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure><p>为了让 Linux 节点的 iptables 能够正确查看桥接流量，请确认 sysctl 配置中的 net.bridge.bridge-nf-call-iptables 设置为 1。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置所需的 sysctl 参数，参数在重新启动后保持不变</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 应用 sysctl 参数而不重新启动</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure><h2 id="3-安装容器-docker（所有节点）">3. 安装容器 docker（所有节点）</h2><div class="note warning no-icon flat"><p>提示：v1.24 之前的 Kubernetes 版本包括与 Docker Engine 的直接集成，使用名为 dockershim 的组件。这种特殊的直接整合不再是 Kubernetes 的一部分 （这次删除被作为 v1.20 发行版本的一部分宣布）。你可以阅读检查 Dockershim 弃用是否会影响你 以了解此删除可能会如何影响你。要了解如何使用 dockershim 进行迁移，请参阅从 dockershim 迁移。</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置yum源</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d ; <span class="built_in">mkdir</span> bak; <span class="built_in">mv</span> CentOS-Linux-* bak/</span><br><span class="line"><span class="comment"># centos7</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># centos8</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 安装yum-config-manager配置工具</span></span><br><span class="line">yum -y install yum-utils</span><br><span class="line"><span class="comment"># 设置yum源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 安装docker-ce版本</span></span><br><span class="line">yum install -y docker-ce</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># 查看版本号</span></span><br><span class="line">docker --version</span><br><span class="line"><span class="comment"># 查看版本具体信息</span></span><br><span class="line">docker version</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Docker镜像源设置</span></span><br><span class="line"><span class="comment"># 修改文件 /etc/docker/daemon.json，没有这个文件就创建</span></span><br><span class="line"><span class="comment"># 添加以下内容后，重启docker服务：</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">systemctl reload docker</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">systemctl status docker containerd</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>【温馨提示】dockerd 实际真实调用的还是 containerd 的 api 接口，containerd 是 dockerd 和 runC 之间的一个中间交流组件。所以启动 docker 服务的时候，也会启动 containerd 服务的。</p></div><h2 id="4-配置-k8s-yum-源（所有节点）">4. 配置 k8s yum 源（所有节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[k8s]</span></span><br><span class="line"><span class="string">name=k8s</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="5-将-sandbox-image-镜像源设置为阿里云-google-containers-镜像源（所有节点）">5. 将 sandbox_image 镜像源设置为阿里云 google_containers 镜像源（所有节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出默认配置，config.toml这个文件默认是不存在的</span></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">grep sandbox_image  /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">&quot;s#k8s.gcr.io/pause#registry.aliyuncs.com/google_containers/pause#g&quot;</span>       /etc/containerd/config.toml</span><br><span class="line">grep sandbox_image  /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/3708b8bafad1069012a2bd5f46654533.png" class=""><h2 id="6-配置-containerd-cgroup-驱动程序-systemd（所有节点）">6. 配置 containerd cgroup 驱动程序 systemd（所有节点）</h2><div class="note warning no-icon flat"><p>kubernets 自ｖ 1.24.0 后，就不再使用 docker.shim，替换采用 containerd 作为容器运行时端点。因此需要安装 containerd（在 docker 的基础下安装），上面安装 docker 的时候就自动安装了 containerd 了。这里的 docker 只是作为客户端而已。容器引擎还是 containerd。</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#SystemdCgroup = false#SystemdCgroup = true#g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># 应用所有更改后,重新启动containerd</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h2 id="7-开始安装-kubeadm，kubelet-和-kubectl（master-节点）">7. 开始安装 kubeadm，kubelet 和 kubectl（master 节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不指定版本就是最新版本，当前最新版就是1.24.1</span></span><br><span class="line">yum install -y kubelet-1.24.1  kubeadm-1.24.1  kubectl-1.24.1 --disableexcludes=kubernetes</span><br><span class="line"><span class="comment"># disableexcludes=kubernetes：禁掉除了这个kubernetes之外的别的仓库</span></span><br><span class="line"><span class="comment"># 设置为开机自启并现在立刻启动服务 --now：立刻启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看状态，这里需要等待一段时间再查看服务状态，启动会有点慢</span></span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/6dc6086a27f2fe1fb792763b5f94559f.png" class=""><p>查看日志，发现有报错，报错如下：</p><div class="note danger no-icon flat"><p>kubelet.service: Main process exited, code=exited, status=1/FAILURE kubelet.service: Failed with result ‘exit-code’.</p></div><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/6a682a9a0875747d0822ac46c4105ece.png" class=""><div class="note primary no-icon flat"><p>【解释】重新安装（或第一次安装）k8s，未经过 kubeadm init 或者 kubeadm join 后，kubelet 会不断重启，这个是正常现象……，执行 init 或 join 后问题会自动解决，对此官网有如下描述，也就是此时不用理会 kubelet.service。</p></div><p>查看版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl version</span><br><span class="line">yum info kubeadm</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/2bbc22c48dcb4f3f2f63951dba57c501.png" class=""><h2 id="8-使用-kubeadm-初始化集群（master-节点）">8. 使用 kubeadm 初始化集群（master 节点）</h2><p>最好提前把镜像下载好，这样安装快</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.24.1</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.24.1</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.24.1</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.24.1</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/pause:3.7</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/etcd:3.5.3-0</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/coredns:v1.8.6</span><br></pre></td></tr></table></figure><p>集群初始化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.0.113 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --control-plane-endpoint=cluster-endpoint \</span><br><span class="line">  --kubernetes-version v1.24.1 \</span><br><span class="line">  --service-cidr=10.1.0.0/16 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --v=5</span><br><span class="line"><span class="comment"># –image-repository string：    这个用于指定从什么位置来拉取镜像（1.13版本才有的），默认值是k8s.gcr.io，我们将其指定为国内镜像地址：registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment"># –kubernetes-version string：  指定kubenets版本号，默认值是stable-1，会导致从https://dl.k8s.io/release/stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（v1.22.1）来跳过网络请求。</span></span><br><span class="line"><span class="comment"># –apiserver-advertise-address  指明用 Master 的哪个 interface 与 Cluster 的其他节点通信。如果 Master 有多个 interface，建议明确指定，如果不指定，kubeadm 会自动选择有默认网关的 interface。这里的ip为master节点ip，记得更换。</span></span><br><span class="line"><span class="comment"># –pod-network-cidr             指定 Pod 网络的范围。Kubernetes 支持多种网络方案，而且不同网络方案对  –pod-network-cidr有自己的要求，这里设置为10.244.0.0/16 是因为我们将使用 flannel 网络方案，必须设置成这个 CIDR。</span></span><br><span class="line"><span class="comment"># --control-plane-endpoint     cluster-endpoint 是映射到该 IP 的自定义 DNS 名称，这里配置hosts映射：192.168.0.113   cluster-endpoint。 这将允许你将 --control-plane-endpoint=cluster-endpoint 传递给 kubeadm init，并将相同的 DNS 名称传递给 kubeadm join。 稍后你可以修改 cluster-endpoint 以指向高可用性方案中的负载均衡器的地址。</span></span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>【温馨提示】kubeadm 不支持将没有 --control-plane-endpoint 参数的单个控制平面集群转换为高可用性集群。</p></div><p>重置再初始化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br><span class="line"><span class="built_in">rm</span> -fr ~/.kube/  /etc/kubernetes/* var/lib/etcd/*</span><br><span class="line">kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.0.113  \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --control-plane-endpoint=cluster-endpoint \</span><br><span class="line">  --kubernetes-version v1.24.1 \</span><br><span class="line">  --service-cidr=10.1.0.0/16 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --v=5</span><br><span class="line"><span class="comment"># –image-repository string：    这个用于指定从什么位置来拉取镜像（1.13版本才有的），默认值是k8s.gcr.io，我们将其指定为国内镜像地址：registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment"># –kubernetes-version string：  指定kubenets版本号，默认值是stable-1，会导致从https://dl.k8s.io/release/stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（v1.22.1）来跳过网络请求。</span></span><br><span class="line"><span class="comment"># –apiserver-advertise-address  指明用 Master 的哪个 interface 与 Cluster 的其他节点通信。如果 Master 有多个 interface，建议明确指定，如果不指定，kubeadm 会自动选择有默认网关的 interface。这里的ip为master节点ip，记得更换。</span></span><br><span class="line"><span class="comment"># –pod-network-cidr             指定 Pod 网络的范围。Kubernetes 支持多种网络方案，而且不同网络方案对  –pod-network-cidr有自己的要求，这里设置为10.244.0.0/16 是因为我们将使用 flannel 网络方案，必须设置成这个 CIDR。</span></span><br><span class="line"><span class="comment"># --control-plane-endpoint     cluster-endpoint 是映射到该 IP 的自定义 DNS 名称，这里配置hosts映射：192.168.0.113   cluster-endpoint。 这将允许你将 --control-plane-endpoint=cluster-endpoint 传递给 kubeadm init，并将相同的 DNS 名称传递给 kubeadm join。 稍后你可以修改 cluster-endpoint 以指向高可用性方案中的负载均衡器的地址。</span></span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 临时生效（退出当前窗口重连环境变量失效）</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"><span class="comment"># 永久生效（推荐）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span>  ~/.bash_profile</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/2042dcd9b0c1400bc9e1c40c5b1a2367.png" class=""><p>发现节点还是有问题，查看日志 /var/log/messages</p><div class="note danger no-icon flat"><p>“Container runtime network not ready” networkReady=“NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized”</p></div><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/b379bfa0abeb253e9d74ff1af455b387.png" class=""><p>接下来就是安装 Pod 网络插件</p><h2 id="9-安装-Pod-网络插件（CNI：Container-Network-Interface）-master">9. 安装 Pod 网络插件（CNI：Container Network Interface）(master)</h2><p>你必须部署一个基于 Pod 网络插件的 容器网络接口 (CNI)，以便你的 Pod 可以相互通信。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最好提前下载镜像（所有节点）</span></span><br><span class="line">docker pull quay.io/coreos/flannel:v0.14.0</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>再查看 node 节点，就已经正常了</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/38b9cc51be6ad1d3ee6a8e21d5082d69.png" class=""><h2 id="10-node-节点加入-k8s-集群">10. node 节点加入 k8s 集群</h2><p>先安装 kubelet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"><span class="comment"># 设置为开机自启并现在立刻启动服务 --now：立刻启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure><p>如果没有令牌，可以通过在控制平面节点上运行以下命令来获取令牌：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>默认情况下，令牌会在24小时后过期。如果要在当前令牌过期后将节点加入集群， 则可以通过在控制平面节点上运行以下命令来创建新令牌：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create</span><br><span class="line"><span class="comment"># 再查看</span></span><br><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>如果你没有 –discovery-token-ca-cert-hash 的值，则可以通过在控制平面节点上执行以下命令链来获取它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br></pre></td></tr></table></figure><p>如果执行 kubeadm init 时没有记录下加入集群的命令，可以通过以下命令重新创建（推荐）一般不用上面的分别获取 token 和 ca-cert-hash 方式，执行以下命令一气呵成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><p>这里需要等待一段时间，再查看节点节点状态，因为需要安装 kube-proxy 和 flannel。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/da6d3bed351220172fd7b36c11f733e2.png" class=""><h2 id="11-配置-IPVS">11. 配置 IPVS</h2><p>【问题】集群内无法 ping 通 ClusterIP（或 ServiceName）</p><h3 id="11-1-加载-ip-vs-相关内核模块">11.1 加载 ip_vs 相关内核模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br></pre></td></tr></table></figure><p>所有节点验证开启了 ipvs：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod |grep ip_vs</span><br></pre></td></tr></table></figure><h3 id="11-2-安装-ipvsadm-工具">11.2 安装 ipvsadm 工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipset ipvsadm -y</span><br></pre></td></tr></table></figure><h3 id="11-3-编辑-kube-proxy-配置文件，mode-修改成-ipvs">11.3 编辑 kube-proxy 配置文件，mode 修改成 ipvs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit  configmap -n kube-system  kube-proxy</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/12c12a0c5dbd049557e298732a59f55e.png" class=""><h3 id="11-4-重启-kube-proxy">11.4 重启 kube-proxy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先查看</span></span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy</span><br><span class="line"><span class="comment"># 再delete让它自拉起</span></span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk <span class="string">&#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27;</span></span><br><span class="line"><span class="comment"># 再查看</span></span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/680cc9b1324a7cf26f5d71af132d9360.png" class=""><h3 id="11-5-查看-ipvs-转发规则">11.5 查看 ipvs 转发规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/ba54f694f93e34f71f4317530f5f7c5f.png" class=""><h2 id="12-集群高可用配置">12. 集群高可用配置</h2><p>配置高可用（HA）Kubernetes 集群实现的两种方案：</p><ul><li>使用堆叠（stacked）控制平面节点，其中 etcd 节点与控制平面节点共存（本章使用），架构图如下：</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/0db2ecab0ad0746e4155b0998a9f04f1.png" class=""><ul><li>使用外部 etcd 节点，其中 etcd 在与控制平面不同的节点上运行，架构图如下：</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/a48532b6492693988f0a9131b5fa978f.png" class=""><p>这里新增一台机器作为另外一个 master 节点：192.168.0.116 配置跟上面 master 节点一样。只是不需要最后一步初始化了。</p><h3 id="12-1-修改主机名和配置-hosts">12.1 修改主机名和配置 hosts</h3><p>所有节点都统一如下配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在192.168.0.113执行</span></span><br><span class="line">hostnamectl set-hostname  k8s-master-168-0-113</span><br><span class="line"><span class="comment"># 在192.168.0.114执行</span></span><br><span class="line">hostnamectl set-hostname k8s-node1-168-0-114</span><br><span class="line"><span class="comment"># 在192.168.0.115执行</span></span><br><span class="line">hostnamectl set-hostname k8s-node2-168-0-115</span><br><span class="line"><span class="comment"># 在192.168.0.116执行</span></span><br><span class="line">hostnamectl set-hostname k8s-master2-168-0-116</span><br></pre></td></tr></table></figure><p>配置 hosts</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.0.113 k8s-master-168-0-113 cluster-endpoint</span></span><br><span class="line"><span class="string">192.168.0.114 k8s-node1-168-0-114</span></span><br><span class="line"><span class="string">192.168.0.115 k8s-node2-168-0-115</span></span><br><span class="line"><span class="string">192.168.0.116 k8s-master2-168-0-116</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="12-2-配置-ssh-互信">12.2 配置 ssh 互信</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接一直回车就行</span></span><br><span class="line">ssh-keygen</span><br><span class="line"> </span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-master-168-0-113</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node1-168-0-114</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node2-168-0-115</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-master2-168-0-116</span><br></pre></td></tr></table></figure><h3 id="12-3-时间同步">12.3 时间同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install chrony -y</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line">chronyc sources</span><br></pre></td></tr></table></figure><h3 id="12-4-关闭防火墙">12.4 关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h3 id="12-5-关闭-swap">12.5 关闭 swap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭；关闭swap主要是为了性能考虑</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 可以通过这个命令查看swap是否关闭了</span></span><br><span class="line">free</span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure><h3 id="12-6-禁用-SELinux">12.6 禁用 SELinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久禁用</span></span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="12-7-允许-iptables-检查桥接流量（可选，所有节点）">12.7 允许 iptables 检查桥接流量（可选，所有节点）</h3><p>若要显式加载此模块，请运行 sudo modprobe br_netfilter，通过运行 lsmod | grep br_netfilter 来验证 br_netfilter 模块是否已加载，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe br_netfilter</span><br><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure><p>为了让 Linux 节点的 iptables 能够正确查看桥接流量，请确认 sysctl 配置中的 net.bridge.bridge-nf-call-iptables 设置为 1。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置所需的 sysctl 参数，参数在重新启动后保持不变</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 应用 sysctl 参数而不重新启动</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure><h3 id="12-8-安装容器-docker（所有节点）">12.8 安装容器 docker（所有节点）</h3><div class="note default no-icon flat"><p>提示：v1.24 之前的 Kubernetes 版本包括与 Docker Engine 的直接集成，使用名为 dockershim 的组件。这种特殊的直接整合不再是 Kubernetes 的一部分 （这次删除被作为 v1.20 发行版本的一部分宣布）。你可以阅读检查 Dockershim 弃用是否会影响你 以了解此删除可能会如何影响你。要了解如何使用 dockershim 进行迁移，请参阅从 dockershim 迁移</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置yum源</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d ; <span class="built_in">mkdir</span> bak; <span class="built_in">mv</span> CentOS-Linux-* bak/</span><br><span class="line"><span class="comment"># centos7</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># centos8</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 安装yum-config-manager配置工具</span></span><br><span class="line">yum -y install yum-utils</span><br><span class="line"><span class="comment"># 设置yum源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 安装docker-ce版本</span></span><br><span class="line">yum install -y docker-ce</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># 查看版本号</span></span><br><span class="line">docker --version</span><br><span class="line"><span class="comment"># 查看版本具体信息</span></span><br><span class="line">docker version</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Docker镜像源设置</span></span><br><span class="line"><span class="comment"># 修改文件 /etc/docker/daemon.json，没有这个文件就创建</span></span><br><span class="line"><span class="comment"># 添加以下内容后，重启docker服务：</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">systemctl reload docker</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">systemctl status docker containerd</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>【温馨提示】dockerd 实际真实调用的还是 containerd 的 api 接口，containerd 是 dockerd 和 runC 之间的一个中间交流组件。所以启动 docker 服务的时候，也会启动 containerd 服务的。</p></div><h3 id="12-9-配置-k8s-yum-源（所有节点）">12.9 配置 k8s yum 源（所有节点）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[k8s]</span></span><br><span class="line"><span class="string">name=k8s</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="12-10-将-sandbox-image-镜像源设置为阿里云-google-containers-镜像源（所有节点）">12.10 将 sandbox_image 镜像源设置为阿里云 google_containers 镜像源（所有节点）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出默认配置，config.toml这个文件默认是不存在的</span></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">grep sandbox_image  /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">&quot;s#k8s.gcr.io/pause#registry.aliyuncs.com/google_containers/pause#g&quot;</span>       /etc/containerd/config.toml</span><br><span class="line">grep sandbox_image  /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/b2f9379a70ea64538eef220de4c5874f.png" class=""><h3 id="12-11-配置-containerd-cgroup-驱动程序-systemd">12.11 配置 containerd cgroup 驱动程序 systemd</h3><div class="note default no-icon flat"><p>kubernets 自ｖ 1.24.0 后，就不再使用 docker.shim，替换采用 containerd 作为容器运行时端点。因此需要安装 containerd（在 docker 的基础下安装），上面安装 docker 的时候就自动安装了 containerd 了。这里的 docker 只是作为客户端而已。容器引擎还是 containerd。</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#SystemdCgroup = false#SystemdCgroup = true#g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># 应用所有更改后,重新启动containerd</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h3 id="12-12-开始安装-kubeadm，kubelet-和-kubectl（master-节点）">12.12 开始安装 kubeadm，kubelet 和 kubectl（master 节点）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不指定版本就是最新版本，当前最新版就是1.24.1</span></span><br><span class="line">yum install -y kubelet-1.24.1  kubeadm-1.24.1  kubectl-1.24.1 --disableexcludes=kubernetes</span><br><span class="line"><span class="comment"># disableexcludes=kubernetes：禁掉除了这个kubernetes之外的别的仓库</span></span><br><span class="line"><span class="comment"># 设置为开机自启并现在立刻启动服务 --now：立刻启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看状态，这里需要等待一段时间再查看服务状态，启动会有点慢</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"> </span><br><span class="line">kubectl version</span><br><span class="line">yum info kubeadm</span><br></pre></td></tr></table></figure><h3 id="12-13-加入-k8s-集群">12.13 加入 k8s 集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 证如果过期了，可以使用下面命令生成新证书上传，这里会打印出certificate key，后面会用到</span></span><br><span class="line">kubeadm init phase upload-certs --upload-certs</span><br><span class="line"><span class="comment"># 你还可以在 【init】期间指定自定义的 --certificate-key，以后可以由 join 使用。 要生成这样的密钥，可以使用以下命令（这里不执行，就用上面那个自命令就可以了）：</span></span><br><span class="line">kubeadm certs certificate-key</span><br><span class="line"> </span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"> </span><br><span class="line">kubeadm <span class="built_in">join</span> cluster-endpoint:6443 --token wswrfw.fc81au4yvy6ovmhh --discovery-token-ca-cert-hash sha256:43a3924c25104d4393462105639f6a02b8ce284728775ef9f9c30eed8e0abc0f --control-plane --certificate-key 8d2709697403b74e35d05a420bd2c19fd8c11914eb45f2ff22937b245bed5b68</span><br><span class="line"> </span><br><span class="line"><span class="comment"># --control-plane 标志通知 kubeadm join 创建一个新的控制平面。加入master必须加这个标记</span></span><br><span class="line"><span class="comment"># --certificate-key ... 将导致从集群中的 kubeadm-certs Secret 下载控制平面证书并使用给定的密钥进行解密。这里的值就是上面这个命令（kubeadm init phase upload-certs --upload-certs）打印出的key。</span></span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/ea30f504feb8a4ba33de83eefce60f56.png" class=""><p>根据提示执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><p>查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods -A -owide</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/87ef90bca62e6ac4a2abf1e83831adb8.png" class=""><p>虽然现在已经有两个 master 了，但是对外还是只能有一个入口的，所以还得要一个负载均衡器，如果一个 master 挂了，会自动切到另外一个 master 节点。</p><h2 id="13-部署-Nginx-Keepalived-高可用负载均衡器">13. 部署 Nginx+Keepalived 高可用负载均衡器</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/a4d7cd609c8678772195080f59e6d155.png" class=""><h3 id="13-1-安装-Nginx-和-Keepalived">13.1 安装 Nginx 和 Keepalived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在两个master节点上执行</span></span><br><span class="line">yum install nginx keepalived -y</span><br></pre></td></tr></table></figure><h3 id="13-2-Nginx-配置">13.2 Nginx 配置</h3><p>在两个 master 节点配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/nginx/nginx.conf &lt;&lt; <span class="string">&quot;EOF&quot;</span></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class="line">stream &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">    <span class="comment"># Master APISERVER IP:PORT</span></span><br><span class="line">       server 192.168.0.113:6443;</span><br><span class="line">    <span class="comment"># Master2 APISERVER IP:PORT</span></span><br><span class="line">       server 192.168.0.116:6443;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 16443;</span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line"> </span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>【温馨提示】如果只保证高可用，不配置 k8s-apiserver 负载均衡的话，可以不装 nginx，但是最好还是配置一下 k8s-apiserver 负载均衡。</p></div><h3 id="13-3-Keepalived-配置（master）">13.3 Keepalived 配置（master）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string">   notification_email &#123;</span></span><br><span class="line"><span class="string">     acassen@firewall.loc</span></span><br><span class="line"><span class="string">     failover@firewall.loc</span></span><br><span class="line"><span class="string">     sysadmin@firewall.loc</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">   notification_email_from fage@qq.com</span></span><br><span class="line"><span class="string">   smtp_server 127.0.0.1</span></span><br><span class="line"><span class="string">   smtp_connect_timeout 30</span></span><br><span class="line"><span class="string">   router_id NGINX_MASTER</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">vrrp_script check_nginx &#123;</span></span><br><span class="line"><span class="string">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123;</span></span><br><span class="line"><span class="string">    state MASTER</span></span><br><span class="line"><span class="string">    interface ens33</span></span><br><span class="line"><span class="string">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的</span></span><br><span class="line"><span class="string">    priority 100    # 优先级，备服务器设置 90</span></span><br><span class="line"><span class="string">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒</span></span><br><span class="line"><span class="string">    authentication &#123;</span></span><br><span class="line"><span class="string">        auth_type PASS</span></span><br><span class="line"><span class="string">        auth_pass 1111</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    # 虚拟IP</span></span><br><span class="line"><span class="string">    virtual_ipaddress &#123;</span></span><br><span class="line"><span class="string">        192.168.0.120/24</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    track_script &#123;</span></span><br><span class="line"><span class="string">        check_nginx</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul><li>vrrp_script：指定检查 nginx 工作状态脚本（根据 nginx 状态判断是否故障转移）</li><li>virtual_ipaddress：虚拟 IP（VIP）</li></ul><p>检查 nginx 状态脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/check_nginx.sh  &lt;&lt; <span class="string">&quot;EOF&quot;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx |egrep -cv <span class="string">&quot;grep|$$&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$count</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure><h3 id="13-4-Keepalived-配置（backup）">13.4 Keepalived 配置（backup）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string">   notification_email &#123;</span></span><br><span class="line"><span class="string">     acassen@firewall.loc</span></span><br><span class="line"><span class="string">     failover@firewall.loc</span></span><br><span class="line"><span class="string">     sysadmin@firewall.loc</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">   notification_email_from fage@qq.com</span></span><br><span class="line"><span class="string">   smtp_server 127.0.0.1</span></span><br><span class="line"><span class="string">   smtp_connect_timeout 30</span></span><br><span class="line"><span class="string">   router_id NGINX_BACKUP</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">vrrp_script check_nginx &#123;</span></span><br><span class="line"><span class="string">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123;</span></span><br><span class="line"><span class="string">    state BACKUP</span></span><br><span class="line"><span class="string">    interface ens33</span></span><br><span class="line"><span class="string">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的</span></span><br><span class="line"><span class="string">    priority 90</span></span><br><span class="line"><span class="string">    advert_int 1</span></span><br><span class="line"><span class="string">    authentication &#123;</span></span><br><span class="line"><span class="string">        auth_type PASS</span></span><br><span class="line"><span class="string">        auth_pass 1111</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    virtual_ipaddress &#123;</span></span><br><span class="line"><span class="string">        192.168.0.120/24</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    track_script &#123;</span></span><br><span class="line"><span class="string">        check_nginx</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>检查 nginx 状态脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/check_nginx.sh  &lt;&lt; <span class="string">&quot;EOF&quot;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx |egrep -cv <span class="string">&quot;grep|$$&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$count</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure><h3 id="13-5-启动并设置开机启动">13.5 启动并设置开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart nginx &amp;&amp; systemctl <span class="built_in">enable</span> nginx &amp;&amp; systemctl status nginx</span><br><span class="line">systemctl restart keepalived &amp;&amp; systemctl <span class="built_in">enable</span> keepalived &amp;&amp; systemctl status keepalived</span><br></pre></td></tr></table></figure><p>查看 VIP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/80de5bd0a857b514163e20cb707cb77f.png" class=""><h3 id="13-6-修改-hosts（所有节点）">13.6 修改 hosts（所有节点）</h3><p>将 cluster-endpoint 之前执行的 ip 修改执行现在的 VIP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.113 k8s-master-168-0-113</span><br><span class="line">192.168.0.114 k8s-node1-168-0-114</span><br><span class="line">192.168.0.115 k8s-node2-168-0-115</span><br><span class="line">192.168.0.116 k8s-master2-168-0-116</span><br><span class="line">192.168.0.120 cluster-endpoint</span><br></pre></td></tr></table></figure><h3 id="13-7-测试验证">13.7 测试验证</h3><p>查看版本（负载均衡测试验证）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k https://cluster-endpoint:16443/version</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/7670570e09e20dc52a918f763462cc82.png" class=""><p>高可用测试验证，将 k8s-master-168-0-113 节点关机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br><span class="line">curl -k https://cluster-endpoint:16443/version</span><br><span class="line">kubectl get nodes -A</span><br><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure><h2 id="14-dashboard-环境部署">14. dashboard 环境部署</h2><p>GitHub 地址：<a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br><span class="line">kubectl get pods -n kubernetes-dashboard</span><br></pre></td></tr></table></figure><p>但是这个只能内部访问，所以要外部访问，要么部署 ingress，要么就是设置 service NodePort 类型。这里选择 service 暴露端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><p>修改后的内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 31443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-csrf</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  csrf: <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-key-holder</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-settings</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    resourceNames: [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    resourceNames: [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get metrics.</span></span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    resourceNames: [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    resourceNames: [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Allow Metrics Scraper to get metrics from the Metrics server</span></span><br><span class="line">  - apiGroups: [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubernetes-dashboard</span><br><span class="line">    namespace: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubernetes-dashboard</span><br><span class="line">    namespace: kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">    spec:</span><br><span class="line">      securityContext:</span><br><span class="line">        seccompProfile:</span><br><span class="line">          <span class="built_in">type</span>: RuntimeDefault</span><br><span class="line">      containers:</span><br><span class="line">        - name: kubernetes-dashboard</span><br><span class="line">          image: kubernetesui/dashboard:v2.6.0</span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8443</span><br><span class="line">              protocol: TCP</span><br><span class="line">          args:</span><br><span class="line">            - --auto-generate-certificates</span><br><span class="line">            - --namespace=kubernetes-dashboard</span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">            <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">            <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: kubernetes-dashboard-certs</span><br><span class="line">              mountPath: /certs</span><br><span class="line">              <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">            - mountPath: /tmp</span><br><span class="line">              name: tmp-volume</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              scheme: HTTPS</span><br><span class="line">              path: /</span><br><span class="line">              port: 8443</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">false</span></span><br><span class="line">            readOnlyRootFilesystem: <span class="literal">true</span></span><br><span class="line">            runAsUser: 1001</span><br><span class="line">            runAsGroup: 2001</span><br><span class="line">      volumes:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          secret:</span><br><span class="line">            secretName: kubernetes-dashboard-certs</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      nodeSelector:</span><br><span class="line">        <span class="string">&quot;kubernetes.io/os&quot;</span>: linux</span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      tolerations:</span><br><span class="line">        - key: node-role.kubernetes.io/master</span><br><span class="line">          effect: NoSchedule</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line">  name: dashboard-metrics-scraper</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8000</span><br><span class="line">      targetPort: 8000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line">  name: dashboard-metrics-scraper</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: dashboard-metrics-scraper</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: dashboard-metrics-scraper</span><br><span class="line">    spec:</span><br><span class="line">      securityContext:</span><br><span class="line">        seccompProfile:</span><br><span class="line">          <span class="built_in">type</span>: RuntimeDefault</span><br><span class="line">      containers:</span><br><span class="line">        - name: dashboard-metrics-scraper</span><br><span class="line">          image: kubernetesui/metrics-scraper:v1.0.8</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8000</span><br><span class="line">              protocol: TCP</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              scheme: HTTP</span><br><span class="line">              path: /</span><br><span class="line">              port: 8000</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          volumeMounts:</span><br><span class="line">          - mountPath: /tmp</span><br><span class="line">            name: tmp-volume</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">false</span></span><br><span class="line">            readOnlyRootFilesystem: <span class="literal">true</span></span><br><span class="line">            runAsUser: 1001</span><br><span class="line">            runAsGroup: 2001</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      nodeSelector:</span><br><span class="line">        <span class="string">&quot;kubernetes.io/os&quot;</span>: linux</span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      tolerations:</span><br><span class="line">        - key: node-role.kubernetes.io/master</span><br><span class="line">          effect: NoSchedule</span><br><span class="line">      volumes:</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/0ea7ebc5c6b505c472ca1223f4f53bfe.png" class=""><p>重新部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f recommended.yaml</span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line">kubectl get svc,pods -n kubernetes-dashboard</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/09349cf7b391dd760daa0d08b7d57a9e.png" class=""><h3 id="14-1-创建登录用户">14.1 创建登录用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;ServiceAccount.yaml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: admin-user</span></span><br><span class="line"><span class="string">  namespace: kubernetes-dashboard</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: admin-user</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: cluster-admin</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: ServiceAccount</span></span><br><span class="line"><span class="string">  name: admin-user</span></span><br><span class="line"><span class="string">  namespace: kubernetes-dashboard</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f ServiceAccount.yaml</span><br></pre></td></tr></table></figure><p>创建并获取登录 token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard create token admin-user</span><br></pre></td></tr></table></figure><h3 id="14-2-配置-hosts-登录-dashboard-web">14.2 配置 hosts 登录 dashboard web</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.120 cluster-endpoint</span><br></pre></td></tr></table></figure><p>登录：<a href="https://cluster-endpoint:31443">https://cluster-endpoint:31443</a></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/6bfa77ed1c8a78642f958470bf1b637d.png" class=""><p>输入上面创建的 token 登录</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/c16cfe22df1dd92da6bc24cfe7112e85.png" class=""><h2 id="15-harbor-环境部署">15. harbor 环境部署</h2><p>GitHub 地址：<a href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a><br>这使用 helm 安装，所以得先安装 helm</p><h3 id="15-1-安装-helm">15.1 安装 helm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/k8s/helm &amp;&amp; <span class="built_in">cd</span> /opt/k8s/helm</span><br><span class="line">wget https://get.helm.sh/helm-v3.9.0-rc.1-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v3.9.0-rc.1-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">ln</span> -s /opt/k8s/helm/linux-amd64/helm /usr/bin/helm</span><br><span class="line">helm version</span><br><span class="line">helm <span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="15-2-配置-hosts">15.2 配置 hosts</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.120 myharbor.com</span><br></pre></td></tr></table></figure><h3 id="15-3-创建-stl-证书">15.3 创建 stl 证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /opt/k8s/helm/stl &amp;&amp; <span class="built_in">cd</span> /opt/k8s/helm/stl</span><br><span class="line"><span class="comment"># 生成 CA 证书私钥</span></span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line"><span class="comment"># 生成 CA 证书</span></span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line"> -subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Shenzhen/O=harbor/OU=harbor/CN=myharbor.com&quot;</span> \</span><br><span class="line"> -key ca.key \</span><br><span class="line"> -out ca.crt</span><br><span class="line"><span class="comment"># 创建域名证书，生成私钥</span></span><br><span class="line">openssl genrsa -out myharbor.com.key 4096</span><br><span class="line"><span class="comment"># 生成证书签名请求 CSR</span></span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Shenzhen/O=harbor/OU=harbor/CN=myharbor.com&quot;</span> \</span><br><span class="line">    -key myharbor.com.key \</span><br><span class="line">    -out myharbor.com.csr</span><br><span class="line"><span class="comment"># 生成 x509 v3 扩展</span></span><br><span class="line"><span class="built_in">cat</span> &gt; v3.ext &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1=myharbor.com</span></span><br><span class="line"><span class="string">DNS.2=*.myharbor.com</span></span><br><span class="line"><span class="string">DNS.3=hostname</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#创建 Harbor 访问证书</span></span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -<span class="keyword">in</span> myharbor.com.csr \</span><br><span class="line">    -out myharbor.com.crt</span><br></pre></td></tr></table></figure><h3 id="15-4-创建-Namespace">15.4 创建 Namespace</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns harbor</span><br></pre></td></tr></table></figure><h3 id="15-5-创建证书秘钥">15.5 创建证书秘钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls myharbor.com --key myharbor.com.key --cert myharbor.com.crt -n harbor</span><br><span class="line">kubectl get secret myharbor.com -n harbor</span><br></pre></td></tr></table></figure><h3 id="15-6-创建证书秘钥">15.6 创建证书秘钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls myharbor.com --key myharbor.com.key --cert myharbor.com.crt -n harbor</span><br><span class="line">kubectl get secret myharbor.com -n harbor</span><br></pre></td></tr></table></figure><h3 id="15-7-添加-Chart-库">15.7 添加 Chart 库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add harbor https://helm.goharbor.io</span><br></pre></td></tr></table></figure><h3 id="15-8-通过-helm-安装-harbor">15.8 通过 helm 安装 harbor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">helm install myharbor --namespace harbor harbor/harbor \</span><br><span class="line">  --<span class="built_in">set</span> expose.ingress.hosts.core=myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> expose.ingress.hosts.notary=notary.myharbor.com \</span><br><span class="line">  --set-string expose.ingress.annotations.<span class="string">&#x27;nginx\.org/client-max-body-size&#x27;</span>=<span class="string">&quot;1024m&quot;</span> \</span><br><span class="line">  --<span class="built_in">set</span> expose.tls.secretName=myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.jobservice.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.database.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.redis.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.trivy.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.chartmuseum.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.enabled=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">set</span> externalURL=https://myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> harborAdminPassword=Harbor12345</span><br></pre></td></tr></table></figure><p>这里稍等一段时间在查看资源状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ingress,svc,pods,pvc -n harbor</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/8cc91d8f7f38e3878a95f2cfdd2b0e97.png" class=""><h3 id="15-9-ingress-没有-ADDRESS-问题解决">15.9 ingress 没有 ADDRESS 问题解决</h3><div class="note default no-icon flat"><p>【分析】:发现&quot;error: endpoints “default-http-backend” not found&quot;</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; default-http-backend.yaml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default-http-backend</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: default-http-backend</span></span><br><span class="line"><span class="string">  namespace: harbor</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 1</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: default-http-backend</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: default-http-backend</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      terminationGracePeriodSeconds: 60</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: default-http-backend</span></span><br><span class="line"><span class="string">        # Any image is permissible as long as:</span></span><br><span class="line"><span class="string">        # 1. It serves a 404 page at /</span></span><br><span class="line"><span class="string">        # 2. It serves 200 on a /healthz endpoint</span></span><br><span class="line"><span class="string">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/defaultbackend:1.4</span></span><br><span class="line"><span class="string">#        image: gcr.io/google_containers/defaultbackend:1.4</span></span><br><span class="line"><span class="string">        livenessProbe:</span></span><br><span class="line"><span class="string">          httpGet:</span></span><br><span class="line"><span class="string">            path: /healthz</span></span><br><span class="line"><span class="string">            port: 8080</span></span><br><span class="line"><span class="string">            scheme: HTTP</span></span><br><span class="line"><span class="string">          initialDelaySeconds: 30</span></span><br><span class="line"><span class="string">          timeoutSeconds: 5</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          limits:</span></span><br><span class="line"><span class="string">            cpu: 10m</span></span><br><span class="line"><span class="string">            memory: 20Mi</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            cpu: 10m</span></span><br><span class="line"><span class="string">            memory: 20Mi</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default-http-backend</span></span><br><span class="line"><span class="string">  namespace: harbor</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: default-http-backend</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - port: 80</span></span><br><span class="line"><span class="string">    targetPort: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: default-http-backend</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f default-http-backend.yaml</span><br></pre></td></tr></table></figure><h3 id="15-10-卸载重新部署">15.10 卸载重新部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">helm uninstall myharbor -n harbor</span><br><span class="line">kubectl get pvc -n harbor| awk <span class="string">&#x27;NR!=1&#123;print $1&#125;&#x27;</span> | xargs kubectl delete pvc -n harbor</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">helm install myharbor --namespace harbor harbor/harbor \</span><br><span class="line">  --<span class="built_in">set</span> expose.ingress.hosts.core=myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> expose.ingress.hosts.notary=notary.myharbor.com \</span><br><span class="line">  --set-string expose.ingress.annotations.<span class="string">&#x27;nginx\.org/client-max-body-size&#x27;</span>=<span class="string">&quot;1024m&quot;</span> \</span><br><span class="line">  --<span class="built_in">set</span> expose.tls.secretName=myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.jobservice.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.database.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.redis.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.trivy.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.persistentVolumeClaim.chartmuseum.storageClass=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> persistence.enabled=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">set</span> externalURL=https://myharbor.com \</span><br><span class="line">  --<span class="built_in">set</span> harborAdminPassword=Harbor12345</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/96d0af566e54ad097408a5adc359c13f.png" class=""><h3 id="15-11-访问-harbor">15.11 访问 harbor</h3><p><a href="https://myharbor.com">https://myharbor.com</a><br>账号/密码：admin/Harbor12345</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/3e1762d0bcae7dd07f878f626a0416d3.png" class=""><h3 id="15-12-harbor-常见操作">15.12 harbor 常见操作</h3><p>【1】创建项目 bigdata</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/002636b1b7458b85e03fa173f50a646e.png" class=""><p>【2】配置私有仓库<br>在文件/etc/docker/daemon.json添加如下内容：<br>“insecure-registries”:[“<a href="https://myharbor.com">https://myharbor.com</a>”]</p><p>重启 docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>【3】服务器上登录 harbor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker login https://myharbor.com</span><br><span class="line"><span class="comment">#账号/密码：admin/Harbor12345</span></span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/81daa0ee0ee0512128d6d393fd5c52fb.png" class=""><p>【4】打标签并把镜像上传到 harbor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag rancher/pause:3.6 myharbor.com/bigdata/pause:3.6</span><br><span class="line">docker push myharbor.com/bigdata/pause:3.6</span><br></pre></td></tr></table></figure><h3 id="15-13-修改-containerd-配置">15.13 修改 containerd 配置</h3><p>以前使用 docker-engine 的时候，只需要修改/etc/docker/daemon.json 就行，但是新版的 k8s 已经使用 containerd 了，所以这里需要做相关配置，要不然 containerd 会失败。证书（ca.crt）可以在页面上下载：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/f32230fabb5237105433ed470455534e.png" class=""><p>创建域名目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/containerd/myharbor.com</span><br><span class="line"><span class="built_in">cp</span> ca.crt /etc/containerd/myharbor.com/</span><br></pre></td></tr></table></figure><p>配置文件：/etc/containerd/config.toml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      config_path = <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.auths]</span><br><span class="line"> </span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;myharbor.com&quot;</span>.tls]</span><br><span class="line">          ca_file = <span class="string">&quot;/etc/containerd/myharbor.com/ca.crt&quot;</span></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;myharbor.com&quot;</span>.auth]</span><br><span class="line">          username = <span class="string">&quot;admin&quot;</span></span><br><span class="line">          password = <span class="string">&quot;Harbor12345&quot;</span></span><br><span class="line"> </span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.headers]</span><br><span class="line"> </span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;myharbor.com&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://myharbor.com&quot;</span>]</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/68717cd71c8ba6bd20a8089385bd9bdd.png" class=""><p>重启 containerd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重新加载配置</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment">#重启containerd</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><p>简单使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把docker换成crictl 就行，命令都差不多</span></span><br><span class="line">crictl pull myharbor.com/bigdata/mysql:5.7.38</span><br></pre></td></tr></table></figure><p>执行 crictl 报如下错误的解决办法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARN[0000] image connect using default endpoints: [unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock]. As the default settings are now deprecated, you should <span class="built_in">set</span> the endpoint instead.</span><br><span class="line">ERRO[0000] unable to determine image API version: rpc error: code = Unavailable desc = connection error: desc = <span class="string">&quot;transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory&quot;</span></span><br></pre></td></tr></table></figure><p>这个报错是 docker 的报错，这里没使用，所以这个错误不影响使用，但是还是解决好点，解决方法如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; /etc/crictl.yaml</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>再次拉取镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl pull myharbor.com/bigdata/mysql:5.7.38</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/0aa7649c0278469b6adc18fc03455520.png" class=""><h2 id="16-安装-ingress">16. 安装 ingress</h2><p>ingress 官方网站：<a href="https://kubernetes.github.io/ingress-nginx/">https://kubernetes.github.io/ingress-nginx/</a><br>ingress 仓库地址：<a href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a><br>部署文档：<a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a></p><h3 id="16-1-通过-helm-部署">16.1 通过 helm 部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx ingress-nginx \</span><br><span class="line">  --repo https://kubernetes.github.io/ingress-nginx \</span><br><span class="line">  --namespace ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure><h3 id="16-2-通过-YAML-文件安装（本章使用这个方式安装-ingress）">16.2 通过 YAML 文件安装（本章使用这个方式安装 ingress）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.0/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure><p>如果下载镜像失败，可以用以下方式修改镜像地址再安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以先把镜像下载，再安装</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.2.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span><br><span class="line"> </span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.0/deploy/static/provider/cloud/deploy.yaml</span><br><span class="line"><span class="comment"># 修改镜像地址</span></span><br><span class="line">sed -i <span class="string">&#x27;s@k8s.gcr.io/ingress-nginx/controller:v1.2.0\(.*\)@registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.2.0@&#x27;</span> deploy.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s@k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1\(.*\)$@registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1@&#x27;</span> deploy.yaml</span><br><span class="line"> </span><br><span class="line"><span class="comment">###还需要修改两地方</span></span><br><span class="line"><span class="comment">#1、kind: 类型修改成DaemonSet，replicas: 注销掉，因为DaemonSet模式会每个节点运行一个pod</span></span><br><span class="line"><span class="comment">#2、在添加一条：hostnetwork：true</span></span><br><span class="line"><span class="comment">#3、把LoadBalancer修改成NodePort</span></span><br><span class="line"><span class="comment">#4、在--validating-webhook-key下面添加- --watch-ingress-without-class=true</span></span><br><span class="line"><span class="comment">#5、设置master节点可调度</span></span><br><span class="line">kubectl taint nodes k8s-master-168-0-113 node-role.kubernetes.io/control-plane:NoSchedule-</span><br><span class="line">kubectl taint nodes k8s-master2-168-0-116 node-role.kubernetes.io/control-plane:NoSchedule-</span><br><span class="line"> </span><br><span class="line">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/e494372d95d84c0f43c98a27c61be771.png" class=""><h2 id="17-安装-nfs">17. 安装 nfs</h2><h3 id="17-1-所有节点安装-nfs">17.1 所有节点安装 nfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install  nfs-utils rpcbind</span><br></pre></td></tr></table></figure><h3 id="17-2-在-master-节点创建共享目录并授权">17.2 在 master 节点创建共享目录并授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="built_in">mkdir</span> /opt/nfsdata</span><br><span class="line"><span class="comment"># 授权共享目录</span></span><br><span class="line"><span class="built_in">chmod</span> 666 /opt/nfsdata</span><br></pre></td></tr></table></figure><h3 id="17-3-配置-exports-文件">17.3 配置 exports 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/exports&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">/opt/nfsdata *(rw,no_root_squash,no_all_squash,sync)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 配置生效</span></span><br><span class="line">exportfs -r</span><br></pre></td></tr></table></figure><p>exportfs 命令</p><div class="note default no-icon flat"><p>常用选项<br>-a 全部挂载或者全部卸载<br>-r 重新挂载<br>-u 卸载某一个目录<br>-v 显示共享目录 以下操作在服务端上</p></div><h3 id="17-4-启动-rpc-和-nfs（客户端只需要启动-rpc-服务）（注意顺序）">17.4 启动 rpc 和 nfs（客户端只需要启动 rpc 服务）（注意顺序）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs-server</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server</span><br></pre></td></tr></table></figure><p>查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">showmount -e</span><br><span class="line"><span class="comment"># VIP</span></span><br><span class="line">showmount -e 192.168.0.120</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>-e 显示 NFS 服务器的共享列表<br>-a 显示本机挂载的文件资源的情况 NFS 资源的情况<br>-v 显示版本号</p></div><h3 id="17-5-客户端">17.5 客户端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum -y install  nfs-utils rpcbind</span><br><span class="line"><span class="comment"># 启动rpc服务</span></span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line"><span class="comment"># 创建挂载目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /mnt/nfsdata</span><br><span class="line"><span class="comment"># 挂载</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.0.120:/opt/nfsdata /mnt/nfsdata     nfs    defaults  0 1&quot;</span>&gt;&gt; /etc/fstab</span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure><h3 id="17-6-rsync-数据同步">17.6 rsync 数据同步</h3><p>【1】rsync 安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两端都得安装</span></span><br><span class="line">yum -y install rsync</span><br></pre></td></tr></table></figure><p>【2】配置</p><p>在/etc/rsyncd.conf 中添加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/rsyncd.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">uid = root</span></span><br><span class="line"><span class="string">gid = root</span></span><br><span class="line"><span class="string">#禁锢在源目录</span></span><br><span class="line"><span class="string">use chroot = yes</span></span><br><span class="line"><span class="string">#监听地址</span></span><br><span class="line"><span class="string">address = 192.168.0.113</span></span><br><span class="line"><span class="string">#监听地址tcp/udp 873，可通过cat /etc/services | grep rsync查看</span></span><br><span class="line"><span class="string">port 873</span></span><br><span class="line"><span class="string">#日志文件位置</span></span><br><span class="line"><span class="string">log file = /var/log/rsyncd.log</span></span><br><span class="line"><span class="string">#存放进程 ID 的文件位置</span></span><br><span class="line"><span class="string">pid file = /var/run/rsyncd.pid</span></span><br><span class="line"><span class="string">#允许访问的客户机地址</span></span><br><span class="line"><span class="string">hosts allow = 192.168.0.0/16</span></span><br><span class="line"><span class="string">#共享模块名称</span></span><br><span class="line"><span class="string">[nfsdata]</span></span><br><span class="line"><span class="string">#源目录的实际路径</span></span><br><span class="line"><span class="string">path = /opt/nfsdata</span></span><br><span class="line"><span class="string">comment = Document Root of www.kgc.com</span></span><br><span class="line"><span class="string">#指定客户端是否可以上传文件，默认对所有模块为 true</span></span><br><span class="line"><span class="string">read only = yes</span></span><br><span class="line"><span class="string">#同步时不再压缩的文件类型</span></span><br><span class="line"><span class="string">dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z</span></span><br><span class="line"><span class="string">#授权账户，多个账号以空格分隔，不加则为匿名，不依赖系统账号</span></span><br><span class="line"><span class="string">auth users = backuper</span></span><br><span class="line"><span class="string">#存放账户信息的数据文件</span></span><br><span class="line"><span class="string">secrets file = /etc/rsyncd_users.db</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>配置 rsyncd_users.db</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/rsyncd_users.db&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">backuper:123456</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#官方要求，最好只是赋权600！</span></span><br><span class="line"><span class="built_in">chmod</span> 600 /etc/rsyncd_users.db</span><br></pre></td></tr></table></figure><p>【3】rsyncd.conf 常用参数详解</p><p>rsyncd.conf 参数</p><table><thead><tr><th>rsyncd.conf 参数</th><th>参数说明</th></tr></thead><tbody><tr><td>uid=root</td><td>rsync 使用的用户。</td></tr><tr><td>gid=root</td><td>rsync 使用的用户组（用户所在的组）</td></tr><tr><td>use chroot=no</td><td>如果为 true，daemon 会在客户端传输文件前“chroot to the path”。这是一种安全配置，因为我们大多数都在内网，所以不配也没关系</td></tr><tr><td>max connections=200</td><td>设置最大连接数，默认 0，意思无限制，负值为关闭这个模块</td></tr><tr><td>timeout=400</td><td>默认为 0，表示 no timeout，建议 300-600（5-10 分钟）</td></tr><tr><td>pid file</td><td>rsync daemon 启动后将其进程 pid 写入此文件。如果这个文件存在，rsync 不会覆盖该文件，而是会终止</td></tr><tr><td>lock file</td><td>指定 lock 文件用来支持“max connections”参数，使得总连接数不会超过限制</td></tr><tr><td>log file</td><td>不设或者设置错误，rsync 会使用 rsyslog 输出相关日志信息</td></tr><tr><td>ignore errors</td><td>忽略 I/O 错误</td></tr><tr><td>read only=false</td><td>指定客户端是否可以上传文件，默认对所有模块为 true</td></tr><tr><td>list=false</td><td>是否允许客户端可以查看可用模块列表，默认为可以</td></tr><tr><td>hosts allow</td><td>指定可以联系的客户端主机名或和 ip 地址或地址段，默认情况没有此参数，即都可以连接</td></tr><tr><td>hosts deny</td><td>指定不可以联系的客户端主机名或 ip 地址或地址段，默认情况没有此参数，即都可以连接</td></tr><tr><td>auth users</td><td>指定以空格或逗号分隔的用户可以使用哪些模块，用户不需要在本地系统中存在。默认为所有用户无密码访问</td></tr><tr><td>secrets file</td><td>指定用户名和密码存放的文件，格式；用户名；密码，密码不超过 8 位</td></tr><tr><td>[backup]</td><td>这里就是模块名称，需用中括号扩起来，起名称没有特殊要求，但最好是有意义的名称，便于以后维护</td></tr><tr><td>path</td><td>这个模块中，daemon 使用的文件系统或目录，目录的权限要注意和配置文件中的权限一致，否则会遇到读写的问题</td></tr></tbody></table><p>【4】rsync 常用命令参数详解</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rsync --<span class="built_in">help</span></span><br><span class="line"> </span><br><span class="line">rsync [选项]  原始位置   目标位置</span><br><span class="line"> </span><br><span class="line">常用选项    说明</span><br><span class="line">-r    递归模式，包含目录及子目录中的所有文件</span><br><span class="line">-l    对于符号链接文件仍然复制为符号链接文件</span><br><span class="line">-v    显示同步过程的详细信息</span><br><span class="line">-z    在传输文件时进行压缩goD</span><br><span class="line">-p    保留文件的权限标记</span><br><span class="line">-a    归档模式，递归并保留对象属性，等同于-rlpt</span><br><span class="line">-t    保留文件的时间标记</span><br><span class="line">-g    保留文件的属组标记（仅超级用户使用）</span><br><span class="line">-o    保留文件的属主标记（仅超级用户使用）</span><br><span class="line">-H    保留硬链接文件</span><br><span class="line">-A    保留ACL属性信息</span><br><span class="line">-D    保留设备文件及其他特殊文件</span><br><span class="line">--delete  删除目标位置有而原始位置没有的文件</span><br><span class="line">--checksum  根据对象的校验和来决定是否跳过文件</span><br></pre></td></tr></table></figure><p>【5】启动服务（数据源机器）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rsync监听端口：873</span></span><br><span class="line"><span class="comment">#rsync运行模式：C/S</span></span><br><span class="line">rsync --daemon --config=/etc/rsyncd.conf</span><br><span class="line">netstat -tnlp|grep :873</span><br></pre></td></tr></table></figure><p>【6】执行命令同步数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在目的机器上执行</span></span><br><span class="line"><span class="comment"># rsync -avz 用户名@源主机地址/源目录 目的目录</span></span><br><span class="line">rsync -avz root@192.168.0.113:/opt/nfsdata/* /opt/nfsdata/</span><br></pre></td></tr></table></figure><p>【7】crontab 定时同步</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置crontab， 每五分钟同步一次，这种方式不好</span></span><br><span class="line">*/5 * * * * rsync -avz root@192.168.0.113:/opt/nfsdata/* /opt/nfsdata/</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>【温馨提示】crontab 定时同步数据不太好，可以使用rsync+inotify做数据实时同步</p></div><h2 id="18-创建-nfs-provisioner-和持久化存储-SC">18. 创建 nfs provisioner 和持久化存储 SC</h2><p>GitHub 地址：<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p><p>helm 部署 nfs-subdir-external-provisioner</p><h3 id="18-1-添加-helm-仓库">18.1 添加 helm 仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br></pre></td></tr></table></figure><h3 id="18-2-helm-安装-nfs-provisioner">18.2 helm 安装 nfs provisioner</h3><div class="note default no-icon flat"><p>【温馨提示】默认镜像是无法访问的，这里使用 dockerhub 搜索到的镜像willdockerhub/nfs-subdir-external-provisioner:v4.0.2，还有就是 StorageClass 不分命名空间，所有命名空间下都可以使用。</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \</span><br><span class="line">  --namespace=nfs-provisioner \</span><br><span class="line">  --create-namespace \</span><br><span class="line">  --<span class="built_in">set</span> image.repository=willdockerhub/nfs-subdir-external-provisioner \</span><br><span class="line">  --<span class="built_in">set</span> image.tag=v4.0.2 \</span><br><span class="line">  --<span class="built_in">set</span> replicaCount=2 \</span><br><span class="line">  --<span class="built_in">set</span> storageClass.name=nfs-client \</span><br><span class="line">  --<span class="built_in">set</span> storageClass.defaultClass=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">set</span> nfs.server=192.168.0.120 \</span><br><span class="line">  --<span class="built_in">set</span> nfs.path=/opt/nfsdata</span><br></pre></td></tr></table></figure><div class="note default no-icon flat"><p>【温馨提示】上面 nfs.server 设置为 VIP，可实现高可用。</p></div><h3 id="18-3-查看">18.3 查看</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods,deploy,sc -n nfs-provisioner</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220919/kubernetes-20220919-19-kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/6baa996d736465256fc941b39c1fc1df.png" class="">]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>18.devops</title>
      <link href="/20220915/kubernetes-20220915-18-devops/"/>
      <url>/20220915/kubernetes-20220915-18-devops/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-18">1. 简介</h2><p>开发运维一体化<br>CI/CD持续集成，持续交付</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/devops.png" class=""><h2 id="2-部署harbor服务器">2. 部署harbor服务器</h2><h3 id="2-1-安装docker-ce">2.1 安装docker-ce</h3><p>通过文章<a href="https://renm.cc/20220119/docker-20220119-docker%E5%AE%89%E8%A3%85%E5%92%8C%E5%8A%A0%E9%80%9F/">docker安装和加速</a>安装docker-ce</p><h3 id="2-2-安装harbor">2.2 安装harbor</h3><p>通过文章<a href="https://renm.cc/20220717/containerd-20220717-4-harbor/">harbor</a>安装harbor</p><h3 id="2-3-集群节点配置私有harbor">2.3 集群节点配置私有harbor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;192.168.10.251&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;http://192.168.10.251&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>重启服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h2 id="3-部署ops服务器">3. 部署ops服务器</h2><h3 id="3-1-安装docker">3.1 安装docker</h3><p>通过文章<a href="https://renm.cc/20220119/docker-20220119-docker%E5%AE%89%E8%A3%85%E5%92%8C%E5%8A%A0%E9%80%9F/">docker安装和加速</a>安装docker-ce</p><h3 id="3-2-配置docker">3.2 配置docker</h3><p>配置私有harbor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry=192.168.10.252 -H tcp://0.0.0.0:2376 -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><p><strong>重启docker</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docke</span><br></pre></td></tr></table></figure><h3 id="3-2-安装gitlab">3.2 安装gitlab</h3><p><strong>下载镜像</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull beginor/gitlab-ce</span><br></pre></td></tr></table></figure><p><strong>部署</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/gitlab/etc /data/gitlab/log /data/gitlab/data</span><br><span class="line"><span class="built_in">chmod</span> 777 /data/gitlab/etc /data/gitlab/log /data/gitlab/data/</span><br><span class="line"></span><br><span class="line">docker run -dit --name=gitlab --restart=always -p 8443:443 -p 80:80 -p 222:22 -v /data/gitlab/etc:/etc/gitlab -v /data/gitlab/log:/var/log/gitlab -v /data/gitlab/data:/var/opt/gitlab --privileged=<span class="literal">true</span> beginor/gitlab-ce</span><br></pre></td></tr></table></figure><p><strong>修改一下两处位置</strong><br>1.用 vim 编辑器修改/data/gitlab/etc/gitlab.rb 以下几处内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">external_url <span class="string">&#x27;http://192.168.26.9&#x27;</span> </span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_ssh_host&#x27;</span>] = <span class="string">&#x27;192.168.26.9&#x27;</span> </span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 222</span><br></pre></td></tr></table></figure><p>2.用 vim 编辑修改/data/gitlab/data/gitlab-rails/etc/gitlab.yml 以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gitlab:</span><br><span class="line">  <span class="comment">## Web server settings (note: host is the FQDN, do not include http://)</span></span><br><span class="line">  host: 192.168.26.9</span><br><span class="line">  port: 80</span><br><span class="line">  https: <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><strong>重启</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart gitlab</span><br></pre></td></tr></table></figure><p>在浏览器里输入 192.168.26.9，会让我们为 root 用户设置新的密码</p><p>如果密码设置的没有满足一定的复杂性，则会有如下报错</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/gitlab2.png" class=""><p>登录之后，点击创建一个项目</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/gitlab3.png" class=""><p>然后在项目名称位置写入 p1，可见登记选中公开，然后点击创建项目</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/gitlab5.png" class=""><p>然后点击复制按钮获取 clone 的链接：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/gitlab6.png" class=""><p><strong>在客户端上测试</strong><br>用命令 yum install git -y 安装 git 客户端软件，然后用 git clone 把此项目的版本库克隆下来：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@vms9 ~]<span class="comment"># git clone http://192.168.26.9/root/p1.git</span></span><br><span class="line">正克隆到 <span class="string">&#x27;p1&#x27;</span>... warning: 您似乎克隆了一个空版本库。</span><br></pre></td></tr></table></figure><p><strong>设置一些变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vms9 ~]<span class="comment"># cd p1/</span></span><br><span class="line">[root@vms9 p1]<span class="comment"># git config --global user.name &quot;lduan&quot;</span></span><br><span class="line">[root@vms9 p1]<span class="comment"># git config --global user.email lduan@example.com</span></span><br><span class="line">[root@vms9 p1]<span class="comment"># git config --global push.default simple</span></span><br><span class="line">[root@vms9 p1]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><strong>创建 index.html 并推送到代码仓库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@vms9 p1]<span class="comment"># echo 1111 &gt; index.html</span></span><br><span class="line">[root@vms9 p1]<span class="comment"># git add . [root@vms9 p1]# git commit -m 111</span></span><br><span class="line">[root@vms9 p1]<span class="comment"># git push</span></span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://192.168.26.9&#x27;</span>: root</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://root@192.168.26.9&#x27;</span>:</span><br><span class="line">Counting objects: 3, <span class="keyword">done</span>. Writing objects: 100% (3/3), 207 bytes | 0 bytes/s, <span class="keyword">done</span>. Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">To http://192.168.26.9/root/p1.git * [new branch] master -&gt; master</span><br><span class="line">[root@vms9 p1]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>至此，gitlab 配置完毕</p><h3 id="3-3-安装jenkins">3.3 安装jenkins</h3><p>把 jenkins 的镜像下载下来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins:2.249.2-lts-centos7</span><br></pre></td></tr></table></figure><p>创建数据卷所需要的目录，并把所有者和所属组改为 1000</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /jenkins ; <span class="built_in">chown</span> 1000.1000 /jenkins</span><br></pre></td></tr></table></figure><p>这里为什么要改成 1000，是因为容器里是以 jenkins 用户的身份去读写数据，而在容器里<br>jenkins 的 uid 是 1000，可以看下此镜像的 Dockerfile 内容</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins1.png" class=""><p><strong>创建 jenkins容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit -p 8080:8080 -p 50000:50000 --name jenkins --privileged=<span class="literal">true</span> --restart=always -v /jenkins:/var/jenkins_home jenkins/jenkins:2.289.2-lts-centos7</span><br></pre></td></tr></table></figure><p>打开浏览器，输入 192.168.10.252:8080</p><p>记住，此时一定要先打开浏览器打开这个页面，让其初始化一下，直到看到界面<br>cat /jenkins/secrets/initialAdminPassword</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins2.png" class=""><p>因为要修改 jenkins 的配置，所以此时关闭 jenkins 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop jenkins</span><br></pre></td></tr></table></figure><p>然后用 vim 编辑打开/jenkins/hudson.model.UpdateCenter.xml，按如下修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.1&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br></pre></td></tr></table></figure><p>改为</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.1&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mirrors.tuna.tsinghua.edu.cn/jenkins<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br></pre></td></tr></table></figure><p>用 vim 编辑器打开/jenkins/updates/default.json<br>{“connectionCheckUrl”:“<a href="http://www.google.com/">http://www.google.com/</a>” 改成<br>{“connectionCheckUrl”:“<a href="http://www.baidu.com/">http://www.baidu.com/</a>”</p><p>sed -i ‘s/google/baidu/’ /jenkins/updates/default.json</p><p><strong>再次启动 jenkins</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start jenkins</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins3.png" class=""><p>直到所有插件全部安装完成</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins4.png" class=""><p>填写必要的网络信息，点击保存并完成</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins5.png" class=""><h3 id="3-4-安装-docker-插件">3.4 安装 docker 插件</h3><p>在 jenkins 主页面依次点击左侧的系统管理-插件管理-可选插件，在搜索栏搜索 docker，选中 docker 和 docker-build-step，然后点击下面的直接安装</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins6.png" class=""><p>点击下面的直接安装</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins7.png" class=""><p>点击返回首页，再依次点击系统管理-节点管理-Configure Clouds</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins8.png" class=""><p>在 add a new cloud 里选择 docker 之后页面跳转到如下页</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins9.png" class=""><p>点击 docker cloud details，输入 tcp://192.168.10.251:2376，然后点击 test connection</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins10.png" class=""><p>可以看到当前 docker 的信息，点击最下面的 save。</p><p>在 jenkins 首页，依次点击系统管理-系统配置，找到 docker build，在 docker build 里输入tcp://192.168.26.9:2376，点击 test connection</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins11.png" class=""><p>点击最下面的保存，这样 jenkins 就和 docker 关联起来了。</p><h3 id="3-5-jenkins-安全设置">3.5 jenkins 安全设置</h3><p>后面 gitlab 要和 jenkins 进行联动，所以必须要需要对 jenkins 的安全做一些设置，依次点击系统管理-全局安全配置-授权策略，勾选&quot;匿名用户具有可读权限&quot;</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins12.png" class=""><p>注意下面的的跨站点伪造保护(CSFR)请求必须要关闭，但是在Jenkins版本自2.2xx版本之后，<br>在 web 界面里已经没法关闭了：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins13.png" class=""><p>所以在当前 web 界面里暂且不要管它，点击下面的保存</p><p>gitlab 要触发 jenkins 的话，就必须要关闭跨站点伪造请求，web 界面里已经没法关闭了，<br>所以要需要做如下设置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -u root -it jenkins bash</span><br><span class="line"></span><br><span class="line">vi /usr/local/bin/jenkins.sh</span><br><span class="line">找到 <span class="built_in">exec</span> java 那行(大概是在第 37 行)，添加</span><br><span class="line">-Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=<span class="literal">true</span></span><br><span class="line"><span class="built_in">exec</span> java -Duser.home=<span class="string">&quot;<span class="variable">$JENKINS_HOME</span>&quot;</span></span><br><span class="line">-Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=<span class="literal">true</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$&#123;java_opts_array[@]&#125;</span>&quot;</span> -jar <span class="variable">$&#123;JENKINS_WAR&#125;</span> <span class="string">&quot;<span class="variable">$&#123;jenkins_opts_array[@]&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>然后重启 jenkins 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart jenki</span><br></pre></td></tr></table></figure><p>再次登录到 web 界面查看 跨站点伪造请求的设置</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-18-devops/jenkins14.png" class=""><p>这里已经是关闭了</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>17.资源请求与限制</title>
      <link href="/20220915/kubernetes-20220915-17-%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%99%90%E5%88%B6/"/>
      <url>/20220915/kubernetes-20220915-17-%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-17">1. 简介</h2><p>在kubernetets系统上，1个单位的CPU相当于虚拟机上的一颗虚拟CPU（vCPU）或者物理机上的一个超线程（HyperThread，或者称一个逻辑（CPU），它支持分数计量方式，一个核心（1core）相当于1000个微核心（millicores），因此500m相当于是0.5个核心，即二分之一个核心</p><h2 id="2-resource字段来限制">2. resource字段来限制</h2><p>创建pod做资源限制</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1-new</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#serviceAccount: sa1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span> </span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>requests —容器所在节点 资源的最小值<br>limits —容器消耗资源最大值</p></div><h2 id="3-limitrange限制">3. limitrange限制</h2><p>如果容器里没有声明请求和限制则使用默认的请求和限制如果容器内没有声明最大值最小值则使用这里设置的<br>如果容器里声明了请求和限制大于或者小于 limitrange里的max或者min，都会导致pod创建不成功。<br>容器申请的资源不能超过limit</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220915/kubernetes-20220915-17-%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%99%90%E5%88%B6/limitrange.png" class=""><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-min-max-demo-lr</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap12-safe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure><p><strong>查看资源</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 aa]<span class="comment"># kubectl describe limitranges mem-min-max-demo-lr </span></span><br><span class="line">Name:       mem-min-max-demo-lr</span><br><span class="line">Namespace:  chap12-safe</span><br><span class="line">Type        Resource  Min    Max  Default Request  Default Limit  Max Limit/Request Ratio</span><br><span class="line">----        --------  ---    ---  ---------------  -------------  -----------------------</span><br><span class="line">Container   memory    512Mi  1Gi  1Gi              1Gi            -</span><br></pre></td></tr></table></figure><h2 id="4-resourcequota">4. resourcequota</h2><p>limitrange 用来限制每个pod的资源<br>resourcequtoa 用来限制一个ns里可以使用多少资源</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myquota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure><p><strong>查看资源</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 aa]<span class="comment"># kubectl get resourcequotas </span></span><br><span class="line">NAME      AGE   REQUEST                                                                                                                                              LIMIT</span><br><span class="line">myquota   7s    configmaps: 1/10, persistentvolumeclaims: 0/4, pods: 5/4, replicationcontrollers: 0/20, secrets: 1/10, services: 1/10, services.loadbalancers: 1/2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>16.认证授权</title>
      <link href="/20220914/kubernetes-20220914-16-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/"/>
      <url>/20220914/kubernetes-20220914-16-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h2 id="1-认证">1. 认证</h2><h3 id="1-1-token登录">1.1 token登录</h3><h4 id="1-1-1-生成token">1.1.1 生成token</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 10</span><br></pre></td></tr></table></figure><h4 id="1-1-2-创建认证文件">1.1.2 创建认证文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/kubernetes/pki/ren.csv</span><br><span class="line">d4cd5cf1f44fc9232f4c,ren,3</span><br></pre></td></tr></table></figure><h4 id="1-1-3-修改kube-api配置">1.1.3 修改kube-api配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- --token-auth-file=/etc/kubernetes/pki/ren.csv</span><br></pre></td></tr></table></figure><h4 id="1-1-4-重启kubelet">1.1.4 重启kubelet</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure><h4 id="1-1-5-登录">1.1.5 登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -s https://172.17.203.55:6443 --insecure-skip-tls-verify=<span class="literal">true</span> --token=<span class="string">&quot;d4cd5cf1f44fc9232f4c&quot;</span> get nodes</span><br></pre></td></tr></table></figure><h3 id="1-2-kubeconfig登录">1.2 kubeconfig登录</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node001</span> <span class="string">chap11-helm</span>]<span class="comment"># kubectl config view</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://172.17.203.55:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">chap11-helm</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>kubeconfig文件由3部分组成<br>1.集群信息<br> 1.集群的证书<br> 2.集群的地址<br>2.上下文信息<br> 1.集群信息<br> 2.用户</p><p>3.用户信息<br> 1.用户的证书<br> 2.用户的私钥</p></div><h4 id="1-2-1-创建kubeconfig">1.2.1 创建kubeconfig</h4><p><strong>复制ca</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/kubernetes/pki/ca.crt .</span><br></pre></td></tr></table></figure><p><strong>创建私钥</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ren.key 2048</span><br></pre></td></tr></table></figure><p><strong>生成证书请求文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key ren.key -subj <span class="string">&quot;/CN=ren&quot;</span> -out ren.csr</span><br></pre></td></tr></table></figure><p><strong>转为base64</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ren.csr |<span class="built_in">base64</span>|<span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure><p><strong>创建证书申请yaml</strong><br>[root@node001 aa]# cat csr.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">certificates.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ren</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:authenticated</span></span><br><span class="line">  <span class="attr">signerName:</span> <span class="string">kubernetes.io/kube-apiserver-client</span></span><br><span class="line">  <span class="attr">request:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1V6Q0NBVHNDQVFBd0RqRU1NQW9HQTFVRUF3d0RjbVZ1TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQwpBUThBTUlJQkNnS0NBUUVBclpkYjNuamVGaTUyUW8veU12cnZaQUUxLzZaaVI2MnVya0ZFV1pUdVVrbFN4MnlvClZZNW01NEkyV05mWE15WDExakxpT1lmamhpd0RrWldnbURhQUE2UjlncU04NTFkbDhLR1l0a3VpbVZhbzZhMXEKM3ROb3VyMG91ZU1OalFZZ0YvOUtNTWM3bFJ4bUM3R1RpSWhKdEpVMGJuZzdnUkdEUm1SMDZITXIzQjB3OFpWTgpoSVYrVGV5UTI4VkloUnBuVjcxaFUyYzVqWkhrdnBrQVRsb0lyS0tXU3JjNWRrVHVWTVBXRnYvUGRDOFoxNXRICjl5a3crSWQybDdsaUpwMWJLRS9rVlBQWEFyelZBWnZiaWVUZmN0aEVmckR5aUt0Y2dQWnNxdkJ2UjlBTDYrUUoKUGllQ0toUEtDRVNDUnVUbDA4U3BXdXhMaVhXY3NLc095WFFlL3dJREFRQUJvQUF3RFFZSktvWklodmNOQVFFTApCUUFEZ2dFQkFFWWJPcTFrdHlobGdMRWc0Ukd6cFRWZUJQVWZ3Q1VacnpHU2pjcGhsNWIrb0FaNVV0czBaS1hpClE1KzdpaUdnUng3Rm5sb2FwL0g1ck91Z2tjd2JmSU5kc3JWT2crOVJJc1JCK1N3QTZBRmhTcnBVNndDT2JDOUQKMlBYVlpnZmlyS1BXcy9EK01nNnFXdmNscVpiVDg0WmJUaGUzWnB2OFFyNDdNVklwbVdPWld6dnJ3bWNKZDFnQgp2L29iMUJ0Zm9JSUc4OFpkS2N0dGh6MXhmREFSRFFSWWhxaEtkVUV2TUNBUC9mcmRoQXkvUEsrdG9RUnR6a05MCi8wRjFTNUFCR0dSTTdNSXN6OEMydUg5cGxIS3RWS0xYZWxLWnZCUVZJU0Z5MGt5R21Ia3VMWWp5UXB6WVVYNlcKbjlFY2tBUVpPQ0dhVG5XWlRCRjVVTnBxcTVXelRBcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">client</span> <span class="string">auth</span></span><br></pre></td></tr></table></figure><p><strong>查看证书申请</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 aa]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME   AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">ren    25s   kubernetes.io/kube-apiserver-client   kubernetes-admin   &lt;none&gt;              Pending</span><br></pre></td></tr></table></figure><p><strong>审批</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl certificate approve ren</span><br></pre></td></tr></table></figure><p><strong>查看csr</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr ren -o yaml</span><br></pre></td></tr></table></figure><p><strong>生成证书文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM5RENDQWR5Z0F3SUJBZ0lSQUs1bHdyVmUxZ1pocGp2SEZlaURvYUl3RFFZSktvWklodmNOQVFFTEJRQXcKRlRFVE1CRUdBMVVFQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UUXdOalU1TURGYUZ3MHlNekE1TVRRdwpOalU1TURGYU1BNHhEREFLQmdOVkJBTVRBM0psYmpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDCkFRb0NnZ0VCQUsyWFc5NTQzaFl1ZGtLUDhqTDY3MlFCTmYrbVlrZXRycTVCUkZtVTdsSkpVc2RzcUZXT1p1ZUMKTmxqWDF6TWw5ZFl5NGptSDQ0WXNBNUdWb0pnMmdBT2tmWUtqUE9kWFpmQ2htTFpMb3BsV3FPbXRhdDdUYUxxOQpLTG5qRFkwR0lCZi9TakRITzVVY1pndXhrNGlJU2JTVk5HNTRPNEVSZzBaa2RPaHpLOXdkTVBHVlRZU0ZmazNzCmtOdkZTSVVhWjFlOVlWTm5PWTJSNUw2WkFFNWFDS3lpbGtxM09YWkU3bFREMWhiL3ozUXZHZGViUi9jcE1QaUgKZHBlNVlpYWRXeWhQNUZUejF3SzgxUUdiMjRuazMzTFlSSDZ3OG9pclhJRDJiS3J3YjBmUUMrdmtDVDRuZ2lvVAp5Z2hFZ2tiazVkUEVxVnJzUzRsMW5MQ3JEc2wwSHY4Q0F3RUFBYU5HTUVRd0V3WURWUjBsQkF3d0NnWUlLd1lCCkJRVUhBd0l3REFZRFZSMFRBUUgvQkFJd0FEQWZCZ05WSFNNRUdEQVdnQlRtZ2dsVFhOU1NFczNJU2xscHYxUkMKQ21tb0JqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFGZ3pxZ0piRzVUMDJFdXpNbnBDV0tTclJNaTdXRUxiRQoxYU5IV3RQaTZpTmQyWjk5TlVweW1uUUlIVXBNTnp6ck9UeXpkSTdRRE5sVUdFUFVRS0d0eGUwUjNYbkpoaXdZCklOY1Bzc240dGtqNWk5S0E4d2t3R1NwcEpROG5vT1lPWUZFRUtjZWNMOFE4N0RPRWNhWllSeW41RlZxZWNKTUkKZXZ2QThQdGp0M09RUEw3SjhiUkczeTRqYXV1NkZ3bE43U2paOGRxNlAvcWY4OWx3SkZ1dkdjVTBlNHdxWTBkQwp3Ym1peDNEYlkwSlIwVDk0eTg0RVZzeTFrOVF1MnhYU2R3Q3YyK09KdlBEa0d0V1NiU3VBRFBlLzZWWkg1Q2dICmVuNml3cDNFenFET0VXVG9sYUhwMis2R0dLcVlMQVNQRnBnUTg0RmQvSkt2UjE3ckNoKzlzUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K|<span class="built_in">base64</span> -d &gt; ren.crt</span><br></pre></td></tr></table></figure><p><strong>生成kubeconfig</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config --kubeconfig=kc1 set-cluster cluster1 --server=https://192.168.10.31:6443 --certificate-authority=ca.crt --embed-certs=<span class="literal">true</span></span><br><span class="line">kubectl config --kubeconfig=kc1 set-credentials ren --client-certificate=ren.crt --client-key=ren.key --embed-certs=<span class="literal">true</span></span><br><span class="line">kubectl config --kubeconfig=kc1 set-context context1 --cluster=cluster1 --namespace=default --user=ren</span><br></pre></td></tr></table></figure><p><strong>使用kubeconfig</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig kc1 get pod</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User <span class="string">&quot;ren&quot;</span> cannot list resource <span class="string">&quot;pods&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure><h2 id="2-授权">2. 授权</h2><h3 id="2-1-了解授权">2.1 了解授权</h3><pre><code>- --authorization-mode=Node,RBAC- --authorization-mode=AlwaysAllow #允许所有请求- --authorization-mode=AlwaysDeny #拒绝所有请求- --authorization-mode=ABACAttribute-Based Access Control 不够灵活放弃- --authorization-mode=RBACRole Based Access Control - --authorization-mode=NodeNode授权器主要用于各个node上的kubelet访问apiserver时使用的，其他一般均由RBAC授权器来授权</code></pre><h3 id="2-2-role管理">2.2 role管理</h3><p><strong>创建role1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create role role1 --verb get,list --resource=pod,svc</span><br></pre></td></tr></table></figure><p><strong>查看role1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 aa]<span class="comment"># kubectl describe role role1 </span></span><br><span class="line">Name:         role1</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------  -----------------  --------------  -----</span><br><span class="line">  pods       []                 []              [get list]</span><br><span class="line">  services   []                 []              [get list]</span><br></pre></td></tr></table></figure><p><strong>生成yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create role role1 --verb get,list --resource=pod,svc --dry-run=client -o yaml &gt; role1.yaml</span><br></pre></td></tr></table></figure><p>根据需求修改权限</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role1</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;apps&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br></pre></td></tr></table></figure><h3 id="2-3-创建rolebinding">2.3 创建rolebinding</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding rbind1 --role role1 --user ren</span><br></pre></td></tr></table></figure><p><strong>查看</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node001</span> <span class="string">aa</span>]<span class="comment"># kubectl get rolebindings.rbac.authorization.k8s.io rbind1 -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-14T10:04:28Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbind1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap12-safe</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;674021&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">92aa36a2-f558-4e63-a738-c787acf236b8</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role1</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ren</span></span><br></pre></td></tr></table></figure><h3 id="2-4-验证">2.4 验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 aa]<span class="comment"># kubectl --kubeconfig kc1 get pod</span></span><br><span class="line">No resources found <span class="keyword">in</span> chap12-safe namespace.</span><br><span class="line"></span><br><span class="line">[root@node003 ~]<span class="comment"># kubectl -s https://172.17.203.55:6443 --insecure-skip-tls-verify=true --token=&quot;d4cd5cf1f44fc9232f4c&quot; -n chap12-safe get pod</span></span><br><span class="line">No resources found <span class="keyword">in</span> chap12-safe namespace.</span><br></pre></td></tr></table></figure><h2 id="3-serviceaccount">3. serviceaccount</h2><p>k8s集群有两种账户</p><p>user account 用户账户 —用于登录kubernetes<br>service account 服务账户 —主要用于对pod里的进程进行授权</p><p>pod都要以某个sa账号运行，默认使用default这个sa，每个ns里都会自动创建一个default</p><div class="note primary no-icon flat"><p>1.20（含）之前的版本<br>每创建一个sa，都会生成一个secret，这个secret里包含了一个token，在pod里加载这个token</p><p>1.21~1.23之间的版本<br>每创建一个sa，都会生成一个secret，这个secret里包含一个token，在pod里并不使用这个token，而是由kubelet去申请一个新的</p><p>1.24开始<br>每创建一个sa，不会再生成secret，再pod里会由kubelet去申请</p></div><h3 id="3-1-创建sa账号">3.1 创建sa账号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa sa1</span><br></pre></td></tr></table></figure><h3 id="3-2-绑定管理员">3.2 绑定管理员</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding sabind1 --clusterrole cluster-admin --serviceaccount chap12-safe:sa1</span><br></pre></td></tr></table></figure><h3 id="3-3-测试权限">3.3 测试权限</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --as=system:serviceaccount:default:sa1 auth can-i  get pods</span><br></pre></td></tr></table></figure><h3 id="3-4-创建secret">3.4 创建secret</h3><p>[root@node001 aa]# cat sa1-secret.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa1</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-account.name:</span> <span class="string">&quot;sa1&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-5-获取token">3.5 获取token</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets sa1 -o jsonpath=&#123;.data.token&#125;|<span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure><h3 id="3-6-登录dashboard">3.6 登录dashboard</h3><p>使用token登录dashboard</p><h3 id="3-7-pod指定sa账号">3.7 pod指定sa账号</h3><h4 id="3-7-1-创建sa">3.7.1 创建sa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa sa1</span><br></pre></td></tr></table></figure><h4 id="3-7-2-创建权限">3.7.2 创建权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create role r2 --verb list,get --resource pod,service</span><br></pre></td></tr></table></figure><h4 id="3-7-3-绑定权限">3.7.3 绑定权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding rbind2 --role r2 --serviceaccount default:sa1</span><br></pre></td></tr></table></figure><h4 id="3-7-4-pod指定sa">3.7.4 pod指定sa</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod3</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">sa1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-7-5-验证">3.7.5 验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@pod3:/run/secrets/kubernetes.io/serviceaccount<span class="comment"># CA_CERT=ca.crt</span></span><br><span class="line">root@pod3:/run/secrets/kubernetes.io/serviceaccount<span class="comment"># TOKEN=$(cat token)</span></span><br><span class="line">root@pod3:/run/secrets/kubernetes.io/serviceaccount<span class="comment"># curl --cacert $CA_CERT -H &quot;Authorization: Bearer $TOKEN&quot; &quot;https://kubernetes.default/api/v1/namespaces/default/services/svc1&quot;</span></span><br></pre></td></tr></table></figure><h4 id="3-7-6-取消投射卷">3.7.6 取消投射卷</h4><p><strong>pod中</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod3</span><br><span class="line">  name: pod3</span><br><span class="line">spec:</span><br><span class="line">  serviceAccount: sa1</span><br><span class="line">  automountServiceAccountToken: <span class="literal">false</span></span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod3</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>sa中</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">automountServiceAccountToken: <span class="literal">false</span></span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: sa1</span><br><span class="line">root@vms41:</span><br></pre></td></tr></table></figure><h3 id="3-8-用户使用sa">3.8 用户使用sa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRV</span><br><span class="line">    server: https://192.168.26.40:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    token: eyJhbGciOiJSUzI1NiIs</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>15.helm</title>
      <link href="/20220913/kubernetes-20220913-15-helm/"/>
      <url>/20220913/kubernetes-20220913-15-helm/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-16">1. 简介</h2><p>helm的作用就是把许多的定义比如svc，deployment，seucrt一次性全部定义好，放在源里统一管理，方便部署到其他集群上。</p><h2 id="2-安装helm">2. 安装helm</h2><p><a href="https://github.com/helm/helm/releases/tag/v3.2.1">https://github.com/helm/helm/releases/tag/v3.2.1</a></p><p>tar zxf helm-v3.2.1-linux-amd64.tar.gz<br>mv linux-amd64/helm /usr/local/bin/</p><p>编辑/etc/profile<br>source &lt;(helm completion bash)<br>保存退出<br>source /etc/profil</p><h2 id="3-helm仓库">3. helm仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br><span class="line"></span><br><span class="line">helm repo add azure http://mirror.azure.cn/kubernetes/charts/</span><br><span class="line">helm repo add github https://burdenbear.github.io/kube-charts-mirror</span><br><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure><h2 id="4-实例">4. 实例</h2><h3 id="4-1-搜索镜像">4.1 搜索镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap11-helm]<span class="comment"># helm search repo mysql</span></span><br><span class="line">NAME                           CHART VERSIONAPP VERSIONDESCRIPTION                                       </span><br><span class="line">azure/mysql                    1.6.9        5.7.30     DEPRECATED - Fast, reliable, scalable, and easy...</span><br><span class="line">azure/mysqldump                2.6.2        2.4.1      DEPRECATED! - A Helm chart to <span class="built_in">help</span> backup MySQL...</span><br><span class="line">azure/prometheus-mysql-exporter0.7.1        v0.11.0    DEPRECATED A Helm chart <span class="keyword">for</span> prometheus mysql ex...</span><br><span class="line">stable/mysql                   0.3.5                   Fast, reliable, scalable, and easy to use open-...</span><br><span class="line">azure/percona                  1.2.3        5.7.26     DEPRECATED - free, fully compatible, enhanced, ...</span><br><span class="line">azure/percona-xtradb-cluster   1.0.8        5.7.19     DEPRECATED - free, fully compatible, enhanced, ...</span><br><span class="line">azure/phpmyadmin               4.3.5        5.0.1      DEPRECATED phpMyAdmin is an mysql administratio...</span><br><span class="line">stable/percona                 0.3.0                   free, fully compatible, enhanced, open <span class="built_in">source</span> d...</span><br><span class="line">stable/percona-xtradb-cluster  0.0.2        5.7.19     free, fully compatible, enhanced, open <span class="built_in">source</span> d...</span><br><span class="line">azure/gcloud-sqlproxy          0.6.1        1.11       DEPRECATED Google Cloud SQL Proxy                 </span><br><span class="line">azure/mariadb                  7.3.14       10.3.22    DEPRECATED Fast, reliable, scalable, and easy t...</span><br><span class="line">stable/gcloud-sqlproxy         0.2.3                   Google Cloud SQL Proxy                            </span><br><span class="line">stable/mariadb                 2.1.6        10.1.31    Fast, reliable, scalable, and easy to use open-...</span><br></pre></td></tr></table></figure><h3 id="4-2-下载镜像">4.2 下载镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm pull azure/mysql --version 1.6.9</span><br></pre></td></tr></table></figure><h3 id="4-3-解压编辑">4.3 解压编辑</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf mysql-1.6.9.tgz</span><br><span class="line"></span><br><span class="line">[root@node001 chap11-helm]<span class="comment"># ll mysql</span></span><br><span class="line">total 36</span><br><span class="line">-rw-r--r-- 1 root root   406 Nov 14  2020 Chart.yaml</span><br><span class="line">-rw-r--r-- 1 root root 23661 Nov 14  2020 README.md</span><br><span class="line">drwxr-xr-x 3 root root   268 Sep 13 18:26 templates</span><br><span class="line">-rw-r--r-- 1 root root  6171 Sep 13 18:24 values.yaml</span><br></pre></td></tr></table></figure><h3 id="4-4-安装">4.4 安装</h3><p>helm install 名字 chart目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install mysql .</span><br><span class="line"></span><br><span class="line">[root@node001 mysql]<span class="comment"># helm ls</span></span><br><span class="line">NAME NAMESPACE  REVISIONUPDATED                              STATUS  CHART      APP VERSION</span><br><span class="line">mysqlchap11-helm1       2022-09-13 18:27:27.3973064 +0800 CSTdeployedmysql-1.6.95.7.30 </span><br></pre></td></tr></table></figure><h2 id="5-私有源">5. 私有源</h2><h3 id="5-1-打包chat">5.1 打包chat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap11-helm]<span class="comment"># helm package mysql/</span></span><br><span class="line">Successfully packaged chart and saved it to: /root/chap11-helm/mysql-1.6.9.tgz</span><br></pre></td></tr></table></figure><h3 id="5-2-创建nginx服务">5.2 创建nginx服务</h3><p><strong>创建仓库目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mychat</span><br></pre></td></tr></table></figure><p><strong>启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=c1 -p 8880:80 -v /mychart:/usr/share/nginx/html/mychart docker.io/nginx</span><br></pre></td></tr></table></figure><h3 id="5-3-创建chart索引文件">5.3 创建chart索引文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo index . --url http://192.168.10.31:8880/mychart</span><br></pre></td></tr></table></figure><p><strong>移动paackage</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> index.yaml mysql-1.6.9.tgz /mychart/</span><br></pre></td></tr></table></figure><h3 id="5-4-添加私有仓库">5.4 添加私有仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add mychart http://192.168.10.31:8880/mychart</span><br></pre></td></tr></table></figure><h3 id="5-5-查看仓库">5.5 查看仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap11-helm]<span class="comment"># helm search repo mychart</span></span><br><span class="line">NAME         CHART VERSIONAPP VERSIONDESCRIPTION                                       </span><br><span class="line">mychart/mysql1.6.9        5.7.30     DEPRECATED - Fast, reliable, scalable, and easy...</span><br></pre></td></tr></table></figure><h2 id="6-prometheus">6. prometheus</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-15-helm/prometheus.png" class=""><h3 id="6-1-添加官方源">6.1 添加官方源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br></pre></td></tr></table></figure><h3 id="6-2-下载chart">6.2 下载chart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm pull prometheus-community/kube-prometheus-stack</span><br></pre></td></tr></table></figure><h3 id="6-3-安装">6.3 安装</h3><p>编辑修改后安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install prometheus kube-prometheus-stack</span><br></pre></td></tr></table></figure><h3 id="6-4-查看release">6.4 查看release</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap11-helm]<span class="comment"># helm ls</span></span><br><span class="line">NAME      NAMESPACE  REVISIONUPDATED                              STATUS  CHART                       APP VERSION</span><br><span class="line">mysql     chap11-helm1       2022-09-13 23:37:14.0590291 +0800 CSTdeployedmysql-1.6.9                 5.7.30     </span><br><span class="line">prometheuschap11-helm1       2022-09-14 00:04:46.9828275 +0800 CSTdeployedkube-prometheus-stack-20.0.10.52.0  </span><br></pre></td></tr></table></figure><h3 id="6-5-修改svc">6.5 修改svc</h3><p>修改grafana的svc为LoadBalancer</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap11-helm]<span class="comment"># kubectl get svc prometheus-grafana </span></span><br><span class="line">NAME                 TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE</span><br><span class="line">prometheus-grafana   LoadBalancer   10.106.183.246   192.168.10.244   80:32592/TCP   9m23</span><br></pre></td></tr></table></figure><h3 id="6-6-获取密码">6.6 获取密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets prometheus-grafana -o jsonpath=<span class="string">&#x27;&#123;.data.admin-password&#125;&#x27;</span>|<span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure><h2 id="7-日志">7. 日志</h2><p>ELK<br>Elasticsearch #是个开源分布式搜索引擎，存储日志及提供查询接口。<br>Logstash #是一个完全开源的工具，他可以对日志进行收集 发送给Elasticsearch.<br>Kibana #是一个开源和免费的，web界面的工具，可以让用户浏览Elasticsearch里的日志.<br>logstash性能低，消耗资源，且存在不支持消息队列缓存及存在数据丢失的问题<br>所以logstash一般可以用fluentd或者filebeat替代<br>EFK框架</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-15-helm/efk.png" class="">]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>14.网络策略</title>
      <link href="/20220913/kubernetes-20220913-14-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/"/>
      <url>/20220913/kubernetes-20220913-14-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="1-pod间通信">1. pod间通信</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-14-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/podtongxin.png" class=""><h2 id="2-网络解决方案">2. 网络解决方案</h2><p>CNI(container network interface) CNCF下的一个项目，由coreOS提出<br>通过插件的方式统一配置<br>flannel—基于overlay 不支持网络策略<br>calico—基于BGP 支持网络策略<br>canal 支持网络策略</p><h2 id="3-各种解决方案的对比">3. 各种解决方案的对比</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-14-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/duibi.png" class=""><p>不管哪种解决方案，每个pod都有独立IP，可以直接通信，只是性能及配置的难易及是否支持网络策略</p><h2 id="4-网络策略">4. 网络策略</h2><p>只允许特定的客户端能访问，其他客户端不能访问<br>1.此网络策略要保护谁<br>2.指定入口流量还是出口流量<br>3.具体的规则</p><h3 id="4-1-查看集群是否有网络策略">4.1 查看集群是否有网络策略</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get networkpolicies</span><br></pre></td></tr></table></figure><h3 id="4-2-创建策略">4.2 创建策略</h3><p>只允指定网络能访问</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypolicy1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap10-net</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">        <span class="comment">#    except:</span></span><br><span class="line">        <span class="comment">#      - 172.17.1.0/24</span></span><br><span class="line">        <span class="comment">#- namespaceSelector:</span></span><br><span class="line">        <span class="comment">#    matchLabels:</span></span><br><span class="line">        <span class="comment">#      project: myproject</span></span><br><span class="line">        <span class="comment">#- podSelector:</span></span><br><span class="line">        <span class="comment">#    matchLabels:</span></span><br><span class="line">        <span class="comment">#      role: frontend</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="4-3-特定标签能访问">4.3 特定标签能访问</h3><p>只能是相同名称空间，指定标签</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypolicy1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap10-net</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="comment">#- ipBlock:</span></span><br><span class="line">        <span class="comment">#    cidr: 192.168.10.0/24</span></span><br><span class="line">        <span class="comment">#    except:</span></span><br><span class="line">        <span class="comment">#      - 172.17.1.0/24</span></span><br><span class="line">        <span class="comment">#- namespaceSelector:</span></span><br><span class="line">        <span class="comment">#    matchLabels:</span></span><br><span class="line">        <span class="comment">#      project: myproject</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">xx:</span> <span class="string">xx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="4-4-指定名称空间可访问">4.4 指定名称空间可访问</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypolicy1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap10-net</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="comment">#- ipBlock:</span></span><br><span class="line">        <span class="comment">#    cidr: 192.168.10.0/24</span></span><br><span class="line">        <span class="comment">#    except:</span></span><br><span class="line">        <span class="comment">#      - 172.17.1.0/24</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">default</span></span><br><span class="line">        <span class="comment">#- podSelector:</span></span><br><span class="line">        <span class="comment">#    matchLabels:</span></span><br><span class="line">        <span class="comment">#      xx: xx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="4-5-指定名称空间特定标签">4.5 指定名称空间特定标签</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypolicy1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap10-net</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="comment">#- ipBlock:</span></span><br><span class="line">        <span class="comment">#    cidr: 192.168.10.0/24</span></span><br><span class="line">        <span class="comment">#    except:</span></span><br><span class="line">        <span class="comment">#      - 172.17.1.0/24</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">xx:</span> <span class="string">xx</span></span><br><span class="line">        <span class="comment">#- podSelector:</span></span><br><span class="line">        <span class="comment">#    matchLabels:</span></span><br><span class="line">        <span class="comment">#      xx: xx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><h2 id="5-出栈规则">5. 出栈规则</h2><h3 id="5-1-只允许到pod2">5.1 只允许到pod2</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">epolicy1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">chap10-net</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">kube-system</span></span><br><span class="line">          <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">53</span></span><br></pre></td></tr></table></figure><h2 id="6-拒绝所有入流量">6. 拒绝所有入流量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure><h2 id="7。-允许所有入流量">7。 允许所有入流量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>如果没有策略，则允许所有数据包通过<br>如果定义了一个策略，但是没有任何规则，则是拒绝所有的<br>所有的协议（icmp,tcp,udp）及所有的客户端全部拒绝了</p></div>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>13.k8s安装calico时如何选择网卡</title>
      <link href="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/"/>
      <url>/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="1-了解calico的通信">1. 了解calico的通信</h2><p>默认情况下calico使用的是IPIP模式进行通信，所有节点之间建立tunl0隧道，每创建一个pod在宿主机上都会产生一个以cali开头的虚拟接口，如下图pod1生成了一个calixxxx网卡，pod2生成了一个caliyyyy虚拟网卡。每个pod发出去的数据包会直接转发到cali开头的网卡，这个接口跟pod里的网卡是veth pair的关系。</p><p>veth pari最直接的理解就是&quot;网线直连&quot;，pod1发出去的所有数据包，”闭着眼“转发给calixxx，calixxx从其他地方收到数据包”闭着眼“转发给pod1.</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928383845.png" class=""><p>cali开头的网卡会连接到tunl0上，pod1和pod2通信时，pod1发出的数据包先到达calixxx，然后进入vms71的tunl0接口，再然后到达隧道的另一端vms72的tunl0接口，然后转发到caliyyy，最终到达了pod2,所以tunl0隧道的作用就是封装所有pod之间的流量。</p><p>现在的问题是tunl0隧道所走的物理线路是哪条呢？默认情况下calico会自动选择，但是如果有多张网卡的话我们想手动选择网卡，下面分成5种情况来看tunl0如何选择物理线路。</p><h2 id="2-实现准备">2. 实现准备</h2><p>本实验共两台节点，如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES                  AGE   VERSION</span><br><span class="line">vms71.rhce.cc   Ready    control-plane,master   54m   v1.23.2</span><br><span class="line">vms72.rhce.cc   Ready    &lt;none&gt;                 54m   v1.23.2</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>为了测试，特地把vms72上的网卡名做了修改，原来的ens32修改成了eth0,原来的ens33修改名eth1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vms71上ens32 ----- vms72上eth1   同一网段。</span><br><span class="line">vms71上ens33 ----- vms72上eth0   同一网段。</span><br></pre></td></tr></table></figure><p>同一网段的网卡，结合上图，我这里并没写错。</p><p>练习时会在vms71上创建pod1，在vms72上创建pod2，所编写的pod.yaml内容如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@vms71</span> <span class="string">~</span>]<span class="comment"># cat pod.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms71.rhce.cc</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/centos:test</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">vms72.rhce.cc</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/centos:test</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line">[<span class="string">root@vms71</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="3-第一种情况-指定网卡1">3. 第一种情况 指定网卡1</h2><p>修改calico.yaml的内容，找到IP_AUTODETECTION_METHOD</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=ens33,eth0&quot;</span><br></pre></td></tr></table></figure><p>这里指定tunl0隧道所对应的物理接口为ens33或者eth0。在vms71上他会选择ens33，在vms72上会选择eth0。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928567562.png" class=""><p><strong>安装calico</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure><p><strong>创建测试用的pod</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f pod.yaml </span><br><span class="line">pod/pod1 created</span><br><span class="line">pod/pod2 created</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">[root@vms71 ~]# kubectl get pods -owide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE        IP             NODE        </span><br><span class="line">pod1   1/1     Running   0          14s   10.244.118.193   vms71.rhce.cc </span><br><span class="line">pod2   1/1     Running   0          14s   10.244.5.194     vms72.rhce.cc </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>整个拓扑图应该如下。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928605990.png" class=""><p>进入到pod1里去，然后通过traceroute访问 pod2的IP即 10.244.5.194。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl exec -it pod1 -- bash</span><br><span class="line">[root@pod1 /]#</span><br><span class="line">[root@pod1 /]# traceroute 10.244.5.194</span><br><span class="line">traceroute to 10.244.5.194 (10.244.5.194), 30 hops max, 60 byte packets</span><br><span class="line"> 1  192-168-26-71.kubernetes.default.svc.cluster.local (192.168.26.71)  0.049 ms  0.009 ms  0.007 ms</span><br><span class="line"> 2  10.244.5.192 (10.244.5.192)  0.477 ms  0.414 ms  0.378 ms</span><br><span class="line"> 3  10.244.5.194 (10.244.5.194)  0.615 ms  0.577 ms  0.540 ms</span><br><span class="line">[root@pod1 /]# exit</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>从这里可以看到在pod1发出去的包，直接到达隧道另一端即vms72上的tunl0，然后再转发到pod2的。<br>那么vms71和vms72之间的隧道之间是怎么走的呢？</p><p>先查看vms71的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p><p>查看vms72的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br><span class="line">凡是去往网段10.244.</span><br><span class="line">```118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）。</span><br><span class="line"></span><br><span class="line">删除pod1和pod2。</span><br><span class="line">```shell</span><br><span class="line">[root@vms71 ~]# kubectl delete -f pod.yaml </span><br><span class="line">pod &quot;pod1&quot; deleted</span><br><span class="line">pod &quot;pod2&quot; deleted</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">删除calico。</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><h2 id="4-第二种情况-指定网卡2">4. 第二种情况 指定网卡2</h2><p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=ens32,eth1&quot;</span><br></pre></td></tr></table></figure><p>这里指定tunl0所使用的物理线路是ens32或者eth1，vms71上有ens32所以选择ens32，vms72上有eth1则选择eth1。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928692725.png" class=""><p><strong>安装calico</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure><p><strong>创建pod</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f pod.yaml </span><br><span class="line">pod/pod1 created</span><br><span class="line">pod/pod2 created</span><br><span class="line">[root@vms71 ~]#</span><br><span class="line">[root@vms71 ~]# kubectl get pods -owide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE </span><br><span class="line">pod1   1/1     Running   0          3s    10.244.118.193   vms71.rhce.cc </span><br><span class="line">pod2   1/1     Running   0          3s    10.244.5.194     vms72.rhce.cc  </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>两个pod的IP保持了之前一样</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928716721.png" class=""><p>进入到pod1里去，然后通过traceroute访问 pod2的IP即 10.244.5.194。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl exec -it pod1 -- bash</span><br><span class="line">[root@pod1 /]# traceroute 10.244.5.194</span><br><span class="line">traceroute to 10.244.5.194 (10.244.5.194), 30 hops max, 60 byte packets</span><br><span class="line"> 1  192-168-26-71.kubernetes.default.svc.cluster.local (192.168.26.71)  0.050 ms  0.009 ms  0.007 ms</span><br><span class="line"> 2  10.244.5.192 (10.244.5.192)  0.493 ms  0.407 ms  0.365 ms</span><br><span class="line"> 3  10.244.5.194 (10.244.5.194)  0.482 ms  0.468 ms  0.461 ms</span><br><span class="line">[root@pod1 /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>查看vms71的路由。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.26.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.26.72（这是vms72的eth1接口，也是隧道tunl0的另一端）</p><p>查看vms72的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.26.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.26.71（这是vms71的ens32接口，也是隧道tunl0的另一端）<br>删除pod1和pod2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f pod.yaml </span><br><span class="line">pod &quot;pod1&quot; deleted</span><br><span class="line">pod &quot;pod2&quot; deleted</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><h2 id="5-第三种情况-跳过指定网卡">5. 第三种情况 跳过指定网卡</h2><p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;skip-interface=eth1,ens32&quot;</span><br></pre></td></tr></table></figure><p>tunl0选择物理网卡时跳过eth1或者ens32。在vms71上跳过ens32的话只能选择ens33，在vms72上跳过eth1的话只能选择eth0。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928793951.png" class=""><p>安装calico</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure><p>先查看vms71的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p><p>先查看vms72的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）</p><p><strong>删除calico</strong><br>[root@vms71 ~]# kubectl delete -f calico.yaml<br>configmap “calico-config” deleted<br>…输出…<br>[root@vms71 ~]#</p><h2 id="6-第四种情况-通过网络连通性判断">6. 第四种情况 通过网络连通性判断</h2><p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;can-reach=192.168.30.1&quot;</span><br></pre></td></tr></table></figure><p>tunl0要选择能和192.168.30.1通信的那张网卡，在vms71上ens33网卡和192.168.30.1是同一个网段，能够和192.168.30.1通信，被选中。在vms72上eth0网卡和192.168.30.1是同一网段可以通信，被选中。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928865022.png" class=""><p><strong>创建calico</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure><p>先查看vms71的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.30.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.30.72（这是vms72的eth0接口，也是隧道tunl0的另一端）。</p><p>先查看vms72的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.30.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.30.71（这是vms71的ens33接口，也是隧道tunl0的另一端）。</p><p>删除calico。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><h2 id="7-第五种情况-通过cidr判断">7. 第五种情况 通过cidr判断</h2><p>修改calico.yaml的内容，修改IP_AUTODETECTION_METHOD的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;cidr=192.168.26.0/24&quot;</span><br></pre></td></tr></table></figure><p>tunl0选择选择192.168.26.0/24网段的网卡，vms71选中的是ens32，vms72上选中的应该是eth1了，因为他们都是属于192.168.26.0/24网段的。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220913/kubernetes-20220913-13-k8s%E5%AE%89%E8%A3%85calico%E6%97%B6%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1/image-1652928925269.png" class=""><p><strong>创建calico</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl apply -f calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]# </span><br></pre></td></tr></table></figure><p><strong>查看vms71的路由</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.5.192/26 via 192.168.26.72 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.5.192/26的数据包都发送到192.168.26.72（这是vms72的eth1接口，也是隧道tunl0的另一端）。</p><p>查看vms72的路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms72 ~]# ip route  | grep tunl0</span><br><span class="line">10.244.118.192/26 via 192.168.26.71 dev tunl0 proto bird onlink </span><br><span class="line">[root@vms72 ~]#</span><br></pre></td></tr></table></figure><p>凡是去往网段10.244.118.192/26的数据包都发送到192.168.26.71（这是vms71的ens32接口，也是隧道tunl0的另一端）。</p><p><strong>删除calico</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vms71 ~]# kubectl delete -f calico.yaml </span><br><span class="line">configmap &quot;calico-config&quot; deleted</span><br><span class="line">    ...输出...</span><br><span class="line">[root@vms71 ~]#</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>12.calico通信</title>
      <link href="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/"/>
      <url>/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装etcd集群">1. 安装etcd集群</h2><p>通过文章<a href="https://renm.cc/20220906/kubernetes-20220906-4-%E4%BA%86%E8%A7%A3etcd/">部署etcd集群</a>部署etcd集群</p><h2 id="2-安装docker-ce-2">2. 安装docker-ce</h2><p>通过文章<a href="https://renm.cc/20220119/docker-20220119-docker%E5%AE%89%E8%A3%85%E5%92%8C%E5%8A%A0%E9%80%9F/">docker安装和加速</a>安装docker-ce</p><h3 id="2-1-修改配置">2.1 修改配置</h3><p>修改docker启动脚本配置存储到etcd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=/usr/bin/dockerd --cluster-store=etcd://192.168.10.41:2379 -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><h3 id="2-2-重启docker">2.2 重启docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="3-安装calico">3. 安装calico</h2><h3 id="3-1-创建目录">3.1 创建目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/calico</span><br></pre></td></tr></table></figure><h3 id="3-2-创建配置文件">3.2 创建配置文件</h3><p>[root@node003 ~]# cat /etc/calico/calicoctl.cfg</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">calicoApiConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">datastoreType:</span> <span class="string">&quot;etcdv2&quot;</span> </span><br><span class="line">  <span class="attr">etcdEndpoints:</span> <span class="string">&quot;http://192.168.10.43:2379&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-创建隧道">3.3 创建隧道</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">calicoctl node run --node-image=quay.io/calico/node:v2.6.12 -c /etc/calico/calicoctl.cfg</span><br></pre></td></tr></table></figure><h3 id="3-4-查看状态">3.4 查看状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># calicoctl node status</span></span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.10.42 | node-to-node mesh | up    | 17:38:59 | Established |</span><br><span class="line">| 192.168.10.43 | node-to-node mesh | up    | 17:39:01 | Established |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br></pre></td></tr></table></figure><h3 id="3-5-创建容器网络">3.5 创建容器网络</h3><p>在任意主机上创建网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver calico --ipam-driver calico-ipam calnet1</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>–driver calico 指定使用 calico 的 libnetwork CNM driver。<br>–ipam-driver calico-ipam 指定使用 calico 的 IPAM driver 管理 IP。<br>calico 为 global 网络，etcd 会将 calnet1 同步到所有主机</p></div><h3 id="3-6-查看容器网络">3.6 查看容器网络</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">f43625b6bef2   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">5c3a504b7498   calnet1   calico    global</span><br><span class="line">d1f8d4b0e2bf   host      host      <span class="built_in">local</span></span><br><span class="line">5255a26fa295   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure><h2 id="4-通信原理">4. 通信原理</h2><p>每在主机上创建一个容器，则会在物理机上创建一张虚拟网卡</p><h3 id="4-1-node001节点创建容器">4.1 node001节点创建容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># docker run --name c91 --net calnet1 -itd busybox  sh</span></span><br></pre></td></tr></table></figure><p><strong>查看容器 node001 的 网卡</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/wuli.png" class=""><p>多了一张网卡<code>17: calic0c1251d07d@if16</code></p><p><strong>查看容器 c91 的 IP</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/xuni.png" class=""><p>从这里可以看到容器里的虚拟网卡 cali0 和物理机的 calif6391d136be 是 veth pair 关系。</p><h3 id="4-2-看总拓扑图">4.2 看总拓扑图</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/zong.png" class=""><h2 id="5-路由关系">5. 路由关系</h2><h3 id="5-1-看c91路由">5.1 看c91路由</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/vroute.png" class=""><p>不管目的地到哪里都走cali0</p><h3 id="5-2-看node001路由">5.2 看node001路由</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220912/kubernetes-20220912-12-%E7%BD%91%E7%BB%9C/node001route.png" class=""><p>目的地址到192.168.152.133的数据包都从calic0c1251d07d（vm91新生成的虚拟网卡）走<br>目的地到192.168.112.128的数据包都冲eth1发送到node002节点<br>每台主机都知道不同的容器在哪台主机上，所以会动态设置路由。</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>11.服务发布</title>
      <link href="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/"/>
      <url>/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-15">1. 简介</h2><p>Service的出现，就是解决ip不固定的问题<br>当Pod宕机后重新生成时，其IP等状态信息可能会变动，Service会根据Pod的Label对这些状态信息进行监控和变更，保证上游服务不受Pod的变动而影响。</p><p>在 Kubernetes集群中，每个 Node运行一个 kube-proxy进程。 kube-proxy负责为 Service实现了一种 VIP（虚拟 IP）的形式，而不是 ExternalName的形式。在 Kubernetes v1.0版本，代理完全在 userspace。在 Kubernetes v1.1版本，新增了 iptables代理，但并不是默认的运行模式。从 Kubernetes v1.2起，默认就是 iptables代理。在 Kubernetes v1.8.0-beta.0中，添加了 ipvs代理。在 Kubernetes 1.14版本开始默认使用 ipvs代理。</p><h2 id="2-Service-基础导论">2. Service 基础导论</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/External.jpeg" class="" title="执行结果"><ul><li>客户端访问节点时通过 iptables实现的</li><li>iptables规则是通过 kube-proxy写入的</li><li>apiserver通过监控 kube-proxy去进行对服务和端点的监控</li><li>kube-proxy通过 pod的标签（ lables）去判断这个断点信息是否写入到 Endpoints里</li></ul><h2 id="3-代理模式分类">3.  代理模式分类</h2><h3 id="3-1-iptables-代理模式">3.1 iptables 代理模式</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/iptables.jpeg" class=""><h3 id="3-2-ipvs-代理模式">3.2 ipvs 代理模式</h3><p>ipvs代理模式中 kube-proxy会监视 Kubernetes Service对象和 Endpoints，调用 netlink接口以相应地创建 ipvs规则并定期与 Kubernetes Service对象和 Endpoints对象同步 ipvs规则，以确保 ipvs状态与期望一致。访问服务时，流量将被重定向到其中一个后端 Pod。</p><p>与 iptables类似， ipvs于 netfilter的 hook功能，但使用哈希表作为底层数据结构并在内核空间中工作。这意味着 ipvs可以更快地重定向流量，并且在同步代理规则时具有更好的性能。此外， ipvs为负载均衡算法提供了更多选项，例如：</p><ul><li>rr：轮询调度</li><li>lc：最小连接数</li><li>dh：目标哈希</li><li>sh：源哈希</li><li>sed：最短期望延迟</li><li>nq：不排队调度</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/ipvs.jpeg" class=""><h2 id="4-service类型">4. service类型</h2><p>Service在 K8s中有以下四种类型：</p><h3 id="4-1-ClusterIp">4.1 ClusterIp</h3><p>ClusterIP主要在每个node节点使用iptables，将发向ClusterIP对应端口的数据，转发到kube-proxy中。然后kube-proxy自己内部实现有负载均衡的方法，并可以查询到这个service下对应pod的地址和端口，进而把数据转发给对应的pod的地址和端口。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/clusterip.jpeg" class="" title="执行结果"><p>为了实现图上的功能，主要需要以下几个组件的协同工作：</p><ul><li>apiserver：用户通过 kubectl命令向 apiserver发送创建 service的命令， apiserver接收到请求后将数据存储到 etcd中</li><li>kube-proxy： Kubernetes的每个节点中都有一个叫做 kube-porxy的进程，这个进程负责感知 service、 pod的变化，并将变化的信息写入本地的 iptables规则中</li><li>iptables：使用 NAT等技术将 virtualIP的流量转至 endpoint中</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/clusterip.png" class="" title="执行结果"><h3 id="4-2-Handless-Service">4.2 Handless Service</h3><p>有时不需要或不想要负载均衡，以及单独的 Service IP。遇到这种情况，可以通过指定 spec.clusterIP的值为 None来创建 Headless Service 。这类 Service并不会分配 Cluster IP， kube-proxy不会处理它们，而且平台也不会为它们进行负载均衡和路由。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/headless.png" class=""><h3 id="4-3-NodePort">4.3 NodePort</h3><p>NodePort的原理在于在 Node上开了一个端口，将向该端口的流量导入到 kube-proxy，然后由 kube-proxy进一步到给对应的 pod。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/nodeport.jpeg" class="" title="执行结果"><h3 id="4-3-LoadBalancer">4.3 LoadBalancer</h3><p>LoadBalancer和NodePort其实是同一种方式。区别在于LoadBalancer比NodePort多了一步，就是可以调用Cloud provider去创建LB来向节点导流</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/LoadBalancer.jpeg" class="" title="执行结果"><h3 id="4-4-ExternalName">4.4 ExternalName</h3><p>这种类型的 Service通过返回 CNAME和它的值，可以将服务映射到 externalName字段的内容<br>ExternalName Service是 Service的特例，它没有 selector，也没有定义任何的端口和 Endpoint。相反的，对于运行在集群外部的服务，它通过返回该外部服务的别名这种方式来提供服务。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220911/kubernetes-20220911-11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/externalname.png" class="" title="执行结果"><h2 id="5-练习">5. 练习</h2><h3 id="5-1-创建deployment">5.1 创建deployment</h3><p>创建一个nginx镜像3个副本</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">        <span class="attr">app1:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-创建svc">5.2 创建svc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose --name web1 deployment web1 --port 80 --target-port 80 --dry-run=client -o yaml &gt; svc1.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-列出svc关联的pod">5.3 列出svc关联的pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap9-svc]<span class="comment"># kubectl get pod -l `kubectl get svc -o wide|awk &#x27;/svc2/&#123;print $NF&#125;&#x27;`</span></span><br><span class="line">NAME                    READY   STATUS        RESTARTS   AGE</span><br><span class="line">web1-68c8cd7dbb-hjcp7   1/1     Running       0          25h</span><br><span class="line">web1-68c8cd7dbb-xg4sj   1/1     Running       0          25h</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="6-服务发现">6. 服务发现</h2><h3 id="6-1-通过变量方式发现">6.1 通过变量方式发现</h3><p>1.只能获取相同namespace里的变量<br>2.变量的获取有先后顺序，引用的变量必须要先创建</p><p>假设我们创建了一些服务，然后再创建了pod，在pod里会通过一些变量来记录这些服务的信息<br>SVCNAME_SERVICE_HOST=svcname的IP<br>SVCNAME_SERVICE_PORT=svcname的端口</p><h3 id="6-2-通过DNS的方式发现">6.2 通过DNS的方式发现</h3><p>在kube-system里有dns，可以自动发现所有名称空间里的服务的clusterIP,所以在同一个名称空间里，一个服务访问另一个服务的时候，可以直接通过服务名来访问。<br>只要创建了一个服务（不管在哪个ns里创建的），都会自动向kube-system里的dns注册</p><p>如果是不同的名称空间，可以通过：服务名.名称空间名 来访问<br>服务名.名称空间.svc.cluster.local</p><h2 id="7-服务的发布">7. 服务的发布</h2><p>所谓发布指的是，如何让集群之外的主机能访问到服务</p><h3 id="7-1-通过NodePort">7.1 通过NodePort</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose --name svc3 pod pod1 --port 80 --<span class="built_in">type</span> NodePort</span><br></pre></td></tr></table></figure><h3 id="7-2-通过external-ip">7.2 通过external-ip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose --name svc2 pod pod1 --port 80 --external-ip 192.168.10.42</span><br></pre></td></tr></table></figure><h3 id="7-3-通过LoadBalancer">7.3 通过LoadBalancer</h3><h4 id="7-3-1-安装metallb">7.3.1 安装metallb</h4><p><strong>创建名称空间</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns metallb-system</span><br></pre></td></tr></table></figure><p><strong>安装metallb</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f metallb.yaml</span><br></pre></td></tr></table></figure><p><strong>创建metallb地址池</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    address-pools:</span></span><br><span class="line"><span class="string">    - name: default</span></span><br><span class="line"><span class="string">      protocol: layer2</span></span><br><span class="line"><span class="string">      addresses:</span></span><br><span class="line"><span class="string">      - 192.168.10.240-192.168.10.250</span></span><br></pre></td></tr></table></figure><p><strong>创建svc</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose --name svc4 pod pod1 --port 80 --<span class="built_in">type</span> LoadBalancer</span><br></pre></td></tr></table></figure><p><strong>查看svc</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap9-svc]<span class="comment"># kubectl get svc svc4 -o wide</span></span><br><span class="line">NAME   TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE   SELECTOR</span><br><span class="line">svc4   LoadBalancer   10.99.214.113   192.168.10.240   80:30200/TCP   37s   run=pod1</span><br></pre></td></tr></table></figure><h3 id="7-4-通过ingress">7.4 通过ingress</h3><p>这里利用的是有Nginx实现的反向代理</p><h3 id="7-4-1-安装ingress-nginx-controller">7.4.1 安装ingress-nginx-controller</h3><p><strong>创建名称空间</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns ingress-nginx</span><br></pre></td></tr></table></figure><p><strong>创建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl aply -f nginx-controller.yaml </span><br></pre></td></tr></table></figure><h3 id="7-4-2-创建ingress规则">7.4.2 创建ingress规则</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myingress</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">aa.rhce.cc</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">service:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">              <span class="attr">port:</span></span><br><span class="line">                <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="7-4-3-https类型的发布">7.4.3 https类型的发布</h3><p><strong>创建tls类型的secret</strong><br>使用网站证书可key创建secret</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls mytlssec --key client-key.pem --cert client.pem</span><br></pre></td></tr></table></figure><p><strong>创建ingress规则</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mying</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">www1.ck8s.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">mytlssec</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www1.ck8s.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.定时任务</title>
      <link href="/20220910/kubernetes-20220910-10-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
      <url>/20220910/kubernetes-20220910-10-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-13">1. 简介</h2><p>Kubernetes jobs主要是针对短时和批量的工作负载。它是为了结束而运行的，而不是像deployment、replicasets、replication controllers和DaemonSets等其他对象那样持续运行。<br>Kubernetes Jobs会一直运行到Job中指定的任务完成。也就是说，如果pods给出退出代码0，那么Job就会退出。</p><h2 id="2-job">2. job</h2><h3 id="2-1-创建job">2.1 创建job</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create job my-job --image=busybox --dry-run=client -o yaml -- <span class="string">&#x27;touch /tmp/abc.txt;sleep 10&#x27;</span> &gt; myjob.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#activeDeadlineSeconds: 6 </span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/abc.txt;sleep</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-job</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p><strong>参数详解</strong><br>parallelism：  N 一次运行N个pod<br>completions：M job结束需要成功运行的pod个数，即状态为completed的pod数<br>backoffLimit：N 如果job失败，则重试几次</p><p>job的restart策略只能是：<br> Nerver：只要任务没有完成，则是新建pod运行，直到job完成会产生多个pod<br> OnFailure：只要pod没有完成，则会重启pod，直到job完成</p></div><h3 id="2-2-举例">2.2 举例</h3><p>计算圆周率</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#activeDeadlineSeconds: 6 </span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>,<span class="string">&quot;-Mbignum=bpi&quot;</span>,<span class="string">&quot;-wle&quot;</span>,<span class="string">&quot;print bpi(2000)&quot;</span>]</span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-job</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>查看结果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap-8-job]<span class="comment"># kubectl logs my-pi-cpcg6 </span></span><br><span class="line">3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275901</span><br></pre></td></tr></table></figure><h2 id="3-cronjob">3. cronjob</h2><h3 id="3-1-创建cj">3.1 创建cj</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cronjob mycj --image=busybox --schedule=<span class="string">&quot;*/1 * * * *&quot;</span> --dry-run=client -o yaml -- <span class="built_in">date</span>  &gt; mycj.yaml</span><br></pre></td></tr></table></figure><h3 id="3-2-编辑yaml">3.2 编辑yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mycj</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">successfulJobsHistoryLimit:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">failedJobsHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mycj</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;date; sleep 10&quot;</span>]</span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mycj</span></span><br><span class="line">            <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&#x27;*/1 * * * *&#x27;</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p><strong>参数详解</strong><br>successfulJobsHistoryLimit: N 成功的pod保留N个<br>failedJobsHistoryLimit: N 失败的pod保留N个</p></div><h3 id="3-4-手动执行cronjob">3.4 手动执行cronjob</h3><p>基于现有crontab手动执行job</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create job myjobx --from cj/mycj</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.健康检查</title>
      <link href="/20220910/kubernetes-20220910-9-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"/>
      <url>/20220910/kubernetes-20220910-9-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-14">1. 简介</h2><p>deployment的作用来维持pod的健壮性，当pod挂掉之后，deployment会生成新的pod，但如果pod是正常运行的，但pod里面出了问题，此时deployment是监测不到的。故此时需要探测（probe），用户定义出现什么样的状况才叫出问题，当probe监测到此问题，会认为pod出现了问题，执行重启大法来解决问题。</p><h2 id="2-liveness-prob">2. liveness prob</h2><p>存活性探针，遇到问题会通过重启大法来解决问题，所谓重启就是删除pod里的容器，重新创建pod里的容器</p><h3 id="2-1-支持的探测方式">2.1 支持的探测方式</h3><p>1.command<br>2.httpGet<br>3.tcpSocket</p><h3 id="2-2-command探测方式">2.2 command探测方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span> <span class="comment">#容器启动的5s内不监测</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span> <span class="comment">#每5s钟检测一次</span></span><br></pre></td></tr></table></figure><h3 id="2-3-httpGet探测方式">2.3 httpGet探测方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p><strong>参数意义</strong><br>initialDelaySeconds：容器启动后第一次执行他测是需要等待多少秒<br>periodSeconds：执行探测的频率，默认是10秒，最小1秒<br>timeoutSeconds：探测超时时间，默认1秒，最小1秒<br>seccessThreshold：探测失败后，最少连续探测成功多少此才被认定为成功，默认1，对于liveless来说必须是1<br>failureThreshold：当pod启动了并且探测到失败，kubernetes的重试次数，存活探测情况下的放弃就意味着重新启动容器，就绪探测情况下的放弃Pod会被打上未就绪的标签。默认值3，最小值是1</p></div><h3 id="2-4-tcpsocket探测方式">2.4 tcpsocket探测方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">pod3</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="3-readiness-probe">3. readiness probe</h2><p>就绪性探针，遇到问题不重启pod，svc不再把请求转发到此pod</p><h3 id="3-1-支持的探测方式">3.1 支持的探测方式</h3><p>1.command<br>2.httpGet<br>3.tcpSocket</p><h3 id="3-2-command探测">3.2 command探测</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">readness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readness-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;sleep</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h3 id="3-3-httpGet探测方式">3.3 httpGet探测方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h3 id="3-4-tcpsocket探测方式">3.4 tcpsocket探测方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8.pod控制器</title>
      <link href="/20220909/kubernetes-20220909-8-pod%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
      <url>/20220909/kubernetes-20220909-8-pod%E6%8E%A7%E5%88%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-12">1. 简介</h2><p>在kubernetes里最小的调度单位是pod,当删除pod的时候，pod一下就被删除了，pod并没有给我们提供任何的健壮性，在工作中，很少会单独创建pod，而是通过控制器来管理pod。</p><h2 id="2-deployment控制器">2. deployment控制器</h2><p>Deployment控制器的主要职责是保证Pod资源的健康运行，该控制器的大部分功能是通过调用ReplicaSet控制器实现，同时Deploymen控制器还增添了一些特性，这些特性大多是体现在Pod更新上，使得我们队Pod的更新控制更加细致。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220909/kubernetes-20220909-8-pod%E6%8E%A7%E5%88%B6%E5%99%A8/deployment.png" class="" title="执行结果"><h3 id="2-1-deployment命令行管理">2.1 deployment命令行管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments</span><br><span class="line">kubectl create deployment web1 --image=nginx --dry-run=client -o yaml &gt; cc.yaml</span><br><span class="line">kubectl run nginx --image=nginx --dry-run -o yaml</span><br><span class="line">kubectl run nginx --image=nginx --replicas=5</span><br><span class="line">kubectl run name --image=nginx --port=80</span><br><span class="line">kubectl run name --image=nginx --<span class="built_in">env</span>=<span class="string">&quot;env1=v2&quot;</span> --<span class="built_in">env</span>=<span class="string">&quot;env2=v2&quot;</span></span><br><span class="line">kubectl run name --image=nginx --labels=<span class="string">&quot;app=hazelcast,env=prod&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-创建deployment">2.2 创建deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-HPA">2.3 HPA</h3><p>horizontal pod autoscalers 水平自动伸缩，通过检查pod cpu的负载，解决deployment里某pod负载太重，动态伸缩pod的数量来负载均衡</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220909/kubernetes-20220909-8-pod%E6%8E%A7%E5%88%B6%E5%99%A8/hpa.png" class="" title="执行结果"><h4 id="2-3-1-应用场景">2.3.1 应用场景</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220909/kubernetes-20220909-8-pod%E6%8E%A7%E5%88%B6%E5%99%A8/hpa2.png" class="" title="执行结果"><h4 id="2-3-2-配置HPA">2.3.2 配置HPA</h4><p>配置HPA需要满足2个条件：</p><ol><li>安装metrics-server</li><li>pod做资源限制</li></ol><p><strong>创建yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">400m</span> </span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>创建hpa</strong></p><p>超过5%就创建pod副本，最多5个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deployment web1 --max=5 --cpu-percent=5</span><br></pre></td></tr></table></figure><p>查看当前hpa资源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap6-deployment]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME   REFERENCE         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">web1   Deployment/web1   0%/30%    1         5         1          85s</span><br></pre></td></tr></table></figure><p><strong>创建svc</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose --name=svc1 deployment web1 --port 80</span><br></pre></td></tr></table></figure><h4 id="2-3-3-测试hpa">2.3.3 测试hpa</h4><p><strong>安装压测工具</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools -y</span><br></pre></td></tr></table></figure><p><strong>进行压测</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -t 600 -n 1000000 -c 1000 http://10.99.13.205/index.html</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>-n在测试会话中所执行的请求个数。默认时，仅执行一个请求。<br>-c一次产生的请求个数。默认是一次一个。<br>-t测试所进行的最大秒数</p></div><p><strong>查看hpa</strong></p><p>可以看到当前3个副本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap6-deployment]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME   REFERENCE         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">web1   Deployment/web1   3%/3%     1         5         3          15m</span><br></pre></td></tr></table></figure><p>当压力下降，5分钟后副本数会降为1</p><h3 id="2-4-升级镜像">2.4 升级镜像</h3><h4 id="2-4-1-版本更新">2.4.1 版本更新</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/web1 nginx=nginx:1.9 --record</span><br></pre></td></tr></table></figure><h4 id="2-4-2-查看更新历史记录">2.4.2 查看更新历史记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap6-deployment]<span class="comment"># kubectl rollout history deployment web1 </span></span><br><span class="line">deployment.apps/web1 </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         kubectl <span class="built_in">set</span> image deployment/web1 nginx=1.9 --record=<span class="literal">true</span></span><br><span class="line">3         kubectl <span class="built_in">set</span> image deployment/web1 nginx=nginx:1.9 --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="2-4-3-版本回滚">2.4.3 版本回滚</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment web1 --to-revision 1</span><br></pre></td></tr></table></figure><h3 id="2-5-滚动更新">2.5 滚动更新</h3><p>maxSurge<br> 在升级过程中一次升级几个<br>maxUnavailable<br> 在升级过程中，只能有1个不可用,一次性删除多少个po</p><p><strong>创建yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">400m</span> </span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-daemonset控制器">3. daemonset控制器</h2><p>不需要指定副本数，有几个worker节点就运行几个副本数</p><h3 id="3-1-应用场景">3.1 应用场景</h3><ol><li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd、ceph</li><li>在每个 Node 上运行日志收集 daemon，例如fluentd、logstash</li><li>在每个 Node 上运行监控 daemon，例如 Prometheus Node Exporter、collectd、Datadog 代理、New Relic 代理，或 Ganglia gmon</li></ol><h3 id="3-2-创建yaml">3.2 创建yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">dsweb1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dsweb1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">dsweb1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">dsweb1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4-statefulset控制器">4. statefulset控制器</h2><p>它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序，在StatefulSet中，Pod名字称为网络标识(hostname)，还必须要用到共享存储。<br>在Deployment中，与之对应的服务是service，而在StatefulSet中与之对应的headless service，headless service，即无头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的Endpoint列表。<br>除此之外，StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod副本创建了一个DNS域名</p><p>这个域名的格式为：<br><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>d</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mo stretchy="false">(</mo><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo><mi>F</mi><mi>Q</mi><mi>D</mi><mi>N</mi><mtext>：</mtext></mrow><annotation encoding="application/x-tex">(podname).(headless server name)FQDN：</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">nam</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mord">.</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">essser</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">nam</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mord mathnormal">FQ</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord cjk_fallback">：</span></span></span></span>(podname).(headless server name).namespace.svc.cluster.local</p><h3 id="4-1-组成部分">4.1 组成部分</h3><p>Headless Service：用来定义Pod网络标识( DNS domain)；<br>volumeClaimTemplates ：存储卷申请模板，创建PVC，指定pvc名称大小，将自动创建pvc，且pvc必须由存储类供应；<br>StatefulSet ：定义具体应用，名为Nginx，有三个Pod副本，并为每个Pod定义了一个域名部署statefulset。</p><p>为什么需要 headless service 无头服务？<br>在用Deployment时，每一个Pod名称是没有顺序的，是随机字符串，因此是Pod名称是无序的，但是在statefulset中要求必须是有序 ，每一个pod不能被随意取代，pod重建后pod名称还是一样的。而pod IP是变化的，所以是以Pod名称来识别。pod名称是pod唯一性的标识符，必须持久稳定有效。这时候要用到无头服务，它可以给每个Pod一个唯一的名称 。</p><p>为什么需要volumeClaimTemplate？<br>对于有状态的副本集都会用到持久存储，对于分布式系统来讲，它的最大特点是数据是不一样的，所以各个节点不能使用同一存储卷，每个节点有自已的专用存储，但是如果在Deployment中的Pod template里定义的存储卷，是所有副本集共用一个存储卷，数据是相同的，因为是基于模板来的 ，而statefulset中每个Pod都要自已的专有存储卷，所以statefulset的存储卷就不能再用Pod模板来创建了，于是statefulSet使用volumeClaimTemplate，称为卷申请模板，它会为每个Pod生成不同的pvc，并绑定pv，从而实现各pod有专用存储。这就是为什么要用volumeClaimTemplate的原因。</p><h3 id="4-2-部署服务">4.2 部署服务</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 默认值是 1</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span> <span class="comment"># 默认值是 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;mysc&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7.密码管理</title>
      <link href="/20220908/kubernetes-20220908-7-%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86/"/>
      <url>/20220908/kubernetes-20220908-7-%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-secret">1. secret</h2><p>Secret有三种类型：</p><ol><li>Opaque：base64编码格式的Secret，用来存储密码、密钥等；但 数据也通过base64 –decode解码得到原始数据，所有加密性很弱。</li><li>kubernetes.io-dockerconfigjson：用来存储私有docker registry的认 证信息。</li><li>kubernetes.io-service-account-token： 用于被serviceaccount引用。 serviceaccout创建时Kubernetes会默认创建对应的secret。Pod如果 使用了serviceaccount，对应的secret会自动挂载到Pod目录 /run/secrets/ kubernetes.io-serviceaccount中。</li></ol><h3 id="1-1-创建generic类型">1.1 创建generic类型</h3><p><strong>通过键值对方式创建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic mysec1 --from-literal xx=haha001 --from-literal yy=haha002</span><br></pre></td></tr></table></figure><p><strong>通过文件方式创建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic mysec2 --from-file /etc/hosts --from-file /etc/issue</span><br></pre></td></tr></table></figure><h3 id="1-2-创建harbor-registory类型">1.2 创建harbor-registory类型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry myxx --docker-server 192.168.10.31 --docker-username admin --docker-password harbor001</span><br></pre></td></tr></table></figure><h3 id="1-3-查看secret">1.3 查看secret</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap5-secret]<span class="comment"># kubectl get secrets mysec1  -o yaml</span></span><br><span class="line">[root@node001 chap5-secret]<span class="comment"># kubectl get secrets mysec1 -o jsonpath=&#x27;&#123;.data.xx&#125;&#x27;|base64 -d</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>secret使用base64进行存储，使用base64 -d进行转换</p></div><h3 id="1-4-使用secret">1.4 使用secret</h3><h4 id="1-4-1-以环境变量方式引用">1.4.1 以环境变量方式引用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">dbpod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysec1</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">xx</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="1-4-2-以卷的形式挂在">1.4.2 以卷的形式挂在</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysec1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p>secret不方便修改，所以一般情况下不会使用卷的方式引用secret</p></div><h2 id="2-configmap">2. configmap</h2><h3 id="2-1-创建变量类型">2.1 创建变量类型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cm mycm1 --from-literal xx=haha001 --from-literal yy=haha002</span><br></pre></td></tr></table></figure><h3 id="2-2-创建文件类型">2.2 创建文件类型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cm mycm2 --from-file /etc/hosts --from-file /etc/issue</span><br></pre></td></tr></table></figure><h3 id="2-3-以变量的方式引用">2.3 以变量的方式引用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">dbpod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dbpod</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mycm1</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">xx</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-以卷的方式引用">2.4 以卷的方式引用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mycm2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-5-以文件方式引用">2.5 以文件方式引用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx.conf</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">nginx.conf</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7.存储管理</title>
      <link href="/20220908/kubernetes-20220908-7-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/"/>
      <url>/20220908/kubernetes-20220908-7-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-11">1. 简介</h2><p>删除pod的时候，对应的删除容器，容器层里的数据也会被跟着一起删除掉</p><h2 id="2-emptyDir">2. emptyDir</h2><p>在宿主机里随机生成一个目录，删除pod之后emptyDir所对应的目录会被一起删除</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">c1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 1d&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">c2</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="3-hostPath">3. hostPath</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">hostpath</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/xx</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="4-nfs共享存储">4. nfs共享存储</h2><h3 id="4-1-安装nfs-server">4.1 安装nfs-server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap4-valume]<span class="comment"># yum install nfs-utils -y</span></span><br></pre></td></tr></table></figure><p><strong>启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap4-valume]<span class="comment"># systemctl enable nfs-server --now</span></span><br></pre></td></tr></table></figure><p><strong>创建共享目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap4-valume]<span class="comment"># mkdir /nfs</span></span><br><span class="line">[root@node001 chap4-valume]<span class="comment"># vim /etc/exports</span></span><br><span class="line">[root@node001 chap4-valume]<span class="comment"># exportfs -arv</span></span><br><span class="line">exporting *:/nfs</span><br></pre></td></tr></table></figure><p><strong>所有worker安装nfs客户端</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># yum install nfs-utils -y</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum install nfs-utils -y</span></span><br></pre></td></tr></table></figure><p><strong>查看共享</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 manifests]<span class="comment"># showmount -e 192.168.10.31</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.10.31:</span><br><span class="line">/nfs *</span><br></pre></td></tr></table></figure><h3 id="4-2-创建yaml">4.2 创建yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">aaa.txt</span></span><br><span class="line">[<span class="string">root@node001</span> <span class="string">chap4-valume</span>]<span class="comment"># cat nfs.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.31</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="5-k8s持久性存储">5. k8s持久性存储</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220908/kubernetes-20220908-7-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/pv.png" class="" title="执行结果"><h3 id="5-1-创建nfs-pv">5.1 创建nfs-pv</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="comment">#storageClassName: slow</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.31</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p><strong>回收策略</strong><br>如果回收策略是Recycle，当删除了pvc，pv的状态会自动变为Avaliable，pv里所存储的数据会被删除<br>弱国回收策略是Retain,当删除了pvc,pv里的数据是不会删除的，但是pv的状态不会变成avaliable</p></div><h3 id="5-2-创建pvc">5.2 创建pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="comment">#storageClassName: slow</span></span><br></pre></td></tr></table></figure><div class="note primary no-icon flat"><p><strong>pvc和pv关联要素</strong></p><p>1.accessmode<br> 务必要确保pv和pvc的值是一样的<br>2.大小<br> pv的大小&gt;=pvc里要求的大小<br>3.storageclass</p></div><h3 id="5-3-挂载pvc">5.3 挂载pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pvc</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">mypvc01</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hostpath</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="6-动态卷供应">6. 动态卷供应</h2><p>用户创建pvc的时候，自动把pv创建出来</p><h3 id="6-1-创建nfs分配器">6.1 创建nfs分配器</h3><p><strong>下载分配器</strong><br><a href="https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner">https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner</a></p><p><strong>创建分配器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 deploy]<span class="comment"># kubectl apply -f rbac.yaml</span></span><br><span class="line"></span><br><span class="line">修改deployment.yaml</span><br><span class="line">          <span class="built_in">env</span>:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: k8s-sigs.io/nfs-subdir-external-provisioner</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 192.168.10.31</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /nfs2</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 192.168.10.31</span><br><span class="line">            path: /nfs2</span><br><span class="line"></span><br><span class="line">[root@node001 deploy]<span class="comment"># kubectl apply -f deployment.yaml</span></span><br></pre></td></tr></table></figure><h3 id="6-2-创建存储类">6.2 创建存储类</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysc</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span> </span><br></pre></td></tr></table></figure><h3 id="6-3-创建pvc">6.3 创建pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">mysc</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6.pod</title>
      <link href="/20220907/kubernetes-20220907-6-pod/"/>
      <url>/20220907/kubernetes-20220907-6-pod/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-10">1. 简介</h2><p>虽然说我们在工作过程中，很少单独去创建pod,我们都会使用控制器来管理pod，但是控制器里是包括pod模板的，如果我们不理解pod的话，那么如果想修改控制器的话，也是比较难的。</p><h2 id="2-创建pod方式">2. 创建pod方式</h2><p>创建pod的话，通过：<br>1.命令行的方式<br>2.yaml文件 —更推荐—yaml可以有更多的选项</p><div class="note success no-icon flat"><p><strong>创建pod通用语法</strong><br>kubectl run podname --image nginx --image-pull-policy IfNotPresent --dry-run=client -o yaml</p></div><h2 id="3-获取yaml">3. 获取yaml</h2><p>通过命令行获取模板，然后修改即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run pod1 --image nginx --image-pull-policy IfNotPresent --dry-run=client -o yaml &gt; pod1.yaml</span><br></pre></td></tr></table></figure><h2 id="4-yaml文件">4. yaml文件</h2><p>k8s里有很多中资源，比如：<br>ns<br>node<br>pod<br>configmap<br>secret<br>cluster<br>…<br>每种资源的类型使用kind标记</p><p>每种资源都会有对应的挨批version，资源和apiversion之间的关系是固定的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node001</span> <span class="string">chap3-pod</span>]<span class="comment"># cat pod1.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#hostNetwork: true</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">haha001</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">db1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myip</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="comment">#ports:</span></span><br><span class="line">    <span class="comment">#- name: http</span></span><br><span class="line">    <span class="comment">#  containerPort: 80</span></span><br><span class="line">    <span class="comment">#  hostPort: 8888</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-yaml格式">4.1 yaml格式</h3><p>要遵照驼峰写法</p><ol><li>冒号左边<br> 多个单词的话，第一个单词首字母小写，其余单词首字母大写。</li><li>冒号右边<br> 多个单词的话，每个单词的首字母都大写</li><li>在yaml文件不能出现等于号，所有的等于号都要替换为冒号空格</li><li>在yaml中有严格的缩进要求，每次缩进2个空格</li></ol><h3 id="4-2-查看yaml帮助">4.2 查看yaml帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl explain pod.spec</span></span><br></pre></td></tr></table></figure><h2 id="5-pod的基本操作">5. pod的基本操作</h2><h3 id="5-1-执行命令">5.1 执行命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl exec  pod2 -- env</span></span><br></pre></td></tr></table></figure><h3 id="5-2-复制文件">5.2 复制文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl cp /etc/issue pod1:/tmp</span></span><br><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl exec pod1 -- ls /tmp</span></span><br><span class="line">issue</span><br></pre></td></tr></table></figure><h3 id="5-3-进入容器">5.3 进入容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl exec -it pod2 -c c1 -- bash</span></span><br></pre></td></tr></table></figure><h3 id="5-4-查看容器log">5.4 查看容器log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl logs pod2 -c c1 -f</span></span><br></pre></td></tr></table></figure><h2 id="6-pod的生命周期">6. pod的生命周期</h2><p>pod重启----所谓pod重启，就是删除pod里的容器，然后重建容器</p><p><strong>重启策略</strong><br>Always 总是重启<br>OnFailure 非正常退出才重启<br>Never 从不重启</p><p><strong>pod hook（pod钩子进程）</strong></p><ol><li>postStart<br>在主进程运行的同时，可以再启用一个钩子进程，钩子进程没有结束的话，pod状态一直为createing</li><li>preStop<br>在关闭pod的时候，在关闭之前先执行钩子进程</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod4</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod4</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="string">1d</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;date &gt; /tmp/bb.txt ;sleep 15&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;date &gt; /tmp/cc.txt; sleep 15&quot;</span>]</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><div class="note info no-icon flat"><p><strong>pod的状态</strong><br>Pending pod 因为其他的原因导致pod准备开始创建 还没有创建（卡住了）<br>Running pod已经被调度到节点上，且容器工作正常<br>Completed pod里所有容器正常退出<br>error<br>CrashLoopBackOff 创建的时候就出错，属于内部原因<br>imagePullBackoff 创建pod的时候，镜像下载失败</p></div><h2 id="7-初始化容器">7. 初始化容器</h2><p>比如一个容器A依赖其他容器，可以为A设置多个依赖容器A1,A2,A3<br>A1,A2,A3要按照顺序启动，A1没有启动起来的话，A2,A3是不会启动的，直到所有的静态容器全部启动完毕，主容器A才会启动。<br>一般用于A容器运行之前，先做一些准备工作。</p><h3 id="7-1-创建初始化容器">7.1 创建初始化容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: pod5</span><br><span class="line">  name: pod5</span><br><span class="line">spec:</span><br><span class="line">  initContainers:</span><br><span class="line">  - image: alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: initc1</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/sbin/sysctl -w swappiness=0; sleep 10&quot;</span>]</span><br><span class="line">    securityContext:</span><br><span class="line">      privileged: <span class="literal">true</span></span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: pod5</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="8-静态pod">8. 静态pod</h2><p>所谓静态pod就是，不是master上创建的，而是需要在node的/etc/kubelet.d/里创建一个yaml文件，然后根据这个yaml文件，创建一个pod，这样创建出来的node，是不会接受master管理的。<br>当然，要是想创建静态pod的话，需要对node的kubelet配置文件进行一些设置才可以，在指定目录下面创建一个yaml文件，然后改kubelet的systemd配置，reload+重启。</p><h3 id="8-1-创建静态pod">8.1 创建静态pod</h3><p><strong>进入静态pod目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># cd /etc/kubernetes/manifests</span></span><br></pre></td></tr></table></figure><p><strong>添加yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node003</span> <span class="string">manifests</span>]<span class="comment"># cat pod6.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod6</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">clinet</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>查看pod</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl -n default get pod</span></span><br><span class="line">NAME           READY   STATUS             RESTARTS     AGE</span><br><span class="line">pod6-node003   0/1     CrashLoopBackOff   1 (9s ago)   10s</span><br></pre></td></tr></table></figure><h2 id="9-标签">9. 标签</h2><h3 id="9-1-添加标签">9.1 添加标签</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl label nodes node002 tag=node002</span></span><br><span class="line">node/node002 labeled</span><br><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl get nodes -l tag=node002</span></span><br><span class="line">NAME      STATUS   ROLES    AGE    VERSION</span><br><span class="line">node002   Ready    &lt;none&gt;   2d2h   v1.24.4</span><br></pre></td></tr></table></figure><h3 id="9-2-强制覆盖">9.2 强制覆盖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl label nodes node002 tag=node002-new --overwrite</span></span><br><span class="line">node/node002 labeled</span><br></pre></td></tr></table></figure><h3 id="9-3-删除标签">9.3 删除标签</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl label nodes node002 tag-</span></span><br><span class="line">node/node002 unlabeled</span><br><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl get nodes -l tag=node002</span></span><br><span class="line">No resources found</span><br></pre></td></tr></table></figure><h3 id="9-4-调度pod">9.4 调度pod</h3><p>通过nodeName标签调度pod<br>如果pod是通过nodeName来指定是在哪个节点上运行的话，此pod是可以在有污点的节点上运行的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod6</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node001</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="9-5-通过标签选择器">9.5 通过标签选择器</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod6</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#nodeName: node001</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">node002</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="9-6-通过亲和性">9.6 通过亲和性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  name: nginx</span><br><span class="line">  resources: &#123;&#125;</span><br><span class="line">affinity:</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    <span class="comment"># requiredDuringSchedulingIgnoredDuringExecution: # 硬策略</span></span><br><span class="line">    <span class="comment"># nodeSelectorTerms:</span></span><br><span class="line">    <span class="comment"># - matchExpressions:</span></span><br><span class="line">    <span class="comment"># - key: kubernetes.io/hostname</span></span><br><span class="line">    <span class="comment"># operator: In</span></span><br><span class="line">    <span class="comment"># values:</span></span><br><span class="line">      <span class="comment"># - vms63.rhce.cc</span></span><br><span class="line">      <span class="comment"># - vms62.rhce.cc</span></span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution: <span class="comment"># 软策略</span></span><br><span class="line">  - weight: 2</span><br><span class="line">    preference:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - key: bb</span><br><span class="line">        operator: Gt</span><br><span class="line">        values:</span><br><span class="line">        - <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><h2 id="10-节点cordon">10. 节点cordon</h2><p>如果一个node被标记为cordon，新创建的pod不会被调度到此node上，已经调度上去的不会被移走，需要被删除让其重新生成。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl cordon node002 </span></span><br><span class="line">node/node002 already cordoned</span><br><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS                     ROLES           AGE    VERSION</span><br><span class="line">node001   Ready                      control-plane   2d3h   v1.24.4</span><br><span class="line">node002   Ready,SchedulingDisabled   &lt;none&gt;          2d3h   v1.24.4</span><br><span class="line">node003   Ready                      &lt;none&gt;          2d2h   v1.24.4</span><br></pre></td></tr></table></figure><p><strong>取消</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl uncordon node002 </span></span><br><span class="line">node/node002 uncordoned</span><br></pre></td></tr></table></figure><h2 id="11-排空节点drain">11. 排空节点drain</h2><p>如果一个节点被设置为drain，则此节点不再被调度pod，且此节点上已经运行的pod会被驱逐（evicted）到其他节点（所谓驱逐就是删除这个节点上的pod）<br>drain包含：<br> cordon<br> evicted</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl drain node002 --ignore-daemonsets</span></span><br></pre></td></tr></table></figure><h2 id="12-节点taint及tolerations">12. 节点taint及tolerations</h2><div class="note default no-icon flat"><p>定义污点格式<br>kubectl taint node xxx 键=值:effect(NoSchedule)</p><p>取消污点<br>kubectl untaint node xxx 键-</p></div><p><strong>查看节点污点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 chap3-pod]<span class="comment"># kubectl describe nodes node001 |grep -A2 Tain</span></span><br><span class="line">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span><br><span class="line">                    node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Unschedulable:      <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><strong>容忍污点</strong><br>创建容忍，以运行pod在master节点</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod6</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#nodeName: node001</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">node001</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5.k8s升级</title>
      <link href="/20220907/kubernetes-20220907-5-k8s%E5%8D%87%E7%BA%A7/"/>
      <url>/20220907/kubernetes-20220907-5-k8s%E5%8D%87%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<h2 id="1-版本介绍">1. 版本介绍</h2><p>了解kubernetes版本的命名：x.y.z<br>x—主版本号<br>y—次版本号<br>z—补丁号</p><p>升级kubernetes的时候，是不能跨版本升级的：<br>1.y — 1.y+1</p><p>不能够<br>1.y — 1.y+2</p><h2 id="2-更新流程">2. 更新流程</h2><p>先更新master再更新worker<br>1.先更新kubeadm<br>2.把节点设置drain<br>3.更新组件<br>4.更新kubelet、kubectl<br>5.把节点恢复正常</p><h2 id="3-查看仓库支持的版本">3. 查看仓库支持的版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum list --showduplicates kubeadm --disableexcludes=kubernetes</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Installed Packages</span><br><span class="line">kubeadm.x86_64                                                                         1.24.2-0                                                                           @kubernetes</span><br><span class="line">Available Packages</span><br><span class="line">kubeadm.x86_64                                                                         1.6.0-0                                                                            kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.6.1-0                                                                            kubernetes </span><br><span class="line">...</span><br><span class="line">kubeadm.x86_64                                                                         1.23.8-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.23.9-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.23.10-0                                                                          kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.24.0-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.24.1-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.24.2-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.24.3-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.24.4-0                                                                           kubernetes </span><br><span class="line">kubeadm.x86_64                                                                         1.25.0-0                                                                           kubernetes</span><br></pre></td></tr></table></figure><h2 id="4-升级master001节点">4. 升级master001节点</h2><p>升级到1.24.4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install -y kubeadm-1.24.4-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><h3 id="4-1-查看升级变更">4.1 查看升级变更</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubeadm upgrade plan</span></span><br><span class="line">[upgrade/config] Making sure the configuration is correct:</span><br><span class="line">[upgrade/config] Reading configuration from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look at this config file with <span class="string">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span></span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade] Fetching available versions to upgrade to</span><br><span class="line">[upgrade/versions] Cluster version: v1.24.2</span><br><span class="line">[upgrade/versions] kubeadm version: v1.24.4</span><br><span class="line">I0907 02:28:59.947040   14493 version.go:255] remote version is much newer: v1.25.0; falling back to: stable-1.24</span><br><span class="line">[upgrade/versions] Target version: v1.24.4</span><br><span class="line">[upgrade/versions] Latest version <span class="keyword">in</span> the v1.24 series: v1.24.4</span><br><span class="line"></span><br><span class="line">Components that must be upgraded manually after you have upgraded the control plane with <span class="string">&#x27;kubeadm upgrade apply&#x27;</span>:</span><br><span class="line">COMPONENT   CURRENT       TARGET</span><br><span class="line">kubelet     3 x v1.24.2   v1.24.4</span><br><span class="line"></span><br><span class="line">Upgrade to the latest version <span class="keyword">in</span> the v1.24 series:</span><br><span class="line"></span><br><span class="line">COMPONENT                 CURRENT   TARGET</span><br><span class="line">kube-apiserver            v1.24.2   v1.24.4</span><br><span class="line">kube-controller-manager   v1.24.2   v1.24.4</span><br><span class="line">kube-scheduler            v1.24.2   v1.24.4</span><br><span class="line">kube-proxy                v1.24.2   v1.24.4</span><br><span class="line">CoreDNS                   v1.8.6    v1.8.6</span><br><span class="line">etcd                      3.5.3-0   3.5.3-0</span><br><span class="line"></span><br><span class="line">You can now apply the upgrade by executing the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">kubeadm upgrade apply v1.24.4</span><br><span class="line"></span><br><span class="line">_____________________________________________________________________</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The table below shows the current state of component configs as understood by this version of kubeadm.</span><br><span class="line">Configs that have a <span class="string">&quot;yes&quot;</span> mark <span class="keyword">in</span> the <span class="string">&quot;MANUAL UPGRADE REQUIRED&quot;</span> column require manual config upgrade or</span><br><span class="line">resetting to kubeadm defaults before a successful upgrade can be performed. The version to manually</span><br><span class="line">upgrade to is denoted <span class="keyword">in</span> the <span class="string">&quot;PREFERRED VERSION&quot;</span> column.</span><br><span class="line"></span><br><span class="line">API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED</span><br><span class="line">kubeproxy.config.k8s.io   v1alpha1          v1alpha1            no</span><br><span class="line">kubelet.config.k8s.io     v1beta1           v1beta1             no</span><br><span class="line">_____________________________________________________________________</span><br></pre></td></tr></table></figure><h3 id="4-2-维护节点">4.2 维护节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl drain node001 --ignore-daemonsets </span></span><br><span class="line">node/node001 already cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-wb8pd, kube-system/kube-proxy-xhhtf</span><br><span class="line">evicting pod kube-system/coredns-74586cf9b6-z6nn9</span><br><span class="line">evicting pod kube-system/calico-kube-controllers-6799f5f4b4-jfclq</span><br><span class="line">evicting pod kube-system/coredns-74586cf9b6-224q9</span><br><span class="line">pod/calico-kube-controllers-6799f5f4b4-jfclq evicted</span><br><span class="line">pod/coredns-74586cf9b6-z6nn9 evicted</span><br><span class="line">pod/coredns-74586cf9b6-224q9 evicted</span><br><span class="line">node/node001 drained</span><br></pre></td></tr></table></figure><p><strong>查看节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME      STATUS                     ROLES           AGE   VERSION</span><br><span class="line">node001   Ready,SchedulingDisabled   control-plane   27h   v1.24.2</span><br><span class="line">node002   Ready                      &lt;none&gt;          27h   v1.24.2</span><br><span class="line">node003   Ready                      &lt;none&gt;          27h   v1.24.2</span><br></pre></td></tr></table></figure><h3 id="4-3-更新master001节点">4.3 更新master001节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubeadm upgrade apply v1.24.2 --etcd-upgrade=false</span></span><br></pre></td></tr></table></figure><div class="note danger no-icon flat"><p>第一个master节点需要执行，其他master和worker不需要执行。</p></div><h3 id="4-4-升级kubelet和kubectl">4.4 升级kubelet和kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install -y kubelet-1.24.4-0 kubectl-1.24.4-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><h3 id="4-5-重启kubelet">4.5 重启kubelet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl daemon-reload ;systemctl restart kubelet</span></span><br></pre></td></tr></table></figure><h3 id="4-6-查看节点版本">4.6 查看节点版本</h3><p>node001已更新到1.24.4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME      STATUS                     ROLES           AGE   VERSION</span><br><span class="line">node001   Ready,SchedulingDisabled   control-plane   28h   v1.24.4</span><br><span class="line">node002   Ready                      &lt;none&gt;          28h   v1.24.2</span><br><span class="line">node003   Ready                      &lt;none&gt;          27h   v1.24.2</span><br></pre></td></tr></table></figure><h3 id="4-7-取消污点">4.7 取消污点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl uncordon node001</span></span><br></pre></td></tr></table></figure><h2 id="5-升级worker节点">5. 升级worker节点</h2><h3 id="5-1-升级kubeadm">5.1 升级kubeadm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># yum install -y kubeadm-1.24.4-0 --disableexcludes=kubernetes</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum install -y kubeadm-1.24.4-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><h3 id="5-2-维护节点">5.2 维护节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl drain node002 --ignore-daemonsets </span></span><br></pre></td></tr></table></figure><h3 id="5-3-升级节点">5.3 升级节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># kubeadm upgrade node</span></span><br></pre></td></tr></table></figure><h3 id="5-4-升级kubelet和kubectl">5.4 升级kubelet和kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># yum install -y kubelet-1.24.4-0 kubectl-1.24.4-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><h3 id="5-5-重启kubelet">5.5 重启kubelet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># systemctl daemon-reload ;systemctl restart kubelet</span></span><br></pre></td></tr></table></figure><h3 id="5-6-取消污点">5.6 取消污点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl uncordon node002</span></span><br></pre></td></tr></table></figure><h3 id="5-7-查看节点版本">5.7 查看节点版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME      STATUS                     ROLES           AGE   VERSION</span><br><span class="line">node001   Ready                      control-plane   28h   v1.24.4</span><br><span class="line">node002   Ready                      &lt;none&gt;          28h   v1.24.4</span><br><span class="line">node003   Ready,SchedulingDisabled   &lt;none&gt;          27h   v1.24.2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4.了解etcd</title>
      <link href="/20220906/kubernetes-20220906-4-%E4%BA%86%E8%A7%A3etcd/"/>
      <url>/20220906/kubernetes-20220906-4-%E4%BA%86%E8%A7%A3etcd/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-9">1. 简介</h2><p>etcd集群是一个分布式系统，使用Raft协议来维护集群内容各个节点状态的一致性。<br>主机状态Leader,Follower,Candidate</p><p>当集群初始化时候，每个节点都是Follower角色<br>通过心跳与其他节点同步数据<br>当Follower在一定时间内没有收到来自其他节点的心跳，会将自己角色改变为Candidate，并发起一次选主投票。</p><p>配置etcd集群，建议尽可能是<font color=red size=2>奇数</font>个节点。</p><p>目前在用的两个大版本v2，v3<br>v3已键值对的方式来存储数据，k8s从1.5开始使用v3版本etcd。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220906/kubernetes-20220906-4-%E4%BA%86%E8%A7%A3etcd/etcd.png" class="" title="执行结果"><h2 id="2-单节点etcd">2. 单节点etcd</h2><h3 id="2-1-安装etcd">2.1 安装etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install etcd -y</span></span><br></pre></td></tr></table></figure><h3 id="2-2-修改配置文件">2.2 修改配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># vim /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line"><span class="comment">#ETCD_CORS=&quot;&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line"><span class="comment">#ETCD_WAL_DIR=&quot;&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.10.41:2380,http://localhost:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.10.41:2379,http://localhost:2379&quot;</span></span><br><span class="line"><span class="comment">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span></span><br><span class="line"><span class="comment">#ETCD_MAX_WALS=&quot;5&quot;</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment">#ETCD_SNAPSHOT_COUNT=&quot;100000&quot;</span></span><br><span class="line"><span class="comment">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span></span><br><span class="line"><span class="comment">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span></span><br><span class="line"><span class="comment">#ETCD_QUOTA_BACKEND_BYTES=&quot;0&quot;</span></span><br><span class="line"><span class="comment">#ETCD_MAX_REQUEST_BYTES=&quot;1572864&quot;</span></span><br><span class="line"><span class="comment">#ETCD_GRPC_KEEPALIVE_MIN_TIME=&quot;5s&quot;</span></span><br><span class="line"><span class="comment">#ETCD_GRPC_KEEPALIVE_INTERVAL=&quot;2h0m0s&quot;</span></span><br><span class="line"><span class="comment">#ETCD_GRPC_KEEPALIVE_TIMEOUT=&quot;20s&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://localhost:2380&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://192.168.10.41:2379,http://localhost:2379&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-启动etcd">2.3 启动etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment">#  systemctl start etcd</span></span><br></pre></td></tr></table></figure><h3 id="2-4-使用etcdctl连接服务端">2.4 使用etcdctl连接服务端</h3><p>etcdctl默认v2版本<br>添加环境变量，使用v3版本命令行<br>[root@node001 ~]# export ETCDCTL_API=3</p><h3 id="2-5-etcdctl常用命令">2.5 etcdctl常用命令</h3><p><strong>创建键值对</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl put aa 111</span></span><br><span class="line">OK</span><br><span class="line">[root@node001 ~]<span class="comment"># etcdctl get aa</span></span><br><span class="line">aa</span><br><span class="line">111</span><br><span class="line">[root@node001 ~]<span class="comment"># etcdctl del aa</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><h3 id="2-6-创建etcd快照">2.6 创建etcd快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl snapshot save snap1.data</span></span><br><span class="line">Snapshot saved at snap1.data</span><br></pre></td></tr></table></figure><h3 id="2-7-恢复快照">2.7 恢复快照</h3><p><strong>关闭集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl stop etcd</span></span><br></pre></td></tr></table></figure><p><strong>删除数据目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># rm -rf /var/lib/etcd/default.etcd</span></span><br></pre></td></tr></table></figure><p><strong>回复快照</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl snapshot restore snap1.data --name=&quot;default&quot; --data-dir=/var/lib/etcd/default.etcd --initial-cluster=&quot;default=http://localhost:2380&quot;</span></span><br><span class="line">2022-09-06 21:23:03.135401 I | etcdserver/membership: added member 8e9e05c52164694d [http://localhost:2380] to cluster cdf818194e3a8c32</span><br></pre></td></tr></table></figure><p><strong>修改属主</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># chown -R etcd.etcd /var/lib/etcd/</span></span><br></pre></td></tr></table></figure><p><strong>启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl start etcd</span></span><br></pre></td></tr></table></figure><h2 id="3-多节点etcd集群">3. 多节点etcd集群</h2><h3 id="3-1-安装etcd">3.1 安装etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install etcd -y</span></span><br><span class="line">[root@node002 ~]<span class="comment"># yum install etcd -y</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum install etcd -y</span></span><br></pre></td></tr></table></figure><h3 id="3-2-etcd集群配置文件">3.2 etcd集群配置文件</h3><p>第一个节点首次启动需要ETCD_INITIAL_CLUSTER_STATE=“new”</p><p><strong>node001</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># cat /etc/etcd/etcd.conf </span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span> </span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.10.41:2380,http://localhost:2380&quot;</span> </span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.10.41:2379,http://localhost:2379&quot;</span> </span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-41&quot;</span> </span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.10.41:2380&quot;</span> </span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.10.41:2379&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br></pre></td></tr></table></figure><p><strong>node002</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span> </span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.10.42:2380,http://localhost:2380&quot;</span> </span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.10.42:2379,http://localhost:2379&quot;</span> </span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-42&quot;</span> </span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.10.42:2380&quot;</span> </span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.10.42:2379&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br></pre></td></tr></table></figure><p><strong>node003</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/cluster.etcd&quot;</span> </span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;http://192.168.10.43:2380,http://localhost:2380&quot;</span> </span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://192.168.10.43:2379,http://localhost:2379&quot;</span> </span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd-43&quot;</span> </span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;http://192.168.10.43:2380&quot;</span> </span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://localhost:2379,http://192.168.10.43:2379&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span> </span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br></pre></td></tr></table></figure><p><strong>参数详解</strong></p><div class="note success no-icon flat"><p>ETCD_NAME 节点名称，默认为default<br>ETCD_DATA_DIR 服务运行数据保存的路径<br>ETCD_LISTEN_PEER_URLS 监听的同伴通信的地址，比如http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用 localhost！<br>ETCD_LISTEN_CLIENT_URLS 监听的客户端服务地址<br>ETCD_ADVERTISE_CLIENT_URLS 对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点。<br>ETCD_INITIAL_ADVERTISE_PEER_URLS 对外公告的该节点同伴监听地址，这个值会告诉集群中其他节点<br>ETCD_INITIAL_CLUSTER 集群中所有节点的信息，格式为<br>ETCD_INITIAL_CLUSTER_STATE 新建集群的时候，这个值为 new；假如加入已经存在的集群，这个值为existing。<br>ETCD_INITIAL_CLUSTER_TOKEN 集群的ID，多个集群的时候，每个集群的ID必须保持唯一</p></div><h3 id="3-3-启动服务">3.3 启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl start etcd</span></span><br><span class="line">[root@node002 ~]<span class="comment"># systemctl start etcd</span></span><br><span class="line">[root@node003 ~]<span class="comment"># systemctl start etcd</span></span><br></pre></td></tr></table></figure><h3 id="3-4-添加环境变量">3.4 添加环境变量</h3><p>使用v3版本读写数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br></pre></td></tr></table></figure><h3 id="3-5-查看集群">3.5 查看集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl member list</span></span><br><span class="line">1fcc72ff7c9fcff9, started, etcd-42, http://192.168.10.42:2380, http://192.168.10.42:2379,http://localhost:2379</span><br><span class="line">9ea06ab63b510bd0, started, etcd-43, http://192.168.10.43:2380, http://192.168.10.43:2379,http://localhost:2379</span><br><span class="line">a711108a22efa59d, started, etcd-41, http://192.168.10.41:2380, http://192.168.10.41:2379,http://localhost:2379</span><br></pre></td></tr></table></figure><h3 id="3-6-创建快照">3.6 创建快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># etcdctl snapshot save snap2.data</span></span><br><span class="line">Snapshot saved at snap2.data</span><br></pre></td></tr></table></figure><h3 id="3-7-恢复快照">3.7 恢复快照</h3><p><strong>复制快照到所有节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># scp snap2.data 192.168.10.42:/root</span></span><br><span class="line">[root@node003 ~]<span class="comment"># scp snap2.data 192.168.10.41:/root</span></span><br></pre></td></tr></table></figure><p><strong>关闭服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment">#  systemctl stop etcd</span></span><br><span class="line">[root@node002 ~]<span class="comment">#  systemctl stop etcd</span></span><br><span class="line">[root@node003 ~]<span class="comment">#  systemctl stop etcd</span></span><br></pre></td></tr></table></figure><p><strong>删除数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># rm -rf /var/lib/etcd/cluster.etcd/</span></span><br><span class="line">[root@node002 ~]<span class="comment"># rm -rf /var/lib/etcd/cluster.etcd/</span></span><br><span class="line">[root@node001 ~]<span class="comment"># rm -rf /var/lib/etcd/cluster.etcd/</span></span><br></pre></td></tr></table></figure><p><strong>恢复快照</strong></p><p>node003节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># etcdctl snapshot restore snap2.data --name etcd-43 --data-dir=/var/lib/etcd/cluster.etcd --initial-cluster=etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380 --initial-advertise-peer-urls=http://192.168.10.43:2380</span></span><br><span class="line">2022-09-06 22:19:59.686988 I | etcdserver/membership: added member 1fcc72ff7c9fcff9 [http://192.168.10.42:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:19:59.687020 I | etcdserver/membership: added member 9ea06ab63b510bd0 [http://192.168.10.43:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:19:59.687025 I | etcdserver/membership: added member a711108a22efa59d [http://192.168.10.41:2380] to cluster ef8bee9f9d5c4009</span><br></pre></td></tr></table></figure><p>node002节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 ~]<span class="comment"># etcdctl snapshot restore snap2.data --name etcd-42 --data-dir=/var/lib/etcd/cluster.etcd --initial-cluster=etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380 --initial-advertise-peer-urls=http://192.168.10.42:2380</span></span><br><span class="line">2022-09-06 22:21:25.372853 I | etcdserver/membership: added member 1fcc72ff7c9fcff9 [http://192.168.10.42:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:21:25.372900 I | etcdserver/membership: added member 9ea06ab63b510bd0 [http://192.168.10.43:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:21:25.372907 I | etcdserver/membership: added member a711108a22efa59d [http://192.168.10.41:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:19:59.687025 I | etcdserver/membership: added member a711108a22efa59d [http://192.168.10.41:2380] to cluster ef8bee9f9d5c4009</span><br></pre></td></tr></table></figure><p>node001节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl snapshot restore snap2.data --name etcd-41 --data-dir=/var/lib/etcd/cluster.etcd --initial-cluster=etcd-41=http://192.168.10.41:2380,etcd-42=http://192.168.10.42:2380,etcd-43=http://192.168.10.43:2380 --initial-advertise-peer-urls=http://192.168.10.41:2380</span></span><br><span class="line">2022-09-06 22:22:17.243782 I | etcdserver/membership: added member 1fcc72ff7c9fcff9 [http://192.168.10.42:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:22:17.243815 I | etcdserver/membership: added member 9ea06ab63b510bd0 [http://192.168.10.43:2380] to cluster ef8bee9f9d5c4009</span><br><span class="line">2022-09-06 22:22:17.243820 I | etcdserver/membership: added member a711108a22efa59d [http://192.168.10.41:2380] to cluster ef8bee9f9d5c4009</span><br></pre></td></tr></table></figure><p><strong>修改属主</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># chown -R etcd.etcd /var/lib/etcd/</span></span><br><span class="line">[root@node002 ~]<span class="comment"># chown -R etcd.etcd /var/lib/etcd/</span></span><br><span class="line">[root@node001 ~]<span class="comment"># chown -R etcd.etcd /var/lib/etcd/</span></span><br></pre></td></tr></table></figure><p><strong>启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl start etcd</span></span><br><span class="line">[root@node002 ~]<span class="comment"># systemctl start etcd</span></span><br><span class="line">[root@node003 ~]<span class="comment"># systemctl start etcd</span></span><br></pre></td></tr></table></figure><h2 id="4-访问k8s的etcd">4. 访问k8s的etcd</h2><h3 id="4-1-查看配置文件">4.1 查看配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># cat /etc/kubernetes/manifests/etcd.yaml</span></span><br></pre></td></tr></table></figure><h3 id="4-2-创建数据">4.2 创建数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key put aaa 111</span></span><br><span class="line">OK</span><br><span class="line">[root@node001 ~]<span class="comment"># etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key get aaa</span></span><br><span class="line">aaa</span><br><span class="line">111</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3.k8s的基本管理</title>
      <link href="/20220906/kubernetes-20220906-3-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/"/>
      <url>/20220906/kubernetes-20220906-3-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="1-了解namespace">1. 了解namespace</h2><p>集群逻辑上的资源分类，用于实现多租户的资源隔离。k8s上所有命名空间对应于containerd的k8s.io命名空间。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220906/kubernetes-20220906-3-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/ns.png" class="" title="执行结果"><h3 id="1-1-查看集群上命名空间">1.1 查看集群上命名空间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get namespaces </span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   18h</span><br><span class="line">kube-node-lease   Active   18h</span><br><span class="line">kube-public       Active   18h</span><br><span class="line">kube-system       Active   18h</span><br></pre></td></tr></table></figure><h3 id="1-2-查看指定ns空间资源">1.2 查看指定ns空间资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get pod -n kube-system </span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6799f5f4b4-jfclq   1/1     Running   0          18h</span><br><span class="line">calico-node-kgksh                          1/1     Running   0          17h</span><br><span class="line">calico-node-vxdr5                          1/1     Running   0          18h</span><br><span class="line">calico-node-wb8pd                          1/1     Running   0          18h</span><br><span class="line">coredns-74586cf9b6-224q9                   1/1     Running   0          18h</span><br><span class="line">coredns-74586cf9b6-z6nn9                   1/1     Running   0          18h</span><br><span class="line">etcd-node001                               1/1     Running   0          18h</span><br><span class="line">kube-apiserver-node001                     1/1     Running   0          18h</span><br><span class="line">kube-controller-manager-node001            1/1     Running   0          18h</span><br><span class="line">kube-proxy-4mjdp                           1/1     Running   0          17h</span><br><span class="line">kube-proxy-b7rmn                           1/1     Running   0          18h</span><br><span class="line">kube-proxy-xhhtf                           1/1     Running   0          18h</span><br><span class="line">kube-scheduler-node001                     1/1     Running   0          18h</span><br><span class="line">metrics-server-9d5bbf85c-6jbkn             1/1     Running   0          17h</span><br></pre></td></tr></table></figure><h3 id="1-3-查看所有命名空间资源">1.3 查看所有命名空间资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6799f5f4b4-jfclq   1/1     Running   0          18h</span><br><span class="line">kube-system   calico-node-kgksh                          1/1     Running   0          17h</span><br><span class="line">kube-system   calico-node-vxdr5                          1/1     Running   0          18h</span><br><span class="line">kube-system   calico-node-wb8pd                          1/1     Running   0          18h</span><br><span class="line">kube-system   coredns-74586cf9b6-224q9                   1/1     Running   0          18h</span><br><span class="line">kube-system   coredns-74586cf9b6-z6nn9                   1/1     Running   0          18h</span><br><span class="line">kube-system   etcd-node001                               1/1     Running   0          18h</span><br><span class="line">kube-system   kube-apiserver-node001                     1/1     Running   0          18h</span><br><span class="line">kube-system   kube-controller-manager-node001            1/1     Running   0          18h</span><br><span class="line">kube-system   kube-proxy-4mjdp                           1/1     Running   0          17h</span><br><span class="line">kube-system   kube-proxy-b7rmn                           1/1     Running   0          18h</span><br><span class="line">kube-system   kube-proxy-xhhtf                           1/1     Running   0          18h</span><br><span class="line">kube-system   kube-scheduler-node001                     1/1     Running   0          18h</span><br><span class="line">kube-system   metrics-server-9d5bbf85c-6jbkn             1/1     Running   0          17h</span><br></pre></td></tr></table></figure><h3 id="1-4-切换名称空间">1.4 切换名称空间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl config set-context --current --namespace kube-system</span></span><br></pre></td></tr></table></figure><p><strong>查看当前ns下资源</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get all</span></span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-6799f5f4b4-jfclq   1/1     Running   0          18h</span><br><span class="line">pod/calico-node-kgksh                          1/1     Running   0          18h</span><br><span class="line">pod/calico-node-vxdr5                          1/1     Running   0          18h</span><br><span class="line">pod/calico-node-wb8pd                          1/1     Running   0          18h</span><br><span class="line">pod/coredns-74586cf9b6-224q9                   1/1     Running   0          18h</span><br><span class="line">pod/coredns-74586cf9b6-z6nn9                   1/1     Running   0          18h</span><br><span class="line">pod/etcd-node001                               1/1     Running   0          18h</span><br><span class="line">pod/kube-apiserver-node001                     1/1     Running   0          18h</span><br><span class="line">pod/kube-controller-manager-node001            1/1     Running   0          18h</span><br><span class="line">pod/kube-proxy-4mjdp                           1/1     Running   0          18h</span><br><span class="line">pod/kube-proxy-b7rmn                           1/1     Running   0          18h</span><br><span class="line">pod/kube-proxy-xhhtf                           1/1     Running   0          18h</span><br><span class="line">pod/kube-scheduler-node001                     1/1     Running   0          18h</span><br><span class="line">pod/metrics-server-9d5bbf85c-6jbkn             1/1     Running   0          17h</span><br></pre></td></tr></table></figure><h2 id="2-多集群管理">2. 多集群管理</h2><p>kubeconfig文件是kubectl客户端登录集群的配置文件，包括3个部分：<br>1、集群信息<br> 登录集群的地址<br> 集群的证书<br>2、上下文<br> 整合1和3<br> 默认的ns<br>3、用户<br> 用户的私钥<br> 用户的证书</p><h3 id="2-1-获取kubeconfig文件">2.1 获取kubeconfig文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl config view &gt; kc</span></span><br></pre></td></tr></table></figure><h3 id="2-2-编辑kc支持2套集群">2.2 编辑kc支持2套集群</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node001</span> <span class="string">~</span>]<span class="comment"># cat kc </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3dOVEUwTkRBd04xb1hEVE15TURrd01qRTBOREF3TjFvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS21KCmRTcHBPUmdZSEMwVVhxUjJGMG5DZG92aUxQSEFPbmxDQXk0cjRxNi9TMmRxN0wwZ0NtTyt2aks5UEJmZWNBa3QKdFNVMW0wMUNVQnpzRjFzRDI1TGREMTFJNHl4azBGK0NsL1VNT2JEWVMvZGRyLzl1bGw2THNXY0VPTnJzUUUvUApyT1RJWGNVQThFN0NHL3N2V1FVaWZBbHN0VFkwdHR2V1E0UUxSN3o4U0VwdlFZMlZhNXZRV292TGtrcHR0NGNHCnI5RGZaMWhOTTlVVGlQbTZ3L0NkYUVQYVhuREYreHNGT0VhcHhENkh6RjhYQUtJamtWZmZ4M3NpK0lOVFBGL1AKdXhCTGpnNlhjRjZ3NW9Bc0NDWUpjbG1kUXhEUEtlbllNRGwxRjVmUzVhY1cvZ3BDenI3ZUUzUEVXYW9wYkV2dwpjRUtoOGF5Y0k5QXhMaGc3czNNQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZPYUNDVk5jMUpJU3pjaEtXV20vVkVJS2FhZ0dNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSlB4NU5TN2UzQXA4NXl6aWJmcgpnU3ZnUHNQUE81MGF1UWtscjV0aGZLR2I0VXZKbnJaRndsVjNqT3g4NElpUzVyRENCdktVQ1VCYnRFcG40ZHk2Cnp1MldTS3RJZGpMUFZQcGl0b2Q3bWdrVzV1TEI5SmtOdFZITGNGOVF0UzZIQ05nb29Dd2Q1eU9qN3RyWFBMRWYKdkFzdmM4emF3ZkZPUGFDVE5POHduVWdIa3JQV01BZjVNWWp1dUhnMlBuZ29PMVRxeVppWGwrR0VFZmhoMFhJVQpSN2thTFRvQkdGRFJKcHloWTVoMzdMdEdSdUJITXR4eUt5b3Z5eEtIU3NQYmZXaHlIbXNEKzJUU1JrVTYvTXB2CnR1V0FnWXoxWDJrY1ZXRkcycFZsRnc4S2ZDd1Bxc3FuUS9WVmdWK3gzNnJIcnNFa1JOOHNMTEhLMm9vcGRVODUKN09FPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://172.17.203.55:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubeadm-cluster</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURsRENDQW55Z0F3SUJBZ0lVSG1KbzFhSDZwbGlxaitNOEJydlhtOW00MS9Fd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lURUxNQWtHQTFVRUJoTUNRMDR4RVRBUEJnTlZCQWdUQ0VoaGJtZGFhRzkxTVFzd0NRWURWUVFIRXdKWQpVekVNTUFvR0ExVUVDaE1EYXpoek1ROHdEUVlEVlFRTEV3WlRlWE4wWlcweEV6QVJCZ05WQkFNVENtdDFZbVZ5CmJtVjBaWE13SUJjTk1qSXdPREUzTVRZek56QXdXaGdQTWpFeU1qQTNNalF4TmpNM01EQmFNR0V4Q3pBSkJnTlYKQkFZVEFrTk9NUkV3RHdZRFZRUUlFd2hJWVc1bldtaHZkVEVMTUFrR0ExVUVCeE1DV0ZNeEREQUtCZ05WQkFvVApBMnM0Y3pFUE1BMEdBMVVFQ3hNR1UzbHpkR1Z0TVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1JSUJJakFOCkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQW5hMHVvYWZMZ0d5QU4yQlJDaE9GdVRmeTMrVk8KdDN4bWJHcGN3ZTRjcmxKMGM4aSsyc2NoS2Z3Q0VUQWUwa1Q1ck9hOWYrQXRTWlZRMUJhWGZTSHY3SWJ0NDdzOQpzYklqQkxHWGt3UHAwQ0ZXbjVUVjVRVlFBNWorc3NNY0FHbXpITVBvbFhOVkpKUlltTHdEWFZtUHRzdFBHRm9rCmcraFY5a25HV0JFYm9Wd2FweGtKQlZ1c0l1RDJUMkJkemdmZEp3bVJjaEdEL0RoS0R2S2ZheGpWNU9SN3prNDAKY1pyUFdBYmZXditzMmluMHIxaW5rczhUM016Z2pMV3oyYmt6NlBQdzhJbjg0ajY4c2RFbzBPOUxJcWIvQlFZYwpvTUV4NXJjTTZuczhCVVZzS0F6NU1Kb1VVR2NJTnRqUjN4SkxORkJ1VXU1aGluOHMrQUVZQ09wSDBRSURBUUFCCm8wSXdRREFPQmdOVkhROEJBZjhFQkFNQ0FRWXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVUKamRxclRPblZQeStEOW8yazdDUnJFVlRDQ0Z3d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFHU3AzQ1ZTblZWagpYcytqZkI0NE9OZVJvVkpUNkNoMDRnb1Qvcnh2aHF5UkNYaEROVms0MmRpQWhaSjNTbWdrRGU4cmErbGlwTXFwCkhkZW94OWtMbUp4L1ZNR2NnVk1tRytWaWxlaWNwQ3JQT1NoSGZsRzJhc2VQaDQ0UmhNUzVhWmFEdEJPMzcxd0cKM1Y3NmFhZVJzZnlYY2JTUm1sdEFIbVcxVDUrOGloNmtLUGdyZ1o1N1dyVDR3Uk5FZy92SUJxVm80cXR5K3Q5UwpyUjVNYkJBTkJPMDY5NXBMcng4S3luY2lNNE9OMmFxcWh6ckhXbWhjZ213aFQ2T3ZkYjlYMlNkZmdDU3EvUTlWCmdMTnFVb0ZSUmFEZWUwdkVKZFFiTHJJaGVZWDJHWExSZEhWYjJEb2pTL0VWcUxzcWdnYXB0QWFMUmllbnRtN1EKTlMrRERBTHZscjA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.10.11:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ansible-cluster</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubeadm-cluster</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ek8s</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">ansible-cluster</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ok8s</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">ek8s</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin1</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJQ2R6SFZKcWZEWHd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1EVXhORFF3TURkYUZ3MHlNekE1TURVeE5EUXdNRGhhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTBkb1o1MHZ4WnF1M0FROVUKUlNjWVA0Q3RveFl3MUtpOUhldWIyZU9QMjNwYXFkdUcxN3QzZkJxMjJudldFS2VCWnlGM1RpYkY1dUFUZTlNRQpBWGJYcEZnSzRYNlRPSHdNYWtWM0ZFQjJhRElHVXRkd3poMkZxTnZKRWVURjMrWWJuQUNTUm1tclgvV2d4QWVKCkJBVkwwN05GTVJlcE5FelhONjBCT2hxMTlRZHhjOGoyYTBBbjRxYXFHcm9WUlNkNWRuMlU4U3pXbkZpUmE3Yk8KMjczVk40Y2V4eWdrV3Y1aFZtNjJOVDA3czZUOFo1MVAwMmVMejNXYkJTTmVjbUt6bmJCYXczNDFoTlpUTlJmbQpjbkZ5czJDV0t0ZEFoL0MzbTRLZW1jRE5ia3VBZ1crL0tNcExKbXRFV0pqNy9BUjJsWk9QQzZwai9vV1RsaDNCClREcGFWd0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JUbWdnbFRYTlNTRXMzSVNsbHB2MVJDQ21tbwpCakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbHVibDVsSTdJZzVUUlB0T0VJeUZpVE1PQlJQVjRBd1ZyVnR1CjE0bmJneEtrdlV6RFNrYk5ZL3BRYzVEWlFtVnExUmRpSUFYRE5IMm1rRG53aHJqTndOeGljZTRoUmRiUEVZWlQKZWdqcTlENEdheGJGQlYvRXQ1MW8vUUthNUhIVjhxYlprVjl1U1N5elA3UjJka05MZW1Sdi9RSC9lS1lweUhVMQpyWTFDWWZmeGJaSFJ2K0lTd3A1WVFSNktmYndXWmtoUS9YNURxc25DbTdRbVhMOGVSaWQ5NGt0aU0reXlzeG56CkhLdkFkNFh6aFVHU20zRzRlTTRPY2J5dEVrRVJEajA1bnptZTlIMGl1blBneHJndHNtZjl1em1DVkVXWmQ1VDEKeFhmOFFUQ2FDeW9QaDk3R21MLzhKekJ4dzhsNmhwR09QcDhkUDRuMTFlL0dCeDVKNkE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBMGRvWjUwdnhacXUzQVE5VVJTY1lQNEN0b3hZdzFLaTlIZXViMmVPUDIzcGFxZHVHCjE3dDNmQnEyMm52V0VLZUJaeUYzVGliRjV1QVRlOU1FQVhiWHBGZ0s0WDZUT0h3TWFrVjNGRUIyYURJR1V0ZHcKemgyRnFOdkpFZVRGMytZYm5BQ1NSbW1yWC9XZ3hBZUpCQVZMMDdORk1SZXBORXpYTjYwQk9ocTE5UWR4YzhqMgphMEFuNHFhcUdyb1ZSU2Q1ZG4yVThTelduRmlSYTdiTzI3M1ZONGNleHlna1d2NWhWbTYyTlQwN3M2VDhaNTFQCjAyZUx6M1diQlNOZWNtS3puYkJhdzM0MWhOWlROUmZtY25GeXMyQ1dLdGRBaC9DM200S2VtY0ROYmt1QWdXKy8KS01wTEptdEVXSmo3L0FSMmxaT1BDNnBqL29XVGxoM0JURHBhVndJREFRQUJBb0lCQUZlVkJ5cVpiMjdDUythTgpWMFpsUXFGK092bk4wU053S1QzTGo0Z29pV200Ync1bEtLbncrN1U0RVFpdWxuRHM5L3pxNHJnalJvVk5EOVNtCkJRMzNZNWliaGk4R2ZMc2VTckF2dmJzZURFMEFVOU5QUnkwKzlRRzhlUGFXM0Y3TjBzZ1JGUHQrTHFBbUM2ckUKMmxKclEzSmZaNGxOcnJpOU9UVnJadyt4QmkvMDRVOStleExYTE9vNS9xQ1NPOUtqQ3hRd05Hc1FXSkpvTS9oMApRc0gwTzJPU0NwYnpoaklvTERBMDQvNU9HM2kwRmFxTEpCQlQ0L2hUSDJINjZIMG9wNWJXaE9WQ1RYR0Mwckp3CnRnYUpkNEVqNjJEV2MzVzZNUTJTbmVFL3VQSmpyd0ZCbHM3Zi9vTnlONUN5YWpiK1lrSE1uV1pUNkpabWU5U1gKdStiSnlVRUNnWUVBK1dIbEt4TkQvdktxU0pOWVE4U2svRUQ4bEFkYUtqMkh4UksvbURuN2EzcnppMHdvOVY5Mgp3VklyMG5UL2IrQXJMSFFJVDF2NG9IWnA2Q2hUT2R5TVJhTzBQb3BBQXEvRWM3dktlNkprWlRoa2lxL2gyUTFEClJEL201TlNIUzRHRkt4R3BoRzBoa05ZbTRaUnJORFlzSWNIN1l6TFFZbTJ0SFJ2LzFxYlk2ajBDZ1lFQTEydXEKOEl0blR5K1F4cy9IWWpEdGJ0Y09FRTZpeXpHQ01hWHZpOGhCUnY4RDZDZlQyM0ZtUHZsazZ6Vm05aEV0ZEZFRQo5RHExb3ZwOGR0YmdYaW9CZzNoM3NmQ0wwY0g1V1dXbk1GZUJnTENRUWFWU05iai9BRzBGSGtyVFNCbmhwbnNUCk0zYzc0Z3BUanJEcTBISDZpYS9qcDBvZ1V4VjFoL2daYTE4RTVDTUNnWUVBbzhIbjlZZzZIMEVFRnBKQzVJVk4KZmFQQytBVjM3TUxvMDcxQytOZ2lRK3JCNEZmTGtZejFjMjdjL2Q3OEdWL1BtZW83eHJqekk1TithZ2VJMXpiLwpHWCt0RFdCRk5qNXJOMEE2YjBNc3Y5YnZGcTcyRkV5RVBsM2o1YUcxa2h4ajhPc3hNSmRrOGpIZDZFVkl2RWxTClkzeDQ4aVBjK0xWaWR2bjYzdDVERkZVQ2dZQjBiNGFxazc3WVJ5NXF0MTNlamZHWDZuZDRpdmhrK2JLVVlVdFQKODM2TkFFTzlWT0duQitrcStxUDRtaG0zd05zZnRyY0Z4MEhzQUpZTHFlTUdJcEJFM25WYjRWZkJuYVhJRXpERgo2VlpmRjVBeFcwbFBMbG51Z2Y2MU85NXRaMGZYTTBqU2xZenhoWUZhYS9mUGlQdlJOaGZIa1VKZGhnakw0R2JrCjZTdjhud0tCZ1FDdUt3Vzl0Z3E1K1NRZHlmRFltL2xsMVFoVElndEdkcE1DTDZGUlFDams5c1RjcEpkanJXLzUKUFV0YWM1ek9wT1BiQzVZYzZGdWJMRXNQdUNWSWpTYVdEeVYyMlFOK3JHUEE3UHAySi9EMUh3M1lBOWl0elJmRgpud0dKYjdvZ3RONUhuTFpYaXNrRXhOckhjdlBhdStIdzZxMXREOUJQN2ltRk5HNFJ1SmMwRnc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin2</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQxekNDQXIrZ0F3SUJBZ0lVY0JWaTMwVjNydHRhSE1tM2dCbjNQRUxtWVVJd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lURUxNQWtHQTFVRUJoTUNRMDR4RVRBUEJnTlZCQWdUQ0VoaGJtZGFhRzkxTVFzd0NRWURWUVFIRXdKWQpVekVNTUFvR0ExVUVDaE1EYXpoek1ROHdEUVlEVlFRTEV3WlRlWE4wWlcweEV6QVJCZ05WQkFNVENtdDFZbVZ5CmJtVjBaWE13SUJjTk1qSXdPREUzTVRZME1UQXdXaGdQTWpBM01qQTRNRFF4TmpReE1EQmFNR2N4Q3pBSkJnTlYKQkFZVEFrTk9NUkV3RHdZRFZRUUlFd2hJWVc1bldtaHZkVEVMTUFrR0ExVUVCeE1DV0ZNeEZ6QVZCZ05WQkFvVApEbk41YzNSbGJUcHRZWE4wWlhKek1ROHdEUVlEVlFRTEV3WlRlWE4wWlcweERqQU1CZ05WQkFNVEJXRmtiV2x1Ck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMWpBYWdrdWxZMWZHb2dNcVBjcHgKTWMyVlAxK0ExRXI2NWFyUTFwUDU0Mm5jZER6MHZSYzdmREJlYkd2ZS9maEZDZWhvWUR5RWRUczlNeUxVUG9jYgpBWUpYM1BYbTJPR3dNbmYyTzB1TGg3aWJtL3VKdlBtRzMyMEcxalZZcmFmOTh6SVlsWms3QnExZHJwcHlsMzR1CjBrbTlxZEZOVkNJcFBmUkI1bWZsOFIyUkp4NEdqOGxjZnY1V3JBNGc4cVcxbDJWTEVIUGpZTTBWQnVkTi9oeUIKLzA4cW9GMElNU3pUKzNtVjJ1aGZubUJadnBENUVlNHJYTHgyd29xdWFBMTViS1QrY2FTQ251bzhUbEJ2dVk4MQovQlhseHBYUWx6MnNkM0RxTzBPR0MzWkNOSTNaanJEOVYvbHVORCt1aHBpaks1a25VRUJEM1h3T2I4cWMxTCtRCk53SURBUUFCbzM4d2ZUQU9CZ05WSFE4QkFmOEVCQU1DQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdIUVlEVlIwT0JCWUVGTVlzdnBVdGxQb2lhcEpBQ09OMQpwa0R1SHRwRE1COEdBMVVkSXdRWU1CYUFGSTNhcTB6cDFUOHZnL2FOcE93a2F4RlV3Z2hjTUEwR0NTcUdTSWIzCkRRRUJDd1VBQTRJQkFRQ0x5bXk0REZlaDdlOEwzWTdnc1ZyWTZSenFIaDI3Si9qN3BxZWRaZU9MVnhvczZqcEUKcG9hTnhPbzBOVVA2MFBhNmV1SnNOQnA3TGVtZVBnTXpXT2RpTU1sSEF0S3ZzZDIxRXh6VVBZZW5KUUJRNkNjUgp0SURUQ2VvTmgrQThQYWJBOU0zaUwwdVRLK2VTTWJ3cFBMTmdLNFJpcCswZ1lBWnRMTFBFQXpHdmNMT0tSb0twClBuYkljcEkzeVRhaWp4RmVxZy9rbzFQMlMrZzRydmwxVFVUcGEzdnhiSlA3djIvbmhMb0dCNkYzNWlKU2o1TEYKZmIvYjUzSTdWbVlja3B1VW54c1BranBPWGFBTC8reWRlNFFBb25xN0lrdFNHL3hrUmI4L1IvRDR5S2l2ZHQydApOVHRuUzE1ZTg3em41VVhYNHI3QTJjVWpwb0FJYkhDU0VkWk4KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcFFJQkFBS0NBUUVBMWpBYWdrdWxZMWZHb2dNcVBjcHhNYzJWUDErQTFFcjY1YXJRMXBQNTQybmNkRHowCnZSYzdmREJlYkd2ZS9maEZDZWhvWUR5RWRUczlNeUxVUG9jYkFZSlgzUFhtMk9Hd01uZjJPMHVMaDdpYm0vdUoKdlBtRzMyMEcxalZZcmFmOTh6SVlsWms3QnExZHJwcHlsMzR1MGttOXFkRk5WQ0lwUGZSQjVtZmw4UjJSSng0RwpqOGxjZnY1V3JBNGc4cVcxbDJWTEVIUGpZTTBWQnVkTi9oeUIvMDhxb0YwSU1TelQrM21WMnVoZm5tQlp2cEQ1CkVlNHJYTHgyd29xdWFBMTViS1QrY2FTQ251bzhUbEJ2dVk4MS9CWGx4cFhRbHoyc2QzRHFPME9HQzNaQ05JM1oKanJEOVYvbHVORCt1aHBpaks1a25VRUJEM1h3T2I4cWMxTCtRTndJREFRQUJBb0lCQVFDRWpncXAzb1VCZ1Q0bAo0QTJSWmlzOXBqeWFsdEZWRVA1TGlyWnFSZlFkd05NMWdNLzZBbG5IRnV3bzcyMTNBZUpBS253R0t3M1N1NUc1Cmh2R1JyTzJTdG9jSDhZc25hQzB5WHJtZG9yZzhpNHlLTVZiaUJBOXJVTDh0YktCd0FJcVNxc3M2TWpXc2dUaDgKS1l1SHBBajREYmo2VXRVbm4yaWt0ZmplemlncFduK0EvdFBhMlJZNDhLT2hQLzg1ZXZ1dmpudDR2Qy9Ta2g5QQo3ZHhwZlltR3pWQmR6b0JxYkQ3R01sWllWR0tjSzlnQ2xxaDF3bnhvbCsyWHQzcDZlekNCUUJnWFgyYWttcFQ5CkNHNmE2Z2V1NlBGNlhWYlVqTC83aTUxTHJ0ZENqdmNkNFk1YkcwWi90Y1cxSTVHQjJZVkRKRm8yclRHQkdCRXUKYjlqS1ZxM1pBb0dCQU5wUndBWFUveUY3TVVEaG4zSWx5dG81eUtoK1YxUkx1elB3YVFOdGE1dytlREVCbGU3RworQUplb2xnWjJLbWZBOHFKUFlDY1dIbDM4QWtYZy85cVhpR2tnSS9obENyWnFWZFlZTUNtcGZNZkZBMzRKYVdDCnhDMDdLWHhybnA2ZWt1UWQ4TTRoK0dDa0hiR2JKUU9aWTJjcmtHWStFWEJ3YzloWE15bTNKelJGQW9HQkFQc24KejB0T053SHNyUEs4V21US20wb3ZTZDVLbzVQSG9YeDczMlBGdEQ0Y0pBMjZsUDZ2VmRETHI2dFBYbWFDZEdLaAp0dGx6TXdDdFVuT3FvTVdweFpFYVRKUThJZ0RPZmhiNzdHcXFHeTFvNzRsT0FDb081Q3p5WHRjajh5MUp2aCtxCmFaYml5Um5iOUppaVQ3T2I1alhFSm55ZWxISFJpelJiYlUrS2lrQkxBb0dBUkpCRUJCRGVoejlQT3BjaEloSW8KWU55ZzNmbS9wMk9aU1RpSlltQXMyWWJzN0VjWk5VSWJoWEwrL1Rnd3lTUjlabEF2bG9LRGJySnlHZ2plbFlwcwpRWmlPSDZHeWpMcUs2am1CT1QrZEFudVNLc2p4MmNiMW9WYmhNb2dCNnNMV1V2bnNOSENLdHA4VURFRXpJS3c5CmdaczI0RVZCNk5RSUxidEZBQ2JiRXhrQ2dZRUF2aklSbTNlcDFIMUZJN1ZieHdSZndUZzZlbXFQb2JRR0tOMHQKK01LWmtvZUJEaHlFQkxNSEM4MlVST2tnRmdVbzJpQ1k5ZWQxY2tmUEx1VENSNjRmZlprcThQN3d5U2VXK1JUaQpub3dmZEs0STZEUDNqK0lqRFo2bUQ4cWJ0Mm9tM3BnUXlrRUlCZHM2U2ZSdzR4Vm1xc1RXV0gxRzhVSzhablB1ClBkUXVpaTBDZ1lFQW1uNlpjYVZFTzd5MThyZnlPWDYvM0ExRXl4MUxHYzBqbVVESENEVnhFRzE4OVgvT3E5RVcKK2c3Z0pDWFVSbEp0T29za0Q0WTFYa0tPM2ZyV09TbjNyTkJaNTR6K3p3WmcxWksraEZja2M1UGJ2Q3NFcjBxRwpEaUF5T1ZlaG5Fb1FmSkhkYSs1djNEeHBxMWwrTi9FcGN2U0xBcGJ5TkFTL3ZIL014TnYxek13PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br></pre></td></tr></table></figure><h3 id="2-3-查看当前有几套集群">2.3 查看当前有几套集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl --kubeconfig=kc config get-contexts </span></span><br><span class="line">CURRENT   NAME   CLUSTER           AUTHINFO   NAMESPACE</span><br><span class="line">*         ek8s   kubeadm-cluster   admin1     default</span><br><span class="line">          ok8s   ansible-cluster   admin2     default</span><br></pre></td></tr></table></figure><h3 id="2-4-切换集群">2.4 切换集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl --kubeconfig=kc config use-context ok8s</span></span><br><span class="line">Switched to context <span class="string">&quot;ok8s&quot;</span>.</span><br></pre></td></tr></table></figure><p><strong>查看集群node</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl --kubeconfig=kc get nodes</span></span><br><span class="line">NAME            STATUS                     ROLES    AGE   VERSION</span><br><span class="line">192.168.10.11   Ready,SchedulingDisabled   master   19d   v1.24.2</span><br><span class="line">192.168.10.12   Ready,SchedulingDisabled   master   19d   v1.24.2</span><br><span class="line">192.168.10.13   Ready,SchedulingDisabled   master   19d   v1.24.2</span><br><span class="line">192.168.10.14   Ready                      node     19d   v1.24.2</span><br><span class="line">192.168.10.15   Ready                      node     19d   v1.24.2</span><br><span class="line">192.168.10.16   Ready                      node     18d   v1.24.2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.安装k8s</title>
      <link href="/20220905/kubernetes-20220905-2-%E5%AE%89%E8%A3%85k8s/"/>
      <url>/20220905/kubernetes-20220905-2-%E5%AE%89%E8%A3%85k8s/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-8">1. 简介</h2><table><thead><tr><th>IP地址</th><th>操作系统</th><th>k8s版本</th><th>runtime</th><th>部署方式</th></tr></thead><tbody><tr><td>192.168.10.31</td><td>centos7</td><td>1.24.2</td><td>containerd</td><td>kubeadm</td></tr><tr><td>192.168.10.32</td><td>centos7</td><td>1.24.2</td><td>containerd</td><td>kubeadm</td></tr><tr><td>192.168.10.33</td><td>centos7</td><td>1.24.2</td><td>containerd</td><td>kubeadm</td></tr></tbody></table><h2 id="2-初始化环境">2. 初始化环境</h2><p><strong>更新系统</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum update -y</span></span><br><span class="line">[root@node002 ~]<span class="comment"># yum update -y</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum update -y</span></span><br></pre></td></tr></table></figure><p><strong>关闭防火墙</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># firewall-cmd --set-default-zone=trusted</span></span><br><span class="line">[root@node002 ~]<span class="comment"># firewall-cmd --set-default-zone=trusted</span></span><br><span class="line">[root@node003 ~]<span class="comment"># firewall-cmd --set-default-zone=trusted</span></span><br></pre></td></tr></table></figure><p><strong>关闭selinux</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@node002 ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@node003 ~]<span class="comment"># setenforce 0</span></span><br></pre></td></tr></table></figure><p><strong>关闭swap</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># swapoff -a ; sed -i &#x27;/swap/d&#x27; /etc/fstab</span></span><br><span class="line">[root@node002 ~]<span class="comment"># swapoff -a ; sed -i &#x27;/swap/d&#x27; /etc/fstab</span></span><br><span class="line">[root@node003 ~]<span class="comment"># swapoff -a ; sed -i &#x27;/swap/d&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line">[root@node002 ~]<span class="comment"># swapon  -s</span></span><br></pre></td></tr></table></figure><p><strong>配置yum源</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># rm -rf /etc/yum.repos.d/* ; wget ftp://ftp.rhce.cc/k8s/* -P /etc/yum.repos.d/</span></span><br><span class="line">[root@node002 ~]<span class="comment"># rm -rf /etc/yum.repos.d/* ; wget ftp://ftp.rhce.cc/k8s/* -P /etc/yum.repos.d/</span></span><br><span class="line">[root@node003 ~]<span class="comment"># rm -rf /etc/yum.repos.d/* ; wget ftp://ftp.rhce.cc/k8s/* -P /etc/yum.repos.d/</span></span><br></pre></td></tr></table></figure><p><strong>添加hosts</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.10.31 node001</span></span><br><span class="line"><span class="string">192.168.10.32 node002</span></span><br><span class="line"><span class="string">192.168.10.33 node003</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>加载内核模块</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/modules-load.d/containerd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure><p><strong>修改内核参数</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure><h2 id="3-安装containerd">3. 安装containerd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install containerd.io cri-tools -y</span></span><br><span class="line">[root@node002 ~]<span class="comment"># yum install containerd.io cri-tools -y</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum install containerd.io cri-tools -y</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>生成配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">第一：搜索mirrors，把</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">改成</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;nerdctl.io&quot;</span>]</span><br><span class="line">        endpoint = [<span class="string">&quot;https://frz7i079.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line"></span><br><span class="line">第二：搜索sandbox，把</span><br><span class="line">sandbox_image = <span class="string">&quot;k8s.gcr.io/pause:3.6&quot;</span></span><br><span class="line">改为</span><br><span class="line">sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line"></span><br><span class="line">第三：搜索SystemdCgroup，把</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">      BinaryName = <span class="string">&quot;&quot;</span></span><br><span class="line">      CriuImagePath = <span class="string">&quot;&quot;</span></span><br><span class="line">      CriuPath = <span class="string">&quot;&quot;</span></span><br><span class="line">      CriuWorkPath = <span class="string">&quot;&quot;</span></span><br><span class="line">      IoGid = 0</span><br><span class="line">      IoUid = 0</span><br><span class="line">      NoNewKeyring = <span class="literal">false</span></span><br><span class="line">      NoPivotRoot = <span class="literal">false</span></span><br><span class="line">      Root = <span class="string">&quot;&quot;</span></span><br><span class="line">      ShimCgroup = <span class="string">&quot;&quot;</span></span><br><span class="line">      SystemdCgroup = <span class="literal">false</span></span><br><span class="line">改成</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">      SystemdCgroup = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>config.toml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">disabled_plugins = []</span><br><span class="line">imports = []</span><br><span class="line">oom_score = 0</span><br><span class="line">plugin_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">required_plugins = []</span><br><span class="line">root = <span class="string">&quot;/var/lib/containerd&quot;</span></span><br><span class="line">state = <span class="string">&quot;/run/containerd&quot;</span></span><br><span class="line">temp = <span class="string">&quot;&quot;</span></span><br><span class="line">version = 2</span><br><span class="line"></span><br><span class="line">[cgroup]</span><br><span class="line">  path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[debug]</span><br><span class="line">  address = <span class="string">&quot;&quot;</span></span><br><span class="line">  format = <span class="string">&quot;&quot;</span></span><br><span class="line">  gid = 0</span><br><span class="line">  level = <span class="string">&quot;&quot;</span></span><br><span class="line">  uid = 0</span><br><span class="line"></span><br><span class="line">[grpc]</span><br><span class="line">  address = <span class="string">&quot;/run/containerd/containerd.sock&quot;</span></span><br><span class="line">  gid = 0</span><br><span class="line">  max_recv_message_size = 16777216</span><br><span class="line">  max_send_message_size = 16777216</span><br><span class="line">  tcp_address = <span class="string">&quot;&quot;</span></span><br><span class="line">  tcp_tls_ca = <span class="string">&quot;&quot;</span></span><br><span class="line">  tcp_tls_cert = <span class="string">&quot;&quot;</span></span><br><span class="line">  tcp_tls_key = <span class="string">&quot;&quot;</span></span><br><span class="line">  uid = 0</span><br><span class="line"></span><br><span class="line">[metrics]</span><br><span class="line">  address = <span class="string">&quot;&quot;</span></span><br><span class="line">  grpc_histogram = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.gc.v1.scheduler&quot;</span>]</span><br><span class="line">    deletion_threshold = 0</span><br><span class="line">    mutation_threshold = 100</span><br><span class="line">    pause_threshold = 0.02</span><br><span class="line">    schedule_delay = <span class="string">&quot;0s&quot;</span></span><br><span class="line">    startup_delay = <span class="string">&quot;100ms&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>]</span><br><span class="line">    device_ownership_from_security_context = <span class="literal">false</span></span><br><span class="line">    disable_apparmor = <span class="literal">false</span></span><br><span class="line">    disable_cgroup = <span class="literal">false</span></span><br><span class="line">    disable_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    disable_proc_mount = <span class="literal">false</span></span><br><span class="line">    disable_tcp_service = <span class="literal">true</span></span><br><span class="line">    enable_selinux = <span class="literal">false</span></span><br><span class="line">    enable_tls_streaming = <span class="literal">false</span></span><br><span class="line">    enable_unprivileged_icmp = <span class="literal">false</span></span><br><span class="line">    enable_unprivileged_ports = <span class="literal">false</span></span><br><span class="line">    ignore_image_defined_volumes = <span class="literal">false</span></span><br><span class="line">    max_concurrent_downloads = 3</span><br><span class="line">    max_container_log_line_size = 16384</span><br><span class="line">    netns_mounts_under_state_dir = <span class="literal">false</span></span><br><span class="line">    restrict_oom_score_adj = <span class="literal">false</span></span><br><span class="line">    sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line">    selinux_category_range = 1024</span><br><span class="line">    stats_collect_period = 10</span><br><span class="line">    stream_idle_timeout = <span class="string">&quot;4h0m0s&quot;</span></span><br><span class="line">    stream_server_address = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    stream_server_port = <span class="string">&quot;0&quot;</span></span><br><span class="line">    systemd_cgroup = <span class="literal">false</span></span><br><span class="line">    tolerate_missing_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    unset_seccomp_profile = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.cni]</span><br><span class="line">      bin_dir = <span class="string">&quot;/opt/cni/bin&quot;</span></span><br><span class="line">      conf_dir = <span class="string">&quot;/etc/cni/net.d&quot;</span></span><br><span class="line">      conf_template = <span class="string">&quot;&quot;</span></span><br><span class="line">      ip_pref = <span class="string">&quot;&quot;</span></span><br><span class="line">      max_conf_num = 1</span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd]</span><br><span class="line">      default_runtime_name = <span class="string">&quot;runc&quot;</span></span><br><span class="line">      disable_snapshot_annotations = <span class="literal">true</span></span><br><span class="line">      discard_unpacked_layers = <span class="literal">false</span></span><br><span class="line">      ignore_rdt_not_enabled_errors = <span class="literal">false</span></span><br><span class="line">      no_pivot = <span class="literal">false</span></span><br><span class="line">      snapshotter = <span class="string">&quot;overlayfs&quot;</span></span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.default_runtime]</span><br><span class="line">        base_runtime_spec = <span class="string">&quot;&quot;</span></span><br><span class="line">        cni_conf_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">        cni_max_conf_num = 0</span><br><span class="line">        container_annotations = []</span><br><span class="line">        pod_annotations = []</span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        runtime_engine = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_path = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_type = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.default_runtime.options]</span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes]</span><br><span class="line"></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc]</span><br><span class="line">          base_runtime_spec = <span class="string">&quot;&quot;</span></span><br><span class="line">          cni_conf_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">          cni_max_conf_num = 0</span><br><span class="line">          container_annotations = []</span><br><span class="line">          pod_annotations = []</span><br><span class="line">          privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">          runtime_engine = <span class="string">&quot;&quot;</span></span><br><span class="line">          runtime_path = <span class="string">&quot;&quot;</span></span><br><span class="line">          runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">          runtime_type = <span class="string">&quot;io.containerd.runc.v2&quot;</span></span><br><span class="line"></span><br><span class="line">          [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">            SystemdCgroup = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.untrusted_workload_runtime]</span><br><span class="line">        base_runtime_spec = <span class="string">&quot;&quot;</span></span><br><span class="line">        cni_conf_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">        cni_max_conf_num = 0</span><br><span class="line">        container_annotations = []</span><br><span class="line">        pod_annotations = []</span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        runtime_engine = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_path = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">        runtime_type = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.untrusted_workload_runtime.options]</span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.image_decryption]</span><br><span class="line">      key_model = <span class="string">&quot;node&quot;</span></span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      config_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.auths]</span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs]</span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.headers]</span><br><span class="line"></span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://frz7i079.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line"></span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.x509_key_pair_streaming]</span><br><span class="line">      tls_cert_file = <span class="string">&quot;&quot;</span></span><br><span class="line">      tls_key_file = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.internal.v1.opt&quot;</span>]</span><br><span class="line">    path = <span class="string">&quot;/opt/containerd&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.internal.v1.restart&quot;</span>]</span><br><span class="line">    interval = <span class="string">&quot;10s&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.internal.v1.tracing&quot;</span>]</span><br><span class="line">    sampling_ratio = 1.0</span><br><span class="line">    service_name = <span class="string">&quot;containerd&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.metadata.v1.bolt&quot;</span>]</span><br><span class="line">    content_sharing_policy = <span class="string">&quot;shared&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.monitor.v1.cgroups&quot;</span>]</span><br><span class="line">    no_prometheus = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.runtime.v1.linux&quot;</span>]</span><br><span class="line">    no_shim = <span class="literal">false</span></span><br><span class="line">    runtime = <span class="string">&quot;runc&quot;</span></span><br><span class="line">    runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">    shim = <span class="string">&quot;containerd-shim&quot;</span></span><br><span class="line">    shim_debug = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.runtime.v2.task&quot;</span>]</span><br><span class="line">    platforms = [<span class="string">&quot;linux/amd64&quot;</span>]</span><br><span class="line">    sched_core = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.service.v1.diff-service&quot;</span>]</span><br><span class="line">    default = [<span class="string">&quot;walking&quot;</span>]</span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.service.v1.tasks-service&quot;</span>]</span><br><span class="line">    rdt_config_file = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.aufs&quot;</span>]</span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.btrfs&quot;</span>]</span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.devmapper&quot;</span>]</span><br><span class="line">    async_remove = <span class="literal">false</span></span><br><span class="line">    base_image_size = <span class="string">&quot;&quot;</span></span><br><span class="line">    discard_blocks = <span class="literal">false</span></span><br><span class="line">    fs_options = <span class="string">&quot;&quot;</span></span><br><span class="line">    fs_type = <span class="string">&quot;&quot;</span></span><br><span class="line">    pool_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.native&quot;</span>]</span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.overlayfs&quot;</span>]</span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line">    upperdir_label = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.snapshotter.v1.zfs&quot;</span>]</span><br><span class="line">    root_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.tracing.processor.v1.otlp&quot;</span>]</span><br><span class="line">    endpoint = <span class="string">&quot;&quot;</span></span><br><span class="line">    insecure = <span class="literal">false</span></span><br><span class="line">    protocol = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[proxy_plugins]</span><br><span class="line"></span><br><span class="line">[stream_processors]</span><br><span class="line"></span><br><span class="line">  [stream_processors.<span class="string">&quot;io.containerd.ocicrypt.decoder.v1.tar&quot;</span>]</span><br><span class="line">    accepts = [<span class="string">&quot;application/vnd.oci.image.layer.v1.tar+encrypted&quot;</span>]</span><br><span class="line">    args = [<span class="string">&quot;--decryption-keys-path&quot;</span>, <span class="string">&quot;/etc/containerd/ocicrypt/keys&quot;</span>]</span><br><span class="line">    <span class="built_in">env</span> = [<span class="string">&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;</span>]</span><br><span class="line">    path = <span class="string">&quot;ctd-decoder&quot;</span></span><br><span class="line">    returns = <span class="string">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span></span><br><span class="line"></span><br><span class="line">  [stream_processors.<span class="string">&quot;io.containerd.ocicrypt.decoder.v1.tar.gzip&quot;</span>]</span><br><span class="line">    accepts = [<span class="string">&quot;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&quot;</span>]</span><br><span class="line">    args = [<span class="string">&quot;--decryption-keys-path&quot;</span>, <span class="string">&quot;/etc/containerd/ocicrypt/keys&quot;</span>]</span><br><span class="line">    <span class="built_in">env</span> = [<span class="string">&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;</span>]</span><br><span class="line">    path = <span class="string">&quot;ctd-decoder&quot;</span></span><br><span class="line">    returns = <span class="string">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span></span><br><span class="line"></span><br><span class="line">[timeouts]</span><br><span class="line">  <span class="string">&quot;io.containerd.timeout.bolt.open&quot;</span> = <span class="string">&quot;0s&quot;</span></span><br><span class="line">  <span class="string">&quot;io.containerd.timeout.shim.cleanup&quot;</span> = <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="string">&quot;io.containerd.timeout.shim.load&quot;</span> = <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="string">&quot;io.containerd.timeout.shim.shutdown&quot;</span> = <span class="string">&quot;3s&quot;</span></span><br><span class="line">  <span class="string">&quot;io.containerd.timeout.task.state&quot;</span> = <span class="string">&quot;2s&quot;</span></span><br><span class="line"></span><br><span class="line">[ttrpc]</span><br><span class="line">  address = <span class="string">&quot;&quot;</span></span><br><span class="line">  gid = 0</span><br><span class="line">  uid = 0</span><br></pre></td></tr></table></figure><p><strong>重启服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl enable containerd;systemctl restart containerd</span></span><br><span class="line">[root@node002 ~]<span class="comment"># systemctl enable containerd;systemctl restart containerd</span></span><br><span class="line">[root@node003 ~]<span class="comment"># systemctl enable containerd;systemctl restart containerd</span></span><br></pre></td></tr></table></figure><h2 id="4-配置crictl客户端工具">4. 配置crictl客户端工具</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">[root@node002 ~]<span class="comment"># crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">[root@node003 ~]<span class="comment"># crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock</span></span><br></pre></td></tr></table></figure><h2 id="5-nerdctl安装和配置">5. nerdctl安装和配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -OL https://github.com/containerd/nerdctl/releases/download/v0.22.0/nerdctl-0.22.0-linux-amd64.tar.gz</span><br><span class="line">tar xf nerdctl-0.22.0-linux-amd64.tar.gz -C /usr/bin/</span><br><span class="line"></span><br><span class="line">curl -OL https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz</span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/cni/bin</span><br><span class="line">tar xf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/</span><br></pre></td></tr></table></figure><p><strong>创建配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/nerdctl/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/nerdctl/nerdctl.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">debug = false</span></span><br><span class="line"><span class="string">debug_full = false</span></span><br><span class="line"><span class="string">address = &quot;unix:///var/run/containerd/containerd.sock&quot;</span></span><br><span class="line"><span class="string">namespace = &quot;k8s.io&quot;</span></span><br><span class="line"><span class="string">#snapshotter = &quot;stargz&quot;</span></span><br><span class="line"><span class="string">cgroup_manager = &quot;systemd&quot;</span></span><br><span class="line"><span class="string">hosts_dir = [&quot;/etc/containerd/certs.d&quot;]</span></span><br><span class="line"><span class="string">insecure_registry = false</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>镜像加速</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd/certs.d/docker.io</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># server = &quot;https://docker.io&quot;</span></span><br><span class="line"><span class="string">[host.&quot;https://frz7i079.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">capabilities = [&quot;pull&quot;,&quot;resolve&quot;]</span></span><br><span class="line"><span class="string">override_path = true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>切换名称空间</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CONTAINERD_NAMESPACE=k8s.io</span><br></pre></td></tr></table></figure><h2 id="6-安装k8s">6. 安装k8s</h2><p><strong>查看yum源中可用的版本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum list --showduplicates kubeadm --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><p><strong>安装客户端工具</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install -y kubelet-1.24.2-0 kubeadm-1.24.2-0 kubectl-1.24.2-0 --disableexcludes=kubernetes</span></span><br><span class="line">[root@node002 ~]<span class="comment"># yum install -y kubelet-1.24.2-0 kubeadm-1.24.2-0 kubectl-1.24.2-0 --disableexcludes=kubernetes</span></span><br><span class="line">[root@node003 ~]<span class="comment"># yum install -y kubelet-1.24.2-0 kubeadm-1.24.2-0 kubectl-1.24.2-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure><p><strong>启动kubelet</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># systemctl restart kubelet ; systemctl enable kubelet</span></span><br><span class="line">[root@node002 ~]<span class="comment"># systemctl restart kubelet ; systemctl enable kubelet</span></span><br><span class="line">[root@node003 ~]<span class="comment"># systemctl restart kubelet ; systemctl enable kubelet</span></span><br></pre></td></tr></table></figure><p><strong>初始化安装1.24.2</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version=v1.24.2 --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 172.17.203.55:6443 --token 58kell.5rbsvxa5pftz54v3 \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:c38177a8a3962a5e50a3d8e58f60de869d315d3c753b915e69d7a3ec70a6faea</span><br></pre></td></tr></table></figure><p><strong>其他节点加入集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 172.17.203.55:6443 --token 58kell.5rbsvxa5pftz54v3 \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:c38177a8a3962a5e50a3d8e58f60de869d315d3c753b915e69d7a3ec70a6faea</span><br></pre></td></tr></table></figure><p><strong>查看node节点状态</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME      STATUS     ROLES           AGE     VERSION</span><br><span class="line">node001   NotReady   control-plane   3m58s   v1.24.2</span><br><span class="line">node002   NotReady   &lt;none&gt;          48s     v1.24.2</span><br><span class="line">node003   NotReady   &lt;none&gt;          45s     v1.24.2</span><br></pre></td></tr></table></figure><p><strong>安装cni网络插件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># wget https://docs.projectcalico.org/manifests/calico.yaml</span></span><br><span class="line"></span><br><span class="line">修改calico里pod所在网段</span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为了防止多张网卡带来的问题，修改calico.yaml</span><br><span class="line">            - name: CALICO_IPV4POOL_VXLAN</span><br><span class="line">              value: <span class="string">&quot;Never&quot;</span></span><br><span class="line">            - name: IP_AUTODETECTION_METHOD</span><br><span class="line">              value: <span class="string">&quot;interface=eth1&quot;</span></span><br></pre></td></tr></table></figure><p><strong>安装calico</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl apply -f calico.yaml</span></span><br></pre></td></tr></table></figure><p><strong>安装命令补全</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># yum install bash-completion -y</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure><p><strong>集群状态</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME      STATUS   ROLES           AGE   VERSION</span><br><span class="line">node001   Ready    control-plane   32m   v1.24.2</span><br><span class="line">node002   Ready    &lt;none&gt;          29m   v1.24.2</span><br><span class="line">node003   Ready    &lt;none&gt;          29m   v1.24.2</span><br></pre></td></tr></table></figure><h2 id="7-删除新增节点">7. 删除新增节点</h2><p><strong>删除节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubectl drain node003 --ignore-daemonsets</span></span><br><span class="line">[root@node001 ~]<span class="comment"># kubectl delete nodes node003 </span></span><br><span class="line">[root@node001 ~]<span class="comment"># kubectl get nodes </span></span><br><span class="line">NAME      STATUS   ROLES           AGE   VERSION</span><br><span class="line">node001   Ready    control-plane   36m   v1.24.2</span><br><span class="line">node002   Ready    &lt;none&gt;          33m   v1.24.2</span><br></pre></td></tr></table></figure><p><strong>node003重置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># kubeadm reset</span></span><br></pre></td></tr></table></figure><p><strong>获取加入集群的命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># kubeadm token create --print-join-command</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 172.17.203.55:6443 --token yl9g09.34s5glmqlomdjc59 --discovery-token-ca-cert-hash sha256:c38177a8a3962a5e50a3d8e58f60de869d315d3c753b915e69d7a3ec70a6faea </span><br></pre></td></tr></table></figure><p><strong>重新加入集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node003 ~]<span class="comment"># kubeadm join 172.17.203.55:6443 --token yl9g09.34s5glmqlomdjc59 --discovery-token-ca-cert-hash sha256:c38177a8a3962a5e50a3d8e58f60de869d315d3c753b915e69d7a3ec70a6faea</span></span><br></pre></td></tr></table></figure><h2 id="8-安装metrics-server">8. 安装metrics-server</h2><p><strong>下载最新版本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes-sigs/metrics-server/releases/tag/metrics-server-helm-chart-3.8.2</span><br><span class="line"></span><br><span class="line">导入镜像</span><br><span class="line">[root@node001 metrics]<span class="comment"># nerdctl load -i metric-img-v0.6.1.tar </span></span><br><span class="line">[root@node002 metrics]<span class="comment"># nerdctl load -i metric-img-v0.6.1.tar </span></span><br><span class="line">[root@node003 metrics]<span class="comment"># nerdctl load -i metric-img-v0.6.1.tar </span></span><br></pre></td></tr></table></figure><p><strong>修改配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改metrics-server-deployment.yaml</span><br><span class="line">containers: - name: metrics-server</span><br><span class="line">image: k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br><span class="line"><span class="comment">#imagePullPolicy: Always</span></span><br><span class="line">imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="built_in">command</span>: - /metrics-server</span><br><span class="line"> - --metric-resolution=30s</span><br><span class="line"> - --kubelet-insecure-tls</span><br><span class="line"> - --kubelet-preferred-address-types=InternalIP</span><br><span class="line"> <span class="comment">#- --cert-dir=/tmp</span></span><br></pre></td></tr></table></figure><p><strong>安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 metrics]<span class="comment"># kubectl apply -f components.yaml </span></span><br></pre></td></tr></table></figure><p><strong>查看负载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 metrics]<span class="comment"># kubectl  top node</span></span><br><span class="line">NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">node001   84m          2%     1929Mi          52%       </span><br><span class="line">node002   32m          0%     717Mi           19%       </span><br><span class="line">node003   36m          0%     910Mi           24% </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1.k8s简介</title>
      <link href="/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/"/>
      <url>/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介-7">1. 简介</h2><p>  我们可以使用<code>docker run</code>或<code>nerdctl run</code>这样的命令来创建一个一个的容器， 那么我们在创建这些容器的时候，其实一个一个去创建的话整个的性能太低，而且假如说需要创建几十个或几百个容器的话，手动创建基本是不太现实的，所以说我们是需要一个更高层的编排工具。<br>  常见的编排工具有：<code>kubernetes</code>、红帽的<code>openshift</code>、twitter的<code>mesos</code>、docker的<code>swarm</code>等，不过目前来说kubernetes已经是一家独大而且基本是标准了。在k8s中不需要我们再去操作容器了，而是由k8s来帮我们管理容器，维持我们想要的容器状态。<br>  k8s本身并不提供容器创建的功能，它需要调用<code>runtime</code>，而<code>runtime</code>的类型还是挺多的比如说<code>docker</code>、<code>podman</code>、<code>containerd</code>、<code>rkt</code>、<code>cri-o</code>等，对于k8s来说它有一个代理叫<code>kubelet</code>而<code>kubelet</code>需要和各个<code>runtime</code>做关联。在k8s刚发布的时候基本上是<code>docker</code>一家独大，其他运行时基本不成气候，所以说kubelet内置了docker的代码来连接到docker，随着时间推移容器界百花争鸣像<code>containerd</code>、<code>rkt</code>、<code>podman</code>等项目说我也想成为你k8s的<code>runtime</code>,为了统一<code>runtime</code>k8s在kubelet上开放了一个CRI标准，你们开发的产品只要符合这个CRI标准那么我就可以使用你们产品作为<code>runtime</code>，然而<code>docker</code>并不支持CRI协议，一开始k8s是妥协的，就把docker-shim集成到kubelet中，直到1.24版本k8s把docker-shim从kubelet中剔除掉，docker又不支持CRI标准，要使用docker作为runtime则需要一个<code>cri-docker</code>作为转接口。所以作为k8s管理员，发布一个请求说我要创建一个容器，创建容器的时候是由kubelet调用后端的runtime最终创建出来的。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/2022-08-07-022913.png" class=""><h2 id="2-理解pod">2. 理解pod</h2><p>  我们使用<code>nerdctl</code>创建出来的都是一个一个的容器，而使用k8s进行管理的时候创建出来的都是一个一个的pod,那什么是pod？所谓pod就是包装好了的强化功能的的容器，一个pod中所有容器共享网络空间，在k8s里最小的调度单元就是pod.</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/pod.png" class=""><h2 id="3-k8s框架">3. k8s框架</h2><p>  其实虚拟化和云平台的架构都是类似的，首选也需要有一个控制台，这个控制台我们称为<code>master</code>或称为<code>control plane</code>，其次还需要一个一个的工作节点我们称为<code>worker node</code>,它是专门用来运行容器的，所以需要在在每个node节点装上<code>runtime</code> ,然后需要一个client端可以是命令行也可以是图形界面，来连接到master节点的<code>kube-apiserver</code>组件（需要通过<code>认证</code>），再通过<code>鉴权</code>才可以创建出来pod，那么k8s如何知道pod创建到哪个node节点呢，那么就需要引出第二个组件<code>kube-scheduler</code>调度器这个组件他会根据自己的算法，根据node节点的cpu内存等资源进行打分，分值越高约优先进行调度。之后<code>kube-apiserver</code>就会通知<code>kubelet</code>进行容器创建，<code>kubelet</code>就会调用<code>runtime</code>通过<code>pause</code>这个镜像创建出需要的pod。看似一切都OK了，那么如何保证pod运行正常呢，那么就需要引出另一个master组件<code>kube-controller-manager</code>其中包括了namespace控制器、node控制器、deployment控制器等等。因此可知pod是不稳定的，当pod重建以后里面的容器IP就会发生变化，那么如何保证可以连接到pod呢，就需要引出另一个node节点组件<code>kube-proxy</code>，这个组件有两种模式<code>iptables</code>和<code>ipvs</code>把流量转发到指定的pod，具体实现通过k8s自定义类型<code>service</code>简称svc,通过配置svc标签选择器来找到指定的pod的<code>endpoint</code>。我们知道宿主机之间有层网络，pod有层网络，service有层网络，那么如何保证pod层和service层网络可以跨主机通信呢，那么就需要通过隧道协议来打通各主机间虚拟网络，具体实现方式有<code>BGP</code>、<code>openvswitch</code>、<code>vxlan</code>等技术.这太难了！！！，不用担心，有一些厂商或组织开发出符合CNI（容器网络接口规范）的产品他们已经把这些技术封装到产品里，我们只需要安装指定的产品配置即可使用，例如：<code>calico</code>、<code>flannel</code>等，这些产品我们统称为CNI网络插件。到目前为止，我们所有的配置都需要保存下来做持续化存储，k8s中用到的持久存储是<code>etcd</code>，存储了集群信息，包括cni网络插件信息也需要持久化到etcd中</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220806/kubernetes-20220806-1-k8s%E7%AE%80%E4%BB%8B/k8skuangjia.png" class=""><h2 id="4-k8s组件">4. k8s组件</h2><ul><li>kubectl:客户端命令行工具。</li><li>kube-apiserver:作为整个系统的控制入口，以REST API服务提供接口。</li><li>kube-controller-manager:用来执行整个系统中的后台任务，包括节点状态状况、Pod个数、Pods和Service的关联等。</li><li>kube-scheduler: 接受来自kube-apiserver创建Pods任务，分配到某个节点。</li><li>etcd:存储集群信息的分布式存储。</li><li>kube-proxy: 运行在每个计算节点上，负责Pod网络代理。定时从etcd获取到service信息来做相应的策略。</li><li>kubelet:运行在每个计算节点上，作为agent，接受分配该节点的Pods任务及管理容器，周期性获取容器状态，反馈给kube-apiserver。</li></ul>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>容器监控</title>
      <link href="/20220801/containerd-20220801-6-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/"/>
      <url>/20220801/containerd-20220801-6-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/</url>
      
        <content type="html"><![CDATA[<h2 id="1-cadvisor监控">1. cadvisor监控</h2><p>利用谷歌的cadvisor，目前只能监控docker下的容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> docker pull hub.c.163.com/xbingo/cadvisor:latest</span><br><span class="line">docker run \</span><br><span class="line">-v /var/run:/var/run \</span><br><span class="line">-v /sys:/sys:ro \</span><br><span class="line">-v /var/lib/docker:/var/lib/docker:ro \</span><br><span class="line">-d -p 8080:8080 --name=mon \</span><br><span class="line">hub.c.163.com/xbingo/cadvisor:latest</span><br></pre></td></tr></table></figure><h2 id="2-scope监控">2. scope监控</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]# ./scope launch</span><br><span class="line">6766fe71c2edc2977631a9b419f640d974f590af52ffd8b15581672e1193c896</span><br><span class="line">Scope probe started</span><br><span class="line">Weave Scope is listening at the following URL(s):</span><br><span class="line">  * http://192.168.10.10:4040/</span><br><span class="line">  * http://10.4.0.1:4040/</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>限制容器资源</title>
      <link href="/20220731/containerd-20220731-5-%E9%99%90%E5%88%B6%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90/"/>
      <url>/20220731/containerd-20220731-5-%E9%99%90%E5%88%B6%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90/</url>
      
        <content type="html"><![CDATA[<h2 id="1-了解Cgroup">1. 了解Cgroup</h2><p>cgroups的全称是Linux Control Groups，主要作用是限制、记录和隔离进程组（process groups）使用的物理资源（cpu、memory、IO等）</p><p>Cgroup提供了一个原生接口并通过<font color=red size=2>cgroupfs</font>提供（cgroupfs就是Cgroup的一个借口封装）。类似于procfs和sysfs，是一种虚拟文件系统。并且cgroupfs是可以挂载的，默认情况下挂载在/sys/fs/cgroup目录。</p><p><font color=red size=2>Systemd</font>也是对于Cgroup接口的一个封装。systemd以PID1的形式在系统启动的时候运行，并提供了一套系统管理守护程序、库和实用程序，用来控制、管理Linux计算机操作系统资源。通过systemd-cgls命令我们可以看到systemd工作的进程PID是1，而目录/sys/cgroup/systemd/是systemd维护的自己使用的非subsystem的cgroups层级结构。</p><h2 id="2-对容器内存的限制">2. 对容器内存的限制</h2><p><strong>运行一个容器,不限制的情况下压测</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=c1 --restart=always centos <span class="built_in">sleep</span> 1d</span><br></pre></td></tr></table></figure><p><strong>安装压测工具</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nerdctl <span class="built_in">cp</span> memload-7.0-1.r29766.x86_64.rpm c1:/opt/</span><br><span class="line">[root@control ~]<span class="comment"># nerdctl exec -it c1 bash</span></span><br><span class="line">[root@ab3af419f53a /]<span class="comment"># cd /opt/</span></span><br><span class="line">[root@ab3af419f53a opt]<span class="comment"># rpm -ivh memload-7.0-1.r29766.x86_64.rpm </span></span><br><span class="line">[root@ab3af419f53a /]<span class="comment"># memload 1000</span></span><br><span class="line">[root@control ~]<span class="comment"># nerdctl stats</span></span><br></pre></td></tr></table></figure><p><strong>限制资源使用</strong><br>限制内存使用512mb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]<span class="comment"># nerdctl run -d --name=c1 --restart=always -m 512m centos sleep 1d</span></span><br></pre></td></tr></table></figure><p><strong>压测</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ab3af419f53a /]<span class="comment"># memload 1000</span></span><br></pre></td></tr></table></figure><p><strong>查看容器资源使用量</strong></p><h2 id="3-对容器CPU亲和性">3. 对容器CPU亲和性</h2><p><strong>临时进入容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]<span class="comment"># nerdctl run -it --name c1 --rm centos bash</span></span><br></pre></td></tr></table></figure><p><strong>创建3个进程</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@06f9d93ae4da /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[1] 16</span><br><span class="line">[root@06f9d93ae4da /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[2] 17</span><br><span class="line">[root@06f9d93ae4da /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[3] 18</span><br></pre></td></tr></table></figure><p><strong>进程随机运行到cpu上</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@06f9d93ae4da /]# ps mo pid,comm,psr $(pgrep cat)</span><br><span class="line">   PID COMMAND         PSR</span><br><span class="line">    16 cat               -</span><br><span class="line">     - -                 2</span><br><span class="line">    17 cat               -</span><br><span class="line">     - -                 0</span><br><span class="line">    18 cat               -</span><br><span class="line">     - -                 3</span><br></pre></td></tr></table></figure><p><strong>限制容器只能运行在0号cpu</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@control ~]<span class="comment"># nerdctl run -it --name c1 --rm --cpuset-cpus 0  centos bash</span></span><br><span class="line">[root@16215eb83f99 /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[1] 15</span><br><span class="line">[root@16215eb83f99 /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[2] 16</span><br><span class="line">[root@16215eb83f99 /]<span class="comment"># cat /dev/zero  &gt; /dev/null &amp;</span></span><br><span class="line">[3] 17</span><br><span class="line">[root@16215eb83f99 /]<span class="comment"># ps mo pid,comm,psr $(pgrep cat)</span></span><br><span class="line">   PID COMMAND         PSR</span><br><span class="line">    15 <span class="built_in">cat</span>               -</span><br><span class="line">     - -                 0</span><br><span class="line">    16 <span class="built_in">cat</span>               -</span><br><span class="line">     - -                 0</span><br><span class="line">    17 <span class="built_in">cat</span>               -</span><br><span class="line">     - -                 0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4.harbor</title>
      <link href="/20220717/containerd-20220717-4-harbor/"/>
      <url>/20220717/containerd-20220717-4-harbor/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装docker-compose">1. 安装docker-compose</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># yum install docker-compose -y</span></span><br></pre></td></tr></table></figure><h2 id="2-配置docker允许http访问">2. 配置docker允许http访问</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;max-concurrent-uploads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://7bezldxe.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;192.168.8.182&quot;</span>],</span><br><span class="line">    <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-下载harbor离线安装包">3. 下载harbor离线安装包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -OL https://github.com/goharbor/harbor/releases/tag/v2.5.3</span><br></pre></td></tr></table></figure><h2 id="4-安装harbor">4. 安装harbor</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]<span class="comment"># docker load -i harbor.v2.3.5.tar.gz</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3.自定义镜像</title>
      <link href="/20220710/containerd-20220710-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F/"/>
      <url>/20220710/containerd-20220710-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="1-概述">1. 概述</h2><p>nerdctl想要构建镜像需要安装buildkit插件，且不能基于本地镜像进行构建，所以建议构建镜像和镜像仓库仍使用docker作为运行时。</p><h2 id="2-安装docker-ce">2. 安装docker-ce</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /etc/yum.repos.d/* &amp;&amp; wget ftp://ftp.rhce.cc/k8s/* -P /etc/yum.repos.d/</span></span><br><span class="line">[root@harbor ~]<span class="comment"># yum install docker-ce -y</span></span><br><span class="line">[root@harbor ~]<span class="comment"># systemctl enable docker --now</span></span><br></pre></td></tr></table></figure><h2 id="3-添加配置文件">3. 添加配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;max-concurrent-uploads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://7bezldxe.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-创建Dockerfile">4. 创建Dockerfile</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM hub.c.163.com/library/centos</span><br><span class="line">MAINTAINER ren</span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span><br><span class="line">ADD repo.tar /etc/yum.repos.d/</span><br><span class="line">RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* &amp;&amp; \</span><br><span class="line">yum install net-tools iproute nginx -y &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -rf /var/cache/yum/x86_64/*</span><br><span class="line">COPY index.html /usr/share/nginx/html/</span><br><span class="line">ENV myname xxx</span><br><span class="line">VOLUME [<span class="string">&quot;/data1&quot;</span>,<span class="string">&quot;/data2&quot;</span>]</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="5-构建镜像">5. 构建镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t centos:v1 .</span><br></pre></td></tr></table></figure><h2 id="6-容器构建层">6. 容器构建层</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># docker history nginx:v1</span></span><br><span class="line">IMAGE          CREATED             CREATED BY                                      SIZE      COMMENT</span><br><span class="line">2d27d9685011   2 minutes ago       /bin/sh -c <span class="comment">#(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span></span><br><span class="line">78910337674c   2 minutes ago       /bin/sh -c <span class="comment">#(nop)  USER ren                     0B</span></span><br><span class="line">a08ee1b47ccb   2 minutes ago       /bin/sh -c <span class="comment">#(nop)  VOLUME [/data1 /data2]       0B</span></span><br><span class="line">b113d86db0f8   2 minutes ago       /bin/sh -c <span class="comment">#(nop)  ENV myname=xxx               0B</span></span><br><span class="line">3850648e9adc   2 minutes ago       /bin/sh -c <span class="comment">#(nop) COPY file:a633a7048410ec7d…   9B</span></span><br><span class="line">c4b8c4b6bb2f   2 minutes ago       /bin/sh -c rpm --import /etc/pki/rpm-gpg/RPM…   57MB</span><br><span class="line">921bf2371e22   54 minutes ago      /bin/sh -c <span class="comment">#(nop) ADD file:7f9bc919601a811e4…   3.13kB</span></span><br><span class="line">478e859d1eb5   54 minutes ago      /bin/sh -c <span class="built_in">rm</span> -rf /etc/yum.repos.d/*            0B</span><br><span class="line">88d815c24789   About an hour ago   /bin/sh -c <span class="comment">#(nop)  MAINTAINER ren               0B</span></span><br><span class="line">328edcd84f1b   4 years ago         /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago         /bin/sh -c <span class="comment">#(nop)  LABEL name=CentOS Base Im…   0B</span></span><br><span class="line">&lt;missing&gt;      4 years ago         /bin/sh -c <span class="comment">#(nop) ADD file:63492ba809361c51e…   193MB</span></span><br></pre></td></tr></table></figure><h2 id="7-测试镜像">7. 测试镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nginx -p 80:80 nginx:v1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.containerd安装使用</title>
      <link href="/20220709/containerd-20220709-2-containerd%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
      <url>/20220709/containerd-20220709-2-containerd%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装">1. 安装</h2><p><strong>配置yum源安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.rhce.cc/k8s/* -P /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">yum install containerd.io cri-tools -y</span><br></pre></td></tr></table></figure><p><strong>生成默认配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><p><strong>修改配置文件</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="string">plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors</span>]</span><br><span class="line">[<span class="string">plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;</span>]</span><br><span class="line"><span class="string">endpoint</span> <span class="string">=</span> [<span class="string">&quot;https://frz7i079.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">sandbox_image</span> <span class="string">=</span> <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options</span>]</span><br><span class="line"><span class="string">SystemdCgroup</span> <span class="string">=</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>添加源</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd/certs.d/docker.io </span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string"># server = &quot;https://docker.io&quot; </span></span><br><span class="line"><span class="string">[host.&quot;https://frz7i079.mirror.aliyuncs.com&quot;] </span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;] </span></span><br><span class="line"><span class="string">  override_path = true </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>容器开机启动</strong><br>containerd默认创建的容器不会开机自启</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loginctl enable-linger root</span><br><span class="line">loginctl show-user root | grep Linger </span><br></pre></td></tr></table></figure><p><strong>添加内核参数</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/sysctl.d/containerd.conf </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1 </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1 </span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1 </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>查看生效配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config dump</span><br></pre></td></tr></table></figure><p><strong>启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> containerd --now</span><br></pre></td></tr></table></figure><p><strong>安装nerdctl</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -OL https://github.com/containerd/nerdctl/releases/download/v0.22.0/nerdctl-0.22.0-linux-amd64.tar.gz</span><br><span class="line">curl -OL https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz</span><br><span class="line">tar xf nerdctl-0.22.0-linux-amd64.tar.gz -C /opt/kube/bin/</span><br><span class="line">tar xf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/</span><br></pre></td></tr></table></figure><p><strong>添加命令补全</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/profile</span><br><span class="line"><span class="built_in">source</span> &lt;(nerdctl completion bash)</span><br></pre></td></tr></table></figure><p><strong>创建客户端配置文件</strong><br>nerdctl不读取/etc/containerd/config.toml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/nerdctl</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/nerdctl/nerdctl.toml &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string">debug = false </span></span><br><span class="line"><span class="string">debug_full = false </span></span><br><span class="line"><span class="string">address = &quot;unix:///var/run/containerd/containerd.sock&quot; </span></span><br><span class="line"><span class="string">namespace = &quot;default&quot; </span></span><br><span class="line"><span class="string">#snapshotter = &quot;stargz&quot; </span></span><br><span class="line"><span class="string">cgroup_manager = &quot;systemd&quot; </span></span><br><span class="line"><span class="string">#hosts_dir = [&quot;/etc/containerd/certs.d&quot;, &quot;/etc/nerdctl/certs.d&quot;] </span></span><br><span class="line"><span class="string">insecure_registry = true </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>查看运行容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl ps</span></span><br><span class="line">CONTAINER ID    IMAGE                                  COMMAND                   CREATED         STATUS    PORTS                     NAMES</span><br><span class="line">2eaf94dd7455    hub.c.163.com/library/centos:latest    <span class="string">&quot;tail -f /dev/null&quot;</span>       33 hours ago    Up                                  c1</span><br><span class="line">3c78be6431c2    hub.c.163.com/library/mysql:latest     <span class="string">&quot;docker-entrypoint.s…&quot;</span>    5 days ago      Up        0.0.0.0:3307-&gt;3306/tcp    db</span><br></pre></td></tr></table></figure><h2 id="2-镜像管理">2. 镜像管理</h2><p><strong>自定义tag</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl tag nginx:latest renmcc/nginx:v1</span><br></pre></td></tr></table></figure><p><strong>导入导出</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出镜像</span></span><br><span class="line">nerdctl save nginx -o nginx.tar</span><br><span class="line"><span class="comment"># 倒入镜像</span></span><br><span class="line">nerdctl load -i nginx.tar</span><br></pre></td></tr></table></figure><p><strong>查看容器构建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl <span class="built_in">history</span> nginx --no-trunc</span><br></pre></td></tr></table></figure><h2 id="3-容器管理">3. 容器管理</h2><p><strong>运行容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run --name centos -it hub.c.163.com/library/centos /bin/bash</span><br><span class="line">nerdctl run --name centos -it --<span class="built_in">rm</span> hub.c.163.com/library/centos /bin/bash</span><br><span class="line">nerdctl run --name=nginx -d --restart=always -p 80:80 nginx</span><br><span class="line">nerdctl run --name=db -d --restart=always -e MYSQL_ROOT_PASSWORD=910202 -e MYSQL_DATABASE=blog -p 3307:3306 hub.c.163.com/library/mysql:latest</span><br></pre></td></tr></table></figure><p><strong>查看容器配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl inspect db|grep Address</span></span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.4.0.13&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;3a:9c:d8:5d:55:37&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.4.0.13&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;3a:9c:d8:5d:55:37&quot;</span></span><br></pre></td></tr></table></figure><p><strong>查看容器中运行程序</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl top db</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">polkitd             1579                1528                0                   20:11               ?                   00:00:01            mysqld</span><br></pre></td></tr></table></figure><h2 id="4-数据卷使用">4. 数据卷使用</h2><p><strong>映射data数据卷</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=nginx -v /data:/data nginx:alpine</span><br></pre></td></tr></table></figure><p><strong>查看所有数据卷</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl volume ls</span></span><br><span class="line">VOLUME NAME                                                         DIRECTORY</span><br><span class="line">23080f5296e127cf1534050e0a04318ac2791d49ee361291522fb4a2ec9819b8    /var/lib/nerdctl/1935db59/volumes/default/23080f5296e127cf1534050e0a04318ac2791d49ee361291522fb4a2ec9819b8/_data</span><br><span class="line">4c8ae79c628da515a738593d8fdcd90b3942957885da54be9b6f5890eb283b01    /var/lib/nerdctl/1935db59/volumes/default/4c8ae79c628da515a738593d8fdcd90b3942957885da54be9b6f5890eb283b01/_data</span><br><span class="line">e3f5c53ba515831cc5a51642c209da3079345e0139750bcec812c3f687e9bcc7    /var/lib/nerdctl/1935db59/volumes/default/e3f5c53ba515831cc5a51642c209da3079345e0139750bcec812c3f687e9bcc7/_data</span><br><span class="line">00dc7812fc9149ab6f6af3d862b9c32a1675234ccb54bd9f227c88f75d71eec8    /var/lib/nerdctl/1935db59/volumes/default/00dc7812fc9149ab6f6af3d862b9c32a1675234ccb54bd9f227c88f75d71eec8/_data</span><br></pre></td></tr></table></figure><p><strong>宿主机和容器数据复制</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝宿主机文件到容器</span></span><br><span class="line">nerdctl <span class="built_in">cp</span> /etc/hosts nginx:/tmp</span><br><span class="line"><span class="comment"># 拷贝容器内文件到宿主机</span></span><br><span class="line">nerdctl <span class="built_in">cp</span> nginx:/etc/hosts .</span><br></pre></td></tr></table></figure><h2 id="5-网络管理">5. 网络管理</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220709/containerd-20220709-2-containerd%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/D9BD4F7E-F002-46C3-95B8-888F012666B7.png" class=""><p>容器采用nat进行流量转发</p><p><strong>列出所有网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl network <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p><strong>创建一个网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl network create -d bridge --subnet 10.0.0.0/24 mynet</span><br></pre></td></tr></table></figure><p><strong>使用自建容器网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=c1 --restart=always --network=mynet hub.c.163.com/library/centos:latest -- <span class="built_in">tail</span> -f /dev/null</span><br></pre></td></tr></table></figure><p><strong>使用宿主机网络空间</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=c1 --restart=always --network host nginx:alpine </span><br></pre></td></tr></table></figure><p><strong>不使用网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d --name=c1 --restart=always --network noneåß nginx:alpine </span><br></pre></td></tr></table></figure><p><strong>删除网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl network <span class="built_in">rm</span> mynet</span><br></pre></td></tr></table></figure><p><strong>练习</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl run -d --name=db --restart=always -v /db:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=910202 -e MYSQL_DATABASE=wordpress hub.c.163.com/library/mysql:latest</span></span><br><span class="line">c735dbc12c6a513910af18a93aba7d6bb18b6ddfc766317041a7017d1d507cfd</span><br><span class="line"></span><br><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl inspect db |grep Address</span></span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.4.0.15&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;b6:6d:ae:b1:ce:c7&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.4.0.15&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;b6:6d:ae:b1:ce:c7&quot;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master001 ~]<span class="comment"># nerdctl run -d --name=blog --restart=always -v /blog:/var/www/html -p 80:80 -e WORDPRESS_DB_HOST=10.4.0.15 -e WORDPRESS_DB_USER=root -e WORDPRESS_DB_PASSWORD=910202 -e WORDPRESS_DB_NAME=wordpress hub.c.163.com/library/wordpress:latest</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1.容器介绍</title>
      <link href="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/"/>
      <url>/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="1-容器概念介绍">1. 容器概念介绍</h2><p>对于初学者来说并不太容易理解什么是容器，这里举个例子。想象一下，我们把系统安装在一个U盘里，此系统安装好了MySQL。然后我们把这个U盘插入到一台正在运行的宿主机上，这台宿主机上并没有安装MySQL，如图1-1所示。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349838706.png" class=""><p>图1-1 了解容器和镜像<br>然后把U盘里的mysqld进程“拽”到物理机上运行。但是这个mysqld进程只能适应U盘里的生态环境（系统环境），并不能适应物理机的生态环境（系统）。所以找一个类似于气球的东西把mysqld包裹保护起来，这个mysqld进程就可以正常运行了，因为它感觉现在所处的生态环境，仍然是U盘里的生态环境。<br>但是这个进程mysqld运行的时候是需要消耗CPU和内存的，这个U盘里并不提供CPU和内存，所以气球里的mysqld进程可以从物理机里吸收CPU和内存，作为维持它正常运行的“养分”。</p><p>那么这个类似气球的东西就是容器，U盘就是镜像。在Linux下安装软件包的时候经常会遇到各种包依赖，或者有人不会在Linux系统（比如 Ubuntu、centos）里安装软件包。这样以后就不需要安装和配mysql了，直接把这个“U盘”插到电脑上，然后生成一个容器出来，这样就有 mysql 对外提供服务了，是不是很方便？</p><p>所谓镜像，就是安装了系统的硬盘文件，这个系统里安装了想要运行的程序，比如 mysql、nginx，并规定好使用这个镜像所生成的容器里面运行什么进程。这里假设有一个安装了 mysql的镜像，如图 1-2 所示。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349870058.png" class=""><p>图1-2 了解容器和镜像<br>在服务器上有一个 mysql 的镜像（即已经安装好了 mysql），然后使用这个镜像生成一个容器。 这个容器里只运行一个 mysqld 进程。容器里的 mysqld 进程直接从物理机吸收 CPU 和内存以维持 它的正常运行。</p><p>以后需要什么应用就直接拉取什么镜像下来，然后使用这个镜像生成容器。比如需要对外提供 mysql 服务，那么就拉取一个 mysql 镜像，然后生成一个 mysql 容器。如果需要对外提供 web 服务，那么就拉取一个 nginx 镜像，然后生成一个 nginx 容器。 一个镜像是可以生成很多个容器的，如图 1-3 所示。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349912478.png" class=""><p>图1-3 一个镜像可以生成多个容器</p><p>当然了不管是镜像还是容器，都要遵从一个标准，比如镜像的结构是怎么样的，容器的状态、怎么创建和删除容器等都要遵从一个标准，这个标准就是OCI（Open Container Initiative）。</p><h2 id="2-了解什么是runtime">2. 了解什么是runtime</h2><p>前面说了一大堆，什么是容器什么是创建镜像。如同要聊天得安装微信、QQ，练习打字得安装office一样，那么要管理镜像和容器一定是需要安装一种软件的，这个软件叫做runtime，翻译成中文叫做运行时。</p><p>说到了运行时，又涉及到了两类：</p><ol><li><p>低级别运行时（low-level runtime），比如lxc、runc、gvisor、kata等<br>对于低级别的运行时来说，只能简单的管理容器，却是不能管理镜像的。</p></li><li><p>高级别运行时(high-level runtime)，比如docker、containerd、podman等<br>对于高级别运行时来说，他们是通过调用低级别运行时来管理容器，一般可以是runc作为低级别运行时，他们还可以管理镜像。</p></li></ol><p>这里我们重点讲讲containerd的使用。</p><p>当我们安装好containerd之后，会有一个服务器进程containerd，他所使用的配置文件是/etc/containerd/config.toml。这个服务器进程会生成一个接口并客户端来连接（通过gRPC协议），这个接口就是/var/run/containerd/containerd.sock。</p><p>因为在操作系统里目录/var/run是/run的软连接(快捷方式)，所以/run/containerd/containerd.sock和/var/run/containerd/containerd.sock是同一个文件。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349949322.png" class=""><p>图1-4 containerd<br>kubernetes的kubelet就是通过gRPC协议连接/var/run/containerd/containerd.sock，是它的一个客户端。<br>那么连接containerd的客户端还有crictl、ctr、dockerd、nerdctl等。对，你没看错，dockerd也是containerd的一个客户端，如下图。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349958801.png" class=""><p>所敲的docker命令，它只是一个客户端工具（命令行接口CLI），需要连接到服务器进程dockerd（这里docker后面有个d，表示守护进程daemon），默认连接到本机的dockerd进程。如果docker客户端需要连接到其他机器的服务器进程dockerd，需要使用docker -H指定远端机器的IP或者通过定义环境变量DOCKER_HOST。</p><p>dockerd又作为containerd的客户端连接到/run/containerd/containerd.sock。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vms101 ~]<span class="comment"># ps aux | grep -v grep | grep docker</span></span><br><span class="line">root       1814  0.3  1.5 1088516 60640 ?       Ssl  00:48   0:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">[root@vms101 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>crictl和ctr也可以作为containerd的客户端，但是这两个客户端工具非常不好用。所以在客户端nerdctl出来之前，可以说containerd对用户层面来说，是非常难用的。</p><p>nerdctl就是一个非常好用的客户端工具了，它的命令的使用和docker命令非常相似，所以后续我们就开始使用nerdctl来管理容器和镜像。</p><p>不管是哪个客户端连接containerd创建容器，先调用runc把容器创建出来，然后一个进程containerd-shim维护和管理这个容器，如下图。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220703/containerd-20220703-1-%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D/image-1655349983891.png" class=""><p>图1-6 containerd<br>当然nerdctl也有不方便的地方，比如搭建镜像仓库、构建镜像等方面做的并不完善，比如构建镜像必须要安装buildkitd，且没法基于本地镜像等构建镜像。所以呢，这两块内容我们依然使用docker来完成。</p>]]></content>
      
      
      <categories>
          
          <category> containerd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hadoop运行环境搭建</title>
      <link href="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
      <url>/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-虚拟机环境准备">1. 虚拟机环境准备</h2><table><thead><tr><th>主机名</th><th>IP</th><th>内存</th><th>系统</th></tr></thead><tbody><tr><td>hadoop101</td><td>192.168.10.11</td><td>2G</td><td>Ubuntu 20.04.3 LTS</td></tr><tr><td>hadoop102</td><td>192.168.10.12</td><td>2G</td><td>Ubuntu 20.04.3 LTS</td></tr><tr><td>hadoop103</td><td>192.168.10.13</td><td>2G</td><td>Ubuntu 20.04.3 LTS</td></tr></tbody></table><div class="note primary no-icon flat"><p>以下步骤三台服务器均需要操作</p></div><h3 id="1-1-添加主机名映射">1.1 添加主机名映射</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:~$ <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">192.168.10.11 hadoop101</span><br><span class="line">192.168.10.12 hadoop102</span><br><span class="line">192.168.10.13 hadoop103</span><br></pre></td></tr></table></figure><h3 id="1-2-ssh三机互信">1.2 ssh三机互信</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:~$ ssh-keygen</span><br><span class="line">ren@hadoop101:~$ ssh-copy-id ren@192.168.10.11</span><br><span class="line">ren@hadoop101:~$ ssh-copy-id ren@192.168.10.12</span><br><span class="line">ren@hadoop101:~$ ssh-copy-id ren@192.168.10.13</span><br></pre></td></tr></table></figure><h3 id="1-3-创建项目目录">1.3 创建项目目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:~$ sudo <span class="built_in">mkdir</span> /opt/&#123;module,software&#125;</span><br><span class="line">ren@hadoop101:~$ sudo <span class="built_in">chown</span> -R ren.ren /opt/*</span><br></pre></td></tr></table></figure><h2 id="2-Hadoop部署">2. Hadoop部署</h2><h3 id="2-1-集群部署规划">2.1 集群部署规划</h3><table><thead><tr><th>服务</th><th>hadoop101</th><th>hadoop102</th><th>hadoop103</th></tr></thead><tbody><tr><td>HDFS</td><td><code>NameNode</code></br>DatanNode</td><td>DataNode</td><td><code>SecondaryNameNode</code></br>DataNode</td></tr><tr><td>YARN</td><td>NodeManager</td><td><code>ResourceManager</code></br>NodeManager</td><td>NodeManager</td></tr></tbody></table><h3 id="2-2-常用端口说明">2.2 常用端口说明</h3><table><thead><tr><th>端口名称</th><th>Hadoop2.x</th><th>Hadoop3.x</th></tr></thead><tbody><tr><td>NameNode内部通信端口</td><td>8020/9000</td><td><code>8020</code>/9000/9820</td></tr><tr><td>NameNode HTTP UI</td><td><code>50070</code></td><td><code>9870</code></td></tr><tr><td>MapReduce查看执行任务端口</td><td>8088</td><td>8088</td></tr><tr><td>历史服务器通信端口</td><td>19888</td><td>19888</td></tr></tbody></table><h3 id="2-3-资源下载">2.3 资源下载</h3><p>这里通过百度云下载<br>链接: <a href="https://pan.baidu.com/s/1VrFIfFpxq4S0nrrMGcKw3w">https://pan.baidu.com/s/1VrFIfFpxq4S0nrrMGcKw3w</a> 提取码: 986o</p><h3 id="2-4-上传资源到software目录">2.4 上传资源到software目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:~$ ll /opt/software/</span><br><span class="line">total 767908</span><br><span class="line">drwxr-xr-x 2 ren  ren       4096 Mar  2 09:39 ./</span><br><span class="line">drwxr-xr-x 4 root root      4096 Mar  1 18:56 ../</span><br><span class="line">-rw-r--r-- 1 ren  ren  607792249 Mar  1 18:57 hadoop-3.3.1-aarch64.tar.gz</span><br><span class="line">-rw-r--r-- 1 ren  ren        115 Mar  1 18:58 hadoop.sh</span><br><span class="line">-rw-r--r-- 1 ren  ren  178509312 Mar  1 18:58 jdk-8u321-fcs-bin-b07-linux-aarch64-15_dec_2021.tar</span><br><span class="line">-rw-r--r-- 1 ren  ren         75 Mar  1 18:58 jdk.sh</span><br><span class="line">-rwxrwxr-x 1 ren  ren        157 Mar  2 09:39 jpsall*</span><br><span class="line">-rwxrwxr-x 1 ren  ren       1086 Mar  2 09:30 myhadoop*</span><br><span class="line">-rwxrwxr-x 1 ren  ren        691 Mar  1 19:00 xsync*</span><br></pre></td></tr></table></figure><h3 id="2-5-安装jdk">2.5 安装jdk</h3><p><strong>解压jdk到module目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/software$ tar xf jdk-8u321-fcs-bin-b07-linux-aarch64-15_dec_2021.tar -C ../module/</span><br></pre></td></tr></table></figure><p><strong>添加jdk系统环境变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/software$ sudo <span class="built_in">cp</span> jdk.sh /etc/profile.d/</span><br><span class="line">ren@hadoop101:/opt/software$ <span class="built_in">source</span> /etc/profile.d/jdk.sh</span><br></pre></td></tr></table></figure><p><strong>确保java有以下输出</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/software$ java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_321&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_321-b07)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.321-b07, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="2-6-安装hadoop">2.6 安装hadoop</h3><p><strong>解压hadoop到module目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/software$ tar xf hadoop-3.3.1-aarch64.tar.gz -C ../module/</span><br></pre></td></tr></table></figure><p><strong>添加hadoop系统环境变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/software$ sudo <span class="built_in">cp</span> hadoop.sh /etc/profile.d/</span><br><span class="line">ren@hadoop101:/opt/software$ <span class="built_in">source</span> /etc/profile.d/hadoop.sh</span><br></pre></td></tr></table></figure><p><strong>测试是否安装成功</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module$ hadoop version</span><br><span class="line">Hadoop 3.3.1</span><br><span class="line">Source code repository https://github.com/apache/hadoop.git -r a3b9c37a397ad4188041dd80621bdeefc46885f2</span><br><span class="line">Compiled by ubuntu on 2021-06-15T10:51Z</span><br><span class="line">Compiled with protoc 3.7.1</span><br><span class="line">From <span class="built_in">source</span> with checksum 88a4ddb2299aca054416d6b7f81ca55</span><br><span class="line">This <span class="built_in">command</span> was run using /opt/module/hadoop-3.3.1/share/hadoop/common/hadoop-common-3.3.1.jar</span><br></pre></td></tr></table></figure><h3 id="2-7-配置hadoop">2.7 配置hadoop</h3><h4 id="2-7-1-默认配置文件">2.7.1 默认配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./share/doc/hadoop/hadoop-project-dist/hadoop-common/core-default.xml</span><br><span class="line">./share/doc/hadoop/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml</span><br><span class="line">./share/doc/hadoop/hadoop-yarn/hadoop-yarn-common/yarn-default.xml</span><br><span class="line">./share/doc/hadoop/hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml</span><br></pre></td></tr></table></figure><h4 id="2-7-2-自定义配置文件">2.7.2 自定义配置文件</h4><p><strong>etc/hadoop/core-site.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop101:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>指定NameNode的地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/hadoop-3.3.1/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>指定hadoop数据的存储目录<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>ren<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>配置hdfs网页登陆使用的静态用户为ren<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>etc/hadoop/hdfs-site.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop101:9870<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>nn web端访问地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop103:9868<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>2nn web端访问地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>etc/hadoop/yarn-site.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>指定MR走shuffle<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>指定ResourceManager的地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>环境变量的继承<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>开始日志聚集功能<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>设置日志聚集服务器地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log.server.url<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>http://hadoop101:19888/jobhistory/logs<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>设置日志保留时间为7天<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>604800<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>etc/hadoop/mapred-site.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>指定MapReduce程序运行再Yarn上<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop101:10020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>历史服务器地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop101:19888<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>历史服务器web端地址<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-7-3-配置workers">2.7.3 配置workers</h4><p><strong>etc/hadoop/workers</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop101</span><br><span class="line">hadoop102</span><br><span class="line">hadoop103</span><br></pre></td></tr></table></figure><h2 id="3-项目同步">3. 项目同步</h2><p>同步hadoop101的hadoop项目目录到hadoop102、haddop103<br>使用自定义脚本xsync</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 判断参数个数</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> Not Enough Arguement!</span><br><span class="line">    <span class="built_in">exit</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 遍历集群所有机器</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> hadoop101 hadoop102 hadoop103; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> ==================== <span class="variable">$host</span> ====================</span><br><span class="line">    <span class="comment">#3. 遍历所有目录，挨个发送</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="comment">#4. 判断文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> [ -e <span class="variable">$file</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment">#5. 获取父目录</span></span><br><span class="line">            pdir=$(<span class="built_in">cd</span> -P $(<span class="built_in">dirname</span> <span class="variable">$file</span>); <span class="built_in">pwd</span>)</span><br><span class="line">            <span class="comment">#6. 获取当前文件的名称</span></span><br><span class="line">            fname=$(<span class="built_in">basename</span> <span class="variable">$file</span>)</span><br><span class="line">            ssh <span class="variable">$host</span> <span class="string">&quot;mkdir -p <span class="variable">$pdir</span>&quot;</span></span><br><span class="line">            rsync -av <span class="variable">$pdir</span>/<span class="variable">$fname</span> <span class="variable">$host</span>:<span class="variable">$pdir</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$file</span> does not exists!</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="3-1-同步目录">3.1 同步目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module$ xsync /opt/module/</span><br></pre></td></tr></table></figure><h2 id="4-起集群">4. 起集群</h2><h3 id="4-1-如果集群第一次启动，需要再hadoop101节点格式化NameNode">4.1 <strong>如果集群第一次启动</strong>，需要再hadoop101节点格式化NameNode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure><h3 id="4-2-启动集群">4.2 启动集群</h3><blockquote><p>这里使用自定义脚本<code>myhadoop</code><br>Usage: myhadoop &lt;start|stop&gt;</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;No Args Input...&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> ;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;start&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; =================== 启动 hadoop 集群 ===================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 启动 hdfs ---------------&quot;</span></span><br><span class="line">    ssh hadoop101 <span class="string">&quot;/opt/module/hadoop-3.3.1/sbin/start-dfs.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 启动 yarn ---------------&quot;</span></span><br><span class="line">    ssh hadoop102 <span class="string">&quot;/opt/module/hadoop-3.3.1/sbin/start-yarn.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 启动 historyserver ---------------&quot;</span></span><br><span class="line">    ssh hadoop101 <span class="string">&quot;/opt/module/hadoop-3.3.1/bin/mapred --daemon start historyserver&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; =================== 关闭 hadoop 集群 ===================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 关闭 historyserver ---------------&quot;</span></span><br><span class="line">    ssh hadoop101 <span class="string">&quot;/opt/module/hadoop-3.3.1/bin/mapred --daemon stop historyserver&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 关闭 yarn ---------------&quot;</span></span><br><span class="line">    ssh hadoop102 <span class="string">&quot;/opt/module/hadoop-3.3.1/sbin/stop-yarn.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; --------------- 关闭 hdfs ---------------&quot;</span></span><br><span class="line">    ssh hadoop101 <span class="string">&quot;/opt/module/hadoop-3.3.1/sbin/stop-dfs.sh&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Input Args Error...&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module/hadoop-3.3.1$ myhadoop start</span><br></pre></td></tr></table></figure><h3 id="4-3-查看集群状态">4.3 查看集群状态</h3><blockquote><p>这里使用自定义脚本<code>jpsall</code><br>Usage: jpsall</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> hadoop101 hadoop102 hadoop103; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> =============== <span class="variable">$host</span> ===============</span><br><span class="line">    ssh <span class="variable">$host</span> /opt/module/jdk1.8.0_321/bin/jps</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><strong>查看集群进程</strong><br>确保进程都在，这里配置的是<br>NameNode和JobHistoryServer在hadoop101<br>ResourceManager在hadoop102<br>SecoundaryNameNode在hadoop103</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module/hadoop-3.3.1$ jpsall</span><br><span class="line">=============== hadoop101 ===============</span><br><span class="line">17907 JobHistoryServer</span><br><span class="line">17172 NameNode</span><br><span class="line">17383 DataNode</span><br><span class="line">21559 Jps</span><br><span class="line">17689 NodeManager</span><br><span class="line">=============== hadoop102 ===============</span><br><span class="line">19267 DataNode</span><br><span class="line">19495 ResourceManager</span><br><span class="line">19851 NodeManager</span><br><span class="line">22975 Jps</span><br><span class="line">=============== hadoop103 ===============</span><br><span class="line">16487 NodeManager</span><br><span class="line">16167 DataNode</span><br><span class="line">20984 Jps</span><br><span class="line">16333 SecondaryNameNode</span><br></pre></td></tr></table></figure><h3 id="4-4-集群web页面">4.4 集群web页面</h3><p><strong>hdfs web页面</strong><br>集群文件的web管理页面<br><a href="http://hadoop101:9870/">http://hadoop101:9870/</a></p><p><strong>yarn web页面</strong><br>yarn的资源调度页面<br><a href="http://hadoop102:8088">http://hadoop102:8088</a></p><p><strong>历史记录web页面</strong><br><a href="http://hadoop101:19888/jobhistory">http://hadoop101:19888/jobhistory</a></p><h3 id="4-5-各服务组件逐一启动-停止">4.5 各服务组件逐一启动/停止</h3><p>如果单台机器上服务出现异常，单独启动或停止方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs --daemon start/stop namenode/datanode/secondarynamenode</span><br></pre></td></tr></table></figure><p><strong>启动/停止yarn</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn --daemon start/stop resourcemanager/nodemanager</span><br></pre></td></tr></table></figure><h2 id="5-集群饿基本测试">5. 集群饿基本测试</h2><h3 id="5-1-上传文件到集群">5.1 上传文件到集群</h3><p><strong>hdfs中创建目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module/hadoop-3.3.1$ hadoop fs -<span class="built_in">mkdir</span> /input</span><br></pre></td></tr></table></figure><p><strong>HDFS中上传一个小文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -put /opt/module/hadoop-3.3.1/wcinput/word.txt /input</span><br></pre></td></tr></table></figure><p><strong>数据的实际存储位置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module/hadoop-3.3.1$ <span class="built_in">cat</span> data/dfs/data/current/BP-2027323945-192.168.10.11-1646133053594/current/finalized/subdir0/subdir0/blk_1073741825</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">hehe</span><br><span class="line">haha</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">za</span><br><span class="line">zhe</span><br></pre></td></tr></table></figure><h3 id="5-2-执行调度任务保存到hdfs">5.2 执行调度任务保存到hdfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">ren@hadoop101:/opt/module/hadoop-3.3.1$ hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.1.jar wordcount /input /wcountput</span><br><span class="line">2022-03-02 15:44:37,508 INFO client.DefaultNoHARMFailoverProxyProvider: Connecting to ResourceManager at hadoop102/192.168.10.12:8032</span><br><span class="line">2022-03-02 15:44:37,882 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding <span class="keyword">for</span> path: /tmp/hadoop-yarn/staging/ren/.staging/job_1646190571735_0001</span><br><span class="line">2022-03-02 15:44:38,221 INFO input.FileInputFormat: Total input files to process : 1</span><br><span class="line">2022-03-02 15:44:38,302 INFO mapreduce.JobSubmitter: number of splits:1</span><br><span class="line">2022-03-02 15:44:38,450 INFO mapreduce.JobSubmitter: Submitting tokens <span class="keyword">for</span> job: job_1646190571735_0001</span><br><span class="line">2022-03-02 15:44:38,450 INFO mapreduce.JobSubmitter: Executing with tokens: []</span><br><span class="line">2022-03-02 15:44:38,561 INFO conf.Configuration: resource-types.xml not found</span><br><span class="line">2022-03-02 15:44:38,562 INFO resource.ResourceUtils: Unable to find <span class="string">&#x27;resource-types.xml&#x27;</span>.</span><br><span class="line">2022-03-02 15:44:38,716 INFO impl.YarnClientImpl: Submitted application application_1646190571735_0001</span><br><span class="line">2022-03-02 15:44:38,741 INFO mapreduce.Job: The url to track the job: http://hadoop102:8088/proxy/application_1646190571735_0001/</span><br><span class="line">2022-03-02 15:44:38,741 INFO mapreduce.Job: Running job: job_1646190571735_0001</span><br><span class="line">2022-03-02 15:44:43,845 INFO mapreduce.Job: Job job_1646190571735_0001 running <span class="keyword">in</span> uber mode : <span class="literal">false</span></span><br><span class="line">2022-03-02 15:44:43,851 INFO mapreduce.Job:  map 0% reduce 0%</span><br><span class="line">2022-03-02 15:44:46,897 INFO mapreduce.Job:  map 100% reduce 0%</span><br><span class="line">2022-03-02 15:44:51,958 INFO mapreduce.Job:  map 100% reduce 100%</span><br><span class="line">2022-03-02 15:44:52,996 INFO mapreduce.Job: Job job_1646190571735_0001 completed successfully</span><br><span class="line">2022-03-02 15:44:53,065 INFO mapreduce.Job: Counters: 54</span><br><span class="line">File System Counters</span><br><span class="line">FILE: Number of bytes <span class="built_in">read</span>=58</span><br><span class="line">FILE: Number of bytes written=545001</span><br><span class="line">FILE: Number of <span class="built_in">read</span> operations=0</span><br><span class="line">FILE: Number of large <span class="built_in">read</span> operations=0</span><br><span class="line">FILE: Number of write operations=0</span><br><span class="line">HDFS: Number of bytes <span class="built_in">read</span>=128</span><br><span class="line">HDFS: Number of bytes written=32</span><br><span class="line">HDFS: Number of <span class="built_in">read</span> operations=8</span><br><span class="line">HDFS: Number of large <span class="built_in">read</span> operations=0</span><br><span class="line">HDFS: Number of write operations=2</span><br><span class="line">HDFS: Number of bytes <span class="built_in">read</span> erasure-coded=0</span><br><span class="line">Job Counters</span><br><span class="line">Launched map tasks=1</span><br><span class="line">Launched reduce tasks=1</span><br><span class="line">Data-<span class="built_in">local</span> map tasks=1</span><br><span class="line">Total time spent by all maps <span class="keyword">in</span> occupied slots (ms)=1323</span><br><span class="line">Total time spent by all reduces <span class="keyword">in</span> occupied slots (ms)=2244</span><br><span class="line">Total time spent by all map tasks (ms)=1323</span><br><span class="line">Total time spent by all reduce tasks (ms)=2244</span><br><span class="line">Total vcore-milliseconds taken by all map tasks=1323</span><br><span class="line">Total vcore-milliseconds taken by all reduce tasks=2244</span><br><span class="line">Total megabyte-milliseconds taken by all map tasks=1354752</span><br><span class="line">Total megabyte-milliseconds taken by all reduce tasks=2297856</span><br><span class="line">Map-Reduce Framework</span><br><span class="line">Map input records=6</span><br><span class="line">Map output records=6</span><br><span class="line">Map output bytes=51</span><br><span class="line">Map output materialized bytes=58</span><br><span class="line">Input <span class="built_in">split</span> bytes=101</span><br><span class="line">Combine input records=6</span><br><span class="line">Combine output records=5</span><br><span class="line">Reduce input <span class="built_in">groups</span>=5</span><br><span class="line">Reduce shuffle bytes=58</span><br><span class="line">Reduce input records=5</span><br><span class="line">Reduce output records=5</span><br><span class="line">Spilled Records=10</span><br><span class="line">Shuffled Maps =1</span><br><span class="line">Failed Shuffles=0</span><br><span class="line">Merged Map outputs=1</span><br><span class="line">GC time elapsed (ms)=75</span><br><span class="line">CPU time spent (ms)=560</span><br><span class="line">Physical memory (bytes) snapshot=498315264</span><br><span class="line">Virtual memory (bytes) snapshot=4984467456</span><br><span class="line">Total committed heap usage (bytes)=403177472</span><br><span class="line">Peak Map Physical memory (bytes)=287354880</span><br><span class="line">Peak Map Virtual memory (bytes)=2484170752</span><br><span class="line">Peak Reduce Physical memory (bytes)=210960384</span><br><span class="line">Peak Reduce Virtual memory (bytes)=2500296704</span><br><span class="line">Shuffle Errors</span><br><span class="line">BAD_ID=0</span><br><span class="line">CONNECTION=0</span><br><span class="line">IO_ERROR=0</span><br><span class="line">WRONG_LENGTH=0</span><br><span class="line">WRONG_MAP=0</span><br><span class="line">WRONG_REDUCE=0</span><br><span class="line">File Input Format Counters</span><br><span class="line">Bytes Read=27</span><br><span class="line">File Output Format Counters</span><br><span class="line">Bytes Written=32</span><br></pre></td></tr></table></figure><h3 id="5-3-WEB页面查看执行结果">5.3 WEB页面查看执行结果</h3><p>每次执行计算任务保存到hdfs中，这里使用wordcount计算文本中文字出现的次数，可以看到多了一个wcountput</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/hdfs.png" class="" title="执行结果"><p>查看计算结果文件</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/hdfs2.png" class="" title="执行结果"><p>查看yarn任务调度页面，查看此次任务执行各参数</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/yarn1.png" class="" title="执行结果"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/yarn2.png" class="" title="执行结果"><p>通过任务页面跳转到历史记录页面，查看相关执行细节</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/history.png" class="" title="执行结果"><p>因为是集群查看日志不方便，web端做了日志合并任务关联，通过yarn任务调度界面进入查看</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/log1.png" class="" title="执行结果"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/log2.png" class="" title="执行结果"><h2 id="6-常见错误及解决方案">6. 常见错误及解决方案</h2><h3 id="6-1-防火墙没关闭、或没启动YARN">6.1 防火墙没关闭、或没启动YARN</h3><pre><code>    INFO client.RMProxy: Connecting to ResourceManager at hadoop108/192.168.10.108:8032</code></pre><h3 id="6-2-主机名配置错误">6.2 主机名配置错误</h3><p>主机名不要和集群名称一样，或者删除<code>/etc/hosts</code>下127.0.0.1 hadoop101</p><h3 id="6-3-IP地址配置错误">6.3 IP地址配置错误</h3><p>略</p><h3 id="6-4-ssh没配置好">6.4 ssh没配置好</h3><p>涉及同步脚本报错</p><h3 id="6-5-root-用户和-ren-两个用户启动集群不统一">6.5 root 用户和 ren 两个用户启动集群不统一</h3><p>集群使用普通用户启动，如果需要使用root用户启动需要特殊配置不要混用用户启动，所以最好使用脚本统一启动</p><p>在/hadoop/sbin路径下：<br><a href="http://xn--start-dfs-kj5q.sh">将start-dfs.sh</a>，stop-dfs.sh两个文件顶部添加以下参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">HDFS_DATANODE_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=hdfs</span><br><span class="line">HDFS_NAMENODE_USER=root</span><br><span class="line">HDFS_SECONDARYNAMENODE_USER=root</span><br></pre></td></tr></table></figure><p>还有，<a href="http://start-yarn.sh">start-yarn.sh</a>，stop-yarn.sh顶部也需添加以下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=yarn</span><br><span class="line">YARN_NODEMANAGER_USER=root</span><br></pre></td></tr></table></figure><h3 id="6-6-配置文件修改不细心">6.6 配置文件修改不细心</h3><p>服务启动会出现异常，具体查看服务log</p><h3 id="6-7-不识别主机名称">6.7 不识别主机名称</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.net.UnknownHostException: hadoop102: hadoop102</span><br><span class="line">at </span><br><span class="line">java.net.InetAddress.getLocalHost(InetAddress.java:<span class="number">1475</span>)</span><br><span class="line">at </span><br><span class="line">org.apache.hadoop.mapreduce.JobSubmitter.submitJobInternal(Job</span><br><span class="line">Submitter.java:<span class="number">146</span>)</span><br><span class="line">at org.apache.hadoop.mapreduce.Job$<span class="number">10.</span>run(Job.java:<span class="number">1290</span>)</span><br><span class="line">at org.apache.hadoop.mapreduce.Job$<span class="number">10.</span>run(Job.java:<span class="number">1287</span>)</span><br><span class="line">at java.security.AccessController.doPrivileged(Native </span><br><span class="line">Method)</span><br><span class="line">at javax.security.auth.Subject.doAs(Subject.java:<span class="number">415</span>)</span><br></pre></td></tr></table></figure><p>解决办法：<br>（1）在/etc/hosts 文件中添加 192.168.10.102 hadoop102<br>（2）主机名称不要起 hadoop hadoop000 等特殊名称</p><h3 id="6-8-DataNode-和-NameNode-进程同时只能工作一个">6.8 DataNode 和 NameNode 进程同时只能工作一个</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220303/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-Hadoop%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/guzhang.png" class="" title="执行结果"><h3 id="6-9-jps-发现进程已经没有，但是重新启动集群，提示进程已经开启">6.9 jps 发现进程已经没有，但是重新启动集群，提示进程已经开启</h3><p>原因是在 Linux 的根目录下/tmp 目录中存在启动的进程临时文件，将集群相关进程删除掉，再重新启动集群。</p><h3 id="6-10-jps不生效">6.10 jps不生效</h3><p>原因：全局变量 hadoop java 没有生效。解决办法：需要 source /etc/profile 文件。</p>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1.服务网格</title>
      <link href="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/"/>
      <url>/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前言">1. 前言</h2><p>如果你比较关注新兴技术的话，那么很可能在不同的地方听说过 istio，并且知道它和 service mesh 有着牵扯。这篇文章可以作为了解 istio 的入门介绍，了解什么是 istio，istio 为什么最近这么火，以及 istio 能够我们带来什么好处。</p><h2 id="2-什么是-istio？">2. 什么是 istio？</h2><p>官方对 istio 的介绍浓缩成了一句话：</p><blockquote><p>An open platform to connect, secure, control and observe services.</p></blockquote><p>翻译过来，就是”连接、安全加固、控制和观察服务的开放平台“。开放平台就是指它本身是开源的，服务对应的是微服务，也可以粗略地理解为单个应用。</p><p>中间的四个动词就是 istio 的主要功能，官方也各有一句话的说明。这里再阐释一下：</p><ul><li>连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和红黑部署等功能</li><li>安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密</li><li>控制（Control）：应用用户定义的 policy，保证资源在消费者中公平分配</li><li>观察（Observe）：查看服务运行期间的各种数据，比如日志、监控和 tracing，了解服务的运行情况</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/aHR0cHM6Ly9tbW.png" class="" title="执行结果"><p>虽然听起来非常高级，功能非常强大，但是一股脑出现这么多名词，还都是非常虚的概念，说了跟没说一样。要想理解上面这几句话的含义，我们还是从头说起，先聊聊 service mesh。</p><div class="note info no-icon flat"><p>NOTE：其实 istio 的源头是微服务，但这又是一个比较大的话题，目前可以参考网络上各种文章。如果有机会，我们再来聊聊微服务。</p></div><h2 id="3-什么是-service-mesh">3. 什么是 service mesh</h2><p>一般介绍 service mesh 的文章都会从网络层的又一个抽象说起，把 service mesh 看做建立在 TCP 层之上的微服务层。我这次换个思路，从 service mesh 的技术根基——网络代理来分析。</p><p>说起网络代理，我们会想到翻墙，如果对软件架构比较熟悉的会想到 Nginx 等反向代理软件。其实网络代理的范围比较广，可以肯定的说，有网络访问的地方就会有代理的存在。</p><div class="note warning no-icon flat"><p>NOTE：代理可以是嵌套的，也就是说通信双方 A、B 中间可以多多层代理，而这些代理的存在有可能对 A、B 是透明的。</p></div><p>简单来说，网络代理可以简单类比成现实生活中的中介，本来需要通信的双方因为各种原因在中间再加上一道关卡。本来双方就能完成的通信，为何非要多此一举呢？那是因为代理可以为整个通信带来更多的功能，比如：</p><ul><li>拦截：代理可以选择性拦截传输的网络流量，比如一些公司限制员工在上班的时候不能访问某些游戏或者电商网站，再比如把我们和世界隔离开来的 GFW，还有在数据中心中拒绝恶意访问的网关</li><li>统计：既然所有的流量都经过代理，那么代理也可以用来统计网络中的数据信息，比如了解哪些人在访问哪些网站，通信的应答延迟等</li><li>缓存：如果通信双方比较”远“，访问比较慢，那么代理可以把最近访问的数据缓存在本地，后面的访问不用访问后端来做到加速。CDN 就是这个功能的典型场景</li><li>分发：如果某个通信方有多个服务器后端，代理可以根据某些规则来选择如何把流量发送给多个服务器，也就是我们常说的负载均衡功能。比如著名的 Nginx 软件</li><li>跳板：如果 A、B 双方因为某些原因不能直接访问，而代理可以和双方通信，那么通过代理，双方可以绕过原来的限制进行通信。这应该广大中国网民比较熟悉的场景</li><li>注入：既然代理可以看到流量，那么它也可以修改网络流量，可以自动在收到的流量中添加一些数据，比如有些宽带提供商的弹窗广告</li><li>……</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/daili.png" class="" title="执行结果"><p>不是要讲 service mesh 吗？为什么扯了一堆代理的事情？因为 service mesh 可以看做是传统代理的升级版，用来解决现在微服务框架中出现的问题，可以把 service mesh 看做是分布式的微服务代理。</p><p>在传统模式下，代理一般是集中式的单独的服务器，所有的请求都要先通过代理，然后再流入转发到实际的后端。</p><p>而在 service mesh 中，代理变成了分布式的，它常驻在了应用的身边（最常见的就是 kubernetes sidecar 模式，每一个应用的 pod 中都运行着一个代理，负责流量相关的事情）。这样的话，应用所有的流量都被代理接管，那么这个代理就能做到上面提到的所有可能的事情，从而带来无限的想象力。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/sidecar.png" class="" title="执行结果"><p>此外，原来的代理都是基于网络流量的，一般都是工作在 IP 或者 TCP 层，很少关心具体的应用逻辑。但是 service mesh 中，代理会知道整个集群的所有应用信息，并且额外添加了热更新、注入服务发现、降级熔断、认证授权、超时重试、日志监控等功能，让这些通用的功能不必每个应用都自己实现，放在代理中即可。换句话说，service mesh 中的代理对微服务中的应用做了定制化的改进！</p><p>就这样，借着微服务和容器化的东风，传统的代理摇身一变，成了如今炙手可热的 service mesh。应用微服务之后，每个单独的微服务都会有很多副本，而且可能会有多个版本，这么多微服务之间的相互调用和管理非常复杂，但是有了 service mesh，我们可以把这块内容统一在代理层。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/proxy.png" class="" title="执行结果"><p>有了看起来四通八达的分布式代理，我们还需要对这些代理进行统一的管理。手动更新每个代理的配置，对代理进行升级或者维护是个不可持续的事情，在前面的基础上，在加上一个控制中心，一个完整的 service mesh 就成了。管理员只需要根据控制中心的 API 来配置整个集群的应用流量、安全规则即可，代理会自动和控制中心打交道根据用户的期望改变自己的行为。</p><div class="note warning no-icon flat"><p>NOTE：所以你也可以理解 service mesh 中的代理会抢了 Nginx 的生意，这也是为什么Nginx 也要开始做 NginMesh 的原因。</p></div><h2 id="4-再来看-istio">4. 再来看 istio</h2><p>了解了 service mesh 的概念，我们再来看 istio ，也许就会清楚很多。首先来看 istio 官方给出的架构图：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/istio.png" class="" title="执行结果"><p>可以看到，istio 就是我们上述提到的 service mesh 架构的一种实现，服务之间的通信（比如这里的 Service A 访问 Service B）会通过代理（默认是 envoy）来进行，而且中间的网络协议支持 HTTP/1.1，HTTP/2，gRPC 或者 TCP，可以说覆盖了主流的通信协议。控制中心做了进一步的细分，分成了 Pilot、Mixer、和 Citadel，它们的各自功能如下：</p><ul><li>Pilot：为 envoy 提供了服务发现，流量管理和智能路由（AB测试、金丝雀发布等），以及错误处理（超时、重试、熔断）功能。用户通过 pilot 的 API 管理网络相关的资源对象，pilot 会根据用户的配置和服务的信息把网络流量管理变成 envoy 能识别的格式分发到各个 sidecar 代理中。</li><li>Mixer：为整个集群执行访问控制（哪些用户可以访问哪些服务）和 policy 管理（rate limit，quota 等），并且收集代理观察到的服务之间的流量统计数据</li><li>Citadel：为服务之间提供认证和证书管理，可以让服务自动升级成 TLS 协议</li></ul><p>代理会和控制中心通信，一方面可以获取需要的服务之间的信息，另一方面也可以汇报服务调用的 metrics 数据。知道 istio 的核心架构，再来看看它的功能描述就非常容易理解了。</p><ul><li>连接：控制中心可以从集群中获取所有服务的信息，并分发给代理，这样代理就能根据用户的期望来完成服务之间的通信（自动地服务发现、负载均衡、流量控制等）</li><li>安全加固：因为所有的流量都是通过代理的，那么代理接收到不加密的网络流量之后，可以自动做一次封装，把它升级成安全的加密流量</li><li>控制：用户可以配置各种规则（比如 RBAC 授权、白名单、rate limit 或者 quota 等），当代理发现服务之间的访问不符合这些规则，就直接拒绝掉</li><li>观察：所有的流量都经过代理，因此代理对整个集群的访问情况知道得一清二楚，它把这些数据上报到控制中心，那么管理员就能观察到整个集群的流量情况了</li></ul><h2 id="5-istio-解决什么问题">5. istio 解决什么问题</h2><p>虽然看起来非常炫酷，功能也很强大，但是一个架构和产品出来都是要解决具体的问题。所以这部分我们来看看微服务架构中的难题以及 istio 给出的答案。</p><p>首先，原来的单个应用拆分成了许多分散的微服务，它们之间相互调用才能完成一个任务，而一旦某个过程出错（组件越多，出错的概率也就越大），就非常难以排查。</p><p>用户请求出现问题无外乎两个问题：错误和响应慢。如果请求错误，那么我们需要知道哪个步骤出错了，这么多的微服务之间的调用怎么确定哪个有调用成功？哪个没有调用成功呢？如果是请求响应太慢，我们就需要知道到底哪些地方比较慢？整个链路的调用各阶段耗时是多少？哪些调用是并发执行的，哪些是串行的？这些问题需要我们能非常清楚整个集群的调用以及流量情况。</p><p>此外，微服务拆分成这么多组件，如果单个组件出错的概率不变，那么整体有地方出错的概率就会增大。服务调用的时候如果没有错误处理机制，那么会导致非常多的问题。</p><p>比如如果应用没有配置超时参数，或者配置的超时参数不对，则会导致请求的调用链超时叠加，对于用户来说就是请求卡住了；如果没有重试机制，那么因为各种原因导致的偶发故障也会导致直接返回错误给用户，造成不好的用户体验；此外，如果某些节点异常（比如网络中断，或者负载很高），也会导致应用整体的响应时间变成，集群服务应该能自动避开这些节点上的应用；最后，应用也是会出现 bug 的，各种 bug 会导致某些应用不可访问。这些问题需要每个应用能及时发现问题，并做好对应的处理措施。</p><p>应用数量的增多，对于日常的应用发布来说也是个难题。应用的发布需要非常谨慎，如果应用都是一次性升级的，出现错误会导致整个线上应用不可用，影响范围太大；而且，很多情况我们需要同时存在不同的版本，使用 AB 测试验证哪个版本更好；如果版本升级改动了 API，并且互相有依赖，那么我们还希望能自动地控制发布期间不同版本访问不同的地址。这些问题都需要智能的流量控制机制。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/shengji.png" class="" title="执行结果"><p>为了保证整个系统的安全性，每个应用都需要实现一套相似的认证、授权、HTTPS、限流等功能。一方面大多数的程序员对安全相关的功能并不擅长或者感兴趣，另外这些完全相似的内容每次都要实现一遍是非常冗余的。这个问题需要一个能自动管理安全相关内容的系统。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/security.png" class="" title="执行结果"><p>上面提到的这些问题是不是非常熟悉？它们就是 istio 尝试解决的问题，如果把上面的问题和 istio 提供的功能做个映射，你会发现它们是非常匹配，毕竟 istio 就是为了解决微服务的这些问题才出现的。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220228/istio-20220228-1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/gongneng.png" class="" title="执行结果"><h2 id="6-用什么姿势接入-istio？">6. 用什么姿势接入 istio？</h2><p>虽然 istio 能解决那么多的问题，但是引入 istio 并不是没有代价的。最大的问题是 istio 的复杂性，强大的功能也意味着 istio 的概念和组件非常多，要想理解和掌握 istio ，并成功在生产环境中部署需要非常详细的规划。一般情况下，集群管理团队需要对 kubernetes 非常熟悉，了解常用的使用模式，然后采用逐步演进的方式把 istio 的功能分批掌控下来。</p><p>第一步，自然是在测试环境搭建一套 istio 的集群，理解所有的核心概念和组件。了解 istio 提供的接口和资源，知道它们的用处，思考如何应用到自己的场景中，然后是熟悉 istio 的源代码，跟进社区的 issues，了解目前还存在的 issues 和 bug，思考如何规避或者修复。这一步是基础，需要积累到 istio 安装部署、核心概念、功能和缺陷相关的知识，为后面做好准备。<br>第二步，可以考虑接入 istio 的观察性功能，包括 logging、tracing、metrics 数据。应用部署到集群中，选择性地（一般是流量比较小，影响范围不大的应用）为一些应用开启 istio 自动注入功能，接管应用的流量，并安装 prometheus 和 zipkin 等监控组件，收集系统所有的监控数据。</p><p>这一步可以试探性地了解 istio 对应用的性能影响，同时建立服务的性能测试基准，发现服务的性能瓶颈，帮助快速定位应用可能出现的问题。此时，这些功能可以是对应用开发者透明的，只需要集群管理员感知，这样可以减少可能带来的风险。</p><p>第三步，为应用配置 timeout 超时参数、自动重试、熔断和降级等功能，增加服务的容错性。这样可以避免某些应用错误进行这些配置导致问题的出现，这一步完成后需要通知所有的应用开发者删除掉在应用代码中对应的处理逻辑。这一步需要开发者和集群管理员同时参与。</p><p>第四步，和 ingress、helm、应用上架等相关组件和流程对接，使用 istio 接管应用的升级发布流程。让开发者可以配置应用灰度发布升级的策略，支持应用的蓝绿发布、金丝雀发布以及 AB 测试。</p><p>第五步，接入安全功能。配置应用的 TLS 互信，添加 RBAC 授权，设置应用的流量限制，提升整个集群的安全性。因为安全的问题配置比较繁琐，而且优先级一般会比功能性相关的特性要低，所以这里放在了最后。</p><p>当然这个步骤只是一个参考，每个公司需要根据自己的情况、人力、时间和节奏来调整，找到适合自己的方案。</p><h2 id="7-总结">7. 总结</h2><p>Istio 的架构在数据中心和集群管理中非常常见，每个 agent 分布在各个节点上（可以是服务器、虚拟机、pod、容器）负责接收指令并执行，以及汇报信息；控制中心负责汇聚整个集群的信息，并提供 API 让用户对集群进行管理。kubernetes 也是类似的架构，SDN（Software Defined Network） 也是如此。</p><p>相信以后会有更多类似架构的出现，这是因为数据中心要管理的节点越来越多，我们需要把任务执行分布到各节点（agent 负责的功能），同时也需要对整个集群进行管理和控制（control plane 的功能），完全去中心化的架构是无法满足后面这个要求的。</p><p>Istio 的出现为负责的微服务架构减轻了很多的负担，开发者不用关心服务调用的超时、重试、rate limit 的实现，服务之间的安全、授权也自动得到了保证；集群管理员也能够很方便地发布应用（AB 测试和灰度发布），并且能清楚看到整个集群的运行情况。</p><p>但是这并不表明有了 istio 就可以高枕无忧了，istio 只是把原来分散在应用内部的复杂性统一抽象出来放到了统一的地方，并没有让原来的复杂消失不见。因此我们需要维护 istio 整个集群，而 istio 的架构比较复杂，尤其是它一般还需要架在 kubernetes 之上，这两个系统都比较复杂，而且它们的稳定性和性能会影响到整个集群。</p><p>因此在采用 isito 之前，必须做好清楚的规划，权衡它带来的好处是否远大于额外维护它的花费，需要有相关的人才对整个网络、kubernetes 和 istio 都比较了解才行。</p>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大数据生态体系</title>
      <link href="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/"/>
      <url>/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Hadoop是什么">1. Hadoop是什么</h2><ol><li>Hadoop是由Apache基金会所开发的<font color=red size=2>分布式系统基础架构</font>。</li><li>主要解决，海量数据的<font color=red size=2>存储</font>和海量数据的<font color=red size=2>分析计算</font>问题。</li><li>广义上来说，Hadoop通常是指一个更广泛的概念——<font color=red size=2>Hadoop生态圈</font>。</li></ol><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/20220221141006.png" class="" title="执行结果"><h2 id="2-Hadoop发展历史">2. Hadoop发展历史</h2><ol><li>Hadoop创始人<font color=red size=2>Doug Cutting</font>，为了实现与Googole类似的全文搜索功能，他在<font color=red size=2>Lucene</font>框架基础上进行优化升级，查询引擎和索引引擎。</li></ol> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-141558.png" class="" title="执行结果"><ol start="2"><li>2001年年底Lucene成为Apache基金会的一个子项目。</li><li>对于海量数据的场景，Lucene框架面对与Google同意的困难，<strong>存储海量数据困难，检索海量数据速度慢。</strong></li><li>学习和模仿Google解决这些问题的办法：微型版Nutch。</li><li>可以说Google是Hadoop的思想之源（Google在大数据方面的三篇论文）<br><strong>GFS --&gt; HDFS</strong><br><strong>Map-Reduce —&gt; MR</strong><br><strong>BigTable —&gt; HBase</strong></li><li>2003-2004年，Google公开了部分GFS和MapReduce思想的细节，以此为基础Doug Cutting等人用了<strong>2年业务时间</strong>实现了DFS和MapReduce机制，是Nutch性能飙升。</li><li>2005年Hadoop作为Lucene的子项目Nutch的一部分正式引入Apache基金会。</li><li>2006年3月份，Map-Reduce和Nutch Distributed File System (NDFS)分别被纳入到Hadoop项目中，Hadoop就此正式诞生，标志着大数据时代来临。</li><li>名字来源与Doug Cutting儿子的玩具大象</li></ol><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-143141.png" class="" title="执行结果"><h2 id="3-Hadoop三大发行版本">3. Hadoop三大发行版本</h2><p>Hadoop三大发行版本：Apache、Cloudera、Hortonworks。</p><ul><li><font color=red size=2>Apache</font>版本最原始（最基础）的版本，对于入门学习最好。2006</li><li>Cloudera内部集成了很多大数据框架，对应产品<font color=red size=2>CDH</font>。2008</li><li>Hortonworks文档较好，对应产品<font color=red size=2>HDP</font>。2011</li></ul><p>    Hortonworks现在已经被Cloudera公司收购，推出新的品牌 <font color=red size=2>CDP</font>。</p><h3 id="3-1-Apache-Hadoop">3.1 Apache Hadoop</h3><p>官网地址：<a href="https://hadoop.apache.org">https://hadoop.apache.org</a><br>下载地址：<a href="https://hadoop.apache.org/releases.html">https://hadoop.apache.org/releases.html</a></p><h3 id="3-2-Cloudera-Hadoop">3.2 Cloudera Hadoop</h3><p>官网地址：<a href="https://www.cloudera.com/downloads/cdh">https://www.cloudera.com/downloads/cdh</a><br>下载地址：<a href="https://docs.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_6_download.html">https://docs.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_6_download.html</a></p><ol><li>2008年成立的Cloudera是最早将Hadoop商用的公司，为合作伙伴提供Hadoop的商用解决方案，主要是包括支持、咨询服务、培训。</li><li><strong>2009年Hadoop的创始人Doug Cutting 也加盟Cloudera公司</strong>。Cloudera产品主要为CDH，Cloudera Manager，Cloudera Support</li><li>CDH是Cloudera的Hadoop发行版，完全开源，比Apache Hadoop 在兼容性，安全性，稳定性上有所增强。Cloudera的标价为每年每个节点<strong>10000美元</strong></li><li>Cloudera Manager 是集群的软件分发及管理监控平台，可以在几个小时内部署好一个Hadoop集群，并对集群的节点及服务进行实时监控。</li></ol><h3 id="3-3-Hortonworks-Hadoop">3.3 Hortonworks Hadoop</h3><p>官网地址：<a href="https://hortonworks.com/products/data-center/hdp/">https://hortonworks.com/products/data-center/hdp/</a><br>下载地址：<a href="https://www.cloudera.com/downloads.html#data-platform">https://www.cloudera.com/downloads.html#data-platform</a></p><ol><li>2011年成立的Hortonworks是雅虎与硅谷风投公司Benchmark Capital合资组建。</li><li><strong>公司成立之初就吸纳了大于25名至30名专门研究Hadoop的雅虎工程师，上述工程师均在2005年开始协助雅虎开发Hadoop，贡献了Hadoop 80%的代码</strong>。</li><li>Hortonworks的主打产品是Hortonworks Data Platform（HDP），也同样是100%开源的产品，HDP除常见的项目外还包括了<strong>Ambari</strong>，一款开源的安装和管理系统。</li><li><strong>2018年Hortonworks目前已经被Cloudera公司收购</strong>。</li></ol><h2 id="4-Hadoop优势（4高）">4. Hadoop优势（4高）</h2><ul><li>高可靠性：Hadoop底层维护多个数据副本，所以即使Hadoop某个计算元素或存储出现故障，也不会导致数据的丢失。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-151323.png" class="" title="执行结果"><ul><li>高扩展性：在集群间分配任务数据，可方便的扩展数以千计的节点。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-151408.png" class="" title="执行结果"><ul><li>高效性：在MapReduce的思想下，Hadoop是并行工作的，以加快任务处理速度。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-151534.png" class="" title="执行结果"><ul><li>高容错性：能够自动将失败的任务重新分配。</li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-151635.png" class="" title="执行结果"><h2 id="5-Hadoop组成（面试重点）">5. Hadoop组成（面试重点）</h2><p>Hadoop 1.x、2.x、3.x的区别</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-151812.png" class="" title="执行结果"><h3 id="5-1-HDFS架构概述">5.1 HDFS架构概述</h3><p>Hadoop Distributed File System，简称<font color=red size=2>HDFS</font>，是一个分布式文件系统。</p><ol><li>NameNode(nn)：存储文件的<font color=red size=2>元数据</font>，如<font color=red size=2>文件名，文件目录结构，文件属性</font>（生成时间、副本数、文件权限），以及每个文件的<font color=red size=2>块列表</font>和<font color=red size=2>块所在的DataNode</font>等。</li><li>DataNode(dn)：在本地文件系统<font color=red size=2>存储文件块数据</font>，以及<font color=red size=2>块数据的校验和</font>。</li><li>Secondary NameNode(2nn)：<font color=red size=2>每隔一段时间对NameNode元数据备份</font>。</li></ol><h3 id="5-2-YARN架构概述">5.2 YARN架构概述</h3><p>YetAnotherResourceNegotiator简称YARN，另一种资源协调者，是Hadoop的资源管理器。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-153011.png" class="" title="执行结果"><h3 id="5-3-MapReduce架构概述">5.3 MapReduce架构概述</h3><p>MapReduce将计算过程分为两个阶段：Map和Reduce</p><ol><li>Map阶段并行处理输入数据</li><li>Reduce阶段对<strong>Map</strong>结果进行汇总</li></ol><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-153447.png" class="" title="执行结果"><h3 id="5-4-HDFS、YARN、MapReduce三者关系">5.4 HDFS、YARN、MapReduce三者关系</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-153724.png" class="" title="执行结果"><h2 id="6-大数据技术生态体系">6. 大数据技术生态体系</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-154202.png" class="" title="执行结果"><p>图中涉及的技术名词解释如下：</p><ol><li><strong>Sqoop：Sqoop</strong>是一款开源的工具，主要用于在<strong>Hadoop、Hive</strong>与传统的数据库（<strong>MySQL</strong>）间进行数据的传递，可以将一个关系型数据库（例如：<strong>MySQL,Oracle</strong>等）中的数据导进到<strong>Hadoop</strong>的<strong>HDFS</strong>中，也可以将<strong>HDFS</strong>的数据导进到关系型数据库中。</li><li><strong>Flume：Flume</strong>是一个高可用的，高可靠的，分布式的海量日志采集、集合和传输的系统，Flume支持在日志系统中定制各类数据发送方，用于收集数据；</li><li><strong>Kafka：Kafka</strong>是一种高吞吐量的分布式发布订阅消息系统。</li><li><strong>Spark：Spark</strong>是当前最流行的开源大数据内存计算框架，可以基于Hadoop上存储的大数据进行计算。</li><li><strong>Flink：Flink</strong>是当前最流行的开源大数据内存计算框架，用于实时计算的场景较多。</li><li><strong>Oozie：Oozie</strong>是一个管理<strong>Hadoop</strong>作业（<strong>job</strong>）的工作流程调度管理系统。</li><li><strong>Hbase：Hbase</strong>是一个分布式的、面向列的开源数据库。<strong>HBase</strong>不同于一般的关系数据库，它是一个适合于非结构化数据存储的数据库。</li><li><strong>Hive：Hive</strong>是基于<strong>Hadoop</strong>的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供简单的<strong>SQL</strong>查询功能，可以将<strong>SQL</strong>语句转换为<strong>MapReduce</strong>任务进行运行。其优点是学习成本低，可以通过类<strong>SQL</strong>语句快速实现简单的<strong>MapReduce</strong>统计，不必开发专门的<strong>MapReduce</strong>应用，十分适合数据仓库的统计分析。</li><li><strong>ZooKeeper</strong>：它是一个针对大型分布式系统的可靠协调系统，提供的功能包括：配置维护、名字服务、分布式同步、组服务等。</li></ol><h2 id="7-推荐系统框架图">7. 推荐系统框架图</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB/2022-02-21-160933.png" class="" title="执行结果">]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大数据概论</title>
      <link href="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A6%82%E8%AE%BA/"/>
      <url>/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A6%82%E8%AE%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-大数据概念">1. 大数据概念</h2><p>大数据（BigData）：指<font color=red size=2>无法在一定时间范围</font>内用常规软件工具进行捕捉、管理和处理的数据集合，是需要新处理模式才能具有更强的决策力、洞察发现力和流程优化能力的<font color=red size=2>海量、高增长、率和多样化</font>的<font color=red size=2><b>信息资产</b></font>。</p><p>大数据主要解决，<font color=red size=2>海量</font>数据的<font color=red size=2>采集</font>、<font color=red size=2>存储</font>和<font color=red size=2>分析计算</font>问题。</p><p>按顺序给出数据存储单位：bit、Byte、KB、MB、GB、<font color=red size=2>TB、PB、EB</font>、ZB、YB、BB、NB、DB。</p><p>1Byte=8bit<br>1K=1024Byte<br>1MB=1024KB<br>1G=1024MB<br><font color=red size=2>1T=1024GB</font><br><font color=red size=2>1P=1024TB</font></p><h2 id="2-大数据特点（4V）">2. 大数据特点（4V）</h2><h3 id="2-1-Volume（大量）">2.1 Volume（大量）</h3><p>截至目前，人类生产的所有<font color=red size=2>印刷材料的数据量是200PB</font>，而历史上全人类总共<font color=red size=2>说过的话的数据量大约是5EB</font>。当前，典型个人计算机硬盘的容量为TB量级，而一些大<font color=red size=2>企业的数据量已经接近EB</font>量级。</p><h3 id="2-2-Velocity-高速">2.2 Velocity(高速)</h3><p>这是大数据区分与传统数据挖掘的最显著特征。根据IDC的“数字宇宙”的报告，<font color=green size=2>预计到2025年，全球数据使用量将达到163ZB。</font>在如此海量的数据面前，处理数据的效率就是企业的生命。</p><font color=red size=2><b>天猫双十一</b>：2017年3分钟01秒，天猫交易额超过100亿</br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2020年96秒，天猫交易额超过100亿</font><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A6%82%E8%AE%BA/2022-02-21103555.png" class="" title="执行结果"><h3 id="2-3-Variety-多样">2.3 Variety(多样)</h3><p>这种类型的多样性也让数据被分为结构化数据和非结构化数据。相对于以往便于存储的<font color=red size=2>以数据库/文本为主要的结构化数据，非结构化数据</font>越来越多，包括<font color=red size=2>网络日志、音频、视频、图片、地理位置信息</font>等，这些多类型的数据对数据的处理能力提出了更高要求。</p><h3 id="2-4-Value-低价值密度">2.4 Value(低价值密度)</h3><p>价值密度的高低与数据总量的大小成反比。比如，在一天监控视频中，我们只关心晚上在床上健身的那一分钟，如何<font color=red size=2>快速对有价值数据“提纯”成为目前大数据背景下待解决的难题。</font></p><h2 id="3-大数据应用场景">3. 大数据应用场景</h2><ol><li>抖音：推荐的都是你喜欢的视频</li><li>电商站内广告推荐：给用户推荐可能喜欢的商品</li><li>零售：分析用户消费习惯，为用户购买商品提供方便，从而提升商品销量。</li><li>物流仓储：京东物流，上午下单下午送达、下午下单次日上午送达。</li><li>保险：海量数据挖掘及风险预测，助力保险行业精准营销，提升精细化定价能力。</li><li>金融：多维度体现用户特征，帮助金融机构推荐优质客户，防范欺诈风险。</li><li>房产：大数据全面助力房地产行业，打造精准投策与营销，选出更合适的地，建造更合适的楼，卖给更合适的人。</li><li>人工智能+5G+物联网+虚拟现实</li></ol><h2 id="4-大数据发展前景">4. 大数据发展前景</h2><ol><li>党的十九大提出“<font color=red size=2>推动互联网、大数据、人工智能和实体经济深度融合</font>”</li><li>2020年初，中央推出<font color=red size=2>34亿</font>“新基建”投资计划</li><li>下一个风口<br>2020年是<strong>5G</strong>的元年，<font color=red size=2>国家在大力铺设5G设备，2021</font>年就是5G手机应用的开始，<font color=red size=2>也是大数据要爆发的一年</font>。5G带来的是每秒钟10G的数据，会给每家公司都带来海量的数据。那么传统的JAVA工具根本解决不了海量数据的存储。就更不用说海量数据的计算了。如果你对5G的感触不够深，可以回忆一下3G和4G的区别。<font color=red size=2>3G时只能打电话、发短信</font>，当时还觉得很好，觉得3G不错。但是<font color=red size=2>4G来了后</font>，大家很少打电话和发短信了，都改为<font color=red size=2>语音、视频、直播、网上购物</font>等生活方式，<font color=red size=2>带火了淘宝、京东、美团、字节跳动等企业</font>。没有跟上节奏的百度，有点摇摇欲坠。</li></ol><!-- <div align="center"><font color=red size=2><b>自古不变的真理：先入行着吃肉，后入行着喝汤，最后到的买单！</b></font></div> --><ol start="4"><li>人才紧缺，竞争压力小<br>有句话叫：“<font color=red size=2>选择大于努力</font>”选择一个好的方向，少奋斗十年。是否记得国家在2017年才开设大数据课程，当时是<font color=red size=2>北京大学、人民大学</font>等25所高校开设第一批大数据课程。今年才2022年.也就是今年才毕业，那么像Java、前端大学已经开设多少年了，包括培训班都加在一起，10多年，可想而知目前市场上，Java和前端的人才有多少。<br>大数据的人才目前除了培训机构培养的，没有真正的科班毕业，而且真正能培养好大数据人才的培训机构又有几个？<font color=red size=2>所以目前选择大数据是最佳选择。</font></li></ol><h2 id="5-大数据部门间业务流程分析">5. 大数据部门间业务流程分析</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A6%82%E8%AE%BA/2022-02-21-111416.png" class="" title="执行结果"><h2 id="6-大数据部门内组织结构">6. 大数据部门内组织结构</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220221/%E5%A4%A7%E6%95%B0%E6%8D%AE-20220221-%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%A6%82%E8%AE%BA/2022-02-21-111539.png" class="" title="执行结果">]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>测试HPA</title>
      <link href="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/"/>
      <url>/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-HPA-工作原理">1. HPA 工作原理</h2><p>Pod 弹性伸缩器（HPA）是 Kubernetes 的一项功能，可以对您的应用进行自动扩容和自动缩容。</p><h3 id="1-1-为什么要使用-HPA？">1.1 为什么要使用 HPA？</h3><p>使用 HPA，您可以自动缩放在 Replication Controller，Deployment 或者 Replica Set 中的 Pod。HPA 将自动缩放正在运行的 Pod 的数量，以实现最高效率。HPA 中影响 Pod 数量的因素包括：</p><ul><li>用户定义的允许运行的 Pod 的最小和最大数量。</li><li>资源指标中报告的观察到的 CPU 或内存使用情况。</li><li>第三方指标应用程序（例如 Prometheus，Datadog 等）提供的自定义指标。</li></ul><p>HPA 通过以下方式改善您的服务：</p><ul><li>释放因过多的 Pod 而浪费的硬件资源。</li><li>按照应用需要的性能，自动提高或降低 Pod 数量。</li></ul><h3 id="1-2-HPA-是如何工作的？">1.2 HPA 是如何工作的？</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/horizontal-pod-autoscaler-73e94153b61adc40a276899a326addc9.jpg" class="" title="执行结果"><p>HPA 是通过循环控制来实现的，其循环周期由下面的 <code>kube-controller-manager</code> 启动参数控制：</p><table><thead><tr><th>参数</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>–horizontal-pod-autoscaler-sync-period</td><td>30s</td><td>HPA 审核应用使用资源情况或自定义指标的频率。</td></tr><tr><td>–horizontal-pod-autoscaler-downscale-delay</td><td>5m0s</td><td>缩容操作完成后，HPA 必须等待多长时间才能进行另外一次缩容操作。</td></tr><tr><td>–horizontal-pod-autoscaler-upscale-delay</td><td>3m0s</td><td>扩容操作完成后，HPA 必须等待多长时间才能进行另外一次扩容操作。</td></tr></tbody></table><h2 id="2-创建nginx资源">2. 创建nginx资源</h2><p>要使用HPA创建的负载需要配置资源限制<br>资源预留为容器启动时必须占用的资源<br>资源限制为容器最大使用量</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/nginx.png" class="" title="执行结果"><h2 id="3-通过-Rancher-UI-管理-HPA">3. 通过 Rancher UI 管理 HPA</h2><p><a href="https://docs.rancher.cn/docs/rancher2/k8s-in-rancher/horitzontal-pod-autoscaler/manage-hpa-with-rancher-ui/_index/">官方文档</a></p><p>登录rancher点击资源创建HPA</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hpa.png" class="" title="执行结果"><p>根据实际情况配置相关参数，这里模拟测试cpu使用大于%1随即触发</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hpapeizhi.png" class="" title="执行结果"><p>等待hpa资源激活</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hpaactive.png" class="" title="执行结果"><h2 id="4-模拟压测">4. 模拟压测</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl http://192.168.10.21:31274; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>查看hpa资源情况,已经超过阈值使用量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@node02:~<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME        REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-9fmv8   Deployment/nginx   12%/1%    1         3         3          30m</span><br></pre></td></tr></table></figure><p>可以看到已经达到最大预期3个pod</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hapyace.png" class="" title="执行结果"><p>停止压测，稍等几分钟后,查看资源使用情况将为0%</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hapyacejietu.png" class="" title="执行结果"><p>缩容的统计窗口时间为5分钟，k8s会评估此窗口内的信息，以此消除突发的指标波动产生的神经质操作。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/hpanginx.png" class="" title="执行结果"><h2 id="5-总结">5. 总结</h2><p>rancher2.2.2升级到2.3.2后，通过rancherUI配置HPA测试正常通过。</p>]]></content>
      
      
      <categories>
          
          <category> rancher </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rancher </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s基础环境配置</title>
      <link href="/20220216/kubernetes-20220216-k8s%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/20220216/kubernetes-20220216-k8s%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1>1 主机基础配置</h1><h2 id="1-1-主机名配置">1.1 主机名配置</h2><p>因为 K8S 或者 <code>FQDN</code> 的规定，主机名仅支持包含 <code>-</code> 或/和 <code>.</code>(中横线和点)两种特殊符号，并且一个集群中主机名不能重复。</p><h2 id="1-2-Hosts">1.2 Hosts</h2><ol><li>Linux 系统安装完成后，在 <code>hosts(/etc/hosts)</code> 中应该有 <code>localhost</code> 指向 <code>127.0.0.1</code>，如果没有则手动添加上。</li><li>配置每台主机的 hosts(/etc/hosts)，添加 <code>host_ip $hostname</code> 到 <code>/etc/hosts</code> 文件中。</li></ol><h2 id="1-3-CentOS-关闭-selinux">1.3 CentOS 关闭 selinux</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="1-4-关闭防火墙-可选-或者放行相应端口">1.4 关闭防火墙(可选)或者放行相应端口</h2><ul><li><p>CentOS</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service &amp;&amp; systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure></li><li><p>Ubuntu</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw <span class="built_in">disable</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="1-5-配置主机时间、时区、系统语言">1.5 配置主机时间、时区、系统语言</h2><p>查看时区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span> -R 或者 timedatectl</span><br></pre></td></tr></table></figure><p>修改时区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure><p>修改系统语言环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;LANG=&quot;en_US.UTF-8&quot;&#x27;</span> &gt;&gt; /etc/profile; <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><p>配置主机 NTP 时间同步</p><h2 id="1-6-配置主机-DNS-服务器">1.6 配置主机 DNS 服务器</h2><p>对于类似 Ubuntu 18 这类默认使用 <code>systemd-resolve</code> 管理 DNS 服务器的系统，建议禁用 <code>systemd-resolved</code> 服务，然后手动配置 DNS。</p><p>因为 <code>systemd-resolve</code> 会使用 <code>127.0.x.x</code> 这样的 IP 来作为默认的 DNS 服务器地址，这个是主机的环回地址。这个地址传递到容器环境中后，容器应用无法访问这个地址。</p><p>操作方法：</p><p>1.禁用 systemd-resolved.service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> systemd-resolved.service</span><br><span class="line">systemctl stop systemd-resolved.service</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/resolv.conf; <span class="built_in">touch</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>2.接着编辑 <code>/etc/resolv.conf</code> 添加 DNS 服务器<br>3.重启 docker 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload; systemctl restart docker</span><br></pre></td></tr></table></figure><h1>2 Kernel 调优</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.forwarding=1</span></span><br><span class="line"><span class="string"># 参考 https://github.com/prometheus/node_exporter#disabled-by-default</span></span><br><span class="line"><span class="string">kernel.perf_event_paranoid=-1</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh=30</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string"># 存在于 ARP 高速缓存中的最少层数，如果少于这个数，垃圾收集器将不会运行，默认值：128。</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1=128</span></span><br><span class="line"><span class="string"># 保存在 ARP 高速缓存中的最大记录软限制。垃圾收集器在开始收集前，允许记录数超过这个数字 5 秒。默认值：512。</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2=6144</span></span><br><span class="line"><span class="string"># 保存在 ARP 高速缓存中的最大记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。默认值：1024。</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3=8192</span></span><br><span class="line"><span class="string"># 决定检查一次相邻层记录的有效性的周期。当相邻层记录失效时，将在给它发送数据前，再解析一次。默认值：60 秒。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 系统中所有进程能够同时打开的文件句柄数量</span></span><br><span class="line"><span class="string">fs.file-max=2097152</span></span><br><span class="line"><span class="string"># 设置每个用户可以运行的 inotifywait 或 inotifywatch 命令的进程数。</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances=8192</span></span><br><span class="line"><span class="string"># inotify 用于监控文件系统事件，该文件中的值为调用 inotify_init 函数时分配给 inotify 队列的事件数目的最大值，超出这个值得事件被丢弃，但会触发 IN_Q_OVERFLOW 事件，文件系统变化越频繁，这个值就应该越大</span></span><br><span class="line"><span class="string">fs.inotify.max_queued_events=16384</span></span><br><span class="line"><span class="string"># IO 复用 epoll 监听文件句柄的数量最大值</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=524288</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies=1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout=30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_synack_retries=2</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog=8096</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle=0</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 1048576</span></span><br><span class="line"><span class="string">kernel.randomize_va_space = 0</span></span><br><span class="line"><span class="string">net.core.somaxconn = 1024</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><blockquote><p>数值根据实际环境自行配置，最后执行 sysctl -p 保存配置。</p></blockquote><h1>3 连接数调整</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/security/limits.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">root soft nofile 655350</span></span><br><span class="line"><span class="string">root hard nofile 655350</span></span><br><span class="line"><span class="string">* soft nofile 655350</span></span><br><span class="line"><span class="string">* hard nofile 655350</span></span><br><span class="line"><span class="string">* soft nproc unlimited</span></span><br><span class="line"><span class="string">* hard nproc unlimited</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h1>4 Docker 安装与配置</h1><h2 id="4-1-Docker-安装">4.1 Docker 安装</h2><h3 id="4-1-1-修改系统源">4.1.1 修改系统源</h3><ul><li>Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class="line">sed -i <span class="string">&#x27;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sed -i <span class="string">&#x27;s/security.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure><ul><li>Centos 7.x</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install ca-certificates ;</span><br><span class="line">update-ca-trust;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -rf /etc/yum.repos.d /etc/yum.repos.d.backup</span><br><span class="line"></span><br><span class="line">sed -e <span class="string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> \</span><br><span class="line">    -e <span class="string">&#x27;s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos|g&#x27;</span> \</span><br><span class="line">    -i.bak /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><ul><li>centos8.x</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -rf /etc/yum.repos.d /etc/yum.repos.d.backup</span><br><span class="line"></span><br><span class="line">sed -e <span class="string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> \</span><br><span class="line">    -e <span class="string">&#x27;s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/centos|g&#x27;</span> \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Linux-AppStream.repo \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Linux-BaseOS.repo \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Linux-Extras.repo \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Linux-PowerTools.repo \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Linux-Plus.repo</span><br><span class="line"></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h3 id="4-1-2-Docker-ce-安装">4.1.2 Docker-ce 安装</h3><ul><li>Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义用户名</span></span><br><span class="line">NEW_USER=rancher</span><br><span class="line"><span class="comment"># 添加用户(可选)</span></span><br><span class="line">sudo adduser <span class="variable">$NEW_USER</span></span><br><span class="line"><span class="comment"># 为新用户设置密码</span></span><br><span class="line">sudo passwd <span class="variable">$NEW_USER</span></span><br><span class="line"><span class="comment"># 为新用户添加 sudo 权限</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NEW_USER</span> ALL=(ALL) ALL&quot;</span> &gt;&gt; /etc/sudoers</span><br><span class="line"><span class="comment"># 定义安装版本</span></span><br><span class="line"><span class="built_in">export</span> docker_version=18.09.9;</span><br><span class="line"><span class="comment"># 删除旧的 docker 组件</span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc -y;</span><br><span class="line"><span class="comment"># 更新 apt 源</span></span><br><span class="line">sudo apt-get update;</span><br><span class="line"><span class="comment"># 对系统进行全面的更新升级，推荐升级一下（可选）</span></span><br><span class="line">sudo apt-get -y upgrade;</span><br><span class="line"><span class="comment"># 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates \</span><br><span class="line">    curl software-properties-common bash-completion  gnupg-agent;</span><br><span class="line"><span class="comment"># 安装 GPG 证书</span></span><br><span class="line">sudo curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | \</span><br><span class="line">    sudo apt-key add -;</span><br><span class="line"><span class="comment"># 添加 Docker APT 源</span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span>;</span><br><span class="line"><span class="comment"># 更新并安装 Docker-CE</span></span><br><span class="line">sudo apt-get -y update;</span><br><span class="line">install_version=$( apt-cache madison docker-ce | grep <span class="variable">$&#123;docker_version&#125;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> );</span><br><span class="line"><span class="comment"># --allow-downgrades 允许降级安装</span></span><br><span class="line">sudo apt-get -y install docker-ce=<span class="variable">$&#123;install_version&#125;</span> docker-ce-cli=<span class="variable">$&#123;install_version&#125;</span> --allow-downgrades;</span><br><span class="line"><span class="comment"># 把当前用户加入 docker 组</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$NEW_USER</span>;</span><br><span class="line"><span class="comment"># 设置开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker;</span><br><span class="line"><span class="comment"># 清理不需要的依赖</span></span><br><span class="line">apt-get autoremove  -y</span><br></pre></td></tr></table></figure><ul><li>Centos</li></ul><blockquote><p>注意：在安装的时候如果提示 containerd 版本过低，则需要访问 <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages">https://download.docker.com/linux/centos/7/x86_64/stable/Packages</a> 下载最新版本的 containerd 到本地，然后运行 yum localinstall xxx.rpm 进行安装。</p></blockquote><blockquote><p>因为 CentOS 的安全限制，通过 RKE 安装 K8S 集群时候无法使用 root 账户。所以，建议 CentOS 用户使用非 root 用户来运 docker，不管是 RKE 还是 custom 安装 k8s。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义用户名</span></span><br><span class="line">NEW_USER=rancher</span><br><span class="line"><span class="comment"># 添加用户(可选)</span></span><br><span class="line">sudo adduser <span class="variable">$NEW_USER</span></span><br><span class="line"><span class="comment"># 为新用户设置密码</span></span><br><span class="line">sudo passwd <span class="variable">$NEW_USER</span></span><br><span class="line"><span class="comment"># 为新用户添加 sudo 权限</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NEW_USER</span> ALL=(ALL) ALL&quot;</span> &gt;&gt; /etc/sudoers</span><br><span class="line"><span class="comment"># 卸载旧版本 Docker 软件</span></span><br><span class="line">sudo yum remove docker \</span><br><span class="line">              docker-client \</span><br><span class="line">              docker-client-latest \</span><br><span class="line">              docker-common \</span><br><span class="line">              docker-latest \</span><br><span class="line">              docker-latest-logrotate \</span><br><span class="line">              docker-logrotate \</span><br><span class="line">              docker-selinux \</span><br><span class="line">              docker-engine-selinux \</span><br><span class="line">              docker-engine \</span><br><span class="line">              container*</span><br><span class="line"><span class="comment"># 定义安装版本</span></span><br><span class="line"><span class="built_in">export</span> docker_version=18.06.3</span><br><span class="line"><span class="comment"># 对系统进行全面的更新升级，推荐升级一下（可选）</span></span><br><span class="line">sudo yum update -y;</span><br><span class="line"><span class="comment"># 安装必要的一些系统工具</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data \</span><br><span class="line">    lvm2 bash-completion;</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">sudo yum-config-manager --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo;</span><br><span class="line"><span class="comment"># Step 3: 更新并安装 Docker-CE</span></span><br><span class="line">sudo yum makecache all;</span><br><span class="line">version=$(yum list docker-ce.x86_64 --showduplicates | <span class="built_in">sort</span> -r|grep <span class="variable">$&#123;docker_version&#125;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>);</span><br><span class="line">sudo yum -y install --<span class="built_in">setopt</span>=obsoletes=0 docker-ce-<span class="variable">$&#123;version&#125;</span> docker-ce-selinux-<span class="variable">$&#123;version&#125;</span>;</span><br><span class="line"><span class="comment"># 如果已经安装高版本 Docker,可进行降级安装(可选)</span></span><br><span class="line">yum downgrade --<span class="built_in">setopt</span>=obsoletes=0 -y docker-ce-<span class="variable">$&#123;version&#125;</span> docker-ce-selinux-<span class="variable">$&#123;version&#125;</span>;</span><br><span class="line"><span class="comment"># 把当前用户加入 docker 组</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$NEW_USER</span>;</span><br><span class="line"><span class="comment"># 设置开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker;</span><br></pre></td></tr></table></figure><h3 id="4-1-3-锁定-Docker-版本">4.1.3 锁定 Docker 版本</h3><p>可能因为某些原因无意间执行了 <code>yum update</code> 或者 <code>apt-get -y upgrade</code>;导致 Docker 版本升级。为了避免此类问题发生，建议在安装好 Docker 后对 Docker 软件进行锁定，防止 Docker 意外更新。</p><ul><li>centos<br>安装 yum-plugin-versionlock 插件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-plugin-versionlock</span><br></pre></td></tr></table></figure><p>锁定软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum versionlock add docker-ce docker-ce-cli</span><br><span class="line"></span><br><span class="line">[root@izwz969o7lu6t9lh4ta6m5z ~]<span class="comment"># yum versionlock add docker-ce docker-ce-cli</span></span><br><span class="line">已加载插件：fastestmirror, versionlock</span><br><span class="line">Adding versionlock on: 0:docker-ce-17.06.2.ce-3.el7.centos</span><br><span class="line">versionlock added: 1</span><br><span class="line">[root@izwz969o7lu6t9lh4ta6m5z ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>查看已锁定的软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum versionlock list</span><br></pre></td></tr></table></figure><p>解锁指定的软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum versionlock delete &lt;软件包名称&gt;</span><br></pre></td></tr></table></figure><p>解锁所有的软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum versionlock clear</span><br></pre></td></tr></table></figure><ul><li>Ubuntu<br>锁定软件：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark hold docker-ce docker-ce-cli</span><br></pre></td></tr></table></figure><p>查看已锁定的软件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark showhold</span><br></pre></td></tr></table></figure><p>软件包被锁定后，再次执行 apt-get upgrade 可以看到以下日志提示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@alihost-03:/home/docker<span class="comment"># apt-get  upgrade</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">Calculating upgrade... Done</span><br><span class="line">The following packages have been kept back:</span><br><span class="line">  docker-ce docker-ce-cli linux-generic linux-headers-generic linux-image-generic ubuntu-minimal</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 6 not upgraded.</span><br><span class="line">root@alihost-03:/home/docker<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>被锁定的软件不会再升级。</p><p>解除锁定：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark unhold docker-ce docker-ce-cli</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"><span class="comment">## 4.2 Docker 配置</span></span><br><span class="line">对于通过 systemd 来管理服务的系统(比如 CentOS7.X、Ubuntu16.X)，Docker 有两处可以配置参数: 一个是 `docker.service` 服务配置文件，一个是 Docker daemon 配置文件 daemon.json。</span><br><span class="line"></span><br><span class="line">1. docker.service</span><br><span class="line"></span><br><span class="line">对于 CentOS 系统，docker.service 默认位于 `/usr/lib/systemd/system/docker.service`；对于 Ubuntu 系统，docker.service 默认位于 `/lib/systemd/system/docker.service`</span><br><span class="line"></span><br><span class="line">2. daemon.json</span><br><span class="line"></span><br><span class="line">daemon.json 默认位于 `/etc/docker/daemon.json`，如果没有可手动创建，基于 systemd 管理的系统都是相同的路径。通过修改 daemon.json 来改过 Docker 配置，也是 Docker 官方推荐的方法。</span><br><span class="line"></span><br><span class="line">&gt; 以下说明均基于 systemd，并通过 `/etc/docker/daemon.json` 来修改配置。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.2.1 配置镜像下载和上传并发数</span></span><br><span class="line">从 Docker1.12 开始，支持自定义下载和上传镜像的并发数，默认值上传为 3 个并发，下载为 5 个并发。通过添加”max-concurrent-downloads”和”max-concurrent-uploads”参数对其修改:</span><br><span class="line">``` bash</span><br><span class="line"><span class="string">&quot;max-concurrent-downloads&quot;</span>: 3,</span><br><span class="line"><span class="string">&quot;max-concurrent-uploads&quot;</span>: 5</span><br></pre></td></tr></table></figure><h3 id="4-2-2-配置镜像加速地址">4.2.2 配置镜像加速地址</h3><p>Rancher 从 v1.6.15 开始到 v2.x.x,Rancher 系统相关的所有镜像(包括 1.6.x 上的 K8S 镜像)都托管在 Dockerhub 仓库。Dockerhub 节点在国外，国内直接拉取镜像会有些缓慢。为了加速镜像的下载，可以给 Docker 配置国内的镜像地址。</p><p>编辑 <code>/etc/docker/daemon.json</code> 加入以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://7bezldxe.mirror.aliyuncs.com/&quot;</span>,<span class="string">&quot;https://IP:PORT/&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>可以设置多个 registry-mirrors 地址，以数组形式书写，地址需要添加协议头(https 或者 http)。</p></blockquote><h3 id="4-2-3-配置-insecure-registries私有仓库">4.2.3 配置 insecure-registries私有仓库</h3><p>Docker 默认只信任 TLS 加密的仓库地址(https)，所有非 https 仓库默认无法登陆也无法拉取镜像。<code>insecure-registries</code> 字面意思为不安全的仓库，通过添加这个参数对非 https 仓库进行授信。可以设置多个 <code>insecure-registries</code> 地址，以数组形式书写，地址不能添加协议头(http)。</p><p>编辑 /etc/docker/daemon.json 加入以下内容:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.1.100&quot;</span>,<span class="string">&quot;IP:PORT&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-4-配置-Docker-存储驱动">4.2.4 配置 Docker 存储驱动</h3><p>OverlayFS 是一个新一代的联合文件系统，类似于 AUFS，但速度更快，实现更简单。Docker 为 OverlayFS 提供了两个存储驱动程序:旧版的 <code>overlay</code>，新版的 <code>overlay2</code>(更稳定)。</p><p>先决条件:</p><ul><li>overlay2: Linux 内核版本 4.0 或更高版本，或使用内核版本 3.10.0-514+的 RHEL 或 CentOS。</li><li>overlay: 主机 Linux 内核版本 3.18+</li><li>支持的磁盘文件系统<ul><li>ext4(仅限 RHEL 7.1)</li><li>xfs(RHEL7.2 及更高版本)，需要启用 d_type=true。</li></ul></li></ul><p>编辑 /etc/docker/daemon.json 加入以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage-opts&quot;</span>: [<span class="string">&quot;overlay2.override_kernel_check=true&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-5-配置日志驱动">4.2.5 配置日志驱动</h3><p>容器在运行时会产生大量日志文件，很容易占满磁盘空间。通过配置日志驱动来限制文件大小与文件的数量。</p><blockquote><p>限制单个日志文件为 100M,最多产生 3 个日志文件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line"><span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-6-可选-修改-Docker0-默认-网络接口-IP-地址">4.2.6 (可选)修改 Docker0 默认 网络接口 IP 地址</h3><p>Docker 第一次运行时会自动创建名为 docker0 的网络接口，默认接口地址为 172.17.0.1/16。在一些企业中，可能已经使用了这个网段的地址，或者规划以后会使用这个网段的地址。所以，建议在安装好 docker 服务后，第一时间修改 docker0 接口地址，避免后期出现网段冲突。</p><ul><li>停止 docker 运行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker.service</span><br></pre></td></tr></table></figure><ul><li>删除已有的 docker0 接口</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip <span class="built_in">link</span> del docker0</span><br></pre></td></tr></table></figure><ul><li><p>修改 docker 配置文件<br>在 /etc/docker/daemon.json 中添加 “bip”: “192.168.100.1/24”,</p></li><li><p>重启启动 docker</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker; systemctl daemon-reload; systemctl restart docker;</span><br></pre></td></tr></table></figure><ul><li>docker.service 配置<ol><li>对于 CentOS 系统，docker.service 默认位于 /usr/lib/systemd/system/docker.service；</li><li>对于 Ubuntu 系统，docker.service 默认位于 /lib/systemd/system/docker.service。</li></ol></li></ul><p>编辑 docker.service，添加以下参数。</p><ul><li>防止 docker 服务 OOM： <code>OOMScoreAdjust=-1000</code></li><li>开启 iptables 转发链：<br><code>ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT</code></li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220216/kubernetes-20220216-k8s%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20190615165436722.ea672a70.png" class="" title="执行结果"><h3 id="4-2-7-Ubuntu-Debian-系统-，docker-info-提示-WARNING-No-swap-limit-support">4.2.7 Ubuntu\Debian 系统 ，docker info 提示 WARNING: No swap limit support</h3><p>Ubuntu\Debian 系统下，默认 cgroups 未开启 swap account 功能，这样会导致设置容器内存或者 swap 资源限制不生效。可以通过以下命令解决:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统一网卡名称为 ethx</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;s/en[[:alnum:]]*/eth0/g&#x27;</span> /etc/network/interfaces;</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/GRUB_CMDLINE_LINUX=&quot;\(.*\)&quot;/GRUB_CMDLINE_LINUX=&quot;net.ifnames=0 cgroup_enable=memory swapaccount=1 biosdevname=0 \1&quot;/g&#x27;</span> /etc/default/grub;</span><br><span class="line">sudo update-grub;</span><br></pre></td></tr></table></figure><p>注意 通过以上命令可自动配置参数，如果 /etc/default/grub 非默认配置，需根据实际参数做调整。 提示 以上配置完成后，建议重启一次主机</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helm2升级rancher2-2-2到rancher2-3-2</title>
      <link href="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/"/>
      <url>/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/</url>
      
        <content type="html"><![CDATA[<h2 id="1-集群现状">1. 集群现状</h2><p><strong>rke部署工具版本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke -version</span></span><br><span class="line">rke version v0.2.6</span><br></pre></td></tr></table></figure><p><strong>rke部署k8s集群版本（用于高可用部署rancher）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl version</span></span><br><span class="line">Client Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.3&quot;</span>, GitCommit:<span class="string">&quot;5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-06-06T01:44:30Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.5&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.3&quot;</span>, GitCommit:<span class="string">&quot;5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-06-06T01:36:19Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.5&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p><strong>rancher版本和负载集群版本</strong><br>rancher2.2.2<br>kubernetes 1.13.5</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/2022-02-16_172405.png" class="" title="执行结果"><h2 id="2-升级版本简介">2. 升级版本简介</h2><p>官方2.3.x版本说明 <a href="https://docs.rancher.cn/docs/rancher2/releases/v2.3.0/">2.3.0</a><br>Rancher 2.3.2，这是Rancher 2.3.x第一个stable的版本，这意味着它是Rancher官方推荐所有用户可用于生产环境的稳定版本！</p><h2 id="3-升级步骤">3. 升级步骤</h2><p>官方的升级指南<a href="https://docs.rancher.cn/docs/rancher2/installation/install-rancher-on-k8s/upgrades/ha/helm2/_index">高可用升级指南（Helm 2）</a></p><h3 id="3-1-备份正在运行-Rancher-Server-的-Kubernetes-集群">3.1 备份正在运行 Rancher Server 的 Kubernetes 集群</h3><p><strong>创建rke集群快照</strong><br>如若升级失败用户恢复rancher版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke etcd snapshot-save --name etcd-2022021602.db --config cluster.yml</span></span><br><span class="line">INFO[0000] Starting saving snapshot on etcd hosts       </span><br><span class="line">INFO[0000] [dialer] Setup tunnel <span class="keyword">for</span> host [192.168.10.20] </span><br><span class="line">INFO[0000] [etcd] Saving snapshot [etcd-2022021602.db] on host [192.168.10.20] </span><br><span class="line">INFO[0001] [etcd] Successfully started [etcd-snapshot-once] container on host [192.168.10.20] </span><br><span class="line">INFO[0001] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0001] Container [etcd-snapshot-once] is still running on host [192.168.10.20] </span><br><span class="line">INFO[0002] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0002] Container [etcd-snapshot-once] is still running on host [192.168.10.20] </span><br><span class="line">INFO[0003] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0003] Finished saving snapshot [etcd-2022021602.db] on all etcd hosts </span><br></pre></td></tr></table></figure><p><strong>备份负载集群</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/backfuzaijiqun.png" class="" title="执行结果"><h3 id="3-2-更新-Helm-chart-仓库">3.2 更新 Helm chart 仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><p>确保有需要升级的版本<br>rancher官方仓库stable版本列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># helm search rancher -l</span></span><br><span class="line">rancher-stable/rancher2.3.4           v2.3.4           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.3.3           v2.3.3           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.3.2           v2.3.2           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.13          v2.2.13          Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.11          v2.2.11          Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.10          v2.2.10          Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.9           v2.2.9           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.8           v2.2.8           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.7           v2.2.7           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.6           v2.2.6           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.5           v2.2.5           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.4           v2.2.4           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.3           v2.2.3           Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher2.2.2           v2.2.2           Install Rancher Server to manage Kubernetes clusters acro...</span><br></pre></td></tr></table></figure><h3 id="3-3-升级-Rancher">3.3 升级 Rancher</h3><p><strong>从已安装的当前 Rancher Helm chart 中获取通过 --set 传递的值</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># helm get values rancher</span></span><br><span class="line">hostname: cloud.jfjbapp.cn</span><br><span class="line">ingress:</span><br><span class="line">  tls:</span><br><span class="line">    <span class="built_in">source</span>: secret</span><br><span class="line">privateCA: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>更新到指定版本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade rancher rancher-stable/rancher \</span><br><span class="line">  --namespace cattle-system \</span><br><span class="line">  --<span class="built_in">set</span> hostname=cloud.jfjbapp.cn \</span><br><span class="line">  --<span class="built_in">set</span> ingress.tls.source=secret \</span><br><span class="line">  --<span class="built_in">set</span> privateCA=<span class="literal">true</span> \</span><br><span class="line">  --version 2.3.2</span><br></pre></td></tr></table></figure><p>升级过程后端集群需要升级rancher-agent从2.2.2到2.3.2会有1-2分钟负载集群不可用状态</p><p>稍等rancher和集群恢复正常状态</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/zhengchang.png" class="" title="执行结果"><p>检查rke集群pod是否正常,确保状态为running并且无重启状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-74bcd8b6df-zxdrb     1/1     Running     0          3m12s</span><br><span class="line">cattle-system   cattle-node-agent-vqm4t                   1/1     Running     0          3m8s</span><br><span class="line">cattle-system   rancher-848d7f74fd-5bstv                  1/1     Running     0          4m30s</span><br><span class="line">cattle-system   rancher-848d7f74fd-5hhjg                  1/1     Running     0          4m56s</span><br><span class="line">cattle-system   rancher-848d7f74fd-fhm7k                  1/1     Running     0          5m10s</span><br><span class="line">ingress-nginx   default-http-backend-5954bd5d8c-9gjz7     1/1     Running     3          46h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-zftwb            1/1     Running     0          7h11m</span><br><span class="line">kube-system     canal-ljlxc                               2/2     Running     0          7h11m</span><br><span class="line">kube-system     coredns-86bc4b7c96-z875n                  1/1     Running     0          7h11m</span><br><span class="line">kube-system     coredns-autoscaler-5d5d49b8ff-5jwvr       1/1     Running     0          7h11m</span><br><span class="line">kube-system     metrics-server-7f6bd4c888-4xxm8           1/1     Running     0          7h11m</span><br><span class="line">kube-system     rke-coredns-addon-deploy-job-zj72v        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-sbprl   0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-xtf8m        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-pd9vg       0/1     Completed   0          46h</span><br><span class="line">kube-system     tiller-deploy-7cb87ddf7d-vzr4j            1/1     Running     3          46h</span><br></pre></td></tr></table></figure><p>同理检查负载集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@node02:~<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-7d74b74f89-xrnx8     1/1     Running     0          5m7s</span><br><span class="line">cattle-system   cattle-node-agent-4gf92                   1/1     Running     0          5m</span><br><span class="line">cattle-system   kube-api-auth-nprjl                       1/1     Running     0          4m20s</span><br><span class="line">default         nginx-6d6d68488c-vq9qd                    1/1     Running     1          9h</span><br><span class="line">ingress-nginx   default-http-backend-78fccfc5d9-7krhb     1/1     Running     1          9h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-jjw6l            1/1     Running     0          7h8m</span><br><span class="line">kube-system     canal-wgzpc                               2/2     Running     0          7h8m</span><br><span class="line">kube-system     kube-dns-58bd5b8dd7-5h4l7                 3/3     Running     0          7h8m</span><br><span class="line">kube-system     kube-dns-autoscaler-77bc5fd84-8rvss       1/1     Running     0          7h8m</span><br><span class="line">kube-system     metrics-server-58bd5dd8d7-s5pcf           1/1     Running     0          7h8m</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-rkdgf   0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-kube-dns-addon-deploy-job-8l4xq       0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-62fmt        0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-98tdb       0/1     Completed   0          9h</span><br></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/shengjihou.png" class="" title="执行结果"><p>至此，升级完成。</p><h2 id="4-版本回滚">4. 版本回滚</h2><p>官方的回退指南<a href="https://docs.rancher.cn/docs/rancher2/backups/restore/ha-restore/_index/">高可用恢复</a></p><h3 id="4-1-从本地快照还原rke集群">4.1 从本地快照还原rke集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke etcd snapshot-restore --name etcd-2022021602.db --config cluster.yml</span></span><br><span class="line">INFO[0000] Restoring etcd snapshot etcd-2022021602.db   </span><br><span class="line">INFO[0000] Successfully Deployed state file at [./cluster.rkestate] </span><br><span class="line">INFO[0000] [dialer] Setup tunnel <span class="keyword">for</span> host [192.168.10.20] </span><br><span class="line">INFO[0007] [etcd] starting backup server on host [192.168.10.20] </span><br><span class="line">INFO[0007] [etcd] Successfully started [etcd-Serve-backup] container on host [192.168.10.20] </span><br><span class="line">INFO[0012] [remove/etcd-Serve-backup] Successfully removed container on host [192.168.10.20] </span><br><span class="line">INFO[0012] [etcd] Checking <span class="keyword">if</span> all snapshots are identical</span><br><span class="line">...</span><br><span class="line">INFO[0076] [ingress] ingress controller nginx deployed successfully </span><br><span class="line">INFO[0076] [addons] Setting up user addons              </span><br><span class="line">INFO[0076] [addons] no user addons defined              </span><br><span class="line">INFO[0076] Finished building Kubernetes cluster successfully </span><br><span class="line">INFO[0076] Restarting network, ingress, and metrics pods </span><br><span class="line">INFO[0078] Finished restoring snapshot [etcd-2022021602.db] on all etcd hosts</span><br></pre></td></tr></table></figure><p>等待两个anget容器恢复running状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-588959c4bf-hpgfr     1/1     Running     2          40s</span><br><span class="line">cattle-system   cattle-node-agent-4h6kx                   1/1     Running     3          26h</span><br><span class="line">cattle-system   rancher-6ff949dc75-6cfbj                  1/1     Running     0          42h</span><br><span class="line">cattle-system   rancher-6ff949dc75-jnn87                  1/1     Running     0          42h</span><br><span class="line">cattle-system   rancher-6ff949dc75-pcz7c                  1/1     Running     0          42h</span><br><span class="line">ingress-nginx   default-http-backend-5954bd5d8c-9gjz7     1/1     Running     3          46h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-7td9m            1/1     Running     0          26s</span><br><span class="line">kube-system     canal-xv2sd                               2/2     Running     0          40s</span><br><span class="line">kube-system     coredns-86bc4b7c96-kcnqk                  1/1     Running     0          40s</span><br><span class="line">kube-system     coredns-autoscaler-5d5d49b8ff-g6h7n       1/1     Running     0          40s</span><br><span class="line">kube-system     metrics-server-7f6bd4c888-zv8fc           1/1     Running     0          40s</span><br><span class="line">kube-system     rke-coredns-addon-deploy-job-zj72v        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-sbprl   0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-xtf8m        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-pd9vg       0/1     Completed   0          46h</span><br><span class="line">kube-system     tiller-deploy-7cb87ddf7d-vzr4j            1/1     Running     3          46h</span><br></pre></td></tr></table></figure><h3 id="4-2-恢复负载集群">4.2 恢复负载集群</h3><p>选择负载集群恢复找到备份的时间，点击恢复</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifu.png" class="" title="执行结果"><p>等待集群更新</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifujiqun.png" class="" title="执行结果"><p>等待集群恢复查看rancher-agent版本</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifu2.2.png" class="" title="执行结果"><p>至此，集群恢复完成。</p><h2 id="5-升级和回滚负载集群测试">5. 升级和回滚负载集群测试</h2><p>创建2个负载容器</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/ceshi.png" class="" title="执行结果"><p>用死循环模拟不间断请求</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># while true; do curl -I http://192.168.10.21:31274/ ;done</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.5</span><br><span class="line">Date: Thu, 17 Feb 2022 01:35:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 28 Dec 2021 18:48:00 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;61cb5be0-267&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h2 id="6-总结-2">6. 总结</h2><p>在升级到 v2.3.0 时，第一次修改通过 Rancher v2.3.0 之前版本部署的 RKE 集群时，由于要向系统组件中加入 Tolerations，该集群全部的系统组件将会自动重启。升级前请预先做好数据备份。</p><p>以上为官方版本说明，经过测试rancher在升级过程中请求不会发生中断，回滚过程中负载集群所有pod都会重新创建模拟请求会发生中断。</p>]]></content>
      
      
      <categories>
          
          <category> rancher </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rancher </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RKE集群helm2部署rancher-v2.2.2</title>
      <link href="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/"/>
      <url>/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/</url>
      
        <content type="html"><![CDATA[<p>对于生产环境，需以高可用的配置安装 Rancher，确保用户始终可以访问 Rancher Server。当安装在Kubernetes集群中时，Rancher将与集群的 etcd 集成，并利用Kubernetes 调度实现高可用。</p><p>为确保高可用，本文所部署的 Kubernetes 集群将专用于运行 Rancher ，Rancher 运行起来后，可再创建或导入集群以运行具体的工作负载。</p><h2 id="1-推荐架构">1. 推荐架构</h2><ul><li>Rancher的DNS 应解析到 4层(TCP) 负载均衡上。</li><li>负载均衡应将端口 TCP/80 和 TCP/443 转发到 Kubernetes 集群中的所有3个节点。</li><li>Ingress-controller 将 HTTP 重定向到HTTPS并终止端口 TCP/443 上的 SSL/TLS（SSL数字证书在这里部署）。</li><li>Ingress-controller 将流量转发到 pod 的 TCP/80 端口。</li></ul><p>下面是一张从官网拉过来的图片,更直观一些。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/rancher2ha.svg" class="" title="执行结果"><h2 id="2-准备工作">2. 准备工作</h2><h3 id="2-1-服务器准备">2.1 服务器准备</h3><ol><li>1台 Linux服务器，配置不用很高，用于四层负载均衡</li><li>3台 Linux服务器，Rancker-server-node 节点</li><li>n台 Linux服务器，Rancker-agent-node 节点(n&lt;=50)</li></ol><p>节点服务器的硬件配置，可根据实际情况依据该表自行选择。</p><table><thead><tr><th>规模</th><th>集群</th><th>节点</th><th>CPU内存</th></tr></thead><tbody><tr><td>小</td><td>最多5个</td><td>高达50</td><td>2</td></tr><tr><td>中</td><td>最多15个</td><td>最多200</td><td>4</td></tr><tr><td>大</td><td>高达50</td><td>最多500个</td><td>8</td></tr><tr><td>超大</td><td>最多100个</td><td>高达1000</td><td>32</td></tr><tr><td>更大规模</td><td>100+</td><td>1000+</td><td>联系 Rancher</td></tr></tbody></table><h3 id="2-2工具安装">2.2工具安装</h3><p>这里按自己习惯，我这里把所有文件部署到/data/rke/rke2.2.2</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/mulu.png" class="" title="执行结果"><h4 id="2-2-1-安装-kubectl">2.2.1 安装 kubectl</h4><p>这是一个 kubernetes 命令行工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载目前最新版</span></span><br><span class="line">curl -LO https://dl.k8s.io/release/v1.14.3/bin/linux/amd64/kubectl</span><br><span class="line"><span class="comment"># 设置执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x ./linux-amd64-v1.14.3-kubectl </span><br><span class="line"><span class="comment"># 改短名字</span></span><br><span class="line">sudo <span class="built_in">mv</span> ./linux-amd64-v1.14.3-kubectl kubectl</span><br></pre></td></tr></table></figure><h4 id="2-2-2-安装-RKE">2.2.2 安装 RKE</h4><p>RKE 全称 Rancher Kubernetes Engine，是一个用于构建 kubernets 集群的命令行工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载目前最新版</span></span><br><span class="line">curl -LO https://github.com/rancher/rke/releases/download/v0.2.6/rke_linux-amd64</span><br><span class="line"><span class="comment"># 设置执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x rke_linux-amd64</span><br><span class="line"><span class="comment"># 改短名字</span></span><br><span class="line">sudo <span class="built_in">mv</span> rke_linux-amd64 rke</span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">./rke --version <span class="comment"># rke version v0.2.6</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3-安装-helm">2.2.3 安装 helm</h4><p>helm 是Kubernetes的包管理器。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 网络原因，切换到 github 提供的镜像连接</span></span><br><span class="line">curl -LO https://get.helm.sh/helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf helm-v2.0.0-linux-amd64.tgz</span><br><span class="line"><span class="comment"># 改短名字</span></span><br><span class="line"><span class="built_in">mv</span> linux-amd64/helm helm</span><br></pre></td></tr></table></figure><h2 id="3-创建节点和负载均衡">3. 创建节点和负载均衡</h2><p>这些节点须在同一个网络区域或数据中心。</p><h3 id="3-1-节点准备">3.1 节点准备</h3><p><strong>操作系统</strong></p><p>所有节点安装 ubuntu 16.04(64-bit x86)</p><p><strong>网络要求</strong><br>注意参考 官网放行相关端口。本文 ip 清单（仅用于演示）：</p><table><thead><tr><th>NODE</th><th>IP</th><th>备注</th></tr></thead><tbody><tr><td>NODE-LB</td><td>公网</td><td>168.168.168.1 / 内网 10.0.0.1</td></tr><tr><td>NODE-SERVER</td><td>公网</td><td>168.168.168.6 / 内网 10.0.0.6</td></tr><tr><td>NODE-SERVER</td><td>公网</td><td>168.168.168.7 / 内网 10.0.0.7</td></tr><tr><td>NODE-SERVER</td><td>公网</td><td>168.168.168.8 / 内网 10.0.0.8</td></tr><tr><td>NODE-WORKER</td><td>公网</td><td>168.168.168.16 / 内网 10.0.0.16</td></tr><tr><td>NODE-WORKER</td><td>公网</td><td>168.168.168.17 / 内网 10.0.0.17</td></tr><tr><td>NODE-WORKER</td><td>公网</td><td>168.168.168.18 / 内网 10.0.0.18</td></tr></tbody></table><p><strong>docker-ce</strong></p><p>并安装最新stable版 docker-ce:18.06.3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce=5:18.09.2~3-0~ubuntu-xenial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span></span><br><span class="line"><span class="comment"># sudo apt-get -y install docker-ce=[VERSION]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  配置docker</span></span><br><span class="line"></span><br><span class="line">root@iZ2zegfpsrzdc0fhgcv2w3Z:~<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;max-concurrent-uploads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://7bezldxe.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-配置四层负载均衡">3.2 配置四层负载均衡</h3><p>RKE 将会在每个节点上配置一个 Ingress-controller pod，这个 pod 将绑定到该节点的 TCP/80 和 TCP/443 端口，作为 Rancher-server 的HTTPS流量入口点。</p><p>将负载均衡器配置为基本的第4层TCP转发器，这里采用 NGINX 作四层负载均衡。</p><p><strong>安装 Nginx</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br><span class="line"><span class="comment"># /usr/sbin/nginx：主程序</span></span><br><span class="line"><span class="comment"># /etc/nginx：存放配置文件</span></span><br><span class="line"><span class="comment"># /usr/share/nginx：存放静态文件</span></span><br><span class="line"><span class="comment"># /var/log/nginx：存放日志</span></span><br></pre></td></tr></table></figure><p>更新配置文件 /etc/nginx/nginx.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 4;</span><br><span class="line">worker_rlimit_nofile 40000;</span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 8192;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">stream &#123;</span><br><span class="line">    upstream rancher_servers_http &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server 10.0.0.6:80 max_fails=3 fail_timeout=5s;</span><br><span class="line">        server 10.0.0.7:80 max_fails=3 fail_timeout=5s;</span><br><span class="line">        server 10.0.0.8:80 max_fails=3 fail_timeout=5s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen     80;</span><br><span class="line">        proxy_pass rancher_servers_http;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    upstream rancher_servers_https &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server 10.0.0.6:443 max_fails=3 fail_timeout=5s;</span><br><span class="line">        server 10.0.0.7:443 max_fails=3 fail_timeout=5s;</span><br><span class="line">        server 10.0.0.8:443 max_fails=3 fail_timeout=5s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen     443;</span><br><span class="line">        proxy_pass rancher_servers_https;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>注意：将local群集专用于Rancher。<br>勿将此负载均衡（即local群集Ingress）对 Rancher 以外的应用程序进行负载转发。</p></div><h2 id="4-使用-RKE-安装-kubernetes">4. 使用 RKE 安装 kubernetes</h2><p>下面使用 RKE(Kubernetes Engine) 安装高可用的 Kubernetes。</p><h3 id="4-1-NODE-SERVER-之间建立-ssh-信任">4.1 NODE-SERVER 之间建立 ssh 信任</h3><p>我们目前有三台服务器用作 local 集群，首先要确保我们主机能够通过 ssh 访问到另外两台主机并执行相关操作。比如执行 docker 命令，还记得前面我们加入 docker 用户组的用户吧。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据需求配置相关信息生成 rsa 公钥密钥</span></span><br><span class="line">ssh-keygen</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 复制当前主机上的公钥到另外两台上面，实现免密码登录</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub user@x.x.x.x</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 要注意这里也要跟自己注册注册一下 ：ssh-copy-id -i ~/.ssh/id_rsa.pub user@本机ip</span></span><br></pre></td></tr></table></figure><h3 id="4-2-创建-rke-配置文件">4.2 创建 rke 配置文件</h3><div class="note primary no-icon flat"><p>注意: 如果节点有公网地址 和 内网地址地址，建议手动设置 internal_address:以便 Kubernetes 将内网地址用于集群内部通信。如果需要开启自动配置安全组或防火墙，某些服务(如 AWS EC2)需要设置 internal_address:。</p></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">nodes:</span><br><span class="line">  - address: 165.227.114.x</span><br><span class="line">    internal_address: 172.16.22.x</span><br><span class="line">    user: ubuntu</span><br><span class="line">    role: [controlplane,worker,etcd]</span><br><span class="line">  - address: 165.227.116.x</span><br><span class="line">    internal_address: 172.16.32.x</span><br><span class="line">    user: ubuntu</span><br><span class="line">    role: [controlplane,worker,etcd]</span><br><span class="line">  - address: 165.227.127.x</span><br><span class="line">    internal_address: 172.16.42.x</span><br><span class="line">    user: ubuntu</span><br><span class="line">    role: [controlplane,worker,etcd]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果要使用私有仓库中的镜像，配置以下参数来指定默认私有仓库地址。</span></span><br><span class="line"><span class="comment">##private_registries:</span></span><br><span class="line"><span class="comment">##    - url: registry.com</span></span><br><span class="line"><span class="comment">##      user: Username</span></span><br><span class="line"><span class="comment">##      password: password</span></span><br><span class="line"><span class="comment">##      is_default: true</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  etcd:</span><br><span class="line">    <span class="comment"># 扩展参数 https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/configuration.md</span></span><br><span class="line">    extra_args:</span><br><span class="line">      auto-compaction-mode: periodic</span><br><span class="line">      auto-compaction-retention: 60m</span><br><span class="line">      <span class="comment"># 修改空间配额为$((6*1024*1024*1024))，默认 2G,最大 8G</span></span><br><span class="line">      quota-backend-bytes: <span class="string">&#x27;6442450944&#x27;</span></span><br><span class="line">      snapshot-count: 50000</span><br><span class="line">    <span class="comment"># 自动备份</span></span><br><span class="line">    <span class="comment">## rke 版本小于 0.2.x 或 rancher 版本小于 v2.2.0 时使用</span></span><br><span class="line">    snapshot: <span class="literal">true</span></span><br><span class="line">    creation: 6h</span><br><span class="line">    retention: 24h</span><br><span class="line">    <span class="comment">## rke 版本大于等于 0.2.x 或 rancher 版本大于等于 v2.2.0 时使用(两段配置二选一)</span></span><br><span class="line">    backup_config:</span><br><span class="line">      enabled: <span class="literal">true</span>         <span class="comment"># 设置 true 启用 ETCD 自动备份，设置 false 禁用；</span></span><br><span class="line">      interval_hours: 12    <span class="comment"># 快照创建间隔时间，不加此参数，默认 5 分钟；</span></span><br><span class="line">      retention: 6          <span class="comment"># etcd 备份保留份数；</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1-RKE-节点参数说明">4.2.1 RKE 节点参数说明</h4><table><thead><tr><th>参数</th><th>必须</th><th>描述</th></tr></thead><tbody><tr><td>address</td><td>yes</td><td>公共域名或 IP 地址</td></tr><tr><td>user</td><td>yes</td><td>可以运行 docker 命令的用户</td></tr><tr><td>role</td><td>yes</td><td>分配给节点的 Kubernetes 角色列表</td></tr><tr><td>internal_address</td><td>no</td><td>内部集群通信的私有域名或 IP 地址</td></tr><tr><td>ssh_key_path</td><td>no</td><td>用于对节点进行身份验证的 SSH 私钥的路径（默认为~/.ssh/id_rsa）</td></tr></tbody></table><h4 id="4-2-2-镜像仓库配置">4.2.2 镜像仓库配置</h4><p>如果需要使用自己镜像仓库的镜像或者是离线安装，那么可以在 private_registries 字段中配置私有镜像仓库信息。</p><table><thead><tr><th>选项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>url</td><td>‘’</td><td>镜像仓库地址</td></tr><tr><td>user</td><td>‘’</td><td>镜像仓库用户名</td></tr><tr><td>password</td><td>‘’</td><td>镜像仓库密码</td></tr><tr><td>is_default</td><td>true/false</td><td>这个参数很重要，当配置这个参数后，rke 会自动为系统镜像添加镜像仓库前缀，比如 rancher/rancher 会变为192.168.1.1/rancher/rancher，用于离线环境或者使用自己的私有仓库构建集群。</td></tr></tbody></table><blockquote><p>完整的配置示例，请参考<a href="https://docs.rancher.cn/docs/rke/example-yamls/_index/">完整-cluster-yml-示例</a></p></blockquote><p>根据以上样例，执行命令生成配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据提示一步一步生成配置</span></span><br><span class="line">./rke config --name cluster.yml</span><br></pre></td></tr></table></figure><h3 id="4-3-运行-RKE-构建-kubernetes-集群">4.3 运行 RKE 构建 kubernetes 集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rke up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证：返回类似下面的消息则说明执行成功，有问题欢迎留言交流。</span></span><br><span class="line"><span class="comment"># Finished building Kubernetes cluster successfully.</span></span><br></pre></td></tr></table></figure><p>执行成功会在当前目录生成一个文件 kube_config_rancher-cluster.yml</p><h3 id="4-4-配置环境变量">4.4 配置环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke]<span class="comment"># vim /etc/profile.d/rke.sh</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/data/rke/rke2.2.2/kube_config_cluster.yml</span><br><span class="line"></span><br><span class="line">[root@localhost rke]<span class="comment"># vim /root/.bashrc</span></span><br><span class="line"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;/data/rke/rke2.2.2/kubectl&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> helm=<span class="string">&#x27;/data/rke/rke2.2.2/helm&#x27;</span></span><br><span class="line"></span><br><span class="line">. /root/.bashrc</span><br><span class="line">. /etc/profile.d/rke.sh</span><br></pre></td></tr></table></figure><h3 id="4-5-测试集群">4.5 测试集群</h3><p>RKE 会自动创建 kube_config_rancher-cluster.yml。这个文件包含 kubectl 和 helm 访问 K8S 的凭据，请妥善保管。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@iZ2zeasfsez3jw7rpiqh8fZ:~/rke<span class="comment"># kubectl get node -o wide</span></span><br><span class="line"><span class="comment"># 返回下面信息说明集群创建成功</span></span><br><span class="line">NAME           STATUS   ROLES                      AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span><br><span class="line">192.168.0.81   Ready    controlplane,etcd,worker   7m4s   v1.14.3   192.168.0.81   &lt;none&gt;        Ubuntu 16.04.7 LTS   4.4.0-210-generic   docker://18.9.2</span><br><span class="line">192.168.0.82   Ready    controlplane,etcd,worker   7m3s   v1.14.3   192.168.0.82   &lt;none&gt;        Ubuntu 16.04.7 LTS   4.4.0-210-generic   docker://18.9.2</span><br><span class="line">192.168.0.83   Ready    controlplane,etcd,worker   7m4s   v1.14.3   192.168.0.83   &lt;none&gt;        Ubuntu 16.04.7 LTS   4.4.0-210-generic   docker://18.9.2</span><br></pre></td></tr></table></figure><h3 id="4-6-保存好相关配置文件">4.6 保存好相关配置文件</h3><p>当排除故障、升级群集时需要用到以下文件，请将其副本保存在一个安全的位置。<br>rancher-cluster.yml：RKE集群配置文件。<br>kube_config_rancher-cluster.yml：群集的Kubeconfig文件，此文件包含完全访问群集的凭据。<br>rancher-cluster.rkestate：Kubernetes群集状态文件，此文件包含完全访问群集的凭据。</p><h3 id="4-7-初始化-Helm">4.7 初始化 Helm</h3><p>一开始，我们安装了 Helm ，Helm 是 Kubernetes 首选的包管理工具。为了能够使用 Helm，需要在群集上安装服务器端组件 tiller。<br>Kubernetes APIServer 开启了 RBAC 访问控制，所以需要创建 tiller 使用的service account: tiller 并分配合适的角色给它。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 kube-system 命名空间下创建一个 serviceaccount ,并将角色绑定给 tiller</span></span><br><span class="line">kubectl -n kube-system create serviceaccount tiller</span><br><span class="line"><span class="comment"># 创建一个clusterrolebinding绑定管理员权限</span></span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 然后， heml 就可以在集群上安装 tiller 了</span></span><br><span class="line"><span class="comment"># 同样，网络原因，我们需要配置一个镜像仓库地址</span></span><br><span class="line">helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 输出：$HELM_HOME has been configured at /home/ubuntu/.helm.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用程序设置serviceAccount 注意：默认情况下,部署舵柄与一个不安全的“允许未经身份验证的用户”政策。</span></span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="4-8-测试-tiller-安装是否成功">4.8 测试 tiller 安装是否成功</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system  rollout status deploy/tiller-deploy</span><br><span class="line"><span class="comment"># 输出 deployment &quot;tiller-deploy&quot; successfully rolled out</span></span><br><span class="line"> </span><br><span class="line">helm version</span><br><span class="line"><span class="comment"># Client: &amp;version.Version&#123;SemVer:&quot;v2.13.1&quot;, GitCommit:&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;, GitTreeState:&quot;clean&quot;&#125;</span></span><br><span class="line"><span class="comment"># Server: &amp;version.Version&#123;SemVer:&quot;v2.13.1&quot;, GitCommit:&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;, GitTreeState:&quot;clean&quot;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-自签CA证书（内网自建使用）">5. 自签CA证书（内网自建使用）</h3><p><a href="https://docs.rancher.cn/docs/rancher2.5/installation/resources/advanced/self-signed-ssl/_index/#41-%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90-ssl-%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E8%84%9A%E6%9C%AC">生成自签名 SSL 证书</a></p><p><strong>创建脚本</strong><br>create_self-signed-cert.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">help</span></span> ()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; ================================================================ &#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-domain: 生成ssl证书需要的主域名，如不指定则默认为www.rancher.local，如果是ip访问服务，则可忽略；&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-trusted-ip: 一般ssl证书只信任域名的访问请求，有时候需要使用ip去访问server，那么需要给ssl证书添加扩展IP，多个IP用逗号隔开；&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-trusted-domain: 如果想多个域名访问，则添加扩展域名（SSL_TRUSTED_DOMAIN）,多个扩展域名用逗号隔开；&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-size: ssl加密位数，默认2048；&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-cn: 国家代码(2个字母的代号),默认CN;&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; 使用示例:&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; ./create_self-signed-cert.sh --ssl-domain=www.test.com --ssl-trusted-domain=www.test2.com \ &#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; --ssl-trusted-ip=1.1.1.1,2.2.2.2,3.3.3.3 --ssl-size=2048 --ssl-date=3650&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span>  <span class="string">&#x27; ================================================================&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    -h|--<span class="built_in">help</span>) <span class="built_in">help</span>; <span class="built_in">exit</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$1</span> == <span class="string">&#x27;&#x27;</span> ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">help</span>;</span><br><span class="line">    <span class="built_in">exit</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">CMDOPTS=<span class="string">&quot;$*&quot;</span></span><br><span class="line"><span class="keyword">for</span> OPTS <span class="keyword">in</span> <span class="variable">$CMDOPTS</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    key=$(<span class="built_in">echo</span> <span class="variable">$&#123;OPTS&#125;</span> | awk -F<span class="string">&quot;=&quot;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> )</span><br><span class="line">    value=$(<span class="built_in">echo</span> <span class="variable">$&#123;OPTS&#125;</span> | awk -F<span class="string">&quot;=&quot;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> )</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$key</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        --ssl-domain) SSL_DOMAIN=<span class="variable">$value</span> ;;</span><br><span class="line">        --ssl-trusted-ip) SSL_TRUSTED_IP=<span class="variable">$value</span> ;;</span><br><span class="line">        --ssl-trusted-domain) SSL_TRUSTED_DOMAIN=<span class="variable">$value</span> ;;</span><br><span class="line">        --ssl-size) SSL_SIZE=<span class="variable">$value</span> ;;</span><br><span class="line">        --ssl-date) SSL_DATE=<span class="variable">$value</span> ;;</span><br><span class="line">        --ca-date) CA_DATE=<span class="variable">$value</span> ;;</span><br><span class="line">        --ssl-cn) CN=<span class="variable">$value</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CA相关配置</span></span><br><span class="line">CA_DATE=<span class="variable">$&#123;CA_DATE:-3650&#125;</span></span><br><span class="line">CA_KEY=<span class="variable">$&#123;CA_KEY:-cakey.pem&#125;</span></span><br><span class="line">CA_CERT=<span class="variable">$&#123;CA_CERT:-cacerts.pem&#125;</span></span><br><span class="line">CA_DOMAIN=cattle-ca</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssl相关配置</span></span><br><span class="line">SSL_CONFIG=<span class="variable">$&#123;SSL_CONFIG:-<span class="variable">$PWD</span>/openssl.cnf&#125;</span></span><br><span class="line">SSL_DOMAIN=<span class="variable">$&#123;SSL_DOMAIN:-&#x27;www.rancher.local&#x27;&#125;</span></span><br><span class="line">SSL_DATE=<span class="variable">$&#123;SSL_DATE:-3650&#125;</span></span><br><span class="line">SSL_SIZE=<span class="variable">$&#123;SSL_SIZE:-2048&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 国家代码(2个字母的代号),默认CN;</span></span><br><span class="line">CN=<span class="variable">$&#123;CN:-CN&#125;</span></span><br><span class="line"></span><br><span class="line">SSL_KEY=<span class="variable">$SSL_DOMAIN</span>.key</span><br><span class="line">SSL_CSR=<span class="variable">$SSL_DOMAIN</span>.csr</span><br><span class="line">SSL_CERT=<span class="variable">$SSL_DOMAIN</span>.crt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ---------------------------- \033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m       | 生成 SSL Cert |       \033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ---------------------------- \033[0m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -e ./<span class="variable">$&#123;CA_KEY&#125;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 1. 发现已存在CA私钥，备份&quot;</span><span class="variable">$&#123;CA_KEY&#125;</span><span class="string">&quot;为&quot;</span><span class="variable">$&#123;CA_KEY&#125;</span><span class="string">&quot;-bak，然后重新创建 \033[0m&quot;</span></span><br><span class="line">    <span class="built_in">mv</span> <span class="variable">$&#123;CA_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;CA_KEY&#125;</span>&quot;</span>-bak</span><br><span class="line">    openssl genrsa -out <span class="variable">$&#123;CA_KEY&#125;</span> <span class="variable">$&#123;SSL_SIZE&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 1. 生成新的CA私钥 <span class="variable">$&#123;CA_KEY&#125;</span> \033[0m&quot;</span></span><br><span class="line">    openssl genrsa -out <span class="variable">$&#123;CA_KEY&#125;</span> <span class="variable">$&#123;SSL_SIZE&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -e ./<span class="variable">$&#123;CA_CERT&#125;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 2. 发现已存在CA证书，先备份&quot;</span><span class="variable">$&#123;CA_CERT&#125;</span><span class="string">&quot;为&quot;</span><span class="variable">$&#123;CA_CERT&#125;</span><span class="string">&quot;-bak，然后重新创建 \033[0m&quot;</span></span><br><span class="line">    <span class="built_in">mv</span> <span class="variable">$&#123;CA_CERT&#125;</span> <span class="string">&quot;<span class="variable">$&#123;CA_CERT&#125;</span>&quot;</span>-bak</span><br><span class="line">    openssl req -x509 -sha256 -new -nodes -key <span class="variable">$&#123;CA_KEY&#125;</span> -days <span class="variable">$&#123;CA_DATE&#125;</span> -out <span class="variable">$&#123;CA_CERT&#125;</span> -subj <span class="string">&quot;/C=<span class="variable">$&#123;CN&#125;</span>/CN=<span class="variable">$&#123;CA_DOMAIN&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 2. 生成新的CA证书 <span class="variable">$&#123;CA_CERT&#125;</span> \033[0m&quot;</span></span><br><span class="line">    openssl req -x509 -sha256 -new -nodes -key <span class="variable">$&#123;CA_KEY&#125;</span> -days <span class="variable">$&#123;CA_DATE&#125;</span> -out <span class="variable">$&#123;CA_CERT&#125;</span> -subj <span class="string">&quot;/C=<span class="variable">$&#123;CN&#125;</span>/CN=<span class="variable">$&#123;CA_DOMAIN&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 3. 生成Openssl配置文件 <span class="variable">$&#123;SSL_CONFIG&#125;</span> \033[0m&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;SSL_CONFIG&#125;</span> &lt;&lt;<span class="string">EOM</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">[ v3_req ]</span></span><br><span class="line"><span class="string">basicConstraints = CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = clientAuth, serverAuth</span></span><br><span class="line"><span class="string">EOM</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="variable">$&#123;SSL_TRUSTED_IP&#125;</span> || -n <span class="variable">$&#123;SSL_TRUSTED_DOMAIN&#125;</span> || -n <span class="variable">$&#123;SSL_DOMAIN&#125;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &gt;&gt; <span class="variable">$&#123;SSL_CONFIG&#125;</span> &lt;&lt;<span class="string">EOM</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">EOM</span></span><br><span class="line">    IFS=<span class="string">&quot;,&quot;</span></span><br><span class="line">    dns=(<span class="variable">$&#123;SSL_TRUSTED_DOMAIN&#125;</span>)</span><br><span class="line">    dns+=(<span class="variable">$&#123;SSL_DOMAIN&#125;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!dns[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> DNS.$((i+<span class="number">1</span>)) = <span class="variable">$&#123;dns[$i]&#125;</span> &gt;&gt; <span class="variable">$&#123;SSL_CONFIG&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="variable">$&#123;SSL_TRUSTED_IP&#125;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        ip=(<span class="variable">$&#123;SSL_TRUSTED_IP&#125;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!ip[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> IP.$((i+<span class="number">1</span>)) = <span class="variable">$&#123;ip[$i]&#125;</span> &gt;&gt; <span class="variable">$&#123;SSL_CONFIG&#125;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 4. 生成服务SSL KEY <span class="variable">$&#123;SSL_KEY&#125;</span> \033[0m&quot;</span></span><br><span class="line">openssl genrsa -out <span class="variable">$&#123;SSL_KEY&#125;</span> <span class="variable">$&#123;SSL_SIZE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 5. 生成服务SSL CSR <span class="variable">$&#123;SSL_CSR&#125;</span> \033[0m&quot;</span></span><br><span class="line">openssl req -sha256 -new -key <span class="variable">$&#123;SSL_KEY&#125;</span> -out <span class="variable">$&#123;SSL_CSR&#125;</span> -subj <span class="string">&quot;/C=<span class="variable">$&#123;CN&#125;</span>/CN=<span class="variable">$&#123;SSL_DOMAIN&#125;</span>&quot;</span> -config <span class="variable">$&#123;SSL_CONFIG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 6. 生成服务SSL CERT <span class="variable">$&#123;SSL_CERT&#125;</span> \033[0m&quot;</span></span><br><span class="line">openssl x509 -sha256 -req -<span class="keyword">in</span> <span class="variable">$&#123;SSL_CSR&#125;</span> -CA <span class="variable">$&#123;CA_CERT&#125;</span> \</span><br><span class="line">    -CAkey <span class="variable">$&#123;CA_KEY&#125;</span> -CAcreateserial -out <span class="variable">$&#123;SSL_CERT&#125;</span> \</span><br><span class="line">    -days <span class="variable">$&#123;SSL_DATE&#125;</span> -extensions v3_req \</span><br><span class="line">    -extfile <span class="variable">$&#123;SSL_CONFIG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 7. 证书制作完成 \033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 8. 以YAML格式输出结果 \033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----------------------------------------------------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ca_key: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$CA_KEY</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ca_cert: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$CA_CERT</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ssl_key: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$SSL_KEY</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ssl_csr: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$SSL_CSR</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ssl_cert: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$SSL_CERT</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 9. 附加CA证书到Cert文件 \033[0m&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$&#123;CA_CERT&#125;</span> &gt;&gt; <span class="variable">$&#123;SSL_CERT&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ssl_cert: |&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$SSL_CERT</span> | sed <span class="string">&#x27;s/^/  /&#x27;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m ====&gt; 10. 重命名服务证书 \033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cp <span class="variable">$&#123;SSL_DOMAIN&#125;</span>.key tls.key&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;SSL_DOMAIN&#125;</span>.key tls.key</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cp <span class="variable">$&#123;SSL_DOMAIN&#125;</span>.crt tls.crt&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;SSL_DOMAIN&#125;</span>.crt tls.crt</span><br></pre></td></tr></table></figure><p><strong>执行脚本生成自签证书</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--ssl-domain: 生成ssl证书需要的主域名，如不指定则默认为www.rancher.local，如果是ip访问服务，则可忽略；</span><br><span class="line">--ssl-trusted-ip: 一般ssl证书只信任域名的访问请求，有时候需要使用ip去访问server，那么需要给ssl证书添加扩展IP，多个IP用逗号隔开；</span><br><span class="line">--ssl-trusted-domain: 如果想多个域名访问，则添加扩展域名（TRUSTED_DOMAIN）,多个TRUSTED_DOMAIN用逗号隔开；</span><br><span class="line">--ssl-size: ssl加密位数，默认2048；</span><br><span class="line">--ssl-cn: 国家代码(2个字母的代号),默认CN；</span><br><span class="line"><span class="comment"># 使用示例:</span></span><br><span class="line">./create_self-signed-cert.sh --ssl-domain=www.test.com --ssl-trusted-domain=www.test2.com \</span><br><span class="line">--ssl-trusted-ip=1.1.1.1,2.2.2.2,3.3.3.3 --ssl-size=2048 --ssl-date=3650</span><br><span class="line"></span><br><span class="line">./create_self-signed-cert.sh --ssl-domain=cloud.jfjbapp.cn --ssl-trusted-domain=cloud.jfjbapp.cn --ssl-trusted-ip=192.168.10.20,192.168.10.10 --ssl-size=2048 --ssl-date=36500</span><br></pre></td></tr></table></figure><blockquote><blockquote><p>注意: 申请证书对应的域名需要与 hostname 选项匹配，否则 ingress 将无法代理访问 Rancher。</p></blockquote></blockquote><p><strong>生成的证书文件</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/ziqianca.png" class="" title="执行结果"><h3 id="5-1-导入证书到集群">5.1 导入证书到集群</h3><p><a href="https://docs.rancher.cn/docs/rancher2.5/installation/resources/tls-secrets/_index/">添加 TLS 密文</a></p><p>只有当我们在 cattle-system 命名空间，将自签名证书和对应密钥配置到 tls-rancher-ingress 的密文中，Kubernetes 才会为 Rancher 创建所有的对象和服务。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cattle-system create secret tls tls-rancher-ingress \</span><br><span class="line">  --cert=tls.crt \</span><br><span class="line">  --key=tls.key</span><br></pre></td></tr></table></figure><p>如果您使用的是私有 CA，Rancher 需要您提供 CA 证书的副本，用来校验 Rancher Agent 与 Server 的连接。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cattle-system create secret generic tls-ca \</span><br><span class="line">  --from-file=cacerts.pem=./cacerts.pem</span><br></pre></td></tr></table></figure><h2 id="5-2-安装-Rancher">5.2 安装 Rancher</h2><p>这里注意选择 stable 版本，首先添加 heml 源仓库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span><br></pre></td></tr></table></figure><h3 id="5-3-部署-Rancher-并配置-SSL-数字证书">5.3 部署 Rancher 并配置 SSL 数字证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建命名空间</span></span><br><span class="line">kubectl create ns cattle-system</span><br><span class="line"></span><br><span class="line">helm install rancher-stable/rancher \</span><br><span class="line">  --name rancher \</span><br><span class="line">  --namespace cattle-system \</span><br><span class="line">  --<span class="built_in">set</span> hostname=cloud.jfjbapp.cn \</span><br><span class="line">  --version 2.2.2 \</span><br><span class="line">  --<span class="built_in">set</span> ingress.tls.source=secret \</span><br><span class="line">  --<span class="built_in">set</span> privateCA=<span class="literal">true</span>     <span class="comment"># 用于私有CA</span></span><br></pre></td></tr></table></figure><h3 id="5-4-检查-rancher-是否成功可用">5.4 检查 rancher 是否成功可用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cattle-system rollout status deploy/rancher</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;rancher&quot;</span> rollout to finish: 0 of 3 updated replicas are available...</span><br><span class="line">deployment <span class="string">&quot;rancher&quot;</span> successfully rolled out</span><br></pre></td></tr></table></figure><h3 id="5-5-为-Agent-Pod-添加主机别名-etc-hosts">5.5 为 Agent Pod 添加主机别名(/etc/hosts)</h3><p>通过 <code>kubectl --kubeconfig=xxx.yaml -n cattle-system get pod</code> 应该是可以看到 agent pod 一直无法正常运行，查看 agent pod 日志会发现是因为连接不上 rancher server url。</p><p><strong>解决方法</strong></p><p>可以通过给 <code>cattle-cluster-agent Pod</code> 和 <code>cattle-node-agent pod</code> 添加主机别名(/etc/hosts)，让其可以正常通过 Rancher Server URL 与 Rancher Server 通信(前提是 IP 地址可以互通)。</p><ul><li><p>cattle-cluster-agent pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=<span class="variable">$kubeconfig</span> -n cattle-system \</span><br><span class="line">patch deployments cattle-cluster-agent --patch <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;template&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;hostAliases&quot;: [</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                        &quot;hostnames&quot;:</span></span><br><span class="line"><span class="string">                        [</span></span><br><span class="line"><span class="string">                            &quot;cloud.jfjbapp.cn&quot;</span></span><br><span class="line"><span class="string">                        ],</span></span><br><span class="line"><span class="string">                            &quot;ip&quot;: &quot;192.168.10.20&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>cattle-node-agent pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=<span class="variable">$kubeconfig</span> -n cattle-system \</span><br><span class="line">patch  daemonsets cattle-node-agent --patch <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;template&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;hostAliases&quot;: [</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                        &quot;hostnames&quot;:</span></span><br><span class="line"><span class="string">                        [</span></span><br><span class="line"><span class="string">                            &quot;cloud.jfjbapp.cn&quot;</span></span><br><span class="line"><span class="string">                        ],</span></span><br><span class="line"><span class="string">                            &quot;ip&quot;: &quot;192.168.10.20&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5-6-访问-Rancher-UI">5.6 访问 Rancher UI</h3><p>浏览器打开 <a href="https://your.doamin">https://your.doamin</a>，为 admin账户设置初始密码，并登入系统。提示设置server-url，确保你的地址无误，确认即可。随后稍等皮片刻，待系统完成初始化。</p><p>如果出现local集群一直停留在等待状态，并提示 Waiting for server-url setting to be set，可以尝试点击 全局-&gt;local-&gt;升级-&gt;添加一个成员角色（admin/ClusterOwner）-&gt;保存即可。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/rancher2.2.2.png" class="" title="执行结果"><h2 id="6-结语">6 结语</h2><p>至此，已完成 Rancher 2.2.2 的 HA 安装，后续再做一些安全加固，检查各项配置确保无安全风险，即可开始提供服务。</p>]]></content>
      
      
      <categories>
          
          <category> rancher </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rancher </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubectl命令自动补全</title>
      <link href="/20220210/kubernetes-20220210-kubectl%E5%91%BD%E4%BB%A4%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8/"/>
      <url>/20220210/kubernetes-20220210-kubectl%E5%91%BD%E4%BB%A4%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source &lt;(helm completion bash)&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BiliBili视频下载工具</title>
      <link href="/20220208/tools-20220208-BiliBili%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7/"/>
      <url>/20220208/tools-20220208-BiliBili%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h1>项目地址</h1><p><a href="https://github.com/leiurayer/downkyi">github</a></p><p>下载完成之后，直接解压就可以使用😄<br>登录之后，打开设置，选择你下载视频的目录，其他保持默认就行。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220208/tools-20220208-BiliBili%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7/202110151046153.png" class="" title="执行结果"><p>回到主界面，输入你想要下载的视频地址，点击查询，解析视频之后，选中视频，点击下载选中项即可开始下载，可以看出，下载速度还是非常快的。</p><p>这款工具还是非常值得推荐👍。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220208/tools-20220208-BiliBili%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7/202110151046825.gif" class="" title="执行结果">]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker安装和加速</title>
      <link href="/20220119/docker-20220119-docker%E5%AE%89%E8%A3%85%E5%92%8C%E5%8A%A0%E9%80%9F/"/>
      <url>/20220119/docker-20220119-docker%E5%AE%89%E8%A3%85%E5%92%8C%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<h1>安装</h1><h2 id="Centos7">Centos7</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 3: 更新并安装Docker-CE</span></span><br><span class="line">sudo yum makecache fast</span><br><span class="line">sudo yum -y install docker-ce</span><br><span class="line"><span class="comment"># Step 4: 开启Docker服务</span></span><br><span class="line">sudo service docker start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：</span></span><br><span class="line"><span class="comment"># 官方软件源默认启用了最新的软件，您可以通过编辑软件源的方式获取各个版本的软件包。例如官方并没有将测试版本的软件源置为可用，您可以通过以下方式开启。同理可以开启各种测试版本等。</span></span><br><span class="line"><span class="comment"># vim /etc/yum.repos.d/docker-ee.repo</span></span><br><span class="line"><span class="comment">#   将[docker-ce-test]下方的enabled=0修改为enabled=1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># yum list docker-ce.x86_64 --showduplicates | sort -r</span></span><br><span class="line"><span class="comment">#   Loading mirror speeds from cached hostfile</span></span><br><span class="line"><span class="comment">#   Loaded plugins: branch, fastestmirror, langpacks</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="comment">#   Available Packages</span></span><br><span class="line"><span class="comment"># Step2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.0.ce.1-1.el7.centos)</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-[VERSION]</span></span><br></pre></td></tr></table></figure><h2 id="Ubuntu-14-04-16-04（使用-apt-get-进行安装）">Ubuntu 14.04/16.04（使用 apt-get 进行安装）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span></span><br><span class="line"><span class="comment"># sudo apt-get -y install docker-ce=[VERSION]</span></span><br></pre></td></tr></table></figure><h1>加速</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;, // 容器在运行时会产生大量日志文件，很容易占满磁盘空间。通过配置日志驱动来限制文件大小与文件的数量。 &gt;限制单个日志文件为100M,最多产生3个日志文件</span><br><span class="line">    <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;max-concurrent-uploads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://g4idqtjc.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>, // overlayFS是一个新一代的联合文件系统, 类似aufs, 但是更快实现更简单, refer: https://docs.docker.com/storage/storagedriver/overlayfs-driver/</span><br><span class="line">    <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.1.100&quot;</span>,<span class="string">&quot;IP:PORT&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4-桥接网络-热添加与热迁移</title>
      <link href="/20220111/kvm-20220111-4-%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C-%E7%83%AD%E6%B7%BB%E5%8A%A0%E4%B8%8E%E7%83%AD%E8%BF%81%E7%A7%BB/"/>
      <url>/20220111/kvm-20220111-4-%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C-%E7%83%AD%E6%B7%BB%E5%8A%A0%E4%B8%8E%E7%83%AD%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<h1>一 桥接网络</h1><h2 id="1：创建桥接网络">1：创建桥接网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh iface-bridge eth0 br0</span><br></pre></td></tr></table></figure><h2 id="2：基于桥接网络创建虚拟机">2：基于桥接网络创建虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web04 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 \</span><br><span class="line">--disk /opt/web04.qcow2,format=qcow2,size=10 \</span><br><span class="line">--boot hd \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure><h2 id="3：将已有的虚机修改为桥接网络">3：将已有的虚机修改为桥接网络</h2><ol><li><p>virsh edit web02<br>#修改以下位置<br><interface type='bridge'><br><mac address='52:54:00:55:aa:fa'/><br>&lt;source bridge='br0’/&gt;</p></li><li><p>修改虚拟机ip地址</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br></pre></td></tr></table></figure><p>然后通过vnc配置好虚拟机的IP地址,即可用其他机器通过ssh进行连接了</p><h1>二 热添加技术</h1><p>热添加技术就是不停机的情况下，在线热添加硬盘，内存，cpu，网卡等设备，热添加技术一般都是在虚拟机资源不够了，又不能停机的情况下使用的，热添加技术是虚拟机相对于物理机的一个很大的优势，它让资源分配变得更灵活！</p><h2 id="1：热添加硬盘">1：热添加硬盘</h2><p><strong>创建硬盘</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 web02-add01.qcow2 2G</span><br></pre></td></tr></table></figure><p><strong>热添加硬盘</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk web02 /opt/web02-add01.qcow2 vdb --live --cache=none --subdriver=qcow2</span><br></pre></td></tr></table></figure><h2 id="2：热添加网卡">2：热添加网卡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-interface web04 --<span class="built_in">type</span> bridge --model virtio --<span class="built_in">source</span> br0</span><br></pre></td></tr></table></figure><h2 id="3：热添加cpu">3：热添加cpu</h2><p><strong>安装参数</strong><br>需要在安装时有指定过maxvcpu参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm </span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web04 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1,maxvcpus=4 \</span><br><span class="line">--disk /opt/web04.qcow2,format=qcow2,size=10 \</span><br><span class="line">--boot hd \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure><p>热添加cpu<br><code>virsh setvcpus web04 --count=2</code></p><h2 id="4：热添加内存">4：热添加内存</h2><p><strong>安装参数</strong><br>需要在安装时指定过maxmenory参数]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web04 \</span><br><span class="line">--memory 512,maxmemory=2048 \</span><br><span class="line">--vcpus=1,maxvcpus=2 \</span><br><span class="line">--disk /opt/web04.qcow2,format=qcow2,size=10 \</span><br><span class="line">--boot hd \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--graphics vnc,listen=0.0.0.0  \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure><p>热添加内存<br><code>virsh setmem web04 1G</code></p><h1>三 kvm虚拟机的热迁移</h1><p>相比KVM虚拟机冷迁移中需要拷贝虚拟机虚拟磁盘文件，kvm虚拟机热迁移无需拷贝虚拟磁盘文件，但是需要迁移到的宿主机之间需要有相同的目录结构虚拟机磁盘文件，也就是共享存储.<br>这次通过大家熟悉的nfs来实现，当然也可以采用Glusterfs等分布式文件系统来实现.<br>博客:<a href="https://www.qstack.com.cn/archives/368.html">https://www.qstack.com.cn/archives/368.html</a></p><p><strong>步骤:</strong></p><ol><li>在kvm01和kvm02上安装kvm和nfs,配置桥接网卡</li><li>在nfs01上安装配置nfs</li><li>kvm01和kvm02挂载共享目录/opt</li><li>安装一台基于桥接模式的虚拟机</li><li>在kvm01上安装图形界面、vnc服务端和virt-manager</li><li>启动vnc服务端</li><li>使用vnc连接宿主机，使用virt-manager进行迁移</li></ol>]]></content>
      
      
      <categories>
          
          <category> kvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3-磁盘格式-快照和克隆</title>
      <link href="/20220111/kvm-20220111-3-%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F-%E5%BF%AB%E7%85%A7%E5%92%8C%E5%85%8B%E9%9A%86/"/>
      <url>/20220111/kvm-20220111-3-%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F-%E5%BF%AB%E7%85%A7%E5%92%8C%E5%85%8B%E9%9A%86/</url>
      
        <content type="html"><![CDATA[<h1>一 KVM磁盘格式</h1><h2 id="1-两种磁盘格式">1.两种磁盘格式</h2><ul><li>raw：<br>裸格式，占用空间比较大，不适合远程传输,不支持快照功能，性能较好</li><li>qcow2：<br>cow(copy on write)占用空间小，适合传输，支持快照，性能比raw差一点点</li></ul><h2 id="2-磁盘相关命令">2.磁盘相关命令</h2><ol><li>创建相应格式磁盘</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create          test.raw   1G</span><br><span class="line">qemu-img create -f qcow2 test.qcow2 1G</span><br></pre></td></tr></table></figure><ol start="2"><li>查看虚拟磁盘信息</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img info test.raw</span><br></pre></td></tr></table></figure><ol start="3"><li>调整虚拟磁盘容量大小</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img resize test.raw +1G</span><br></pre></td></tr></table></figure><ol start="4"><li>磁盘格式转换<br>会多出一份新格式文件,源文件保留</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -f raw -O qcow2  test.raw test2.qcow2</span><br><span class="line">[root@noah-tp opt]<span class="comment"># ll test* -h</span></span><br><span class="line">-rw-r--r--. 1 root root 193K Nov 14 22:45 test2.qcow2</span><br><span class="line">-rw-r--r--. 1 root root 193K Nov 14 22:42 test.qcow2</span><br><span class="line">-rw-r--r--. 1 root root 2.0G Nov 14 22:44 test.raw</span><br></pre></td></tr></table></figure><h2 id="3-实际操作演示">3.实际操作演示</h2><p>以修改centos7mb.raw为例</p><ol><li>停止虚拟机</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh shutdown centos7mb</span><br></pre></td></tr></table></figure><ol start="2"><li>转换虚拟机磁盘格式为qcow2</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -f raw -O qcow2 /opt/centos7-mb.raw /opt/centos7-mb.qcow2</span><br></pre></td></tr></table></figure><ol start="3"><li>手动修改虚拟机配置文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh edit centos7mb</span><br><span class="line"><span class="comment">##搜索disk,将driver name 和source file中的raw修改为qcow2</span></span><br><span class="line">  &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;     --&gt; &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos7-mb.raw&#x27;</span>/&gt; --&gt; &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos7-mb.qcow2&#x27;</span>/&gt;</span><br></pre></td></tr></table></figure><ol start="4"><li>重启虚拟机</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh start centos7mb</span><br></pre></td></tr></table></figure><h1>二 快照和克隆</h1><h2 id="1-虚拟机快照-qcow2格式">1.虚拟机快照[qcow2格式]</h2><p>只有qcow2格式的虚拟机能使用快照功能</p><ol><li>创建快照</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh snapshot-create centos7mb</span><br></pre></td></tr></table></figure><ol start="2"><li>查看快照</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh snapshot-list centos7mb</span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> 1542207368           2018-11-14 22:56:08 +0800 running</span><br><span class="line"> 1542207451           2018-11-14 22:57:31 +0800 running</span><br></pre></td></tr></table></figure><ol start="3"><li>还原快照</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh snapshot-revert centos7mb --snapshotname 1542207368</span><br></pre></td></tr></table></figure><ol start="4"><li>删除快照</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh snapshot-delete centos7mb --snapshotname 1542207368</span><br></pre></td></tr></table></figure><h2 id="2-虚拟机克隆">2.虚拟机克隆</h2><h3 id="1-完整克隆">1.完整克隆</h3><p>实现方法：virt-clone -o 源虚拟机名 -n 新虚拟机名 -f 新虚拟机磁盘文件名 --auto-clone</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-clone -o centos7mb -n web02 -f web02.qcow2 --auto-clone</span><br></pre></td></tr></table></figure><h3 id="2-链接克隆">2.链接克隆</h3><ol><li>创建回写文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 -b cetnos7mb.qcow2 web03.qcow2</span><br></pre></td></tr></table></figure><ol start="2"><li>以此回写文件创建虚拟机<br>通过<code>--boot hd</code>参数直接从硬盘启动的方式,加载别人已经做好的模板镜像,免去了从iso镜像安装的过程</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web03 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 \</span><br><span class="line">--disk /opt/web03.qcow2,format=qcow2,size=10 \</span><br><span class="line">--boot hd \</span><br><span class="line">--network network=default \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2-KVM日常管理命令</title>
      <link href="/20220111/kvm-20220111-2-KVM%E6%97%A5%E5%B8%B8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/"/>
      <url>/20220111/kvm-20220111-2-KVM%E6%97%A5%E5%B8%B8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h1>开关机与查看</h1><ol><li>列表显示<br><code>virsh list</code> 只会显示运行中的列表<br><code>virsh list --all</code> 显示所有虚拟机列表</li><li>开机start<br><code>virsh start centos7-mb</code></li><li>关机shutdown<br><code>virsh shutdown centos7-mb</code></li><li>强制关机destroy<br><code>virsh destroy centos7-mb</code></li><li>查询vnc端口号vncdisplay<br><code>virsh vncdisplay centos7-mb</code></li></ol><h1>配置管理</h1><ol><li><p>存放位置<br>kvm创建的虚拟机,配置文件存放在目录<code>/etc/libvirt/qemu/</code>中,配置文件以虚拟机+.xml结尾,如:<code>/etc/libvirt/qemu/ centos7-mb.xml</code></p></li><li><p>修改配置 edit<br><code>virsh edit centos7-mb</code></p></li><li><p>导出配置 dumpxml<br><code>virsh dumpxml centos7-mb &gt;/opt/centos7-mb.xml</code></p></li><li><p>删除镜像/配置 undefine<br><code>virsh undefine centos7-mb</code></p></li></ol><blockquote><p>如果要删除虚拟机,建议先关机[shutdown或destroy]，再删除<br>此命令只会删除配置文件,不会删除实际镜像,所以可以再导入备份的配置进行恢复</p></blockquote><ol start="5"><li>导入配置define<br><code>virsh define /opt/centos7-mb.xml</code></li></ol><h1>镜像管理</h1><ol><li>重命名 domrename<br><code>virsh domrename centos7-mb c7-mb</code></li></ol><blockquote><p>只会修改列表显示中的名字,不修改镜像文件的名字</p></blockquote><ol start="2"><li>挂起 suspend<br><code>virsh suspend c7-mb</code></li><li>恢复 resume<br><code>virsh resume c7-mb</code></li><li>开机启动autostart<br><code>virsh autostart c7-mb</code> 开机启动<br><code>virsh autostart --disable c7-mb</code> 取消开机启动<br>设置开机启动后,<code>/etc/libvirt/qemu/autostart/</code>目录下就会有一个软连接</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]<span class="comment"># ll /etc/libvirt/qemu/autostart/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx .......   c7-mb.xml -&gt; /etc/libvirt/qemu/c7-mb.xml</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1-KVM基础与快速部署</title>
      <link href="/20220111/kvm-20220111-1-KVM%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/"/>
      <url>/20220111/kvm-20220111-1-KVM%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1>一 虚拟化基础</h1><ol><li><p>什么是虚拟化<br>虚拟化就是通过模拟计算机硬件(cpu,内存，硬盘，网卡)来实现在一台物理服务器上运行同时多个不同的操作系统，并且使每个操作系统之间都是互相隔离的</p></li><li><p>什么是kvm虚拟化<br>目前国内的公有云底层采用的都是kvm虚拟化，经过这几年的快速发展，kvm计算已经非常成熟稳定，在任何linux发行版中，kvm都是标配，虚拟化已经成为了一项必备的技能</p></li></ol><h1>二 环境准备</h1><ol><li>主机规划</li></ol><table><thead><tr><th>主机名</th><th>IP地址</th><th>操作系统</th><th>内存</th><th>硬盘</th></tr></thead><tbody><tr><td>kvm01</td><td>10.0.0.11</td><td>centos7.4</td><td>4G</td><td>50G</td></tr></tbody></table><ol start="2"><li><p>上传模板并克隆<br>根据以前的标准模板克隆主机,克隆后按规划设置主机名,IP地址,并关闭selinux和firewalld</p></li><li><p>在window上安装TightVNC<br>tightvnc官网：<a href="http://www.tightvnc.com">http://www.tightvnc.com</a><br>vnc是一个跨平台的远程桌面软件，待会安装kvm虚拟机系统的时候使用</p></li><li><p>确定服务器支持虚拟化</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]<span class="comment"># cat /proc/cpuinfo | egrep -o &#x27;vmx|svm&#x27;</span></span><br><span class="line">vmx</span><br></pre></td></tr></table></figure><ol start="5"><li>上传centos7.4镜像</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /server/tools/ &amp;&amp; <span class="built_in">cd</span> /server/tools/</span><br><span class="line"><span class="comment">#然后上传镜像到本目录</span></span><br></pre></td></tr></table></figure><h1>三 快速部署</h1><h2 id="1-安装软件启动服务">1.安装软件启动服务</h2><ul><li>libvirt服务：管理kvm虚拟机的生命周期</li><li>virt-install工具：创建安装虚拟机</li><li>qemu-kvm工具：使用qemu-img为虚拟机提供硬盘</li></ul><h2 id="安装软件">安装软件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libvirt virt-install qemu-kvm -y</span><br></pre></td></tr></table></figure><h2 id="启动libvirtd服务">启动libvirtd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start libvirtd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> libvirtd.service</span><br></pre></td></tr></table></figure><h2 id="校验">校验</h2><p>kvm服务启动后,系统会多出一个<code>virbr0</code>的网卡,配置如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]<span class="comment"># ip addr show dev virbr0</span></span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:a7:ca:46 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h2 id="2-创建启动虚拟机">2.创建启动虚拟机</h2><p>建议虚拟机内存不要低于1024M，否则安装系统特别慢！</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name centos7-mb \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 \</span><br><span class="line">--disk /opt/centos7-mb.raw,format=raw,size=5 \</span><br><span class="line">--cdrom /server/tools/CentOS-7.4-x86_64-DVD-1708.iso \</span><br><span class="line">--network network=default \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure><h2 id="3-通过vnc安装系统">3.通过vnc安装系统</h2><p>qemu-kvm启动后默认监听5900端口,通过<code>virsh vncdisplay centos7-mb</code>命令显示该虚拟机的vnc端口号,结果是<code>:0</code>.<br>因此可以使用windows机器上的vnc客户端,使用<code>10.0.0.11:5900</code>连接虚拟机安装系统<br>如果vnc端口号是<code>:1</code>,则使用<code>10.0.0.11:5901</code><br>连接成功后,就按正常的安装步骤安装centos7</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220111/kvm-20220111-1-KVM%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/1558769107001.png" class="" title="vnc连接图例"><h1>四 console登录</h1><ol><li>VNC登录问题1<br>常规情况下，安装完 KVM 之后，可能都会通过 VNC 连接到 KVM 虚拟机里面去修改 IP 等信息。<br>但是一旦虚拟机比较多的话，打开过多的端口会造成安全问题</li><li>VNC登录问题2<br>很多时候，我们是通过跳板机连接的宿主机，window和kvm宿主机没有直达的路由，这时候vnc都用不了，如何快速进入到 KVM 虚拟机里面去排查问题呢？</li><li>解决办法:console登录<br>打开虚拟机的console以后,就可以在宿主机上直接连接虚拟机,包括启动过程都可以看得到,而不必等虚拟机启动好以后,才能用ssh连接</li></ol><h2 id="开启console登录">开启console登录</h2><p>以下开启操作都是需要进到虚拟机中操作的</p><ol><li>centos7</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --args=<span class="string">&quot;console=ttyS0,115200n8&quot;</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><ol start="2"><li>centos6<br>很麻烦,省略</li></ol><p>开启后,可以通过以下命令在宿主机上直接进入虚拟机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh console centos7mb</span><br></pre></td></tr></table></figure><blockquote><p>退出当前虚拟机的console界面命令:“ctrl + ]”</p></blockquote><h2 id="其他说明">其他说明</h2><p>可以直接使用官方已经做好的镜像,免去了安装步骤</p>]]></content>
      
      
      <categories>
          
          <category> kvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5-命令补全和资源限制</title>
      <link href="/20220111/docker-compose-20220111-5-%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8%E5%92%8C%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/"/>
      <url>/20220111/docker-compose-20220111-5-%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8%E5%92%8C%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1>1 命令补全</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o /etc/bash_completion.d/docker-compose \</span><br><span class="line">    https://raw.githubusercontent.com/docker/compose/$(docker-compose version --short)/contrib/completion/bash/docker-compose </span><br><span class="line"><span class="comment"># 下次登陆生效</span></span><br></pre></td></tr></table></figure><h1>2 资源限制</h1><p>docker-compose v3版本命令,可以使用deploy来做资源限制,如:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">image: flink:1.3.1</span><br><span class="line">deploy:</span><br><span class="line">  resources:</span><br><span class="line">    limits:</span><br><span class="line">      memory: 1G</span><br></pre></td></tr></table></figure><p>但是docker-compose up命令不支持资源限制参数,提示如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">....Compose does not support <span class="string">&#x27;deploy&#x27;</span> configuration - use `docker stack deploy` to deploy to a swarm</span><br></pre></td></tr></table></figure><p>这个时候可以使用<code>--compatibility</code>参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--compatibility             If <span class="built_in">set</span>, Compose will attempt to convert keys</span><br></pre></td></tr></table></figure><p>命令如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --compatibility up -d</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker-compose </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4-compose/stack/swarm集群</title>
      <link href="/20220110/docker-compose-20220110-4-compose-stack-swarm%E9%9B%86%E7%BE%A4/"/>
      <url>/20220110/docker-compose-20220110-4-compose-stack-swarm%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<h1>区别和联系</h1><p>docker-compose V3之后,设置资源限额和容器数量的配置,只能写在deploy字段里, 但是docker-compose up  却不支持 deploy 配置<br>编辑同一份docker-compose.yml, 但是compose 和 swarm/stack的分工是这样的:</p><blockquote><p>docker-compose   用于dev   支持build/restart  但是不支持deploy,<br>swarm/stack      用于 prod  支持 deply的各种设置,包括分配cpu和内存, 但是创建容器只支持从image,不支持build.</p></blockquote><h1>deploy扩缩容参数</h1><p>deploy是用于在docker集群环境下自动进行扩容和缩容的配置项,<code>docker-compose up</code> and <code>docker-compose run</code>两个命令会忽略此配置,只有<code>docker stack deploy</code>命令下才有用<br>有以下子选项</p><ol><li>endpoint_mode：集群对提供服务的方式<ul><li>endpoint_mode: vip VIP方式</li><li>endpoint_mode: dnsrr dns轮询方式</li></ul></li><li>labels：元数据（标签）</li><li>mode：设置容器模式(默认replicated)<ul><li>mode: global 全局模式,只能有一个容器</li><li>mode: replicated 复制模式,可以指定数量</li></ul></li><li>placement：定约束和首选项的配置</li><li>replicas：指定容器可运行的数量,需要(mode: replicated)</li><li>resources：资源约束,可约束cpu和内存,设置分配量和预留量<ul><li>limits:<ul><li>cpus: ‘0.50’</li><li>memory: 50M</li></ul></li><li>reservations:<ul><li>cpus: ‘0.25’</li><li>memory: 20M</li></ul></li></ul></li><li>restart_policy：重启策略<ul><li>condition:重启的条件(default: any)<ul><li>none 没有条件(不重启)</li><li>on-failure 故障情况下才重启</li><li>any 任何情况下都重启</li></ul></li><li>delay: 两次重启中的时间间隔(default: 0).</li><li>max_attempts: 尝试重启的次数(默认不限制)</li><li>window: 重启之前的等待时间(默认不等待)</li></ul></li><li>rollback_config：回滚配置<ul><li>parallelism: 一次回滚的容器数量,为0则1次回滚完</li><li>delay: 两次回滚间隔(default 0s).</li><li>failure_action: 回滚失败后的操作,继续或暂停(default pause)</li><li>monitor: 任务更新后的持续监测时间(ns|us|ms|s|m|h) (default 0s).</li><li>max_failure_ratio: 回滚期间的容错率(default 0).</li><li>order: 任务执行顺序(default stop-first).<ul><li>stop-first 旧任务在开始新任务之前停止</li><li>start-first 新任务首先启动，正在运行的任务暂停</li></ul></li></ul></li><li>update_config：更新配置<ul><li>parallelism: 一次要更新的容器数量</li><li>delay: 两次更新的时间间隔</li><li>failure_action: 更新失败后的操作,继续或暂停(default pause)</li><li>monitor: 任务更新后的持续监测时间(ns|us|ms|s|m|h) (default 0s).</li><li>max_failure_ratio: 更新期间的容错率(default 0).</li><li>order: 任务执行顺序(default stop-first).<ul><li>stop-first 旧任务在开始新任务之前停止</li><li>start-first 新任务首先启动，正在运行的任务暂停</li></ul></li></ul></li></ol><p>配置举例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">services:</span><br><span class="line">  redis:</span><br><span class="line">    image: redis:alpine</span><br><span class="line">    deploy:</span><br><span class="line">      mode: global</span><br><span class="line">      replicas: 6</span><br><span class="line">      endpoint_mode: dnsrr</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">      labels:</span><br><span class="line">        com.example.description: <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">      resources:</span><br><span class="line">        limits:</span><br><span class="line">          cpus: <span class="string">&#x27;0.50&#x27;</span></span><br><span class="line">          memory: 50M</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 2</span><br><span class="line">        delay: 10s</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker-compose </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3-docker-compose命令</title>
      <link href="/20220110/docker-compose-20220110-3-docker-compose%E5%91%BD%E4%BB%A4/"/>
      <url>/20220110/docker-compose-20220110-3-docker-compose%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h1>1，Docker-compose命令格式</h1><pre><code>    docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]</code></pre><p>命令选项如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-f --file FILE指定Compose模板文件，默认为docker-compose.yml</span><br><span class="line">-p --project-name NAME 指定项目名称，默认使用当前所在目录为项目名</span><br><span class="line">--verbose  输出更多调试信息</span><br><span class="line">-v，-version 打印版本并退出</span><br><span class="line">--log-level LEVEL 定义日志等级(DEBUG, INFO, WARNING, ERROR, CRITICAL)</span><br></pre></td></tr></table></figure><h1>2，docker-compose up</h1><pre><code>docker-compose up [options] [--scale SERVICE=NUM...] [SERVICE...]</code></pre><p>选项包括：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-d 在后台运行服务容器</span><br><span class="line">-no-color 不是有颜色来区分不同的服务的控制输出</span><br><span class="line">-no-deps 不启动服务所链接的容器</span><br><span class="line">--force-recreate 强制重新创建容器，不能与-no-recreate同时使用</span><br><span class="line">–no-recreate 如果容器已经存在，则不重新创建，不能与–force-recreate同时使用</span><br><span class="line">–no-build 不自动构建缺失的服务镜像</span><br><span class="line">–build 在启动容器前构建服务镜像</span><br><span class="line">–abort-on-container-exit 停止所有容器，如果任何一个容器被停止，不能与-d同时使用</span><br><span class="line">-t, –<span class="built_in">timeout</span> TIMEOUT 停止容器时候的超时（默认为10秒）</span><br><span class="line">–remove-orphans 删除服务中没有在compose文件中定义的容器</span><br></pre></td></tr></table></figure><h1>3，docker-compose ps</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose  ps [options] [SERVICE...]</span><br><span class="line">列出项目中所有的容器</span><br></pre></td></tr></table></figure><h1>4，docker-compose stop</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop [options] [SERVICE...]</span><br><span class="line">选项包括</span><br><span class="line">-t, –<span class="built_in">timeout</span> TIMEOUT 停止容器时候的超时（默认为10秒）</span><br><span class="line">docker-compose stop</span><br><span class="line">停止正在运行的容器，可以通过docker-compose start 再次启动</span><br></pre></td></tr></table></figure><h1>5，docker-compose -h</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -h</span><br><span class="line">查看帮助</span><br></pre></td></tr></table></figure><h1>6，docker-compose down</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down [options]</span><br><span class="line">停止和删除容器、网络、卷、镜像。</span><br><span class="line">选项包括：</span><br><span class="line">–rmi <span class="built_in">type</span>，删除镜像，类型必须是：all，删除compose文件中定义的所有镜像；<span class="built_in">local</span>，删除镜像名为空的镜像</span><br><span class="line">-v, –volumes，删除已经在compose文件中定义的和匿名的附在容器上的数据卷</span><br><span class="line">–remove-orphans，删除服务中没有在compose中定义的容器</span><br><span class="line">docker-compose down</span><br><span class="line">停用移除所有容器以及网络相关</span><br></pre></td></tr></table></figure><h1>7，docker-compose logs</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs [options] [SERVICE...]</span><br><span class="line">查看服务容器的输出。默认情况下，docker-compose将对不同的服务输出使用不同的颜色来区分。可以通过–no-color来关闭颜色。</span><br><span class="line">docker-compose logs</span><br><span class="line">查看服务容器的输出</span><br><span class="line">-f 跟踪日志输出</span><br></pre></td></tr></table></figure><h1>8，docker-compose bulid</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build [options] [--build-arg key=val...] [SERVICE...]</span><br><span class="line">构建（重新构建）项目中的服务容器。</span><br><span class="line">选项包括：</span><br><span class="line">–compress 通过gzip压缩构建上下环境</span><br><span class="line">–force-rm 删除构建过程中的临时容器</span><br><span class="line">–no-cache 构建镜像过程中不使用缓存</span><br><span class="line">–pull 始终尝试通过拉取操作来获取更新版本的镜像</span><br><span class="line">-m, –memory MEM为构建的容器设置内存大小</span><br><span class="line">–build-arg key=val为服务设置build-time变量</span><br><span class="line">服务容器一旦构建后，将会带上一个标记名。可以随时在项目目录下运行docker-compose build来重新构建服务</span><br></pre></td></tr></table></figure><h1>9，docker-compose pull</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose pull [options] [SERVICE...]</span><br><span class="line">拉取服务依赖的镜像。</span><br><span class="line">选项包括：</span><br><span class="line">–ignore-pull-failures，忽略拉取镜像过程中的错误</span><br><span class="line">–parallel，多个镜像同时拉取</span><br><span class="line">–quiet，拉取镜像过程中不打印进度信息</span><br><span class="line">docker-compose pull</span><br><span class="line">拉取服务依赖的镜像</span><br></pre></td></tr></table></figure><h1>10，docker-compose restart</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose restart [options] [SERVICE...]</span><br><span class="line">重启项目中的服务。</span><br><span class="line">选项包括：</span><br><span class="line">-t, –<span class="built_in">timeout</span> TIMEOUT，指定重启前停止容器的超时（默认为10秒）</span><br><span class="line">docker-compose restart</span><br><span class="line">重启项目中的服务</span><br></pre></td></tr></table></figure><h1>11，docker-compose rm</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">rm</span> [options] [SERVICE...]</span><br><span class="line">删除所有（停止状态的）服务容器。</span><br><span class="line">选项包括：</span><br><span class="line">–f, –force，强制直接删除，包括非停止状态的容器</span><br><span class="line">-v，删除容器所挂载的数据卷</span><br><span class="line">docker-compose <span class="built_in">rm</span></span><br><span class="line">删除所有（停止状态的）服务容器。推荐先执行docker-compose stop命令来停止容器。</span><br></pre></td></tr></table></figure><h1>12，docker-compose start</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose start [SERVICE...]</span><br><span class="line">docker-compose start</span><br><span class="line">启动已经存在的服务容器。</span><br></pre></td></tr></table></figure><h1>13，docker-compose run</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose run [options] [-v VOLUME...] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]</span><br><span class="line">在指定服务上执行一个命令。</span><br><span class="line">docker-compose run ubuntu ping www.baidu.com</span><br><span class="line">在指定容器上执行一个ping命令。</span><br></pre></td></tr></table></figure><h1>14，docker-compose scale</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose scale web=3 db=2</span><br><span class="line">设置指定服务运行的容器个数。通过service=num的参数来设置数量</span><br></pre></td></tr></table></figure><h1>15，docker-compose pause</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose pause [SERVICE...]</span><br><span class="line">暂停一个服务容器</span><br></pre></td></tr></table></figure><h1>16，docker-compose kill</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">kill</span> [options] [SERVICE...]</span><br><span class="line">通过发送SIGKILL信号来强制停止服务容器。</span><br><span class="line">支持通过-s参数来指定发送的信号，例如通过如下指令发送SIGINT信号：</span><br><span class="line">docker-compose <span class="built_in">kill</span> -s SIGINT</span><br></pre></td></tr></table></figure><h1>17，docker-compose config</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker-compose config [options]</span><br><span class="line">验证并查看compose文件配置。</span><br><span class="line">选项包括：</span><br><span class="line">–resolve-image-digests 将镜像标签标记为摘要</span><br><span class="line">-q, –quiet 只验证配置，不输出。 当配置正确时，不输出任何内容，当文件配置错误，输出错误信息</span><br><span class="line">–services 打印服务名，一行一个</span><br><span class="line">–volumes 打印数据卷名，一行一个</span><br></pre></td></tr></table></figure><h1>18，docker-compose create</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker-compose create [options] [SERVICE...]</span><br><span class="line">为服务创建容器。</span><br><span class="line">选项包括：</span><br><span class="line">–force-recreate：重新创建容器，即使配置和镜像没有改变，不兼容–no-recreate参数</span><br><span class="line">–no-recreate：如果容器已经存在，不需要重新创建，不兼容–force-recreate参数</span><br><span class="line">–no-build：不创建镜像，即使缺失</span><br><span class="line">–build：创建容器前　　，生成镜像</span><br></pre></td></tr></table></figure><h1>19，docker-compose exec</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> [options] SERVICE COMMAND [ARGS...]</span><br><span class="line">选项包括：</span><br><span class="line">-d 分离模式，后台运行命令。</span><br><span class="line">–privileged 获取特权。</span><br><span class="line">–user USER 指定运行的用户。</span><br><span class="line">-T 禁用分配TTY，默认docker-compose <span class="built_in">exec</span>分配TTY。</span><br><span class="line">–index=index，当一个服务拥有多个容器时，可通过该参数登陆到该服务下的任何服务，</span><br><span class="line">  例如：docker-compose <span class="built_in">exec</span> –index=1 web /bin/bash ，web服务中包含多个容器</span><br></pre></td></tr></table></figure><h1>20，docker-compose port</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose port [options] SERVICE PRIVATE_PORT</span><br><span class="line">显示某个容器端口所映射的公共端口。</span><br><span class="line">选项包括：</span><br><span class="line">–protocol=proto，指定端口协议，TCP（默认值）或者UDP</span><br><span class="line">–index=index，如果同意服务存在多个容器，指定命令对象容器的序号（默认为1）</span><br></pre></td></tr></table></figure><h1>21，docker-compose push</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose push [options] [SERVICE...]</span><br><span class="line">推送服务依的镜像。</span><br><span class="line">选项包括：</span><br><span class="line">–ignore-push-failures 忽略推送镜像过程中的错误</span><br></pre></td></tr></table></figure><h1>22，docker-compose top</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose top [options] [SERVICE...]</span><br><span class="line">显示各个容器运行的进程情况。</span><br></pre></td></tr></table></figure><h1>23，docker-compose uppause</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose unpause [SERVICE...]</span><br><span class="line">恢复处于暂停状态中的服务。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker-compose </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2-compose命令和yaml模板</title>
      <link href="/20220110/docker-compose-20220110-2-compose%E5%91%BD%E4%BB%A4%E5%92%8Cyaml%E6%A8%A1%E6%9D%BF/"/>
      <url>/20220110/docker-compose-20220110-2-compose%E5%91%BD%E4%BB%A4%E5%92%8Cyaml%E6%A8%A1%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<h1>一 compose命令和模板说明</h1><h2 id="A-compse命令列表说明">A. compse命令列表说明</h2><p>每个命令后后还有很多参数,具体的请用<code>--help</code>去查看</p><table><thead><tr><th>命令名</th><th>参数说明</th></tr></thead><tbody><tr><td>build</td><td>构建项目中的服务容器</td></tr><tr><td>images</td><td>列出所有镜像</td></tr><tr><td>kill</td><td>通过发送SIGKILL信号来强制停止服务容器</td></tr><tr><td>logs</td><td>查看服务器容器的输出</td></tr><tr><td>pause</td><td>暂停一个服务容器</td></tr><tr><td>port</td><td>打印某个容器的端口所映射的公共端口</td></tr><tr><td>ps</td><td>列出项目中目前的所有容器</td></tr><tr><td>pull</td><td>拉取服务依赖的镜像</td></tr><tr><td>push</td><td>推送服务依赖的镜像</td></tr><tr><td>restart</td><td>重启项目中的服务</td></tr><tr><td>rm</td><td>删除所有的服务器容器（停止状态的）</td></tr><tr><td>run</td><td>在指定服务上执行一个命令</td></tr><tr><td>scale</td><td>设置指定服务运行的容器个数</td></tr><tr><td>start</td><td>启动已经存在的服务容器</td></tr><tr><td>stop</td><td>停止已经处于运行状态的容器，但不删除它</td></tr><tr><td>top</td><td>展示运行的进程</td></tr><tr><td>unpause</td><td>恢复处于暂停状态中的服务</td></tr><tr><td>up</td><td>自动完成包括构建镜像、创建服务、启动服务并关联服务相关容器的一系列操作</td></tr></tbody></table><h2 id="B-Compose模板文件的说明">B. Compose模板文件的说明</h2><ol><li><a href="https://docs.docker.com/compose/compose-file/">compose模板文件官方文档</a></li><li>compose模板文件有三个版本,现在用第三版</li><li>模板文件可以使用的扩展名为.yml或.yaml</li><li>模板文件使用的yaml语法,用空格缩进不支持tab缩进<ul><li>结构通过空格来表示缩进,推荐2个空格,不支持tab</li><li>连续的项目通过减号-来表示,键值对用冒号:分割</li><li>每个散列项(键值对k: v)冒号和值之间至少有一个空格</li></ul></li><li>模板有4个顶级的配置项,顶级配置项包含非常多的子项:<ul><li>version 定义版本信息</li><li>services 定义服务的配置信息,类似docker container create</li><li>networks 定义网络,给 给容器使用,类似docker network create</li><li>volumes 定义卷,给具体容器使用,类似docker volume create</li></ul></li></ol><blockquote><p>定义卷和定义网络这两个顶级配置,定义的东西都是为了让容器可以用的</p></blockquote><h1>二 services普通选项说明</h1><p>以下仅仅讨论常用的配置指令</p><h2 id="A-container-name容器名">A. container_name容器名</h2><p>容器名默认将会使用(项目名称_服务名称_序号)的格式,如果使用container_name,可以指定该容器的名称.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  webapp:</span><br><span class="line">    container_name: web01</span><br></pre></td></tr></table></figure><blockquote><p>注意: 指定容器名称后，该服务将无法进行扩展(scale)，因为Docker不允许多个容器具有相同的名称。</p></blockquote><h2 id="B-labels标签信息">B. labels标签信息</h2><p>为容器添加 Docker 元数据(metadata)信息。例如可以为容器添加辅助说明信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    labels:</span><br><span class="line">      com.startupteam.description: <span class="string">&quot;webapp for a startup team&quot;</span></span><br><span class="line">      com.startupteam.department: <span class="string">&quot;devops department&quot;</span></span><br><span class="line">      com.startupteam.release: <span class="string">&quot;rc3 for v1.0&quot;</span></span><br></pre></td></tr></table></figure><h2 id="C-command容器启动命令">C. command容器启动命令</h2><p>使用 command 可以覆盖容器启动后默认执行的命令,支持shell和exec格式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    <span class="built_in">command</span>: bundle <span class="built_in">exec</span> thin -p 3000</span><br><span class="line">    <span class="built_in">command</span>: [bundle, <span class="built_in">exec</span>, thin, -p, 3000]</span><br></pre></td></tr></table></figure><h2 id="D-depends-on依赖关系">D. depends_on依赖关系</h2><p>解决容器的依赖、启动先后的问题,注意不要弄错循环依赖了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br></pre></td></tr></table></figure><blockquote><p>注意web服务不会等待db[完全启动]之后才启动。</p></blockquote><h2 id="E-environment和env-file环境变量">E. environment和env_file环境变量</h2><p>environment可设置环境变量,可以使用数组或字典两种格式。<br>如果只给定变量名不赋值,会自动获取运行 Compose 主机上对应变量的值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    environment:</span><br><span class="line">      RACK_ENV: development</span><br><span class="line">      SESSION_SECRET:</span><br><span class="line">    environment:</span><br><span class="line">      - RACK_ENV=development</span><br><span class="line">      - SESSION_SECRET</span><br></pre></td></tr></table></figure><p>如果变量名称或者值中用到 true|false| 等布尔含义的词汇，需要放到引号里，包括</p><pre><code>    y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF</code></pre><p>env_file可从文件中获取环境变量，可以指定一个文件路径或路径列表，其优先级低于 environment 指定的环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    env_file: .<span class="built_in">env</span></span><br><span class="line">    ---------------</span><br><span class="line">    env_file:</span><br><span class="line">      - ./common.env</span><br></pre></td></tr></table></figure><h2 id="F-expose和ports端口">F. expose和ports端口</h2><ol><li>expose向容器暴露端口<br>仅暴露端口，但不映射到宿主机，只被连接的服务访问,可以指定容器内部的端口为参数</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">&quot;3000&quot;</span></span><br><span class="line">      - <span class="string">&quot;8000&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ports端口映射<br><strong>宿主端口：容器端口</strong>(即：HOST:CONTAINER)的格式格式，或者仅仅指定容器的端口(宿主将会随机选择端口)。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000&quot;</span></span><br><span class="line">      - <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">      - <span class="string">&quot;49100:22&quot;</span></span><br><span class="line">      - <span class="string">&quot;127.0.0.1:8001:8001&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>数字串都采用引号包括起来的字符串格式。</p></blockquote><h2 id="G-extra-hosts主机名映射">G. extra_hosts主机名映射</h2><p>类似 Docker 中的–add-host参数，指定额外的host名称映射信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    extra_hosts:</span><br><span class="line">      - <span class="string">&quot;googledns:8.8.8.8&quot;</span></span><br><span class="line">      - <span class="string">&quot;dockerhub:52.1.157.61&quot;</span></span><br></pre></td></tr></table></figure><p>会在启动后的服务容器中/etc/hosts文件中添加IP地址与主机名的映射记录。</p><h2 id="H-healthcheck健康检查">H. healthcheck健康检查</h2><p>通过命令检查容器是否健康运行,需要设置测试的命令,间隔时间,超时时间,判断次数等</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  ......</span><br><span class="line">  healthcheck:</span><br><span class="line">    <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost&quot;</span>]</span><br><span class="line">    interval: 1m30s</span><br><span class="line">    <span class="built_in">timeout</span>: 10s</span><br><span class="line">    retries: 3</span><br></pre></td></tr></table></figure><h2 id="I-logging日志">I. logging日志</h2><p>配置日志选项,指定日志驱动和该驱动下可用的选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">services:</span><br><span class="line">  some-service:</span><br><span class="line">    image: some-service</span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;200k&quot;</span></span><br><span class="line">        max-file: <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure><p>目前支持三种日志驱动类型。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">driver: <span class="string">&quot;syslog&quot;</span></span><br><span class="line">driver: <span class="string">&quot;none&quot;</span></span><br></pre></td></tr></table></figure><p>options 配置日志驱动的相关参数。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options:</span><br><span class="line">  max-size: <span class="string">&quot;200k&quot;</span></span><br><span class="line">  max-file: <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure><h2 id="J-DNS和dns-search">J DNS和dns_search</h2><ol><li>dns：配置 dns 服务器，可以是一个值或列表</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    dns: 8.8.8.8</span><br><span class="line">    ------------</span><br><span class="line">    dns:</span><br><span class="line">      - 8.8.8.8</span><br><span class="line">      - 9.9.9.9</span><br></pre></td></tr></table></figure><ol start="2"><li>dns_search：配置 DNS 搜索域，可以是一个值或列表</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    dns_search: example.com</span><br><span class="line">    ------------------------</span><br><span class="line">    dns_search:</span><br><span class="line">      - dc1.example.com</span><br><span class="line">      - dc2.example.com</span><br></pre></td></tr></table></figure><h1>四 build和image镜像设置</h1><p>每个服务都必须要有 <code>image</code> 或 <code>build</code> 指令二者之一</p><h2 id="A-单独bulid指令">A. 单独bulid指令</h2><p>指定 Dockerfile 所在文件夹的绝对或相对路径。 Compose 将会利用它自动构建和使用这个镜像。类似于命令行的 docker build .</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    build: ./dir</span><br><span class="line">[1-docker-compose快速入门](1-docker-compose%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.md)</span><br></pre></td></tr></table></figure><p>也可以使用 context 指令指定 Dockerfile 所在文件夹的路径,同时使用 dockerfile 指令指定 Dockerfile 文件名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    build:</span><br><span class="line">      context: ./dir</span><br><span class="line">      dockerfile: Dockerfile-alternate</span><br></pre></td></tr></table></figure><h2 id="B-单独image指令">B. 单独image指令</h2><p>指定为镜像名称或镜像 ID。如果镜像不存在将会尝试拉取这个镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    image: ubuntu</span><br><span class="line">    image: orchardup/postgresql</span><br><span class="line">    image: a4bc65fd</span><br></pre></td></tr></table></figure><h2 id="C-同时使用image和build">C. 同时使用image和build</h2><p>如果同时指定了 image和 build，Compose 会使用 build指令中指定的 Dockerfile构建的镜像，镜像名称使用 image中指定的名字<code>webapp:tag</code>命名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    build: ./dir</span><br><span class="line">    image: webapp:tag</span><br></pre></td></tr></table></figure><h1>五 volumes的配置说明</h1><p>volumes可以直接使用目录挂载,也可以先创建volume卷,然后用卷名进行挂载,其实就是docker挂载目录,文件,容器管理卷等操作</p><h2 id="A-直接挂载目录">A. 直接挂载目录</h2><p>可以设置宿主机路径 (HOST:CONTAINER) 或加上访问模式 (HOST:CONTAINER:ro)。<br>有长短两种格式,短格式就直接是源:目的,长格式需要写出每一项的属性</p><ol><li>短格式示例</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    volumes:</span><br><span class="line">      - /var/lib/mysql</span><br><span class="line">      - cache/:/tmp/cache</span><br><span class="line">      - ~/configs:/etc/configs/:ro</span><br></pre></td></tr></table></figure><ol start="2"><li>长格式示例</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="built_in">type</span>: volume</span><br><span class="line">        <span class="built_in">source</span>: mydata</span><br><span class="line">        target: /data</span><br><span class="line">        volume:</span><br><span class="line">          nocopy: <span class="literal">true</span></span><br><span class="line">      - <span class="built_in">type</span>: <span class="built_in">bind</span></span><br><span class="line">        <span class="built_in">source</span>: ./static</span><br><span class="line">        target: /opt/app/static</span><br></pre></td></tr></table></figure><h2 id="B-容器卷方式挂载">B. 容器卷方式挂载</h2><p>需要用顶级配置项<code>volumes</code>先创建卷,然后容器中直接使用卷名进行挂载,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  mysql:</span><br><span class="line">services:</span><br><span class="line">  mysql:  </span><br><span class="line">    image: mysql</span><br><span class="line">    container_name: mysql</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql:/var/lib/mysql</span><br></pre></td></tr></table></figure><h2 id="C-长格式的所有参数">C. 长格式的所有参数</h2><ul><li><code>type</code>: 挂载的类型.有[volume|bind|tmpfs]</li><li><code>source</code>: 挂载的源、目录或卷名-file/#volume-configuration-reference). Not applicable for a tmpfs mount.</li><li><code>target</code>: 挂载到容器中的目的地</li><li><code>read_only</code>: 设置为只读</li><li><code>bind</code>: 配置附加的绑定选项<ul><li><code>propagation</code>: 绑定使用的传播模式</li></ul></li><li>volume: 配置附加的卷选项<ul><li><code>nocopy</code>: 创建卷时禁用从容器复制数据</li></ul></li><li><code>tmpfs</code>: 配置附加的tmpfs选项<ul><li><code>size</code>: tmpfs挂载的大小</li></ul></li></ul><h2 id="D-顶级配置项中的volumes">D. 顶级配置项中的volumes</h2><p>volumes不仅可以是容器卷,也支持通过driver插件的方法支持其他类型的存储</p><ol><li>driver_opts指定其他类型存储</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">volumes:</span><br><span class="line">  example:</span><br><span class="line">    driver_opts:</span><br><span class="line">      <span class="built_in">type</span>: <span class="string">&quot;nfs&quot;</span></span><br><span class="line">      o: <span class="string">&quot;addr=10.40.0.199,nolock,soft,rw&quot;</span></span><br><span class="line">      device: <span class="string">&quot;:/docker/example&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>external设置扩展信息<br>默认compose会创建卷data,但如果指定该参数为true,则只会寻找已有的data卷来使用,而不会创建</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  xxxapp:</span><br><span class="line">volumes:</span><br><span class="line">  data:</span><br><span class="line">    external: <span class="literal">true</span></span><br></pre></td></tr></table></figure><ol start="3"><li>labels和name<br>labels设置卷的元数据信息(标签),name设置源的指定名字,而不让卷被compose自动命名</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">volumes:</span><br><span class="line">  data:</span><br><span class="line">    external: <span class="literal">true</span></span><br><span class="line">    name: my-app-data</span><br><span class="line">    labels:</span><br><span class="line">      - <span class="string">&quot;com.example.description=Database volume&quot;</span></span><br><span class="line">      - <span class="string">&quot;com.example.department=IT/Ops&quot;</span></span><br></pre></td></tr></table></figure><h1>六 networks网络配置</h1><p>设置要加入的网络，需要使用顶级<code>networks</code> 定义下的条目 。</p><h2 id="A-service中的networds">A. service中的networds</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  some-service:</span><br><span class="line">    networks:</span><br><span class="line">     - some-network</span><br><span class="line">     - other-network</span><br><span class="line">networks:</span><br><span class="line">  some-network:</span><br><span class="line">  other-network:</span><br></pre></td></tr></table></figure><ol><li>网络的alias别名<br>设置此服务的别名(备用主机名)。同一网络上的其他容器可以使用此别名连接容器。<br>由于aliases是网络范围的，因此相同的服务可以在不同的网络上具有不同的别名。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  some-service:</span><br><span class="line">    networks:</span><br><span class="line">      some-network:</span><br><span class="line">        aliases:</span><br><span class="line">          - alias1</span><br><span class="line">          - alias3</span><br><span class="line">      other-network:</span><br><span class="line">        aliases:</span><br><span class="line">          - alias2</span><br></pre></td></tr></table></figure><ol start="2"><li>指定IP地址<br>默认都是自动分配的ip地址,但也可以手动指定,但顶级网络配置部分中对应的网络配置必须有一个ipam块才行。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">services:</span><br><span class="line">  app:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    networks:</span><br><span class="line">      app_net:</span><br><span class="line">        ipv4_address: 172.16.238.10</span><br><span class="line">        ipv6_address: 2001:3984:3989::10</span><br><span class="line">networks:</span><br><span class="line">  app_net:</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: <span class="string">&quot;172.16.238.0/24&quot;</span></span><br><span class="line">        - subnet: <span class="string">&quot;2001:3984:3989::/64&quot;</span></span><br></pre></td></tr></table></figure><h2 id="B-顶级模块中的networks">B. 顶级模块中的networks</h2><ol><li>driver网络驱动<br>与docker引擎配置有关,默认情况下单机是bridge,多机是overlay,当然还支持其他网络(如host,none等),差异很大,略过</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line">  mynet1:</span><br><span class="line">    driver: overlay</span><br></pre></td></tr></table></figure><ol start="2"><li>driver_opts传输参数<br>给对应的驱动传输相应的参数,驱动不同参数差异很大,简单举例</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line">  mynet1:</span><br><span class="line">    driver_opts:</span><br><span class="line">      foo: <span class="string">&quot;bar&quot;</span></span><br><span class="line">      baz: 1</span><br></pre></td></tr></table></figure><ol start="3"><li>attachable是否允许附加<br>当网络为overlay是才能用,用途是允许该网络被此项目外的其他独立容器使用</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line">  mynet1:</span><br><span class="line">    driver: overlay</span><br><span class="line">    attachable: <span class="literal">true</span></span><br></pre></td></tr></table></figure><ol start="4"><li>ipam配置IP地址信息</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line">  mynet1:</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 172.28.0.0/16</span><br></pre></td></tr></table></figure><ol start="5"><li>name和external<br>name设置网络名,external设置使用已创建好的网络,而不是自己创建</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">networks:</span><br><span class="line">  network1:</span><br><span class="line">    external: <span class="literal">true</span></span><br><span class="line">    name: my-app-net</span><br></pre></td></tr></table></figure><h1>八 关于容器的限制的参数</h1><h2 id="A-sysctls内核参数控制">A. sysctls内核参数控制</h2><p>配置容器内核参数。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  some-service:</span><br><span class="line">    sysctls:</span><br><span class="line">      net.core.somaxconn: 1024</span><br><span class="line">      net.ipv4.tcp_syncookies: 0</span><br><span class="line">    sysctls:</span><br><span class="line">      - net.core.somaxconn=1024</span><br><span class="line">      - net.ipv4.tcp_syncookies=0</span><br></pre></td></tr></table></figure><h2 id="B-ulimits进程和句柄数控制">B. ulimits进程和句柄数控制</h2><p>指定容器的 ulimits 限制值。<br>例如，指定最大进程数为 65535，指定文件句柄数为 20000(软限制，应用可以随时修改，不能超过硬限制) 和 40000(系统硬限制，只能 root 用户提高)。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  some-service:</span><br><span class="line">    ulimits:</span><br><span class="line">      <span class="built_in">nproc</span>: 65535</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 20000</span><br><span class="line">        hard: 40000</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker-compose </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1-docker-compose快速入门</title>
      <link href="/20220110/docker-compose-20220110-1-docker-compose%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
      <url>/20220110/docker-compose-20220110-1-docker-compose%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h1>一 docker-compose的简介</h1><p>docker-compose是dokcer官方的单机编排工具，让用户通过编写一个简单的模板文件，快速地创建和管理基于docker容器的应用集群。实现对docker容器集群的快速编排。<br>允许用户通过一个单独的docker-compose.yml模板文件（YAML格式）来定义一组相关联的应用容器作为一个项目（project）</p><h2 id="A-Compose2个重要概念：">A. Compose2个重要概念：</h2><ol><li>服务（service）<br>一个应用的容器，实际上可以包含若干运行相同镜像的容器实例。</li><li>项目（project）<br>由一组关联的应用容器组成的一个完整业务单元，在docker-compose.yml文件中定义。</li></ol><h2 id="B-使用Compose的三步骤：">B. 使用Compose的三步骤：</h2><ol><li>Dockerfile 定义应用的运行环境</li><li>docker-compose.yml 定义组成应用的各服务</li><li>docker-compose up 启动整个应用</li></ol><h2 id="C-docker-compose命令与模板文件">C. docker-compose命令与模板文件</h2><ol><li>docker-compose命令<br>对于Compose来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或容器。默认针对项目</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br><span class="line">-f  指定使用的Compose模板文件，默认为docker-compose.yml,可多次指定                   </span><br><span class="line">-p  指定项目名称，默认将使用所在目录名称作为项目名  </span><br><span class="line">-x-network-driver DRIVER指定网络后端的驱动，默认为bridge</span><br></pre></td></tr></table></figure><ol start="2"><li>compose的yml模板<br>docker-compose.yml文件是compose的模板文件默认文件名,使用docker-compose时,会通过该模板文件构建镜像、启动容器、关联容器等<br>Docker Compose 运行目录下的所有文件（docker-compose.yml）组成一个工程,一个工程包含多个服务，每个服务中定义了容器运行的镜像、参数、依赖，一个服务可包括多个容器实例<br>模板文件类似dockerfile,但命令更多,命令详情见模板文件详解</li></ol><h1>二 docker-compose安装</h1><p>Compose项目是用Python语言编写的，所以compose可以通过python的pip工具进行安装。安装过程如下：</p><h2 id="A-pip在线安装法">A. pip在线安装法</h2><ol><li>安装更新pip</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum install -y python-pip</span><br><span class="line">pip install --upgrade pip  -i https://pypi.douban.com/simple/</span><br></pre></td></tr></table></figure><ol start="2"><li>pip安装docker-compose</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose -i https://pypi.douban.com/simple/</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker-compose version</span></span><br><span class="line">docker-compose version 1.24.0, build 0aa5906</span><br><span class="line">docker-py version: 3.7.2</span><br><span class="line">CPython version: 2.7.5</span><br><span class="line">OpenSSL version: OpenSSL 1.0.1e-fips 11 Feb 2013</span><br></pre></td></tr></table></figure><h2 id="B-github脚本安装法">B. github脚本安装法</h2><p>可以直接下载docker官方存放在GitHub上的程序,然后授权启动即可,这样做的好处是可以控制下载指定的版本使用,而第一种方法默认会下载最新版</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /usr/local/bin/docker-compose \</span><br><span class="line">  https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(<span class="built_in">uname</span> -s)-$(<span class="built_in">uname</span> -m)</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><h1>三 Compose编排快速使用</h1><h2 id="A-简单编排演示">A. 简单编排演示</h2><ol><li>创建目录及模板文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /test/www -p &amp;&amp; <span class="built_in">cd</span> /test/</span><br><span class="line"><span class="built_in">cat</span> &gt;docker-compose.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">version: &quot;3&quot;</span></span><br><span class="line"><span class="string">volumes:</span></span><br><span class="line"><span class="string">  web:</span></span><br><span class="line"><span class="string">services:</span></span><br><span class="line"><span class="string">  web-ser1:</span></span><br><span class="line"><span class="string">    image: busybox:latest</span></span><br><span class="line"><span class="string">    command: httpd -h /test/ -p 80 -f</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - web:/test/</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - &quot;81:80&quot;</span></span><br><span class="line"><span class="string">  web-ser2:</span></span><br><span class="line"><span class="string">    image: busybox:latest</span></span><br><span class="line"><span class="string">    command: httpd -h /test/ -p 80 -f</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - /test/www/:/test/</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - &quot;82:80&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ol start="2"><li>启动项目并写入测试文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;linux file test pag&#x27;</span> &gt; /test/www/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;docker-volumes test pags&#x27;</span> &gt;/var/lib/docker/volumes/test_web/_data/index.html</span><br></pre></td></tr></table></figure><ol start="3"><li>验证功能</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 <span class="built_in">test</span>]<span class="comment"># curl 127.0.0.1:81</span></span><br><span class="line">docker-volumes <span class="built_in">test</span> pags</span><br><span class="line">[root@docker01 <span class="built_in">test</span>]<span class="comment"># curl 127.0.0.1:82</span></span><br><span class="line">linux file <span class="built_in">test</span> pag</span><br></pre></td></tr></table></figure><h2 id="B-该模板功能解释">B. 该模板功能解释</h2><p>该模板做了一下几件事:</p><ol><li>目录为test,所以项目名就是test</li><li>compose模板有3个语法版本,使用第3版</li><li>创建一个卷web,会自动加上项目名为test_web</li><li>创建第一个容器web-ser1,全名test_web-ser1_1<ul><li>用busybox做镜像,将docker卷web挂载到/test/</li><li>启动简易httpd服务,映射端口81:80</li></ul></li><li>创建第二个容器web-ser2,全名test_web-ser2_1<ul><li>用busybox做镜像,将指定目录挂载到/test/</li><li>启动简易httpd服务,映射端口82:80</li></ul></li></ol><p>可以通过docker相关命令验证是是否有创建相关的卷</p><ol><li>验证volume</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 <span class="built_in">test</span>]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               test_web</span><br><span class="line">[root@docker02 <span class="built_in">test</span>]<span class="comment"># docker volume inspect test_web|grep data</span></span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/test_web/_data&quot;</span>,</span><br></pre></td></tr></table></figure><ol start="2"><li>验证容器</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 <span class="built_in">test</span>]<span class="comment"># docker container ls</span></span><br><span class="line">CONTAINER ID  IMAGE           COMMAND                  CREATED         STATUS         PORTS               NAMES</span><br><span class="line">f378003a21d3  busybox:latest  <span class="string">&quot;httpd -h /test/ -p …&quot;</span>   23 minutes ago  Up 23 minutes  0.0.0.0:82-&gt;80/tcp  test_web-ser2_1</span><br><span class="line">47ca927c1abd  busybox:latest  <span class="string">&quot;httpd -h /test/ -p …&quot;</span>   23 minutes ago  Up 23 minutes  0.0.0.0:81-&gt;80/tcp  test_web-ser1_1</span><br><span class="line">[root@docker02 <span class="built_in">test</span>]<span class="comment"># docker container inspect test_web-ser1_1 |grep -A5 Mounts</span></span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test_web&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/test_web/_data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/test&quot;</span>,</span><br><span class="line">[root@docker02 <span class="built_in">test</span>]<span class="comment"># docker container inspect test_web-ser2_1 |grep -A4 Mounts</span></span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/test/www&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/test&quot;</span>,</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker-compose </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7-docker容器的网络通信</title>
      <link href="/20220110/docker-20220110-7-docker%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/"/>
      <url>/20220110/docker-20220110-7-docker%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h1>一 容器网络的类型</h1><p>Docker 网络从覆盖范围可分为单个 host 上的容器网络和跨多个 host 的网络,多host网络又分为原生网络和第三方网络,如下:</p><ul><li>原生单机网络<ul><li>None：不为容器配置任何网络功能,–net=none</li><li>Host：与主机共享Network Namespace,–net=host</li><li>Container：与另一个运行中的容器共享网络名称空间,–net=container:ID</li><li>Bridge：Docker设计的,默认的NAT网络模型,–net=bridge</li></ul></li><li>原生多机网络<ul><li>overlay：基于vxlan的隧道网络</li><li>macvlan：基于网卡虚拟化的大局域网</li></ul></li><li>第三方多机网络[本章不讨论]<ul><li>flannel</li><li>weave</li><li>calico</li></ul></li></ul><blockquote><p>原生网络和单机网络都是通过不同的driver来实现的,未来可能还会有更多的开源driver</p></blockquote><h1>二 原生单机网络</h1><p>docker安装好后,默认会创建三个网络,分别是none,host和bridge,用docker network ls命令查看如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID       NAME      DRIVER     SCOPE</span><br><span class="line">3cb9e3ca4456     bridge    bridge     <span class="built_in">local</span></span><br><span class="line">4cc3166d4351     host      host       <span class="built_in">local</span></span><br><span class="line">f61ddbb4efdf     none      null       <span class="built_in">local</span></span><br></pre></td></tr></table></figure><h2 id="A-none网络">A. none网络</h2><p>none 网络就是什么都没有的网络。挂在这个网络下的容器除了 lo，没有其他任何网卡。容器创建时，可以通过 --network=none 指定使用 none 网络。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span> --network=none centos:6.9 </span><br><span class="line">[root@5fa702165cb2 /]<span class="comment"># ifconfig</span></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br></pre></td></tr></table></figure><p>封闭意味着隔离，一些对安全性要求高并且不需要联网的应用可以使用 none 网络。<br>比如某个容器的唯一用途是生成随机密码，就可以放到 none 网络中避免密码被窃取。</p><h2 id="B-host网络">B. host网络</h2><p>连接到 host 网络的容器共享 Docker host 的网络栈，容器的网络配置与 host 完全一样。可以通过 <code>--network=host</code> 指定使用 host 网络。<br>在容器中可以看到 host 的所有网卡，并且连 hostname 也是 host 的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span> --network=host busybox</span><br><span class="line">/ <span class="comment"># hostname</span></span><br><span class="line">docker01</span><br><span class="line">/ <span class="comment"># ip l|egrep ^[1-9]|awk &#x27;&#123;print $1,$2&#125;&#x27;</span></span><br><span class="line">1: lo:</span><br><span class="line">2: eth0:</span><br><span class="line">3: docker0:</span><br><span class="line">9: vethccf4863@if8:</span><br></pre></td></tr></table></figure><p>Docker host 的网络最大的好处就是性能，如果容器对网络传输效率有较高要求，可以选择 host 网络,但要考虑端口冲突问题<br>另一个用途是让容器可以直接配置 host 网路。如某些跨 host 的网络解决方案，本身也是以容器方式运行的，需要对网络进行配置，比如管理 iptables</p><h2 id="C-Container网络">C. Container网络</h2><p>container网络严格来说并不是一种网络类型,因为它只是让一个容器使用主容器的网络名称空间,主容器的网络是什么类型都不影响</p><ol><li>创建主容器并查看网卡信息</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name bbx --<span class="built_in">rm</span> busybox <span class="built_in">sleep</span> 900</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker exec -it bbx ip a|egrep  eth0|awk &#x27;&#123;print $1,$2&#125;&#x27;</span></span><br><span class="line">34: eth0@if35:</span><br><span class="line">inet 172.17.0.2/16</span><br></pre></td></tr></table></figure><ol start="2"><li>创建新容器并使用主容器网络</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker run --network=container:bbx busybox ip a|grep eth0|awk &#x27;&#123;print $1,$2&#125;&#x27;</span></span><br><span class="line">34: eth0@if35:</span><br><span class="line">inet 172.17.0.2/16</span><br></pre></td></tr></table></figure><ol start="3"><li>用途说明<br>可以明显看出来,上诉两个容器使用的是同一个网卡,其他整个网络名称空间用的都是一个,用这种方式组织的容器,容器间通信十分便捷,效率也很高</li></ol><h1>三 bridge 网络</h1><h2 id="A-bridge网络入门解释">A. bridge网络入门解释</h2><p>如果不指定<code>--network</code>，创建的容器默认都会挂到 <code>docker0</code> 上,docker0是安装时创建的linux bridge网络(可以理解为NAT),可以用linux管理bridge的命令进行查看和管理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install bridge-utils</span><br><span class="line">docker container <span class="built_in">rm</span> -f `docker container <span class="built_in">ls</span> -a -q`</span><br><span class="line">[root@docker01 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge namebridge <span class="built_in">id</span>    STP enabled    interfaces</span><br><span class="line">docker08000.024277f99a61no</span><br></pre></td></tr></table></figure><p>可以看到网桥docker0的信息,可以把docker0理解为一个虚拟交换机,现在这个交换机上没有接设备,我们启动一个容器看看结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name bbx --<span class="built_in">rm</span> busybox <span class="built_in">sleep</span> 900</span><br><span class="line">[root@docker01 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge namebridge <span class="built_in">id</span>    STP enabled    interfaces</span><br><span class="line">docker08000.024277f99a61no        veth0652c67</span><br></pre></td></tr></table></figure><p>交换机docker0已近连接了虚拟接口对(veth pair)的接口veth0652c67,该虚拟接口对的另一个接口连接到了刚刚新建的容器bbx中</p><blockquote><p>veth pair 是一种成对出现的特殊网络设备，可以想象成由一根虚拟网线连接起来的一对网卡，网卡的一头在容器中，另一头挂在网桥 docker0 上</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># ip a|grep veth0652c67|awk &#x27;&#123;print $1,$2&#125;&#x27;</span></span><br><span class="line">33: veth0652c67@if32:</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker exec -it bbx sh</span></span><br><span class="line">/ <span class="comment"># ip a|grep eth0|awk &#x27;&#123;print $1,$2&#125;&#x27;</span></span><br><span class="line">32: eth0@if33: </span><br><span class="line">[root@docker01 ~]<span class="comment"># docker network inspect bridge |grep -A1 Subnet</span></span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br></pre></td></tr></table></figure><p><strong>上面代码解释说明:</strong></p><ul><li>docker主机中多了一块网卡,编号33,名称veth0652c67,对端网卡编号if32</li><li>bbx容器中有一个网卡,编号32,名称eth0,对端网卡边哈if33,正好是一对</li><li>默认分配的IP地址段是172.17.0.0/16,网关IP就是docker0的IP</li></ul><h2 id="B-bridge网络自定义">B. bridge网络自定义</h2><p>默认的bridge网络是自动创建的,已有的信息不能修改,但docker支持自定义新的bridge网络,子网段、网关、是否自动分配等都可以自定义</p><ol><li>创建简单的自定义bridge网络</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge noah_net</span><br><span class="line">[root@docker01 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name        bridge <span class="built_in">id</span>STP enabled    interfaces</span><br><span class="line">br-a83f1d0be49e8000.0242e25e18d4            no</span><br><span class="line">docker0        8000.024277f99a61            no</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker network inspect noah_net |grep -A1 Subnet</span></span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.18.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.18.0.1&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>创建自定义网段的bridge网络</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge \</span><br><span class="line">  --subnet 192.168.4.0/24 \</span><br><span class="line">  --gateway 192.168.4.1 \</span><br><span class="line">  noah_net2</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker network inspect noah_net2 |grep -A1 Subnet</span></span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.4.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.4.1&quot;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>使用自定义网络创建容器<br>以上两个自定义网络创建好以后,创建容器时只要指定–network=xxx,就可以使用新的bridge网络了.<br>使用<code>--subnet</code>创建的网络,还可以通过–ip手动分配IP,非<code>--subnet</code>参数创建的网络不能手动分配IP,会报错</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker run -it --rm --network=noah_net busybox ip addr|grep &quot;172&quot;</span></span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker run -it --rm --network=noah-net2 --ip 192.168.4.99 busybox ip addr|grep &quot;192&quot;</span></span><br><span class="line">    inet 192.168.4.99/24 brd 192.168.4.255 scope global eth0</span><br></pre></td></tr></table></figure><h2 id="C-bridge网络之间通信">C. bridge网络之间通信</h2><p>先说结论:</p><ul><li>相同bridge网络下的容器互相之间可以通过IP通信</li><li>不同bridge网络下的容器互相之间不能通过IP通信</li><li>不同bridge网络之间不能通过添加路由解决通信问题</li><li>iptables DROP 掉了不同bridge网络间的通信</li></ul><p>基于以上原因,要解决不同bridge网络之间的通信问题,常用的解决办法就是为容器配置多个bridge的网卡,通过docker network connect 命令实现。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name bbx1 --network=noah_net busybox <span class="built_in">sleep</span> 900</span><br><span class="line">docker network connect noah-net2 bbx1</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker exec -it bbx1 ip a|grep inet</span></span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0</span><br><span class="line">    inet 192.168.4.2/24 brd 192.168.4.255 scope global eth1</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker exec -it bbx1 ping -c1 192.168.4.1</span></span><br><span class="line">PING 192.168.4.1 (192.168.4.1): 56 data bytes</span><br><span class="line">64 bytes from 192.168.4.1: <span class="built_in">seq</span>=0 ttl=64 time=0.192 ms</span><br></pre></td></tr></table></figure><h1>四 macvlan网络</h1><h2 id="A-什么是macvlan：">A. 什么是macvlan：</h2><p>macvlan 本质上是一种网卡虚拟化技术<br>macvlan 本身是 linux kernel 模块，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP。</p><p>使用macvlan可以实现容器跨主机通信：</p><h2 id="B-创建macvlan：">B. 创建macvlan：</h2><p>首先需要再开一台虚拟机,创建好docker环境,然后两台机器都执行下列命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver macvlan </span><br><span class="line">  --subnet 10.0.0.0/24 </span><br><span class="line">  --gateway 10.0.0.254 </span><br><span class="line">  -o parent=eth0   macvlan_1</span><br></pre></td></tr></table></figure><blockquote><p>说明:docker不会为macvlan创建网关,所以这里的网关要事先存在<br>macvlan最好自己手动管理IP地址,不要自动分配,容易IP冲突</p></blockquote><p>两台docker主机上分别创建容器测试：</p><ol><li>docker01：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.111 busybox:latest /bin/sh</span><br></pre></td></tr></table></figure><ol start="2"><li>docker02：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.112 busybox:latest /bin/sh</span><br></pre></td></tr></table></figure><h1>五 overlay网络</h1><p>overlay网络是基于 VxLAN 的 隧道网络,VxLAN 可将二层数据封装到 UDP 进行传输，VxLAN 提供与 VLAN 相同的以太网二层服务，但是拥有更强的扩展性和灵活性。<br>不同overlay网络是互相隔离的,要相互通信的话,也是需要把容器加入多个网络才行.<br>Docerk overlay 网络需要一个 key-value 数据库用于保存网络状态信息，包括 Network、Endpoint、IP 等。Consul、Etcd 和 ZooKeeper 都支持，这里使用 Consul。</p><h2 id="A-环境准备工作">A. 环境准备工作</h2><ol><li>分别修改docker配置文件<br>docker01、02上都增加如下配置在daemon.json文件中</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cluster-store&quot;</span>: <span class="string">&quot;consul://10.0.0.11:8500&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster-advertise&quot;</span>: <span class="string">&quot;10.0.0.12:2376&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker </span><br><span class="line"><span class="comment"># cluster-store是consul的地址</span></span><br><span class="line"><span class="comment"># cluster-advertise是自己的地址</span></span><br></pre></td></tr></table></figure><ol start="2"><li>docker01上运行consul</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap</span><br></pre></td></tr></table></figure><p>运行成功后,可以访问consul的web页:<a href="http://10.0.0.11:8500/ui/#/dc1/kv/">http://10.0.0.11:8500/ui/#/dc1/kv/</a></p><h2 id="B-overlay网络功能测试">B. overlay网络功能测试</h2><ol><li>创建overlay网络(任意主机)<br>由于overlay信息会写入数据库,所以在docker02上创建overlay网络,docker01上是可以看到的</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]<span class="comment"># docker network create -d overlay olay-1</span></span><br><span class="line">[root@docker01 ~]<span class="comment"># docker network ls|grep olay-1</span></span><br><span class="line">bda0ae8345d8        olay-1      overlay       global</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker network inspect olay-1|grep -A1 Subnet</span></span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;10.0.1.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;10.0.1.1&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>启动容器测试</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker run --rm --network olay-1 busybox ip a s|grep inet</span></span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet 10.0.1.2/24 brd 10.0.1.255 scope global eth0</span><br><span class="line">    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth1</span><br><span class="line">[root@docker02 ~]<span class="comment"># docker run --rm --network olay-1 busybox ip a s|grep inet</span></span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet 10.0.1.2/24 brd 10.0.1.255 scope global eth0</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span><br></pre></td></tr></table></figure><ol start="3"><li>测试结果说明<br>上面的结果中,每个容器都分别有eth0和eth1两个网卡,其中eth0属于overlay网络,用于跨主机通信,eth1用于与宿主机通信<br>overlay网络支持docker dns server,支持使用容器名进行通信</li></ol><h2 id="C-overlay-IPAM">C. overlay IPAM</h2><p>docker 默认为 overlay 网络分配 24 位掩码的子网（10.0.X.0/24），所有主机共享这个 subnet，容器启动时会顺序从此空间分配 IP。当然我们也可以通过<code>--subnet</code>指定 IP 空间。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d overlay --subnet 10.22.1.0/24 ov_net3</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6-docker镜像仓库和标签tag</title>
      <link href="/20220110/docker-20220110-6-docker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%92%8C%E6%A0%87%E7%AD%BEtag/"/>
      <url>/20220110/docker-20220110-6-docker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%92%8C%E6%A0%87%E7%AD%BEtag/</url>
      
        <content type="html"><![CDATA[<h1>一 docker仓库和镜像tag</h1><h2 id="A-docker仓库分类">A. docker仓库分类</h2><p>docker镜像是需要放到一个统一的仓库的,以便不同的主机可以下载和使用相同的镜像而不必每次都用dockerfile自己做,docker镜像仓库按如下方式划分</p><ol><li>公共仓库<ul><li>官方公共仓库<ul><li>docker hub</li></ul></li><li>第三方公共仓库<ul><li>阿里云</li><li>七牛云</li><li>DaoCloud</li><li>时速云</li></ul></li></ul></li><li>私有仓库<ul><li>官方命令行仓库:registry</li><li>第三方web仓库:harbor</li></ul></li></ol><h2 id="B-docker镜像tag命名规范">B. docker镜像tag命名规范</h2><p>在基础知识部分,介绍了标准镜像名由四部分组成: <strong>仓库地址/项目名/镜像名:标签</strong>,如 <code>daocloud.io/library/nginx:latest</code><br>一个高效的版本命名方案可以让用户清楚地知道当前使用的是哪个镜像，同时还可以保持足够的灵活性。<br>每个镜像可以有多个 tag，而多个 tag 可能对应的是同一个镜像。下面介绍 Docker 社区普遍使用的 tag 方案。</p><ol><li>初始版本<code>v1.9.1</code><br>镜像名为myimage，当前需要的版本为 v1.9.1。那么可以给镜像打上四个 tag：1、1.9、1.9.1和 latest。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag myimage-v1.9.1 myimage:1</span><br><span class="line">docker tag myimage-v1.9.1 myimage:1.9</span><br><span class="line">docker tag myimage-v1.9.1 myimage:1.9.1</span><br><span class="line">docker tag myimage-v1.9.1 myimage:latest</span><br></pre></td></tr></table></figure><ol start="2"><li>小版本更新<code>v1.9.2</code><br>过了一段时间，发布了 v1.9.2。这时可以打上 1.9.2 的 tag，并将1、1.9和 latest 从 v1.9.1 移到 v1.9.2。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag myimage-v1.9.2 myimage:1</span><br><span class="line">docker tag myimage-v1.9.2 myimage:1.9</span><br><span class="line">docker tag myimage-v1.9.2 myimage:1.9.2</span><br><span class="line">docker tag myimage-v1.9.2 myimage:latest</span><br></pre></td></tr></table></figure><ol start="3"><li>大版本更新<br>之后，v2.0.1 发布了。这时可以打上2、2.0、2.0.1的tag，并将 latest 移到 v2.0.1。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag myimage-v2.0.1 myimage:2</span><br><span class="line">docker tag myimage-v2.0.1 myimage:2.0</span><br><span class="line">docker tag myimage-v2.0.1 myimage:2.0.1</span><br><span class="line">docker tag myimage-v2.0.1 myimage:latest</span><br></pre></td></tr></table></figure><ol start="4"><li>tag方法有点总结<br>myimage:1 始终指向 1 这个分支中最新的镜像。<br>myimage:1.9 始终指向 1.9.x 中最新的镜像。<br>myimage:latest 始终指向所有版本中最新的镜像。<br>如果想使用特定版本，可以选择 myimage:1.9.1、myimage:1.9.2 或 myimage:2.0.1。</li></ol><blockquote><p>Docker Hub 上很多 repository 都采用这种方案，要熟练使用。</p></blockquote><h1>二 公共仓库docker hub</h1><p>docker hub是docker官方提供的的公共镜像仓库,类似于代码仓库github,需要注册.<br>官方地址：<a href="https://hub.docker.com/">https://hub.docker.com/</a><br>本人账号：luoxiaogang<br>账号密码：隐藏<br>私有仓库：c7-nginx</p><h2 id="A-修改镜像名">A. 修改镜像名</h2><p>修改镜像名,使其符合docker hub命名规范</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker image tag c7-nginx:v2  luoxiaogang/c7-nginx:v2</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker image ls luoxiaogang/c7-nginx</span></span><br><span class="line">REPOSITORY             TAG       IMAGE ID        CREATED       SIZE</span><br><span class="line">luoxiaogang/c7-nginx   v2        669691018aa6    5 days ago    789MB</span><br></pre></td></tr></table></figure><h2 id="B-登录docker-hub">B. 登录docker hub</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker login -u luoxiaogang</span></span><br><span class="line">Password: </span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure><h2 id="C-推送镜像">C. 推送镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker push luoxiaogang/c7-nginx</span></span><br><span class="line">The push refers to repository [docker.io/luoxiaogang/c7-nginx]</span><br><span class="line">fd2fdb015cf0: Pushed </span><br><span class="line">7912ce70bbc0: Pushed </span><br><span class="line">2de8d3b18deb: Pushed </span><br><span class="line">f903e5a29540: Pushed </span><br><span class="line">228f6119c990: Pushed </span><br><span class="line">54470def7538: Pushed </span><br><span class="line">d69483a6face: Pushed </span><br><span class="line">v2: digest: sha256:12843dfd....6 size: 1782</span><br></pre></td></tr></table></figure><h1>三 私有仓库(命令行)</h1><h2 id="A-公共操作-添加信任仓库">A. 公共操作-添加信任仓库</h2><p>需要添加信任的原因是docker默认需要使用https的安全连接来下载镜像,而我们自己搭建的环境只有http,所以需要信任该地址.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://registry.docker-cn.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.11:5000&quot;</span>,<span class="string">&quot;10.0.0.11:5001&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="B-无密码认证的私有仓库">B. 无密码认证的私有仓库</h2><ol><li>运行docker仓库</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always  -v /opt/myregistry:/var/lib/registry  registry</span><br></pre></td></tr></table></figure><ol start="2"><li>修改tag并推送</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker image tag c7-nginx:v2 10.0.0.11:5000/c7-nginx:v2</span><br><span class="line">docker push 10.0.0.11:5000/c7-nginx</span><br></pre></td></tr></table></figure><h2 id="C-带密码认证的私有仓库">C. 带密码认证的私有仓库</h2><ol><li>base认证密码文件准备</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools -y</span><br><span class="line"><span class="built_in">mkdir</span> /opt/registry-var/auth/ -p</span><br><span class="line">htpasswd  -Bbn luogang 123456  &gt;&gt; /opt/registry-var/auth/htpasswd</span><br></pre></td></tr></table></figure><ol start="2"><li>启动docker私有仓库</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5001:5000 -v /opt/registry-var/auth/:/auth/ \</span><br><span class="line">-v /opt/myregistry:/var/lib/registry \</span><br><span class="line">-e <span class="string">&quot;REGISTRY_AUTH=htpasswd&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span> \</span><br><span class="line">-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">registry</span><br></pre></td></tr></table></figure><ol start="3"><li>登录docker仓库</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login 10.0.0.11:5001 -u luogang</span><br></pre></td></tr></table></figure><ol start="4"><li>修改tag并推送</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker image tag c7-nginx:v2 10.0.0.11:5001/c7-nginx:v2</span><br><span class="line">docker push 10.0.0.11:5001/c7-nginx</span><br></pre></td></tr></table></figure><h1>四 私有仓库(harbor)</h1><p>企业级私有仓库harbor需要用到docker的单机编排工具docker-compose,所以这里仅列出步骤,等学过后便的docker-compose工具后,在单独写harbor的部署</p><ol><li>安装docker和docker-compose</li><li>下载harbor</li><li>修改harbor.cfg配置文件</li><li>执行安装脚本</li></ol><p>参考链接:<a href="https://www.cnblogs.com/pangguoping/p/7650014.html">https://www.cnblogs.com/pangguoping/p/7650014.html</a></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5-docker镜像构建</title>
      <link href="/20220110/docker-20220110-5-docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/"/>
      <url>/20220110/docker-20220110-5-docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>一 docker镜像构建说明</h1><h2 id="A-两种构建方式">A. 两种构建方式</h2><ol><li>手动构建docker镜像</li><li>自动构建docker镜像[dockerfile]</li></ol><h2 id="B-构建步骤">B. 构建步骤</h2><ul><li>手工构建步骤<ol><li>启动容器安装软件服务</li><li>将安装好服务的容器commit提交为镜像</li><li>启动新容器来测试新提交的镜像</li></ol></li><li>自动构建步骤<ol><li>编写dockerfile文件</li><li>通过build命令使用该dockerfile构建镜像</li><li>启动新容器来测试新提交的镜像</li></ol></li></ul><h2 id="C-dockerfile命令集">C. dockerfile命令集</h2><table><thead><tr><th>指令</th><th>功能</th><th>特殊说明</th></tr></thead><tbody><tr><td>FROM</td><td>指定基础镜像</td><td>必须有</td></tr><tr><td>MAINTAINER</td><td>指定维护者信息</td><td>可以没有</td></tr><tr><td>ENV</td><td>设置环境变量</td><td>可被后面的指令使用</td></tr><tr><td>COPY</td><td>复制文件到容器</td><td></td></tr><tr><td>ADD</td><td>复制文件到容器</td><td>压缩文件会自动解压</td></tr><tr><td>WORKDIR</td><td>设置当前工作目录</td><td>类似linux的cd命令</td></tr><tr><td>VOLUME</td><td>设置卷，挂载主机目录</td><td>需’-v’配合</td></tr><tr><td>EXPOSE</td><td>指定对外的端口</td><td>默认不暴露,需&quot;-P&quot;配合</td></tr><tr><td>RUN</td><td>运行指定的命令</td><td>在用于容器创建过程中执行命令</td></tr><tr><td>CMD</td><td>容器启动后执行的命令</td><td>容易被替换</td></tr><tr><td>ENTRYPOINT</td><td>容器启动后执行的命令</td><td>无法被替换</td></tr></tbody></table><p><a href="https://www.cnblogs.com/CloudMan6/p/6875834.html">两种命令方式以及run,cmd,ENTRYPOINT的关系说明</a></p><h1>二 手动构建docker镜像</h1><p>案例以cnetos6.9为基础镜像,制作含有nginx的镜像</p><h2 id="A-环境准备">A. 环境准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container <span class="built_in">rm</span> `docker container <span class="built_in">ls</span> -q -a`</span><br><span class="line">docker volume <span class="built_in">rm</span> `docker volume <span class="built_in">ls</span> -q`</span><br><span class="line">docker run -it --name noah-nginx centos:7.4</span><br></pre></td></tr></table></figure><h2 id="B-在容器中执行操作">B. 在容器中执行操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> /etc/yum.repos.d/* -f</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum install -y nginx</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;this nginx test pag&#x27;</span> &gt;/usr/share/nginx/html/index.html</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="C-打包为新镜像conmit">C. 打包为新镜像<code>conmit</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker commit noah-nginx c7-nginx:v1</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker image ls c7-nginx</span></span><br><span class="line">REPOSITORY  TAG   IMAGE ID        CREATED          SIZE</span><br><span class="line">c7-nginx    v1    f823aff3828d    39 seconds ago   388MB</span><br></pre></td></tr></table></figure><h2 id="D-以新镜像创建容器">D. 以新镜像创建容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nginx-test -p 880:80 c7-nginx:v1 nginx -g <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:880</span></span><br><span class="line">this nginx <span class="built_in">test</span> pag</span><br></pre></td></tr></table></figure><p>已经通过自己手动构建的镜像创建了新容器,并且成功运行和访问</p><h1>三 自动构建docker镜像[dockerfile]</h1><p>相对于手动制作的docker镜像，使用dockerfile构建的镜像有以下优点：</p><ol><li>dockerfile只有几kb，便于传输</li><li>使用dockerfile构建出来的镜像，在运行容器的时候，不用指定容器的初始命令</li><li>支持更多的自定义操作</li></ol><p>接下来通过dockerfile构建一个nginx镜像</p><h2 id="A-环境准备-2">A. 环境准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker container <span class="built_in">rm</span> `docker container <span class="built_in">ls</span> -q -a`</span><br><span class="line">docker volume <span class="built_in">rm</span> `docker volume <span class="built_in">ls</span> -q`</span><br><span class="line"><span class="built_in">mkdir</span>  -p /data/docker-file/c7-nginx/</span><br><span class="line"><span class="built_in">cd</span>  /data/docker-file/c7-nginx/</span><br></pre></td></tr></table></figure><h2 id="B-编写dockerfile镜像">B. 编写dockerfile镜像</h2><p><strong>1.编写dockerfile</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM   centos:7.4</span></span><br><span class="line"><span class="string">RUN    rm -f /etc/yum.repos.d/*.repo</span></span><br><span class="line"><span class="string">RUN    curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="string">RUN    curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line"><span class="string">RUN    yum clean all &amp;&amp; yum makecache</span></span><br><span class="line"><span class="string">RUN    yum install -y nginx</span></span><br><span class="line"><span class="string">RUN    echo &#x27;this nginx test pag&#x27; &gt;/usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="string">CMD    nginx -g &quot;daemon off;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>2.docker build构建镜像</strong><br><code>docker build -t c7-nginx:v2 .</code></p><p><strong>3.启动新容器来测试新构建的镜像</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nginx-test -p 980:80 c7-nginx:v2 nginx -g <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:980</span></span><br><span class="line">this nginx <span class="built_in">test</span> pag</span><br></pre></td></tr></table></figure><h1>四 CMD|ENTRYPOINT和两种格式</h1><p>RUN、CMD 和 ENTRYPOINT 这三个 Dockerfile 指令看上去很类似，很容易混淆。简单的说他们的区别：</p><ol><li>RUN 执行命令并创建新的镜像层，RUN 经常用于安装软件包。</li><li>CMD 设置容器启动后默认执行的命令及其参数.<br>但 CMD 能够被 docker run 后面跟的命令行参数替换。</li><li>ENTRYPOINT 配置容器启动时运行的命令。</li><li>都可以使用两种命令格式:Shell 和 Exec</li></ol><h2 id="A-Shell-和-Exec-命令格式">A. Shell 和 Exec 命令格式</h2><p>可用两种方式指定 RUN、CMD 和 ENTRYPOINT 要运行的命令：Shell 格式和 Exec 格式<br><strong>CMD 和 ENTRYPOINT 推荐使用 Exec 格式</strong>，因为指令可读性更强，更容易理解。RUN 则两种格式都可以。</p><ol><li>两种格式语法<ul><li>hell 格式: <code>&lt;instruction&gt; &lt;command&gt;</code></li></ul></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN apt-get install python3  </span><br><span class="line">CMD <span class="built_in">echo</span> <span class="string">&quot;Hello world&quot;</span>  </span><br><span class="line">ENTRYPOINT <span class="built_in">echo</span> <span class="string">&quot;Hello world&quot;</span></span><br></pre></td></tr></table></figure><pre><code>* Exec 格式: `&lt;instruction&gt; [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...]`</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN [<span class="string">&quot;apt-get&quot;</span>, <span class="string">&quot;install&quot;</span>, <span class="string">&quot;python3&quot;</span>]  </span><br><span class="line">CMD [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;Hello world&quot;</span>]  </span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;Hello world&quot;</span>]</span><br></pre></td></tr></table></figure><ol start="2"><li>Shell格式详解<br>当指令执行时，shell 格式底层会调用 /bin/sh -c ,例如下面的 Dockerfile 片段：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV name Noah luo  </span><br><span class="line">ENTRYPOINT <span class="built_in">echo</span> <span class="string">&quot;Hello, <span class="variable">$name</span>&quot;</span>   </span><br></pre></td></tr></table></figure><p>执行 docker run 将输出：“Hello, Noah luo”<br>注意环境变量 name 已经被值 Noah luo 替换。</p><ol start="3"><li>Exec格式详解<br>当指令执行时，会直接调用 ，不会被 shell 解析, 例如下面的 Dockerfile 片段：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV name Noah luo  </span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;Hello, <span class="variable">$name</span>&quot;</span>]</span><br></pre></td></tr></table></figure><p>运行容器将输出： “Hello, $name”<br>注意环境变量“name”没有被替换,如果希望使用环境变量，照如下修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV name Noah luo  </span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello, <span class="variable">$name</span>&quot;</span>]</span><br></pre></td></tr></table></figure><p>运行容器将输出： ‘Hello, Noah luo’</p><h2 id="B-CMD命令详解">B. CMD命令详解</h2><p>CMD 指令允许用户指定容器的默认执行的命令,此命令会在容器启动且 docker run 没有指定其他命令时运行。</p><ul><li>如果 docker run 指定了其他命令，CMD 指定的默认命令将被忽略。</li><li>如果 Dockerfile 中有多个 CMD 指令，只有最后一个 CMD 有效。</li></ul><ol><li><p>CMD 有三种格式：</p><ol><li>Exec 格式：CMD [“executable”,“param1”,“param2”]</li><li>Shell 格式：CMD command param1 param2</li><li>ENTRYPOINT参数格式：CMD [“param1”,“param2”]<br>专为 ENTRYPOINT 提供额外的参数，此时 ENTRYPOINT 必须使用 Exec 格式,详见 ENTRYPOINT部分说明。</li></ol></li><li><p>使用举例<br>Dockerfile 片段：CMD echo “Hello world”,运行容器 docker run -it [image]将输出：Hello world.<br>但当后面加上一个命令，比如docker run -it [image] /bin/bash，CMD 会被忽略掉，命令 bash 将被执行</p></li></ol><h2 id="C-ENTRYPOINT命令详解">C. ENTRYPOINT命令详解</h2><p>ENTRYPOINT 指令可让容器以应用程序或者服务的形式运行,<br>与 CMD都可以指定要执行的命令及其参数.<br>不同的地方在于 ENTRYPOINT 不会被忽略，一定会被执行，即使运行 docker run 时指定了其他命令。</p><ol><li>ENTRYPOINT 有两种格式：<br>两种格式的效果差别很大<ul><li>Exec 格式：ENTRYPOINT [“executable”, “param1”, “param2”]</li><li>Shell 格式：ENTRYPOINT command param1 param2</li></ul></li><li>Exec 格式详解<br>ENTRYPOINT 的 Exec 格式用于设置要执行的命令及其参数，同时可通过 CMD 提供额外的参数。<br>ENTRYPOINT 中的参数始终会被使用，而 CMD 的额外参数可以在容器启动时动态替换掉。<br>Dockerfile 片段如下：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;Hello&quot;</span>]  </span><br><span class="line">CMD [<span class="string">&quot;world&quot;</span>]</span><br></pre></td></tr></table></figure><p>当容器通过 <code>docker run -it [image]</code>启动时，输出为：Hello world<br>而如果通过 <code>docker run -it [image] noah</code> 启动，则输出为：Hello noah<br>3. Shell 格式<br>ENTRYPOINT 的 Shell 格式会忽略任何 CMD 或 docker run 提供的参数。</p><h2 id="D-最佳实践总结">D. 最佳实践总结</h2><ol><li>如果 Docker 镜像的用途是运行应用程序或服务，如运行MySQL，优先使用 Exec 格式的 ENTRYPOINT 指令。<br>CMD 可为 ENTRYPOINT 提供额外的默认参数，同时可利用 docker run 命令行替换默认参数。</li><li>如果想为容器设置默认的启动命令，可使用 CMD 指令。用户可在 docker run 命令行中替换此默认命令。</li></ol>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4-数据的持久化和共享互连</title>
      <link href="/20220110/docker-20220110-4-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8C%E5%85%B1%E4%BA%AB%E4%BA%92%E8%BF%9E/"/>
      <url>/20220110/docker-20220110-4-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8C%E5%85%B1%E4%BA%AB%E4%BA%92%E8%BF%9E/</url>
      
        <content type="html"><![CDATA[<h1>一 容器数据持久化和共享方案</h1><h2 id="A-为什么要使用docker数据持久化">A.为什么要使用docker数据持久化</h2><p>正常情况下，删除容器，容器中所有的文件也会被删除。所以需要能持久化容器中数据的方法,也就是数据卷<br><strong>数据卷(Data Volume)的作用：</strong></p><ol><li>持久化容器运行过程中产生的数据文件</li><li>实现多个容器间的文件共享。</li><li>实现多个主机间有状态容器的迁移</li></ol><h2 id="B-docker数据卷的分类">B.docker数据卷的分类</h2><p>在集群环境下,数据卷分为:</p><ol><li>单机内容器间的数据持久化和共享<ul><li>数据卷[Data Volume]<ul><li>绑定挂载[bind mount]</li><li>容器管理卷[docker managed volume]</li></ul></li><li>容器卷[volume container]</li></ul></li><li>跨主机容器间的数据持久化和共享<ul><li>使用分布式文件系统(如NFS)</li><li>使用volume driver实现跨主机存储<ul><li>Rex-Ray插件</li><li><a href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">更多官方插件</a></li></ul></li></ul></li></ol><h2 id="C-容器间互连的方式">C.容器间互连的方式</h2><p>容器互联大体有以下三种方式：</p><ul><li>基于volume的互联</li><li>基于link的互联</li><li>基于网络的互联</li></ul><blockquote><p>其中基于网络的互连会在网络部分单独写,基于volume的互连和基于link的互连会在本节详细说明</p></blockquote><h1>二 数据卷的使用详情</h1><p>数据卷[Data Volume]就是将宿主机中的一个文件或目录挂载到容器中,供容器使用,分为绑定卷[bind mount]和容器管理卷[docker managed volume],区别是</p><table><thead><tr><th>区别点</th><th>bind mount</th><th>docker managed volume</th></tr></thead><tbody><tr><td>volume 位置</td><td>可任意指定</td><td>/var/lib/docker/volumes/…</td></tr><tr><td>对已有mount point 影响</td><td>隐藏并替换为 volume</td><td>原有数据复制到 volume</td></tr><tr><td>是否支持单个文件</td><td>支持</td><td>不支持，只能是目录</td></tr><tr><td>权限控制</td><td>可设置为只读，默认为读写权限</td><td>无控制，均为读写权限</td></tr><tr><td>移植性</td><td>移植性弱，与 host path 绑定</td><td>移植性强，无需指定 host 目录</td></tr></tbody></table><h2 id="A-常见的docker数据卷命令-2">A.常见的docker数据卷命令</h2><ul><li>创建一个数据卷<br><code>docker volume create xxx</code></li><li>查看数据卷列表<br><code>docker volume ls</code></li><li>删除一个数据卷<br><code>docker volume rm</code></li><li>查看一个数据卷的属性<br><code>docker volume inspect</code></li></ul><h2 id="B-v参数挂载数据卷的语法">B.<code>-v</code>参数挂载数据卷的语法</h2><ol><li>挂载数据卷语法<br><code>-v 挂载源:挂载目的[:其他选项]</code><ul><li>使用举例:<br><code>docker run -d -p 80:80 -v /data/test/:/usr/share/nginx/html nginx</code></li></ul></li></ol><blockquote><p>其他选项一般只有一个ro只读选项常用,不举例了</p></blockquote><ol start="2"><li>-v参数用法详解</li></ol><table><thead><tr><th>-v参数所跟选项</th><th>举例</th><th>导致的结果</th></tr></thead><tbody><tr><td>A:不跟任何选项</td><td>-v</td><td>根据创建镜像的dockerfiled的配置进行挂载</td></tr><tr><td>B:只写一个目录</td><td>-v /data</td><td>表示只有挂载目的,会自动创建挂载源</td></tr><tr><td>C:源目都有[四种]</td><td>-v xxx:/test</td><td>又如下分四种情况</td></tr><tr><td>C1:源目都是目录</td><td>-v /data/:/test</td><td>将主机的data目录挂载到容器的test目录</td></tr><tr><td>C2:源目都是文件</td><td>-v ~/f.txt:/test/b.txt</td><td>用主机文件f.txt文件替代容器b.txt文件</td></tr><tr><td>C3:源是容器管理卷[已建]</td><td>-v noah:/test</td><td>挂载容器管理卷noah为容器目录/test</td></tr><tr><td>C4:源是容器管理卷[未建]</td><td>-v noah:/test</td><td>创建并挂载容器管理卷,并用容器目录中的数据初始化容器管理卷</td></tr></tbody></table><h2 id="C-绑定挂载-bind-mount-的使用">C.绑定挂载[bind mount]的使用</h2><p>先创建好一个目录和里面的测试文件,然后创建实例的时候,直接加参数挂载到相应的目录即可</p><p><strong>1.准备数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/test/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;this is test ----------&gt; bind mount&#x27;</span> &gt;/data/test/index.html</span><br></pre></td></tr></table></figure><p><strong>2.创建bind mount的容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 -v /data/test/:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure><p><strong>3.验证结果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">this is <span class="built_in">test</span> ----------&gt; <span class="built_in">bind</span> mount</span><br><span class="line">[root@docker01 ~]<span class="comment"># echo &#x27;this is new change pag&#x27; &gt;/data/test/index.html</span></span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">this is new change pag</span><br><span class="line"><span class="comment">#可见已经将目录成功挂载到容器中,并且可以实时更新</span></span><br></pre></td></tr></table></figure><p><strong>4.用inspect查看镜像信息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker container inspect 9c5e35343873|grep -A 4 Mounts</span></span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/data/test&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/usr/share/nginx/html&quot;</span>,</span><br></pre></td></tr></table></figure><h2 id="D-容器管理卷-docker-managed-volume-的使用">D.容器管理卷[docker managed volume]的使用</h2><p><strong>1.手动创建卷&quot;noah-v1&quot;并写入文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume create noah-v1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;this is noah-v1 vol&#x27;</span> &gt;/var/lib/docker/volumes/noah-v1/_data/index.html</span><br></pre></td></tr></table></figure><p><strong>2.分别用三种方式创建含容器管理卷的容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 180:80 -v /usr/share/nginx/html nginx</span><br><span class="line">docker run -d -p 280:80 -v noah:/usr/share/nginx/html nginx</span><br><span class="line">docker run -d -p 380:80 -v noah-v1:/usr/share/nginx/html nginx</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:380</span></span><br><span class="line">this is noah-v1 vol</span><br><span class="line">[root@docker01 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               95b29d4a729017510df9fdc1753ebeb117a7464c24af9657913130c7e6ef2f01</span><br><span class="line"><span class="built_in">local</span>               noah</span><br><span class="line"><span class="built_in">local</span>               noah-v1</span><br></pre></td></tr></table></figure><blockquote><p>针对第一条命令,未指定挂载源时,自动创建一个卷<br>针对第二条命令,指定的挂载源不存在时,自动创建卷并命名<br>针对第三条命令,指定的挂载源存在时,直接挂载该卷</p></blockquote><p><strong>3.分别curl三个端口看结果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:180</span></span><br><span class="line">......</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:280</span></span><br><span class="line">......</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:380</span></span><br><span class="line">this is noah-v1 vol</span><br></pre></td></tr></table></figure><h1>四 容器卷[volume container]的使用详情</h1><p>volume container 是专门为其他容器提供 volume 的容器。它提供的卷可以是 bind mount，也可以是 docker managed volume。</p><h2 id="A-volume-container-的特点：">A.volume container 的特点：</h2><ol><li>实现了容器与 host 的解耦<br>与 bind mount 相比，不必为每一个容器指定 host path，所有 path 都在 volume container 中定义好了，容器只需与 volume container 关联。</li><li>有利于配置的规范和标准化<br>使用 volume container 的容器其 mount point 是一致的，有利于配置的规范和标准化，但也带来一定的局限，使用时需要综合考虑。</li></ol><h2 id="B-容器卷实操演示">B. 容器卷实操演示</h2><p>创建一个名为<code>vc_data</code>的容器, mount 了1个<code>docker managed volume</code>,其他容器可以通过<code>--volumes-from</code>使用<code>vc_data</code>这个 volume container：</p><blockquote><p>注意这里执行的是docker create命令，这是因为 volume container 的作用只是提供数据，它本身不需要处于运行状态。</p></blockquote><ol><li>创建容器卷容器</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker volume create noah-v2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;this is noah-v2 vol&#x27;</span> &gt;/var/lib/docker/volumes/noah-v2/_data/index.html</span><br><span class="line">docker create --name vc_data -v noah-v2:/usr/share/nginx/html busybox</span><br></pre></td></tr></table></figure><ol start="2"><li>通过docker inspect可以查看到信息</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># docker inspect vc_data |grep -A 4 Mounts</span></span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;noah-v2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/noah-v2/_data&quot;</span>,</span><br></pre></td></tr></table></figure><ol start="3"><li>其他容器挂载vc_data</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 801:80 --volumes-from vc_data nginx</span><br><span class="line">docker run -d -p 802:80 --volumes-from vc_data nginx</span><br></pre></td></tr></table></figure><ol start="4"><li>查看结果验证</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:801</span></span><br><span class="line">this is noah-v2 vol</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:802</span></span><br><span class="line">this is noah-v2 vol</span><br></pre></td></tr></table></figure><ol start="5"><li>修改数据验证共享</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;change data info is now&#x27;</span> &gt;/var/lib/docker/volumes/noah-v2/_data/index.html</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:801</span></span><br><span class="line">change data info is now</span><br><span class="line">[root@docker01 ~]<span class="comment"># curl 127.0.0.1:802</span></span><br><span class="line">change data info is now</span><br></pre></td></tr></table></figure><p>可见，两个容器已经成功共享了 volume container 中的 volume。</p><h1>五 volume的备份和恢复</h1><h2 id="A-备份和恢复">A. 备份和恢复</h2><p>volume 实际上是 host 文件系统中的目录和文件，而我们所有的本地镜像都存在 host 指定目录的</p><ol><li>无私有registry时,在<code>/var/lib/docker/volumes/</code>目录</li><li>有私有registry时,在registry创建时指定的目录</li></ol><p>我们要做的就是定期备份这个目录,如果数据损坏了，直接用之前备份的数据拷贝到 对应目录就可以了。</p><h2 id="B-仓库迁移">B. 仓库迁移</h2><p>如果我们想使用更新版本的 Registry，这就涉及到数据迁移，步骤是：</p><ol><li>docker stop 停止当前 Registry 容器。</li><li>启动新版本容器并 mount 原有 volume。<br><code>docker run -d -p 5000:5000 -v /myregistry:/var/lib/registry registry:latest</code><br>当然，在启用新容器前要确保新版本的默认数据路径是否发生变化。</li></ol><h2 id="C-销毁">C. 销毁</h2><p>docker 不会销毁 bind mount，删除数据的工作只能由 host 负责。<br>对于 docker managed volume，在删除容器时可以带上 -v 参数，会将容器使用到的 volume 一并删除(前提是没有其他容器 mount 该 volume)<br>如果删除容器时没有带 -v ,就会产生孤儿 volume，对于孤儿volume:</p><ol><li>用 docker managed volume 进行维护。</li><li>删除孤儿volume docker volume rm .</li><li>批量删除孤儿 volume，docker volume rm $(docker volume ls -q)</li></ol><h1>六 link连接容器进行互连</h1><h2 id="A-link基本功能演示">A. link基本功能演示</h2><p><code>--link</code>参数格式为<code>--link name:alias</code>,其中name是要链接的容器名称，alias是这个连接的别名。<br>Docker通过<strong>环境变量</strong>和<strong>更新/etc/hosts</strong>文件两种方式为容器公开连接信息</p><ol><li>用link方式创建容器</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name web01 -e DBNAME=demo nginx:latest </span><br><span class="line">docker run -it --<span class="built_in">link</span> web01:test01 centos:6.9</span><br></pre></td></tr></table></figure><ol start="2"><li>在test01容器中验证</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@142f76fd54d1 /]<span class="comment"># curl -sL -w &quot;%&#123;http_code&#125;\n&quot; web01 -o /dev/null</span></span><br><span class="line">200</span><br></pre></td></tr></table></figure><ol start="3"><li>查看hosts文件和env环境变量</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@142f76fd54d1 /]<span class="comment"># tail -2 /etc/hosts</span></span><br><span class="line">172.17.0.2test01 a641de6f2ea3 web01</span><br><span class="line">172.17.0.3142f76fd54d1</span><br><span class="line">[root@142f76fd54d1 /]<span class="comment"># env|grep DBNAME</span></span><br><span class="line">TEST01_ENV_DBNAME=demo</span><br></pre></td></tr></table></figure><h2 id="B-link方式快速部署zabbix">B. link方式快速部署zabbix</h2><p>通过用容器方式快速部署zabbix的案例,来说明link在实际使用中的应用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql-server -t \</span><br><span class="line">      -e MYSQL_DATABASE=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_PASSWORD=<span class="string">&quot;zabbix_pwd&quot;</span> \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=<span class="string">&quot;root_pwd&quot;</span> \</span><br><span class="line">      -d mysql:5.7 \</span><br><span class="line">      --character-set-server=utf8 --collation-server=utf8_bin</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-java-gateway -t \</span><br><span class="line">      -d zabbix/zabbix-java-gateway:latest</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-server-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=<span class="string">&quot;mysql-server&quot;</span> \</span><br><span class="line">      -e MYSQL_DATABASE=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_PASSWORD=<span class="string">&quot;zabbix_pwd&quot;</span> \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=<span class="string">&quot;root_pwd&quot;</span> \</span><br><span class="line">      -e ZBX_JAVAGATEWAY=<span class="string">&quot;zabbix-java-gateway&quot;</span> \</span><br><span class="line">      --<span class="built_in">link</span> mysql-server:mysql \</span><br><span class="line">      --<span class="built_in">link</span> zabbix-java-gateway:zabbix-java-gateway \</span><br><span class="line">      -p 10051:10051 \</span><br><span class="line">      -d zabbix/zabbix-server-mysql:latest</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-web-nginx-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=<span class="string">&quot;mysql-server&quot;</span> \</span><br><span class="line">      -e MYSQL_DATABASE=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">      -e MYSQL_PASSWORD=<span class="string">&quot;zabbix_pwd&quot;</span> \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=<span class="string">&quot;root_pwd&quot;</span> \</span><br><span class="line">      --<span class="built_in">link</span> mysql-server:mysql \</span><br><span class="line">      --<span class="built_in">link</span> zabbix-server-mysql:zabbix-server \</span><br><span class="line">      -p 80:80 \</span><br><span class="line">      -d zabbix/zabbix-web-nginx-mysql:latest</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3-docker基础操作命令</title>
      <link href="/20220110/docker-20220110-3-docker%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"/>
      <url>/20220110/docker-20220110-3-docker%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h1>一 命令格式</h1><p>docker的命令分老版命令格式和新版命令格式,新版命令主要是更直观了,添加了镜像[image]和容器[container]来区分命令,简单举例对比:</p><p><strong>1.显示容器命令</strong><br>老版命令:<code>docker ps</code><br>新版命令:<code>docker container ls</code><br><strong>2.显示镜像命令</strong><br>老版命令: <code>docker images</code><br>新版命令: <code>docker image ls</code><br><strong>3.删除镜像命令</strong><br>老版命令: <code>docker rmi centos:latest</code><br>新版命令: <code>docker image rm centos:latest</code></p><h1>二 镜像相关命令</h1><h2 id="1-搜索镜像：">1.搜索镜像：</h2><p><code>docker search xxx</code><br>选镜像的建议：优先考虑官方镜像,然后是<code>starts</code>数量多的镜像</p><h2 id="2-拉取-推送镜像">2.拉取/推送镜像:</h2><p>1.拉取镜像到本地<br><code>docker image pull centos</code><br>2.推送centos镜像到仓库<br><code>docker image push centos</code></p><h2 id="3-镜像加速器">3. 镜像加速器</h2><p>在<code>/etc/docker/daemon.json</code>文件中写上仓库和地址,详见docker部署章节</p><h2 id="4-查看-删除镜像">4. 查看/删除镜像</h2><p>1.查看镜像<br><code>docker image ls</code><br>2.删除镜像<br><code>docker image rm centos</code></p><h2 id="5-导入导出镜像">5. 导入导出镜像</h2><p>1.导出镜像<br><code>docker image save centos &gt; docker-centos7.4.tar.gz</code><br>2.导入镜像<br><code>docker image load -i docker-centos7.4.tar.gz</code></p><h1>三 容器相关命令</h1><h2 id="1-创建启动容器">1. 创建启动容器</h2><p><strong>1.创建容器并启动</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建并启动容器</span></span><br><span class="line">docker container  run -d -p 80:80 nginx:latest &#123;cmd&#125;</span><br><span class="line"><span class="comment">#单独创建容器</span></span><br><span class="line">docker container create -p 80:80 nginx</span><br><span class="line"><span class="comment">#单独启动容器</span></span><br><span class="line">docker container start -d 容器ID|容器名</span><br></pre></td></tr></table></figure><p><strong>2.常规参数</strong></p><table><thead><tr><th>参数名</th><th>功能</th><th>不带此参数时</th></tr></thead><tbody><tr><td>-d</td><td>将容器放在后台运行</td><td>前台运行,会占用终端</td></tr><tr><td>-p</td><td>进行端口映射</td><td>有些复杂,单独说明</td></tr><tr><td>-it</td><td>分配新终端并进入容器</td><td>不会进入容器内部</td></tr><tr><td>–name</td><td>指定容器的名字</td><td>随机命名</td></tr><tr><td>cmd</td><td>覆盖容器的初始命令</td><td>使用容器的初始命令</td></tr><tr><td>–cpus</td><td>限定cpu的权重</td><td>不限制</td></tr><tr><td>-memory</td><td>限定内存的大小</td><td>不限制</td></tr><tr><td>-h</td><td>指定容器的主机名</td><td>以容器端ID命名</td></tr></tbody></table><h2 id="2-停止删除容器">2. 停止删除容器</h2><p><strong>1.停止容器</strong><br><code>docker container stop</code> 容器ID|容器名<br><strong>2.杀死容器</strong><br><code>docker container kill</code> 容器ID|容器名<br><strong>3.删除容器</strong><br><code>docker container rm</code> 容器ID|容器名<br><strong>4.批量删除容器</strong><br><code>docker container rm -f $(docker container ls -a -q)</code></p><h2 id="3-查看容器">3. 查看容器</h2><p><strong>1.查看容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看运行中的容器</span></span><br><span class="line">docker container <span class="built_in">ls</span></span><br><span class="line"><span class="comment">#查看所有容器</span></span><br><span class="line">docker container <span class="built_in">ls</span> -a</span><br></pre></td></tr></table></figure><p><strong>2.查看指定容器详细信息</strong><br>以下命令可以查看容器的超详细信息,以json格式显示<br><code>docker container inspect</code> 容器ID|容器名</p><h2 id="4-进入容器的方法">4. 进入容器的方法</h2><p>进入容器的目的：排错，调试</p><p><strong>1.attach 方法[不常用]</strong><br><code>docker container attach [OPTIONS]</code> 容器ID|容器名<br>此方法会是进入容器当前终端,会实时打印容器的输出信息,退出很麻烦[Ctrl+p Ctrl+q ],容易按成[Ctrl+c]导致容器被关闭<br><strong>2.exec方法</strong><br><code>docker container exec [OPTIONS]</code> 容器ID|容器名 {命令}<br>常用<code>docker exec -it xxx /bin/bash</code> 的方法打开新终端进入容器</p><h1>四 端口映射</h1><h2 id="1-docker容器为什么要使用端口映射">1.docker容器为什么要使用端口映射</h2><p>默认情况下，容器使用的ip网段是172.17.0.0/16，外界的用户只能访问宿主机的10.0.0.0/24网段，无法访问172.17.0.0/16网段。<br>而我们运行容器的目的,是希望运行在容器中的服务，能够被外界访问，这里就涉及到了外网10.0.0.0/24到容器内网172.17.0.0/16网段的转换，所以需要做端口映射。</p><h2 id="2-docker容器端口映射的方法">2.docker容器端口映射的方法</h2><p>docker 的端口映射是通过自动添加一条iptables规则实现的</p><p><strong>1.指定映射端口</strong></p><table><thead><tr><th>语法</th><th>举例</th><th>说明</th></tr></thead><tbody><tr><td>-p hPort:cPort</td><td>-p 8800:80</td><td>主机8800映射容器80</td></tr><tr><td>同上,指定多个-p</td><td>-p 81:80</td><td>-p 443:443</td></tr><tr><td>-p ip:hPort:cPort</td><td>-p 10.0.0.11:8800:80</td><td>指定主机IP</td></tr><tr><td>-p crPort</td><td>-p 80</td><td>随机端口映射容器80</td></tr><tr><td>-p ip::crPort</td><td>-p 10.0.11::80</td><td>IP指定,主机端口随机</td></tr><tr><td>-p hPort:cPort:udp</td><td>-p 8800:80:udp</td><td>默认tcp映射,改为UDP</td></tr></tbody></table><p><strong>2.完全随机映射</strong><br><code>docker run -P</code><br>将<code>dockerfile</code>创建镜像时指定的,需要映射出来的内网端口,做外网随机映射</p><h1>五 docker资源限额</h1><p>一个 docker host 上会运行若干容器，每个容器都需要 CPU、内存和 IO 资源，Docker 提供了资源限制的机制避免某个容器因占用太多资源而影响其他容器乃至整个 host 的性能。</p><h2 id="A-内存限额">A. 内存限额</h2><p>与操作系统类似，容器可使用的内存包括两部分：物理内存和 swap。</p><ol><li><code>-m</code> 或 <code>--memory</code>：设置内存的使用限额，例如 100M, 2G。</li><li><code>--memory-swap</code>：设置 <strong>内存+swap</strong> 的使用限额。</li><li>默认情况下都为为 -1，即对容器内存和 swap 的使用没有限制。</li><li>如果只指定 <code>-m</code> 参数，那么 <code>--memory-swap</code> 默认为 <code>-m</code> 的两倍</li></ol><p>命令案例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 200M --memory-swap=300M ubuntu</span><br></pre></td></tr></table></figure><p>允许该容器最多使用 200M 的内存和 100M 的 swap。</p><h3 id="A1-动态修改内存限额">A1 动态修改内存限额</h3><p>动态修改运行中的容器内存限额,需要用到update参数,并且不能只修改内存限制,需要同步修改swap限制,否则会报错,报错详见:<br><a href="https://my.oschina.net/Kanonpy/blog/2209207">参考链接</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update  --memory 2048m --memory-swap -1 gitlab</span><br></pre></td></tr></table></figure><h2 id="B-cpu限额">B. cpu限额</h2><p>通过 <code>-c</code> 设置的 cpu share 并不是 CPU 资源的绝对数量，而是一个相对的权重值。某个容器最终能分配到的 CPU 资源取决于它的 cpu share 占所有容器 cpu share 总和的比例。</p><ol><li>默认所有容器可以平等地使用 host CPU 资源 ,并且没有限制。</li><li>通过 <code>-c</code> 或 <code>--cpu-shares</code> 设置容器使用 CPU 的权重。</li><li>如果不指定，默认值为 1024。</li><li>通过 cpu share 可以设置容器使用 CPU 的优先级。</li></ol><p>案例:在 host 中启动了两个容器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --name <span class="string">&quot;container_A&quot;</span> -c 1024 ubuntu</span><br><span class="line">docker run --name <span class="string">&quot;container_B&quot;</span> -c 512  ubuntu</span><br></pre></td></tr></table></figure><p>container_A 的 cpu share 1024，是 container_B 的两倍。当两个容器都需要 CPU 资源时，container_A 可以得到的 CPU 是 container_B 的两倍。</p><blockquote><p>这种按权重分配 CPU 只会发生在 CPU 资源紧张的情况下。如果 container_A 处于空闲状态，这时，为了充分利用 CPU 资源，container_B 也可以分配到全部可用的 CPU。</p></blockquote><h2 id="C-磁盘限额">C. 磁盘限额</h2><p>Block IO 指的是磁盘的读写，docker 可通过设置权重、限制 bps 和 iops 的方式控制容器读写磁盘的带宽，下面分别讨论。</p><blockquote><p>目前 Block IO 限额只对 direct IO（不使用文件缓存）有效。</p></blockquote><p><strong>1.block IO 权重</strong><br>默认情况下，所有容器能平等地读写磁盘，可以通过设置 <code>--blkio-weight</code> 参数来改变容器 block IO 的优先级。<br><code>--blkio-weight</code> 与 <code>--cpu-shares</code> 类似，设置的是相对权重值，默认为 500。<br>在下面的例子中，container_A 读写磁盘的带宽是 container_B 的两倍。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name container\_A --blkio-weight 600 ubuntu   </span><br><span class="line">docker run -it --name container\_B --blkio-weight 300 ubuntu</span><br></pre></td></tr></table></figure><p><strong>2.限制 bps 和 iops</strong><br>bps 是 byte per second，每秒读写的数据量。<br>iops 是 io per second，每秒 IO 的次数。</p><ul><li><code>--device-read-bps</code>，限制读某个设备的 bps。</li><li><code>--device-write-bps</code>，限制写某个设备的 bps。</li><li><code>--device-read-iops</code>，限制读某个设备的 iops。</li><li><code>--device-write-iops</code>，限制写某个设备的 iops。</li></ul><p>下面这个例子限制容器写 /dev/sda 的速率为 30 MB/s</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --device-write-bps /dev/sda:30MB ubuntu</span><br></pre></td></tr></table></figure><h1>六 数据卷与挂载</h1><h2 id="A-常见的docker数据卷命令">A.常见的docker数据卷命令</h2><ul><li>创建一个数据卷<br><code>docker volume create xxx</code></li><li>查看数据卷列表<br><code>docker volume ls</code></li><li>删除一个数据卷<br><code>docker volume rm</code></li><li>查看一个数据卷的属性<br><code>docker volume inspect</code></li></ul><h2 id="B-数据卷与容器卷挂载">B.数据卷与容器卷挂载</h2><ol><li>绑定卷</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80  -v /data/test/:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure><ol start="2"><li>容器管理卷</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 180:80 -v         /usr/share/nginx/html nginx</span><br><span class="line">docker run -d -p 380:80 -v noah-v1:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure><ol start="3"><li>容器卷</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume create noah-v2</span><br><span class="line">docker run -d -p 801:80 --volumes-from vc_data nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2-docker软件部署</title>
      <link href="/20220110/docker-20220110-2-docker%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/"/>
      <url>/20220110/docker-20220110-2-docker%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1>一 环境规划</h1><p>内核版本必须3.8以上,所以我们之间使用centos7.4</p><table><thead><tr><th>主机名</th><th>IP地址</th><th>操作系统</th><th>内存</th><th>docker版本</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.11</td><td>centos7.4</td><td>4G</td><td>1.83</td></tr><tr><td>docker02</td><td>10.0.0.12</td><td>centos7.4</td><td>4G</td><td>1.83</td></tr></tbody></table><h1>二 docker部署</h1><h2 id="1-添加yum源">1. 添加yum源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum clean all</span><br></pre></td></tr></table></figure><h2 id="2-安装docker">2. 安装docker</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce</span><br></pre></td></tr></table></figure><h2 id="3-配置docker镜像加速">3. 配置docker镜像加速</h2><p>docker的镜像默认都从docker-hub上拉取,然而由于不可描述的原因,国内访问速度很很慢,因此会采用镜像加速的方式拉取镜像,常用的有四个地址,分别是daocloud,七牛,docker-cn,阿里云,阿里云的要注册后才能使用专用地址,使用使用方法如下</p><ul><li>方法1:DaoCloud+七牛+docker-cn加速</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/docker</span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123; </span></span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;: [&quot;https://ms14dndh.mirror.aliyuncs.com&quot;, &quot;http://hub-mirror.c.163.com&quot;, &quot;https://registry.docker-cn.com&quot;] </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>docker cn的加速效果很一般,如果不用阿里云的话,推荐用发放DaoCloud</p><ul><li>方法2:阿里云加速器</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注册阿里云账号,才能获取专用加速器地址,获得路径：</span><br><span class="line">https://cr.console.aliyun.com/<span class="comment">#/accelerato</span></span><br></pre></td></tr></table></figure><h2 id="4-启动docker">4. 启动docker</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker </span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><h1>三 启动第一个docker容器</h1><p><strong>启动nginx容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80  nginx</span><br></pre></td></tr></table></figure><p><strong>命令参数解释</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run    创建并运行一个容器</span><br><span class="line">-d     放在后台运行</span><br><span class="line">-p     端口映射</span><br><span class="line">nginx  镜像的名字</span><br></pre></td></tr></table></figure><blockquote><p>输出结果:<br>Unable to find image ‘nginx:latest’ locally<br>latest: Pulling from library/nginx<br>743f2d6c1f65: Pull complete<br>6bfc4ec4420a: Pull complete<br>688a776db95f: Pull complete<br>Digest: sha256:23b4dcdf0d34d4a129755fc6f52e1c6e23bb34ea011b315d87e193033bcd1b68<br>Status: Downloaded newer image for nginx:latest<br>46030b32068a344d66e8437ff7b9ccca3b593b1d43b679f781b4ef23d35e82c6</p></blockquote><p><strong>输出结果解释</strong></p><ol><li>本地未发现镜像文件</li><li>从仓库library/nginx分层下载镜像</li><li>下载完成后校验哈希值</li><li>新镜像命令并输出ID</li></ol>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1-容器和docker基础知识</title>
      <link href="/20220110/docker-20220110-1-%E5%AE%B9%E5%99%A8%E5%92%8Cdocker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>/20220110/docker-20220110-1-%E5%AE%B9%E5%99%A8%E5%92%8Cdocker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h1>一 容器的概念</h1><h2 id="1-什么是容器：">1.什么是容器：</h2><p>容器是在隔离的环境里面运行的一个进程，这个隔离的环境有自己的系统目录文件，有自己的ip地址，主机名等。</p><p>也可以说：容器是一种轻量级虚拟化的技术。</p><h2 id="2-容器相对于kvm虚拟机的优势：">2.容器相对于kvm虚拟机的优势：</h2><ol><li>容器能提供接近宿主机的性能，而kvm虚拟机会损害一部分宿主机的性能</li><li>若宿主机最多能启动10虚拟机，那么它可以启动100+容器</li><li>启动一台kvm虚拟机，可以能需要20秒，容器只需要1秒</li><li>kvm需要硬件cpu的支持，容器不需要</li></ol><h2 id="3-docker容器是什么？">3.docker容器是什么？</h2><p>Docker是通过内核虚拟化技术（namespaces及cgroups）来提供容器的资源隔离与资源限制。<br>由于Docker通过操作系统层的虚拟化实现隔离（对操作系统的内核有要求），所以Docker容器在运行时，不需要类似虚拟机（VM）额外的操作系统开销，从而比kvm虚拟机更轻量。</p><h1>二 docker相关概念</h1><p>docker是一种软件的打包技术。</p><h2 id="1-docker的理念">1.docker的理念</h2><p>docker的主要目标是&quot;Build,Ship and Run any App,Angwhere&quot;,构建，运输，然后处处运行</p><ul><li>构建：制作docker镜像，打包容器的所有系统目录文件</li><li>运输：上传,下载,共享docker镜像</li><li>运行：基于docker镜像提供的rootfs，启动容器</li></ul><blockquote><p>只要能运行docker容器，那么docker镜像中已经安装好的软件也可以运行，所以说docker是一种软件的打包技术。</p></blockquote><h2 id="2-docker的优点">2.docker的优点:</h2><ol><li>解决了操作系统和软件运行环境的依赖</li><li>对于开发人员来说，再也不用担心不会部署开发环境</li><li>开发环境，测试环境和生产环境高度一致。</li><li>让用户体验产品新特性的又一种思路。</li></ol><h2 id="3-docker的架构和组件">3.docker的架构和组件</h2><p>docker是一个cs架构：通过docker version来查看<br>docker最重要的三大组件：镜像，容器，仓库</p><h1>三 镜像名和标签</h1><h2 id="1-镜像名称说明">1.镜像名称说明</h2><p>标准镜像名由四部分组成:<br><code>仓库地址/项目名/镜像名:标签</code>,如 <code>daocloud.io/library/nginx:latest</code><br>docker官方仓库的官方镜像可省略仓库地址和项目名,即:<code>镜像名:标签</code><br>docker官方仓库的第三方镜像可省略仓库地址,即:<code>项目名/镜像名:标签</code><br>第三方仓库的镜像必须包含所有信息,即:<code>仓库地址/项目名/镜像名:标签</code></p><h2 id="2-镜像标签">2. 镜像标签</h2><p>同一个镜像可以有多个便签,一个标签也可以对应多个镜像<br>标签常用来区分版本号,如<code>centos:7</code>,<code>centos:7.4</code>,<code>centos:latest</code><br>如果未指明使用哪个标签,将使用默认的标签<code>latest</code></p><h1>四 镜像的分层概念</h1><p>docker镜像是分层存储的,最上面一层为可写层,下面所有层都是只读层,这要做的好处是:</p><ol><li>多个镜像可以共用底层镜像,减小仓库容量</li><li>制作镜像时可以使用底层镜像缓存,加快制作速度</li><li>启动镜像时不用加载重复镜像,提高启动速度</li><li>每一个只读层都可以单独作为镜像加载,制方便排查作镜像时的问题</li></ol><h1>五 Docker DNS Server</h1><p>从 Docker 1.10 版本开始，docker daemon 实现了一个内嵌的 DNS server，使容器可以直接通过“容器名”通信。方法很简单，只要在启动时用 <code>--name</code> 为容器命名就可以了。<br>使用 docker DNS 有个限制：只能在 user-defined 网络中使用。也就是说，默认的 bridge 网络是无法使用 DNS 的。下面验证一下：</p><p><strong>1.创建自定义网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge noah_net</span><br></pre></td></tr></table></figure><p><strong>2.启动基于自定义的网络的容器并测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  --network=noah_net --name=bbox1 busybox <span class="built_in">sleep</span> 900</span><br><span class="line">docker run -it --network=noah_net --name=bbox2 busybox ping -c1 bbox1</span><br></pre></td></tr></table></figure><p><strong>3.启动默认网络的容器并测试。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  --name=bbox3 busybox <span class="built_in">sleep</span> 900</span><br><span class="line">docker run -it --name=bbox4 busybox ping -c1 bbox3</span><br></pre></td></tr></table></figure><p>bbox4 无法 ping 到 bbox3。</p><h1>END docker组件间关系图</h1><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/20220110/docker-20220110-1-%E5%AE%B9%E5%99%A8%E5%92%8Cdocker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/49b86876989d191562b80bc1ed452eeb_1112x659.png" class="" title="docker关系图">]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
