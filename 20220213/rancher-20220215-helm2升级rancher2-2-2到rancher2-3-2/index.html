<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>helm2升级rancher2-2-2到rancher2-3-2 | ren_mccの博客</title><meta name="author" content="ren_mcc"><meta name="copyright" content="ren_mcc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 集群现状 rke部署工具版本 12[root@localhost rke2.2.2]# .&#x2F;rke -versionrke version v0.2.6 rke部署k8s集群版本（用于高可用部署rancher） 123[root@localhost rke2.2.2]# kubectl versionClient Version: version.Info&amp;#123;Major:&quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="helm2升级rancher2-2-2到rancher2-3-2">
<meta property="og:url" content="https://renm.cc/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/index.html">
<meta property="og:site_name" content="ren_mccの博客">
<meta property="og:description" content="1. 集群现状 rke部署工具版本 12[root@localhost rke2.2.2]# .&#x2F;rke -versionrke version v0.2.6 rke部署k8s集群版本（用于高可用部署rancher） 123[root@localhost rke2.2.2]# kubectl versionClient Version: version.Info&amp;#123;Major:&quot;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://renm.cc/img/yuanshen/avatar/128860_43586076260.jpg">
<meta property="article:published_time" content="2022-02-13T15:01:32.000Z">
<meta property="article:modified_time" content="2023-06-28T13:47:21.833Z">
<meta property="article:author" content="ren_mcc">
<meta property="article:tag" content="rancher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://renm.cc/img/yuanshen/avatar/128860_43586076260.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://renm.cc/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'helm2升级rancher2-2-2到rancher2-3-2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><script src="/js/jquery.min.js"></script><link rel="stylesheet" href="/js/function.min.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="/js/custom.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-image: url(/img/backgroud7.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar2.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">148</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/yuanshen/avatar/128860_43586076260.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ren_mccの博客</span></a><a class="nav-page-title" href="/"><span class="site-name">helm2升级rancher2-2-2到rancher2-3-2</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">helm2升级rancher2-2-2到rancher2-3-2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-13T15:01:32.000Z" title="发表于 2022-02-13 23:01:32">2022-02-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-28T13:47:21.833Z" title="更新于 2023-06-28 21:47:21">2023-06-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/rancher/">rancher</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-06-28 21:47:21&quot;}" hidden></div><h2 id="1-集群现状">1. 集群现状</h2>
<p><strong>rke部署工具版本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke -version</span></span><br><span class="line">rke version v0.2.6</span><br></pre></td></tr></table></figure>
<p><strong>rke部署k8s集群版本（用于高可用部署rancher）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl version</span></span><br><span class="line">Client Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.3&quot;</span>, GitCommit:<span class="string">&quot;5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-06-06T01:44:30Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.5&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;14&quot;</span>, GitVersion:<span class="string">&quot;v1.14.3&quot;</span>, GitCommit:<span class="string">&quot;5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2019-06-06T01:36:19Z&quot;</span>, GoVersion:<span class="string">&quot;go1.12.5&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p><strong>rancher版本和负载集群版本</strong><br>
rancher2.2.2<br>
kubernetes 1.13.5</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/2022-02-16_172405.png" class="" title="执行结果">
<h2 id="2-升级版本简介">2. 升级版本简介</h2>
<p>官方2.3.x版本说明 <a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rancher2/releases/v2.3.0/">2.3.0</a><br>
Rancher 2.3.2，这是Rancher 2.3.x第一个stable的版本，这意味着它是Rancher官方推荐所有用户可用于生产环境的稳定版本！</p>
<h2 id="3-升级步骤">3. 升级步骤</h2>
<p>官方的升级指南<a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rancher2/installation/install-rancher-on-k8s/upgrades/ha/helm2/_index">高可用升级指南（Helm 2）</a></p>
<h3 id="3-1-备份正在运行-Rancher-Server-的-Kubernetes-集群">3.1 备份正在运行 Rancher Server 的 Kubernetes 集群</h3>
<p><strong>创建rke集群快照</strong><br>
如若升级失败用户恢复rancher版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke etcd snapshot-save --name etcd-2022021602.db --config cluster.yml</span></span><br><span class="line">INFO[0000] Starting saving snapshot on etcd hosts       </span><br><span class="line">INFO[0000] [dialer] Setup tunnel <span class="keyword">for</span> host [192.168.10.20] </span><br><span class="line">INFO[0000] [etcd] Saving snapshot [etcd-2022021602.db] on host [192.168.10.20] </span><br><span class="line">INFO[0001] [etcd] Successfully started [etcd-snapshot-once] container on host [192.168.10.20] </span><br><span class="line">INFO[0001] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0001] Container [etcd-snapshot-once] is still running on host [192.168.10.20] </span><br><span class="line">INFO[0002] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0002] Container [etcd-snapshot-once] is still running on host [192.168.10.20] </span><br><span class="line">INFO[0003] Waiting <span class="keyword">for</span> [etcd-snapshot-once] container to <span class="built_in">exit</span> on host [192.168.10.20] </span><br><span class="line">INFO[0003] Finished saving snapshot [etcd-2022021602.db] on all etcd hosts </span><br></pre></td></tr></table></figure>
<p><strong>备份负载集群</strong></p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/backfuzaijiqun.png" class="" title="执行结果">
<h3 id="3-2-更新-Helm-chart-仓库">3.2 更新 Helm chart 仓库</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<p>确保有需要升级的版本<br>
rancher官方仓库stable版本列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># helm search rancher -l</span></span><br><span class="line">rancher-stable/rancher	2.3.4           	v2.3.4           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.3.3           	v2.3.3           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.3.2           	v2.3.2           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.13          	v2.2.13          	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.11          	v2.2.11          	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.10          	v2.2.10          	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.9           	v2.2.9           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.8           	v2.2.8           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.7           	v2.2.7           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.6           	v2.2.6           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.5           	v2.2.5           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.4           	v2.2.4           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.3           	v2.2.3           	Install Rancher Server to manage Kubernetes clusters acro...</span><br><span class="line">rancher-stable/rancher	2.2.2           	v2.2.2           	Install Rancher Server to manage Kubernetes clusters acro...</span><br></pre></td></tr></table></figure>
<h3 id="3-3-升级-Rancher">3.3 升级 Rancher</h3>
<p><strong>从已安装的当前 Rancher Helm chart 中获取通过 --set 传递的值</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># helm get values rancher</span></span><br><span class="line">hostname: cloud.jfjbapp.cn</span><br><span class="line">ingress:</span><br><span class="line">  tls:</span><br><span class="line">    <span class="built_in">source</span>: secret</span><br><span class="line">privateCA: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>更新到指定版本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade rancher rancher-stable/rancher \</span><br><span class="line">  --namespace cattle-system \</span><br><span class="line">  --<span class="built_in">set</span> hostname=cloud.jfjbapp.cn \</span><br><span class="line">  --<span class="built_in">set</span> ingress.tls.source=secret \</span><br><span class="line">  --<span class="built_in">set</span> privateCA=<span class="literal">true</span> \</span><br><span class="line">  --version 2.3.2</span><br></pre></td></tr></table></figure>
<p>升级过程后端集群需要升级rancher-agent从2.2.2到2.3.2会有1-2分钟负载集群不可用状态</p>

<p>稍等rancher和集群恢复正常状态</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/zhengchang.png" class="" title="执行结果">
<p>检查rke集群pod是否正常,确保状态为running并且无重启状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-74bcd8b6df-zxdrb     1/1     Running     0          3m12s</span><br><span class="line">cattle-system   cattle-node-agent-vqm4t                   1/1     Running     0          3m8s</span><br><span class="line">cattle-system   rancher-848d7f74fd-5bstv                  1/1     Running     0          4m30s</span><br><span class="line">cattle-system   rancher-848d7f74fd-5hhjg                  1/1     Running     0          4m56s</span><br><span class="line">cattle-system   rancher-848d7f74fd-fhm7k                  1/1     Running     0          5m10s</span><br><span class="line">ingress-nginx   default-http-backend-5954bd5d8c-9gjz7     1/1     Running     3          46h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-zftwb            1/1     Running     0          7h11m</span><br><span class="line">kube-system     canal-ljlxc                               2/2     Running     0          7h11m</span><br><span class="line">kube-system     coredns-86bc4b7c96-z875n                  1/1     Running     0          7h11m</span><br><span class="line">kube-system     coredns-autoscaler-5d5d49b8ff-5jwvr       1/1     Running     0          7h11m</span><br><span class="line">kube-system     metrics-server-7f6bd4c888-4xxm8           1/1     Running     0          7h11m</span><br><span class="line">kube-system     rke-coredns-addon-deploy-job-zj72v        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-sbprl   0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-xtf8m        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-pd9vg       0/1     Completed   0          46h</span><br><span class="line">kube-system     tiller-deploy-7cb87ddf7d-vzr4j            1/1     Running     3          46h</span><br></pre></td></tr></table></figure>
<p>同理检查负载集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@node02:~<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-7d74b74f89-xrnx8     1/1     Running     0          5m7s</span><br><span class="line">cattle-system   cattle-node-agent-4gf92                   1/1     Running     0          5m</span><br><span class="line">cattle-system   kube-api-auth-nprjl                       1/1     Running     0          4m20s</span><br><span class="line">default         nginx-6d6d68488c-vq9qd                    1/1     Running     1          9h</span><br><span class="line">ingress-nginx   default-http-backend-78fccfc5d9-7krhb     1/1     Running     1          9h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-jjw6l            1/1     Running     0          7h8m</span><br><span class="line">kube-system     canal-wgzpc                               2/2     Running     0          7h8m</span><br><span class="line">kube-system     kube-dns-58bd5b8dd7-5h4l7                 3/3     Running     0          7h8m</span><br><span class="line">kube-system     kube-dns-autoscaler-77bc5fd84-8rvss       1/1     Running     0          7h8m</span><br><span class="line">kube-system     metrics-server-58bd5dd8d7-s5pcf           1/1     Running     0          7h8m</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-rkdgf   0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-kube-dns-addon-deploy-job-8l4xq       0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-62fmt        0/1     Completed   0          9h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-98tdb       0/1     Completed   0          9h</span><br></pre></td></tr></table></figure>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/shengjihou.png" class="" title="执行结果">
<p>至此，升级完成。</p>
<h2 id="4-版本回滚">4. 版本回滚</h2>
<p>官方的回退指南<a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rancher2/backups/restore/ha-restore/_index/">高可用恢复</a></p>
<h3 id="4-1-从本地快照还原rke集群">4.1 从本地快照还原rke集群</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># ./rke etcd snapshot-restore --name etcd-2022021602.db --config cluster.yml</span></span><br><span class="line">INFO[0000] Restoring etcd snapshot etcd-2022021602.db   </span><br><span class="line">INFO[0000] Successfully Deployed state file at [./cluster.rkestate] </span><br><span class="line">INFO[0000] [dialer] Setup tunnel <span class="keyword">for</span> host [192.168.10.20] </span><br><span class="line">INFO[0007] [etcd] starting backup server on host [192.168.10.20] </span><br><span class="line">INFO[0007] [etcd] Successfully started [etcd-Serve-backup] container on host [192.168.10.20] </span><br><span class="line">INFO[0012] [remove/etcd-Serve-backup] Successfully removed container on host [192.168.10.20] </span><br><span class="line">INFO[0012] [etcd] Checking <span class="keyword">if</span> all snapshots are identical</span><br><span class="line">...</span><br><span class="line">INFO[0076] [ingress] ingress controller nginx deployed successfully </span><br><span class="line">INFO[0076] [addons] Setting up user addons              </span><br><span class="line">INFO[0076] [addons] no user addons defined              </span><br><span class="line">INFO[0076] Finished building Kubernetes cluster successfully </span><br><span class="line">INFO[0076] Restarting network, ingress, and metrics pods </span><br><span class="line">INFO[0078] Finished restoring snapshot [etcd-2022021602.db] on all etcd hosts</span><br></pre></td></tr></table></figure>
<p>等待两个anget容器恢复running状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rke2.2.2]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">cattle-system   cattle-cluster-agent-588959c4bf-hpgfr     1/1     Running     2          40s</span><br><span class="line">cattle-system   cattle-node-agent-4h6kx                   1/1     Running     3          26h</span><br><span class="line">cattle-system   rancher-6ff949dc75-6cfbj                  1/1     Running     0          42h</span><br><span class="line">cattle-system   rancher-6ff949dc75-jnn87                  1/1     Running     0          42h</span><br><span class="line">cattle-system   rancher-6ff949dc75-pcz7c                  1/1     Running     0          42h</span><br><span class="line">ingress-nginx   default-http-backend-5954bd5d8c-9gjz7     1/1     Running     3          46h</span><br><span class="line">ingress-nginx   nginx-ingress-controller-7td9m            1/1     Running     0          26s</span><br><span class="line">kube-system     canal-xv2sd                               2/2     Running     0          40s</span><br><span class="line">kube-system     coredns-86bc4b7c96-kcnqk                  1/1     Running     0          40s</span><br><span class="line">kube-system     coredns-autoscaler-5d5d49b8ff-g6h7n       1/1     Running     0          40s</span><br><span class="line">kube-system     metrics-server-7f6bd4c888-zv8fc           1/1     Running     0          40s</span><br><span class="line">kube-system     rke-coredns-addon-deploy-job-zj72v        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-sbprl   0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-xtf8m        0/1     Completed   0          46h</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-pd9vg       0/1     Completed   0          46h</span><br><span class="line">kube-system     tiller-deploy-7cb87ddf7d-vzr4j            1/1     Running     3          46h</span><br></pre></td></tr></table></figure>
<h3 id="4-2-恢复负载集群">4.2 恢复负载集群</h3>
<p>选择负载集群恢复找到备份的时间，点击恢复</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifu.png" class="" title="执行结果">
<p>等待集群更新</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifujiqun.png" class="" title="执行结果">
<p>等待集群恢复查看rancher-agent版本</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/huifu2.2.png" class="" title="执行结果">
<p>至此，集群恢复完成。</p>
<h2 id="5-升级和回滚负载集群测试">5. 升级和回滚负载集群测试</h2>
<p>创建2个负载容器</p>
<img src="/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/ceshi.png" class="" title="执行结果">
<p>用死循环模拟不间断请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># while true; do curl -I http://192.168.10.21:31274/ ;done</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.5</span><br><span class="line">Date: Thu, 17 Feb 2022 01:35:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 28 Dec 2021 18:48:00 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;61cb5be0-267&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h2 id="6-总结-2">6. 总结</h2>
<p>在升级到 v2.3.0 时，第一次修改通过 Rancher v2.3.0 之前版本部署的 RKE 集群时，由于要向系统组件中加入 Tolerations，该集群全部的系统组件将会自动重启。升级前请预先做好数据备份。</p>
<p>以上为官方版本说明，经过测试rancher在升级过程中请求不会发生中断，回滚过程中负载集群所有pod都会重新创建模拟请求会发生中断。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://renm.cc">ren_mcc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://renm.cc/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/">https://renm.cc/20220213/rancher-20220215-helm2%E5%8D%87%E7%BA%A7rancher2-2-2%E5%88%B0rancher2-3-2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://renm.cc" target="_blank">ren_mccの博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rancher/">rancher</a></div><div class="post-share"><div class="social-share" data-image="/img/yuanshen/avatar/128860_43586076260.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/20220216/kubernetes-20220216-k8s%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="k8s基础环境配置"><img class="cover" src="/img/yuanshen/avatar/1000111.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">k8s基础环境配置</div></div><div class="info-2"><div class="info-item-1">1 主机基础配置 1.1 主机名配置 因为 K8S 或者 FQDN 的规定，主机名仅支持包含 - 或/和 .(中横线和点)两种特殊符号，并且一个集群中主机名不能重复。 1.2 Hosts  Linux 系统安装完成后，在 hosts(/etc/hosts) 中应该有 localhost 指向 127.0.0.1，如果没有则手动添加上。 配置每台主机的 hosts(/etc/hosts)，添加 host_ip $hostname 到 /etc/hosts 文件中。  1.3 CentOS 关闭 selinux 1sudo sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 1.4 关闭防火墙(可选)或者放行相应端口   CentOS  1systemctl stop firewalld.service &amp;&amp; systemctl disable firewalld.service   Ubuntu   1ufw disable   1.5...</div></div></div></a><a class="pagination-related" href="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/" title="RKE集群helm2部署rancher-v2.2.2"><img class="cover" src="/img/yuanshen/avatar/1f178a82b9014a904ee6e31f2649141bb21bee04.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">RKE集群helm2部署rancher-v2.2.2</div></div><div class="info-2"><div class="info-item-1">对于生产环境，需以高可用的配置安装 Rancher，确保用户始终可以访问 Rancher Server。当安装在Kubernetes集群中时，Rancher将与集群的 etcd 集成，并利用Kubernetes 调度实现高可用。 为确保高可用，本文所部署的 Kubernetes 集群将专用于运行 Rancher ，Rancher 运行起来后，可再创建或导入集群以运行具体的工作负载。 1. 推荐架构  Rancher的DNS 应解析到 4层(TCP) 负载均衡上。 负载均衡应将端口 TCP/80 和 TCP/443 转发到 Kubernetes 集群中的所有3个节点。 Ingress-controller 将 HTTP 重定向到HTTPS并终止端口 TCP/443 上的 SSL/TLS（SSL数字证书在这里部署）。 Ingress-controller 将流量转发到 pod 的 TCP/80 端口。  下面是一张从官网拉过来的图片,更直观一些。  2. 准备工作 2.1 服务器准备  1台 Linux服务器，配置不用很高，用于四层负载均衡 3台...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/20220212/rancher-20220213-RKE%E9%9B%86%E7%BE%A4helm2%E9%83%A8%E7%BD%B2rancher-v2-2-2/" title="RKE集群helm2部署rancher-v2.2.2"><img class="cover" src="/img/yuanshen/avatar/1f178a82b9014a904ee6e31f2649141bb21bee04.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-12</div><div class="info-item-2">RKE集群helm2部署rancher-v2.2.2</div></div><div class="info-2"><div class="info-item-1">对于生产环境，需以高可用的配置安装 Rancher，确保用户始终可以访问 Rancher Server。当安装在Kubernetes集群中时，Rancher将与集群的 etcd 集成，并利用Kubernetes 调度实现高可用。 为确保高可用，本文所部署的 Kubernetes 集群将专用于运行 Rancher ，Rancher 运行起来后，可再创建或导入集群以运行具体的工作负载。 1. 推荐架构  Rancher的DNS 应解析到 4层(TCP) 负载均衡上。 负载均衡应将端口 TCP/80 和 TCP/443 转发到 Kubernetes 集群中的所有3个节点。 Ingress-controller 将 HTTP 重定向到HTTPS并终止端口 TCP/443 上的 SSL/TLS（SSL数字证书在这里部署）。 Ingress-controller 将流量转发到 pod 的 TCP/80 端口。  下面是一张从官网拉过来的图片,更直观一些。  2. 准备工作 2.1 服务器准备  1台 Linux服务器，配置不用很高，用于四层负载均衡 3台...</div></div></div></a><a class="pagination-related" href="/20220216/rancher-20220216-%E6%B5%8B%E8%AF%95HPA/" title="测试HPA"><img class="cover" src="/img/yuanshen/avatar/1000.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-16</div><div class="info-item-2">测试HPA</div></div><div class="info-2"><div class="info-item-1">1. HPA 工作原理 Pod 弹性伸缩器（HPA）是 Kubernetes 的一项功能，可以对您的应用进行自动扩容和自动缩容。 1.1 为什么要使用 HPA？ 使用 HPA，您可以自动缩放在 Replication Controller，Deployment 或者 Replica Set 中的 Pod。HPA 将自动缩放正在运行的 Pod 的数量，以实现最高效率。HPA 中影响 Pod 数量的因素包括：  用户定义的允许运行的 Pod 的最小和最大数量。 资源指标中报告的观察到的 CPU 或内存使用情况。 第三方指标应用程序（例如 Prometheus，Datadog 等）提供的自定义指标。  HPA 通过以下方式改善您的服务：  释放因过多的 Pod 而浪费的硬件资源。 按照应用需要的性能，自动提高或降低 Pod 数量。  1.2 HPA 是如何工作的？  HPA 是通过循环控制来实现的，其循环周期由下面的 kube-controller-manager...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%9B%86%E7%BE%A4%E7%8E%B0%E7%8A%B6"><span class="toc-number">1.</span> <span class="toc-text">1. 集群现状</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%87%E7%BA%A7%E7%89%88%E6%9C%AC%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 升级版本简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.</span> <span class="toc-text">3. 升级步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%A4%87%E4%BB%BD%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C-Rancher-Server-%E7%9A%84-Kubernetes-%E9%9B%86%E7%BE%A4"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 备份正在运行 Rancher Server 的 Kubernetes 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%9B%B4%E6%96%B0-Helm-chart-%E4%BB%93%E5%BA%93"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 更新 Helm chart 仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%8D%87%E7%BA%A7-Rancher"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 升级 Rancher</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%89%88%E6%9C%AC%E5%9B%9E%E6%BB%9A"><span class="toc-number">4.</span> <span class="toc-text">4. 版本回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BB%8E%E6%9C%AC%E5%9C%B0%E5%BF%AB%E7%85%A7%E8%BF%98%E5%8E%9Frke%E9%9B%86%E7%BE%A4"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 从本地快照还原rke集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%81%A2%E5%A4%8D%E8%B4%9F%E8%BD%BD%E9%9B%86%E7%BE%A4"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 恢复负载集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A%E8%B4%9F%E8%BD%BD%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">5. 升级和回滚负载集群测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%BB%E7%BB%93-2"><span class="toc-number">6.</span> <span class="toc-text">6. 总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By ren_mcc</div><div class="footer_custom_text"><a rel="noopener external nofollow noreferrer noopener" target="_blank" href="https://beian.miit.gov.cn/"> <img class="icp-icon entered loading" alt="ICP" src="/img/icp.png" data-ll-status><span>京ICP备2022001205号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: [''],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '9edeed0418f8ffc919469991fbf9e69d'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><div class="aplayer no-destroy" data-id="7211977673" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="list" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/docker/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱 docker (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/docker-compose/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 docker-compose (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/containerd/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 containerd (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/kubernetes/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 kubernetes (27)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/python/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 python (37)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/golang/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 golang (38)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 redis (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://renm.cc/categories/kafka/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 kafka (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://renm.cc/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>